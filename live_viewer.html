<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD Live - Pro Gifts</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>

    <style>
        /* =========================================
           1. Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø©
           ========================================= */
        :root { --primary: #F72585; --gold: #FFD700; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #fff; height: 100vh; overflow: hidden; }

        /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        #remote-player { position: absolute; inset: 0; z-index: 1; background: #111; }
        #remote-player video { object-fit: cover !important; }

        /* Ø·Ø¨Ù‚Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
        .overlay-layer { 
            position: absolute; inset: 0; z-index: 10; pointer-events: none; 
            background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, transparent 30%, rgba(0,0,0,0.8) 100%);
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø°ÙŠØ¹) --- */
        .top-section { width: 100%; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .host-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .host-info-card {
            background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(8px);
            padding: 4px 15px 4px 5px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        .host-img { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--primary); object-fit: cover; }
        .host-name { font-weight: bold; font-size: 13px; color: #fff; }
        .viewer-count { font-size: 10px; color: #ddd; }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª --- */
        .chat-container { width: 100%; display: flex; flex-direction: column; justify-content: flex-end; margin-bottom: 10px; pointer-events: none; }
        .chat-list {
            height: 250px; overflow-y: auto; scrollbar-width: none;
            mask-image: linear-gradient(to top, black 85%, transparent 100%);
            display: flex; flex-direction: column; justify-content: flex-end; margin-bottom: 10px;
        }
        .chat-msg { 
            background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 15px; 
            margin-bottom: 6px; font-size: 13px; width: fit-content; max-width: 85%; 
            word-wrap: break-word; text-shadow: 0 1px 2px black; animation: slideIn 0.2s ease;
        }
        .chat-user { color: #4CC9F0; font-weight: 800; margin-left: 5px; }
        .gift-chat-msg {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.3), transparent);
            border-right: 3px solid #FFD700; color: #FFD700; font-weight: bold;
        }

        /* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ --- */
        .bottom-bar { display: flex; gap: 10px; pointer-events: auto; align-items: center; width: 100%; }
        #msg-input { 
            flex: 1; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 25px; padding: 10px 15px; color: #fff; outline: none; backdrop-filter: blur(5px);
        }
        .action-btn { 
            width: 42px; height: 42px; border-radius: 50%; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 20px; 
            color: #fff; transition: transform 0.2s; backdrop-filter: blur(5px);
        }
        .action-btn:active { transform: scale(0.9); }
        .btn-send { background: var(--primary); }
        .btn-gift { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); animation: pulseGift 2s infinite; }

        /* =========================================
           2. Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ticker & Combo)
           ========================================= */
        .gift-ticker-wrapper {
            position: absolute; top: 120px; left: 10px; z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .gift-ticker-card {
            display: flex; align-items: center; gap: 10px;
            background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-left: 4px solid #FFD700; border-radius: 50px;
            padding: 5px 15px 5px 5px;
            transform: translateX(-120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: fit-content;
        }
        .gift-ticker-card.show { transform: translateX(0); }

        .ticker-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #FFD700; object-fit: cover; }
        .ticker-info { display: flex; flex-direction: column; line-height: 1.1; margin-left: 5px; }
        .ticker-name { color: #FFD700; font-weight: 800; font-size: 12px; }
        .ticker-desc { color: #fff; font-size: 10px; font-weight: 600; }
        .ticker-gift-icon { font-size: 28px; filter: drop-shadow(0 0 5px rgba(255,215,0,0.5)); }
        
        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙˆÙ…Ø¨Ùˆ */
        .gift-combo-count {
            font-family: 'Impact', sans-serif; font-size: 24px; color: #fff;
            text-shadow: 2px 2px 0 #F72585, -1px -1px 0 #000;
            font-style: italic; margin-right: 10px; opacity: 0; transform: scale(0.5);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .gift-combo-count.active { opacity: 1; transform: scale(1); }
        .gift-combo-count.pop { animation: comboPop 0.3s ease-in-out; }

        /* =========================================
           3. Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Bottom Sheet)
           ========================================= */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; }
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a;
            border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s ease;
            z-index: 201; padding: 20px; border-top: 1px solid #333;
        }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #fff; }
        
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .gift-item {
            background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s;
        }
        .gift-item:active { transform: scale(0.95); border-color: var(--primary); }
        .g-emoji { font-size: 35px; margin-bottom: 5px; }
        .g-name { font-size: 10px; font-weight: bold; color: #fff; }
        .g-price { font-size: 9px; color: #FFD700; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 8px; margin-top: 2px; }

        /* =========================================
           4. Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
           ========================================= */
        .big-effect-container { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 150; pointer-events: none; 
        }
        .big-gift-pop { 
            font-size: 120px; animation: popBig 1s ease-out forwards; 
            filter: drop-shadow(0 0 20px rgba(255,215,0,0.8));
        }
        
        @keyframes comboPop { 0% { transform: scale(1); } 50% { transform: scale(1.5) rotate(-10deg); color: #FFD700; } 100% { transform: scale(1) rotate(0); } }
        @keyframes popBig { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes pulseGift { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading-screen { position: absolute; inset: 0; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 40px; margin-bottom: 15px;"></i>
        <div style="color: #fff; font-weight: bold;">Ø¬Ø§Ø±ÙŠ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¨Ø«...</div>
    </div>

    <div id="remote-player"></div>

    <div class="overlay-layer">
        
        <div class="top-section">
            <div class="host-header">
                <div class="host-info-card">
                    <img id="host-pic" src="https://via.placeholder.com/50" class="host-img">
                    <div style="display:flex; flex-direction:column; line-height:1.2">
                        <span class="host-name" id="host-name">..</span>
                        <span class="viewer-count"><i class="fa-solid fa-user"></i> <span id="viewers">0</span></span>
                    </div>
                </div>
                <div style="background:rgba(247,37,133,0.8); padding:4px 10px; border-radius:12px; font-size:11px; font-weight:bold;">LIVE</div>
            </div>
        </div>

        <div id="gift-ticker-overlay" class="gift-ticker-wrapper"></div>

        <div id="big-effects-area" class="big-effect-container"></div>

        <div class="chat-container">
            <div class="chat-list" id="chat-list"></div>

            <div class="bottom-bar">
                <input type="text" id="msg-input" placeholder="Ù‚Ù„ Ø´ÙŠØ¦Ø§Ù‹ Ù„Ø·ÙŠÙØ§Ù‹..." onkeypress="if(event.key==='Enter') sendMsg()">
                
                <button class="action-btn btn-send" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
                
                <button class="action-btn btn-gift" onclick="GiftSystem.open()">
                    <i class="fa-solid fa-gift"></i>
                </button>
                
                <button class="action-btn" style="background:rgba(255,255,255,0.15); color:#ff2d55" onclick="sendHeart()">
                    <i class="fa-solid fa-heart"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="sheet-overlay" id="sheetOverlay" onclick="GiftSystem.close()"></div>
    <div class="bottom-sheet" id="giftSheet">
        <div class="sheet-header">
            <h3>Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</h3>
            <div style="background:rgba(255,215,0,0.1); color:#FFD700; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold;">
                <i class="fa-solid fa-coins"></i> 5000
            </div>
        </div>
        <div class="gift-grid" id="giftGridContainer"></div>
    </div>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Agora ---
        const APP_ID = "f311de5105eb4fa7869dfffd2bb7ac2d"; 
        const TOKEN = "007eJxTYGhhPet5ZLbkOikhVcfvlz9rM9ouv5yyO1hfY/fRZY/S8lkUGNKMDQ1TUk0NDUxTk0zSEs0tzCxT0tLSUoySkswTk41SOlubMhsCGRnSrBuZGRkgEMTnYShJLS6JT85IzMtLzWFgAAAh4iJc";
        
        const urlParams = new URLSearchParams(window.location.search);
        const CHANNEL = urlParams.get('channel') || "test_channel"; 

        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        let currentUser = null;
        let userData = { name: "Ø¶ÙŠÙ", profilePic: "https://via.placeholder.com/100" };
// Ø¶ÙŠÙ Ø¯Ù‡ ØªØ­Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ (Ø²ÙŠ currentUser Ùˆ localTracks)
let pendingHearts = 0; // Ù…Ø®Ø²Ù† Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø§Ù„Ù…Ø¤Ù‚Øª

        // --- 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« ---
        auth.onAuthStateChanged(async user => {
            if(user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.uid).get();
                if(doc.exists) userData = doc.data();
                else userData = { name: user.displayName, profilePic: user.photoURL };
            }
            initLive();
        });

        async function initLive() {
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø°ÙŠØ¹
            db.collection('lives').doc(CHANNEL).onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('host-name').innerText = data.hostName || "Ù…Ø°ÙŠØ¹";
                    if(data.hostPic) document.getElementById('host-pic').src = data.hostPic;
                    document.getElementById('viewers').innerText = data.viewers || 0;
                }
            });

            // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
            db.collection('lives').doc(CHANNEL).update({ viewers: firebase.firestore.FieldValue.increment(1) }).catch(()=>{});

            // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            try {
                client.setClientRole("audience");
                await client.join(APP_ID, CHANNEL, TOKEN, null);
                client.on("user-published", async (user, mediaType) => {
                    await client.subscribe(user, mediaType);
                    document.getElementById('loading-screen').style.display = 'none';
                    if (mediaType === "video") user.videoTrack.play("remote-player");
                    if (mediaType === "audio") user.audioTrack.play();
                });
            } catch (err) {
                console.error(err);
                document.getElementById('loading-screen').innerHTML = "<p style='color:red'>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</p>";
            }

            loadChat();
        }

        // ========================================================
        // 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Brain of the System)
        // ========================================================

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…ØªØ§Ø­Ø©
        const AVAILABLE_GIFTS = [
            { id: 'rose', name: 'ÙˆØ±Ø¯Ø©', emoji: 'ğŸŒ¹', price: 10 },
            { id: 'heart', name: 'Ù‚Ù„Ø¨', emoji: 'â¤ï¸', price: 50 },
            { id: 'fire', name: 'Ù†Ø§Ø±', emoji: 'ğŸ”¥', price: 100 },
            { id: 'diamond', name: 'Ø£Ù„Ù…Ø§Ø³', emoji: 'ğŸ’', price: 500 },
            { id: 'car', name: 'Ø³ÙŠØ§Ø±Ø©', emoji: 'ğŸï¸', price: 1000 },
            { id: 'crown', name: 'ØªØ§Ø¬', emoji: 'ğŸ‘‘', price: 3000 },
            { id: 'lion', name: 'Ø£Ø³Ø¯', emoji: 'ğŸ¦', price: 5000 },
            { id: 'rocket', name: 'ØµØ§Ø±ÙˆØ®', emoji: 'ğŸš€', price: 10000 }
        ];

        // --- ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ---
        const GiftSystem = {
            open: function() {
                // Ø±Ø³Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const container = document.getElementById('giftGridContainer');
                container.innerHTML = AVAILABLE_GIFTS.map(g => `
                    <div class="gift-item" onclick="GiftSystem.send('${g.id}')">
                        <div class="g-emoji">${g.emoji}</div>
                        <div class="g-name">${g.name}</div>
                        <div class="g-price">${g.price}</div>
                    </div>
                `).join('');

                document.getElementById('giftSheet').classList.add('active');
                document.getElementById('sheetOverlay').style.display = 'block';
            },

            close: function() {
                document.getElementById('giftSheet').classList.remove('active');
                document.getElementById('sheetOverlay').style.display = 'none';
            },

            send: async function(giftId) {
                if (!currentUser) return alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
                
                const gift = AVAILABLE_GIFTS.find(g => g.id === giftId);
                if(!gift) return;

                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                this.close();

                // ØªØ£Ø«ÙŠØ± ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø±Ø³Ù„
                GiftTicker.add(userData.name, userData.profilePic, gift.name, gift.emoji);
                playSystemSound('sent');

                // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ù„ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹)
                await db.collection('lives').doc(CHANNEL).collection('messages').add({
                    type: 'gift',
                    userId: currentUser.uid,
                    userName: userData.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                    userPic: userData.profilePic || "",
                    giftId: gift.id,
                    giftName: gift.name,
                    giftEmoji: gift.emoji,
                    price: gift.price,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            },

            // ØªØ´ØºÙŠÙ„ ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            playBigEffect: function(emoji) {
                const area = document.getElementById('big-effects-area');
                const el = document.createElement('div');
                el.className = 'big-gift-pop';
                el.innerText = emoji;
                area.appendChild(el);
                
                // ØµÙˆØª Ù‚ÙˆÙŠ Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
                playSystemSound('combo');

                setTimeout(() => el.remove(), 1500);
            }
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙŠÙƒØ± (Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ) ---
        const GiftTicker = {
            queue: [],
            activeData: null,
            hideTimer: null,

            add: function(senderName, senderPic, giftName, giftEmoji) {
                // Ù„Ùˆ Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ ÙˆÙ†ÙØ³ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø´ØºØ§Ù„Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø²ÙˆØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Combo)
                if (this.activeData && 
                    this.activeData.senderName === senderName && 
                    this.activeData.giftName === giftName) {
                    this.triggerCombo();
                    return;
                }
                
                // ÙˆØ¥Ù„Ø§ Ø¶ÙŠÙÙ‡ Ù„Ù„Ø·Ø§Ø¨ÙˆØ±
                this.queue.push({ senderName, senderPic, giftName, giftEmoji, count: 1 });
                if (!this.activeData) this.process();
            },

            process: function() {
                if (this.queue.length === 0) {
                    this.activeData = null;
                    return;
                }
                const gift = this.queue.shift();
                this.activeData = gift;
                this.render(gift);
            },

            render: function(gift) {
                const container = document.getElementById('gift-ticker-overlay');
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                container.innerHTML = `
                    <div class="gift-ticker-card" id="tickerCard">
                        <img src="${gift.senderPic || 'https://via.placeholder.com/50'}" class="ticker-avatar">
                        <div class="ticker-info">
                            <span class="ticker-name">${gift.senderName}</span>
                            <span class="ticker-desc">Ø£Ø±Ø³Ù„ ${gift.giftName}</span>
                        </div>
                        <div class="ticker-gift-icon">${gift.giftEmoji}</div>
                        <div class="gift-combo-count" id="comboCounter">x1</div>
                    </div>
                `;

                // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
                setTimeout(() => {
                    const card = document.getElementById('tickerCard');
                    const counter = document.getElementById('comboCounter');
                    if(card) card.classList.add('show');
                    if(counter) counter.classList.add('active');
                }, 50);

                this.resetTimer();
            },

            triggerCombo: function() {
                this.activeData.count++;
                const counter = document.getElementById('comboCounter');
                if (counter) {
                    counter.innerText = 'x' + this.activeData.count;
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù€ Pop
                    counter.classList.remove('pop');
                    void counter.offsetWidth; // Trigger reflow
                    counter.classList.add('pop');
                    
                    // ØµÙˆØª Ø§Ù„ÙƒÙˆÙ…Ø¨Ùˆ
                    if(this.activeData.count % 5 === 0) playSystemSound('combo');
                }
                this.resetTimer();
            },

            resetTimer: function() {
                if (this.hideTimer) clearTimeout(this.hideTimer);
                this.hideTimer = setTimeout(() => { this.close(); }, 4000); // ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø³ÙƒÙˆÙ†
            },

            close: function() {
                const card = document.getElementById('tickerCard');
                if (card) {
                    card.style.transform = "translateX(-120%)"; // Ø®Ø±ÙˆØ¬
                    card.style.opacity = "0";
                }
                setTimeout(() => {
                    document.getElementById('gift-ticker-overlay').innerHTML = '';
                    this.activeData = null;
                    this.process(); // Ø´ØºÙ„ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
                }, 300);
            }
        };

        // --- 5. Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« ---
        function loadChat() {
            db.collection('lives').doc(CHANNEL).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const list = document.getElementById('chat-list');
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const msg = change.doc.data();
                            
                            // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
                            if (msg.type === 'gift') {
                                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø§Øª
                                const div = document.createElement('div');
                                div.className = 'chat-msg gift-chat-msg';
                                div.innerHTML = `<span class="chat-user">${escapeHtml(msg.userName)}:</span> Ø£Ø±Ø³Ù„ ${msg.giftName} ${msg.giftEmoji}`;
                                list.appendChild(div);

                                // ğŸ”¥ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙŠÙƒØ± ÙˆØ§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ù…Ø§Ø¹Ø¯Ø§ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ø£Ù†Ù‡ Ø´Ø§ÙÙ‡ Ù„Ø­Ø¸ÙŠØ§Ù‹) ğŸ”¥
                                // Ø´Ø±Ø·: Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠØŒ Ø´ØºÙ„ Ø§Ù„ØªÙŠÙƒØ± (Ø¹Ø´Ø§Ù† Ø¨ØªØ§Ø¹ØªÙŠ Ø§Ø´ØªØºÙ„Øª ÙÙŠ Ø¯Ø§Ù„Ø© send)
                                // Ø£Ùˆ: Ù…Ù…ÙƒÙ† Ù†Ø´ØºÙ„Ù‡ Ù„Ù„ÙƒÙ„ Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ†Ù„ØºÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø­Ø¸ÙŠ ÙÙŠ send Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†
                                if (currentUser && msg.userId !== currentUser.uid) {
                                    GiftTicker.add(msg.userName, msg.userPic, msg.giftName, msg.giftEmoji);
                                }
                                
                                // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
                                GiftSystem.playBigEffect(msg.giftEmoji);

                            } else {
                                // 2. Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ø¯ÙŠØ©
                                const div = document.createElement('div');
                                div.className = 'chat-msg';
                                div.innerHTML = `<span class="chat-user">${escapeHtml(msg.userName)}:</span> ${escapeHtml(msg.text)}`;
                                list.appendChild(div);
                            }
                            
                            list.scrollTop = list.scrollHeight;
                        }
                    });
                });
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !currentUser) return;
            
            await db.collection('lives').doc(CHANNEL).collection('messages').add({
                type: 'text',
                userId: currentUser.uid,
                userName: userData.name,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = '';
        }

        function sendHeart() {
    // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Ø¹Ø´Ø§Ù† ØªØ­Ø³ Ø¥Ù†Ùƒ Ø¯ÙˆØ³Øª)
    const area = document.body; // Ø£Ùˆ hearts-container
    const heart = document.createElement('div');
    heart.className = 'floating-heart'; // ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ CSS
    heart.innerHTML = 'â¤ï¸'; // Ø£Ùˆ Ø£ÙŠ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    
    // Ù…ÙƒØ§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ù‚Ù„Ø¨ Ø¹Ø´Ø§Ù† Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©
    heart.style.left = (Math.random() * 80 + 10) + '%'; 
    heart.style.bottom = '100px';
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±
    document.getElementById('hearts-container').appendChild(heart);
    
    // Ø­Ø°ÙÙ‡ Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠØ·ÙŠØ±
    setTimeout(() => heart.remove(), 3000);

    // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
    playSystemSound('pop'); // ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¶Ø§ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø¯ÙŠ

    // 3. ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…: ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
    pendingHearts++; 
}


        // --- Ù…Ø­Ø§ÙƒÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª (Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©) ---
        // Ù†Ø³ØªØ®Ø¯Ù… Web Audio API Ù„ØªÙˆÙ„ÙŠØ¯ Ø£ØµÙˆØ§Øª "Ø¨ÙŠØ¨" Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSystemSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'sent') {
                // ØµÙˆØª Ø±Ù‚ÙŠÙ‚ (Sine wave)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } 
            else if (type === 'combo') {
                // ØµÙˆØª Ù‚ÙˆÙŠ (Triangle wave)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        // --- Ø£Ø¯ÙˆØ§Øª ---
        function escapeHtml(text) {
            if(!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        window.onbeforeunload = () => {
            if(CHANNEL) db.collection('lives').doc(CHANNEL).update({ viewers: firebase.firestore.FieldValue.increment(-1) });
        };
    </script>

    <style>
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-300px) scale(1.5) rotate(20deg); opacity: 0; }
        }
        
        // --- ğŸ”¥ Ù†Ø¸Ø§Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø§Ù„Ø°ÙƒÙŠ (Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠÙ‡Ù†Ø¬Ø´) ğŸ”¥ ---
setInterval(() => {
    // Ù„Ùˆ ÙÙŠÙ‡ Ù‚Ù„ÙˆØ¨ Ù…ØªØ­ÙˆØ´Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 0)
    if (pendingHearts > 0) {
        
        // 1. Ø§Ø¨Ø¹Øª Ø§Ù„Ø¹Ø¯Ø¯ ÙƒÙ„Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        db.collection('lives').doc(CHANNEL).update({
            hearts: firebase.firestore.FieldValue.increment(pendingHearts)
        }).catch(err => console.log("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ù„ÙˆØ¨", err));

        // 2. ØµÙØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª
        pendingHearts = 0;
    }
}, 2000); // ÙƒÙ„ 2000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ø«Ø§Ù†ÙŠØªÙŠÙ†) ÙŠÙ†ÙØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¯ÙŠ

    </style>
</body>
</html>
