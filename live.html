<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø¯Ø£ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - NABD Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #local-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-layer { position: absolute; inset: 0; z-index: 10; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        .live-controls { pointer-events: auto; display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: #fff; font-size: 20px; cursor: pointer; backdrop-filter: blur(5px); }
        .control-btn.red { background: #ff3b30; }
        #start-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 15px 40px; border-radius: 30px; background: #F72585; color: #fff; border: none; font-size: 18px; font-weight: bold; cursor: pointer; z-index: 20; pointer-events: auto; }
        .status-badge { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .live-indicator { width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; display: none; }
    </style>
</head>
<body>

    <div id="local-player"></div>
    
    <button id="start-btn" onclick="startStream()">ðŸŽ¥ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>

    <div class="ui-layer" id="live-ui" style="display: none;">
        <div class="status-badge">
            <div class="live-indicator" id="live-dot"></div>
            <span id="viewer-count">0</span> <i class="fa-solid fa-eye"></i>
        </div>

        <div class="live-controls">
            <button class="control-btn" onclick="toggleMic()"><i class="fa-solid fa-microphone"></i></button>
            <button class="control-btn" onclick="toggleCam()"><i class="fa-solid fa-video"></i></button>
            <button class="control-btn red" onclick="endStream()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <script>
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ)
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø¬ÙˆØ±Ø§
        const APP_ID = "f311de5105eb4fa7869dfffd2bb7ac2d";
        const TOKEN = "007eJxTYGhhPet5ZLbkOikhVcfvlz9rM9ouv5yyO1hfY/fRZY/S8lkUGNKMDQ1TUk0NDUxTk0zSEs0tzCxT0tLSUoySkswTk41SOlubMhsCGRnSrBuZGRkgEMTnYShJLS6JT85IzMtLzWFgAAAh4iJc"; // âš ï¸ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ø§Ø²Ù… ÙŠØªØ¬Ø¯Ø¯ Ù„Ùˆ Ø®Ù„ØµØª Ù…Ø¯ØªÙ‡
        const CHANNEL = "test_channel"; 

        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        let localTracks = { audio: null, video: null };
        let currentUser = null;

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                console.log("Logged in as:", user.uid);
            } else {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
                window.location.href = 'home.html';
            }
        });

                async function startStream() {
            // 1. Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: Ù„Ùˆ Ø§Ù„Ø²Ø±Ø§Ø± Ù…Ø®ÙÙŠ Ø£Ùˆ Ø§Ø­Ù†Ø§ Ù…ØªØµÙ„ÙŠÙ† Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ø®Ø±Ø¬ ÙÙˆØ±Ø§Ù‹
            if (!currentUser || client.connectionState === "CONNECTED" || client.connectionState === "CONNECTING") {
                console.log("Ø£Ù†Øª Ù…ØªØµÙ„ Ø¨Ø§Ù„ÙØ¹Ù„!");
                return;
            }

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = true;
            startBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„... â³";
            
            try {
                // Ø£. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø°ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();

                // Ø¨. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Agora
                client.setClientRole("host");
                
                // ðŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø§Ù…: ÙˆØ¶Ø¹Ù†Ø§ null Ù…ÙƒØ§Ù† currentUser.uid Ø¹Ø´Ø§Ù† ÙŠØ­Ù„ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£ØµÙØ±
                // Agora Ù‡ØªØ¯ÙŠÙ†Ø§ Ø±Ù‚Ù… (Int) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø­Ø±ÙˆÙ ÙØ§ÙŠØ±Ø¨ÙŠØ³ØŒ ÙˆØ¯Ù‡ Ø£ÙØ¶Ù„ Ù„Ù„Ø£Ø¯Ø§Ø¡
                const uid = await client.join(APP_ID, CHANNEL, TOKEN, null);

                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø§ÙŠÙƒ ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                [localTracks.audio, localTracks.video] = await AgoraRTC.createMicrophoneAndCameraTracks();
                
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯Ùƒ
                localTracks.video.play("local-player");
                
                // Ù†Ø´Ø± Ø§Ù„Ø¨Ø« Ù„Ù„Ù†Ø§Ø³
                await client.publish(Object.values(localTracks));

                // Ø¬. Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø« ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ÙŠØ´ÙˆÙÙˆÙƒ)
                await db.collection('lives').doc(CHANNEL).set({
                    hostUid: currentUser.uid, // Ù‡Ù†Ø§ Ø¨Ù†Ø­ÙØ¸ Ø§Ù„Ù€ ID Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨ØªØ§Ø¹Ùƒ Ø¹Ø´Ø§Ù† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                    agoraUid: uid, // ÙˆØ¯Ù‡ Ø§Ù„Ù€ ID Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨ØªØ§Ø¹ Ø§Ù„Ø¨Ø«
                    hostName: userData.name || "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶",
                    hostPic: userData.profilePic || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                    isVerified: userData.isVerified || false,
                    channelId: CHANNEL,
                    status: 'online',
                    startedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    viewers: 0
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ ØªÙ…Ø§Ù…Ø§Ù‹
                startBtn.style.display = 'none';
                document.getElementById('live-ui').style.display = 'flex';
                document.getElementById('live-dot').style.display = 'block';

                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
                db.collection('lives').doc(CHANNEL).onSnapshot(doc => {
                    if(doc.exists) {
                        document.getElementById('viewer-count').innerText = doc.data().viewers || 0;
                    }
                });

            } catch (error) {
                console.error(error);
                alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«: " + error.message);
                // Ù„Ùˆ ÙØ´Ù„ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø²Ø±Ø§Ø± ØªØ§Ù†ÙŠ Ø¹Ø´Ø§Ù† ØªØ­Ø§ÙˆÙ„
                startBtn.style.display = 'block';
                startBtn.disabled = false;
                startBtn.innerText = "ðŸŽ¥ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±";
            }
        }


        async function endStream() {
            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù„Ù€ Offline
            await db.collection('lives').doc(CHANNEL).update({
                status: 'offline',
                endedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // 2. Ø¥ØºÙ„Ø§Ù‚ Agora
            localTracks.audio && localTracks.audio.close();
            localTracks.video && localTracks.video.close();
            await client.leave();

            // 3. ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            window.location.href = 'home.html';
        }

        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        let micOn = true, camOn = true;
        async function toggleMic() {
            micOn = !micOn;
            await localTracks.audio.setMuted(!micOn);
        }
        async function toggleCam() {
            camOn = !camOn;
            await localTracks.video.setMuted(!camOn);
        }

        // Ø¶Ù…Ø§Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø« Ø¹Ù†Ø¯ Ù‚ÙÙ„ Ø§Ù„Ù…ØªØµÙØ­
        window.onbeforeunload = () => {
            db.collection('lives').doc(CHANNEL).update({ status: 'offline' });
        };
    </script>
</body>
</html>
