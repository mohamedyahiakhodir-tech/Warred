<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="global-call.js"></script>

<style>
/* ========================================= */
/* 1. Ø§Ù„ØªØ£Ø³ÙŠØ³ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª (The Foundation)    */
/* ========================================= */
:root {
    --bg-color: #0d0d0f;
    --card-color: #161616;
    --primary-gradient: linear-gradient(135deg, #5D5FEF, #7879F1);
    --primary-solid: #5D5FEF;
    --uranium-green: #3fff00;
    --text-color: #eee;
    --secondary-text: #aaa;
    --border-color: #2a2a2a;
    --danger-color: #ff3b30;
    --success-color: #34c759;
    --input-bg: #1f1f1f;
    --header-bg: rgba(22, 22, 22, 0.85);
    --glass-bg: rgba(255, 255, 255, 0.05);
    --shadow-soft: 0 10px 30px rgba(0,0,0,0.3);
    --sheet-bg: #1e1e1e;
}

body.light-mode {
    --bg-color: #f2f4f7;
    --card-color: #ffffff;
    --text-color: #1a1a1a;
    --secondary-text: #666;
    --border-color: #e0e0e0;
    --input-bg: #f0f2f5;
    --header-bg: rgba(255, 255, 255, 0.85);
    --glass-bg: rgba(0, 0, 0, 0.05);
    --shadow-soft: 0 5px 20px rgba(0,0,0,0.05);
    --sheet-bg: #fff;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Cairo", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: var(--bg-color); color: var(--text-color); overflow-x: hidden; padding-bottom: 90px; transition: background 0.3s, color 0.3s; overscroll-behavior-y: contain; user-select: none; }
body.no-scroll { overflow: hidden !important; position: fixed; width: 100%; left: 0; right: 0; }
a { text-decoration: none; color: inherit; }
button { border: none; outline: none; background: none; cursor: pointer; }

/* ========================================= */
/* 2. Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… (Header & Navigation)  */
/* ========================================= */
.header { 
    display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; 
    border-bottom: 1px solid var(--border-color); position: sticky; top: 0; 
    background: var(--header-bg); z-index: 50; backdrop-filter: blur(12px); 
}
.header-title { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
.side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
.side-menu-overlay.visible { opacity: 1; }
.side-menu { 
    position: fixed; top: 0; left: 0; height: 100%; width: 280px; 
    background: var(--card-color); z-index: 101; transform: translateX(-100%); 
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
    border-right: 1px solid var(--border-color); display: flex; flex-direction: column;
}
.side-menu.open { transform: translateX(0); }
.menu-header { padding: 40px 20px; text-align: center; background: linear-gradient(to bottom, rgba(93,95,239,0.1), transparent); }
.menu-avatar { width: 70px; height: 70px; border-radius: 50%; background: var(--primary-solid); margin: 0 auto 12px; display: grid; place-items: center; font-size: 26px; font-weight: bold; background-size: cover; border: 2px solid var(--border-color); box-shadow: var(--shadow-soft); }
.menu-items { flex: 1; padding-top: 10px; overflow-y: auto; }
.menu-item { padding: 16px 25px; display: flex; gap: 18px; cursor: pointer; color: var(--text-color); align-items: center; font-weight: 600; font-size: 15px; transition: 0.2s; border-left: 3px solid transparent; }
.menu-item:hover { background: var(--glass-bg); border-left-color: var(--primary-solid); }
.menu-item i { width: 24px; color: var(--primary-solid); font-size: 18px; text-align: center; }

/* Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Switch) */
.toggle-switch { width: 36px; height: 20px; background: #333; border-radius: 20px; position: relative; transition: 0.3s ease; border: 1px solid var(--border-color); }
.toggle-switch.active { background: var(--primary-solid); border-color: var(--primary-solid); }
.toggle-knob { width: 14px; height: 14px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.toggle-switch.active .toggle-knob { left: 18px; }

/* ========================================= */
/* 3. Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Profile UI)          */
/* ========================================= */
.cover { height: 180px; background: linear-gradient(45deg, #141414, #2b1055, #5D5FEF); position: relative; transition: background 0.5s ease; }
.edit-cover-btn { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.4); color: #fff; width: 35px; height: 35px; border-radius: 50%; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); font-size: 14px; transition: 0.2s; z-index: 10; }
.avatar-container { position: absolute; bottom: -55px; left: 50%; transform: translateX(-50%); z-index: 20; }

.avatar {
    position: relative !important; overflow: visible !important;
    width: 110px; height: 110px; border-radius: 40%; 
    border: 4px solid var(--bg-color); background: var(--card-color); 
    display: grid; place-items: center; font-size: 35px; font-weight: 900; 
    background-size: cover; color: var(--text-color); box-shadow: var(--shadow-soft); 
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ÙˆÙ‚Øª */
.profile-status-badge {
    position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
    background: #000; color: #39ff14 !important; border: 1px solid #39ff14;
    font-size: 10px !important; font-weight: 800; padding: 3px 10px; border-radius: 20px;
    z-index: 102; box-shadow: 0 4px 10px rgba(0,0,0,0.6); pointer-events: none;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.profile-online-dot {
    position: absolute; bottom: 5px; right: 5px; width: 18px; height: 18px;
    background-color: #39ff14; border: 3px solid var(--card-color); border-radius: 50%;
    z-index: 103; display: none; box-shadow: 0 0 10px rgba(57, 255, 20, 0.8);
}
.profile-online-dot.active { display: block !important; animation: pulse-green 2s infinite; }

.info { margin-top: 65px; text-align: center; padding: 0 20px; }
.name { font-size: 26px; font-weight: 800; display: flex; justify-content: center; align-items: center; gap: 6px; letter-spacing: -0.5px; }
.username { font-size: 14px; color: var(--secondary-text); margin-top: 2px; direction: ltr; font-weight: 600; }
.bio { margin: 15px auto; font-size: 15px; color: var(--text-color); max-width: 500px; line-height: 1.6; opacity: 0.9; }

.about-item { display: flex; align-items: center; gap: 12px; font-size: 15px; color: var(--text-color); margin-bottom: 12px; }
.about-item i { width: 25px; color: var(--secondary-text); text-align: center; font-size: 18px; }

/* Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø´Ø¹ */
#copyBtn {
    background: #000; color: #39ff14; border: 2px solid #39ff14; border-radius: 50px;
    padding: 6px 15px; font-size: 12px; font-weight: 900; box-shadow: 0 0 10px #39ff14;
    animation: uraniumPulse 1.5s infinite alternate; margin-top: 8px; cursor: pointer;
    transition: 0.3s; display: none; align-items: center; gap: 8px;
}
#copyBtn:hover { background: #39ff14; color: #000; box-shadow: 0 0 40px #39ff14; transform: scale(1.05); }

/* Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
.stats-container { display: flex; justify-content: center; gap: 15px; margin: 25px 20px; padding: 15px; background: var(--card-color); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
.stat-item { text-align: center; cursor: pointer; flex: 1; }
.stat-count { font-size: 20px; font-weight: 800; color: var(--text-color); }
.stat-label { font-size: 12px; color: var(--secondary-text); font-weight: 600; }

.buttons { display: flex; gap: 12px; padding: 0 20px; justify-content: center; margin-bottom: 20px; }
.btn { height: 48px; border-radius: 16px; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; flex: 1; position: relative; overflow: hidden; }
.btn-primary { background: var(--primary-gradient); color: #fff; flex: 2; box-shadow: 0 8px 20px rgba(93, 95, 239, 0.3); }
.btn-secondary { background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
.btn-chat { background: var(--uranium-green); color: #000; width: 48px; flex: 0 0 48px; border-radius: 16px; font-size: 18px; box-shadow: 0 5px 15px rgba(63, 255, 0, 0.2); }
.btn:active { transform: scale(0.96); }

/* ========================================= */
/* 4. Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ (Tabs & Grid)       */
/* ========================================= */
.profile-tabs { display: flex; justify-content: space-around; border-bottom: 1px solid var(--border-color); background: var(--card-color); position: sticky; top: 70px; z-index: 40; margin-bottom: 10px; }
.tab-item { flex: 1; text-align: center; padding: 15px 0; font-weight: 700; color: var(--secondary-text); cursor: pointer; position: relative; transition: 0.3s; }
.tab-item.active { color: var(--primary-solid); }
.tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 3px; background: var(--primary-solid); border-radius: 3px 3px 0 0; }
.tab-content { display: none; animation: fadeIn 0.4s ease; }
.tab-content.active { display: block; }

.photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
.photo-item { aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: pointer; background: #222; }
.reels-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; padding: 3px; }
.reel-item { position: relative; aspect-ratio: 9/16; background: #000; border-radius: 6px; overflow: hidden; cursor: pointer; }
.reel-thumb { width: 100%; height: 100%; object-fit: cover; }
.reel-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%); display: flex; flex-direction: column; justify-content: flex-end; padding: 8px; }
.reel-stats { color: #fff; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 5px; }

/* ========================================= */
/* 5. Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (Posts & Feeds)              */
/* ========================================= */
.new-post-wrapper { background: var(--card-color); margin: 0 15px 20px; border-radius: 18px; border: 1px solid var(--border-color); padding: 15px; display: flex; align-items: center; gap: 12px; }
.np-input-trigger { flex: 1; background: var(--input-bg); border-radius: 30px; padding: 12px 20px; color: var(--secondary-text); font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
.np-mini-avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; background-size: cover; }
.np-media-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; background: rgba(52, 199, 89, 0.1); color: var(--success-color); }

.post { background: var(--card-color); border: 1px solid var(--border-color); margin: 0 0 15px; padding-bottom: 5px; }
@media (min-width: 700px) { .post { border-radius: 18px; margin: 0 15px 15px; } }
.post-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; }
.user-info { display: flex; gap: 12px; align-items: center; }
.post-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; display: grid; place-items: center; font-weight: bold; background-size: cover; border: 1px solid var(--border-color); }
.user-details h4 { font-size: 15px; font-weight: 700; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
.user-details span { font-size: 12px; color: var(--secondary-text); }
.post-text { padding: 0 15px 12px; font-size: 15px; line-height: 1.6; color: var(--text-color); white-space: pre-wrap; }
.post-text.has-bg { min-height: 280px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 26px; font-weight: 800; color: #fff; padding: 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }

.media-grid { display: grid; gap: 2px; margin-top: 5px; background: #000; overflow: hidden; }
.media-grid.single { grid-template-columns: 1fr; }
.media-grid.double { grid-template-columns: 1fr 1fr; }
.media-item { width: 100%; max-height: 550px; object-fit: cover; display: block; cursor: pointer; }

.video-mute-btn { position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; background: rgba(0, 0, 0, 0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; z-index: 20; backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.1); }
.post-actions { display: flex; padding: 8px 15px; border-top: 1px solid var(--border-color); gap: 5px; }
.action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; color: var(--secondary-text); font-size: 14px; font-weight: 600; border-radius: 10px; cursor: pointer; transition: 0.2s; }
.action-btn.liked { color: var(--danger-color); background: rgba(255, 59, 48, 0.05); }

/* ========================================= */
/* 6. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Bottom Sheets)        */
/* ========================================= */
.sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; backdrop-filter: blur(4px); }
.bottom-sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; background: var(--sheet-bg); 
    z-index: 201; border-radius: 24px 24px 0 0; transform: translateY(100%); 
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
    border-top: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 85vh;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
}
.bottom-sheet.active { transform: translateY(0); }
.sheet-handle { width: 40px; height: 5px; background: var(--border-color); border-radius: 10px; margin: 12px auto; }
.sheet-option { padding: 12px 20px; display: flex; gap: 15px; align-items: center; font-weight: 600; cursor: pointer; border-radius: 10px; transition: 0.2s; color: var(--text-color); }
.sheet-option:hover { background: var(--input-bg); }
.sheet-close-btn { position: absolute; left: 20px; top: 15px; font-size: 24px; color: var(--secondary-text); cursor: pointer; z-index: 10; padding: 5px; }

/* ========================================= */
/* 7. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ« (Comments System)*/
/* ========================================= */
.cm-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 16px; background: var(--sheet-bg); z-index: 10; border-radius: 24px 24px 0 0; }
.cm-body { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; background: var(--sheet-bg); }
.cm-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px 15px 15px; border-top: 1px solid var(--border-color); background: var(--sheet-bg); z-index: 202; }

.cm-input-wrapper { display: flex; align-items: center; background: var(--input-bg); border-radius: 25px; padding: 5px 15px; border: 1px solid var(--border-color); }
.cm-input { flex: 1; background: transparent; border: none; padding: 10px 5px; color: var(--text-color); outline: none; max-height: 100px; resize: none; font-size: 15px; }
.cm-send-btn { color: var(--primary-solid); padding: 8px; cursor: pointer; transition: 0.2s; font-size: 18px; }
.cm-send-btn.update-mode { color: var(--success-color); }

/* Ø§Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
.color-0 { --user-color: #5D5FEF; }
.color-1 { --user-color: #34c759; }
.color-2 { --user-color: #ff3b30; }
.color-3 { --user-color: #ffb533; }
.color-4 { --user-color: #bf5af2; }
.color-5 { --user-color: #64d2ff; }
.color-6 { --user-color: #ff9f0a; }
.color-7 { --user-color: #ff375f; }
.color-8 { --user-color: #ac8e68; }
.color-9 { --user-color: #808080; }

.comment-item { display: flex; gap: 10px; margin-bottom: 18px; position: relative; }
.cm-avatar { width: 38px; height: 38px; border-radius: 50%; background: #333; flex-shrink: 0; background-size: cover; border: 1px solid var(--border-color); }
.cm-content { flex: 1; max-width: 85%; }

/* Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
.cm-bubble { background: #262626; border: 1px solid #333; padding: 10px 14px; border-radius: 18px; border-top-right-radius: 2px; color: #eee; min-width: 120px; position: relative; }
.cm-bubble.colored-comment { position: relative; background: #1a1a1a; border: 1px solid var(--user-color); border-right-width: 4px; box-shadow: inset 0 0 10px -5px var(--user-color), 0 5px 15px -8px var(--user-color); transition: 0.2s; }
.cm-bubble.colored-comment .cm-username { color: var(--user-color) !important; filter: brightness(1.3); margin-bottom: 5px; }

/* ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± */
.cm-bubble.owner-bubble { background: rgba(93, 95, 239, 0.25); border: 1px solid #5D5FEF; box-shadow: 0 0 10px rgba(93, 95, 239, 0.1); }
.owner-badge { font-size: 10px; background: #5D5FEF; color: #fff; padding: 1px 6px; border-radius: 8px; display: inline-block; }

.cm-username { font-weight: 800; font-size: 13px; color: #ffffff !important; margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
.cm-text { font-size: 15px; line-height: 1.6; color: #e0e0e0; white-space: pre-wrap; word-break: break-word; }
.cm-meta-row { display: flex; gap: 15px; margin-top: 5px; margin-right: 12px; font-size: 11px; color: var(--secondary-text); font-weight: 600; }
.cm-action { cursor: pointer; transition: 0.2s; }

/* Ø´Ø¬Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ */
.tree-connector { position: absolute; right: -24px; top: -20px; bottom: 0; width: 2px; background: #333; z-index: 0; }
.reply-curve { position: absolute; right: -24px; top: 20px; width: 15px; height: 2px; background: #333; }
.cm-bubble.colored-reply { position: relative; transition: 0.2s; background: #1a1a1a; border: 1px solid var(--user-color); border-right-width: 4px; box-shadow: inset 0 0 10px -5px var(--user-color), 0 5px 15px -8px var(--user-color); border-radius: 12px; padding: 10px 14px; }
.cm-bubble.colored-reply .cm-username { color: var(--user-color) !important; filter: brightness(1.3); margin-bottom: 5px; }

/* Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø´Ù† */
.reply-mention-link { color: #2979ff; font-weight: 800; cursor: pointer; text-decoration: none; margin-left: 4px; display: inline-block; }
.sticker-comment { font-size: 70px !important; line-height: 1; background: transparent !important; border: none !important; box-shadow: none !important; padding: 10px 0 !important; display: inline-block; }
.sticker-trigger-btn { color: var(--secondary-text); padding: 8px; cursor: pointer; font-size: 22px; transition: 0.2s; margin-left: 5px; }
.stickers-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px; max-height: 350px; overflow-y: auto; }
.sticker-option { font-size: 40px; text-align: center; cursor: pointer; transition: transform 0.1s; user-select: none; }
.sticker-option:active { transform: scale(0.8); }

/* Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ */
#commentOptionsSheet .reactions-row { display: flex; justify-content: space-between; padding: 15px 25px; background: var(--input-bg); border-radius: 50px; margin: 10px 15px 20px; border: 1px solid var(--border-color); }
.reaction-emoji { font-size: 24px; cursor: pointer; transition: transform 0.2s; }
.reaction-emoji:hover { transform: scale(1.3); }
.c-option-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; font-size: 15px; font-weight: 600; color: var(--text-color); cursor: pointer; transition: 0.2s; }
.c-option-item:hover { background: var(--glass-bg); }
.c-option-item.danger { color: var(--danger-color); }
.c-option-item.danger i { color: var(--danger-color); }

/* ========================================= */
/* 8. ÙƒØ±Ø© Ø§Ù„ÙŠÙˆØ±Ø§Ù†ÙŠÙˆÙ… (Interactive Orb)       */
/* ========================================= */
.uranium-orb {
    position: fixed; bottom: 30px; left: 20px; width: 55px; height: 55px;
    background: radial-gradient(circle at 30% 30%, #fff, var(--primary-solid), #000);
    border-radius: 50%; z-index: 9999; cursor: grab;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 25px var(--primary-solid), inset -5px -5px 15px rgba(0,0,0,0.4);
    animation: pulse-orb 3s infinite alternate; touch-action: none;
    transition: box-shadow 0.3s, background 0.3s, transform 0.3s, opacity 0.3s; 
}
.uranium-orb.super-mode {
    width: 70px; height: 70px;
    box-shadow: 0 0 80px var(--primary-solid), 0 0 150px var(--primary-solid), 0 0 30px #fff; 
    animation: super-pulse 0.2s infinite alternate; 
    z-index: 10001;
    background: radial-gradient(circle at 50% 50%, #fff, var(--primary-solid));
}
.orb-msg-bubble {
    position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%) scale(0);
    background: rgba(220, 20, 60, 0.95); border: 1px solid #ff9999;
    color: #fff; padding: 8px 15px; border-radius: 15px 15px 15px 0;
    font-size: 13px; font-weight: bold; white-space: nowrap; max-width: 200px;
    overflow: hidden; text-overflow: ellipsis; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
    opacity: 0; pointer-events: none; transition: all 0.4s; z-index: 10002;
}
.satellites-container {
    position: absolute; width: 250px; height: 250px; 
    pointer-events: none; opacity: 0; transition: 0.3s;
    display: flex; align-items: center; justify-content: center;
}
.uranium-orb.super-mode .satellites-container { opacity: 1; pointer-events: auto; }
.sat-btn {
    position: absolute; width: 45px; height: 45px;
    background: rgba(20, 20, 20, 0.9); border: 2px solid var(--primary-solid);
    border-radius: 50%; color: #fff; display: grid; place-items: center;
    font-size: 18px; box-shadow: 0 0 15px rgba(0,0,0,0.5);
    cursor: pointer; transition: 0.3s;
}
.sat-btn i { color: var(--primary-solid); text-shadow: 0 0 5px var(--primary-solid); }

#deleteZone {
    position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) scale(0);
    width: 70px; height: 70px; border-radius: 50%;
    background: rgba(255, 0, 0, 0.1); border: 2px dashed #ff0000;
    color: #ff0000; display: flex; align-items: center; justify-content: center;
    font-size: 30px; transition: all 0.3s; z-index: 9998; pointer-events: none;
}

/* ========================================= */
/* 9. Ù†ÙˆØ§ÙØ° Ùˆ Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Modals & Utils)  */
/* ========================================= */
.custom-modal { position: fixed; inset: 0; z-index: 3000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
.modal-box { background: var(--card-color); width: 85%; max-width: 380px; border-radius: 24px; padding: 30px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

/* Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«ÙŠÙ… */
.theme-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10005; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.theme-modal-overlay.active { display: flex; }
.theme-card { background: #111; width: 90%; max-width: 380px; padding: 25px; border-radius: 25px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transform: scale(0.8); opacity: 0; transition: 0.3s; }
.theme-modal-overlay.active .theme-card { transform: scale(1); opacity: 1; }
.colors-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; justify-items: center; }
.color-circle { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); position: relative; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.color-circle:hover { transform: scale(1.15); border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.4); }

/* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª */
.account-list { text-align: right; max-height: 250px; overflow-y: auto; margin: 20px 0; background: var(--bg-color); border-radius: 16px; padding: 10px; }
.acc-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border-color); }
.acc-item:last-child { border-bottom: none; }
.acc-item:hover { background: var(--input-bg); }

/* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªÙˆØ³Øª */
.pull-indicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10000; background: var(--card-color); padding: 8px 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; font-weight: bold; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
#toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #222; color: #fff; padding: 12px 24px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.4s; z-index: 6000; display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
#lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.skeleton { background: linear-gradient(90deg, var(--input-bg) 25%, var(--border-color) 50%, var(--input-bg) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 6px; color: transparent !important; }

/* ========================================= */
/* 10. Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Animations)                */
/* ========================================= */
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
@keyframes popIn { from { transform: translateX(-50%) scale(0); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
@keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(57, 255, 20, 0); } 100% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0); } }
@keyframes pulse-orb { 0% { box-shadow: 0 0 15px var(--primary-solid); } 100% { box-shadow: 0 0 35px var(--primary-solid); } }
@keyframes super-pulse { 0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 60px var(--primary-solid); } 100% { transform: translate(-50%, -50%) scale(1.15); box-shadow: 0 0 120px var(--primary-solid); } }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
@keyframes uraniumPulse { 0% { box-shadow: 0 0 5px #39ff14; } 100% { box-shadow: 0 0 20px #39ff14, 0 0 10px #39ff14 inset; } }

    }
</style>


    
</head>
<body>

    <div id="pullIndicator" class="pull-indicator">
        <i class="fa-solid fa-rotate-right fa-spin" style="display:none"></i>
        <i class="fa-solid fa-arrow-down" id="pullIcon"></i>
        <span id="pullText">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ«</span>
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <div id="uraniumOrb" class="uranium-orb">
        <div id="orbMsgBubble" class="orb-msg-bubble">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©...</div>
        <div class="satellites-container">
   <div class="sat-btn" id="ghostBtn" onclick="toggleGhostMode()" style="transform: rotate(0deg) translate(80px) rotate(0deg);">
    <i class="fa-solid fa-ghost"></i>
</div>

    <div class="sat-btn" onclick="location.href='messages.html'" style="transform: rotate(72deg) translate(80px) rotate(-72deg);">
        <i class="fa-solid fa-comment-dots"></i>
    </div>
    
    <div class="sat-btn theme-btn" onclick="openThemeModal()" style="transform: rotate(144deg) translate(80px) rotate(-144deg);">
        <i class="fa-solid fa-palette"></i>
    </div>

    <div class="sat-btn" onclick="location.href='radar.html'" style="transform: rotate(216deg) translate(80px) rotate(-216deg);">
        <i class="fa-solid fa-satellite-dish"></i>
    </div>

    <div class="sat-btn" onclick="location.href='capsules.html'" style="transform: rotate(288deg) translate(80px) rotate(-288deg);">
        <i class="fa-solid fa-hourglass-half"></i>
    </div>
</div>


    </div>

    <div class="theme-modal-overlay" id="themeModal">
        <div class="theme-card">
            <div class="theme-title">ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
            <div class="theme-subtitle">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø°ÙŠ ÙŠÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ ÙˆØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</div>
            
            <div class="colors-grid">
                            <div class="colors-grid">
                <div class="color-circle" style="background: linear-gradient(135deg, #5D5FEF, #a18dff);" onclick="changeTheme('#5D5FEF')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #3fff00, #ccff00);" onclick="changeTheme('#3fff00')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #ff416c, #ff4b2b);" onclick="changeTheme('#ff416c')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #00c6ff, #0072ff);" onclick="changeTheme('#00c6ff')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #f7971e, #ffd200);" onclick="changeTheme('#f7971e')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #833ab4, #fd1d1d);" onclick="changeTheme('#fd1d1d')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #11998e, #38ef7d);" onclick="changeTheme('#11998e')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #fc00ff, #00dbde);" onclick="changeTheme('#fc00ff')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #304352, #d7d2cc);" onclick="changeTheme('#607d8b')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #cb2d3e, #ef473a);" onclick="changeTheme('#ef473a')"></div>
            </div>

            </div>

            <button class="btn-theme-action btn-reset-theme" onclick="resetTheme()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
            <button class="btn-theme-action" onclick="closeThemeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="deleteZone">
        <i class="fa-solid fa-xmark"></i>
    </div>

    <div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-avatar" id="menuAvatar">U</div>
            <div id="menuName" style="font-weight:800; color:var(--text-color); font-size:18px;">Ù…Ø³ØªØ®Ø¯Ù…</div>
        </div>
               <div class="menu-items">
            <div class="menu-item" onclick="location.href='home.html'">
                <i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </div>

            <div class="menu-item" onclick="location.href='Friend_requests.html'">
                <i class="fa-solid fa-user-plus"></i> 
                Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© 
                <span id="requestsBadge" style="background:var(--danger-color); color:white; font-size:10px; padding:2px 8px; border-radius:10px; margin-right:auto; display:none; animation: pulse 1.5s infinite;">0</span>
            </div>

            <div class="menu-item" onclick="location.href='messages.html'"><i class="fa-solid fa-comment-dots"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
            <div class="menu-item" onclick="location.href='friends.html'"><i class="fa-solid fa-users"></i> Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</div>
            
            <div class="menu-item" onclick="location.href='notifications.html'">
                <i class="fa-solid fa-bell"></i> 
                Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                <span id="mainNotifBadge" style="background:var(--danger-color); color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-right:auto; display:none;">0</span>
            </div>
                   
             <div class="menu-item" onclick="location.href='radar.html'">
    <i class="fa-solid fa-satellite-dish"></i> Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ø­ÙŠØ·
</div>
<div class="item" onclick="toggleOrbPreference()" style="flex-direction: row; justify-content: space-between; padding: 0 15px;">
    <div style="display:flex; align-items:center; gap:8px;">
        <i class="fa-solid fa-circle-nodes" style="font-size:18px;"></i> 
        <span>ÙƒØ±Ø© Ø§Ù„ØªÙ†Ù‚Ù„</span>
    </div>
    <div id="orbToggleSwitch" class="toggle-switch active">
        <div class="toggle-knob"></div>
    </div>
</div>
<div class="menu-item" onclick="toggleAppSounds()" style="justify-content: space-between;">
    <div style="display:flex; align-items:center; gap:18px;">
        <i id="soundIcon" class="fa-solid fa-volume-high" style="font-size:18px;"></i> 
        <span>Ø£ØµÙˆØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    </div>
    <div id="soundToggle" class="toggle-switch active">
        <div class="toggle-knob"></div>
    </div>
</div>

            <div class="menu-item" onclick="location.href='settings.html'"><i class="fa-solid fa-gear"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
                   <div class="menu-item" onclick="location.href='capsules.html'">
    <i class="fa-solid fa-hourglass-half"></i> ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø²Ù…Ù†
</div>

            <div class="menu-item" onclick="openAccountSwitcher()"><i class="fa-solid fa-repeat"></i> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
            <div class="menu-item" style="color:var(--danger-color); margin-top:20px; border-top:1px solid var(--border-color)" onclick="openLogoutConfirm()"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>
        </div>

    </div>

    <div class="header">
        <i class="fa-solid fa-house" onclick="location.href='home.html'" style="font-size:20px; cursor:pointer; color:var(--text-color)"></i>

        
    
    <div class="header-title" id="headerTitle">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
    
    <i class="fa-solid fa-magnifying-glass" onclick="toggleSearchBar()" style="font-size:20px; cursor:pointer; color:var(--text-color); margin-left:15px;"></i>

   

<div id="pageSearchBar" style="display:none; padding:10px 15px; background:var(--header-bg); border-bottom:1px solid var(--border-color); position:sticky; top:60px; z-index:49;">
    <input type="text" id="localSearchInput" onkeyup="filterLocalPosts()" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª..." style="width:100%; padding:10px 15px; border-radius:20px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); outline:none;">
</div>

        <i class="fa-solid fa-bars" onclick="openSideMenu()" style="font-size:22px; cursor:pointer; color:var(--primary-solid)"></i>
    </div>

    <div class="cover" id="profileCover">
        <button class="edit-cover-btn" id="editCoverBtn" onclick="openCoverPicker()">
            <i class="fa-solid fa-palette"></i>
        </button>
     <div class="avatar-container">
    <div class="avatar" id="avatar"></div>
</div>

        <div class="online-dot" id="onlineIndicator"></div>
    </div>
</div>
    </div>

    <div class="info">
        <div class="name" id="name"><div class="skeleton" style="width:140px; height:25px;"></div></div>
        <div class="username" id="username"><div class="skeleton" style="width:90px; height:15px; margin-top:5px;"></div></div>
       <button id="copyBtn" onclick="copyUsername()">
    <i class="fa-solid fa-radiation fa-spin" style="font-size:14px; --fa-animation-duration: 3s;"></i> 
    ID
</button>

        <div id="quickLocation" style="text-align:center; font-size:13px; color:var(--secondary-text); margin-bottom:10px; margin-top: 5px;"></div>
        <div class="bio" id="bio"></div>
    </div>

    <div class="stats-container">
        <div class="stat-item" onclick="viewList('following')">
            <div class="stat-count" id="followingCount">0</div><div class="stat-label">ÙŠØªØ§Ø¨Ø¹</div>
        </div>
        <div class="stat-item" onclick="viewList('followers')">
            <div class="stat-count" id="followersCount">0</div><div class="stat-label">Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</div>
        </div>
        <div class="stat-item">
            <div class="stat-count" id="likesCount">0</div><div class="stat-label">Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª</div>
        </div>
    </div>

    <div class="buttons" id="buttons">
        <div class="skeleton" style="flex:2; height:48px; border-radius:16px"></div>
        <div class="skeleton" style="flex:1; height:48px; border-radius:16px"></div>
    </div>

    <div class="profile-tabs">
        <div class="tab-item active" onclick="switchTab('all')" id="tab-all">Ø§Ù„ÙƒÙ„</div>
        <div class="tab-item" onclick="switchTab('photos')" id="tab-photos">Ø§Ù„ØµÙˆØ±</div>
        <div class="tab-item" onclick="switchTab('videos')" id="tab-videos">Ù†Ø¨Ø¶</div>
        <div class="tab-item" onclick="switchTab('about')" id="tab-about">Ù„Ù…Ø­Ø©</div>
    </div>

    <div id="content-all" class="tab-content active">
        <div class="new-post-wrapper" id="createPostWrapper" style="display:none">
            <div class="np-input-trigger" onclick="location.href='create_post.html'">
                <div class="np-mini-avatar" id="myMiniAvatar"></div>
                <span>Ø¨Ù… ØªÙÙƒØ± Ø§Ù„ÙŠÙˆÙ…ØŸ</span>
            </div>
            <div class="np-media-btn" onclick="location.href='create_media.html'"><i class="fa-solid fa-image"></i></div>
        </div>

        <div class="feed" id="feed">
            <div id="postsList"></div>
            <div id="scrollSentinel" class="loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <div id="noPostsMsg" class="empty-state" style="display:none">
                <i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:10px; opacity:0.5"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª
            </div>
        </div>
    </div>

    <div id="content-photos" class="tab-content">
        <div class="photos-grid" id="photosGrid"></div>
        <div id="noPhotosMsg" class="empty-state" style="display:none">
            <i class="fa-regular fa-images" style="font-size:40px; margin-bottom:10px; opacity:0.5"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±
        </div>
    </div>

    <div id="content-videos" class="tab-content">
        <div class="reels-grid" id="videosGrid"></div>
        <div id="noVideosMsg" class="empty-state" style="display:none">
            <i class="fa-solid fa-video" style="font-size:40px; margin-bottom:10px; opacity:0.5"></i><br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø·Ø¹ Ø±ÙŠÙ„Ø²
        </div>
    </div>

    <div id="content-about" class="tab-content">
        <div style="padding: 20px; background: var(--card-color); margin: 0 15px; border-radius: 18px; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 20px; font-size: 18px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Ø§Ù„ØªÙØ§ØµÙŠÙ„</h3>
            <div id="aboutDetailsList" style="display: flex; flex-direction: column; gap: 15px;"></div>
        </div>
    </div>

    <div class="bottom-sheet" id="cmSheet" style="height: 85vh;">
        <div class="sheet-handle"></div>
        <div class="cm-header">
            <span id="cmCount">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
            <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px"></i>
        </div>
        <div class="cm-body" id="cmList"></div>
        <div class="cm-footer">
            
            <div class="cm-input-wrapper">
    <i class="fa-solid fa-face-laugh-beam sticker-trigger-btn" onclick="toggleStickerSheet('main')"></i>
    
    <input type="text" class="cm-input" id="cmInput" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." autocomplete="off">
    <i class="fa-solid fa-paper-plane cm-send-btn" id="cmSendBtn" onclick="handleCommentAction()"></i>
</div>

        </div>
    </div>

    <div class="bottom-sheet" id="commentOptionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div class="reactions-row">
            <span class="reaction-emoji">ğŸ˜¡</span>
            <span class="reaction-emoji">ğŸ˜¢</span>
            <span class="reaction-emoji">ğŸ˜®</span>
            <span class="reaction-emoji">ğŸ˜‚</span>
            <span class="reaction-emoji">ğŸ¥°</span>
            <span class="reaction-emoji">â¤ï¸</span>
            <span class="reaction-emoji">ğŸ‘</span>
        </div>
        <div id="cmOwnerOptions">
            <div class="c-option-item" onclick="triggerEditComment()">
                <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
            </div>
            <div class="c-option-item" onclick="triggerReplyComment()">
                <i class="fa-solid fa-reply"></i> Ø±Ø¯
            </div>
            <div class="c-option-item" onclick="triggerCopyComment()">
                <i class="fa-regular fa-copy"></i> Ù†Ø³Ø®
            </div>
            <div class="c-option-item danger" onclick="triggerDeleteComment()">
                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
            </div>
        </div>
        <div id="cmViewerOptions" style="display:none">
            <div class="c-option-item" onclick="triggerReplyComment()">
                <i class="fa-solid fa-reply"></i> Ø±Ø¯
            </div>
            <div class="c-option-item" onclick="triggerCopyComment()">
                <i class="fa-regular fa-copy"></i> Ù†Ø³Ø®
            </div>
            
            <div id="ownerDeleteBtn" class="c-option-item danger" style="display:none" onclick="triggerDeleteComment()">
                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
            </div>

            <div class="c-option-item danger" onclick="reportComment()">
                <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº
            </div>
        </div>
    </div>

                      <div class="bottom-sheet" id="optionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div style="padding:10px;">
            
            <div id="privacyOptions" style="display:none; border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:10px;">
                <div style="font-size:12px; color:var(--secondary-text); padding:0 20px 10px;">Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ</div>
                <div class="sheet-option" onclick="changePrivacy('public')">
                    <i class="fa-solid fa-earth-americas"></i> Ø§Ù„Ø¹Ø§Ù…Ø©
                </div>
                <div class="sheet-option" onclick="changePrivacy('friends')">
                    <i class="fa-solid fa-user-group"></i> Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙ‚Ø·
                </div>
                <div class="sheet-option" onclick="changePrivacy('private')">
                    <i class="fa-solid fa-lock"></i> Ø£Ù†Ø§ ÙÙ‚Ø·
                </div>
            </div>

            <div id="ownerActions" style="display:none;">
                <div class="sheet-option" onclick="openEditPostModal()">
                    <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
                </div>
                <div class="sheet-option" onclick="deletePost()" style="color:var(--danger-color);">
                    <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±
                </div>
            </div>

            <div class="sheet-option" id="savePostOption" onclick="toggleSavePost()">
                <i class="fa-regular fa-bookmark" id="saveIcon"></i> <span id="saveText">Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span>
            </div>

            <div class="sheet-option" onclick="copyPostText()">
                <i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ù†Øµ
            </div>
            
            <div id="reportAction" class="sheet-option" onclick="openReportModal()" style="color:var(--warning);">
                <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±
            </div>

            <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color); margin-top:10px;" onclick="closeAllSheets()">Ø¥Ù„ØºØ§Ø¡</div>
        </div>
    </div>



            

    <div class="bottom-sheet" id="friendshipOptionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div style="padding: 10px 0;">
            <div class="sheet-option" onclick="handleFriendOption('Ø£Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø©')" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer;">
                <i class="fa-solid fa-users-gear" style="width: 25px;"></i> Ø£Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø©
            </div>
            <div class="sheet-option" onclick="handleFriendOption('Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ù‹Ø§')" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer;">
                <i class="fa-solid fa-moon" style="width: 25px;"></i> Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ù‹Ø§
            </div>
            <div class="sheet-option" onclick="handleUnfollowFromSheet()" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer;">
                <i class="fa-solid fa-rectangle-xmark" style="width: 25px;"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            </div>
            <div class="sheet-option" onclick="handleUnfriendFromSheet()" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer; color: var(--danger-color);">
                <i class="fa-solid fa-user-xmark" style="width: 25px;"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø©
            </div>
            <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color)" onclick="closeAllSheets()">Ø¥Ù„ØºØ§Ø¡</div>
        </div>
    </div>

    <div class="custom-modal" id="coverPickerModal">
        <div class="modal-box" style="max-width:350px;">
            <h3 style="margin-bottom:5px; color:var(--text-color)">Ù„ÙˆÙ† Ø§Ù„ØºÙ„Ø§Ù</h3>
            <div class="color-grid" id="colorGrid"></div>
            <button class="btn btn-secondary" style="width:100%" onclick="document.getElementById('coverPickerModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="custom-modal" id="logoutModal">
        <div class="modal-box">
            <h3 style="margin-bottom:10px; color:var(--text-color)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
            <p style="color:var(--secondary-text); margin-bottom:25px; font-size:14px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('logoutModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-primary" style="background:var(--danger-color); box-shadow:none" onclick="confirmLogout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <div class="custom-modal" id="accountSwitcherModal">
        <div class="modal-box" style="padding:25px 20px;">
            <h3 style="margin-bottom:15px;">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            <div class="account-list" id="accountList"></div>
            <div id="addAccountForm" class="login-inputs" style="display:none;">
                <input type="email" id="newAccEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                <input type="password" id="newAccPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" onclick="addNewAccountAction()">Ø¯Ø®ÙˆÙ„</button>
                    <button class="btn btn-secondary" onclick="hideAddAccountForm()">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </div>
            <div id="addAccBtnContainer" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                <button class="btn btn-primary" onclick="showAddAccountForm()"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
                <button class="btn btn-secondary" onclick="document.getElementById('accountSwitcherModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-check-circle" style="color:var(--success-color)"></i> <span id="toastMsg"></span></div>
    
    <div id="lightbox">
        <div onclick="document.getElementById('lightbox').style.display='none'" style="position:absolute; top:25px; right:25px; color:#fff; width:40px; height:40px; background:rgba(0,0,0,0.5); border-radius:50%; display:grid; place-items:center; cursor:pointer;"><i class="fa-solid fa-xmark"></i></div>
        <img id="lb-img" src="" style="max-width:100%; max-height:90vh; border-radius:10px;">
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
    // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†Ø­ÙØ¸ Ù…ÙƒØ§Ù†Ù†Ø§ ÙÙŠÙ†
let savedScrollPosition = 0;

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø°ÙƒÙŠ (Ø¨ØªØ­ÙØ¸ Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØªØ«Ø¨ØªÙ‡)
function lockScroll() {
    savedScrollPosition = window.scrollY; // 1. Ø­ÙØ¸ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ
    document.body.style.top = `-${savedScrollPosition}px`; // 2. ØªØ«Ø¨ÙŠØª Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù†Ù‚Ø·Ø©
    document.body.classList.add('no-scroll'); // 3. ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø±ÙƒØ©
}

// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ (Ø¨ØªØ±Ø¬Ø¹Ùƒ Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†)
function unlockScroll() {
    document.body.classList.remove('no-scroll'); // 1. Ø´ÙŠÙ„ Ø§Ù„ØªØ¬Ù…ÙŠØ¯
    document.body.style.top = ''; // 2. Ø´ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª
    window.scrollTo(0, savedScrollPosition); // 3. Ø±Ø¬Ø¹Ù†Ø§ Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù„ÙŠ ÙƒÙ†Ø§ ÙÙŠÙ‡ ÙÙˆØ±Ø§Ù‹
}

        // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ---
        moment.locale('ar');
        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');

        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.appspot.com",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f",
            databaseURL: "https://pools-e4381-default-rtdb.firebaseio.com" 
};
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore(), rtdb = firebase.database();
let isGhost = false;
    // Ù‚Ø§Ø¦Ù…Ø© Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø´Ø¨Ø§Ø­ (10 Ø£Ù„ÙˆØ§Ù† Ù†ÙŠÙˆÙ†)
const ghostColors = [
    "#ff0000", // Ø£Ø­Ù…Ø± (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    "#00ff00", // Ø£Ø®Ø¶Ø±
    "#0099ff", // Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ
    "#ffff00", // Ø£ØµÙØ±
    "#ff00ff", // ÙÙˆØ´ÙŠØ§
    "#00ffff", // Ø³ÙŠØ§Ù†
    "#ff9900", // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
    "#9900ff", // Ø¨Ù†ÙØ³Ø¬ÙŠ
    "#ffffff", // Ø£Ø¨ÙŠØ¶
    "#00ff99"  // ØªØ±ÙƒÙˆØ§Ø²
];

// Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ù‡ÙˆÙŠØ© Ø§Ù„Ø´Ø¨Ø­ (Ø§Ù„Ø±Ù‚Ù… + Ø§Ù„Ù„ÙˆÙ†)
function getGhostIdentity(uid) {
    if (!uid) return { id: '0000', color: '#ff0000' };
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ UID Ù„Ø£Ø±Ù‚Ø§Ù…
    let hash = 0;
    for (let i = 0; i < uid.length; i++) {
        hash = uid.charCodeAt(i) + ((hash << 5) - hash);
    }
    hash = Math.abs(hash);

    // 1. ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙÙŠ (4 Ø£Ø±Ù‚Ø§Ù…)
    const ghostID = (hash % 9000) + 1000; 

    // 2. Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const colorIndex = hash % ghostColors.length;
    
    return { 
        id: ghostID, 
        color: ghostColors[colorIndex] 
    };
}

        let profileUid = new URLSearchParams(location.search).get("uid");
        let currentUser = null, profileData = {}, currentUserName = "Ù…Ø³ØªØ®Ø¯Ù…", currentUserVerified = false, currentUserPic = "";
      
        let lastVisibleDoc = null, isLoading = false, currentPostId = null, currentPostOwnerUid = null;
        let listeners = [];
        let hasPhotos = false, hasVideos = false;

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        let selectedComment = null; // {id, uid, text, name}
        let replyToData = null; // {id, uid, name}
        let isEditingComment = false;
        let pressTimer;
        let currentParentComment = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹
let selectedReply = null; // Ø¹Ø´Ø§Ù† Ù†Ø®Ø²Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ù„ÙŠ Ø¶ØºØ·Øª Ø¹Ù„ÙŠÙ‡
let isEditingReply = false; // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø¥Ø­Ù†Ø§ Ø¨Ù†ÙƒØªØ¨ Ø±Ø¯ Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ø§ Ø¨Ù†Ø¹Ø¯Ù„

        const audioLibrary = {
            like: new Audio('https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3'),
            sent: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'),
            success: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
            click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
            tab: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3')
        };
        const globalNotifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        function playSound(type) {
            const sound = audioLibrary[type];
            if (sound) { sound.currentTime = 0; sound.volume = 0.5; sound.play().catch(e => {}); }
        }
        const coverGradients = [
            // --- ØªØ¯Ø±Ø¬Ø§Øª Ø¯Ø§ÙƒÙ†Ø© ÙˆÙØ®Ù…Ø© (Ø²ÙŠ Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©) ---
            "linear-gradient(45deg, #141414, #2b1055, #5D5FEF)", // Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ Ø§Ù„ÙƒÙˆÙ†ÙŠ (Ø§Ù„Ø­Ø§Ù„ÙŠ)
            "linear-gradient(to right, #0f0c29, #302b63, #24243e)", // Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
            "linear-gradient(to right, #000000, #434343)", // Ø£Ø³ÙˆØ¯ Ù…Ù„ÙƒÙŠ
            "linear-gradient(to right, #232526, #414345)", // Ù…Ø¹Ø¯Ù†ÙŠ ØºØ§Ù…Ù‚

            // --- ØªØ¯Ø±Ø¬Ø§Øª Ù†Ø§Ø±ÙŠØ© ÙˆÙ‚ÙˆÙŠØ© ---
            "linear-gradient(135deg, #FF9966, #FF5E62)", // Ø§Ù„ØºØ±ÙˆØ¨ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
            "linear-gradient(to right, #f12711, #f5af19)", // Ù„Ù‡Ø¨ Ø§Ù„Ø°Ù‡Ø¨
            "linear-gradient(to right, #8E2DE2, #4A00E0)", // Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ Ø§Ù„Ø³Ø§Ø·Ø¹
            "linear-gradient(to right, #ff512f, #dd2476)", // Ø§Ù„ÙÙˆØ´ÙŠØ§ Ø§Ù„Ù†Ø§Ø±ÙŠ

            // --- ØªØ¯Ø±Ø¬Ø§Øª Ø²Ø±Ù‚Ø§Ø¡ ÙˆÙ…Ø§Ø¦ÙŠØ© ---
            "linear-gradient(135deg, #4facfe, #00f2fe)", // Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ù‚
            "linear-gradient(to right, #00c6ff, #0072ff)", // Ø£Ø²Ø±Ù‚ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ
            "linear-gradient(to right, #1c92d2, #f2fcfe)", // Ø³Ù…Ø§Ø¡ ØµØ§ÙÙŠØ©
            "linear-gradient(to right, #00d2ff, #3a7bd5)", // Ù…ÙˆØ¬Ø© Ø²Ø±Ù‚Ø§Ø¡

            // --- ØªØ¯Ø±Ø¬Ø§Øª Ø®Ø¶Ø±Ø§Ø¡ ÙˆØ·Ø¨ÙŠØ¹ÙŠØ© ---
            "linear-gradient(135deg, #43e97b, #38f9d7)", // Ø§Ù„Ù†Ø¹Ù†Ø§Ø¹ Ø§Ù„Ù…Ù†Ø¹Ø´
            "linear-gradient(to right, #11998e, #38ef7d)", // Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡
            "linear-gradient(to right, #00b09b, #96c93d)", // Ù„ÙŠÙ…ÙˆÙ†ÙŠ Ù…ØªØ¯Ø±Ø¬

            // --- ØªØ¯Ø±Ø¬Ø§Øª "Ù…Ø­Ø¨Ø´Ø©" ÙˆÙ…Ù…ÙŠØ²Ø© ---
            "linear-gradient(to right, #FC466B, #3F5EFB)", // Ù…Ø²ÙŠØ¬ ÙˆØ±Ø¯ÙŠ ÙˆØ£Ø²Ø±Ù‚
            "linear-gradient(to right, #c94b4b, #4b134f)", // Ù†Ø¨ÙŠØªÙŠ ØºØ§Ù…Ù‚
            "linear-gradient(to right, #ff00cc, #333399)", // Ù†ÙŠÙˆÙ† Ù„ÙŠÙ„ÙŠ
            "linear-gradient(to right, #fc00ff, #00dbde)", // Ø­Ù„ÙˆÙ‰ Ù…Ø¶ÙŠØ¦Ø©
            "linear-gradient(to right, #8360c3, #2ebf91)"  // Ø¨Ù†ÙØ³Ø¬ÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø¶Ø±
        ];

        // --- Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ---
        // --- Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ (Ø§Ù„Ù…Ø¹Ø¯Ù„) ---
const videoObserver = new IntersectionObserver((entries) => {
    // Ø§Ù„ØªØ­Ù‚Ù‚: Ù‡Ù„ ÙÙŠÙ‡ Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ
    const isSheetOpen = document.getElementById('overlay').style.display === 'block';

    entries.forEach(entry => {
        // Ù„Ùˆ ÙÙŠÙ‡ Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø©ØŒ ÙˆÙ‚Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±Ø§Ù‹ ÙˆÙ…ØªØ±ÙƒØ²Ø´ Ù…Ø¹Ø§Ù‡
        if (isSheetOpen) {
            entry.target.pause();
            return;
        }

        // Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ: Ø´ØºÙ„ Ù„Ùˆ Ø¸Ø§Ù‡Ø±ØŒ ÙˆÙ‚Ù Ù„Ùˆ Ø§Ø®ØªÙÙ‰
        if (entry.isIntersecting && entry.intersectionRatio >= 0.7) {
            entry.target.play().catch(()=>{});
        } else {
            entry.target.pause();
        }
    });
}, { threshold: 0.7 });


        const scrollObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoading) loadPosts(true);
        }, { threshold: 0.1 });

        // --- Ø§Ù„Ø¨Ø¯Ø¡ ---
        auth.onAuthStateChanged(async user => {
            if (!user) { location.href = "index.html"; return; }
            checkGhostStatus();
                        // --- Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ---
            
            const myStatusRef = rtdb.ref('/status/' + user.uid);
            
            const isOffline = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP };
            const isOnline = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP };

            rtdb.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === false) return;
                
                // Ù„Ù…Ø§ ØªÙØµÙ„ØŒ Ø­ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ†
                myStatusRef.onDisconnect().set(isOffline).then(() => {
                    // Ø·ÙˆÙ„ Ù…Ø§ Ø£Ù†Øª Ù…ØªØµÙ„ØŒ Ø®Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                    myStatusRef.set(isOnline);
                            // Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‡ÙŠØ®Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© ØªÙ†ÙˆØ± Ø¹Ù†Ø¯Ùƒ Ø£Ù†Øª Ø´Ø®ØµÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹
        if(profileUid === user.uid) document.getElementById('onlineIndicator').classList.add('active');

                });
            });
            // --- Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ---

            currentUser = user;
            if (!profileUid) profileUid = user.uid;
            
            listeners.forEach(unsub => unsub()); listeners = [];
            
            const myDoc = await db.collection("users").doc(currentUser.uid).get();
            if(myDoc.exists) {
                const md = myDoc.data();
                currentUserName = md.name || "Ù…Ø³ØªØ®Ø¯Ù…";
currentUserVerified = md.isVerified || false;
currentUserPic = md.profilePic || ""; // <-- Ø¯Ù‡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ­ÙØ¸ ØµÙˆØ±ØªÙƒ

                
                const menuBadge = currentUserVerified ? 
                    '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:5px; font-size:16px;"></i>' : '';
                
                document.getElementById('menuName').innerHTML = currentUserName + " " + menuBadge;
                document.getElementById('menuName').style.display = "flex";
                document.getElementById('menuName').style.justifyContent = "center";
                document.getElementById('menuName').style.alignItems = "center";
                document.getElementById('menuName').style.gap = "5px";

                if(md.profilePic) {
                    document.getElementById('menuAvatar').style.backgroundImage = `url('${md.profilePic}')`;
                    document.getElementById('menuAvatar').innerText = "";
                }
            }

            updateRequestsBadge();
            updateMainNotifBadge();
            await loadProfile();
            loadPosts();
            
            const sentinel = document.getElementById('scrollSentinel');
            if(sentinel) scrollObserver.observe(sentinel);

            db.collection('notifications').where('recipientId', '==', currentUser.uid).where('read', '==', false)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && (Date.now() - (change.doc.data().createdAt?.toDate().getTime() || Date.now())) < 10000) {
                        globalNotifSound.play().catch(e => {});
                        showToast("ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯");
                    }
                });
            });
        });

        // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
        async function loadProfile() {
            try {
                const doc = await db.collection("users").doc(profileUid).get();
                if (!doc.exists) return;
                profileData = doc.data();

                const d = profileData;
                const disp = d.name || d.email.split("@")[0];
                const badge = d.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#34c759;margin-right:5px;font-size:16px;"></i>' : '';
                
                document.getElementById('headerTitle').innerText = disp;
                document.getElementById('name').innerHTML = disp + badge;
                document.getElementById('username').innerText = d.username ? "@" + d.username : "";
                document.getElementById('bio').innerText = d.bio || "";
                document.getElementById('copyBtn').style.display = 'inline-block';
                
                if(d.location) {
                    document.getElementById('quickLocation').innerHTML = `<i class="fa-solid fa-location-dot"></i> ÙŠÙ‚ÙŠÙ… ÙÙŠ ${d.location}`;
                }

                const aboutList = document.getElementById('aboutDetailsList');
                if(aboutList) {
                    aboutList.innerHTML = ""; 
                    const fields = [
                        { icon: 'fa-briefcase', text: d.work, prefix: 'ÙŠØ¹Ù…Ù„ Ù„Ø¯Ù‰ ' },
                        { icon: 'fa-graduation-cap', text: d.education, prefix: 'Ø¯Ø±Ø³ ÙÙŠ ' },
                        { icon: 'fa-house-chimney', text: d.location, prefix: 'ÙŠÙ‚ÙŠÙ… ÙÙŠ ' },
                        { icon: 'fa-link', text: d.website, isLink: true }
                    ];

                    fields.forEach(item => {
                        if (item.text) {
                            const div = document.createElement('div');
                            div.className = 'about-item';
                            div.innerHTML = `<i class="fa-solid ${item.icon}"></i> <span>${item.prefix || ''} ${item.text}</span>`;
                            aboutList.appendChild(div);
                        }
                    });
                    
                    if(aboutList.innerHTML === "") {
                        aboutList.innerHTML = "<div style='color:var(--secondary-text); text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>";
                    }
                }

                if (d.coverGradient) document.getElementById('profileCover').style.background = d.coverGradient;

                const av = document.getElementById('avatar');
                if(d.profilePic) {
                    av.style.backgroundImage = `url('${d.profilePic}')`; av.innerText = "";
                } else {
                    av.innerText = disp[0].toUpperCase(); av.style.backgroundColor = generateColor(profileUid); av.style.backgroundImage = "none";
                }

                // --- ØªØ¹Ø¯ÙŠÙ„: Ø¯Ù…Ø¬ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ† Ù…Ø¹ Ø§Ù„ÙˆÙ‡Ù…ÙŠÙŠÙ† ---
listeners.push(db.collection("users").doc(profileUid).collection("followers").onSnapshot(s => {
    // 1. Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²)
    const realCount = s.size;
    
    // 2. Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ù‚Ù… ÙˆÙ‡Ù…ÙŠ Ø¨Ù†Ø­Ø³Ø¨Ù‡ ØµÙØ±
    const fakeCount = profileData.fakeFollowersCount || 0; 
    
    // 3. Ø§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø¹Ø±Ø¶ (Ø¨Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø´Ø§Ù† ØªØ·Ù„Ø¹ 1K Ù„Ùˆ Ø§Ù„Ø±Ù‚Ù… ÙƒØ¨ÙŠØ±)
    const total = realCount + fakeCount;
    document.getElementById('followersCount').innerText = formatNumber(total);
}));
                listeners.push(db.collection("users").doc(profileUid).collection("following").onSnapshot(s => document.getElementById('followingCount').innerText = s.size));
                listeners.push(db.collection("posts").where("uid", "==", profileUid).onSnapshot(snap => {
                    let totalLikes = 0;
                    snap.forEach(doc => { totalLikes += Object.keys(doc.data().likes || {}).length; });
                    document.getElementById('likesCount').innerText = totalLikes;
                }));

                if(profileUid === currentUser.uid) {
                    document.getElementById('editCoverBtn').style.display = 'flex';
                    document.getElementById('createPostWrapper').style.display = 'flex';
                    const myMini = document.getElementById('myMiniAvatar');
                    if(profileData.profilePic) myMini.style.backgroundImage = `url('${profileData.profilePic}')`;
                    else myMini.style.backgroundColor = generateColor(currentUser.uid);
                    setupButtons(false, false, false, false, true);
                } else {
                    checkRelationship();
                }

            } catch(e) { console.error(e); }
                        // ============ Ø¨Ø¯Ø§ÙŠØ©            // ============ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) ============
            if (profileUid) {
                // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù€ Realtime Database
                rtdb.ref('/status/' + profileUid).on('value', (snapshot) => {
                    const status = snapshot.val();
                    const container = document.getElementById('avatar'); // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£Ø¨ Ù„Ù„ØµÙˆØ±Ø©
                    
                    // Ø­Ù…Ø§ÙŠØ©: Ù„Ùˆ Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©ØŒ Ù†ÙˆÙ‚Ù ÙÙˆØ±Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Error
                    if (!container) return;

                    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø­Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© (Ø¹Ø´Ø§Ù† Ù…ØªØªØ±Ø§ÙƒÙ…Ø´ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª)
                    const oldDot = container.querySelector('.profile-online-dot');
                    const oldBadge = container.querySelector('.profile-status-badge');
                    if (oldDot) oldDot.remove();
                    if (oldBadge) oldBadge.remove();

                    // === Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ø´ÙŠÙ„Ù†Ø§ Ø§Ù„Ù…ØªØºÙŠØ± isOnlineFeatureEnabled Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø¨ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ===

                    // Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (ÙØ§ØªØ­ Ø¯Ù„ÙˆÙ‚ØªÙŠ)
                    if (status && status.state === 'online') {
                        const dot = document.createElement('div');
                        dot.className = 'profile-online-dot active';
                        container.appendChild(dot);
                    } 
                    // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ù†Ø´ÙˆÙ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±)
                    else if (profileData && profileData.lastSeen) {
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØ© Ø§Ù„ÙˆÙ‚Øª (Ø³ÙˆØ§Ø¡ Timestamp Ø£Ùˆ Ø±Ù‚Ù… Ø¹Ø§Ø¯ÙŠ)
                        let lastSeenTime;
                        if (typeof profileData.lastSeen.toMillis === 'function') {
                            lastSeenTime = profileData.lastSeen.toMillis();
                        } else {
                            lastSeenTime = profileData.lastSeen;
                        }

                        const timeText = getShortLastSeen(lastSeenTime);
                        
                        if (timeText) {
                            const badge = document.createElement('div');
                            badge.className = 'profile-status-badge';
                            // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø© Ù„Ù„Ø³Ø§Ø¹Ø© Ù„Ø´ÙƒÙ„ Ø£Ø¬Ù…Ù„
                            badge.innerHTML = `<i class="fa-regular fa-clock" style="font-size:9px; margin-left:3px;"></i> Ù†Ø´Ø· ${timeText}`; 
                            container.appendChild(badge);
                        }
                    }
                });
            }
            }
            // ============ Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© ============

        function openCoverPicker() {
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = "";
            coverGradients.forEach(grad => {
                const div = document.createElement('div');
                div.className = 'color-swatch';
                div.style.background = grad; // ØªÙƒÙ…Ù„Ø© Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ù…Ù‚Ø·ÙˆØ¹
                div.onclick = () => saveCover(grad);
                grid.appendChild(div);
            });
            document.getElementById('coverPickerModal').style.display = 'flex';
        }

        async function saveCover(gradient) {
            playSound('click');
            document.getElementById('profileCover').style.background = gradient;
            document.getElementById('coverPickerModal').style.display = 'none';
            try {
                await db.collection("users").doc(currentUser.uid).update({ coverGradient: gradient });
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„ØºÙ„Ø§Ù");
            } catch(e) { showToast("Ø­Ø¯Ø« Ø®Ø·Ø£"); }
        }

        function switchTab(tabName) {
            playSound('tab');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.add('active');
        }

        async function loadPosts(more = false) {
            if(isLoading) return; isLoading = true;
            let q = db.collection("posts").where("uid", "==", profileUid).orderBy("createdAt", "desc").limit(8);
            if(more && lastVisibleDoc) q = q.startAfter(lastVisibleDoc);

            try {
                const snap = await q.get();
                if(snap.empty) {
                    document.getElementById('scrollSentinel').style.display = 'none';
                    if(!more) {
                        const list = document.getElementById('postsList');
                        if(!list.hasChildNodes()) document.getElementById('noPostsMsg').style.display='block';
                        if(!hasPhotos) document.getElementById('noPhotosMsg').style.display='block';
                        if(!hasVideos) document.getElementById('noVideosMsg').style.display='block';
                    }
                    isLoading = false;
                    return;
                }

                lastVisibleDoc = snap.docs[snap.docs.length-1];
                
                for(const doc of snap.docs) {
                    const data = {id: doc.id, ...doc.data()};
                    renderPost(data);
                    distributeMedia(data);
                }
            } catch (e) { console.log(e); document.getElementById('scrollSentinel').style.display='none'; }
            isLoading = false;
        }

        function distributeMedia(post) {
            if(post.media && post.media.length > 0) {
                post.media.forEach(m => {
                    if(m.type === 'video') {
                        addToVideoGrid(m.url, post.text || 'ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯', post.views || 0, post.id);
                        hasVideos = true;
                        document.getElementById('noVideosMsg').style.display='none';
                    } else {
                        addToPhotoGrid(m.url);
                        hasPhotos = true;
                        document.getElementById('noPhotosMsg').style.display='none';
                    }
                });
            } else if(post.imageUrl) {
                addToPhotoGrid(post.imageUrl);
                hasPhotos = true;
                document.getElementById('noPhotosMsg').style.display='none';
            }
        }

        function addToPhotoGrid(url) {
            const div = document.createElement('div');
            div.innerHTML = `<img src="${url}" class="photo-item" loading="lazy" onclick="openLightbox('${url}')">`;
            document.getElementById('photosGrid').appendChild(div);
        }

        function addToVideoGrid(url, title, viewsCount, postId) {
            const views = formatNumber(viewsCount);
            const div = document.createElement('div');
            div.className = 'reel-item';
            div.onclick = () => location.href = `videos.html?src=${encodeURIComponent(url)}&id=${postId}`;
            div.innerHTML = `
                <video src="${url}" class="reel-thumb" muted preload="metadata"></video>
                <div class="reel-icon"><i class="fa-solid fa-play"></i></div>
                <div class="reel-overlay">
                    <div class="reel-title">${title}</div>
                    <div class="reel-stats"><i class="fa-regular fa-eye"></i> ${views}</div>
                </div>
            `;
            document.getElementById('videosGrid').appendChild(div);
        }

                    /* ========================================= */
    /* Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ) */
    /* ========================================= */
    function renderPost(p) {
        const isLiked = p.likes && p.likes[currentUser.uid];
        
        // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
        let privacyIcon = '<i class="fa-solid fa-earth-americas" title="Ø§Ù„Ø¹Ø§Ù…Ø©"></i>';
        if(p.visibility === 'friends') privacyIcon = '<i class="fa-solid fa-user-group" title="Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡"></i>';
        if(p.visibility === 'private') privacyIcon = '<i class="fa-solid fa-lock" title="Ø£Ù†Ø§ ÙÙ‚Ø·"></i>';

        let mediaHtml = "";
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ³Ø§Ø¦Ø·
        if(p.media && p.media.length) {
            // ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø´Ø¨ÙƒØ© (ÙØ±Ø¯ÙŠ ÙˆÙ„Ø§ Ø²ÙˆØ¬ÙŠ)
            const gridClass = p.media.length > 1 ? 'double' : 'single';
            mediaHtml = `<div class="media-grid ${gridClass}">`;
            
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¶ÙŠÙÙ†Ø§ (idx) Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù ØªØ±ØªÙŠØ¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            p.media.forEach((m, idx) => {
                if(m.type === 'video') {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
                    const uniqueVideoId = `vid-${p.id}-${idx}`;
                    
                    // Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: Ø¶ÙŠÙÙ†Ø§ index Ø¹Ø´Ø§Ù† ÙŠØ­Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ù„Ø¸Ø¨Ø·
                    // ÙˆØ¶ÙŠÙÙ†Ø§ post Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ø¨ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø¯Ù‡
                    const videoLink = `videos.html?id=${p.id}&post=${p.id}&index=${idx}&src=${encodeURIComponent(m.url)}`;

                    mediaHtml += `
                    <div style="position:relative; overflow:hidden; border-radius:4px;">
                        <video 
                            src="${m.url}" 
                            id="${uniqueVideoId}" 
                            class="media-item" 
                            loop 
                            playsinline 
                            muted 
                            loading="lazy" 
                            onplay="incrementViewCount('${p.id}'); startLiveViews('${p.id}')" 
                            onpause="stopLiveViews()"
                            onclick="location.href='${videoLink}'"
                        ></video>
                        
                        <div style="position:absolute; bottom:10px; left:10px; color:#fff; font-size:12px; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px; pointer-events:none; display:flex; align-items:center; gap:4px; z-index:5;">
                            <i class="fa-regular fa-eye"></i> <span id="vid-views-${p.id}">${formatNumber(p.views || 0)}</span>
                        </div>

                        <div class="video-mute-btn" onclick="toggleMute(event, '${uniqueVideoId}', this)">
                            <i class="fa-solid fa-volume-xmark"></i>
                        </div>
                    </div>`;
                
                } else {
                    // Ù„Ùˆ ØµÙˆØ±Ø©
                    mediaHtml += `<img src="${m.url}" class="media-item" loading="lazy" onclick="openLightbox('${m.url}')">`;
                }
            });
            mediaHtml += `</div>`;
        } 
        else if(p.imageUrl) {
            mediaHtml = `<div class="media-grid single"><img src="${p.imageUrl}" class="media-item" loading="lazy" onclick="openLightbox('${p.imageUrl}')"></div>`;
        } 
        else if(p.background) {
            mediaHtml = `<div class="post-text has-bg" style="background:${p.background}">${p.text}</div>`;
            p.text = ""; 
        }

        const div = document.createElement('div');
        div.className = 'post';
        div.id = `post-${p.id}`;
        div.innerHTML = `
            <div class="post-header">
                <div class="user-info" onclick="location.href='profile.html?uid=${p.uid}'" style="cursor:pointer;">
                    <div class="post-avatar" style="${profileData.profilePic?`background-image:url('${profileData.profilePic}')`: `background-color:${generateColor(p.uid)}`}">${profileData.profilePic?'':(profileData.name||'U')[0]}</div>
                    <div class="user-details">
                        <h4>${profileData.name || 'Ù…Ø³ØªØ®Ø¯Ù…'} ${profileData.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0;font-size:14px;"></i>' : ''}</h4>
                        <span>${p.createdAt ? moment(p.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†'} &bull; <span style="font-size:10px; margin-right:3px;">${privacyIcon}</span></span>
                    </div>
                </div>
                <i class="fa-solid fa-ellipsis" onclick="openOptions('${p.id}', '${p.uid}', \`${p.text || ''}\`, '${profileData.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}')" style="cursor:pointer; padding:5px; color:var(--secondary-text)"></i>
            </div>
            ${p.text ? `<div class="post-text">${p.text}</div>` : ''}
            ${mediaHtml}
            <div class="post-actions">
                <div class="action-btn ${isLiked?'liked':''}" id="like-${p.id}" onclick="toggleLike('${p.id}', '${p.uid}')">
                    <i class="${isLiked?'fa-solid':'fa-regular'} fa-heart"></i> <span id="cnt-${p.id}">${Object.keys(p.likes||{}).length}</span>
                </div>
                
                <div class="action-btn" onclick="openComments('${p.id}', '${p.uid}')">
                    <i class="fa-regular fa-comment"></i> <span>${Math.max(0, p.commentsCount || 0)}</span>
                </div>

                <div class="action-btn" onclick="sharePost('${p.id}')">
                    <i class="fa-solid fa-share-nodes"></i>
                </div>
            </div>
        `;

        // ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù†Ø´ÙˆØ± (Deep Linking)
        // ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ (Deep Linking)
const urlParams = new URLSearchParams(window.location.search);
const targetPostId = urlParams.get('post');
const targetCommentId = urlParams.get('comment');

if (targetPostId) {
    setTimeout(() => {
        const element = document.getElementById(`post-${targetPostId}`);
        if (element) {
            // 1. Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ù…Ù†Ø´ÙˆØ±
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.style.border = "2px solid var(--primary-solid)";
            element.style.boxShadow = "0 0 20px var(--primary-solid)";
            
            // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ¹Ù„ÙŠÙ‚ Ù…Ø­Ø¯Ø¯ØŒ Ø§ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
            if (targetCommentId) {
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù„ÙØªØ­ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ ownerUid Ø­Ø³Ø¨ ÙƒÙˆØ¯Ùƒ)
                const postData = document.querySelector(`#post-${targetPostId} .user-info`).getAttribute('onclick');
                // Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù€ UID Ù…Ù† Ø§Ù„Ù†Øµ (Ù…Ø«Ø§Ù„: location.href='profile.html?uid=XXX')
                const ownerUid = postData.match(/uid=([^']+)/)[1];
                
                openComments(targetPostId, ownerUid);
                
                // 3. ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡Ø§
                setTimeout(() => {
                    const commentEl = document.getElementById(`comment-${targetCommentId}`);
                    if (commentEl) {
                        commentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        commentEl.querySelector('.cm-bubble').classList.add('highlight');
                    }
                }, 1000);
            }
        }
    }, 1500); 
}

        document.getElementById('postsList').appendChild(div);
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ù„Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        div.querySelectorAll('video').forEach(v => videoObserver.observe(v));
    }

    
        function checkRelationship() {
            Promise.all([
                db.collection("users").doc(currentUser.uid).collection("friends").doc(profileUid).get(),
                db.collection("users").doc(currentUser.uid).collection("following").doc(profileUid).get(),
                db.collection("users").doc(profileUid).collection("friendRequests").doc(currentUser.uid).get(),
                db.collection("users").doc(currentUser.uid).collection("friendRequests").doc(profileUid).get()
            ]).then(([fr, fol, sent, rec]) => {
                setupButtons(fr.exists, fol.exists, sent.exists, rec.exists, false);
            });
        }

        // ==========================================
// Ø¯Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø·)
// ==========================================
function setupButtons(isFriend, isFollowing, sent, rec, isMine) {
    const container = document.getElementById('buttons');
    container.innerHTML = "";

    // 1. Ø²Ø± Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø· (Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ†)
    const optionsBtn = `<button class="btn btn-secondary" onclick="showMoreOptions()" style="flex:0 0 48px; width:48px;"><i class="fa-solid fa-ellipsis"></i></button>`;

    // 2. Ù„Ùˆ Ø¯Ù‡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ Ø£Ù†Ø§
    if(isMine) {
        container.innerHTML = `
            <button class="btn btn-primary" onclick="location.href='edit.html'"><i class="fa-solid fa-pen-to-square"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
            ${optionsBtn}
        `;
        return;
    }

    // 3. Ù„Ùˆ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø´Ø®Øµ ØªØ§Ù†ÙŠ (Ù†Ø¬Ù‡Ø² Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
    let friendBtn = '';
    if(isFriend) friendBtn = `<button class="btn btn-secondary" onclick="openFriendshipSheet()"><i class="fa-solid fa-user-check"></i> ØµØ¯ÙŠÙ‚</button>`;
    else if(rec) friendBtn = `<button class="btn btn-primary" style="background:var(--success-color)" onclick="acceptRequest()"><i class="fa-solid fa-check"></i> Ù‚Ø¨ÙˆÙ„</button>`;
    else if(sent) friendBtn = `<button class="btn btn-secondary" onclick="cancelRequest()"><i class="fa-solid fa-hourglass"></i> Ù…ÙØ¹Ù„Ù‚</button>`;
    else friendBtn = `<button class="btn btn-primary" onclick="sendRequest()"><i class="fa-solid fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>`;

    let followBtn = isFollowing 
        ? `<button class="btn btn-secondary" onclick="unfollowUser()" style="color:var(--primary-solid); border-color:var(--primary-solid)">Ù…ÙØªØ§Ø¨Ø¹</button>`
        : `<button class="btn btn-secondary" onclick="followUser()">Ù…ØªØ§Ø¨Ø¹Ø©</button>`;
    
    let chatBtn = `<button class="btn btn-chat" onclick="startChat()"><i class="fa-solid fa-comment-dots"></i></button>`;
    
    // ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¶ÙÙ†Ø§ optionsBtn ÙÙŠ Ø§Ù„Ø¢Ø®Ø± Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø±
    container.innerHTML = friendBtn + followBtn + chatBtn + optionsBtn;
}


        function pushNotification(recipientId, type, text, link) {
    if (!recipientId || recipientId === currentUser.uid) return;
    
    db.collection("notifications").add({
        recipientId: recipientId, 
        senderUid: currentUser.uid, 
        senderName: currentUserName, 
        senderPic: currentUserPic || "",
        isVerified: currentUserVerified, // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ù‡Ù†Ø§
        type: type, 
        text: text, 
        link: link, 
        read: false, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}


        function openFriendshipSheet() { playSound('click'); document.getElementById('overlay').style.display = 'block'; document.getElementById('friendshipOptionsSheet').classList.add('active'); }
        function handleFriendOption(optionName) { playSound('success'); showToast("ØªÙ… ØªÙØ¹ÙŠÙ„: " + optionName); closeAllSheets(); }
        async function handleUnfollowFromSheet() { await unfollowUser(); showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­"); closeAllSheets(); }
        
        // ==========================================
// Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø© (Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
// ==========================================
async function handleUnfriendFromSheet() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
    closeAllSheets();

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´ÙŠÙƒ Ø¨Ø¯Ù„ (confirm) Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    showChicConfirm(
        "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø©ØŸ",
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ØŸ",
        '<i class="fa-solid fa-user-xmark" style="color:var(--danger-color)"></i>', // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
        async function() {
            // Ù‡Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØªÙ†ÙØ° Ù„Ù…Ø§ ÙŠØ¶ØºØ· "ØªØ£ÙƒÙŠØ¯"
            try {
                const b = db.batch();
                b.delete(db.collection("users").doc(currentUser.uid).collection("friends").doc(profileUid));
                b.delete(db.collection("users").doc(profileUid).collection("friends").doc(currentUser.uid));
                
                await b.commit();
                
                playSound('click'); 
                showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ’”"); 
                checkRelationship(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                logActivity('delete', `Ù‚Ù…Øª Ø¨Ø¥Ù„ØºØ§Ø¡ ØµØ¯Ø§Ù‚Ø© ${document.getElementById('name').innerText}`, null, profileUid);
                
            } catch(e) {
                console.error(e);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§");
            }
        }
    );
}


        // ==========================================
// Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø© (Send Request)
// ==========================================
async function sendRequest() { 
    // ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙØ§Ø¶ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ù…Ø§ ÙŠØ¶Ø±Ø¨Ø´
    const safePic = (typeof currentUserPic !== 'undefined' && currentUserPic) ? currentUserPic : "";
    const safeVerified = (typeof currentUserVerified !== 'undefined') ? currentUserVerified : false;

    playSound('success'); 
    
    try {
        const b = db.batch();
        
        // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©
        const requestRef = db.collection("users").doc(profileUid)
                             .collection("friendRequests").doc(currentUser.uid);
                             
        b.set(requestRef, {
            senderUid: currentUser.uid, 
            name: currentUserName, 
            pic: safePic, 
            isVerified: safeVerified, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notifRef = db.collection("notifications").doc();
        
        b.set(notifRef, {
            recipientId: profileUid, 
            senderUid: currentUser.uid, 
            senderName: currentUserName, 
            senderPic: safePic,        // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù…Ù†Ø©
            isVerified: safeVerified,  // Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø¤Ù…Ù†
            type: "friend_request", 
            text: "Ø£Ø±Ø³Ù„ Ù„Ùƒ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©", 
            read: false, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
            link: `profile.html?uid=${currentUser.uid}`
        });

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±
        await b.commit(); 
        
        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…"); 
        checkRelationship(); // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø±

    } catch (error) {
        console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨:", error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
    }
}


        
        async function cancelRequest() { 
            playSound('click'); await db.collection("users").doc(profileUid).collection("friendRequests").doc(currentUser.uid).delete(); 
            showToast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"); checkRelationship(); 
        }
        
        // ==========================================
// Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø© (Accept Request)
// ==========================================
async function acceptRequest() { 
    const safePic = (typeof currentUserPic !== 'undefined' && currentUserPic) ? currentUserPic : "";
    const safeVerified = (typeof currentUserVerified !== 'undefined') ? currentUserVerified : false;

    playSound('success'); 
    
    try {
        const b = db.batch(); 
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø±ÙÙŠÙ†
        b.set(db.collection("users").doc(currentUser.uid).collection("friends").doc(profileUid), {since: firebase.firestore.FieldValue.serverTimestamp()}); 
        b.set(db.collection("users").doc(profileUid).collection("friends").doc(currentUser.uid), {since: firebase.firestore.FieldValue.serverTimestamp()}); 
        
        // Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©
        b.delete(db.collection("users").doc(currentUser.uid).collection("friendRequests").doc(profileUid)); 
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„
        const notifRef = db.collection("notifications").doc();
        b.set(notifRef, {
            recipientId: profileUid, 
            senderUid: currentUser.uid, 
            senderName: currentUserName, 
            senderPic: safePic,       // Ø§Ù„ØµÙˆØ±Ø©
            isVerified: safeVerified, // Ø§Ù„ØªÙˆØ«ÙŠÙ‚
            type: "friend_accept", 
            text: "ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚ØªÙƒ", 
            read: false, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
            link: `profile.html?uid=${currentUser.uid}`
        });

        await b.commit(); 
        showToast("Ø£ØµØ¨Ø­ØªÙ…Ø§ ØµØ¯ÙŠÙ‚ÙŠÙ† ğŸ¤"); 
        checkRelationship(); 

    } catch (error) {
        console.error("ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:", error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}


        
        async function followUser() { 
            playSound('click'); const b = db.batch(); 
            b.set(db.collection("users").doc(currentUser.uid).collection("following").doc(profileUid), {at: firebase.firestore.FieldValue.serverTimestamp()}); 
            b.set(db.collection("users").doc(profileUid).collection("followers").doc(currentUser.uid), {at: firebase.firestore.FieldValue.serverTimestamp()}); 
            const notifRef = db.collection("notifications").doc();
            b.set(notifRef, {
                recipientId: profileUid, senderUid: currentUser.uid, senderName: currentUserName, senderPic: currentUser.photoURL||"",
                type: "follow", text: "Ø¨Ø¯Ø£ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙƒ", read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp(), link: `profile.html?uid=${currentUser.uid}`
            });
            await b.commit(); showToast("ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"); checkRelationship(); 
        }
        
        async function unfollowUser() { 
            playSound('click'); const b = db.batch(); 
            b.delete(db.collection("users").doc(currentUser.uid).collection("following").doc(profileUid)); 
            b.delete(db.collection("users").doc(profileUid).collection("followers").doc(currentUser.uid)); 
            await b.commit(); 
        }
        
        function startChat() { 
            playSound('click'); const cid = [currentUser.uid, profileUid].sort().join("_"); 
            db.collection("chats").doc(cid).set({users:[currentUser.uid, profileUid], lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true}).then(()=> location.href=`chat.html?chatId=${cid}&uid=${profileUid}`); 
        }
        
        async function toggleLike(pid, postOwnerUid) {
            const btn = document.getElementById(`like-${pid}`);
            const cnt = document.getElementById(`cnt-${pid}`);
            const isAddingLike = !btn.classList.contains('liked');
            const isLiked = btn.classList.toggle('liked');
            
            if(isLiked) playSound('like'); else playSound('click');
            btn.querySelector('i').className = isLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
            cnt.innerText = isLiked ? parseInt(cnt.innerText)+1 : parseInt(cnt.innerText)-1;
// Ø¶ÙŠÙ Ø¯Ù‡ Ø¬ÙˆÙ‡ Ø´Ø±Ø· Ø§Ù„Ù€ Like
logActivity('like', 'Ø£Ø¹Ø¬Ø¨Øª Ø¨Ù…Ù†Ø´ÙˆØ±', pid, postOwnerUid);


            if (isAddingLike) pushNotification(postOwnerUid, 'like', 'Ø£Ø¹Ø¬Ø¨ Ø¨Ù…Ù†Ø´ÙˆØ±Ùƒ', `profile.html?uid=${postOwnerUid}#post-${pid}`);

            const ref = db.collection("posts").doc(pid);
            await db.runTransaction(async t => {
                const doc = await t.get(ref); let l = doc.data().likes || {};
                if(l[currentUser.uid]) delete l[currentUser.uid]; else l[currentUser.uid] = true;
                t.update(ref, {likes: l});
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ --               
   function openComments(pid, ownerUid) {
    lockScroll();
    document.body.classList.add('no-scroll');
    document.querySelectorAll('video').forEach(v => v.pause());

    playSound('click'); 
    currentPostId = pid; 
    currentPostOwnerUid = ownerUid;

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('cmSheet').classList.add('active');
    
    setupMentionListener('cmInput', 'mentionDropdown');

    const list = document.getElementById('cmList');
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
    
    resetCommentInput();

    if(window.commentsUnsub) window.commentsUnsub();

    window.commentsUnsub = db.collection("posts").doc(pid).collection("comments")
        .onSnapshot(snap => {
            list.innerHTML = ""; 
            document.getElementById('cmCount').innerText = `Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${snap.size})`;
            
            if(snap.empty) {
                list.innerHTML = '<div style="text-align:center; color:#777; margin-top:20px">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚!</div>';
                return;
            }
            
            let commentsData = [];
            snap.forEach(doc => {
                let d = doc.data(); d.id = doc.id;
                d.sortTime = d.createdAt ? d.createdAt.toDate().getTime() : Date.now();
                commentsData.push(d);
            });
            commentsData.sort((a, b) => a.sortTime - b.sortTime);

            commentsData.forEach(c => {
                try {
                    // --- 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ù†Ø§Ø¹ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (The Colored Ghost Mask) ---
                    let displayName = c.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    let displayPic = c.pic;
                    let verifiedDisplay = c.isVerified;
                    let clickAction = `location.href='profile.html?uid=${c.uid}'`;
                    let avatarContent = displayPic ? '' : (displayName[0]);
                    let avatarStyle = "";
                    let nameColorStyle = ""; // Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø§Ø³Ù…

                    // >> Ù„Ùˆ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø´Ø¨Ø­
                    if (c.isGhost) {
                        const ghostIdentity = getGhostIdentity(c.uid);
                        
                        displayName = `Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶ #${ghostIdentity.id}`;
                        displayPic = "";
                        verifiedDisplay = false;
                        
                        // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
                        avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:18px;"></i>`;
                        
                        // Ø§Ù„Ø¨Ø±ÙˆØ§Ø² Ø§Ù„Ù…Ù„ÙˆÙ†
                        avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 5px ${ghostIdentity.color}40;`;
                        
                        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø§Ø³Ù…
                        nameColorStyle = `color: ${ghostIdentity.color} !important; text-shadow: 0 0 5px ${ghostIdentity.color}40;`;
                        
                        clickAction = "showToast('â›” Ù‡ÙˆÙŠØ© Ù…Ø­Ù…ÙŠØ©')";
                    } else {
                        // >> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
                        let finalPic = c.pic;
                        if (currentUser && c.uid === currentUser.uid && !finalPic) finalPic = currentUserPic;
                        else if (typeof profileData !== 'undefined' && c.uid === profileUid && !finalPic) finalPic = profileData.profilePic;
                        
                        avatarStyle = finalPic ? 
                            `background: url('${finalPic}') center/cover no-repeat; border: 1px solid var(--border-color);` : 
                            `background: ${generateColor(c.uid || 'user')}; border: 1px solid var(--border-color); display:grid; place-items:center;`;
                        
                        if (finalPic) avatarContent = '';
                    }
                    // ----------------------------------------------------

                    // Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
                    let hash = 0;
                    if(c.uid) { for (let i = 0; i < c.uid.length; i++) hash = c.uid.charCodeAt(i) + ((hash << 5) - hash); }
                    const colorIndex = Math.abs(hash) % 10;
                    const colorClass = `color-${colorIndex}`;

                    const isPostOwner = (c.uid === currentPostOwnerUid);
                    let bubbleClass = `cm-bubble colored-comment ${colorClass}`;
                    if (isPostOwner) bubbleClass += ' owner-bubble';
                    if (c.isSticker) bubbleClass += " sticker-comment";

                    let textClass = c.isSticker ? "" : "cm-text";

                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù†Ø´Ù†
                    let displayContent = c.text || "";
                    if (!c.isSticker && c.replyToUid && c.replyToName && displayContent.startsWith(c.replyToName)) {
                        const cleanText = displayContent.substring(c.replyToName.length);
                        const mentionBadge = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${c.replyToUid}'">${c.replyToName}</span>`;
                        displayContent = `${mentionBadge} <span style="color:inherit">${cleanText}</span>`;
                    }

                    let timeString = c.createdAt ? moment(c.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†';
                    const verifiedIcon = (!c.isGhost && verifiedDisplay) ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:4px; font-size:12px; display:inline-block; vertical-align:middle;"></i>' : '';

                    const el = document.createElement('div');
                    el.className = 'comment-item';
                    el.id = `comment-${c.id}`;
                    
                    el.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openCommentOptions(c), 600); });
                    el.addEventListener('touchend', () => clearTimeout(pressTimer));
                    el.addEventListener('touchmove', () => clearTimeout(pressTimer));
                    el.style.cursor = "pointer";
                    
                    el.onclick = (e) => { 
                        if (!e.target.classList.contains('cm-action') && !e.target.classList.contains('reply-mention-link')) {
                            openRepliesSheet(c); 
                        }
                    };

                    el.innerHTML = `
                        <div class="cm-avatar" style="${avatarStyle}" onclick="${clickAction}">${avatarContent}</div>
                        <div class="cm-content">
                            <div class="${bubbleClass}"> 
                                <div class="cm-user-row">
                                    <span class="cm-username" onclick="${clickAction}" style="cursor:pointer; ${nameColorStyle}">
                                        ${displayName} 
                                        ${isPostOwner && !c.isGhost ? '<span class="owner-badge">Ù…Ø¤Ù„Ù</span>' : ''} 
                                    </span>
                                    ${verifiedIcon}
                                </div>
                                <div class="${textClass}">${displayContent}</div>
                            </div>
                            <div class="cm-meta-row">
                                <span>${timeString}</span>
                                <span class="cm-action" onclick="prepareReply('${c.id}', '${c.uid}', '${displayName}')">Ø±Ø¯</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                } catch (err) { console.error(err); }
            });
            setTimeout(() => list.scrollTop = list.scrollHeight, 100);
        });
    listeners.push(window.commentsUnsub);

                   }
    
                function openCommentOptions(commentData) {
            playSound('tab');
            selectedComment = commentData;
            if(navigator.vibrate) navigator.vibrate(50);
            
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø®ØªØ§Ø±
            document.querySelectorAll('.cm-bubble').forEach(b => b.classList.remove('highlight'));
            const bubble = document.getElementById(`comment-${commentData.id}`).querySelector('.cm-bubble');
            if(bubble) bubble.classList.add('highlight');

            // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚
            const isMyComment = (commentData.uid === currentUser.uid);
            const isMyPost = (currentPostOwnerUid === currentUser.uid); // Ù‡Ù„ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
            if (isMyComment) {
                // Ù„Ùˆ ØªØ¹Ù„ÙŠÙ‚ÙŠ Ø£Ù†Ø§: Ø£Ø¸Ù‡Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„Ø© (ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù)
                document.getElementById('cmOwnerOptions').style.display = 'block';
                document.getElementById('cmViewerOptions').style.display = 'none';
            } else {
                // Ù„Ùˆ ØªØ¹Ù„ÙŠÙ‚ Ø´Ø®Øµ Ø¢Ø®Ø±: Ø£Ø¸Ù‡Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯
                document.getElementById('cmOwnerOptions').style.display = 'none';
                document.getElementById('cmViewerOptions').style.display = 'block';

                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù‡Ù„ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ
                const deleteBtn = document.getElementById('ownerDeleteBtn');
                if (isMyPost) {
                    deleteBtn.style.display = 'flex'; // Ø£Ø¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù
                } else {
                    deleteBtn.style.display = 'none'; // Ø£Ø®ÙÙŠ Ø²Ø± Ø§Ù„Ø­Ø°Ù
                }
            }
            
            document.getElementById('commentOptionsSheet').classList.add('active');
        }


        function triggerEditComment() {
            closeAllSheets(true); 
            const inp = document.getElementById('cmInput');
            inp.value = selectedComment.text;
            inp.focus();
            isEditingComment = true;
            document.getElementById('cmSendBtn').classList.remove('fa-paper-plane');
            document.getElementById('cmSendBtn').classList.add('fa-check', 'update-mode');
        }

       function triggerDeleteComment() {
    // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø´ÙŠÙƒ Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡ Ø¨Ø¯Ù„ confirm Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    showChicConfirm(
        "Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ",
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.",
        '<i class="fa-solid fa-trash-can" style="color:var(--danger-color)"></i>',
        async function() {
            try {
                // Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ù† Ø§Ù„ÙƒÙˆÙ„ÙŠÙƒØ´Ù†
                await db.collection("posts").doc(currentPostId).collection("comments").doc(selectedComment.id).delete();
                
                // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø°ÙƒÙŠ ---
                // Ø¨Ù†Ø³ØªØ®Ø¯Ù… Transaction Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø¥Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙŠÙ†Ø²Ù„Ø´ ØªØ­Øª Ø§Ù„ØµÙØ±
                const postRef = db.collection("posts").doc(currentPostId);
                await db.runTransaction(async (t) => {
                    const postDoc = await t.get(postRef);
                    if (!postDoc.exists) return;
                    
                    const currentCount = postDoc.data().commentsCount || 0;
                    // Ù„Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ± Ù†Ù‚Øµ ÙˆØ§Ø­Ø¯ØŒ ØºÙŠØ± ÙƒØ¯Ù‡ Ø®Ù„ÙŠÙ‡ ØµÙØ± Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ
                    const newCount = (currentCount > 0) ? currentCount - 1 : 0;
                    
                    t.update(postRef, { commentsCount: newCount });
                });
                // ---------------------------------

                closeAllSheets(true);
                showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚");
                playSound('click');
            } catch(e) {
                console.error(e);
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        }
    );
}


        function triggerCopyComment() {
            navigator.clipboard.writeText(selectedComment.text);
            closeAllSheets(true);
            showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®");
        }

        function triggerReplyComment() {
            closeAllSheets(true);
            prepareReply(selectedComment.id, selectedComment.uid, selectedComment.name);
        }

        // --- Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        function prepareReply(cid, uid, name) {
            closeAllSheets(true); // ØºÙ„Ù‚ Ø£ÙŠ Ù†ÙˆØ§ÙØ° Ù…ÙØªÙˆØ­Ø©
            const commentElement = document.getElementById(`comment-${cid}`);
            const commentText = commentElement.querySelector('.cm-text').innerText;
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
            openRepliesSheet({ id: cid, uid: uid, name: name, text: commentText });
        }

        function cancelReply() {
            replyToData = null;
        }

        function resetCommentInput() {
            const inp = document.getElementById('cmInput');
            const btn = document.getElementById('cmSendBtn');
            inp.value = "";
            isEditingComment = false;
            replyToData = null;
            btn.classList.remove('fa-check', 'update-mode');
            btn.classList.add('fa-paper-plane');
            cancelReply();
        }

        async function handleCommentAction(stickerContent = null, isSticker = false) {
    const inp = document.getElementById('cmInput');
    // Ù„Ùˆ Ø¨Ø§Ø¹ØªÙŠÙ† Ø§Ø³ØªÙŠÙƒØ± Ø®Ø¯Ù‡ØŒ Ù„Ùˆ Ù„Ø£ Ø®Ø¯ Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø©
    const txt = stickerContent || inp.value.trim();
    
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†Øµ ÙˆÙ…Ø´ Ø§Ø³ØªÙŠÙƒØ±ØŒ Ø§Ø®Ø±Ø¬ ÙˆÙ…ØªØ¨Ø¹ØªØ´ Ø­Ø§Ø¬Ø©
    if(!txt && !isSticker) return;

    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù„Ùˆ Ù…Ø´ Ø§Ø³ØªÙŠÙƒØ±ØŒ Ù„Ø£Ù† Ø§Ù„Ø§Ø³ØªÙŠÙƒØ± Ù„ÙŠÙ‡ ØµÙˆØª ÙÙŠ Ø¯Ø§Ù„Ø© ØªØ§Ù†ÙŠØ©)
    if(!isSticker) playSound('sent');

    // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit Mode) ---
    if(isEditingComment && selectedComment && !isSticker) {
        try {
            await db.collection("posts").doc(currentPostId)
                .collection("comments").doc(selectedComment.id).update({
                    text: txt, 
                    isEdited: true
            });
            showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚");
        } catch (e) {
            console.error(e);
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        }
        resetCommentInput();
    } 
    // --- Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (New Comment) ---
    else {
        // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        // Ø¨Ù†Ø´ÙˆÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù†ÙØªØ±Ø¶ Ø¥Ù†Ù‡ false
        const currentGhostStatus = (typeof isGhost !== 'undefined') ? isGhost : false;

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ù„Ùˆ Ù…Ø´ Ø£Ù†Ø§)
        if(currentPostOwnerUid && currentPostOwnerUid !== currentUser.uid) {
             let msg = isSticker ? 'Ø£Ø±Ø³Ù„ Ø§Ø³ØªÙŠÙƒØ±' : ('Ø¹Ù„Ù‚: ' + txt);
             
             // Ù„Ùˆ Ø´Ø¨Ø­ØŒ Ù…Ù…ÙƒÙ† Ù†ØºÙŠØ± Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶"
             if (currentGhostStatus) {
                 // Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¬Ù‡ÙˆÙ„
                 // (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¯Ø§Ù„Ø© pushNotification Ø¨ØªØ§Ø®Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ 
                 // Ø¹Ø´Ø§Ù† ØªØ®Ù„ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø­ØªØ§Ø¬ ØªØ¹Ø¯Ù„ Ø¯Ø§Ù„Ø© pushNotification Ù†ÙØ³Ù‡Ø§ØŒ 
                 // Ø¨Ø³ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‡Ù†Ø³ÙŠØ¨Ù‡Ø§ ÙƒØ¯Ù‡ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù†ÙØ³Ù‡ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ù‡ÙŠÙƒÙˆÙ† Ù…Ø®ÙÙŠ)
             }
             
             pushNotification(currentPostOwnerUid, 'comment', msg, `profile.html?uid=${currentPostOwnerUid}#post-${currentPostId}`);
        }

        try {
            // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.collection("posts").doc(currentPostId).collection("comments").add({
                uid: currentUser.uid,
                name: currentUserName,
                pic: currentUserPic || "",
                isVerified: currentUserVerified,
                text: txt,
                isSticker: isSticker, // Ø¯ÙŠ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù„ÙŠ Ù‡ØªÙ…ÙŠØ² Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±
                isGhost: currentGhostStatus, // <--- Ø¯ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨Ø­
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
logActivity('comment', `Ø¹Ù„Ù‚Øª: "${txt.substring(0, 15)}..."`, currentPostId, currentPostOwnerUid);


            // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
            db.collection("posts").doc(currentPostId).update({
                commentsCount: firebase.firestore.FieldValue.increment(1)
            });
        } catch (e) {
            console.error(e);
            showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚");
        }

        resetCommentInput();
    }
}



        function reportComment() { showToast("ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚"); closeAllSheets(true); }

                // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let isCurrentPostSaved = false;


        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙØ¸ (Ø¬Ø¯ÙŠØ¯Ø©)
        async function toggleSavePost() {
            closeAllSheets(); // ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const saveRef = db.collection("users").doc(currentUser.uid).collection("savedPosts").doc(currentPostId);

            if (isCurrentPostSaved) {
                // Ù„Ùˆ Ù…Ø­ÙÙˆØ¸ -> Ø§Ø­Ø°ÙÙ‡
                await saveRef.delete();
                showToast("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª");
            } else {
                // Ù„Ùˆ Ù…Ø´ Ù…Ø­ÙÙˆØ¸ -> Ø§Ø­ÙØ¸Ù‡
                await saveRef.set({
                    postId: currentPostId,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ± âœ…");
                playSound('success');
            }
        }

        // 3. Ø¯Ø§Ù„Ø© ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¨Ù„Ø§Øº (Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ Ø¨Ø³ ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§ Ø´ØºØ§Ù„Ø©)
        function openReportModal() {
            closeAllSheets();
            document.getElementById('reportReasonModal').style.display = 'flex';
        }

        async function submitReport(reason) {
            document.getElementById('reportReasonModal').style.display = 'none';
            try {
                await db.collection("reports").add({
                    postId: currentPostId,
                    postText: currentPostText || "Ù…Ø­ØªÙˆÙ‰ ÙˆØ³Ø§Ø¦Ø·",
                    offenderUid: currentPostOwnerUid,
                    offenderName: currentPostOwnerName,
                    reporterUid: currentUser.uid,
                    reporterName: currentUserName,
                    reason: reason,
                    status: "pending", 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡");
                playSound('sent');
            } catch(e) {
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
                console.error(e);
            }
        }
    
        async function deletePost() { 
            if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ")) { 
                playSound('click');
                await db.collection("posts").doc(currentPostId).delete(); 
                const el = document.getElementById(`post-${currentPostId}`);
                if(el) el.remove();
                showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); 
                closeAllSheets(); 
            } 
        }

        function copyPostText() { showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ"); closeAllSheets(); }

        // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø¯Ø§Ø®Ù„ closeAllSheets Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯
// ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªÙ‚Ø¨Ù„ Ù…Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ (keepEditMode)
function closeAllSheets(keepComments = false, keepEditMode = false, isBackBtn = false) { 
    // 1. Ø¥Ø¯Ø§Ø±Ø© Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if (!isBackBtn && history.state && history.state.sheetOpen) {
        history.back();
    }

    // 2. Ø¥ØºÙ„Ø§Ù‚ "ÙƒÙ„" Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø¨Ø°ÙƒØ§Ø¡ (Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯)
    // Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ Ø¨ÙŠÙ„Ù Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ø¬Ø© Ø§Ø³Ù…Ù‡Ø§ bottom-sheet ÙˆÙŠÙ‚ÙÙ„Ù‡Ø§
    document.querySelectorAll('.bottom-sheet').forEach(sheet => {
        // Ø§Ø³ØªØ«Ù†Ø§Ø¡: Ù„Ùˆ Ø§Ø­Ù†Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø®Ù„ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø© (keepComments)
        if (keepComments && sheet.id === 'cmSheet') return;
        
        sheet.classList.remove('active');
    });

    // 3. Ø¥ØºÙ„Ø§Ù‚ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±Ø§Øª ÙˆØ§Ù„Ù…ÙŠÙ†Ø´Ù†
    const sSheet = document.getElementById('stickerSheet');
    if(sSheet) sSheet.classList.remove('active');
    
    const mentionDrop = document.getElementById('mentionDropdown');
    if(mentionDrop) mentionDrop.classList.remove('active');

    // 4. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    const sideMenu = document.getElementById('sideMenu');
    if(sideMenu) sideMenu.classList.remove('open');

    // 5. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Overlay (Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚Ø©) ÙˆØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø´Ø§Ø´Ø©
    if(!keepComments) {
        unlockScroll(); 
        const overlay = document.getElementById('overlay');
        const sideOverlay = document.getElementById('sideMenuOverlay');
        
        if(overlay) overlay.style.display = 'none';
        if(sideOverlay) {
            sideOverlay.classList.remove('visible');
            setTimeout(() => sideOverlay.style.display='none', 300);
        }
        
        resetCommentInput();
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ¸Ù„ÙŠÙ„
        document.querySelectorAll('.cm-bubble').forEach(b => b.classList.remove('highlight'));
    }

    // 6. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
    if (!keepEditMode) {
        isEditingReply = false;
        selectedReply = null;
        isEditingComment = false;
        selectedComment = null;
        
        document.querySelectorAll('.cm-send-btn').forEach(btn => {
            btn.classList.remove('fa-check', 'update-mode');
            btn.classList.add('fa-paper-plane');
        });
    }
}



        function openSideMenu() { 
            playSound('click');
            document.getElementById('sideMenu').classList.add('open'); 
            const overlay = document.getElementById('sideMenuOverlay'); 
            overlay.style.display='block'; 
            setTimeout(()=>overlay.classList.add('visible'), 10); 
        }

        function closeSideMenu() { 
            document.getElementById('sideMenu').classList.remove('open'); 
            const overlay = document.getElementById('sideMenuOverlay'); 
            overlay.classList.remove('visible'); 
            setTimeout(()=>overlay.style.display='none', 300); 
        }

        function openLogoutConfirm() { playSound('click'); closeSideMenu(); document.getElementById('logoutModal').style.display='flex'; }
        function confirmLogout() { playSound('click'); auth.signOut().then(()=>location.href="index.html"); }
        
        function openAccountSwitcher() {
            playSound('click');
            closeSideMenu(); document.getElementById('accountSwitcherModal').style.display = 'flex';
            document.getElementById('addAccountForm').style.display = 'none'; document.getElementById('addAccBtnContainer').style.display = 'flex';
            const list = document.getElementById('accountList'); list.innerHTML = "";
            let accounts = JSON.parse(localStorage.getItem('nabd_accounts') || '[]');
            
            if(currentUser && profileData) {
                const currentIdx = accounts.findIndex(a => a.uid === currentUser.uid);
                if(currentIdx > -1) {
                    accounts[currentIdx].name = currentUserName;
                    accounts[currentIdx].isVerified = currentUserVerified;
                    if(profileData.profilePic) accounts[currentIdx].pic = profileData.profilePic;
                    localStorage.setItem('nabd_accounts', JSON.stringify(accounts));
                }
            }

            if(accounts.length === 0) list.innerHTML = "<div style='text-align:center;color:#777'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>";
            
            accounts.forEach((acc, idx) => {
                const isCurrent = (currentUser && acc.uid === currentUser.uid);
                const verifiedBadge = acc.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:5px; font-size:14px;"></i>' : '';
                const avatarStyle = acc.pic ? `background-image:url('${acc.pic}')` : `background:${generateColor(acc.uid)}`;
                const avatarContent = acc.pic ? '' : (acc.name ? acc.name[0] : 'U');

                list.innerHTML += `
                <div class="acc-item" onclick="${isCurrent?'':`switchAccount(${idx})`}" style="${isCurrent?'opacity:0.5;cursor:default':''}">
                    <div style="width:40px;height:40px;border-radius:50%;${avatarStyle};display:grid;place-items:center;background-size:cover;border:1px solid var(--border-color)">${avatarContent}</div>
                    <div style="flex:1; text-align:right;">
                        <div style="font-weight:bold;font-size:15px;display:flex;align-items:center;color:var(--text-color)">
                            ${acc.name} ${verifiedBadge}
                        </div>
                        <div style="font-size:12px;color:var(--secondary-text)">${acc.email}</div>
                    </div>
                    ${!isCurrent ? `<i class="fa-solid fa-trash" style="color:#ff3b30;padding:8px;font-size:14px" onclick="removeAccount(event, ${idx})"></i>` : ''}
                </div>`;
            });
        }

        function hideAddAccountForm() { document.getElementById('addAccountForm').style.display='none'; document.getElementById('addAccBtnContainer').style.display='flex'; }
        // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± ÙÙˆØ±Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ (ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ©)
function showAddAccountForm() {
    playSound('click');
    document.getElementById('addAccountForm').style.display = 'block'; // ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø§Ù†Ø§Øª
    document.getElementById('addAccBtnContainer').style.display = 'none'; // ÙŠØ®ÙÙŠ Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ù‚ØªØ§Ù‹
}

        async function addNewAccountAction() {
            playSound('click');
            const e = document.getElementById('newAccEmail').value;
            const p = document.getElementById('newAccPass').value;
            if(!e || !p) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            
            try { 
                const cred = await auth.signInWithEmailAndPassword(e, p); 
                const uid = cred.user.uid;

                const userDoc = await db.collection('users').doc(uid).get();
                const userData = userDoc.data() || {};
                const realName = userData.name || e.split('@')[0];
                const isVerified = userData.isVerified || false;
                const pic = userData.profilePic || "";

                let accs = JSON.parse(localStorage.getItem('nabd_accounts') || '[]'); 
                if(!accs.find(a => a.uid === uid)) {
                    accs.push({
                        uid: uid, email: e, token: btoa(p), 
                        name: realName, isVerified: isVerified, pic: pic
                    }); 
                    localStorage.setItem('nabd_accounts', JSON.stringify(accs)); 
                }
                location.reload(); 
            } catch(er) { console.error(er); showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
        }

        function switchAccount(idx) { 
            playSound('click');
            let accs = JSON.parse(localStorage.getItem('nabd_accounts')); 
            if(accs[idx]) auth.signInWithEmailAndPassword(accs[idx].email, atob(accs[idx].token)).then(()=>location.reload()); 
        }

        function removeAccount(e, idx) { 
            e.stopPropagation(); 
            if(!confirm("Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) return;
            let accs = JSON.parse(localStorage.getItem('nabd_accounts')); 
            accs.splice(idx, 1); 
            localStorage.setItem('nabd_accounts', JSON.stringify(accs)); 
            openAccountSwitcher(); 
        }

        function updateMainNotifBadge() {
            if (!currentUser) return;
            db.collection("notifications").where("recipientId", "==", currentUser.uid).where("read", "==", false)
                .onSnapshot(snap => {
                    const badge = document.getElementById('mainNotifBadge');
                    if (badge) {
                        badge.innerText = snap.size > 99 ? '99+' : snap.size; 
                        badge.style.display = snap.size > 0 ? 'inline-block' : 'none';
                        if(snap.size > 0) { badge.style.animation = 'none'; badge.offsetHeight; badge.style.animation = 'pulse 1.5s infinite'; }
                    }
                });
        }

        function updateRequestsBadge() {
            if (!currentUser) return;
            db.collection("users").doc(currentUser.uid).collection("friendRequests")
            .onSnapshot(snap => {
                const badge = document.getElementById('requestsBadge');
                if (badge) {
                    badge.innerText = snap.size;
                    badge.style.display = snap.size > 0 ? 'inline-block' : 'none';
                }
            });
        }

/* ================================================= */
/* ÙƒÙˆØ¯ ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø© + Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… + Ø§Ù„Ø³Ø­Ø¨ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©) */
/* ================================================= */
(function() {
    const orb = document.getElementById('uraniumOrb');
    const deleteZone = document.getElementById('deleteZone');
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    let isDragging = false, startX, startY, currentX, currentY, velocityX = 0, velocityY = 0;
    let lastX, lastY, lastTime, animationFrame, superMode = false;
    let pressTimer, orbVisible = true; 
    
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const savedColor = localStorage.getItem('themeColor');
    if(savedColor) {
        document.documentElement.style.setProperty('--primary-solid', savedColor);
        document.documentElement.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${savedColor}, #444)`);
    }

    // --- 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³ ---
        // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØ± (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹ ØªÙƒÙˆÙ† Ù‡Ù†Ø§) ---
    function captureScreen() {
        const orb = document.getElementById('uraniumOrb');
        const pull = document.getElementById('pullIndicator');
        const deleteZone = document.getElementById('deleteZone');

        // Ù†Ø®ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø© ÙˆØ§Ù„Ø²Ø¨Ø§Ù„Ø© Ø¹Ø´Ø§Ù† Ù…ÙŠØ¸Ù‡Ø±ÙˆØ´ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
        if(orb) orb.style.opacity = '0';
        if(pull) pull.style.display = 'none';
        if(deleteZone) deleteZone.style.display = 'none';

        // ØµÙˆØª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-1133.mp3');
        audio.play().catch(()=>{});

        // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
        html2canvas(document.body, {
            useCORS: true, 
            allowTaint: true, 
            scrollY: -window.scrollY
        }).then(canvas => {
            // Ù†Ø±Ø¬Ø¹ ÙƒÙ„ Ø­Ø§Ø¬Ø© Ù…ÙƒØ§Ù†Ù‡Ø§
            if(orb) orb.style.opacity = '1';
            if(pull) pull.style.display = 'flex';
            if(deleteZone) deleteZone.style.display = 'flex';

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            const link = document.createElement('a');
            link.download = `NABD_Snap_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showToast("ğŸ“¸ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø´Ø§Ø´Ø©");
        }).catch(err => {
            if(orb) orb.style.opacity = '1';
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØ±:", err);
        });
    }

    // --- 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³ (Start) ---
    orb.addEventListener('touchstart', e => {
        if(superMode || !orbVisible) return; 
        const t = e.touches[0]; 
        startX = t.clientX; 
        startY = t.clientY;
        lastX = startX; lastY = startY; lastTime = Date.now();
        
        isDragging = false; // ØªØµÙÙŠØ± Ø§Ù„Ø³Ø­Ø¨
        velocityX = 0; velocityY = 0;
        
        cancelAnimationFrame(animationFrame); 
        orb.style.transition='none';
        
        // ØªØ§ÙŠÙ…Ø± Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø© (Ù„Ùˆ ÙØ¶Ù„Øª Ø¯Ø§ÙŠØ³)
        pressTimer = setTimeout(() => {
            if (!isDragging) {
                 toggleMode(); // ÙŠØºÙŠØ± Ø§Ù„ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ
                 if(navigator.vibrate) navigator.vibrate(50);
            }
        }, 600);
    }, {passive:false});

    // --- 2. Ø­Ø±ÙƒØ© Ø§Ù„ØµØ¨Ø§Ø¹ (Move) ---
    orb.addEventListener('touchmove', e => {
        if(superMode || !orbVisible) return;
        e.preventDefault(); 
        const t = e.touches[0], now=Date.now(), dt=now-lastTime;
        
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù…Ø´ Ù‡Ù†Ø¹ØªØ¨Ø±Ù‡ Ø³Ø­Ø¨ Ø¥Ù„Ø§ Ù„Ùˆ Ø§ØªØ­Ø±ÙƒØª Ø£ÙƒØªØ± Ù…Ù† 10 Ø¨ÙƒØ³Ù„
        // Ø¯Ù‡ Ø¹Ø´Ø§Ù† "Ø§Ù„Ø±Ø¹Ø´Ø©" Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù…ØªÙˆÙ‚ÙØ´ Ø§Ù„Ø§Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª
        if(Math.abs(t.clientX-startX) > 10 || Math.abs(t.clientY-startY) > 10) {
            clearTimeout(pressTimer); // Ø§Ù„ØºÙŠ Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø©
            isDragging = true; // Ø§Ø¹ØªØ¨Ø±Ù‡ Ø³Ø­Ø¨ Ø®Ù„Ø§Øµ
        }

        if(isDragging) {
            currentX = t.clientX-(orb.offsetWidth/2); 
            currentY = t.clientY-(orb.offsetHeight/2);
            orb.style.left=`${currentX}px`; 
            orb.style.top=`${currentY}px`;
            
            // ÙƒÙˆØ¯ Ø§Ù„Ø²Ø¨Ø§Ù„Ø© (Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡)
            if (currentY > window.innerHeight - 180) {
                deleteZone.style.transform = 'translateX(-50%) scale(1)';
                const dzRect = deleteZone.getBoundingClientRect();
                if (t.clientX > dzRect.left && t.clientX < dzRect.right && t.clientY > dzRect.top) {
                    deleteZone.style.background = 'rgba(255, 0, 0, 0.4)';
                    deleteZone.style.boxShadow = '0 0 20px rgba(255,0,0,0.5)';
                    orb.style.opacity = '0.5';
                } else {
                    deleteZone.style.background = 'rgba(255, 0, 0, 0.1)';
                    deleteZone.style.boxShadow = 'none';
                    orb.style.opacity = '1';
                }
            } else {
                deleteZone.style.transform = 'translateX(-50%) scale(0)';
                orb.style.opacity = '1';
            }

            if(dt>0) { velocityX=(t.clientX-lastX)/dt; velocityY=(t.clientY-lastY)/dt; }
            lastX=t.clientX; lastY=t.clientY; lastTime=now;
        }
    }, {passive:false});

    // --- 3. Ø±ÙØ¹ Ø§Ù„ØµØ¨Ø§Ø¹ (End) ---
    orb.addEventListener('touchend', (e) => {
        if(superMode || !orbVisible) return;
        clearTimeout(pressTimer); // Ø§Ù„ØºÙŠ ØªØ§ÙŠÙ…Ø± Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø©
        deleteZone.style.transform = 'translateX(-50%) scale(0)';

        // === Ù‡Ù†Ø§ Ø§Ù„Ø³Ø­Ø± ===
        // Ù„Ùˆ Ù…ÙƒÙ†Ø´ Ø³Ø­Ø¨ (ÙŠØ¹Ù†ÙŠ Ø¶ØºØ·Ø© Ø¨Ø³ÙŠØ·Ø©) -> Ø®Ø¯ Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª
        if (!isDragging) {
            captureScreen(); 
        } 
        // Ù„Ùˆ ÙƒØ§Ù† Ø³Ø­Ø¨ -> Ù†ÙØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù†ÙŠØ©
        else {
            const dzRect = deleteZone.getBoundingClientRect();
            const orbRect = orb.getBoundingClientRect();

            // Ø±Ù…ÙŠ ÙÙŠ Ø§Ù„Ø²Ø¨Ø§Ù„Ø©
            if (orbRect.bottom > dzRect.top && orbRect.left < dzRect.right && orbRect.right > dzRect.left && currentY > window.innerHeight - 180) {
                hideOrb();
            } 
            // Ø±Ù…ÙŠ Ù„ÙÙˆÙ‚ (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
            else if(currentY < 60) {
                activateSuperMode();
            } 
            // ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            else {
                applyMomentum();
            }
        }
    });



    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---

    // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ)
    function activateSuperMode() {
        superMode = true;
        orb.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        orb.style.left = '50%'; orb.style.top = '120px'; orb.style.transform = 'translate(-50%, -50%)';
        orb.classList.add('super-mode');
        setTimeout(() => document.addEventListener('click', closeSuperModeOutside), 100);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    function closeSuperModeOutside(e) {
        // Ù„Ùˆ Ø¶ØºØ·Øª Ø¨Ø±Ù‡ Ø§Ù„ÙƒÙˆØ±Ø© ÙˆÙ…Ø´ Ø¬ÙˆÙ‡ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        if(!orb.contains(e.target) && !document.getElementById('themeModal').contains(e.target)) {
            deactivateSuperMode();
            document.removeEventListener('click', closeSuperModeOutside);
        }
    }

    // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function deactivateSuperMode() {
        superMode = false;
        orb.classList.remove('super-mode'); orb.style.transform = 'none';
        let tx=window.innerWidth-70; let ty=window.innerHeight-150;
        orb.style.left=`${tx}px`; orb.style.top=`${ty}px`;
        currentX=tx; currentY=ty;
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ (Ù„ÙŠÙ„ÙŠ / Ù†Ù‡Ø§Ø±ÙŠ)
    function toggleMode() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ØµÙØ­ØªÙƒ
        if(typeof showToast === "function") showToast(isLight ? "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" : "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ");
    }

    // ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ù„Ø²Ø­Ù„Ù‚Ø© ÙˆØ§Ù„Ø§Ø±ØªØ¯Ø§Ø¯)
    function applyMomentum() {
        const friction=0.92;
        function step() {
            if(Math.abs(velocityX)>0.1 || Math.abs(velocityY)>0.1) {
                currentX+=velocityX*15; currentY+=velocityY*15;
                velocityX*=friction; velocityY*=friction;
                
                // Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ù
                if(currentX<0||currentX>window.innerWidth-55) velocityX*=-0.5;
                if(currentY<0||currentY>window.innerHeight-55) velocityY*=-0.5;
                
                currentX=Math.max(0,Math.min(currentX,window.innerWidth-55));
                currentY=Math.max(0,Math.min(currentY,window.innerHeight-55));
                
                orb.style.left=`${currentX}px`; orb.style.top=`${currentY}px`;
                animationFrame=requestAnimationFrame(step);
            } else {
                // Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ù†Ø¨
                let tx=(orb.getBoundingClientRect().left+(55/2)<window.innerWidth/2)?10:window.innerWidth-65;
                let ty=Math.max(50, Math.min(parseInt(orb.style.top), window.innerHeight-100));
                orb.style.transition='all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                orb.style.left=`${tx}px`; orb.style.top=`${ty}px`;
            }
        } step();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ±Ø©
    function hideOrb() {
        orb.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        orb.style.transform = 'scale(0)'; orb.style.opacity = '0';
        setTimeout(() => { 
            orb.style.display = 'none'; orbVisible = false; 
            if(typeof showToast === "function") showToast("Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒØ±Ø©"); 
        }, 400);
    }

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙˆØ±Ø© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ (Double Tap)
    let lastTap = 0;
    document.addEventListener('touchend', function (e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0 && !orbVisible) {
            orb.style.display = 'flex'; orb.style.transition = 'none';
            orb.style.left = '20px'; orb.style.top = (window.innerHeight - 100) + 'px';
            orbVisible = true;
            setTimeout(() => {
                orb.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                orb.style.transform = 'scale(1)'; orb.style.opacity = '1';
            }, 50);
        }
        lastTap = currentTime;
                /* ========================================= */
    /* ÙƒÙˆØ¯ ØªØ´ØºÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù…Ø§Øª (ÙƒØ§Ù† Ù†Ø§Ù‚Øµ)      */
    /* ========================================= */

    // 1. ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    window.openThemeModal = function() {
        // Ù„Ùˆ Ø§Ù„ÙƒÙˆØ±Ø© Ù…ÙØªÙˆØ­Ø© (Super Mode) Ø§Ù‚ÙÙ„Ù‡Ø§ Ø§Ù„Ø£ÙˆÙ„
        if(superMode) deactivateSuperMode();
        document.getElementById('themeModal').classList.add('active');
    };

    // 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    window.closeThemeModal = function() {
        document.getElementById('themeModal').classList.remove('active');
    };

    // 3. ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†
    window.changeTheme = function(color, save = true) {
        // ØªØºÙŠÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ CSS
        document.documentElement.style.setProperty('--primary-solid', color);
        document.documentElement.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${color}, #444)`);
        
        if(save) {
            localStorage.setItem('themeColor', color);
            showToast("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ÙˆÙ† ğŸ¨");
            window.closeThemeModal();
        }
    };

    // 4. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    window.resetTheme = function() {
        window.changeTheme('#5D5FEF', true); 
    };

    });
})();

        function generateColor(uid) { 
            const c=["#5D5FEF","#34c759","#ff3b30","#ffb533","#2AF598","#009EFD"]; 
            let h=0; for(let i=0;i<uid.length;i++) h=uid.charCodeAt(i)+((h<<5)-h); 
            return c[Math.abs(h)%c.length]; 
        }

        function showToast(m) { 
            const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; 
            t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); 
        }

        function copyUsername() { 
            const u = document.getElementById('username').innerText;
            if(!u) return;
            navigator.clipboard.writeText(u.replace('@','')).then(()=>showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù")); 
        }

        function openLightbox(s) { playSound('click'); document.getElementById('lb-img').src=s; document.getElementById('lightbox').style.display='flex'; }
        function viewList(t) { if(profileUid) location.href=`friends.html?uid=${profileUid}&list=${t}`; }
        function formatNumber(num) { if (!num) return '0'; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'K'; return num.toString(); }

        function shareProfile() {
            playSound('click');
            if (navigator.share) {
                navigator.share({ title: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', text: `Ø´ÙˆÙ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ${currentUserName}`, url: window.location.href }).catch(console.error);
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ");
            }
        }

        function showMoreOptions() {
            playSound('click');
            showToast("Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª");
        }

        // ==========================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ÙˆØ­Ø¯ ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        // ==========================================

        // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ø¨Ù†Ø¹Ù…Ù„Ù‡ Ù…Ù†Ø´Ù† Ø­Ø§Ù„ÙŠØ§Ù‹
let currentSubReplyTarget = null; // {uid, name}



function openRepliesSheet(comment) {
    currentParentComment = comment; 
    playSound('tab');
    
    document.getElementById('repliesSheet').classList.add('active');
    document.getElementById('overlay').style.display = 'block';

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ù†Ø§Ø¹ Ø§Ù„Ù…ØªØ·ÙˆØ± (Colored Ghost Logic) ---
    let displayName = comment.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
    let displayPic = comment.pic;
    let verifiedDisplay = comment.isVerified;
    let clickAction = `location.href='profile.html?uid=${comment.uid}'`;
    let avatarContent = displayPic ? '' : (displayName[0] || 'U');
    let avatarStyle = "";

    // >> Ù„Ùˆ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¯Ù‡ "Ø´Ø¨Ø­"
    if (comment.isGhost) {
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø²ÙŠÙØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©
        const ghostIdentity = getGhostIdentity(comment.uid);
        
        displayName = `Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶ #${ghostIdentity.id}`; // Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø±Ù‚Ù…
        displayPic = "";
        verifiedDisplay = false;
        
        // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ§Ø®Ø¯ Ù„ÙˆÙ† Ø§Ù„Ø´Ø¨Ø­
        avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:18px;"></i>`;
        clickAction = "showToast('â›” Ù‡ÙˆÙŠØ© Ù…Ø­Ù…ÙŠØ©')";
        
        // Ø§Ù„Ø¨Ø±ÙˆØ§Ø² ÙŠØ§Ø®Ø¯ Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ†
        avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 5px ${ghostIdentity.color}40;`;
    } else {
        // >> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
        let finalPic = comment.pic;
        if (currentUser && comment.uid === currentUser.uid && !finalPic) finalPic = currentUserPic;
        else if (typeof profileData !== 'undefined' && comment.uid === profileUid && !finalPic) finalPic = profileData.profilePic;
        
        avatarStyle = finalPic ? 
            `background: url('${finalPic}') center/cover no-repeat; border: 1px solid var(--border-color);` : 
            `background: ${generateColor(comment.uid)}; border: 1px solid var(--border-color); display:grid; place-items:center;`;
        
        if (finalPic) avatarContent = '';
    }

    // Ø­Ø³Ø§Ø¨ Ù„ÙˆÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø© (Ù„Ù„Ø®Ù„ÙÙŠØ© ÙÙ‚Ø·)
    let hash = 0;
    if(comment.uid) { for (let i = 0; i < comment.uid.length; i++) hash = comment.uid.charCodeAt(i) + ((hash << 5) - hash); }
    const colorIndex = Math.abs(hash) % 10;
    const colorClass = `color-${colorIndex}`;

    const isPostOwner = (currentPostOwnerUid && comment.uid === currentPostOwnerUid);
    let bubbleClass = `cm-bubble colored-comment ${colorClass}`;
    if (isPostOwner) bubbleClass += ' owner-bubble';
    
    const verifiedIcon = verifiedDisplay ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:4px; font-size:12px; display:inline-block; vertical-align:middle;"></i>' : '';
    const authorBadge = (isPostOwner && !comment.isGhost) ? '<span class="owner-badge" style="display:inline-block; margin-right:5px;">Ù…Ø¤Ù„Ù</span>' : '';

    const list = document.getElementById('repliesList');
    
    list.innerHTML = `
        <div class="parent-comment-header">
            <div style="display:flex; gap:10px; align-items:flex-start;">
                <div class="cm-avatar" 
                     style="width:40px; height:40px; border-radius:50%; flex-shrink:0; cursor:pointer; ${avatarStyle}"
                     onclick="${clickAction}">
                     ${avatarContent}
                </div>
                
                <div style="flex:1;">
                    <div class="${bubbleClass}">
                        <div class="cm-username" 
                             style="cursor:pointer; font-size:13px; display:flex; align-items:center; flex-wrap:wrap; ${comment.isGhost ? `color:${getGhostIdentity(comment.uid).color} !important;` : ''}"
                             onclick="${clickAction}">
                            <span>${displayName}</span>
                            ${verifiedIcon} 
                            ${authorBadge}
                        </div>
                        <div class="cm-text">${comment.text}</div>
                    </div>
                    
                    <div style="font-size:11px; color:var(--secondary-text); margin-top:5px; margin-right:5px; font-weight:600;">
                        Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ
                    </div>
                </div>
            </div>
        </div>

        <div style="font-size:12px; color:var(--secondary-text); margin-bottom:15px; text-align:center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">Ø§Ù„Ø±Ø¯ÙˆØ¯</div>
        
        <div id="actualRepliesContainer"></div>
    `;

    loadRealtimeReplies(comment.id);
}         

function loadRealtimeReplies(commentId) {
    const container = document.getElementById('actualRepliesContainer');
    if (window.replyListener) window.replyListener();

    window.replyListener = db.collection("posts").doc(currentPostId)
    .collection("comments").doc(commentId)
    .collection("replies").orderBy("createdAt", "asc")
    .onSnapshot(snap => {
        container.innerHTML = ""; 
        if(snap.empty) { container.innerHTML = "<div style='text-align:center; color:var(--secondary-text); font-size:13px; margin-top:20px;'>ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ±Ø¯!</div>"; return; }

        let participants = [currentParentComment.uid]; 

        snap.forEach((doc, index) => {
            const r = {id: doc.id, ...doc.data()};
            
            // --- 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ù†Ø§Ø¹ Ø§Ù„Ù…ØªØ·ÙˆØ± Ù„Ù„Ø±Ø¯ÙˆØ¯ ---
            let displayName = r.name;
            let displayPic = r.pic;
            let clickAction = `location.href='profile.html?uid=${r.uid}'`;
            let avatarContent = displayPic ? '' : (r.name ? r.name[0] : 'U');
            let avatarStyle = displayPic ? 
                `background-image:url('${displayPic}')` : 
                `background:${generateColor(r.uid)}`;
            let verifiedIcon = r.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; font-size:10px; margin-right:3px;"></i>' : '';
            let nameStyle = ""; // Ø¹Ø´Ø§Ù† Ù†Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù…

            // >> Ù„Ùˆ Ø§Ù„Ø±Ø¯ Ø¯Ù‡ "Ø´Ø¨Ø­"
            if (r.isGhost) {
                const ghostIdentity = getGhostIdentity(r.uid);
                
                displayName = `Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶ #${ghostIdentity.id}`;
                displayPic = "";
                
                // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
                avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:14px;"></i>`;
                
                // Ø§Ù„Ø¨Ø±ÙˆØ§Ø² Ø§Ù„Ù…Ù„ÙˆÙ†
                avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 4px ${ghostIdentity.color}30;`;
                
                clickAction = "showToast('â›” Ù‡ÙˆÙŠØ© Ù…Ø­Ù…ÙŠØ©')";
                verifiedIcon = "";
                
                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ø¨Ù†ÙØ³ Ù„ÙˆÙ† Ø§Ù„Ø´Ø¨Ø­
                nameStyle = `color: ${ghostIdentity.color} !important; text-shadow: 0 0 5px ${ghostIdentity.color}40;`;
            }
            // -------------------------------------

            let userIndex = participants.indexOf(r.uid);
            if (userIndex === -1) { participants.push(r.uid); userIndex = participants.length - 1; }
            const colorClass = `color-${userIndex % 10}`;
            
            const isLast = index === snap.size - 1;
            const treeLineStyle = isLast ? "height: 25px;" : "bottom: -15px;"; 

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù†Ø´Ù†
            let displayText = r.text;
            if (!r.isSticker && r.replyToUid && r.replyToName && displayText.startsWith(r.replyToName)) {
                const cleanText = displayText.substring(r.replyToName.length);
                const mentionHtml = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${r.replyToUid}'">${r.replyToName}</span>`;
                displayText = mentionHtml + cleanText;
            }

            let bubbleClasses = `cm-bubble colored-reply ${colorClass}`;
            let textClass = "cm-text";
            if (r.isSticker) {
                bubbleClasses += " sticker-comment"; 
                textClass = ""; 
            }

            const replyWrapper = document.createElement('div');
            replyWrapper.style.cssText = "position:relative; margin-right:25px; margin-bottom:15px; animation: fadeIn 0.3s ease;";
            
            replyWrapper.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openReplyOptions(r), 600); });
            replyWrapper.addEventListener('touchend', () => clearTimeout(pressTimer));
            replyWrapper.addEventListener('touchmove', () => clearTimeout(pressTimer));

            replyWrapper.innerHTML = `
                <div class="tree-connector" style="${treeLineStyle}"></div>
                <div class="reply-curve"></div>
                <div style="display:flex; gap:10px; align-items: flex-start;">
                    <div class="cm-avatar" 
                         style="width:30px; height:30px; flex-shrink:0; border:1px solid var(--border-color); cursor:pointer; ${avatarStyle}"
                         onclick="${clickAction}">
                         ${avatarContent}
                    </div>
                    
                    <div class="cm-content" style="flex:1;">
                        <div class="${bubbleClasses}" id="reply-bubble-${r.id}">
                            <div class="cm-username" 
                                 style="font-size:12px; font-weight:700; cursor:pointer; ${nameStyle}"
                                 onclick="${clickAction}">
                                 ${displayName} ${verifiedIcon}
                            </div>
                            <div class="${textClass}">${displayText}</div>
                        </div>

                        <div class="cm-meta-row" style="margin-right:5px; font-size:10px;">
                            <span>${r.createdAt ? moment(r.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†'}</span>
                            ${!r.isGhost ? `<span class="cm-action" style="font-weight:bold; color:var(--text-color);" onclick="prepareSubReply('${r.uid}', '${displayName}')">Ø±Ø¯</span>` : ''}
                        </div>
                    </div>
                </div>`;
            
            container.appendChild(replyWrapper);
        });
    });
}


    
function prepareSubReply(uid, name) {
    // Ø­ÙØ¸Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø±Ø¯ Ø¹Ù„ÙŠÙ‡
    currentSubReplyTarget = { uid: uid, name: name };
    
    const inp = document.getElementById('replyInput');
    // Ø¨Ù†ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø¨Ø³ Ù…Ù† ØºÙŠØ± @
    inp.value = name + " ";
    inp.focus();
    
    if(navigator.vibrate) navigator.vibrate(30);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
async function sendReplyToComment(stickerContent = null, isSticker = false) {
    const inp = document.getElementById('replyInput');
    let txt = stickerContent || inp.value.trim();
    
    if((!txt && !isSticker) || !currentParentComment) return;
    
    if(!isSticker) {
        txt = txt.replace(/^@/, '');
        playSound('sent');
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù†Ø´Ù†
    let replyToUid = null; let replyToName = null;
    if (!isSticker) {
        if (window.directMentionData && txt.includes(window.directMentionData.name)) {
            replyToUid = window.directMentionData.uid; replyToName = window.directMentionData.name;
            window.directMentionData = null;
        } else if (currentSubReplyTarget && txt.startsWith(currentSubReplyTarget.name)) {
            replyToUid = currentSubReplyTarget.uid; replyToName = currentSubReplyTarget.name;
        }
    }

    // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù„ÙŠ Ù†Ù‚Ù„Ù†Ø§Ù‡ ÙÙˆÙ‚
    // (Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ù†Ù‚Ù„Øª let isGhost = false; Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…Ù„Ù Ø²ÙŠ Ù…Ø§ Ø§ØªÙÙ‚Ù†Ø§ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© 1)

    try {
        if (isEditingReply && selectedReply && !isSticker) {
             await db.collection("posts").doc(currentPostId)
                .collection("comments").doc(currentParentComment.id)
                .collection("replies").doc(selectedReply.id).update({ text: txt, isEdited: true });
            showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯");
            isEditingReply = false; selectedReply = null;
            const btn = document.querySelector('.cm-footer .cm-send-btn');
            if(btn) { btn.classList.remove('fa-check', 'update-mode'); btn.classList.add('fa-paper-plane'); }
        } else {
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ (Ù…Ø¹ Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨Ø­)
            await db.collection("posts").doc(currentPostId)
                .collection("comments").doc(currentParentComment.id)
                .collection("replies").add({
                    uid: currentUser.uid,
                    name: currentUserName,
                    pic: currentUserPic || "", 
                    isVerified: currentUserVerified,
                    text: txt,
                    isSticker: isSticker,
                    isGhost: isGhost, // <--- Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ø¨ÙŠÙ‚Ø±Ø§ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    replyToUid: replyToUid, replyToName: replyToName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            const notifMsg = isSticker ? 'Ø£Ø±Ø³Ù„ Ø§Ø³ØªÙŠÙƒØ± ÙÙŠ Ø±Ø¯' : 'Ø±Ø¯ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚Ùƒ';
            if(currentParentComment.uid !== currentUser.uid) {
                // Ø¯Ø§Ù„Ø© pushNotification Ù…ØªØ­Ø¯Ø«Ø© ÙˆÙ‡ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø´Ø¨Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ
                pushNotification(currentParentComment.uid, 'reply', notifMsg, `profile.html?uid=${currentPostOwnerUid}`);
            }
        }
        inp.value = ""; currentSubReplyTarget = null;
    } catch(e) { 
        console.error(e);
        showToast("Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø±ÙŠÙ isGhost ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù"); 
    }
}




        function closeRepliesSheet() {
            document.getElementById('repliesSheet').classList.remove('active');
            currentParentComment = null;
        }
    // =========================================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
// =========================================

// 1. Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
function toggleSearchBar() {
    const bar = document.getElementById('pageSearchBar');
    const inp = document.getElementById('localSearchInput');
    
    if (bar.style.display === 'none') {
        bar.style.display = 'block';
        playSound('click');
        inp.focus(); // ÙŠØ®Ù„ÙŠ Ø§Ù„Ù…Ø¤Ø´Ø± ÙŠÙƒØªØ¨ Ø¹Ù„Ø·ÙˆÙ„
    } else {
        bar.style.display = 'none';
        inp.value = ""; // ÙŠÙØ¶ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù…
        filterLocalPosts(); // ÙŠØ±Ø¬Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ØªØ¸Ù‡Ø± ØªØ§Ù†ÙŠ
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ© (Ø¨ØªØ®ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù„ÙŠ Ù…Ø´ ØªØ¨Ø¹ Ø§Ù„Ø¨Ø­Ø«)
function filterLocalPosts() {
    const query = document.getElementById('localSearchInput').value.toLowerCase();
    const posts = document.querySelectorAll('.post'); // Ø¨ÙŠØ¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
    
    let hasResults = false;

    posts.forEach(post => {
        // Ø¨Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ Ø¨ØªØ§Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙƒÙ„Ù‡
        const text = post.innerText.toLowerCase();
        
        if (text.includes(query)) {
            post.style.display = 'block'; // Ø§Ø¸Ù‡Ø±
            hasResults = true;
        } else {
            post.style.display = 'none'; // Ø§Ø®ÙÙŠ
        }
    });

    // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†ØªØ§ÙŠØ¬ Ù…Ù…ÙƒÙ† ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    const noMsg = document.getElementById('noSearchMsg');
    if(!hasResults && query !== "") {
        if(!noMsg) {
            const msg = document.createElement('div');
            msg.id = 'noSearchMsg';
            msg.innerHTML = '<div style="text-align:center; padding:20px; color:var(--secondary-text)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
            document.getElementById('postsList').appendChild(msg);
        }
    } else {
        if(noMsg) noMsg.remove();
    }
}
        // --- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¨Ù„Ø§Øº ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ© ---
        let currentPostText = "";
        let currentPostOwnerName = ""; 
    
        function openEditPostModal() {
            closeAllSheets();
            document.getElementById('editPostInput').value = currentPostText;
            document.getElementById('editPostModal').style.display = 'flex';
        }

        async function saveEditedPost() {
            const newText = document.getElementById('editPostInput').value;
            if(!newText) return showToast("Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");

            try {
                await db.collection("posts").doc(currentPostId).update({
                    text: newText,
                    isEdited: true
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ù‚Ø¯Ø§Ù… Ø¹ÙŠÙ†Ùƒ ÙÙˆØ±Ø§Ù‹
                const postEl = document.getElementById(`post-${currentPostId}`);
                if(postEl) {
                    const textEl = postEl.querySelector('.post-text');
                    if(textEl) textEl.innerText = newText;
                }

                document.getElementById('editPostModal').style.display = 'none';
                showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±");
                playSound('success');
            } catch(e) {
                console.error(e);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        }

        // 3. Ø¯ÙˆØ§Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø®ØµÙˆØµÙŠØ©
        async function changePrivacy(type) {
            closeAllSheets();
            try {
                await db.collection("posts").doc(currentPostId).update({ visibility: type });
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµÙˆØµÙŠØ©");
                playSound('click');
                // Ø¹Ø´Ø§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØªØºÙŠØ±ØŒ Ø¨Ù†Ø¹Ù…Ù„ ØªØ­Ø¯ÙŠØ« Ù„Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© (Ø£Ø³Ù‡Ù„ Ø­Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹)
                setTimeout(() => location.reload(), 1000);
            } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
        }

        // 4. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº (ÙŠØ±ÙˆØ­ Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†)
        function openReportModal() {
            closeAllSheets();
            document.getElementById('reportReasonModal').style.display = 'flex';
        }

        async function submitReport(reason) {
            document.getElementById('reportReasonModal').style.display = 'none';
            
            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†ÙØ³ Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ© Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
                await db.collection("reports").add({
                    postId: currentPostId,
                    postText: currentPostText || "ÙˆØ³Ø§Ø¦Ø·",
                    offenderUid: currentPostOwnerUid,
                    offenderName: currentPostOwnerName,
                    reporterUid: currentUser.uid,
                    reporterName: currentUserName,
                    reason: reason,
                    status: "pending", 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©");
                playSound('sent');
            } catch(e) {
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
            }
        }
// 1. ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø¯
// ==========================================
//  Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ ÙˆØ§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Ø§Ù„Ø³Ù„ÙŠÙ…)
// ==========================================

// 1. ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø¯
function openReplyOptions(replyData) {
    playSound('tab');
    if(navigator.vibrate) navigator.vibrate(50);
    
    selectedReply = replyData; 

    if (!currentParentComment) {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚");
        return;
    }

    // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø¯
    document.querySelectorAll('.colored-reply').forEach(b => b.style.opacity = '1');
    const bubble = document.getElementById(`reply-bubble-${replyData.id}`);
    if(bubble) bubble.style.opacity = '0.7'; 

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    const isMyReply = (replyData.uid === currentUser.uid);
    document.getElementById('replyOwnerOptions').style.display = isMyReply ? 'block' : 'none';
    
    const viewerOptions = document.getElementById('replyViewerOptions');
    viewerOptions.style.display = isMyReply ? 'none' : 'block';

    // --- ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ø²Ø±Ø§Ø± ---
    if (!isMyReply) {
        const btn = document.getElementById('replyToUserBtn');
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø¹Ø¯Ù„Øª Ø§Ù„Ù€ HTML ÙˆØ£Ø¶ÙØª id="replyToUserBtn" Ù„Ù„Ø²Ø±Ø§Ø±
        if(btn) btn.innerHTML = `<i class="fa-solid fa-reply"></i> Ø±Ø¯ Ø¹Ù„Ù‰ ${replyData.name}`;
    }
    
    document.getElementById('replyOptionsSheet').classList.add('active');
}




// 2. ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø®Ø§Ù†Ø©)
function triggerEditReplyAction() {
    // Ù†ØºÙ„Ù‚ ÙÙ‚Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© (replyOptionsSheet)
    document.getElementById('replyOptionsSheet').classList.remove('active');
    
    // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ closeAllSheets Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø¯ÙˆØ¯ ØªÙØ¶Ù„ Ù…ÙØªÙˆØ­Ø©
    
    const inp = document.getElementById('replyInput');
    inp.value = selectedReply.text;
    inp.focus();
    isEditingReply = true; 
    
    // ØªØºÙŠÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø±Ø§Ø±
    const btn = document.querySelector('.cm-footer .cm-send-btn');
    if(btn) {
        btn.classList.remove('fa-paper-plane');
        btn.classList.add('fa-check', 'update-mode');
    }
    
    showToast("ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯...");
}


// 3. Ø­Ø°Ù Ø§Ù„Ø±Ø¯ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´ÙŠÙƒ)
function triggerDeleteReply() {
    // Ù†Ø®ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµØºÙŠØ±Ø© ÙÙ‚Ø·
    document.getElementById('replyOptionsSheet').classList.remove('active');

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if(!currentPostId || !currentParentComment || !selectedReply) {
        showToast("Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©");
        return;
    }

    showChicConfirm(
        "Ø­Ø°Ù Ø§Ù„Ø±Ø¯ØŸ",
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ",
        '<i class="fa-solid fa-trash-can" style="color:var(--danger-color)"></i>',
        async function() { 
            try {
                await db.collection("posts").doc(currentPostId)
                    .collection("comments").doc(currentParentComment.id)
                    .collection("replies").doc(selectedReply.id).delete();
                
                showToast("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø¯");
                playSound('click');
                // Ù„Ø§ Ù†ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø­Ø°Ù Ø¨Ø¹ÙŠÙ†Ùƒ
            } catch(e) { 
                console.error(e);
                showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù"); 
            }
        }
    );
}


// 4. Ù†Ø³Ø® Ø§Ù„Ø±Ø¯
function triggerCopyReply() {
    if(selectedReply && selectedReply.text) {
        navigator.clipboard.writeText(selectedReply.text);
        showToast("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø¯");
    }
    closeAllSheets(true);
}

// 5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Modal Logic)
let pendingAction = null;
    
    function triggerReplyToUser() {
    // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('replyOptionsSheet').classList.remove('active');
    
    // 2. (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹) Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    isEditingReply = false;
    const btn = document.querySelector('.cm-footer .cm-send-btn');
    if(btn) {
        btn.classList.remove('fa-check', 'update-mode');
        btn.classList.add('fa-paper-plane');
    }

    // 3. ÙˆØ¶Ø¹ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    const inp = document.getElementById('replyInput');
    if(selectedReply && selectedReply.name) {
        inp.value = selectedReply.name + " "; // Ù…Ø³Ø§ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù…
        inp.focus();
    }
}



function showChicConfirm(title, message, iconHTML, actionCallback) {
    playSound('tab');
    document.getElementById('chicTitle').innerText = title;
    document.getElementById('chicMessage').innerText = message;
    document.getElementById('chicIcon').innerHTML = iconHTML;
    pendingAction = actionCallback;
    document.getElementById('chicConfirmModal').style.display = 'flex';
    
    document.getElementById('chicConfirmBtn').onclick = function() {
        if(pendingAction) pendingAction();
        closeChicModal();
    };
}

function closeChicModal() {
    document.getElementById('chicConfirmModal').style.display = 'none';
    pendingAction = null;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØµÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function toggleMute(e, videoId, btn) {
    // Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø£Ù‡Ù… Ø­Ø§Ø¬Ø©: Ø¨ÙŠÙˆÙ‚Ù "Ø§Ù†ØªØ´Ø§Ø±" Ø§Ù„Ø¶ØºØ·Ø© Ø¹Ø´Ø§Ù† Ù…ÙŠÙˆØµÙ„Ø´ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙŠÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    e.stopPropagation(); 
    
    const video = document.getElementById(videoId);
    const icon = btn.querySelector('i');

    if (video.muted) {
        // Ù„Ùˆ Ù…ÙƒØªÙˆÙ… -> Ø´ØºÙ„Ù‡ ÙˆØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø³Ù…Ø§Ø¹Ø©
        video.muted = false;
        icon.classList.remove('fa-volume-xmark');
        icon.classList.add('fa-volume-high');
    } else {
        // Ù„Ùˆ Ø´ØºØ§Ù„ -> Ø§ÙƒØªÙ…Ù‡ ÙˆØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø¹Ù„Ø§Ù…Ø© x
        video.muted = true;
        icon.classList.remove('fa-volume-high');
        icon.classList.add('fa-volume-xmark');
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
// Ø¯Ø§Ù„Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª (Ù†Ø¸Ø§Ù… Ø§Ø­ØªØ±Ø§ÙÙŠ - Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø¬Ù„Ø³Ø©)
async function incrementViewCount(postId) {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚: Ù‡Ù„ Ø´Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¯ÙŠ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŸ
    const viewedKey = `viewed_${postId}`;
    if (sessionStorage.getItem(viewedKey)) {
        console.log("ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©.");
        return; // ÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆÙ…ØªØ²ÙˆØ¯Ø´ Ø­Ø§Ø¬Ø©
    }

    try {
        console.log("Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...");

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        const postRef = db.collection("posts").doc(postId);
        await postRef.update({
            views: firebase.firestore.FieldValue.increment(1)
        });
        // Ø¶ÙŠÙ Ø¯Ù‡ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
logActivity('view', 'Ø´Ø§Ù‡Ø¯Øª ÙÙŠØ¯ÙŠÙˆ', postId, profileUid);


        
        // 3. ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø¥Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ù‡ Ø®Ù„Ø§Øµ
        sessionStorage.setItem(viewedKey, 'true');
        
        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… ÙÙˆØ±Ø§Ù‹ Ù‚Ø¯Ø§Ù…Ùƒ
        const viewSpan = document.getElementById(`vid-views-${postId}`);
        if(viewSpan) {
            let current = parseInt(viewSpan.innerText.replace(/[^0-9]/g, '')) || 0;
            viewSpan.innerText = formatNumber(current + 1);
        }

    } catch (e) {
        console.error("ÙØ´Ù„ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª:", e);
    }
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø¬Ø¯ÙŠØ¯) ---

let viewUpdateInterval = null;

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
function startLiveViews(postId) {
    if (viewUpdateInterval) clearInterval(viewUpdateInterval);

    viewUpdateInterval = setInterval(async () => {
        try {
            const doc = await db.collection("posts").doc(postId).get();
            if (doc.exists) {
                const realViews = doc.data().views || 0;
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø©
                const el = document.getElementById(`vid-views-${postId}`);
                if (el) el.innerText = formatNumber(realViews);
            }
        } catch (e) { console.log(e); }
    }, 10000); 
}

// Ø¯Ø§Ù„Ø© ØªÙˆÙ‚Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«
function stopLiveViews() {
    if (viewUpdateInterval) {
        clearInterval(viewUpdateInterval);
        viewUpdateInterval = null;
    }
}
// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±Ø§Øª ---
const stickerCollection = [
    "ğŸ¤£", "ğŸ˜‚", "ğŸ˜…", "ğŸ¥¹", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ¤ª", 
    "ğŸ˜", "ğŸ˜­", "ğŸ˜¢", "ğŸ˜¤", "ğŸ˜¡", "ğŸ¤¬", "ğŸ¤¯", "ğŸ˜³", 
    "ğŸ˜±", "ğŸ˜´", "ğŸ¤®", "ğŸ¤¡", "ğŸ’€", "ğŸ‘»", "ğŸ‘½", "ğŸ’©",
    "ğŸ‘", "ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "â¤ï¸", "ğŸ’”", "ğŸ”¥", "âœ¨"
];

let activeStickerContext = null; // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø¨Ù†Ø¨Ø¹Øª ÙÙŠÙ† (ØªØ¹Ù„ÙŠÙ‚ ÙˆÙ„Ø§ Ø±Ø¯)

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function toggleStickerSheet(context) {
    activeStickerContext = context;
    const sheet = document.getElementById('stickerSheet');
    const overlay = document.getElementById('overlay');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±Ø§Øª (Ù„Ùˆ Ù„Ø³Ù‡ Ù…ØªØ­Ù…Ù„ØªØ´)
    const grid = document.getElementById('stickersGrid');
    if (grid.childElementCount === 0) {
        stickerCollection.forEach(sticker => {
            const el = document.createElement('div');
            el.className = 'sticker-option';
            el.innerText = sticker;
            el.onclick = () => sendSticker(sticker);
            grid.appendChild(el);
        });
    }

    if (sheet.classList.contains('active')) {
        closeAllSheets(); // Ù„Ùˆ Ù…ÙØªÙˆØ­Ø© Ø§Ù‚ÙÙ„Ù‡Ø§
    } else {
        // 1. ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø®Ù„ÙÙŠØ©
        document.body.classList.add('no-scroll');
        
        // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ Overlay (Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¶ØºØ·Øª Ø¨Ø±Ù‡ ØªÙ‚ÙÙ„)
        overlay.style.display = 'block';
        
        // 3. ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        sheet.classList.add('active');

        // 4. Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ³ØªÙˆØ±ÙŠ (Ø¹Ø´Ø§Ù† Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ´ØªØºÙ„)
        window.history.pushState({sheetOpen: true}, "");
    }
}


// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±
function sendSticker(sticker) {
    document.getElementById('stickerSheet').classList.remove('active'); // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    playSound('sent');

    if (activeStickerContext === 'main') {
        handleCommentAction(sticker, true); // Ø§Ø¨Ø¹Øª Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    } else {
        sendReplyToComment(sticker, true); // Ø§Ø¨Ø¹Øª Ù„Ù„Ø±Ø¯ÙˆØ¯
    }
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†Ø´Ù† (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…ÙŠÙ‚ÙØ´) ---
function setupMentionListener(inputId, dropdownContainerId) {
    const inp = document.getElementById(inputId);
    const drop = document.getElementById('mentionDropdown'); 
    
    // Ø§Ù„Ø­Ù„ Ù„Ù„Ø®Ø·Ø£ Ø§Ù„Ø£Ø­Ù…Ø±: Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„
    if(!inp || !drop) return; 

    inp.addEventListener('keyup', async (e) => {
        // ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ) ...
        const val = inp.value;
        const cursorPosition = inp.selectionStart;

        const textBeforeCursor = val.substring(0, cursorPosition);
        const lastWord = textBeforeCursor.split(/(\s+)/).pop();

        if (lastWord.startsWith('@')) {
            const query = lastWord.substring(1);
            activeInputId = inputId;
            const wrapper = inp.parentElement.parentElement;
            if(!wrapper.contains(drop)) wrapper.insertBefore(drop, wrapper.firstChild);
            await searchAndShowMentions(query, drop);
        } else {
            drop.classList.remove('active');
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹Ø±Ø¶
async function searchAndShowMentions(queryText, dropdownEl) {
    dropdownEl.innerHTML = '<div style="padding:10px; text-align:center; color:#777"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
    dropdownEl.classList.add('active');
    try {
        let q = db.collection('users').orderBy('followersCount', 'desc').limit(10);
        const snap = await q.get();
        dropdownEl.innerHTML = '';
        if (snap.empty) { dropdownEl.classList.remove('active'); return; }

        snap.forEach(doc => {
            const d = doc.data();
            if (queryText === "" || d.name.toLowerCase().includes(queryText.toLowerCase())) {
                const item = document.createElement('div');
                item.className = 'mention-suggest-item';
                item.onclick = () => selectMention(d.uid, d.name, activeInputId);
                const verified = d.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; font-size:12px;"></i>' : '';
                item.innerHTML = `
                    <div class="cm-avatar" style="width:35px; height:35px; ${d.profilePic ? `background-image:url('${d.profilePic}')` : `background:${generateColor(d.uid||'u')}`}">
                        ${d.profilePic ? '' : d.name[0]}
                    </div>
                    <div>
                        <div style="font-weight:bold; font-size:14px; color:var(--text-color)">${d.name} ${verified}</div>
                        <div style="font-size:11px; color:var(--secondary-text)">@${d.username || 'user'}</div>
                    </div>`;
                dropdownEl.appendChild(item);
            }
        });
        if (dropdownEl.children.length === 0) dropdownEl.classList.remove('active');
    } catch (e) { console.log(e); dropdownEl.classList.remove('active'); }
}

function selectMention(uid, name, inputId) {
    const inp = document.getElementById(inputId);
    const drop = document.getElementById('mentionDropdown');
    const cursor = inp.selectionStart;
    const text = inp.value;
    const before = text.substring(0, cursor);
    const after = text.substring(cursor);
    const lastAt = before.lastIndexOf('@');
    const newText = text.substring(0, lastAt) + name + " " + after;
    inp.value = newText; inp.focus();
    drop.classList.remove('active');
    if (typeof currentSubReplyTarget !== 'undefined') currentSubReplyTarget = { uid: uid, name: name };
    window.directMentionData = { uid: uid, name: name };
}
    // Ù…Ø³ØªÙ…Ø¹ Ù„Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
window.addEventListener('popstate', function(event) {
    // Ù„Ùˆ ÙÙŠÙ‡ Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø© (Ø§Ø³ØªÙŠÙƒØ± Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£Ùˆ Ø±Ø¯ÙˆØ¯)ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§
    if (document.getElementById('stickerSheet').classList.contains('active') || 
        document.getElementById('cmSheet').classList.contains('active') ||
        document.getElementById('repliesSheet').classList.contains('active')) {
        
        // Ø¨Ù†Ø¨Ø¹Øª true Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ¹Ø±Ù Ø¥Ù† Ø¯Ù‡ Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙˆÙ…ØªØ¹Ù…Ù„Ø´ Ù…Ø´Ø§ÙƒÙ„
        closeAllSheets(false, false, true); 
    }
});

        /* ========================================= */
    /* Ø¯Ø§Ù„Ø© Ø§Ù„Ø´ÙŠØ± (ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·)                */
    /* ========================================= */
    function sharePost(pid) {
    playSound('click');
    
    // 1. ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ù…Ù†Ø´ÙˆØ±
    const shareUrl = `${window.location.origin}${window.location.pathname}?uid=${profileUid}&post=${pid}`;

    // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
    if (navigator.share) {
        navigator.share({
            title: 'Ù…Ù†Ø´ÙˆØ± Ù…Ù…ÙŠØ² Ø¹Ù„Ù‰ NABD',
            text: 'Ø´ÙˆÙ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¯Ù‡!',
            url: shareUrl
        }).then(() => {
            // âœ… 3. ØªØ³Ø¬ÙŠÙ„ "Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©" ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
            logActivity('share', `Ø´Ø§Ø±ÙƒØª Ù…Ù†Ø´ÙˆØ±Ø§Ù‹`, pid, profileUid);
            showToast("ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        }).catch(() => {});
    } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
            // âœ… 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® (Ù„Ø£Ù†Ù‡Ø§ ØªØ¹ØªØ¨Ø± Ù…Ø´Ø§Ø±ÙƒØ© ÙŠØ¯ÙˆÙŠØ©)
            logActivity('share', `Ø´Ø§Ø±ÙƒØª Ø±Ø§Ø¨Ø· Ù…Ù†Ø´ÙˆØ± (Ù†Ø³Ø®)`, pid, profileUid);
            showToast("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†Ø´ÙˆØ± ğŸ”—");
        });
    }
}

    // Ø§Ø³ØªØ¨Ø¯Ù„ Ø£ÙŠ Ø¯Ø§Ù„Ø© openOptions Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯
async function openOptions(pid, uid, txt, ownerName) { 
    currentPostId = pid; 
    currentPostOwnerUid = uid;
    currentPostText = txt; 
    currentPostOwnerName = ownerName;

    // 1. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´ÙƒÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)
    isCurrentPostSaved = false;
    document.getElementById('saveIcon').className = 'fa-regular fa-bookmark';
    document.getElementById('saveIcon').style.color = 'var(--text-color)';
    document.getElementById('saveText').innerText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±';

    // 2. ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('overlay').style.display = 'block'; 
    document.getElementById('optionsSheet').classList.add('active'); 

    // 3. Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ (ØªØ¹Ø¯ÙŠÙ„/Ø®ØµÙˆØµÙŠØ© Ø£Ùˆ Ø¥Ø¨Ù„Ø§Øº)
    if (uid === currentUser.uid) {
        document.getElementById('ownerActions').style.display = 'block';
        document.getElementById('privacyOptions').style.display = 'block';
        document.getElementById('reportAction').style.display = 'none';
    } else {
        document.getElementById('ownerActions').style.display = 'none';
        document.getElementById('privacyOptions').style.display = 'none';
        document.getElementById('reportAction').style.display = 'flex';
    }

    // 4. Ø§Ù„ÙƒØ´Ù ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²: Ù‡Ù„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ÙŠØŸ
    try {
        const doc = await db.collection("users").doc(currentUser.uid)
                            .collection("savedPosts").doc(pid).get();
        if (doc.exists) {
            isCurrentPostSaved = true;
            document.getElementById('saveIcon').className = 'fa-solid fa-bookmark';
            document.getElementById('saveIcon').style.color = 'var(--primary-solid)';
            document.getElementById('saveText').innerText = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙØ¸';
        }
    } catch (e) { console.log("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸", e); }
}

// --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø´Ø¨Ø­ ---


// --- Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØ¶Ø¹ ---
async function toggleGhostMode() {
    const btn = document.getElementById('ghostBtn');
    
    // 1. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    isGhost = !isGhost;

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ø³Ø±ÙŠØ¹)
    if (isGhost) {
        // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ù„ÙˆÙ† Ø£Ø­Ù…Ø± + Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¬Ø§Ø³ÙˆØ³)
        btn.style.background = "#ff0000"; 
        btn.style.boxShadow = "0 0 20px #ff0000";
        btn.style.border = "2px solid #fff";
        btn.querySelector('i').className = "fa-solid fa-user-secret"; 
        
        playSound('success'); 
        showToast("ğŸ•µï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­: Ø£Ù†Øª Ø§Ù„Ø¢Ù† 'Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶'");
    } else {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£ØµÙ„)
        btn.style.background = ""; 
        btn.style.boxShadow = "";
        btn.style.border = "";
        btn.querySelector('i').className = "fa-solid fa-ghost";
        
        playSound('click');
        showToast("ğŸ‘¤ ØªÙ… ÙƒØ´Ù Ø§Ù„Ù‡ÙˆÙŠØ©: Ø¹Ø¯Øª Ù„Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ");
    }

    // 3. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ù†Ø§Ø³ Ø§Ù„ØªØ§Ù†ÙŠØ©)
    if (currentUser) {
        try {
            await db.collection('users').doc(currentUser.uid).update({
                isGhost: isGhost,
                // Ø¨Ù†Ù…Ø³Ø­ ÙˆÙ‚Øª Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¹Ø´Ø§Ù† Ù…Ù†Ø¸Ù‡Ø±Ø´ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                lastActive: isGhost ? null : firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error("ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ø´Ø¨Ø­:", e);
            showToast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
        }
    }
}

// --- Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
function checkGhostStatus() {
    if(!currentUser) return;
    
    db.collection('users').doc(currentUser.uid).get().then(doc => {
        if(doc.exists && doc.data().isGhost) {
            isGhost = true;
            const btn = document.getElementById('ghostBtn');
            if(btn) {
                // Ù„Ùˆ ÙƒØ§Ù† Ù…ÙØ¹Ù„ØŒ Ù†ØºÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹
                btn.style.background = "#ff0000";
                btn.style.boxShadow = "0 0 20px #ff0000";
                btn.style.border = "2px solid #fff";
                btn.querySelector('i').className = "fa-solid fa-user-secret";
            }
        }
    });
}

// ==========================================
// ğŸ› ï¸ Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆØ³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
// ==========================================

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨ØªØ­Ø¯Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø®Øµ)
function showMoreOptions() {
    playSound('click');
    const sheet = document.getElementById('profileMenuSheet');
    const content = document.getElementById('profileMenuContent');
    
    // Ù‡Ù„ Ø¯Ù‡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ Ø£Ù†Ø§ØŸ
    const isMyProfile = (currentUser.uid === profileUid);

    content.innerHTML = ""; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…

    if (isMyProfile) {
        // --- Ø®ÙŠØ§Ø±Ø§ØªÙŠ Ø£Ù†Ø§ ---
        content.innerHTML = `
            <div class="sheet-option" onclick="openActivityLog()">
                <i class="fa-solid fa-clock-rotate-left" style="color:#00c6ff"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
            </div>
            <div class="sheet-option" onclick="location.href='settings.html'">
                <i class="fa-solid fa-gear"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
            </div>
            <div class="sheet-option" onclick="copyProfileLink()">
                <i class="fa-solid fa-link"></i> Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ù…Ù„ÙÙŠ
            </div>
        `;
    } else {
        // --- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø± ---
        content.innerHTML = `
            <div class="sheet-option" onclick="sendFriendRequestFromMenu()">
                <i class="fa-solid fa-user-plus" style="color:var(--success-color)"></i> Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚
            </div>
            
            <div class="sheet-option" onclick="sendPoke()">
                <i class="fa-solid fa-hand-point-up" style="color:#ffb533"></i> Ù†ÙƒØ² (Poke) ğŸ‘‹
            </div>

            <div class="sheet-option" onclick="copyProfileLink()">
                <i class="fa-solid fa-link"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
            </div>

            <div class="sheet-option" onclick="openReportModal()" style="color:var(--danger-color)">
                <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            </div>

            <div class="sheet-option" onclick="blockUser()" style="color:var(--danger-color)">
                <i class="fa-solid fa-ban"></i> Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            </div>
        `;
    }

    document.getElementById('overlay').style.display = 'block';
    sheet.classList.add('active');
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ù†ÙƒØ² (Poke)
// Ø¯Ø§Ù„Ø© Ø§Ù„Ù†ÙƒØ²
async function sendPoke() {
    closeAllSheets();
    playSound('sent');
    pushNotification(profileUid, 'poke', 'Ù‚Ø§Ù… Ø¨Ù†ÙƒØ²Ùƒ ğŸ‘‹', `profile.html?uid=${currentUser.uid}`);
    
    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ UID Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ù†ÙƒÙˆØ²
    logActivity('poke', `Ù‚Ù…Øª Ø¨Ù†ÙƒØ² ${document.getElementById('name').innerText}`, null, profileUid);
    
    showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ÙƒØ²Ø© ğŸ‘‹");
}


// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± (Block)
async function blockUser() {
    // 1. Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ù† ØªØ±Ø§Ù‡ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆÙ„Ù† ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ù„ÙÙƒ.")) return;
    
    closeAllSheets();
    try {
        // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        await db.collection('users').doc(currentUser.uid).collection('blocked').doc(profileUid).set({
            uid: profileUid,
            name: document.getElementById('name').innerText,
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // âœ… 3. ØªØ³Ø¬ÙŠÙ„ "Ø§Ù„Ø­Ø¸Ø±" ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        logActivity('block', `Ù‚Ù…Øª Ø¨Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${document.getElementById('name').innerText}`, null, profileUid);

        // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
        showToast("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ ğŸš«");

        // 5. ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø£Ù† Ø§Ù„Ø´Ø®Øµ Ø¯Ù‡ Ù…Ø§Ø¨Ù‚Ø§Ø´ Ù…ØªØ§Ø­
        setTimeout(() => location.href = 'home.html', 1500); 

    } catch(e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø¸Ø±:", e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­Ø¸Ø±");
    }
}


// 4. Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
function copyProfileLink() {
    closeAllSheets();
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ğŸ”—"));
}

// 5. Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function sendFriendRequestFromMenu() {
    closeAllSheets();
    if(typeof sendRequest === 'function') sendRequest();
}

// ==========================================
// ğŸ“œ Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª (Activity Log)
// ==========================================

// Ø£) Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨ØªØ­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²)
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ø¹ Ø¯Ø¹Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù„Ù„Ø±Ø§Ø¨Ø·
function logActivity(type, description, targetPostId = null, postOwnerId = null) {
    if (!currentUser) return;
    
    db.collection('users').doc(currentUser.uid).collection('activityLog').add({
        type: type, 
        description: description,
        targetPostId: targetPostId,    // Ø¢ÙŠ Ø¯ÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        postOwnerId: postOwnerId,      // Ø¢ÙŠ Ø¯ÙŠ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©)
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}

// ==========================================
// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ actionUrl)
// ==========================================
function openActivityLog() {
    // 1. Ù‚ÙÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆÙØªØ­ Ø§Ù„Ø´ÙŠØª
    closeAllSheets(); 
    const sheet = document.getElementById('activityLogSheet');
    const container = document.getElementById('activityLogList');
    
    document.getElementById('overlay').style.display = 'block';
    sheet.classList.add('active');
    
    container.innerHTML = '<div class="loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</div>';

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const logsRef = db.collection('users').doc(currentUser.uid).collection('activityLog');

    logsRef.orderBy('createdAt', 'desc').limit(30).get()
        .then(snap => {
            container.innerHTML = ""; 

            if (snap.empty) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#777;">
                        <i class="fa-solid fa-clipboard-list" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i><br>
                        Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯
                    </div>`;
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                let time = (d.createdAt && d.createdAt.toDate) ? moment(d.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†';
                
                // --- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù„ÙˆÙ† ---
                let icon = 'fa-circle'; 
                let color = '#777';

                if(d.type === 'like') { icon = 'fa-heart'; color = '#ff3b30'; }
                else if(d.type === 'comment') { icon = 'fa-comment'; color = '#00c6ff'; }
                else if(d.type === 'view') { icon = 'fa-eye'; color = '#34c759'; }
                else if(d.type === 'poke') { icon = 'fa-hand-point-up'; color = '#ffb533'; }
                else if(d.type === 'block') { icon = 'fa-ban'; color = '#ff3b30'; }
                else if(d.type === 'share') { icon = 'fa-share-nodes'; color = '#bf5af2'; }

                // --- ğŸ”¥ ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§: ØªØ¹Ø±ÙŠÙ actionUrl ---
                let actionUrl = '#';
                // Ù„Ùˆ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØµØ§Ø­Ø¨Ù‡ØŒ Ø¨Ù†Ø¹Ù…Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·
                if (d.targetPostId && d.postOwnerId) {
                    actionUrl = `profile.html?uid=${d.postOwnerId}&post=${d.targetPostId}`;
                } 
                // Ø¯Ø¹Ù… Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© (activityLog Ø§Ù„Ù‚Ø¯ÙŠÙ…)
                else if (d.postId && d.postOwnerUid) {
                    actionUrl = `profile.html?uid=${d.postOwnerUid}&post=${d.postId}`;
                }

                // Ø±Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±
                container.innerHTML += `
                    <div style="display:flex; align-items:center; gap:15px; padding:15px; border-bottom:1px solid var(--border-color); cursor:pointer;" 
                         onclick="${actionUrl !== '#' ? `location.href='${actionUrl}'` : "showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù†Ø´ÙˆØ±')"}">
                        
                        <div style="width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.05); display:grid; place-items:center; flex-shrink:0;">
                            <i class="fa-solid ${icon}" style="color:${color}; font-size:18px;"></i>
                        </div>
                        
                        <div style="flex:1;">
                            <div style="font-size:14px; font-weight:bold; color:var(--text-color); margin-bottom:3px;">${d.description || d.detail || 'Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯'}</div>
                            <div style="font-size:11px; color:var(--secondary-text);">${time}</div>
                        </div>
                        
                        <div style="color:var(--secondary-text); font-size:12px;">
                            <i class="fa-solid fa-chevron-left"></i>
                        </div>
                    </div>
                `;
            });
        })
        .catch(error => {
            console.error(error);
            container.innerHTML = `<div style="text-align:center; padding:20px; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„<br><small>${error.message}</small></div>`;
        });
}
// --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± ÙƒØ±Ø© Ø§Ù„ÙŠÙˆØ±Ø§Ù†ÙŠÙˆÙ… ---

// 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø­Ø·Ù‡Ø§ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ù…Ø¹ window.onload)
function initOrbState() {
    const isHidden = localStorage.getItem('nabd_orb_hidden') === 'true';
    const orb = document.getElementById('uraniumOrb');
    const toggle = document.getElementById('orbToggleSwitch');
    
    if (isHidden) {
        // Ù„Ùˆ Ù…Ø­ÙÙˆØ¸ Ø¥Ù†Ù‡Ø§ Ù…Ø®ÙÙŠØ© -> Ø§Ø®ÙÙŠÙ‡Ø§ ÙˆØ·ÙÙŠ Ø§Ù„Ø²Ø±Ø§Ø±
        if(orb) orb.style.display = 'none';
        if(toggle) toggle.classList.remove('active');
        window.orbVisible = false; // Ù†Ø­Ø¯Ø« Ù…ØªØºÙŠØ± Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡
    } else {
        // Ø§Ù„Ø¹ÙƒØ³
        if(orb) orb.style.display = 'flex';
        if(toggle) toggle.classList.add('active');
        window.orbVisible = true;
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Ù„Ù…Ø§ ÙŠØ¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±)
function toggleOrbPreference() {
    playSound('click');
    const orb = document.getElementById('uraniumOrb');
    const toggle = document.getElementById('orbToggleSwitch');
    
    // Ø¨Ù†Ø´ÙˆÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ø³
    const isActive = toggle.classList.contains('active');
    
    if (isActive) {
        // Ù‡Ùˆ Ø´ØºØ§Ù„ ÙˆØ¹Ø§ÙŠØ² ÙŠØ·ÙÙŠÙ‡
        toggle.classList.remove('active');
        orb.style.transition = '0.3s';
        orb.style.transform = 'scale(0)'; // Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ø®ØªÙØ§Ø¡
        setTimeout(() => orb.style.display = 'none', 300);
        
        localStorage.setItem('nabd_orb_hidden', 'true'); // Ø­ÙØ¸ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
        showToast("ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒØ±Ø©");
    } else {
        // Ù‡Ùˆ Ù…Ø·ÙÙŠ ÙˆØ¹Ø§ÙŠØ² ÙŠØ´ØºÙ„Ù‡
        toggle.classList.add('active');
        orb.style.display = 'flex';
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        orb.style.left = '20px';
        orb.style.top = (window.innerHeight - 100) + 'px';
        
        // Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¸Ù‡ÙˆØ±
        setTimeout(() => {
            orb.style.transform = 'scale(1)';
            orb.style.opacity = '1';
        }, 10);
        
        localStorage.setItem('nabd_orb_hidden', 'false'); // Ø­ÙØ¸ Ø§Ù„Ø¸Ù‡ÙˆØ±
        showToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ±Ø©");
    }
}

// ğŸ”¥ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­
// Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø¬ÙˆÙ‡ auth.onAuthStateChanged Ø£Ùˆ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
initOrbState();
// Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª (Ù†ÙØ³ Ø¨ØªØ§Ø¹Ø© Ø§Ù„Ø´Ø§Øª)
function getShortLastSeen(timestamp) {
    if (!timestamp) return '';
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    const weeks = Math.floor(days / 7);

    if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
    if (minutes < 60) return `${minutes} Ø¯`;
    if (hours < 24) return `${hours} Ø³`;
    if (days < 7) return `${days} ÙŠ`;
    if (weeks <= 4) return `${weeks} Ø£`;
    return '';
}


</script> 
    <div class="bottom-sheet" id="repliesSheet" style="height: 85vh; border-radius: 24px 24px 0 0;">
        <div class="sheet-handle"></div>
        <div class="cm-header">
            <i class="fa-solid fa-arrow-right" onclick="closeRepliesSheet()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
            <span style="flex:1; text-align:center;">Ø§Ù„Ø±Ø¯ÙˆØ¯</span>
            <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
        </div>
        
        <div class="cm-body" id="repliesList" style="padding-bottom: 80px;">
            </div>
        
        <div class="cm-input-wrapper">
    <i class="fa-solid fa-face-laugh-beam sticker-trigger-btn" onclick="toggleStickerSheet('reply')"></i>

    <input type="text" class="cm-input" id="replyInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ø§Ù‹..." autocomplete="off">
    <i class="fa-solid fa-paper-plane cm-send-btn" onclick="sendReplyToComment()"></i>
</div>

        </div>
    </div>
    <div class="custom-modal" id="editPostModal">
        <div class="modal-box">
            <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</h3>
            <textarea id="editPostInput" style="width:100%; height:120px; background:var(--input-bg); border:1px solid var(--border-color); color:var(--text-color); padding:10px; border-radius:10px; margin:15px 0; resize:none; outline:none; font-family:'Cairo';"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('editPostModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-primary" onclick="saveEditedPost()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>

    <div class="custom-modal" id="reportReasonModal">
        <div class="modal-box">
            <h3 style="color:var(--danger-color)">ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº</h3>
            <p style="color:var(--secondary-text); font-size:13px; margin-bottom:15px;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button class="btn btn-secondary" onclick="submitReport('Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚')">ğŸ” Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚</button>
                <button class="btn btn-secondary" onclick="submitReport('Ø®Ø·Ø§Ø¨ ÙƒØ±Ø§Ù‡ÙŠØ© Ø£Ùˆ ØªÙ†Ù…Ø±')">ğŸ¤¬ Ø®Ø·Ø§Ø¨ ÙƒØ±Ø§Ù‡ÙŠØ© / ØªÙ†Ù…Ø±</button>
                <button class="btn btn-secondary" onclick="submitReport('Ø§Ø­ØªÙŠØ§Ù„ Ø£Ùˆ Ù†ØµØ¨')">ğŸš« Ø§Ø­ØªÙŠØ§Ù„ Ø£Ùˆ Ù†ØµØ¨</button>
                <button class="btn btn-secondary" onclick="submitReport('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø²Ø§Ø¦ÙØ©')">ğŸ¤¥ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø²Ø§Ø¦ÙØ©</button>
                <button class="btn btn-secondary" onclick="submitReport('Ø¢Ø®Ø±')">Ø³Ø¨Ø¨ Ø¢Ø®Ø±</button>
            </div>
            <button style="margin-top:15px; color:var(--secondary-text); font-size:12px;" onclick="document.getElementById('reportReasonModal').style.display='none'">ØªØ±Ø§Ø¬Ø¹</button>
        </div>
    </div>
<div class="bottom-sheet" id="replyOptionsSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    
    <div id="replyOwnerOptions" style="display:none;">
        <div class="c-option-item" onclick="triggerEditReplyAction()">
            <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¯
        </div>
        <div class="c-option-item" onclick="triggerCopyReply()">
            <i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ù†Øµ
        </div>
        <div class="c-option-item danger" onclick="triggerDeleteReply()">
            <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø±Ø¯
        </div>
    </div>

        <div id="replyViewerOptions" style="display:none;">
    <div class="c-option-item" onclick="triggerReplyToUser()" id="replyToUserBtn">
        <i class="fa-solid fa-reply"></i> Ø±Ø¯
    </div>
    <div class="c-option-item" onclick="triggerCopyReply()">
        <i class="fa-regular fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ù†Øµ
    </div>
    <div class="c-option-item danger" onclick="reportComment()">
        <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº
    </div>
</div>
    
    <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color)" onclick="closeAllSheets(true)">Ø¥Ù„ØºØ§Ø¡</div>
</div>
<div class="custom-modal" id="chicConfirmModal" style="z-index: 9999;">
    <div class="modal-box" style="border: 1px solid var(--border-color); background: var(--card-color); max-width: 320px;">
        <div style="font-size: 40px; margin-bottom: 15px;" id="chicIcon"></div>
        <h3 id="chicTitle" style="margin-bottom: 10px; color: var(--text-color);">ØªØ£ÙƒÙŠØ¯</h3>
        <p id="chicMessage" style="color: var(--secondary-text); font-size: 14px; margin-bottom: 25px; line-height: 1.5;"></p>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeChicModal()" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-primary" id="chicConfirmBtn" style="flex: 1; background: var(--danger-color); box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3);">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>
<div class="bottom-sheet" id="stickerSheet" style="height: auto; max-height: 60vh; z-index: 250;">
    
    <i class="fa-solid fa-xmark sheet-close-btn" onclick="closeAllSheets()"></i>

    <div class="sheet-handle"></div>
    
    <div style="padding: 15px; text-align: center; font-weight: 800; border-bottom: 1px solid var(--border-color); color:var(--text-color)">
        Ø§Ø³ØªÙŠÙƒØ±Ø§Øª
    </div>

    <div class="stickers-grid" id="stickersGrid">
        </div>
</div>
<div class="bottom-sheet" id="profileMenuSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <div id="profileMenuContent" style="padding: 10px 0;">
        </div>
    <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color)" onclick="closeAllSheets()">Ø¥Ù„ØºØ§Ø¡</div>
</div>

<div class="bottom-sheet" id="activityLogSheet" style="height: 85vh;">
    <div class="sheet-handle"></div>
    <div class="cm-header">
        <span style="display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-clock-rotate-left" style="color:var(--primary-solid)"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
        </span>
        <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px"></i>
    </div>
    <div class="cm-body" id="activityLogList" style="padding: 0;">
        <div class="loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</div>
    </div>
</div>
<div class="custom-modal" id="chicConfirmModal" style="z-index: 9999;">
    <div class="modal-box" style="border: 1px solid var(--border-color); background: var(--card-color); max-width: 320px;">
        <div style="font-size: 40px; margin-bottom: 15px;" id="chicIcon"></div>
        <h3 id="chicTitle" style="margin-bottom: 10px; color: var(--text-color);">ØªØ£ÙƒÙŠØ¯</h3>
        <p id="chicMessage" style="color: var(--secondary-text); font-size: 14px; margin-bottom: 25px; line-height: 1.5;"></p>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeChicModal()" style="flex: 1;">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-primary" id="chicConfirmBtn" style="flex: 1; background: var(--danger-color); box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3);">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>
        <script src="global-call.js"></script>
<script>
(function() {
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª (ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)
    window.appSoundsEnabled = localStorage.getItem('nabd_app_sounds') !== 'false';

    // 2. ØªØ¹Ø±ÙŠÙ ØµÙˆØª Ø§Ù„Ù†Ù‚Ø±
    const clickAudio = new Audio('./sounds/click.mp3');
    clickAudio.volume = 0.6; 

    // 3. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    function updateSoundUI() {
        const icon = document.getElementById('soundIcon');
        const toggle = document.getElementById('soundToggle');
        
        if(icon && toggle) {
            if (window.appSoundsEnabled) {
                icon.className = "fa-solid fa-volume-high";
                icon.style.color = "var(--primary-solid)";
                toggle.classList.add('active');
            } else {
                icon.className = "fa-solid fa-volume-xmark";
                icon.style.color = "#777";
                toggle.classList.remove('active');
            }
        }
    }
    
    // ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
    document.addEventListener('DOMContentLoaded', updateSoundUI);

    // 4. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Ù„Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
    window.toggleAppSounds = function() {
        window.appSoundsEnabled = !window.appSoundsEnabled;
        localStorage.setItem('nabd_app_sounds', window.appSoundsEnabled);
        updateSoundUI();
        
        if(window.appSoundsEnabled) {
            clickAudio.currentTime = 0;
            clickAudio.play().catch(()=>{});
            if(typeof showToast === 'function') showToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª ğŸ”Š");
        } else {
            if(typeof showToast === 'function') showToast("ØªÙ… ÙƒØªÙ… Ø§Ù„Ø£ØµÙˆØ§Øª ğŸ”‡");
        }
    };

    // 5. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© playSound Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    const oldPlaySound = window.playSound;
    window.playSound = function(type) {
        if (!window.appSoundsEnabled) return; 
        if (type !== 'click' && typeof oldPlaySound === 'function') {
            oldPlaySound(type); 
        }
    };

    // 6. ğŸ”¥ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ù‚Ø± (Ù…Ø®ØµØµ Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) ğŸ”¥
    const clickableSelectors = [
        'button',           // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        '.btn',             // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ù…ØªØ§Ø¨Ø¹Ø©/Ø±Ø³Ø§Ù„Ø©)
        '.menu-item',       // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        '.tab-item',        // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Ø§Ù„ÙƒÙ„/ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ)
        '.photo-item',      // Ø§Ù„ØµÙˆØ±
        '.reel-item',       // Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        '.stat-item',       // Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        '.edit-cover-btn',  // Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØºÙ„Ø§Ù
        '.np-input-trigger',// Ù…ÙƒØ§Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙˆØ³Øª
        '.np-media-btn',    // Ø²Ø± Ø±ÙØ¹ ØµÙˆØ±Ø©
        '.action-btn',      // Ù„Ø§ÙŠÙƒ ÙˆÙƒÙˆÙ…Ù†Øª
        '.sheet-option',    // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        '.c-option-item',   // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        '.sticker-trigger-btn', // Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±
        '.cm-send-btn',     // Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        '.sat-btn',         // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙˆØ±Ø©
        '#copyBtn',         // Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù
        '.fa-xmark',        // Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        '.fa-bars',         // Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        '.fa-magnifying-glass' // Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
    ];

    document.addEventListener('click', function(e) {
        if (!window.appSoundsEnabled) return;

        // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØª Ù†ÙØ³Ù‡
        if (e.target.closest('[onclick="toggleAppSounds()"]')) return;

        const target = e.target.closest(clickableSelectors.join(','));
        
        if (target) {
            clickAudio.currentTime = 0;
            clickAudio.play().catch(() => {});
        }
    }, true);

})();
</script>

<div id="blockedScreen" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:80vh; text-align:center; padding:20px;">
    <i class="fa-solid fa-user-slash" style="font-size:60px; color:#333; margin-bottom:20px;"></i>
    <div style="font-size:18px; color:#777; font-weight:bold;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­</div>
    <div style="font-size:14px; color:#555; margin-top:5px;">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¨Ø³Ø¨Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©.</div>
    <button onclick="location.href='home.html'" style="margin-top:20px; padding:10px 25px; background:#1f1f1f; border:1px solid #333; color:#fff; border-radius:20px; cursor:pointer;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

</body>
</html>