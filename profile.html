<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD - الملف الشخصي</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- المتغيرات والتأسيس --- */
        .mention-tag {
            color: #2979ff;
            background: rgba(41, 121, 255, 0.15);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-left: 5px;
            transition: 0.2s;
        }
        .mention-tag:hover {
            background: rgba(41, 121, 255, 0.25);
            text-decoration: underline;
        }

        :root {
            --bg-color: #0d0d0f;
            --card-color: #161616;
            --primary-gradient: linear-gradient(135deg, #5D5FEF, #7879F1);
            --primary-solid: #5D5FEF;
            --uranium-green: #3fff00;
            --text-color: #eee;
            --secondary-text: #aaa;
            --border-color: #2a2a2a;
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --input-bg: #1f1f1f;
            --header-bg: rgba(22, 22, 22, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.3);
            --sheet-bg: #1e1e1e;
        }

        body.light-mode {
            --bg-color: #f2f4f7;
            --card-color: #ffffff;
            --text-color: #1a1a1a;
            --secondary-text: #666;
            --border-color: #e0e0e0;
            --input-bg: #f0f2f5;
            --header-bg: rgba(255, 255, 255, 0.85);
            --glass-bg: rgba(0, 0, 0, 0.05);
            --shadow-soft: 0 5px 20px rgba(0,0,0,0.05);
            --sheet-bg: #fff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Cairo", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-color); color: var(--text-color); overflow-x: hidden; padding-bottom: 90px; transition: background 0.3s, color 0.3s; overscroll-behavior-y: contain; user-select: none; }
        a { text-decoration: none; color: inherit; }
        button { border: none; outline: none; background: none; cursor: pointer; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- الهيدر والقوائم --- */
        .header { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; 
            border-bottom: 1px solid var(--border-color); position: sticky; top: 0; 
            background: var(--header-bg); z-index: 50; backdrop-filter: blur(12px); 
        }
        .header-title { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
        
        .side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        .side-menu-overlay.visible { opacity: 1; }
        
        .side-menu { 
            position: fixed; top: 0; left: 0; height: 100%; width: 280px; 
            background: var(--card-color); z-index: 101; transform: translateX(-100%); 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            border-right: 1px solid var(--border-color); display: flex; flex-direction: column;
        }
        .side-menu.open { transform: translateX(0); }
        
        .menu-header { padding: 40px 20px; text-align: center; background: linear-gradient(to bottom, rgba(93,95,239,0.1), transparent); }
        .menu-avatar { width: 70px; height: 70px; border-radius: 50%; background: var(--primary-solid); margin: 0 auto 12px; display: grid; place-items: center; font-size: 26px; font-weight: bold; background-size: cover; border: 2px solid var(--border-color); box-shadow: var(--shadow-soft); }
        
        .menu-items { flex: 1; padding-top: 10px; overflow-y: auto; }
        .menu-item { padding: 16px 25px; display: flex; gap: 18px; cursor: pointer; color: var(--text-color); align-items: center; font-weight: 600; font-size: 15px; transition: 0.2s; border-left: 3px solid transparent; }
        .menu-item i { width: 24px; color: var(--primary-solid); font-size: 18px; text-align: center; }
        .menu-item:hover { background: var(--glass-bg); border-left-color: var(--primary-solid); }

        /* --- البروفايل --- */
        .cover { height: 180px; background: linear-gradient(45deg, #141414, #2b1055, #5D5FEF); position: relative; transition: background 0.5s ease; }
        .edit-cover-btn { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.4); color: #fff; width: 35px; height: 35px; border-radius: 50%; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); font-size: 14px; transition: 0.2s; z-index: 10; }
        .edit-cover-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.7); }

        .avatar-container { position: absolute; bottom: -55px; left: 50%; transform: translateX(-50%); }
        .avatar { width: 110px; height: 110px; border-radius: 40%; border: 4px solid var(--bg-color); background: var(--card-color); display: grid; place-items: center; font-size: 35px; font-weight: 900; background-size: cover; color: var(--text-color); box-shadow: var(--shadow-soft); transition: border-radius 0.3s; }
        
        .info { margin-top: 65px; text-align: center; padding: 0 20px; }
        .name { font-size: 26px; font-weight: 800; display: flex; justify-content: center; align-items: center; gap: 6px; letter-spacing: -0.5px; }
        .username { font-size: 14px; color: var(--secondary-text); margin-top: 2px; direction: ltr; font-weight: 600; }
        .bio { margin: 15px auto; font-size: 15px; color: var(--text-color); max-width: 500px; line-height: 1.6; opacity: 0.9; }

        .stats-container { display: flex; justify-content: center; gap: 15px; margin: 25px 20px; padding: 15px; background: var(--card-color); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .stat-item { text-align: center; cursor: pointer; flex: 1; }
        .stat-count { font-size: 20px; font-weight: 800; color: var(--text-color); }
        .stat-label { font-size: 12px; color: var(--secondary-text); font-weight: 600; }

        .buttons { display: flex; gap: 12px; padding: 0 20px; justify-content: center; margin-bottom: 20px; }
        .btn { height: 48px; border-radius: 16px; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); flex: 1; position: relative; overflow: hidden; }
        .btn-primary { background: var(--primary-gradient); color: #fff; flex: 2; box-shadow: 0 8px 20px rgba(93, 95, 239, 0.3); }
        .btn-secondary { background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
        .btn-chat { background: var(--uranium-green); color: #000; width: 48px; flex: 0 0 48px; border-radius: 16px; font-size: 18px; box-shadow: 0 5px 15px rgba(63, 255, 0, 0.2); }
        .btn:active { transform: scale(0.96); }

        /* --- التبويبات --- */
        .profile-tabs { display: flex; justify-content: space-around; border-bottom: 1px solid var(--border-color); background: var(--card-color); position: sticky; top: 70px; z-index: 40; margin-bottom: 10px; }
        .tab-item { flex: 1; text-align: center; padding: 15px 0; font-weight: 700; color: var(--secondary-text); cursor: pointer; position: relative; transition: 0.3s; }
        .tab-item.active { color: var(--primary-solid); }
        .tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 3px; background: var(--primary-solid); border-radius: 3px 3px 0 0; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        /* --- الجريد والمنشورات --- */
        .photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .photo-item { aspect-ratio: 1/1; width: 100%; object-fit: cover; cursor: pointer; background: #222; }
        .reels-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; padding: 3px; }
        .reel-item { position: relative; aspect-ratio: 9/16; background: #000; border-radius: 6px; overflow: hidden; cursor: pointer; }
        .reel-thumb { width: 100%; height: 100%; object-fit: cover; }
        .reel-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%); display: flex; flex-direction: column; justify-content: flex-end; padding: 8px; }
        .reel-stats { color: #fff; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .reel-title { color: #ddd; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }

        .new-post-wrapper { background: var(--card-color); margin: 0 15px 20px; border-radius: 18px; border: 1px solid var(--border-color); padding: 15px; display: flex; align-items: center; gap: 12px; }
        .np-input-trigger { flex: 1; background: var(--input-bg); border-radius: 30px; padding: 12px 20px; color: var(--secondary-text); font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .np-mini-avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; background-size: cover; }
        .np-media-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; background: rgba(52, 199, 89, 0.1); color: var(--success-color); transition: 0.2s; }

        .post { background: var(--card-color); border: 1px solid var(--border-color); margin: 0 0 15px; border-radius: 0; padding-bottom: 5px; }
        @media (min-width: 700px) { .post { border-radius: 18px; margin: 0 15px 15px; } }
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        .user-info { display: flex; gap: 12px; align-items: center; }
        .post-avatar { width: 44px; height: 44px; border-radius: 50%; background: #333; display: grid; place-items: center; font-weight: bold; background-size: cover; border: 1px solid var(--border-color); }
        .user-details h4 { font-size: 15px; font-weight: 700; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
        .user-details span { font-size: 12px; color: var(--secondary-text); }
        .post-text { padding: 0 15px 12px; font-size: 15px; line-height: 1.6; color: var(--text-color); white-space: pre-wrap; }
        .post-text.has-bg { min-height: 280px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 26px; font-weight: 800; color: #fff; padding: 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .media-grid { display: grid; gap: 2px; margin-top: 5px; background: #000; overflow: hidden; }
        .media-grid.single { grid-template-columns: 1fr; }
        .media-grid.double { grid-template-columns: 1fr 1fr; }
        .media-item { width: 100%; max-height: 550px; object-fit: cover; display: block; cursor: pointer; }
        .post-actions { display: flex; padding: 8px 15px; border-top: 1px solid var(--border-color); gap: 5px; }
        .action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; color: var(--secondary-text); font-size: 14px; font-weight: 600; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .action-btn.liked { color: var(--danger-color); background: rgba(255, 59, 48, 0.05); }

        /* --- القوائم السفلية (Updated) --- */
        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; backdrop-filter: blur(4px); }
        .bottom-sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--sheet-bg); 
            z-index: 201; border-radius: 24px 24px 0 0; transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
            border-top: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 85vh;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 5px; background: var(--border-color); border-radius: 10px; margin: 12px auto; }

        /* --- التعليقات (New System) --- */
        .cm-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 16px; background: var(--sheet-bg); z-index: 10; border-radius: 24px 24px 0 0; }
        .cm-body { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; background: var(--sheet-bg); }
        .cm-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px 15px 15px; border-top: 1px solid var(--border-color); background: var(--sheet-bg); z-index: 202; }
        
        .cm-input-wrapper { display: flex; align-items: center; background: var(--input-bg); border-radius: 25px; padding: 5px 15px; border: 1px solid var(--border-color); }
        .cm-input { flex: 1; background: transparent; border: none; padding: 10px 5px; color: var(--text-color); outline: none; max-height: 100px; resize: none; font-size: 15px; }
        .cm-send-btn { color: var(--primary-solid); padding: 8px; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .cm-send-btn.update-mode { color: var(--success-color); }

        .comment-item { display: flex; gap: 10px; margin-bottom: 18px; position: relative; }
        .cm-avatar { width: 38px; height: 38px; border-radius: 50%; background: #333; flex-shrink: 0; background-size: cover; border: 1px solid var(--border-color); }
        .cm-content { flex: 1; max-width: 85%; }
        /* --- ستايل الفقاعات الملونة --- */


/* 1. الشكل الأساسي (لأي شخص عادي) */
.cm-bubble {
    background: #262626;       /* لون رمادي غامق (الافتراضي) */
    border: 1px solid #333;
    padding: 10px 14px;
    border-radius: 18px;
    border-top-right-radius: 2px;
    color: #eee;
    min-width: 120px;
    position: relative;
}

/* 2. شكل فقاعة "صاحب المنشور" (The Boss) */
.cm-bubble.owner-bubble {
    background: rgba(93, 95, 239, 0.25); /* لون أزرق شفاف مميز */
    border: 1px solid #5D5FEF;           /* برواز أزرق */
    box-shadow: 0 0 10px rgba(93, 95, 239, 0.1);
}

/* 3. تحسين شكل الاسم */
.cm-username {
    font-size: 13px;
    font-weight: 800;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* 4. لو صاحب المنشور، نخلي اسمه بلون مميز */
.cm-bubble.owner-bubble .cm-username {
    color: #aeb0ff !important;
}

/* علامة (تاج) صغيرة تظهر جنب اسم صاحب المنشور */
.owner-badge {
    font-size: 10px;
    background: #5D5FEF;
    color: #fff;
    padding: 1px 6px;
    border-radius: 8px;
    display: none; /* مخفية للناس العادية */
}
.cm-bubble.owner-bubble .owner-badge {
    display: inline-block; /* تظهر بس لصاحب المنشور */
}


/* 2. اسم صاحب التعليق */
.cm-username {
    font-weight: 800;
    font-size: 13px;
    color: #ffffff !important; /* أبيض ناصع عشان الاسم يبان */
    margin-bottom: 6px;
    display: block;
    letter-spacing: 0.5px;
}

/* 3. نص التعليق نفسه */
.cm-text {
    font-size: 15px;      /* كبرنا الخط سنة */
    line-height: 1.6;     /* مسافة بين السطور للقراءة المريحة */
    color: #e0e0e0;       /* لون فضي فاتح مريح للعين */
    white-space: pre-wrap;
    word-break: break-word;
}

/* 4. لو التعليق ده معمول له تحديد (Highlight) */
.cm-bubble.highlight {
    background: rgba(93, 95, 239, 0.15); /* لون أزرق شفاف */
    border-color: var(--primary-solid);
    box-shadow: 0 0 15px rgba(93, 95, 239, 0.3); /* توهج */
}

        .cm-user-row { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .cm-username { font-weight: 700; font-size: 13px; color: var(--text-color); }
        .cm-verified { color: #3897f0; font-size: 12px; }
        .cm-text { font-size: 14px; line-height: 1.4; color: var(--text-color); white-space: pre-wrap; word-break: break-word; }
        
        .cm-meta-row { display: flex; gap: 15px; margin-top: 5px; margin-right: 12px; font-size: 11px; color: var(--secondary-text); font-weight: 600; }
        .cm-action { cursor: pointer; transition: 0.2s; }
        .cm-action:hover { color: var(--text-color); }

        .reply-indicator { background: var(--input-bg); padding: 8px 15px; font-size: 12px; color: var(--secondary-text); display: none; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); margin: 0 -15px; padding-right: 30px; }
        .reply-indicator.active { display: flex; }

        /* --- قائمة خيارات التعليق (Long Press Sheet) --- */
        #commentOptionsSheet .reactions-row { display: flex; justify-content: space-between; padding: 15px 25px; background: var(--input-bg); border-radius: 50px; margin: 10px 15px 20px; border: 1px solid var(--border-color); }
        .reaction-emoji { font-size: 24px; cursor: pointer; transition: transform 0.2s; }
        .reaction-emoji:hover { transform: scale(1.3); }
        
        .c-option-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; font-size: 15px; font-weight: 600; color: var(--text-color); cursor: pointer; transition: 0.2s; }
        .c-option-item:hover { background: var(--glass-bg); }
        .c-option-item i { width: 25px; text-align: center; font-size: 18px; color: var(--secondary-text); }
        .c-option-item.danger { color: var(--danger-color); }
        .c-option-item.danger i { color: var(--danger-color); }

        /* --- باقي المودلز والادوات --- */
        .custom-modal { position: fixed; inset: 0; z-index: 3000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        .modal-box { background: var(--card-color); width: 85%; max-width: 380px; border-radius: 24px; padding: 30px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .account-list { text-align: right; max-height: 250px; overflow-y: auto; margin: 20px 0; background: var(--bg-color); border-radius: 16px; padding: 10px; }
        .acc-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border-color); }
        .acc-item:last-child { border-bottom: none; }
        .acc-item:hover { background: var(--input-bg); }
        .login-inputs input { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); padding: 14px; border-radius: 12px; color: var(--text-color); margin-bottom: 10px; outline: none; }

        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 20px 0; justify-items: center; }
        .color-swatch { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s, border-color 0.2s; position: relative; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: #fff; transform: scale(1.15); box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* --- كرة اليورانيوم المتطورة --- */
        .uranium-orb {
            position: fixed; bottom: 30px; left: 20px; width: 55px; height: 55px;
            background: radial-gradient(circle at 30% 30%, #fff, var(--primary-solid), #000);
            border-radius: 50%; z-index: 9999; cursor: grab;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 25px var(--primary-solid), inset -5px -5px 15px rgba(0,0,0,0.4);
            animation: pulse-orb 3s infinite alternate; touch-action: none;
            transition: box-shadow 0.3s, background 0.3s, transform 0.3s, opacity 0.3s; 
        }
        
        /* وضع الإنذار */
        .uranium-orb.red-alert {
            background: radial-gradient(circle at 30% 30%, #ffcccc, #ff0000, #4d0000) !important;
            box-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000, 0 0 100px #ff0000 !important;
            animation: shake-hard 0.5s ease-in-out infinite !important;
            transform: scale(1.1);
        }
        @keyframes shake-hard {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-5px, 5px) rotate(-10deg); }
            40% { transform: translate(5px, -5px) rotate(10deg); }
            60% { transform: translate(-5px, -5px) rotate(-10deg); }
            80% { transform: translate(5px, 5px) rotate(10deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* الفقاعة */
        .orb-msg-bubble {
            position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%) scale(0);
            background: rgba(220, 20, 60, 0.95);
            border: 1px solid #ff9999;
            color: #fff; padding: 8px 15px; border-radius: 15px 15px 15px 0;
            font-size: 13px; font-weight: bold; white-space: nowrap; max-width: 200px;
            overflow: hidden; text-overflow: ellipsis; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            opacity: 0; pointer-events: none; transition: all 0.4s; z-index: 10002;
        }
        .orb-msg-bubble.show-msg { opacity: 1; transform: translateX(-50%) scale(1); bottom: 75px; }

        .uranium-orb.super-mode {
            width: 70px; height: 70px;
            box-shadow: 0 0 80px var(--primary-solid), 0 0 150px var(--primary-solid), 0 0 30px #fff; 
            animation: super-pulse 0.2s infinite alternate; 
            z-index: 10001;
            background: radial-gradient(circle at 50% 50%, #fff, var(--primary-solid));
        }
        .satellites-container {
            position: absolute; width: 250px; height: 250px; 
            pointer-events: none; opacity: 0; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .uranium-orb.super-mode .satellites-container { opacity: 1; pointer-events: auto; }
        
        .sat-btn {
            position: absolute; width: 45px; height: 45px;
            background: rgba(20, 20, 20, 0.9); border: 2px solid var(--primary-solid);
            border-radius: 50%; color: #fff; display: grid; place-items: center;
            font-size: 18px; box-shadow: 0 0 15px rgba(0,0,0,0.5);
            cursor: pointer; transition: 0.3s;
        }
        .sat-btn i { color: var(--primary-solid); text-shadow: 0 0 5px var(--primary-solid); }

        @keyframes pulse-orb { 0% { box-shadow: 0 0 15px var(--primary-solid); } 100% { box-shadow: 0 0 35px var(--primary-solid); } }
        @keyframes super-pulse { 
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 60px var(--primary-solid); } 
            100% { transform: translate(-50%, -50%) scale(1.15); box-shadow: 0 0 120px var(--primary-solid); } 
        }

        /* منطقة الحذف */
        #deleteZone {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) scale(0);
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255, 0, 0, 0.1); border: 2px dashed #ff0000;
            color: #ff0000; display: flex; align-items: center; justify-content: center;
            font-size: 30px; transition: all 0.3s; z-index: 9998; pointer-events: none;
        }

        /* نافذة اختيار السمة */
        .theme-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10005;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .theme-card {
            background: #111; width: 90%; max-width: 380px; padding: 25px;
            border-radius: 25px; text-align: center; border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            transform: scale(0.8); opacity: 0; transition: 0.3s;
        }
        .theme-modal-overlay.active { display: flex; }
        .theme-modal-overlay.active .theme-card { transform: scale(1); opacity: 1; }
        
        .theme-title { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .theme-subtitle { font-size: 14px; color: #888; margin-bottom: 25px; }
        
        .colors-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;
            margin-bottom: 25px; justify-items: center;
        }
                .color-circle {
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.1); /* برواز خفيف */
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* ضل يدي عمق */
        }
        .color-circle:hover { 
            transform: scale(1.15); 
            z-index: 2;
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.4); /* توهج عند اللمس */
        }
        .color-circle:active {
            transform: scale(0.95);
        }

        .btn-reset-theme {
            background: linear-gradient(45deg, #333, #444); color: #fff;
            border: 1px solid #555;
        }

        .pull-indicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10000; background: var(--card-color); padding: 8px 15px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; font-weight: bold; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
        .skeleton { background: linear-gradient(90deg, var(--input-bg) 25%, var(--border-color) 50%, var(--input-bg) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 6px; color: transparent !important; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #222; color: #fff; padding: 12px 24px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.4s; z-index: 6000; display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .loading-spinner { text-align: center; padding: 20px; color: var(--secondary-text); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary-text); }
        .about-item { display: flex; align-items: center; gap: 12px; font-size: 15px; color: var(--text-color); margin-bottom: 12px; }
        .about-item i { width: 25px; color: var(--secondary-text); text-align: center; font-size: 18px; }

        /* ستايل المينشن */
        .mention-link { font-weight: bold; color: var(--text-color); background: rgba(93,95,239,0.2); padding: 0 4px; border-radius: 4px; cursor: pointer; }
    /* ========================================= */
/* بداية كود شجرة الردود والألوان (جديد) */
/* ========================================= */

/* الـ 10 ألوان اللي هتتوزع على الناس */
/* ========================================= */
/* استايل الشجرة والألوان (تحديث: الفقاعات الملونة) */
/* ========================================= */

/* تعريف الألوان (زي ما هي) */
.color-0 { --user-color: #5D5FEF; } /* أزرق */
.color-1 { --user-color: #34c759; } /* أخضر */
.color-2 { --user-color: #ff3b30; } /* أحمر */
.color-3 { --user-color: #ffb533; } /* برتقالي */
.color-4 { --user-color: #bf5af2; } /* بنفسجي */
.color-5 { --user-color: #64d2ff; } /* سماوي */
.color-6 { --user-color: #ff9f0a; } /* ذهبي */
.color-7 { --user-color: #ff375f; } /* بينك */
.color-8 { --user-color: #ac8e68; } /* بني */
.color-9 { --user-color: #808080; } /* رمادي */

/* --- التعديل هنا: شكل الفقاعة الجديد --- */
.cm-bubble.colored-reply {
    position: relative;
    transition: 0.2s;
    
    /* خلفية غامقة عشان الكلام يبان */
    background: #1a1a1a; 
    
    /* البرواز بياخد لون الشخص المتغير */
    border: 1px solid var(--user-color); 
    border-right-width: 4px; /* الخط اليمين أعرض شوية */
    
    /* اللمسة السحرية: توهج خفيف بنفس لون الشخص جوه وبره المربع */
    box-shadow: 
        inset 0 0 10px -5px var(--user-color), /* ضي داخلي */
        0 5px 15px -8px var(--user-color);     /* ضي خارجي */
        
    border-radius: 12px;
    padding: 10px 14px;
}

/* تلوين اسم المستخدم وتفتيحه شوية */
.cm-bubble.colored-reply .cm-username {
    color: var(--user-color) !important;
    filter: brightness(1.3); /* عشان يبقى منور */
    margin-bottom: 5px;
}
/* --- ستايل التعليقات الرئيسية الملونة (نفس ستايل الردود) --- */
.cm-bubble.colored-comment {
    position: relative;
    background: #1a1a1a; /* نفس الخلفية الغامقة */
    border: 1px solid var(--user-color); /* البرواز بلون المستخدم */
    border-right-width: 4px;
    box-shadow: 
        inset 0 0 10px -5px var(--user-color),
        0 5px 15px -8px var(--user-color); /* التوهج */
    transition: 0.2s;
}

/* تلوين اسم المستخدم في التعليق الرئيسي */
.cm-bubble.colored-comment .cm-username {
    color: var(--user-color) !important;
    filter: brightness(1.3);
    margin-bottom: 5px;
}

/* لو صاحب المنشور، بنزود التوهج شوية عشان يبان مميز وسط الألوان */
.cm-bubble.colored-comment.owner-bubble {
    background: rgba(93, 95, 239, 0.15); /* تمييز خفيف للخلفية */
    border-color: #5D5FEF;
    box-shadow: 
        inset 0 0 15px -5px #5D5FEF,
        0 0 20px -5px rgba(93, 95, 239, 0.4);
    --user-color: #5D5FEF; /* تثبيت لون صاحب المنشور للأزرق */
}

/* خط الشجرة (زي ما هو) */
.tree-connector {
    position: absolute;
    right: -24px;
    top: -20px;
    bottom: 0;
    width: 2px;
    background: #333;
    z-index: 0;
}

/* المنحنى (زي ما هو) */
.reply-curve {
    position: absolute;
    right: -24px;
    top: 20px;
    width: 15px;
    height: 2px;
    background: #333;
}


/* المنحنى الصغير اللي بيشاور عالرد */
/* ========================================= */
/* ========================================= */
/* ستايل زر اليورانيوم المشع (Uranium Button) */
/* ========================================= */

#copyBtn {
    /* 1. الألوان المشعة */
    background: #000; /* خلفية سوداء عشان اللون يبان */
    color: #39ff14;   /* أخضر نيون فاقع */
    border: 2px solid #39ff14; /* برواز مضيء */
    
    /* 2. الشكل والحجم */
    border-radius: 50px;
    padding: 6px 15px;
    font-size: 12px;
    font-weight: 900; /* خط تخين */
    
    /* 3. التوهج (The Glow) */
    box-shadow: 0 0 10px #39ff14, inset 0 0 5px #39ff14;
    text-shadow: 0 0 5px #39ff14;
    
    /* 4. الأنيميشن (النبض) */
    animation: uraniumPulse 1.5s infinite alternate;
    
    /* تظبيط المكان */
    margin-top: 8px;
    cursor: pointer;
    transition: 0.3s;
    display: none; /* مخفي لحد ما الجافاسكريبت يظهره */
    align-items: center;
    gap: 8px;
}

/* لما الماوس ييجي عليه ينور أكتر */
#copyBtn:hover {
    background: #39ff14;
    color: #000;
    box-shadow: 0 0 40px #39ff14;
    transform: scale(1.05);
}

/* حركة النبض الإشعاعي */
@keyframes uraniumPulse {
    0% {
        box-shadow: 0 0 5px #39ff14;
    }
    100% {
        box-shadow: 0 0 20px #39ff14, 0 0 10px #39ff14 inset;
    }
}
        .sheet-option { padding: 12px 20px; display: flex; gap: 15px; align-items: center; font-weight: 600; cursor: pointer; border-radius: 10px; transition: 0.2s; color: var(--text-color); }
        .sheet-option:hover { background: var(--input-bg); }
/* ستايل زر كتم الصوت فوق الفيديو */
.video-mute-btn {
    position: absolute;
    bottom: 10px;
    right: 10px; /* خليناه يمين عشان عداد المشاهدات على الشمال */
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.6); /* لون أسود شفاف */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    cursor: pointer;
    z-index: 20; /* عشان يبقى فوق الفيديو */
    backdrop-filter: blur(2px);
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.2s;
}

.video-mute-btn:active {
    transform: scale(0.9);
}

.video-mute-btn i {
    font-size: 14px;
}
/* كلاس لمنع الصفحة من الحركة لما نفتح قايمة */
body.no-scroll {
    
/* --- إضافات الردود والمنشن الجديد --- */
/* ستايل الاسم المنشن (أزرق وبدون خلفية وبدون @) */
.reply-mention-link {
    color: #2979ff;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none;
    margin-left: 4px;
    display: inline-block;
    transition: 0.2s;
}
.reply-mention-link:hover {
    text-decoration: underline;
}

/* تنسيق رأس القائمة المنبثقة (التعليق الأب) */
.parent-comment-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}
/* --- ستايل نظام الاستيكرات (إضافة جديدة) --- */

/* 1. زرار الاستيكر اللي جنب خانة الكتابة */
.sticker-trigger-btn {
    color: var(--secondary-text);
    padding: 8px;
    cursor: pointer;
    font-size: 22px; /* حجم مناسب */
    transition: 0.2s;
    margin-left: 5px; /* مسافة بينه وبين الخانة */
}
.sticker-trigger-btn:hover {
    color: var(--primary-solid);
    transform: scale(1.1);
}

/* 2. شبكة الاستيكرات داخل القائمة المنبثقة */
.stickers-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 في الصف */
    gap: 15px;
    padding: 20px;
    max-height: 350px;
    overflow-y: auto;
}

/* 3. الاستيكر الواحد جوه القائمة (للاختيار) */
.sticker-option {
    font-size: 40px;
    text-align: center;
    cursor: pointer;
    transition: transform 0.1s;
    user-select: none;
}
.sticker-option:active {
    transform: scale(0.8);
}

/* 4. شكل الاستيكر لما يتبعت في الشات (العملاق) */
.sticker-comment {
    font-size: 70px !important; /* حجم عملاق */
    line-height: 1;
    background: transparent !important; /* بدون خلفية */
    border: none !important;            /* بدون برواز */
    box-shadow: none !important;        /* بدون ضل */
    padding: 10px 0 !important;
    display: inline-block;
}

/* إلغاء تأثيرات الألوان للردود لو كانت استيكر */
.sticker-comment.colored-reply,
.sticker-comment.colored-comment {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}
    /* زرار الإغلاق (X) في القائمة */
.sheet-close-btn {
    position: absolute;
    left: 20px;
    top: 15px; /* مكان مظبوط في الزاوية */
    font-size: 24px;
    color: var(--secondary-text);
    cursor: pointer;
    z-index: 10;
    padding: 5px;
    transition: 0.2s;
}
.sheet-close-btn:hover {
    color: var(--danger-color); /* يحمر لما تقف عليه */
    transform: scale(1.1);
}

/* تجميد الخلفية بقوة */
body.no-scroll {
    overflow: hidden !important;
    position: fixed;
    width: 100%;
    left: 0;
    right: 0;
    /* ده اللي بيمنع الصفحة تتحرك يمين وشمال وقت التجميد */
}

/* --- ستايل نقطة الحالة (Online Dot) --- */
.avatar { position: relative; } /* ضروري عشان النقطة تثبت جوه الصورة */

.online-dot {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 16px;
    height: 16px;
    background-color: #34c759;
    border: 3px solid var(--card-color); /* برواز بلون الخلفية */
    border-radius: 50%;
    z-index: 10;
    display: none; /* مخفية لحد ما الشخص يفتح */
    box-shadow: 0 0 10px rgba(52, 199, 89, 0.6);
}

.online-dot.active {
    display: block; /* تظهر لما يكون أونلاين */
    animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
    0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7); }
    70% { box-shadow: 0 0 0 5px rgba(52, 199, 89, 0); }
    100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); }
}/* --- ستايل مفتاح التشغيل (Toggle Switch) --- */
.toggle-switch {
    width: 36px;
    height: 20px;
    background: #333; /* لون الخلفية وهو مطفي */
    border-radius: 20px;
    position: relative;
    transition: 0.3s ease;
    border: 1px solid var(--border-color);
}

/* لما يكون شغال */
.toggle-switch.active {
    background: var(--primary-color); /* لون التطبيق */
    border-color: var(--primary-color);
}

/* الدائرة اللي بتتحرك جوه المفتاح */
.toggle-knob {
    width: 14px;
    height: 14px;
    background: #fff;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* حركة الدائرة لما يشتغل */
.toggle-switch.active .toggle-knob {
    left: 18px; /* تتحرك لليمين */
}



    </style>
</head>
<body>

    <div id="pullIndicator" class="pull-indicator">
        <i class="fa-solid fa-rotate-right fa-spin" style="display:none"></i>
        <i class="fa-solid fa-arrow-down" id="pullIcon"></i>
        <span id="pullText">اسحب للتحديث</span>
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <div id="uraniumOrb" class="uranium-orb">
        <div id="orbMsgBubble" class="orb-msg-bubble">رسالة جديدة...</div>
        <div class="satellites-container">
   <div class="sat-btn" id="ghostBtn" onclick="toggleGhostMode()" style="transform: rotate(0deg) translate(80px) rotate(0deg);">
    <i class="fa-solid fa-ghost"></i>
</div>

    <div class="sat-btn" onclick="location.href='messages.html'" style="transform: rotate(72deg) translate(80px) rotate(-72deg);">
        <i class="fa-solid fa-comment-dots"></i>
    </div>
    
    <div class="sat-btn theme-btn" onclick="openThemeModal()" style="transform: rotate(144deg) translate(80px) rotate(-144deg);">
        <i class="fa-solid fa-palette"></i>
    </div>

    <div class="sat-btn" onclick="location.href='radar.html'" style="transform: rotate(216deg) translate(80px) rotate(-216deg);">
        <i class="fa-solid fa-satellite-dish"></i>
    </div>

    <div class="sat-btn" onclick="location.href='capsules.html'" style="transform: rotate(288deg) translate(80px) rotate(-288deg);">
        <i class="fa-solid fa-hourglass-half"></i>
    </div>
</div>


    </div>

    <div class="theme-modal-overlay" id="themeModal">
        <div class="theme-card">
            <div class="theme-title">تخصيص المظهر</div>
            <div class="theme-subtitle">اختر اللون الذي يناسب ذوقك وسيتم تطبيقه على التطبيق بالكامل</div>
            
            <div class="colors-grid">
                            <div class="colors-grid">
                <div class="color-circle" style="background: linear-gradient(135deg, #5D5FEF, #a18dff);" onclick="changeTheme('#5D5FEF')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #3fff00, #ccff00);" onclick="changeTheme('#3fff00')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #ff416c, #ff4b2b);" onclick="changeTheme('#ff416c')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #00c6ff, #0072ff);" onclick="changeTheme('#00c6ff')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #f7971e, #ffd200);" onclick="changeTheme('#f7971e')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #833ab4, #fd1d1d);" onclick="changeTheme('#fd1d1d')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #11998e, #38ef7d);" onclick="changeTheme('#11998e')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #fc00ff, #00dbde);" onclick="changeTheme('#fc00ff')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #304352, #d7d2cc);" onclick="changeTheme('#607d8b')"></div>
                
                <div class="color-circle" style="background: linear-gradient(135deg, #cb2d3e, #ef473a);" onclick="changeTheme('#ef473a')"></div>
            </div>

            </div>

            <button class="btn-theme-action btn-reset-theme" onclick="resetTheme()">استعادة الافتراضي</button>
            <button class="btn-theme-action" onclick="closeThemeModal()">إغلاق</button>
        </div>
    </div>

    <div id="deleteZone">
        <i class="fa-solid fa-xmark"></i>
    </div>

    <div class="sheet-overlay" id="overlay" onclick="closeAllSheets()"></div>
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-avatar" id="menuAvatar">U</div>
            <div id="menuName" style="font-weight:800; color:var(--text-color); font-size:18px;">مستخدم</div>
        </div>
               <div class="menu-items">
            <div class="menu-item" onclick="location.href='home.html'">
                <i class="fa-solid fa-house"></i> الرئيسية
            </div>

            <div class="menu-item" onclick="location.href='Friend_requests.html'">
                <i class="fa-solid fa-user-plus"></i> 
                طلبات الصداقة 
                <span id="requestsBadge" style="background:var(--danger-color); color:white; font-size:10px; padding:2px 8px; border-radius:10px; margin-right:auto; display:none; animation: pulse 1.5s infinite;">0</span>
            </div>

            <div class="menu-item" onclick="location.href='messages.html'"><i class="fa-solid fa-comment-dots"></i> الرسائل</div>
            <div class="menu-item" onclick="location.href='friends.html'"><i class="fa-solid fa-users"></i> الأصدقاء</div>
            
            <div class="menu-item" onclick="location.href='notifications.html'">
                <i class="fa-solid fa-bell"></i> 
                الإشعارات
                <span id="mainNotifBadge" style="background:var(--danger-color); color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-right:auto; display:none;">0</span>
            </div>
                   
             <div class="menu-item" onclick="location.href='radar.html'">
    <i class="fa-solid fa-satellite-dish"></i> الرادار المحيط
</div>
<div class="item" onclick="toggleOrbPreference()" style="flex-direction: row; justify-content: space-between; padding: 0 15px;">
    <div style="display:flex; align-items:center; gap:8px;">
        <i class="fa-solid fa-circle-nodes" style="font-size:18px;"></i> 
        <span>كرة التنقل</span>
    </div>
    <div id="orbToggleSwitch" class="toggle-switch active">
        <div class="toggle-knob"></div>
    </div>
</div>

            <div class="menu-item" onclick="location.href='settings.html'"><i class="fa-solid fa-gear"></i> الإعدادات</div>
                   <div class="menu-item" onclick="location.href='capsules.html'">
    <i class="fa-solid fa-hourglass-half"></i> كبسولة الزمن
</div>

            <div class="menu-item" onclick="openAccountSwitcher()"><i class="fa-solid fa-repeat"></i> تبديل الحساب</div>
            <div class="menu-item" style="color:var(--danger-color); margin-top:20px; border-top:1px solid var(--border-color)" onclick="openLogoutConfirm()"><i class="fa-solid fa-right-from-bracket"></i> تسجيل خروج</div>
        </div>

    </div>

    <div class="header">
        <i class="fa-solid fa-house" onclick="location.href='home.html'" style="font-size:20px; cursor:pointer; color:var(--text-color)"></i>

        
    
    <div class="header-title" id="headerTitle">الملف الشخصي</div>
    
    <i class="fa-solid fa-magnifying-glass" onclick="toggleSearchBar()" style="font-size:20px; cursor:pointer; color:var(--text-color); margin-left:15px;"></i>

   

<div id="pageSearchBar" style="display:none; padding:10px 15px; background:var(--header-bg); border-bottom:1px solid var(--border-color); position:sticky; top:60px; z-index:49;">
    <input type="text" id="localSearchInput" onkeyup="filterLocalPosts()" placeholder="ابحث في المنشورات..." style="width:100%; padding:10px 15px; border-radius:20px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); outline:none;">
</div>

        <i class="fa-solid fa-bars" onclick="openSideMenu()" style="font-size:22px; cursor:pointer; color:var(--primary-solid)"></i>
    </div>

    <div class="cover" id="profileCover">
        <button class="edit-cover-btn" id="editCoverBtn" onclick="openCoverPicker()">
            <i class="fa-solid fa-palette"></i>
        </button>
        <div class="avatar-container">
    <div class="avatar" id="avatar">
        <div class="online-dot" id="onlineIndicator"></div>
    </div>
</div>
    </div>

    <div class="info">
        <div class="name" id="name"><div class="skeleton" style="width:140px; height:25px;"></div></div>
        <div class="username" id="username"><div class="skeleton" style="width:90px; height:15px; margin-top:5px;"></div></div>
       <button id="copyBtn" onclick="copyUsername()">
    <i class="fa-solid fa-radiation fa-spin" style="font-size:14px; --fa-animation-duration: 3s;"></i> 
    ID
</button>

        <div id="quickLocation" style="text-align:center; font-size:13px; color:var(--secondary-text); margin-bottom:10px; margin-top: 5px;"></div>
        <div class="bio" id="bio"></div>
    </div>

    <div class="stats-container">
        <div class="stat-item" onclick="viewList('following')">
            <div class="stat-count" id="followingCount">0</div><div class="stat-label">يتابع</div>
        </div>
        <div class="stat-item" onclick="viewList('followers')">
            <div class="stat-count" id="followersCount">0</div><div class="stat-label">متابعين</div>
        </div>
        <div class="stat-item">
            <div class="stat-count" id="likesCount">0</div><div class="stat-label">إعجابات</div>
        </div>
    </div>

    <div class="buttons" id="buttons">
        <div class="skeleton" style="flex:2; height:48px; border-radius:16px"></div>
        <div class="skeleton" style="flex:1; height:48px; border-radius:16px"></div>
    </div>

    <div class="profile-tabs">
        <div class="tab-item active" onclick="switchTab('all')" id="tab-all">الكل</div>
        <div class="tab-item" onclick="switchTab('photos')" id="tab-photos">الصور</div>
        <div class="tab-item" onclick="switchTab('videos')" id="tab-videos">نبض</div>
        <div class="tab-item" onclick="switchTab('about')" id="tab-about">لمحة</div>
    </div>

    <div id="content-all" class="tab-content active">
        <div class="new-post-wrapper" id="createPostWrapper" style="display:none">
            <div class="np-input-trigger" onclick="location.href='create_post.html'">
                <div class="np-mini-avatar" id="myMiniAvatar"></div>
                <span>بم تفكر اليوم؟</span>
            </div>
            <div class="np-media-btn" onclick="location.href='create_media.html'"><i class="fa-solid fa-image"></i></div>
        </div>

        <div class="feed" id="feed">
            <div id="postsList"></div>
            <div id="scrollSentinel" class="loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i> جاري التحميل...</div>
            <div id="noPostsMsg" class="empty-state" style="display:none">
                <i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:10px; opacity:0.5"></i><br>لا توجد منشورات
            </div>
        </div>
    </div>

    <div id="content-photos" class="tab-content">
        <div class="photos-grid" id="photosGrid"></div>
        <div id="noPhotosMsg" class="empty-state" style="display:none">
            <i class="fa-regular fa-images" style="font-size:40px; margin-bottom:10px; opacity:0.5"></i><br>لا توجد صور
        </div>
    </div>

    <div id="content-videos" class="tab-content">
        <div class="reels-grid" id="videosGrid"></div>
        <div id="noVideosMsg" class="empty-state" style="display:none">
            <i class="fa-solid fa-video" style="font-size:40px; margin-bottom:10px; opacity:0.5"></i><br>لا توجد مقاطع ريلز
        </div>
    </div>

    <div id="content-about" class="tab-content">
        <div style="padding: 20px; background: var(--card-color); margin: 0 15px; border-radius: 18px; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 20px; font-size: 18px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">التفاصيل</h3>
            <div id="aboutDetailsList" style="display: flex; flex-direction: column; gap: 15px;"></div>
        </div>
    </div>

    <div class="bottom-sheet" id="cmSheet" style="height: 85vh;">
        <div class="sheet-handle"></div>
        <div class="cm-header">
            <span id="cmCount">التعليقات</span>
            <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px"></i>
        </div>
        <div class="cm-body" id="cmList"></div>
        <div class="cm-footer">
            
            <div class="cm-input-wrapper">
    <i class="fa-solid fa-face-laugh-beam sticker-trigger-btn" onclick="toggleStickerSheet('main')"></i>
    
    <input type="text" class="cm-input" id="cmInput" placeholder="اكتب تعليقاً..." autocomplete="off">
    <i class="fa-solid fa-paper-plane cm-send-btn" id="cmSendBtn" onclick="handleCommentAction()"></i>
</div>

        </div>
    </div>

    <div class="bottom-sheet" id="commentOptionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div class="reactions-row">
            <span class="reaction-emoji">😡</span>
            <span class="reaction-emoji">😢</span>
            <span class="reaction-emoji">😮</span>
            <span class="reaction-emoji">😂</span>
            <span class="reaction-emoji">🥰</span>
            <span class="reaction-emoji">❤️</span>
            <span class="reaction-emoji">👍</span>
        </div>
        <div id="cmOwnerOptions">
            <div class="c-option-item" onclick="triggerEditComment()">
                <i class="fa-solid fa-pen"></i> تعديل التعليق
            </div>
            <div class="c-option-item" onclick="triggerReplyComment()">
                <i class="fa-solid fa-reply"></i> رد
            </div>
            <div class="c-option-item" onclick="triggerCopyComment()">
                <i class="fa-regular fa-copy"></i> نسخ
            </div>
            <div class="c-option-item danger" onclick="triggerDeleteComment()">
                <i class="fa-solid fa-trash"></i> حذف التعليق
            </div>
        </div>
        <div id="cmViewerOptions" style="display:none">
            <div class="c-option-item" onclick="triggerReplyComment()">
                <i class="fa-solid fa-reply"></i> رد
            </div>
            <div class="c-option-item" onclick="triggerCopyComment()">
                <i class="fa-regular fa-copy"></i> نسخ
            </div>
            
            <div id="ownerDeleteBtn" class="c-option-item danger" style="display:none" onclick="triggerDeleteComment()">
                <i class="fa-solid fa-trash"></i> حذف التعليق
            </div>

            <div class="c-option-item danger" onclick="reportComment()">
                <i class="fa-solid fa-triangle-exclamation"></i> إبلاغ
            </div>
        </div>
    </div>

                      <div class="bottom-sheet" id="optionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div style="padding:10px;">
            
            <div id="privacyOptions" style="display:none; border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-bottom:10px;">
                <div style="font-size:12px; color:var(--secondary-text); padding:0 20px 10px;">من يمكنه رؤية المنشور؟</div>
                <div class="sheet-option" onclick="changePrivacy('public')">
                    <i class="fa-solid fa-earth-americas"></i> العامة
                </div>
                <div class="sheet-option" onclick="changePrivacy('friends')">
                    <i class="fa-solid fa-user-group"></i> الأصدقاء فقط
                </div>
                <div class="sheet-option" onclick="changePrivacy('private')">
                    <i class="fa-solid fa-lock"></i> أنا فقط
                </div>
            </div>

            <div id="ownerActions" style="display:none;">
                <div class="sheet-option" onclick="openEditPostModal()">
                    <i class="fa-solid fa-pen"></i> تعديل المنشور
                </div>
                <div class="sheet-option" onclick="deletePost()" style="color:var(--danger-color);">
                    <i class="fa-solid fa-trash"></i> حذف المنشور
                </div>
            </div>

            <div class="sheet-option" id="savePostOption" onclick="toggleSavePost()">
                <i class="fa-regular fa-bookmark" id="saveIcon"></i> <span id="saveText">حفظ المنشور</span>
            </div>

            <div class="sheet-option" onclick="copyPostText()">
                <i class="fa-regular fa-copy"></i> نسخ النص
            </div>
            
            <div id="reportAction" class="sheet-option" onclick="openReportModal()" style="color:var(--warning);">
                <i class="fa-solid fa-triangle-exclamation"></i> إبلاغ عن المنشور
            </div>

            <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color); margin-top:10px;" onclick="closeAllSheets()">إلغاء</div>
        </div>
    </div>



            

    <div class="bottom-sheet" id="friendshipOptionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div style="padding: 10px 0;">
            <div class="sheet-option" onclick="handleFriendOption('أخذ استراحة')" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer;">
                <i class="fa-solid fa-users-gear" style="width: 25px;"></i> أخذ استراحة
            </div>
            <div class="sheet-option" onclick="handleFriendOption('إخفاء مؤقت لمدة 30 يومًا')" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer;">
                <i class="fa-solid fa-moon" style="width: 25px;"></i> إخفاء مؤقت لمدة 30 يومًا
            </div>
            <div class="sheet-option" onclick="handleUnfollowFromSheet()" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer;">
                <i class="fa-solid fa-rectangle-xmark" style="width: 25px;"></i> إلغاء المتابعة
            </div>
            <div class="sheet-option" onclick="handleUnfriendFromSheet()" style="padding:15px 20px; display:flex; gap:15px; align-items:center; font-weight:600; cursor:pointer; color: var(--danger-color);">
                <i class="fa-solid fa-user-xmark" style="width: 25px;"></i> إلغاء الصداقة
            </div>
            <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color)" onclick="closeAllSheets()">إلغاء</div>
        </div>
    </div>

    <div class="custom-modal" id="coverPickerModal">
        <div class="modal-box" style="max-width:350px;">
            <h3 style="margin-bottom:5px; color:var(--text-color)">لون الغلاف</h3>
            <div class="color-grid" id="colorGrid"></div>
            <button class="btn btn-secondary" style="width:100%" onclick="document.getElementById('coverPickerModal').style.display='none'">إلغاء</button>
        </div>
    </div>

    <div class="custom-modal" id="logoutModal">
        <div class="modal-box">
            <h3 style="margin-bottom:10px; color:var(--text-color)">تسجيل الخروج</h3>
            <p style="color:var(--secondary-text); margin-bottom:25px; font-size:14px;">هل أنت متأكد من أنك تريد الخروج؟</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('logoutModal').style.display='none'">إلغاء</button>
                <button class="btn btn-primary" style="background:var(--danger-color); box-shadow:none" onclick="confirmLogout()">خروج</button>
            </div>
        </div>
    </div>

    <div class="custom-modal" id="accountSwitcherModal">
        <div class="modal-box" style="padding:25px 20px;">
            <h3 style="margin-bottom:15px;">تبديل الحساب</h3>
            <div class="account-list" id="accountList"></div>
            <div id="addAccountForm" class="login-inputs" style="display:none;">
                <input type="email" id="newAccEmail" placeholder="البريد الإلكتروني">
                <input type="password" id="newAccPass" placeholder="كلمة المرور">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" onclick="addNewAccountAction()">دخول</button>
                    <button class="btn btn-secondary" onclick="hideAddAccountForm()">رجوع</button>
                </div>
            </div>
            <div id="addAccBtnContainer" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                <button class="btn btn-primary" onclick="showAddAccountForm()"><i class="fa-solid fa-plus"></i> إضافة حساب</button>
                <button class="btn btn-secondary" onclick="document.getElementById('accountSwitcherModal').style.display='none'">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-check-circle" style="color:var(--success-color)"></i> <span id="toastMsg"></span></div>
    
    <div id="lightbox">
        <div onclick="document.getElementById('lightbox').style.display='none'" style="position:absolute; top:25px; right:25px; color:#fff; width:40px; height:40px; background:rgba(0,0,0,0.5); border-radius:50%; display:grid; place-items:center; cursor:pointer;"><i class="fa-solid fa-xmark"></i></div>
        <img id="lb-img" src="" style="max-width:100%; max-height:90vh; border-radius:10px;">
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
    // متغير عشان نحفظ مكاننا فين
let savedScrollPosition = 0;

// دالة التجميد الذكي (بتحفظ المكان وتثبته)
function lockScroll() {
    savedScrollPosition = window.scrollY; // 1. حفظ المكان الحالي
    document.body.style.top = `-${savedScrollPosition}px`; // 2. تثبيت الصفحة في نفس النقطة
    document.body.classList.add('no-scroll'); // 3. تجميد الحركة
}

// دالة فك التجميد (بترجعك لنفس المكان)
function unlockScroll() {
    document.body.classList.remove('no-scroll'); // 1. شيل التجميد
    document.body.style.top = ''; // 2. شيل التثبيت
    window.scrollTo(0, savedScrollPosition); // 3. رجعنا للمكان اللي كنا فيه فوراً
}

        // --- تهيئة المكتبات ---
        moment.locale('ar');
        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');

        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.appspot.com",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f",
            databaseURL: "https://pools-e4381-default-rtdb.firebaseio.com" 
};
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore(), rtdb = firebase.database();
let isGhost = false;
    // قائمة ألوان الأشباح (10 ألوان نيون)
const ghostColors = [
    "#ff0000", // أحمر (الافتراضي)
    "#00ff00", // أخضر
    "#0099ff", // أزرق سماوي
    "#ffff00", // أصفر
    "#ff00ff", // فوشيا
    "#00ffff", // سيان
    "#ff9900", // برتقالي
    "#9900ff", // بنفسجي
    "#ffffff", // أبيض
    "#00ff99"  // تركواز
];

// دالة توليد هوية الشبح (الرقم + اللون)
function getGhostIdentity(uid) {
    if (!uid) return { id: '0000', color: '#ff0000' };
    
    // تحويل الـ UID لأرقام
    let hash = 0;
    for (let i = 0; i < uid.length; i++) {
        hash = uid.charCodeAt(i) + ((hash << 5) - hash);
    }
    hash = Math.abs(hash);

    // 1. توليد رقم تعريفي (4 أرقام)
    const ghostID = (hash % 9000) + 1000; 

    // 2. اختيار لون من القائمة
    const colorIndex = hash % ghostColors.length;
    
    return { 
        id: ghostID, 
        color: ghostColors[colorIndex] 
    };
}

        let profileUid = new URLSearchParams(location.search).get("uid");
        let currentUser = null, profileData = {}, currentUserName = "مستخدم", currentUserVerified = false, currentUserPic = "";
      
        let lastVisibleDoc = null, isLoading = false, currentPostId = null, currentPostOwnerUid = null;
        let listeners = [];
        let hasPhotos = false, hasVideos = false;

        // متغيرات التعليقات المتقدمة
        let selectedComment = null; // {id, uid, text, name}
        let replyToData = null; // {id, uid, name}
        let isEditingComment = false;
        let pressTimer;
        let currentParentComment = null; // لتخزين التعليق المختار حالياً
let selectedReply = null; // عشان نخزن الرد اللي ضغطت عليه
let isEditingReply = false; // عشان نعرف إحنا بنكتب رد جديد ولا بنعدل

        const audioLibrary = {
            like: new Audio('https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3'),
            sent: new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3'),
            success: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
            click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
            tab: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3')
        };
        const globalNotifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        function playSound(type) {
            const sound = audioLibrary[type];
            if (sound) { sound.currentTime = 0; sound.volume = 0.5; sound.play().catch(e => {}); }
        }
        const coverGradients = [
            // --- تدرجات داكنة وفخمة (زي اللي في الصورة) ---
            "linear-gradient(45deg, #141414, #2b1055, #5D5FEF)", // البنفسجي الكوني (الحالي)
            "linear-gradient(to right, #0f0c29, #302b63, #24243e)", // ليل المدينة
            "linear-gradient(to right, #000000, #434343)", // أسود ملكي
            "linear-gradient(to right, #232526, #414345)", // معدني غامق

            // --- تدرجات نارية وقوية ---
            "linear-gradient(135deg, #FF9966, #FF5E62)", // الغروب البرتقالي
            "linear-gradient(to right, #f12711, #f5af19)", // لهب الذهب
            "linear-gradient(to right, #8E2DE2, #4A00E0)", // البنفسجي الساطع
            "linear-gradient(to right, #ff512f, #dd2476)", // الفوشيا الناري

            // --- تدرجات زرقاء ومائية ---
            "linear-gradient(135deg, #4facfe, #00f2fe)", // المحيط الأزرق
            "linear-gradient(to right, #00c6ff, #0072ff)", // أزرق كهربائي
            "linear-gradient(to right, #1c92d2, #f2fcfe)", // سماء صافية
            "linear-gradient(to right, #00d2ff, #3a7bd5)", // موجة زرقاء

            // --- تدرجات خضراء وطبيعية ---
            "linear-gradient(135deg, #43e97b, #38f9d7)", // النعناع المنعش
            "linear-gradient(to right, #11998e, #38ef7d)", // الغابة الخضراء
            "linear-gradient(to right, #00b09b, #96c93d)", // ليموني متدرج

            // --- تدرجات "محبشة" ومميزة ---
            "linear-gradient(to right, #FC466B, #3F5EFB)", // مزيج وردي وأزرق
            "linear-gradient(to right, #c94b4b, #4b134f)", // نبيتي غامق
            "linear-gradient(to right, #ff00cc, #333399)", // نيون ليلي
            "linear-gradient(to right, #fc00ff, #00dbde)", // حلوى مضيئة
            "linear-gradient(to right, #8360c3, #2ebf91)"  // بنفسجي على أخضر
        ];

        // --- المراقب ---
        // --- المراقب (المعدل) ---
const videoObserver = new IntersectionObserver((entries) => {
    // التحقق: هل فيه قائمة مفتوحة حالياً؟
    const isSheetOpen = document.getElementById('overlay').style.display === 'block';

    entries.forEach(entry => {
        // لو فيه قائمة مفتوحة، وقف الفيديو فوراً ومتركزش معاه
        if (isSheetOpen) {
            entry.target.pause();
            return;
        }

        // الطبيعي: شغل لو ظاهر، وقف لو اختفى
        if (entry.isIntersecting && entry.intersectionRatio >= 0.7) {
            entry.target.play().catch(()=>{});
        } else {
            entry.target.pause();
        }
    });
}, { threshold: 0.7 });


        const scrollObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoading) loadPosts(true);
        }, { threshold: 0.1 });

        // --- البدء ---
        auth.onAuthStateChanged(async user => {
            if (!user) { location.href = "index.html"; return; }
            checkGhostStatus();
                        // --- بداية كود حالة الاتصال ---
            
            const myStatusRef = rtdb.ref('/status/' + user.uid);
            const isOffline = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP };
            const isOnline = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP };

            rtdb.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === false) return;
                
                // لما تفصل، حول الحالة أوفلاين
                myStatusRef.onDisconnect().set(isOffline).then(() => {
                    // طول ما أنت متصل، خلي الحالة أونلاين
                    myStatusRef.set(isOnline);
                            // السطر ده هيخلي النقطة تنور عندك أنت شخصياً فوراً
        if(profileUid === user.uid) document.getElementById('onlineIndicator').classList.add('active');

                });
            });
            // --- نهاية كود حالة الاتصال ---

            currentUser = user;
            if (!profileUid) profileUid = user.uid;
            
            listeners.forEach(unsub => unsub()); listeners = [];
            
            const myDoc = await db.collection("users").doc(currentUser.uid).get();
            if(myDoc.exists) {
                const md = myDoc.data();
                currentUserName = md.name || "مستخدم";
currentUserVerified = md.isVerified || false;
currentUserPic = md.profilePic || ""; // <-- ده السطر الجديد اللي هيحفظ صورتك

                
                const menuBadge = currentUserVerified ? 
                    '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:5px; font-size:16px;"></i>' : '';
                
                document.getElementById('menuName').innerHTML = currentUserName + " " + menuBadge;
                document.getElementById('menuName').style.display = "flex";
                document.getElementById('menuName').style.justifyContent = "center";
                document.getElementById('menuName').style.alignItems = "center";
                document.getElementById('menuName').style.gap = "5px";

                if(md.profilePic) {
                    document.getElementById('menuAvatar').style.backgroundImage = `url('${md.profilePic}')`;
                    document.getElementById('menuAvatar').innerText = "";
                }
            }

            updateRequestsBadge();
            updateMainNotifBadge();
            await loadProfile();
            loadPosts();
            
            const sentinel = document.getElementById('scrollSentinel');
            if(sentinel) scrollObserver.observe(sentinel);

            db.collection('notifications').where('recipientId', '==', currentUser.uid).where('read', '==', false)
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && (Date.now() - (change.doc.data().createdAt?.toDate().getTime() || Date.now())) < 10000) {
                        globalNotifSound.play().catch(e => {});
                        showToast("🔔 إشعار جديد");
                    }
                });
            });
        });

        // --- الدوال الرئيسية ---
        async function loadProfile() {
            try {
                const doc = await db.collection("users").doc(profileUid).get();
                if (!doc.exists) return;
                profileData = doc.data();

                const d = profileData;
                const disp = d.name || d.email.split("@")[0];
                const badge = d.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#34c759;margin-right:5px;font-size:16px;"></i>' : '';
                
                document.getElementById('headerTitle').innerText = disp;
                document.getElementById('name').innerHTML = disp + badge;
                document.getElementById('username').innerText = d.username ? "@" + d.username : "";
                document.getElementById('bio').innerText = d.bio || "";
                document.getElementById('copyBtn').style.display = 'inline-block';
                
                if(d.location) {
                    document.getElementById('quickLocation').innerHTML = `<i class="fa-solid fa-location-dot"></i> يقيم في ${d.location}`;
                }

                const aboutList = document.getElementById('aboutDetailsList');
                if(aboutList) {
                    aboutList.innerHTML = ""; 
                    const fields = [
                        { icon: 'fa-briefcase', text: d.work, prefix: 'يعمل لدى ' },
                        { icon: 'fa-graduation-cap', text: d.education, prefix: 'درس في ' },
                        { icon: 'fa-house-chimney', text: d.location, prefix: 'يقيم في ' },
                        { icon: 'fa-link', text: d.website, isLink: true }
                    ];

                    fields.forEach(item => {
                        if (item.text) {
                            const div = document.createElement('div');
                            div.className = 'about-item';
                            div.innerHTML = `<i class="fa-solid ${item.icon}"></i> <span>${item.prefix || ''} ${item.text}</span>`;
                            aboutList.appendChild(div);
                        }
                    });
                    
                    if(aboutList.innerHTML === "") {
                        aboutList.innerHTML = "<div style='color:var(--secondary-text); text-align:center;'>لا توجد تفاصيل لعرضها</div>";
                    }
                }

                if (d.coverGradient) document.getElementById('profileCover').style.background = d.coverGradient;

                const av = document.getElementById('avatar');
                if(d.profilePic) {
                    av.style.backgroundImage = `url('${d.profilePic}')`; av.innerText = "";
                } else {
                    av.innerText = disp[0].toUpperCase(); av.style.backgroundColor = generateColor(profileUid); av.style.backgroundImage = "none";
                }

                // --- تعديل: دمج المتابعين الحقيقيين مع الوهميين ---
listeners.push(db.collection("users").doc(profileUid).collection("followers").onSnapshot(s => {
    // 1. العدد الحقيقي (من الداتابيز)
    const realCount = s.size;
    
    // 2. العدد الوهمي (من بيانات المستخدم المحفوظة)
    // لو مفيش رقم وهمي بنحسبه صفر
    const fakeCount = profileData.fakeFollowersCount || 0; 
    
    // 3. الجمع والعرض (بنستخدم دالة التنسيق عشان تطلع 1K لو الرقم كبير)
    const total = realCount + fakeCount;
    document.getElementById('followersCount').innerText = formatNumber(total);
}));
                listeners.push(db.collection("users").doc(profileUid).collection("following").onSnapshot(s => document.getElementById('followingCount').innerText = s.size));
                listeners.push(db.collection("posts").where("uid", "==", profileUid).onSnapshot(snap => {
                    let totalLikes = 0;
                    snap.forEach(doc => { totalLikes += Object.keys(doc.data().likes || {}).length; });
                    document.getElementById('likesCount').innerText = totalLikes;
                }));

                if(profileUid === currentUser.uid) {
                    document.getElementById('editCoverBtn').style.display = 'flex';
                    document.getElementById('createPostWrapper').style.display = 'flex';
                    const myMini = document.getElementById('myMiniAvatar');
                    if(profileData.profilePic) myMini.style.backgroundImage = `url('${profileData.profilePic}')`;
                    else myMini.style.backgroundColor = generateColor(currentUser.uid);
                    setupButtons(false, false, false, false, true);
                } else {
                    checkRelationship();
                }

            } catch(e) { console.error(e); }
                        // ============ بداية كود مراقبة الحالة ============
            if (profileUid) {
                // بنراقب مسار الحالة بتاع الشخص ده في الداتابيز
                rtdb.ref('/status/' + profileUid).on('value', (snapshot) => {
                    const status = snapshot.val(); // بنجيب القيمة (أونلاين ولا أوفلاين)
                    const dot = document.getElementById('onlineIndicator'); // بنمسك عنصر النقطة
                    
                    if (dot) {
                        // لو الحالة أونلاين، ضيف كلاس active (يخليها خضراء وبتنور)
                        if (status && status.state === 'online') {
                            dot.classList.add('active');
                        } else {
                            // غير كده شيل الكلاس (تختفي)
                            dot.classList.remove('active');
                        }
                    }
                });
            }
            // ============ نهاية الكود ============

        }

        function openCoverPicker() {
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = "";
            coverGradients.forEach(grad => {
                const div = document.createElement('div');
                div.className = 'color-swatch';
                div.style.background = grad; // تكملة السطر اللي كان مقطوع
                div.onclick = () => saveCover(grad);
                grid.appendChild(div);
            });
            document.getElementById('coverPickerModal').style.display = 'flex';
        }

        async function saveCover(gradient) {
            playSound('click');
            document.getElementById('profileCover').style.background = gradient;
            document.getElementById('coverPickerModal').style.display = 'none';
            try {
                await db.collection("users").doc(currentUser.uid).update({ coverGradient: gradient });
                showToast("تم تحديث لون الغلاف");
            } catch(e) { showToast("حدث خطأ"); }
        }

        function switchTab(tabName) {
            playSound('tab');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.add('active');
        }

        async function loadPosts(more = false) {
            if(isLoading) return; isLoading = true;
            let q = db.collection("posts").where("uid", "==", profileUid).orderBy("createdAt", "desc").limit(8);
            if(more && lastVisibleDoc) q = q.startAfter(lastVisibleDoc);

            try {
                const snap = await q.get();
                if(snap.empty) {
                    document.getElementById('scrollSentinel').style.display = 'none';
                    if(!more) {
                        const list = document.getElementById('postsList');
                        if(!list.hasChildNodes()) document.getElementById('noPostsMsg').style.display='block';
                        if(!hasPhotos) document.getElementById('noPhotosMsg').style.display='block';
                        if(!hasVideos) document.getElementById('noVideosMsg').style.display='block';
                    }
                    isLoading = false;
                    return;
                }

                lastVisibleDoc = snap.docs[snap.docs.length-1];
                
                for(const doc of snap.docs) {
                    const data = {id: doc.id, ...doc.data()};
                    renderPost(data);
                    distributeMedia(data);
                }
            } catch (e) { console.log(e); document.getElementById('scrollSentinel').style.display='none'; }
            isLoading = false;
        }

        function distributeMedia(post) {
            if(post.media && post.media.length > 0) {
                post.media.forEach(m => {
                    if(m.type === 'video') {
                        addToVideoGrid(m.url, post.text || 'فيديو جديد', post.views || 0, post.id);
                        hasVideos = true;
                        document.getElementById('noVideosMsg').style.display='none';
                    } else {
                        addToPhotoGrid(m.url);
                        hasPhotos = true;
                        document.getElementById('noPhotosMsg').style.display='none';
                    }
                });
            } else if(post.imageUrl) {
                addToPhotoGrid(post.imageUrl);
                hasPhotos = true;
                document.getElementById('noPhotosMsg').style.display='none';
            }
        }

        function addToPhotoGrid(url) {
            const div = document.createElement('div');
            div.innerHTML = `<img src="${url}" class="photo-item" loading="lazy" onclick="openLightbox('${url}')">`;
            document.getElementById('photosGrid').appendChild(div);
        }

        function addToVideoGrid(url, title, viewsCount, postId) {
            const views = formatNumber(viewsCount);
            const div = document.createElement('div');
            div.className = 'reel-item';
            div.onclick = () => location.href = `videos.html?src=${encodeURIComponent(url)}&id=${postId}`;
            div.innerHTML = `
                <video src="${url}" class="reel-thumb" muted preload="metadata"></video>
                <div class="reel-icon"><i class="fa-solid fa-play"></i></div>
                <div class="reel-overlay">
                    <div class="reel-title">${title}</div>
                    <div class="reel-stats"><i class="fa-regular fa-eye"></i> ${views}</div>
                </div>
            `;
            document.getElementById('videosGrid').appendChild(div);
        }

                    /* ========================================= */
    /* دالة عرض المنشورات (تم إصلاح رابط الفيديو) */
    /* ========================================= */
    function renderPost(p) {
        const isLiked = p.likes && p.likes[currentUser.uid];
        
        // تحديد أيقونة الخصوصية
        let privacyIcon = '<i class="fa-solid fa-earth-americas" title="العامة"></i>';
        if(p.visibility === 'friends') privacyIcon = '<i class="fa-solid fa-user-group" title="الأصدقاء"></i>';
        if(p.visibility === 'private') privacyIcon = '<i class="fa-solid fa-lock" title="أنا فقط"></i>';

        let mediaHtml = "";
        
        // التحقق من وجود وسائط
        if(p.media && p.media.length) {
            // تحديد كلاس الشبكة (فردي ولا زوجي)
            const gridClass = p.media.length > 1 ? 'double' : 'single';
            mediaHtml = `<div class="media-grid ${gridClass}">`;
            
            // التعديل هنا: ضيفنا (idx) عشان نعرف ترتيب الفيديو
            p.media.forEach((m, idx) => {
                if(m.type === 'video') {
                    // إنشاء معرف فريد للفيديو
                    const uniqueVideoId = `vid-${p.id}-${idx}`;
                    
                    // رابط الفيديو: ضيفنا index عشان يحدد الفيديو بالظبط
                    // وضيفنا post عشان لو الصفحة بتستخدم الاسم ده
                    const videoLink = `videos.html?id=${p.id}&post=${p.id}&index=${idx}&src=${encodeURIComponent(m.url)}`;

                    mediaHtml += `
                    <div style="position:relative; overflow:hidden; border-radius:4px;">
                        <video 
                            src="${m.url}" 
                            id="${uniqueVideoId}" 
                            class="media-item" 
                            loop 
                            playsinline 
                            muted 
                            loading="lazy" 
                            onplay="incrementViewCount('${p.id}'); startLiveViews('${p.id}')" 
                            onpause="stopLiveViews()"
                            onclick="location.href='${videoLink}'"
                        ></video>
                        
                        <div style="position:absolute; bottom:10px; left:10px; color:#fff; font-size:12px; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px; pointer-events:none; display:flex; align-items:center; gap:4px; z-index:5;">
                            <i class="fa-regular fa-eye"></i> <span id="vid-views-${p.id}">${formatNumber(p.views || 0)}</span>
                        </div>

                        <div class="video-mute-btn" onclick="toggleMute(event, '${uniqueVideoId}', this)">
                            <i class="fa-solid fa-volume-xmark"></i>
                        </div>
                    </div>`;
                
                } else {
                    // لو صورة
                    mediaHtml += `<img src="${m.url}" class="media-item" loading="lazy" onclick="openLightbox('${m.url}')">`;
                }
            });
            mediaHtml += `</div>`;
        } 
        else if(p.imageUrl) {
            mediaHtml = `<div class="media-grid single"><img src="${p.imageUrl}" class="media-item" loading="lazy" onclick="openLightbox('${p.imageUrl}')"></div>`;
        } 
        else if(p.background) {
            mediaHtml = `<div class="post-text has-bg" style="background:${p.background}">${p.text}</div>`;
            p.text = ""; 
        }

        const div = document.createElement('div');
        div.className = 'post';
        div.id = `post-${p.id}`;
        div.innerHTML = `
            <div class="post-header">
                <div class="user-info" onclick="location.href='profile.html?uid=${p.uid}'" style="cursor:pointer;">
                    <div class="post-avatar" style="${profileData.profilePic?`background-image:url('${profileData.profilePic}')`: `background-color:${generateColor(p.uid)}`}">${profileData.profilePic?'':(profileData.name||'U')[0]}</div>
                    <div class="user-details">
                        <h4>${profileData.name || 'مستخدم'} ${profileData.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0;font-size:14px;"></i>' : ''}</h4>
                        <span>${p.createdAt ? moment(p.createdAt.toDate()).fromNow() : 'الآن'} &bull; <span style="font-size:10px; margin-right:3px;">${privacyIcon}</span></span>
                    </div>
                </div>
                <i class="fa-solid fa-ellipsis" onclick="openOptions('${p.id}', '${p.uid}', \`${p.text || ''}\`, '${profileData.name || 'مستخدم'}')" style="cursor:pointer; padding:5px; color:var(--secondary-text)"></i>
            </div>
            ${p.text ? `<div class="post-text">${p.text}</div>` : ''}
            ${mediaHtml}
            <div class="post-actions">
                <div class="action-btn ${isLiked?'liked':''}" id="like-${p.id}" onclick="toggleLike('${p.id}', '${p.uid}')">
                    <i class="${isLiked?'fa-solid':'fa-regular'} fa-heart"></i> <span id="cnt-${p.id}">${Object.keys(p.likes||{}).length}</span>
                </div>
                
                <div class="action-btn" onclick="openComments('${p.id}', '${p.uid}')">
                    <i class="fa-regular fa-comment"></i> <span>${Math.max(0, p.commentsCount || 0)}</span>
                </div>

                <div class="action-btn" onclick="sharePost('${p.id}')">
                    <i class="fa-solid fa-share-nodes"></i>
                </div>
            </div>
        `;

        // كود الوصول للمنشور (Deep Linking)
        // كود الوصول للمنشور والتعليق (Deep Linking)
const urlParams = new URLSearchParams(window.location.search);
const targetPostId = urlParams.get('post');
const targetCommentId = urlParams.get('comment');

if (targetPostId) {
    setTimeout(() => {
        const element = document.getElementById(`post-${targetPostId}`);
        if (element) {
            // 1. التوجه للمنشور
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            element.style.border = "2px solid var(--primary-solid)";
            element.style.boxShadow = "0 0 20px var(--primary-solid)";
            
            // 2. إذا كان هناك تعليق محدد، افتح قائمة التعليقات
            if (targetCommentId) {
                // جلب بيانات صاحب المنشور لفتح التعليقات (يمكنك تعديل ownerUid حسب كودك)
                const postData = document.querySelector(`#post-${targetPostId} .user-info`).getAttribute('onclick');
                // استخلاص الـ UID من النص (مثال: location.href='profile.html?uid=XXX')
                const ownerUid = postData.match(/uid=([^']+)/)[1];
                
                openComments(targetPostId, ownerUid);
                
                // 3. تمييز التعليق داخل القائمة بعد تحميلها
                setTimeout(() => {
                    const commentEl = document.getElementById(`comment-${targetCommentId}`);
                    if (commentEl) {
                        commentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        commentEl.querySelector('.cm-bubble').classList.add('highlight');
                    }
                }, 1000);
            }
        }
    }, 1500); 
}

        document.getElementById('postsList').appendChild(div);
        
        // تشغيل المراقب للفيديوهات
        div.querySelectorAll('video').forEach(v => videoObserver.observe(v));
    }

    
        function checkRelationship() {
            Promise.all([
                db.collection("users").doc(currentUser.uid).collection("friends").doc(profileUid).get(),
                db.collection("users").doc(currentUser.uid).collection("following").doc(profileUid).get(),
                db.collection("users").doc(profileUid).collection("friendRequests").doc(currentUser.uid).get(),
                db.collection("users").doc(currentUser.uid).collection("friendRequests").doc(profileUid).get()
            ]).then(([fr, fol, sent, rec]) => {
                setupButtons(fr.exists, fol.exists, sent.exists, rec.exists, false);
            });
        }

        // ==========================================
// دالة أزرار البروفايل (تم إصلاح زر الثلاث نقط)
// ==========================================
function setupButtons(isFriend, isFollowing, sent, rec, isMine) {
    const container = document.getElementById('buttons');
    container.innerHTML = "";

    // 1. زر الثلاث نقط (موجود في الحالتين)
    const optionsBtn = `<button class="btn btn-secondary" onclick="showMoreOptions()" style="flex:0 0 48px; width:48px;"><i class="fa-solid fa-ellipsis"></i></button>`;

    // 2. لو ده بروفايلي أنا
    if(isMine) {
        container.innerHTML = `
            <button class="btn btn-primary" onclick="location.href='edit.html'"><i class="fa-solid fa-pen-to-square"></i> تعديل الملف الشخصي</button>
            ${optionsBtn}
        `;
        return;
    }

    // 3. لو بروفايل شخص تاني (نجهز باقي الأزرار)
    let friendBtn = '';
    if(isFriend) friendBtn = `<button class="btn btn-secondary" onclick="openFriendshipSheet()"><i class="fa-solid fa-user-check"></i> صديق</button>`;
    else if(rec) friendBtn = `<button class="btn btn-primary" style="background:var(--success-color)" onclick="acceptRequest()"><i class="fa-solid fa-check"></i> قبول</button>`;
    else if(sent) friendBtn = `<button class="btn btn-secondary" onclick="cancelRequest()"><i class="fa-solid fa-hourglass"></i> مُعلق</button>`;
    else friendBtn = `<button class="btn btn-primary" onclick="sendRequest()"><i class="fa-solid fa-user-plus"></i> إضافة صديق</button>`;

    let followBtn = isFollowing 
        ? `<button class="btn btn-secondary" onclick="unfollowUser()" style="color:var(--primary-solid); border-color:var(--primary-solid)">مُتابع</button>`
        : `<button class="btn btn-secondary" onclick="followUser()">متابعة</button>`;
    
    let chatBtn = `<button class="btn btn-chat" onclick="startChat()"><i class="fa-solid fa-comment-dots"></i></button>`;
    
    // 🔥 هنا التعديل: ضفنا optionsBtn في الآخر عشان يظهر
    container.innerHTML = friendBtn + followBtn + chatBtn + optionsBtn;
}


        function pushNotification(recipientId, type, text, link) {
    if (!recipientId || recipientId === currentUser.uid) return;
    
    db.collection("notifications").add({
        recipientId: recipientId, 
        senderUid: currentUser.uid, 
        senderName: currentUserName, 
        senderPic: currentUserPic || "",
        isVerified: currentUserVerified, // 🔥 إضافة التوثيق هنا
        type: type, 
        text: text, 
        link: link, 
        read: false, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}


        function openFriendshipSheet() { playSound('click'); document.getElementById('overlay').style.display = 'block'; document.getElementById('friendshipOptionsSheet').classList.add('active'); }
        function handleFriendOption(optionName) { playSound('success'); showToast("تم تفعيل: " + optionName); closeAllSheets(); }
        async function handleUnfollowFromSheet() { await unfollowUser(); showToast("تم إلغاء المتابعة بنجاح"); closeAllSheets(); }
        
        // ==========================================
// دالة إلغاء الصداقة (بالشكل الجديد)
// ==========================================
async function handleUnfriendFromSheet() {
    // إغلاق القائمة السفلية أولاً
    closeAllSheets();

    // استدعاء الرسالة الشيك بدل (confirm) العادية
    showChicConfirm(
        "إنهاء الصداقة؟",
        "هل أنت متأكد من أنك تريد إزالة هذا الشخص من قائمة الأصدقاء؟",
        '<i class="fa-solid fa-user-xmark" style="color:var(--danger-color)"></i>', // الأيقونة
        async function() {
            // هنا الكود اللي بيتنفذ لما يضغط "تأكيد"
            try {
                const b = db.batch();
                b.delete(db.collection("users").doc(currentUser.uid).collection("friends").doc(profileUid));
                b.delete(db.collection("users").doc(profileUid).collection("friends").doc(currentUser.uid));
                
                await b.commit();
                
                playSound('click'); 
                showToast("تم إلغاء الصداقة بنجاح 💔"); 
                checkRelationship(); // تحديث الأزرار
                
                // تسجيل النشاط في السجل
                logActivity('delete', `قمت بإلغاء صداقة ${document.getElementById('name').innerText}`, null, profileUid);
                
            } catch(e) {
                console.error(e);
                showToast("حدث خطأ ما");
            }
        }
    );
}


        // ==========================================
// إصلاح دالة إرسال طلب الصداقة (Send Request)
// ==========================================
async function sendRequest() { 
    // تأمين المتغيرات عشان لو فاضية الكود ما يضربش
    const safePic = (typeof currentUserPic !== 'undefined' && currentUserPic) ? currentUserPic : "";
    const safeVerified = (typeof currentUserVerified !== 'undefined') ? currentUserVerified : false;

    playSound('success'); 
    
    try {
        const b = db.batch();
        
        // 1. إنشاء مستند طلب الصداقة
        const requestRef = db.collection("users").doc(profileUid)
                             .collection("friendRequests").doc(currentUser.uid);
                             
        b.set(requestRef, {
            senderUid: currentUser.uid, 
            name: currentUserName, 
            pic: safePic, 
            isVerified: safeVerified, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. إنشاء مستند الإشعار
        const notifRef = db.collection("notifications").doc();
        
        b.set(notifRef, {
            recipientId: profileUid, 
            senderUid: currentUser.uid, 
            senderName: currentUserName, 
            senderPic: safePic,        // الصورة المؤمنة
            isVerified: safeVerified,  // التوثيق المؤمن
            type: "friend_request", 
            text: "أرسل لك طلب صداقة", 
            read: false, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
            link: `profile.html?uid=${currentUser.uid}`
        });

        // تنفيذ الأمر
        await b.commit(); 
        
        showToast("تم إرسال الطلب ✅"); 
        checkRelationship(); // تحديث شكل الزرار

    } catch (error) {
        console.error("فشل إرسال الطلب:", error);
        showToast("حدث خطأ، حاول مرة أخرى");
    }
}


        
        async function cancelRequest() { 
            playSound('click'); await db.collection("users").doc(profileUid).collection("friendRequests").doc(currentUser.uid).delete(); 
            showToast("تم الإلغاء"); checkRelationship(); 
        }
        
        // ==========================================
// إصلاح دالة قبول الصداقة (Accept Request)
// ==========================================
async function acceptRequest() { 
    const safePic = (typeof currentUserPic !== 'undefined' && currentUserPic) ? currentUserPic : "";
    const safeVerified = (typeof currentUserVerified !== 'undefined') ? currentUserVerified : false;

    playSound('success'); 
    
    try {
        const b = db.batch(); 
        
        // تسجيل الصداقة عند الطرفين
        b.set(db.collection("users").doc(currentUser.uid).collection("friends").doc(profileUid), {since: firebase.firestore.FieldValue.serverTimestamp()}); 
        b.set(db.collection("users").doc(profileUid).collection("friends").doc(currentUser.uid), {since: firebase.firestore.FieldValue.serverTimestamp()}); 
        
        // حذف طلب الصداقة
        b.delete(db.collection("users").doc(currentUser.uid).collection("friendRequests").doc(profileUid)); 
        
        // إرسال إشعار القبول
        const notifRef = db.collection("notifications").doc();
        b.set(notifRef, {
            recipientId: profileUid, 
            senderUid: currentUser.uid, 
            senderName: currentUserName, 
            senderPic: safePic,       // الصورة
            isVerified: safeVerified, // التوثيق
            type: "friend_accept", 
            text: "وافق على طلب صداقتك", 
            read: false, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
            link: `profile.html?uid=${currentUser.uid}`
        });

        await b.commit(); 
        showToast("أصبحتما صديقين 🤝"); 
        checkRelationship(); 

    } catch (error) {
        console.error("فشل قبول الطلب:", error);
        showToast("حدث خطأ");
    }
}


        
        async function followUser() { 
            playSound('click'); const b = db.batch(); 
            b.set(db.collection("users").doc(currentUser.uid).collection("following").doc(profileUid), {at: firebase.firestore.FieldValue.serverTimestamp()}); 
            b.set(db.collection("users").doc(profileUid).collection("followers").doc(currentUser.uid), {at: firebase.firestore.FieldValue.serverTimestamp()}); 
            const notifRef = db.collection("notifications").doc();
            b.set(notifRef, {
                recipientId: profileUid, senderUid: currentUser.uid, senderName: currentUserName, senderPic: currentUser.photoURL||"",
                type: "follow", text: "بدأ بمتابعتك", read: false, createdAt: firebase.firestore.FieldValue.serverTimestamp(), link: `profile.html?uid=${currentUser.uid}`
            });
            await b.commit(); showToast("تمت المتابعة"); checkRelationship(); 
        }
        
        async function unfollowUser() { 
            playSound('click'); const b = db.batch(); 
            b.delete(db.collection("users").doc(currentUser.uid).collection("following").doc(profileUid)); 
            b.delete(db.collection("users").doc(profileUid).collection("followers").doc(currentUser.uid)); 
            await b.commit(); 
        }
        
        function startChat() { 
            playSound('click'); const cid = [currentUser.uid, profileUid].sort().join("_"); 
            db.collection("chats").doc(cid).set({users:[currentUser.uid, profileUid], lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true}).then(()=> location.href=`chat.html?chatId=${cid}&uid=${profileUid}`); 
        }
        
        async function toggleLike(pid, postOwnerUid) {
            const btn = document.getElementById(`like-${pid}`);
            const cnt = document.getElementById(`cnt-${pid}`);
            const isAddingLike = !btn.classList.contains('liked');
            const isLiked = btn.classList.toggle('liked');
            
            if(isLiked) playSound('like'); else playSound('click');
            btn.querySelector('i').className = isLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
            cnt.innerText = isLiked ? parseInt(cnt.innerText)+1 : parseInt(cnt.innerText)-1;
// ضيف ده جوه شرط الـ Like
logActivity('like', 'أعجبت بمنشور', pid, postOwnerUid);


            if (isAddingLike) pushNotification(postOwnerUid, 'like', 'أعجب بمنشورك', `profile.html?uid=${postOwnerUid}#post-${pid}`);

            const ref = db.collection("posts").doc(pid);
            await db.runTransaction(async t => {
                const doc = await t.get(ref); let l = doc.data().likes || {};
                if(l[currentUser.uid]) delete l[currentUser.uid]; else l[currentUser.uid] = true;
                t.update(ref, {likes: l});
            });
        }

        // --- نظام التعليقات الأساسي --               
   function openComments(pid, ownerUid) {
    lockScroll();
    document.body.classList.add('no-scroll');
    document.querySelectorAll('video').forEach(v => v.pause());

    playSound('click'); 
    currentPostId = pid; 
    currentPostOwnerUid = ownerUid;

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('cmSheet').classList.add('active');
    
    setupMentionListener('cmInput', 'mentionDropdown');

    const list = document.getElementById('cmList');
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa"><i class="fa-solid fa-circle-notch fa-spin"></i> جاري التحميل...</div>';
    
    resetCommentInput();

    if(window.commentsUnsub) window.commentsUnsub();

    window.commentsUnsub = db.collection("posts").doc(pid).collection("comments")
        .onSnapshot(snap => {
            list.innerHTML = ""; 
            document.getElementById('cmCount').innerText = `التعليقات (${snap.size})`;
            
            if(snap.empty) {
                list.innerHTML = '<div style="text-align:center; color:#777; margin-top:20px">كن أول من يعلق!</div>';
                return;
            }
            
            let commentsData = [];
            snap.forEach(doc => {
                let d = doc.data(); d.id = doc.id;
                d.sortTime = d.createdAt ? d.createdAt.toDate().getTime() : Date.now();
                commentsData.push(d);
            });
            commentsData.sort((a, b) => a.sortTime - b.sortTime);

            commentsData.forEach(c => {
                try {
                    // --- 1. منطق القناع للتعليقات (The Colored Ghost Mask) ---
                    let displayName = c.name || 'مستخدم';
                    let displayPic = c.pic;
                    let verifiedDisplay = c.isVerified;
                    let clickAction = `location.href='profile.html?uid=${c.uid}'`;
                    let avatarContent = displayPic ? '' : (displayName[0]);
                    let avatarStyle = "";
                    let nameColorStyle = ""; // لتلوين الاسم

                    // >> لو التعليق شبح
                    if (c.isGhost) {
                        const ghostIdentity = getGhostIdentity(c.uid);
                        
                        displayName = `مستخدم نبض #${ghostIdentity.id}`;
                        displayPic = "";
                        verifiedDisplay = false;
                        
                        // الأيقونة الملونة
                        avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:18px;"></i>`;
                        
                        // البرواز الملون
                        avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 5px ${ghostIdentity.color}40;`;
                        
                        // تلوين الاسم
                        nameColorStyle = `color: ${ghostIdentity.color} !important; text-shadow: 0 0 5px ${ghostIdentity.color}40;`;
                        
                        clickAction = "showToast('⛔ هوية محمية')";
                    } else {
                        // >> الوضع الطبيعي
                        let finalPic = c.pic;
                        if (currentUser && c.uid === currentUser.uid && !finalPic) finalPic = currentUserPic;
                        else if (typeof profileData !== 'undefined' && c.uid === profileUid && !finalPic) finalPic = profileData.profilePic;
                        
                        avatarStyle = finalPic ? 
                            `background: url('${finalPic}') center/cover no-repeat; border: 1px solid var(--border-color);` : 
                            `background: ${generateColor(c.uid || 'user')}; border: 1px solid var(--border-color); display:grid; place-items:center;`;
                        
                        if (finalPic) avatarContent = '';
                    }
                    // ----------------------------------------------------

                    // ألوان الفقاعة
                    let hash = 0;
                    if(c.uid) { for (let i = 0; i < c.uid.length; i++) hash = c.uid.charCodeAt(i) + ((hash << 5) - hash); }
                    const colorIndex = Math.abs(hash) % 10;
                    const colorClass = `color-${colorIndex}`;

                    const isPostOwner = (c.uid === currentPostOwnerUid);
                    let bubbleClass = `cm-bubble colored-comment ${colorClass}`;
                    if (isPostOwner) bubbleClass += ' owner-bubble';
                    if (c.isSticker) bubbleClass += " sticker-comment";

                    let textClass = c.isSticker ? "" : "cm-text";

                    // معالجة المنشن
                    let displayContent = c.text || "";
                    if (!c.isSticker && c.replyToUid && c.replyToName && displayContent.startsWith(c.replyToName)) {
                        const cleanText = displayContent.substring(c.replyToName.length);
                        const mentionBadge = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${c.replyToUid}'">${c.replyToName}</span>`;
                        displayContent = `${mentionBadge} <span style="color:inherit">${cleanText}</span>`;
                    }

                    let timeString = c.createdAt ? moment(c.createdAt.toDate()).fromNow() : 'الآن';
                    const verifiedIcon = (!c.isGhost && verifiedDisplay) ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:4px; font-size:12px; display:inline-block; vertical-align:middle;"></i>' : '';

                    const el = document.createElement('div');
                    el.className = 'comment-item';
                    el.id = `comment-${c.id}`;
                    
                    el.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openCommentOptions(c), 600); });
                    el.addEventListener('touchend', () => clearTimeout(pressTimer));
                    el.addEventListener('touchmove', () => clearTimeout(pressTimer));
                    el.style.cursor = "pointer";
                    
                    el.onclick = (e) => { 
                        if (!e.target.classList.contains('cm-action') && !e.target.classList.contains('reply-mention-link')) {
                            openRepliesSheet(c); 
                        }
                    };

                    el.innerHTML = `
                        <div class="cm-avatar" style="${avatarStyle}" onclick="${clickAction}">${avatarContent}</div>
                        <div class="cm-content">
                            <div class="${bubbleClass}"> 
                                <div class="cm-user-row">
                                    <span class="cm-username" onclick="${clickAction}" style="cursor:pointer; ${nameColorStyle}">
                                        ${displayName} 
                                        ${isPostOwner && !c.isGhost ? '<span class="owner-badge">مؤلف</span>' : ''} 
                                    </span>
                                    ${verifiedIcon}
                                </div>
                                <div class="${textClass}">${displayContent}</div>
                            </div>
                            <div class="cm-meta-row">
                                <span>${timeString}</span>
                                <span class="cm-action" onclick="prepareReply('${c.id}', '${c.uid}', '${displayName}')">رد</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                } catch (err) { console.error(err); }
            });
            setTimeout(() => list.scrollTop = list.scrollHeight, 100);
        });
    listeners.push(window.commentsUnsub);

                   }
    
                function openCommentOptions(commentData) {
            playSound('tab');
            selectedComment = commentData;
            if(navigator.vibrate) navigator.vibrate(50);
            
            // تمييز التعليق المختار
            document.querySelectorAll('.cm-bubble').forEach(b => b.classList.remove('highlight'));
            const bubble = document.getElementById(`comment-${commentData.id}`).querySelector('.cm-bubble');
            if(bubble) bubble.classList.add('highlight');

            // المتغيرات للتحقق
            const isMyComment = (commentData.uid === currentUser.uid);
            const isMyPost = (currentPostOwnerUid === currentUser.uid); // هل أنا صاحب المنشور؟

            // إظهار القوائم بناءً على الحالة
            if (isMyComment) {
                // لو تعليقي أنا: أظهر قائمة التحكم الكاملة (تعديل وحذف)
                document.getElementById('cmOwnerOptions').style.display = 'block';
                document.getElementById('cmViewerOptions').style.display = 'none';
            } else {
                // لو تعليق شخص آخر: أظهر قائمة المشاهد
                document.getElementById('cmOwnerOptions').style.display = 'none';
                document.getElementById('cmViewerOptions').style.display = 'block';

                // التعديل الجديد: هل أنا صاحب المنشور؟
                const deleteBtn = document.getElementById('ownerDeleteBtn');
                if (isMyPost) {
                    deleteBtn.style.display = 'flex'; // أظهر زر الحذف
                } else {
                    deleteBtn.style.display = 'none'; // أخفي زر الحذف
                }
            }
            
            document.getElementById('commentOptionsSheet').classList.add('active');
        }


        function triggerEditComment() {
            closeAllSheets(true); 
            const inp = document.getElementById('cmInput');
            inp.value = selectedComment.text;
            inp.focus();
            isEditingComment = true;
            document.getElementById('cmSendBtn').classList.remove('fa-paper-plane');
            document.getElementById('cmSendBtn').classList.add('fa-check', 'update-mode');
        }

       function triggerDeleteComment() {
    // 1. استخدام التنبيه الشيك اللي عملناه بدل confirm العادية
    showChicConfirm(
        "حذف التعليق؟",
        "هل أنت متأكد؟ لا يمكن التراجع عن هذا الإجراء.",
        '<i class="fa-solid fa-trash-can" style="color:var(--danger-color)"></i>',
        async function() {
            try {
                // حذف التعليق من الكوليكشن
                await db.collection("posts").doc(currentPostId).collection("comments").doc(selectedComment.id).delete();
                
                // --- التعديل هنا: الخصم الذكي ---
                // بنستخدم Transaction عشان نضمن إن الرقم مينزلش تحت الصفر
                const postRef = db.collection("posts").doc(currentPostId);
                await db.runTransaction(async (t) => {
                    const postDoc = await t.get(postRef);
                    if (!postDoc.exists) return;
                    
                    const currentCount = postDoc.data().commentsCount || 0;
                    // لو العدد أكبر من صفر نقص واحد، غير كده خليه صفر زي ما هو
                    const newCount = (currentCount > 0) ? currentCount - 1 : 0;
                    
                    t.update(postRef, { commentsCount: newCount });
                });
                // ---------------------------------

                closeAllSheets(true);
                showToast("✅ تم حذف التعليق");
                playSound('click');
            } catch(e) {
                console.error(e);
                showToast("❌ حدث خطأ");
            }
        }
    );
}


        function triggerCopyComment() {
            navigator.clipboard.writeText(selectedComment.text);
            closeAllSheets(true);
            showToast("تم النسخ");
        }

        function triggerReplyComment() {
            closeAllSheets(true);
            prepareReply(selectedComment.id, selectedComment.uid, selectedComment.name);
        }

        // --- الربط مع نظام الردود الجديد ---
        function prepareReply(cid, uid, name) {
            closeAllSheets(true); // غلق أي نوافذ مفتوحة
            const commentElement = document.getElementById(`comment-${cid}`);
            const commentText = commentElement.querySelector('.cm-text').innerText;
            
            // استدعاء نافذة الردود الموحدة
            openRepliesSheet({ id: cid, uid: uid, name: name, text: commentText });
        }

        function cancelReply() {
            replyToData = null;
        }

        function resetCommentInput() {
            const inp = document.getElementById('cmInput');
            const btn = document.getElementById('cmSendBtn');
            inp.value = "";
            isEditingComment = false;
            replyToData = null;
            btn.classList.remove('fa-check', 'update-mode');
            btn.classList.add('fa-paper-plane');
            cancelReply();
        }

        async function handleCommentAction(stickerContent = null, isSticker = false) {
    const inp = document.getElementById('cmInput');
    // لو باعتين استيكر خده، لو لأ خد الكلام من الخانة
    const txt = stickerContent || inp.value.trim();
    
    // لو مفيش نص ومش استيكر، اخرج ومتبعتش حاجة
    if(!txt && !isSticker) return;

    // تشغيل صوت الإرسال (لو مش استيكر، لأن الاستيكر ليه صوت في دالة تانية)
    if(!isSticker) playSound('sent');

    // --- حالة التعديل (Edit Mode) ---
    if(isEditingComment && selectedComment && !isSticker) {
        try {
            await db.collection("posts").doc(currentPostId)
                .collection("comments").doc(selectedComment.id).update({
                    text: txt, 
                    isEdited: true
            });
            showToast("تم تعديل التعليق");
        } catch (e) {
            console.error(e);
            showToast("خطأ في التعديل");
        }
        resetCommentInput();
    } 
    // --- حالة الإرسال الجديد (New Comment) ---
    else {
        // تحديد حالة الشبح الحالية
        // بنشوف المتغير العام، لو مش موجود بنفترض إنه false
        const currentGhostStatus = (typeof isGhost !== 'undefined') ? isGhost : false;

        // إرسال الإشعار لصاحب المنشور (لو مش أنا)
        if(currentPostOwnerUid && currentPostOwnerUid !== currentUser.uid) {
             let msg = isSticker ? 'أرسل استيكر' : ('علق: ' + txt);
             
             // لو شبح، ممكن نغير نص الإشعار لـ "مستخدم نبض"
             if (currentGhostStatus) {
                 // إشعار مجهول
                 // (ملاحظة: دالة pushNotification بتاخد بياناتك الحالية، 
                 // عشان تخلي الإشعار مجهول بالكامل محتاج تعدل دالة pushNotification نفسها، 
                 // بس حالياً هنسيبها كده والتعليق نفسه هو اللي هيكون مخفي)
             }
             
             pushNotification(currentPostOwnerUid, 'comment', msg, `profile.html?uid=${currentPostOwnerUid}#post-${currentPostId}`);
        }

        try {
            // الحفظ في قاعدة البيانات
            await db.collection("posts").doc(currentPostId).collection("comments").add({
                uid: currentUser.uid,
                name: currentUserName,
                pic: currentUserPic || "",
                isVerified: currentUserVerified,
                text: txt,
                isSticker: isSticker, // دي العلامة اللي هتميز الاستيكر
                isGhost: currentGhostStatus, // <--- دي الإضافة: حفظ حالة الشبح
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
logActivity('comment', `علقت: "${txt.substring(0, 15)}..."`, currentPostId, currentPostOwnerUid);


            // زيادة عداد التعليقات
            db.collection("posts").doc(currentPostId).update({
                commentsCount: firebase.firestore.FieldValue.increment(1)
            });
        } catch (e) {
            console.error(e);
            showToast("فشل إرسال التعليق");
        }

        resetCommentInput();
    }
}



        function reportComment() { showToast("تم الإبلاغ عن التعليق"); closeAllSheets(true); }

                // متغير عالمي لمعرفة حالة الحفظ الحالية
        let isCurrentPostSaved = false;


        // 2. دالة الحفظ وإلغاء الحفظ (جديدة)
        async function toggleSavePost() {
            closeAllSheets(); // غلق القائمة
            const saveRef = db.collection("users").doc(currentUser.uid).collection("savedPosts").doc(currentPostId);

            if (isCurrentPostSaved) {
                // لو محفوظ -> احذفه
                await saveRef.delete();
                showToast("تم إزالة المنشور من المحفوظات");
            } else {
                // لو مش محفوظ -> احفظه
                await saveRef.set({
                    postId: currentPostId,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("تم حفظ المنشور ✅");
                playSound('success');
            }
        }

        // 3. دالة تقديم البلاغ (موجودة عندك بس تأكيد إنها شغالة)
        function openReportModal() {
            closeAllSheets();
            document.getElementById('reportReasonModal').style.display = 'flex';
        }

        async function submitReport(reason) {
            document.getElementById('reportReasonModal').style.display = 'none';
            try {
                await db.collection("reports").add({
                    postId: currentPostId,
                    postText: currentPostText || "محتوى وسائط",
                    offenderUid: currentPostOwnerUid,
                    offenderName: currentPostOwnerName,
                    reporterUid: currentUser.uid,
                    reporterName: currentUserName,
                    reason: reason,
                    status: "pending", 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast("تم إرسال البلاغ للإدارة وسيتم مراجعته");
                playSound('sent');
            } catch(e) {
                showToast("خطأ في الإرسال");
                console.error(e);
            }
        }
    
        async function deletePost() { 
            if(confirm("حذف المنشور؟")) { 
                playSound('click');
                await db.collection("posts").doc(currentPostId).delete(); 
                const el = document.getElementById(`post-${currentPostId}`);
                if(el) el.remove();
                showToast("تم الحذف"); 
                closeAllSheets(); 
            } 
        }

        function copyPostText() { showToast("تم نسخ النص"); closeAllSheets(); }

        // أضف هذا داخل closeAllSheets لإلغاء وضع تعديل الردود
// تم تحديث الدالة لتقبل معامل جديد (keepEditMode)
function closeAllSheets(keepComments = false, keepEditMode = false, isBackBtn = false) { 
    // 1. إدارة زر الرجوع في الموبايل
    if (!isBackBtn && history.state && history.state.sheetOpen) {
        history.back();
    }

    // 2. إغلاق "كل" القوائم السفلية بذكاء (القديم والجديد)
    // الكود ده بيلف على أي حاجة اسمها bottom-sheet ويقفلها
    document.querySelectorAll('.bottom-sheet').forEach(sheet => {
        // استثناء: لو احنا عايزين نخلي التعليقات مفتوحة (keepComments)
        if (keepComments && sheet.id === 'cmSheet') return;
        
        sheet.classList.remove('active');
    });

    // 3. إغلاق قوائم الاستيكرات والمينشن
    const sSheet = document.getElementById('stickerSheet');
    if(sSheet) sSheet.classList.remove('active');
    
    const mentionDrop = document.getElementById('mentionDropdown');
    if(mentionDrop) mentionDrop.classList.remove('active');

    // 4. إغلاق القائمة الجانبية
    const sideMenu = document.getElementById('sideMenu');
    if(sideMenu) sideMenu.classList.remove('open');

    // 5. إخفاء الـ Overlay (الخلفية الغامقة) وتجميد الشاشة
    if(!keepComments) {
        unlockScroll(); 
        const overlay = document.getElementById('overlay');
        const sideOverlay = document.getElementById('sideMenuOverlay');
        
        if(overlay) overlay.style.display = 'none';
        if(sideOverlay) {
            sideOverlay.classList.remove('visible');
            setTimeout(() => sideOverlay.style.display='none', 300);
        }
        
        resetCommentInput();
        
        // إزالة التظليل
        document.querySelectorAll('.cm-bubble').forEach(b => b.classList.remove('highlight'));
    }

    // 6. إعادة تعيين أزرار الإرسال (إلغاء وضع التعديل)
    if (!keepEditMode) {
        isEditingReply = false;
        selectedReply = null;
        isEditingComment = false;
        selectedComment = null;
        
        document.querySelectorAll('.cm-send-btn').forEach(btn => {
            btn.classList.remove('fa-check', 'update-mode');
            btn.classList.add('fa-paper-plane');
        });
    }
}



        function openSideMenu() { 
            playSound('click');
            document.getElementById('sideMenu').classList.add('open'); 
            const overlay = document.getElementById('sideMenuOverlay'); 
            overlay.style.display='block'; 
            setTimeout(()=>overlay.classList.add('visible'), 10); 
        }

        function closeSideMenu() { 
            document.getElementById('sideMenu').classList.remove('open'); 
            const overlay = document.getElementById('sideMenuOverlay'); 
            overlay.classList.remove('visible'); 
            setTimeout(()=>overlay.style.display='none', 300); 
        }

        function openLogoutConfirm() { playSound('click'); closeSideMenu(); document.getElementById('logoutModal').style.display='flex'; }
        function confirmLogout() { playSound('click'); auth.signOut().then(()=>location.href="index.html"); }
        
        function openAccountSwitcher() {
            playSound('click');
            closeSideMenu(); document.getElementById('accountSwitcherModal').style.display = 'flex';
            document.getElementById('addAccountForm').style.display = 'none'; document.getElementById('addAccBtnContainer').style.display = 'flex';
            const list = document.getElementById('accountList'); list.innerHTML = "";
            let accounts = JSON.parse(localStorage.getItem('nabd_accounts') || '[]');
            
            if(currentUser && profileData) {
                const currentIdx = accounts.findIndex(a => a.uid === currentUser.uid);
                if(currentIdx > -1) {
                    accounts[currentIdx].name = currentUserName;
                    accounts[currentIdx].isVerified = currentUserVerified;
                    if(profileData.profilePic) accounts[currentIdx].pic = profileData.profilePic;
                    localStorage.setItem('nabd_accounts', JSON.stringify(accounts));
                }
            }

            if(accounts.length === 0) list.innerHTML = "<div style='text-align:center;color:#777'>لا توجد حسابات محفوظة</div>";
            
            accounts.forEach((acc, idx) => {
                const isCurrent = (currentUser && acc.uid === currentUser.uid);
                const verifiedBadge = acc.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:5px; font-size:14px;"></i>' : '';
                const avatarStyle = acc.pic ? `background-image:url('${acc.pic}')` : `background:${generateColor(acc.uid)}`;
                const avatarContent = acc.pic ? '' : (acc.name ? acc.name[0] : 'U');

                list.innerHTML += `
                <div class="acc-item" onclick="${isCurrent?'':`switchAccount(${idx})`}" style="${isCurrent?'opacity:0.5;cursor:default':''}">
                    <div style="width:40px;height:40px;border-radius:50%;${avatarStyle};display:grid;place-items:center;background-size:cover;border:1px solid var(--border-color)">${avatarContent}</div>
                    <div style="flex:1; text-align:right;">
                        <div style="font-weight:bold;font-size:15px;display:flex;align-items:center;color:var(--text-color)">
                            ${acc.name} ${verifiedBadge}
                        </div>
                        <div style="font-size:12px;color:var(--secondary-text)">${acc.email}</div>
                    </div>
                    ${!isCurrent ? `<i class="fa-solid fa-trash" style="color:#ff3b30;padding:8px;font-size:14px" onclick="removeAccount(event, ${idx})"></i>` : ''}
                </div>`;
            });
        }

        function hideAddAccountForm() { document.getElementById('addAccountForm').style.display='none'; document.getElementById('addAccBtnContainer').style.display='flex'; }
        // دالة إظهار فورم إضافة الحساب (كانت ناقصة)
function showAddAccountForm() {
    playSound('click');
    document.getElementById('addAccountForm').style.display = 'block'; // يظهر الخانات
    document.getElementById('addAccBtnContainer').style.display = 'none'; // يخفي زرار الإضافة مؤقتاً
}

        async function addNewAccountAction() {
            playSound('click');
            const e = document.getElementById('newAccEmail').value;
            const p = document.getElementById('newAccPass').value;
            if(!e || !p) return showToast("أدخل البيانات");
            
            try { 
                const cred = await auth.signInWithEmailAndPassword(e, p); 
                const uid = cred.user.uid;

                const userDoc = await db.collection('users').doc(uid).get();
                const userData = userDoc.data() || {};
                const realName = userData.name || e.split('@')[0];
                const isVerified = userData.isVerified || false;
                const pic = userData.profilePic || "";

                let accs = JSON.parse(localStorage.getItem('nabd_accounts') || '[]'); 
                if(!accs.find(a => a.uid === uid)) {
                    accs.push({
                        uid: uid, email: e, token: btoa(p), 
                        name: realName, isVerified: isVerified, pic: pic
                    }); 
                    localStorage.setItem('nabd_accounts', JSON.stringify(accs)); 
                }
                location.reload(); 
            } catch(er) { console.error(er); showToast("خطأ في الدخول أو البيانات غير صحيحة"); }
        }

        function switchAccount(idx) { 
            playSound('click');
            let accs = JSON.parse(localStorage.getItem('nabd_accounts')); 
            if(accs[idx]) auth.signInWithEmailAndPassword(accs[idx].email, atob(accs[idx].token)).then(()=>location.reload()); 
        }

        function removeAccount(e, idx) { 
            e.stopPropagation(); 
            if(!confirm("إزالة هذا الحساب؟")) return;
            let accs = JSON.parse(localStorage.getItem('nabd_accounts')); 
            accs.splice(idx, 1); 
            localStorage.setItem('nabd_accounts', JSON.stringify(accs)); 
            openAccountSwitcher(); 
        }

        function updateMainNotifBadge() {
            if (!currentUser) return;
            db.collection("notifications").where("recipientId", "==", currentUser.uid).where("read", "==", false)
                .onSnapshot(snap => {
                    const badge = document.getElementById('mainNotifBadge');
                    if (badge) {
                        badge.innerText = snap.size > 99 ? '99+' : snap.size; 
                        badge.style.display = snap.size > 0 ? 'inline-block' : 'none';
                        if(snap.size > 0) { badge.style.animation = 'none'; badge.offsetHeight; badge.style.animation = 'pulse 1.5s infinite'; }
                    }
                });
        }

        function updateRequestsBadge() {
            if (!currentUser) return;
            db.collection("users").doc(currentUser.uid).collection("friendRequests")
            .onSnapshot(snap => {
                const badge = document.getElementById('requestsBadge');
                if (badge) {
                    badge.innerText = snap.size;
                    badge.style.display = snap.size > 0 ? 'inline-block' : 'none';
                }
            });
        }

/* ================================================= */
/* كود فيزياء الكورة + القوائم + السحب (النسخة الكاملة) */
/* ================================================= */
(function() {
    const orb = document.getElementById('uraniumOrb');
    const deleteZone = document.getElementById('deleteZone');
    
    // تعريف المتغيرات
    let isDragging = false, startX, startY, currentX, currentY, velocityX = 0, velocityY = 0;
    let lastX, lastY, lastTime, animationFrame, superMode = false;
    let pressTimer, orbVisible = true; 
    
    // استعادة لون الثيم المحفوظ فوراً عند التحميل
    const savedColor = localStorage.getItem('themeColor');
    if(savedColor) {
        document.documentElement.style.setProperty('--primary-solid', savedColor);
        document.documentElement.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${savedColor}, #444)`);
    }

    // --- 1. بداية اللمس ---
        // --- دالة التصوير (مهمة جداً تكون هنا) ---
    function captureScreen() {
        const orb = document.getElementById('uraniumOrb');
        const pull = document.getElementById('pullIndicator');
        const deleteZone = document.getElementById('deleteZone');

        // نخفي الكورة والزبالة عشان ميظهروش في الصورة
        if(orb) orb.style.opacity = '0';
        if(pull) pull.style.display = 'none';
        if(deleteZone) deleteZone.style.display = 'none';

        // صوت الكاميرا
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-camera-shutter-click-1133.mp3');
        audio.play().catch(()=>{});

        // التقاط الصورة
        html2canvas(document.body, {
            useCORS: true, 
            allowTaint: true, 
            scrollY: -window.scrollY
        }).then(canvas => {
            // نرجع كل حاجة مكانها
            if(orb) orb.style.opacity = '1';
            if(pull) pull.style.display = 'flex';
            if(deleteZone) deleteZone.style.display = 'flex';

            // تحميل الصورة
            const link = document.createElement('a');
            link.download = `NABD_Snap_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showToast("📸 تم التقاط الشاشة");
        }).catch(err => {
            if(orb) orb.style.opacity = '1';
            console.error("خطأ في التصوير:", err);
        });
    }

    // --- 1. بداية اللمس (Start) ---
    orb.addEventListener('touchstart', e => {
        if(superMode || !orbVisible) return; 
        const t = e.touches[0]; 
        startX = t.clientX; 
        startY = t.clientY;
        lastX = startX; lastY = startY; lastTime = Date.now();
        
        isDragging = false; // تصفير السحب
        velocityX = 0; velocityY = 0;
        
        cancelAnimationFrame(animationFrame); 
        orb.style.transition='none';
        
        // تايمر الضغطة المطولة (لو فضلت دايس)
        pressTimer = setTimeout(() => {
            if (!isDragging) {
                 toggleMode(); // يغير الوضع ليلي/نهاري
                 if(navigator.vibrate) navigator.vibrate(50);
            }
        }, 600);
    }, {passive:false});

    // --- 2. حركة الصباع (Move) ---
    orb.addEventListener('touchmove', e => {
        if(superMode || !orbVisible) return;
        e.preventDefault(); 
        const t = e.touches[0], now=Date.now(), dt=now-lastTime;
        
        // التعديل هنا: مش هنعتبره سحب إلا لو اتحركت أكتر من 10 بكسل
        // ده عشان "الرعشة" البسيطة متوقفش الاسكرين شوت
        if(Math.abs(t.clientX-startX) > 10 || Math.abs(t.clientY-startY) > 10) {
            clearTimeout(pressTimer); // الغي الضغطة المطولة
            isDragging = true; // اعتبره سحب خلاص
        }

        if(isDragging) {
            currentX = t.clientX-(orb.offsetWidth/2); 
            currentY = t.clientY-(orb.offsetHeight/2);
            orb.style.left=`${currentX}px`; 
            orb.style.top=`${currentY}px`;
            
            // كود الزبالة (المنطقة الحمراء)
            if (currentY > window.innerHeight - 180) {
                deleteZone.style.transform = 'translateX(-50%) scale(1)';
                const dzRect = deleteZone.getBoundingClientRect();
                if (t.clientX > dzRect.left && t.clientX < dzRect.right && t.clientY > dzRect.top) {
                    deleteZone.style.background = 'rgba(255, 0, 0, 0.4)';
                    deleteZone.style.boxShadow = '0 0 20px rgba(255,0,0,0.5)';
                    orb.style.opacity = '0.5';
                } else {
                    deleteZone.style.background = 'rgba(255, 0, 0, 0.1)';
                    deleteZone.style.boxShadow = 'none';
                    orb.style.opacity = '1';
                }
            } else {
                deleteZone.style.transform = 'translateX(-50%) scale(0)';
                orb.style.opacity = '1';
            }

            if(dt>0) { velocityX=(t.clientX-lastX)/dt; velocityY=(t.clientY-lastY)/dt; }
            lastX=t.clientX; lastY=t.clientY; lastTime=now;
        }
    }, {passive:false});

    // --- 3. رفع الصباع (End) ---
    orb.addEventListener('touchend', (e) => {
        if(superMode || !orbVisible) return;
        clearTimeout(pressTimer); // الغي تايمر الضغطة المطولة
        deleteZone.style.transform = 'translateX(-50%) scale(0)';

        // === هنا السحر ===
        // لو مكنش سحب (يعني ضغطة بسيطة) -> خد سكرين شوت
        if (!isDragging) {
            captureScreen(); 
        } 
        // لو كان سحب -> نفذ الأوامر التانية
        else {
            const dzRect = deleteZone.getBoundingClientRect();
            const orbRect = orb.getBoundingClientRect();

            // رمي في الزبالة
            if (orbRect.bottom > dzRect.top && orbRect.left < dzRect.right && orbRect.right > dzRect.left && currentY > window.innerHeight - 180) {
                hideOrb();
            } 
            // رمي لفوق (القائمة)
            else if(currentY < 60) {
                activateSuperMode();
            } 
            // فيزياء الحركة العادية
            else {
                applyMomentum();
            }
        }
    });



    // --- دوال المساعدة ---

    // تفعيل وضع القائمة (القمر الصناعي)
    function activateSuperMode() {
        superMode = true;
        orb.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        orb.style.left = '50%'; orb.style.top = '120px'; orb.style.transform = 'translate(-50%, -50%)';
        orb.classList.add('super-mode');
        setTimeout(() => document.addEventListener('click', closeSuperModeOutside), 100);
    }

    // إغلاق القائمة عند النقر خارجها
    function closeSuperModeOutside(e) {
        // لو ضغطت بره الكورة ومش جوه مودال الألوان
        if(!orb.contains(e.target) && !document.getElementById('themeModal').contains(e.target)) {
            deactivateSuperMode();
            document.removeEventListener('click', closeSuperModeOutside);
        }
    }

    // إلغاء وضع القائمة
    function deactivateSuperMode() {
        superMode = false;
        orb.classList.remove('super-mode'); orb.style.transform = 'none';
        let tx=window.innerWidth-70; let ty=window.innerHeight-150;
        orb.style.left=`${tx}px`; orb.style.top=`${ty}px`;
        currentX=tx; currentY=ty;
    }

    // تبديل الوضع (ليلي / نهاري)
    function toggleMode() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        // استخدام دالة التوست الموجودة في صفحتك
        if(typeof showToast === "function") showToast(isLight ? "الوضع النهاري" : "الوضع الليلي");
    }

    // فيزياء الحركة (الزحلقة والارتداد)
    function applyMomentum() {
        const friction=0.92;
        function step() {
            if(Math.abs(velocityX)>0.1 || Math.abs(velocityY)>0.1) {
                currentX+=velocityX*15; currentY+=velocityY*15;
                velocityX*=friction; velocityY*=friction;
                
                // الارتداد من الحواف
                if(currentX<0||currentX>window.innerWidth-55) velocityX*=-0.5;
                if(currentY<0||currentY>window.innerHeight-55) velocityY*=-0.5;
                
                currentX=Math.max(0,Math.min(currentX,window.innerWidth-55));
                currentY=Math.max(0,Math.min(currentY,window.innerHeight-55));
                
                orb.style.left=`${currentX}px`; orb.style.top=`${currentY}px`;
                animationFrame=requestAnimationFrame(step);
            } else {
                // الاستقرار على الجانب
                let tx=(orb.getBoundingClientRect().left+(55/2)<window.innerWidth/2)?10:window.innerWidth-65;
                let ty=Math.max(50, Math.min(parseInt(orb.style.top), window.innerHeight-100));
                orb.style.transition='all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                orb.style.left=`${tx}px`; orb.style.top=`${ty}px`;
            }
        } step();
    }

    // إخفاء الكورة
    function hideOrb() {
        orb.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        orb.style.transform = 'scale(0)'; orb.style.opacity = '0';
        setTimeout(() => { 
            orb.style.display = 'none'; orbVisible = false; 
            if(typeof showToast === "function") showToast("انقر مرتين لإعادة الكرة"); 
        }, 400);
    }

    // استرجاع الكورة بالنقر المزدوج (Double Tap)
    let lastTap = 0;
    document.addEventListener('touchend', function (e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0 && !orbVisible) {
            orb.style.display = 'flex'; orb.style.transition = 'none';
            orb.style.left = '20px'; orb.style.top = (window.innerHeight - 100) + 'px';
            orbVisible = true;
            setTimeout(() => {
                orb.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                orb.style.transform = 'scale(1)'; orb.style.opacity = '1';
            }, 50);
        }
        lastTap = currentTime;
                /* ========================================= */
    /* كود تشغيل قائمة السمات (كان ناقص)      */
    /* ========================================= */

    // 1. فتح القائمة
    window.openThemeModal = function() {
        // لو الكورة مفتوحة (Super Mode) اقفلها الأول
        if(superMode) deactivateSuperMode();
        document.getElementById('themeModal').classList.add('active');
    };

    // 2. إغلاق القائمة
    window.closeThemeModal = function() {
        document.getElementById('themeModal').classList.remove('active');
    };

    // 3. تغيير اللون
    window.changeTheme = function(color, save = true) {
        // تغيير المتغيرات في CSS
        document.documentElement.style.setProperty('--primary-solid', color);
        document.documentElement.style.setProperty('--primary-gradient', `linear-gradient(135deg, ${color}, #444)`);
        
        if(save) {
            localStorage.setItem('themeColor', color);
            showToast("تم تطبيق اللون 🎨");
            window.closeThemeModal();
        }
    };

    // 4. استعادة الافتراضي
    window.resetTheme = function() {
        window.changeTheme('#5D5FEF', true); 
    };

    });
})();

        function generateColor(uid) { 
            const c=["#5D5FEF","#34c759","#ff3b30","#ffb533","#2AF598","#009EFD"]; 
            let h=0; for(let i=0;i<uid.length;i++) h=uid.charCodeAt(i)+((h<<5)-h); 
            return c[Math.abs(h)%c.length]; 
        }

        function showToast(m) { 
            const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=m; 
            t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); 
        }

        function copyUsername() { 
            const u = document.getElementById('username').innerText;
            if(!u) return;
            navigator.clipboard.writeText(u.replace('@','')).then(()=>showToast("تم نسخ المعرف")); 
        }

        function openLightbox(s) { playSound('click'); document.getElementById('lb-img').src=s; document.getElementById('lightbox').style.display='flex'; }
        function viewList(t) { if(profileUid) location.href=`friends.html?uid=${profileUid}&list=${t}`; }
        function formatNumber(num) { if (!num) return '0'; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'; if (num >= 1000) return (num / 1000).toFixed(1) + 'K'; return num.toString(); }

        function shareProfile() {
            playSound('click');
            if (navigator.share) {
                navigator.share({ title: 'الملف الشخصي', text: `شوف بروفايل ${currentUserName}`, url: window.location.href }).catch(console.error);
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast("تم نسخ رابط الملف الشخصي");
            }
        }

        function showMoreOptions() {
            playSound('click');
            showToast("قريباً: سجل النشاطات");
        }

        // ==========================================
        // نظام الردود الموحد والجديد بالكامل
        // ==========================================

        // متغير لتخزين الشخص اللي بنعمله منشن حالياً
let currentSubReplyTarget = null; // {uid, name}



function openRepliesSheet(comment) {
    currentParentComment = comment; 
    playSound('tab');
    
    document.getElementById('repliesSheet').classList.add('active');
    document.getElementById('overlay').style.display = 'block';

    // --- منطق القناع المتطور (Colored Ghost Logic) ---
    let displayName = comment.name || 'مستخدم';
    let displayPic = comment.pic;
    let verifiedDisplay = comment.isVerified;
    let clickAction = `location.href='profile.html?uid=${comment.uid}'`;
    let avatarContent = displayPic ? '' : (displayName[0] || 'U');
    let avatarStyle = "";

    // >> لو التعليق ده "شبح"
    if (comment.isGhost) {
        // توليد الهوية المزيفة الثابتة
        const ghostIdentity = getGhostIdentity(comment.uid);
        
        displayName = `مستخدم نبض #${ghostIdentity.id}`; // الاسم + الرقم
        displayPic = "";
        verifiedDisplay = false;
        
        // الأيقونة تاخد لون الشبح
        avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:18px;"></i>`;
        clickAction = "showToast('⛔ هوية محمية')";
        
        // البرواز ياخد نفس اللون
        avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 5px ${ghostIdentity.color}40;`;
    } else {
        // >> الوضع الطبيعي
        let finalPic = comment.pic;
        if (currentUser && comment.uid === currentUser.uid && !finalPic) finalPic = currentUserPic;
        else if (typeof profileData !== 'undefined' && comment.uid === profileUid && !finalPic) finalPic = profileData.profilePic;
        
        avatarStyle = finalPic ? 
            `background: url('${finalPic}') center/cover no-repeat; border: 1px solid var(--border-color);` : 
            `background: ${generateColor(comment.uid)}; border: 1px solid var(--border-color); display:grid; place-items:center;`;
        
        if (finalPic) avatarContent = '';
    }

    // حساب لون الفقاعة (للخلفية فقط)
    let hash = 0;
    if(comment.uid) { for (let i = 0; i < comment.uid.length; i++) hash = comment.uid.charCodeAt(i) + ((hash << 5) - hash); }
    const colorIndex = Math.abs(hash) % 10;
    const colorClass = `color-${colorIndex}`;

    const isPostOwner = (currentPostOwnerUid && comment.uid === currentPostOwnerUid);
    let bubbleClass = `cm-bubble colored-comment ${colorClass}`;
    if (isPostOwner) bubbleClass += ' owner-bubble';
    
    const verifiedIcon = verifiedDisplay ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; margin-right:4px; font-size:12px; display:inline-block; vertical-align:middle;"></i>' : '';
    const authorBadge = (isPostOwner && !comment.isGhost) ? '<span class="owner-badge" style="display:inline-block; margin-right:5px;">مؤلف</span>' : '';

    const list = document.getElementById('repliesList');
    
    list.innerHTML = `
        <div class="parent-comment-header">
            <div style="display:flex; gap:10px; align-items:flex-start;">
                <div class="cm-avatar" 
                     style="width:40px; height:40px; border-radius:50%; flex-shrink:0; cursor:pointer; ${avatarStyle}"
                     onclick="${clickAction}">
                     ${avatarContent}
                </div>
                
                <div style="flex:1;">
                    <div class="${bubbleClass}">
                        <div class="cm-username" 
                             style="cursor:pointer; font-size:13px; display:flex; align-items:center; flex-wrap:wrap; ${comment.isGhost ? `color:${getGhostIdentity(comment.uid).color} !important;` : ''}"
                             onclick="${clickAction}">
                            <span>${displayName}</span>
                            ${verifiedIcon} 
                            ${authorBadge}
                        </div>
                        <div class="cm-text">${comment.text}</div>
                    </div>
                    
                    <div style="font-size:11px; color:var(--secondary-text); margin-top:5px; margin-right:5px; font-weight:600;">
                        التعليق الأصلي
                    </div>
                </div>
            </div>
        </div>

        <div style="font-size:12px; color:var(--secondary-text); margin-bottom:15px; text-align:center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">الردود</div>
        
        <div id="actualRepliesContainer"></div>
    `;

    loadRealtimeReplies(comment.id);
}         

function loadRealtimeReplies(commentId) {
    const container = document.getElementById('actualRepliesContainer');
    if (window.replyListener) window.replyListener();

    window.replyListener = db.collection("posts").doc(currentPostId)
    .collection("comments").doc(commentId)
    .collection("replies").orderBy("createdAt", "asc")
    .onSnapshot(snap => {
        container.innerHTML = ""; 
        if(snap.empty) { container.innerHTML = "<div style='text-align:center; color:var(--secondary-text); font-size:13px; margin-top:20px;'>كن أول من يرد!</div>"; return; }

        let participants = [currentParentComment.uid]; 

        snap.forEach((doc, index) => {
            const r = {id: doc.id, ...doc.data()};
            
            // --- 1. منطق القناع المتطور للردود ---
            let displayName = r.name;
            let displayPic = r.pic;
            let clickAction = `location.href='profile.html?uid=${r.uid}'`;
            let avatarContent = displayPic ? '' : (r.name ? r.name[0] : 'U');
            let avatarStyle = displayPic ? 
                `background-image:url('${displayPic}')` : 
                `background:${generateColor(r.uid)}`;
            let verifiedIcon = r.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; font-size:10px; margin-right:3px;"></i>' : '';
            let nameStyle = ""; // عشان نلون الاسم

            // >> لو الرد ده "شبح"
            if (r.isGhost) {
                const ghostIdentity = getGhostIdentity(r.uid);
                
                displayName = `مستخدم نبض #${ghostIdentity.id}`;
                displayPic = "";
                
                // الأيقونة الملونة
                avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:14px;"></i>`;
                
                // البرواز الملون
                avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 4px ${ghostIdentity.color}30;`;
                
                clickAction = "showToast('⛔ هوية محمية')";
                verifiedIcon = "";
                
                // تلوين الاسم بنفس لون الشبح
                nameStyle = `color: ${ghostIdentity.color} !important; text-shadow: 0 0 5px ${ghostIdentity.color}40;`;
            }
            // -------------------------------------

            let userIndex = participants.indexOf(r.uid);
            if (userIndex === -1) { participants.push(r.uid); userIndex = participants.length - 1; }
            const colorClass = `color-${userIndex % 10}`;
            
            const isLast = index === snap.size - 1;
            const treeLineStyle = isLast ? "height: 25px;" : "bottom: -15px;"; 

            // معالجة المنشن
            let displayText = r.text;
            if (!r.isSticker && r.replyToUid && r.replyToName && displayText.startsWith(r.replyToName)) {
                const cleanText = displayText.substring(r.replyToName.length);
                const mentionHtml = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${r.replyToUid}'">${r.replyToName}</span>`;
                displayText = mentionHtml + cleanText;
            }

            let bubbleClasses = `cm-bubble colored-reply ${colorClass}`;
            let textClass = "cm-text";
            if (r.isSticker) {
                bubbleClasses += " sticker-comment"; 
                textClass = ""; 
            }

            const replyWrapper = document.createElement('div');
            replyWrapper.style.cssText = "position:relative; margin-right:25px; margin-bottom:15px; animation: fadeIn 0.3s ease;";
            
            replyWrapper.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openReplyOptions(r), 600); });
            replyWrapper.addEventListener('touchend', () => clearTimeout(pressTimer));
            replyWrapper.addEventListener('touchmove', () => clearTimeout(pressTimer));

            replyWrapper.innerHTML = `
                <div class="tree-connector" style="${treeLineStyle}"></div>
                <div class="reply-curve"></div>
                <div style="display:flex; gap:10px; align-items: flex-start;">
                    <div class="cm-avatar" 
                         style="width:30px; height:30px; flex-shrink:0; border:1px solid var(--border-color); cursor:pointer; ${avatarStyle}"
                         onclick="${clickAction}">
                         ${avatarContent}
                    </div>
                    
                    <div class="cm-content" style="flex:1;">
                        <div class="${bubbleClasses}" id="reply-bubble-${r.id}">
                            <div class="cm-username" 
                                 style="font-size:12px; font-weight:700; cursor:pointer; ${nameStyle}"
                                 onclick="${clickAction}">
                                 ${displayName} ${verifiedIcon}
                            </div>
                            <div class="${textClass}">${displayText}</div>
                        </div>

                        <div class="cm-meta-row" style="margin-right:5px; font-size:10px;">
                            <span>${r.createdAt ? moment(r.createdAt.toDate()).fromNow() : 'الآن'}</span>
                            ${!r.isGhost ? `<span class="cm-action" style="font-weight:bold; color:var(--text-color);" onclick="prepareSubReply('${r.uid}', '${displayName}')">رد</span>` : ''}
                        </div>
                    </div>
                </div>`;
            
            container.appendChild(replyWrapper);
        });
    });
}


    
function prepareSubReply(uid, name) {
    // حفظنا بيانات الشخص اللي هنرد عليه
    currentSubReplyTarget = { uid: uid, name: name };
    
    const inp = document.getElementById('replyInput');
    // بنكتب الاسم بس من غير @
    inp.value = name + " ";
    inp.focus();
    
    if(navigator.vibrate) navigator.vibrate(30);
}

// دالة الإرسال المعدلة
async function sendReplyToComment(stickerContent = null, isSticker = false) {
    const inp = document.getElementById('replyInput');
    let txt = stickerContent || inp.value.trim();
    
    if((!txt && !isSticker) || !currentParentComment) return;
    
    if(!isSticker) {
        txt = txt.replace(/^@/, '');
        playSound('sent');
    }

    // منطق المنشن
    let replyToUid = null; let replyToName = null;
    if (!isSticker) {
        if (window.directMentionData && txt.includes(window.directMentionData.name)) {
            replyToUid = window.directMentionData.uid; replyToName = window.directMentionData.name;
            window.directMentionData = null;
        } else if (currentSubReplyTarget && txt.startsWith(currentSubReplyTarget.name)) {
            replyToUid = currentSubReplyTarget.uid; replyToName = currentSubReplyTarget.name;
        }
    }

    // 🔥 التصحيح: الاعتماد على المتغير العام اللي نقلناه فوق
    // (ملاحظة: تأكد إنك نقلت let isGhost = false; لأول الملف زي ما اتفقنا في الخطوة 1)

    try {
        if (isEditingReply && selectedReply && !isSticker) {
             await db.collection("posts").doc(currentPostId)
                .collection("comments").doc(currentParentComment.id)
                .collection("replies").doc(selectedReply.id).update({ text: txt, isEdited: true });
            showToast("تم تعديل الرد");
            isEditingReply = false; selectedReply = null;
            const btn = document.querySelector('.cm-footer .cm-send-btn');
            if(btn) { btn.classList.remove('fa-check', 'update-mode'); btn.classList.add('fa-paper-plane'); }
        } else {
            // إرسال الرد (مع حفظ حالة الشبح)
            await db.collection("posts").doc(currentPostId)
                .collection("comments").doc(currentParentComment.id)
                .collection("replies").add({
                    uid: currentUser.uid,
                    name: currentUserName,
                    pic: currentUserPic || "", 
                    isVerified: currentUserVerified,
                    text: txt,
                    isSticker: isSticker,
                    isGhost: isGhost, // <--- هنا السر: بيقرا الحالة الحالية
                    replyToUid: replyToUid, replyToName: replyToName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            // الإشعارات
            const notifMsg = isSticker ? 'أرسل استيكر في رد' : 'رد على تعليقك';
            if(currentParentComment.uid !== currentUser.uid) {
                // دالة pushNotification متحدثة وهتتعامل مع الشبح تلقائي
                pushNotification(currentParentComment.uid, 'reply', notifMsg, `profile.html?uid=${currentPostOwnerUid}`);
            }
        }
        inp.value = ""; currentSubReplyTarget = null;
    } catch(e) { 
        console.error(e);
        showToast("خطأ: تأكد من تعريف isGhost في بداية الملف"); 
    }
}




        function closeRepliesSheet() {
            document.getElementById('repliesSheet').classList.remove('active');
            currentParentComment = null;
        }
    // =========================================
// نظام البحث الداخلي في الصفحة
// =========================================

// 1. دالة إظهار/إخفاء شريط البحث
function toggleSearchBar() {
    const bar = document.getElementById('pageSearchBar');
    const inp = document.getElementById('localSearchInput');
    
    if (bar.style.display === 'none') {
        bar.style.display = 'block';
        playSound('click');
        inp.focus(); // يخلي المؤشر يكتب علطول
    } else {
        bar.style.display = 'none';
        inp.value = ""; // يفضي الكلام
        filterLocalPosts(); // يرجع كل المنشورات تظهر تاني
    }
}

// 2. دالة التصفية (بتخفي المنشورات اللي مش تبع البحث)
function filterLocalPosts() {
    const query = document.getElementById('localSearchInput').value.toLowerCase();
    const posts = document.querySelectorAll('.post'); // بيجيب كل المنشورات المحملة
    
    let hasResults = false;

    posts.forEach(post => {
        // بنبحث في النص بتاع المنشور كله
        const text = post.innerText.toLowerCase();
        
        if (text.includes(query)) {
            post.style.display = 'block'; // اظهر
            hasResults = true;
        } else {
            post.style.display = 'none'; // اخفي
        }
    });

    // لو مفيش نتايج ممكن تظهر رسالة (اختياري)
    const noMsg = document.getElementById('noSearchMsg');
    if(!hasResults && query !== "") {
        if(!noMsg) {
            const msg = document.createElement('div');
            msg.id = 'noSearchMsg';
            msg.innerHTML = '<div style="text-align:center; padding:20px; color:var(--secondary-text)">لا توجد نتائج مطابقة</div>';
            document.getElementById('postsList').appendChild(msg);
        }
    } else {
        if(noMsg) noMsg.remove();
    }
}
        // --- الكود الجديد للتعديل والإبلاغ والخصوصية ---
        let currentPostText = "";
        let currentPostOwnerName = ""; 
    
        function openEditPostModal() {
            closeAllSheets();
            document.getElementById('editPostInput').value = currentPostText;
            document.getElementById('editPostModal').style.display = 'flex';
        }

        async function saveEditedPost() {
            const newText = document.getElementById('editPostInput').value;
            if(!newText) return showToast("اكتب نصاً أولاً");

            try {
                await db.collection("posts").doc(currentPostId).update({
                    text: newText,
                    isEdited: true
                });
                
                // تحديث النص قدام عينك فوراً
                const postEl = document.getElementById(`post-${currentPostId}`);
                if(postEl) {
                    const textEl = postEl.querySelector('.post-text');
                    if(textEl) textEl.innerText = newText;
                }

                document.getElementById('editPostModal').style.display = 'none';
                showToast("تم تعديل المنشور");
                playSound('success');
            } catch(e) {
                console.error(e);
                showToast("حدث خطأ");
            }
        }

        // 3. دوال تغيير الخصوصية
        async function changePrivacy(type) {
            closeAllSheets();
            try {
                await db.collection("posts").doc(currentPostId).update({ visibility: type });
                showToast("تم تحديث الخصوصية");
                playSound('click');
                // عشان الأيقونة تتغير، بنعمل تحديث للصفحة بعد ثانية (أسهل حل حالياً)
                setTimeout(() => location.reload(), 1000);
            } catch(e) { showToast("فشل التحديث"); }
        }

        // 4. دوال الإبلاغ (يروح لصفحة الأدمن)
        function openReportModal() {
            closeAllSheets();
            document.getElementById('reportReasonModal').style.display = 'flex';
        }

        async function submitReport(reason) {
            document.getElementById('reportReasonModal').style.display = 'none';
            
            try {
                // إرسال البيانات بنفس الهيكلية لصفحة الأدمن
                await db.collection("reports").add({
                    postId: currentPostId,
                    postText: currentPostText || "وسائط",
                    offenderUid: currentPostOwnerUid,
                    offenderName: currentPostOwnerName,
                    reporterUid: currentUser.uid,
                    reporterName: currentUserName,
                    reason: reason,
                    status: "pending", 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast("تم إرسال البلاغ للإدارة");
                playSound('sent');
            } catch(e) {
                showToast("خطأ في الإرسال");
            }
        }
// 1. فتح قائمة خيارات الرد
// ==========================================
//  بداية كود الردود والنافذة الاحترافية (السليم)
// ==========================================

// 1. فتح قائمة خيارات الرد
function openReplyOptions(replyData) {
    playSound('tab');
    if(navigator.vibrate) navigator.vibrate(50);
    
    selectedReply = replyData; 

    if (!currentParentComment) {
        showToast("حدث خطأ في تحديد التعليق");
        return;
    }

    // تمييز الرد
    document.querySelectorAll('.colored-reply').forEach(b => b.style.opacity = '1');
    const bubble = document.getElementById(`reply-bubble-${replyData.id}`);
    if(bubble) bubble.style.opacity = '0.7'; 

    // إظهار القوائم
    const isMyReply = (replyData.uid === currentUser.uid);
    document.getElementById('replyOwnerOptions').style.display = isMyReply ? 'block' : 'none';
    
    const viewerOptions = document.getElementById('replyViewerOptions');
    viewerOptions.style.display = isMyReply ? 'none' : 'block';

    // --- تحديث اسم الشخص في الزرار ---
    if (!isMyReply) {
        const btn = document.getElementById('replyToUserBtn');
        // تأكد من أنك عدلت الـ HTML وأضفت id="replyToUserBtn" للزرار
        if(btn) btn.innerHTML = `<i class="fa-solid fa-reply"></i> رد على ${replyData.name}`;
    }
    
    document.getElementById('replyOptionsSheet').classList.add('active');
}




// 2. تفعيل وضع التعديل (إصلاح الزرار والخانة)
function triggerEditReplyAction() {
    // نغلق فقط قائمة الخيارات الصغيرة (replyOptionsSheet)
    document.getElementById('replyOptionsSheet').classList.remove('active');
    
    // لا نستدعي closeAllSheets عشان الردود تفضل مفتوحة
    
    const inp = document.getElementById('replyInput');
    inp.value = selectedReply.text;
    inp.focus();
    isEditingReply = true; 
    
    // تغيير أيقونة الزرار
    const btn = document.querySelector('.cm-footer .cm-send-btn');
    if(btn) {
        btn.classList.remove('fa-paper-plane');
        btn.classList.add('fa-check', 'update-mode');
    }
    
    showToast("📝 جاري تعديل الرد...");
}


// 3. حذف الرد (باستخدام النافذة الشيك)
function triggerDeleteReply() {
    // نخفي القائمة الصغيرة فقط
    document.getElementById('replyOptionsSheet').classList.remove('active');

    // التأكد من وجود البيانات
    if(!currentPostId || !currentParentComment || !selectedReply) {
        showToast("خطأ: بيانات الرد غير مكتملة");
        return;
    }

    showChicConfirm(
        "حذف الرد؟",
        "هل أنت متأكد من حذف هذا الرد نهائياً؟",
        '<i class="fa-solid fa-trash-can" style="color:var(--danger-color)"></i>',
        async function() { 
            try {
                await db.collection("posts").doc(currentPostId)
                    .collection("comments").doc(currentParentComment.id)
                    .collection("replies").doc(selectedReply.id).delete();
                
                showToast("✅ تم حذف الرد");
                playSound('click');
                // لا نغلق نافذة الردود عشان تشوف الحذف بعينك
            } catch(e) { 
                console.error(e);
                showToast("❌ حدث خطأ أثناء الحذف"); 
            }
        }
    );
}


// 4. نسخ الرد
function triggerCopyReply() {
    if(selectedReply && selectedReply.text) {
        navigator.clipboard.writeText(selectedReply.text);
        showToast("📋 تم نسخ الرد");
    }
    closeAllSheets(true);
}

// 5. دوال النافذة الاحترافية (Modal Logic)
let pendingAction = null;
    
    function triggerReplyToUser() {
    // 1. إخفاء القائمة
    document.getElementById('replyOptionsSheet').classList.remove('active');
    
    // 2. (مهم جداً) إلغاء وضع التعديل لتجنب الأخطاء
    isEditingReply = false;
    const btn = document.querySelector('.cm-footer .cm-send-btn');
    if(btn) {
        btn.classList.remove('fa-check', 'update-mode');
        btn.classList.add('fa-paper-plane');
    }

    // 3. وضع اسم الشخص في مربع الكتابة
    const inp = document.getElementById('replyInput');
    if(selectedReply && selectedReply.name) {
        inp.value = selectedReply.name + " "; // مسافة بعد الاسم
        inp.focus();
    }
}



function showChicConfirm(title, message, iconHTML, actionCallback) {
    playSound('tab');
    document.getElementById('chicTitle').innerText = title;
    document.getElementById('chicMessage').innerText = message;
    document.getElementById('chicIcon').innerHTML = iconHTML;
    pendingAction = actionCallback;
    document.getElementById('chicConfirmModal').style.display = 'flex';
    
    document.getElementById('chicConfirmBtn').onclick = function() {
        if(pendingAction) pendingAction();
        closeChicModal();
    };
}

function closeChicModal() {
    document.getElementById('chicConfirmModal').style.display = 'none';
    pendingAction = null;
}

// دالة التحكم في صوت الفيديو
function toggleMute(e, videoId, btn) {
    // السطر ده أهم حاجة: بيوقف "انتشار" الضغطة عشان ميوصلش للفيديو ويفتح الصفحة
    e.stopPropagation(); 
    
    const video = document.getElementById(videoId);
    const icon = btn.querySelector('i');

    if (video.muted) {
        // لو مكتوم -> شغله وغير الأيقونة لسماعة
        video.muted = false;
        icon.classList.remove('fa-volume-xmark');
        icon.classList.add('fa-volume-high');
    } else {
        // لو شغال -> اكتمه وغير الأيقونة لعلامة x
        video.muted = true;
        icon.classList.remove('fa-volume-high');
        icon.classList.add('fa-volume-xmark');
    }
}
// دالة لزيادة عدد المشاهدات في الداتابيز
// دالة لزيادة عدد المشاهدات (نظام احترافي - مرة واحدة لكل جلسة)
async function incrementViewCount(postId) {
    // 1. التحقق: هل شاف الفيديو ده في الجلسة دي قبل كده؟
    const viewedKey = `viewed_${postId}`;
    if (sessionStorage.getItem(viewedKey)) {
        console.log("تم احتساب المشاهدة لهذا الفيديو مسبقاً في هذه الجلسة.");
        return; // وقف هنا ومتزودش حاجة
    }

    try {
        console.log("مشاهدة جديدة! جاري التحديث...");

        // 2. تحديث الداتابيز
        const postRef = db.collection("posts").doc(postId);
        await postRef.update({
            views: firebase.firestore.FieldValue.increment(1)
        });
        // ضيف ده بعد تسجيل المشاهدة
logActivity('view', 'شاهدت فيديو', postId, profileUid);


        
        // 3. وضع علامة إن المستخدم شاف الفيديو ده خلاص
        sessionStorage.setItem(viewedKey, 'true');
        
        // 4. تحديث الرقم فوراً قدامك
        const viewSpan = document.getElementById(`vid-views-${postId}`);
        if(viewSpan) {
            let current = parseInt(viewSpan.innerText.replace(/[^0-9]/g, '')) || 0;
            viewSpan.innerText = formatNumber(current + 1);
        }

    } catch (e) {
        console.error("فشل زيادة المشاهدات:", e);
    }
}

// --- دوال التحديث المباشر (جديد) ---

let viewUpdateInterval = null;

// دالة تبدأ التحديث كل 10 ثواني
function startLiveViews(postId) {
    if (viewUpdateInterval) clearInterval(viewUpdateInterval);

    viewUpdateInterval = setInterval(async () => {
        try {
            const doc = await db.collection("posts").doc(postId).get();
            if (doc.exists) {
                const realViews = doc.data().views || 0;
                // تحديث الرقم في الصفحة
                const el = document.getElementById(`vid-views-${postId}`);
                if (el) el.innerText = formatNumber(realViews);
            }
        } catch (e) { console.log(e); }
    }, 10000); 
}

// دالة توقف التحديث
function stopLiveViews() {
    if (viewUpdateInterval) {
        clearInterval(viewUpdateInterval);
        viewUpdateInterval = null;
    }
}
// --- إعدادات الاستيكرات ---
const stickerCollection = [
    "🤣", "😂", "😅", "🥹", "😍", "🥰", "😘", "🤪", 
    "😎", "😭", "😢", "😤", "😡", "🤬", "🤯", "😳", 
    "😱", "😴", "🤮", "🤡", "💀", "👻", "👽", "💩",
    "👍", "👎", "👌", "✌️", "❤️", "💔", "🔥", "✨"
];

let activeStickerContext = null; // عشان نعرف بنبعت فين (تعليق ولا رد)

// دالة فتح القائمة
function toggleStickerSheet(context) {
    activeStickerContext = context;
    const sheet = document.getElementById('stickerSheet');
    const overlay = document.getElementById('overlay');
    
    // تحميل الاستيكرات (لو لسه متحملتش)
    const grid = document.getElementById('stickersGrid');
    if (grid.childElementCount === 0) {
        stickerCollection.forEach(sticker => {
            const el = document.createElement('div');
            el.className = 'sticker-option';
            el.innerText = sticker;
            el.onclick = () => sendSticker(sticker);
            grid.appendChild(el);
        });
    }

    if (sheet.classList.contains('active')) {
        closeAllSheets(); // لو مفتوحة اقفلها
    } else {
        // 1. تجميد الخلفية
        document.body.classList.add('no-scroll');
        
        // 2. إظهار الـ Overlay (عشان لو ضغطت بره تقفل)
        overlay.style.display = 'block';
        
        // 3. فتح القائمة
        sheet.classList.add('active');

        // 4. إضافة خطوة في الهيستوري (عشان زر الرجوع في الموبايل يشتغل)
        window.history.pushState({sheetOpen: true}, "");
    }
}


// دالة إرسال الاستيكر
function sendSticker(sticker) {
    document.getElementById('stickerSheet').classList.remove('active'); // اقفل القائمة
    playSound('sent');

    if (activeStickerContext === 'main') {
        handleCommentAction(sticker, true); // ابعت للتعليقات
    } else {
        sendReplyToComment(sticker, true); // ابعت للردود
    }
}

// --- دوال المنشن (مهمة جداً عشان الكود ميقفش) ---
function setupMentionListener(inputId, dropdownContainerId) {
    const inp = document.getElementById(inputId);
    const drop = document.getElementById('mentionDropdown'); 
    if(!inp || !drop) return; // أمان عشان لو العناصر مش موجودة ميعملش خطأ

    inp.addEventListener('keyup', async (e) => {
        const val = inp.value;
        const cursorPosition = inp.selectionStart;
        const textBeforeCursor = val.substring(0, cursorPosition);
        const lastWord = textBeforeCursor.split(/(\s+)/).pop();

        if (lastWord.startsWith('@')) {
            const query = lastWord.substring(1);
            activeInputId = inputId;
            const wrapper = inp.parentElement.parentElement;
            if(!wrapper.contains(drop)) wrapper.insertBefore(drop, wrapper.firstChild);
            await searchAndShowMentions(query, drop);
        } else {
            drop.classList.remove('active');
        }
    });
}

// دالة البحث والعرض
async function searchAndShowMentions(queryText, dropdownEl) {
    dropdownEl.innerHTML = '<div style="padding:10px; text-align:center; color:#777"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
    dropdownEl.classList.add('active');
    try {
        let q = db.collection('users').orderBy('followersCount', 'desc').limit(10);
        const snap = await q.get();
        dropdownEl.innerHTML = '';
        if (snap.empty) { dropdownEl.classList.remove('active'); return; }

        snap.forEach(doc => {
            const d = doc.data();
            if (queryText === "" || d.name.toLowerCase().includes(queryText.toLowerCase())) {
                const item = document.createElement('div');
                item.className = 'mention-suggest-item';
                item.onclick = () => selectMention(d.uid, d.name, activeInputId);
                const verified = d.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#3897f0; font-size:12px;"></i>' : '';
                item.innerHTML = `
                    <div class="cm-avatar" style="width:35px; height:35px; ${d.profilePic ? `background-image:url('${d.profilePic}')` : `background:${generateColor(d.uid||'u')}`}">
                        ${d.profilePic ? '' : d.name[0]}
                    </div>
                    <div>
                        <div style="font-weight:bold; font-size:14px; color:var(--text-color)">${d.name} ${verified}</div>
                        <div style="font-size:11px; color:var(--secondary-text)">@${d.username || 'user'}</div>
                    </div>`;
                dropdownEl.appendChild(item);
            }
        });
        if (dropdownEl.children.length === 0) dropdownEl.classList.remove('active');
    } catch (e) { console.log(e); dropdownEl.classList.remove('active'); }
}

function selectMention(uid, name, inputId) {
    const inp = document.getElementById(inputId);
    const drop = document.getElementById('mentionDropdown');
    const cursor = inp.selectionStart;
    const text = inp.value;
    const before = text.substring(0, cursor);
    const after = text.substring(cursor);
    const lastAt = before.lastIndexOf('@');
    const newText = text.substring(0, lastAt) + name + " " + after;
    inp.value = newText; inp.focus();
    drop.classList.remove('active');
    if (typeof currentSubReplyTarget !== 'undefined') currentSubReplyTarget = { uid: uid, name: name };
    window.directMentionData = { uid: uid, name: name };
}
    // مستمع لزر الرجوع في الموبايل
window.addEventListener('popstate', function(event) {
    // لو فيه أي قائمة مفتوحة (استيكر أو تعليقات أو ردود)، اقفلها
    if (document.getElementById('stickerSheet').classList.contains('active') || 
        document.getElementById('cmSheet').classList.contains('active') ||
        document.getElementById('repliesSheet').classList.contains('active')) {
        
        // بنبعت true عشان الدالة تعرف إن ده زرار الرجوع ومتعملش مشاكل
        closeAllSheets(false, false, true); 
    }
});

        /* ========================================= */
    /* دالة الشير (توليد الرابط)                */
    /* ========================================= */
    function sharePost(pid) {
    playSound('click');
    
    // 1. تكوين الرابط الأصلي للمنشور
    const shareUrl = `${window.location.origin}${window.location.pathname}?uid=${profileUid}&post=${pid}`;

    // 2. محاولة المشاركة عبر نظام الهاتف أو نسخ الرابط
    if (navigator.share) {
        navigator.share({
            title: 'منشور مميز على NABD',
            text: 'شوف المنشور ده!',
            url: shareUrl
        }).then(() => {
            // ✅ 3. تسجيل "المشاركة" في سجل النشاطات بعد النجاح
            logActivity('share', `شاركت منشوراً`, pid, profileUid);
            showToast("تمت المشاركة بنجاح ✅");
        }).catch(() => {});
    } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
            // ✅ 4. تسجيل النشاط حتى في حالة النسخ (لأنها تعتبر مشاركة يدوية)
            logActivity('share', `شاركت رابط منشور (نسخ)`, pid, profileUid);
            showToast("تم نسخ رابط المنشور 🔗");
        });
    }
}

    // استبدل أي دالة openOptions موجودة بهذا الكود
async function openOptions(pid, uid, txt, ownerName) { 
    currentPostId = pid; 
    currentPostOwnerUid = uid;
    currentPostText = txt; 
    currentPostOwnerName = ownerName;

    // 1. إعادة تعيين شكل زر الحفظ للافتراضي (غير محفوظ)
    isCurrentPostSaved = false;
    document.getElementById('saveIcon').className = 'fa-regular fa-bookmark';
    document.getElementById('saveIcon').style.color = 'var(--text-color)';
    document.getElementById('saveText').innerText = 'حفظ المنشور';

    // 2. فتح القائمة
    document.getElementById('overlay').style.display = 'block'; 
    document.getElementById('optionsSheet').classList.add('active'); 

    // 3. إظهار/إخفاء الخيارات حسب المالك (تعديل/خصوصية أو إبلاغ)
    if (uid === currentUser.uid) {
        document.getElementById('ownerActions').style.display = 'block';
        document.getElementById('privacyOptions').style.display = 'block';
        document.getElementById('reportAction').style.display = 'none';
    } else {
        document.getElementById('ownerActions').style.display = 'none';
        document.getElementById('privacyOptions').style.display = 'none';
        document.getElementById('reportAction').style.display = 'flex';
    }

    // 4. الكشف في الداتابيز: هل المنشور محفوظ عندي؟
    try {
        const doc = await db.collection("users").doc(currentUser.uid)
                            .collection("savedPosts").doc(pid).get();
        if (doc.exists) {
            isCurrentPostSaved = true;
            document.getElementById('saveIcon').className = 'fa-solid fa-bookmark';
            document.getElementById('saveIcon').style.color = 'var(--primary-solid)';
            document.getElementById('saveText').innerText = 'إلغاء الحفظ';
        }
    } catch (e) { console.log("خطأ في التحقق من الحفظ", e); }
}

// --- متغيرات الشبح ---


// --- دالة تشغيل/إيقاف الوضع ---
async function toggleGhostMode() {
    const btn = document.getElementById('ghostBtn');
    
    // 1. عكس الحالة
    isGhost = !isGhost;

    // 2. تحديث الشكل محلياً (عشان يبقى سريع)
    if (isGhost) {
        // حالة التفعيل (لون أحمر + أيقونة جاسوس)
        btn.style.background = "#ff0000"; 
        btn.style.boxShadow = "0 0 20px #ff0000";
        btn.style.border = "2px solid #fff";
        btn.querySelector('i').className = "fa-solid fa-user-secret"; 
        
        playSound('success'); 
        showToast("🕵️ تم تفعيل وضع الشبح: أنت الآن 'مستخدم نبض'");
    } else {
        // حالة الإلغاء (رجوع للأصل)
        btn.style.background = ""; 
        btn.style.boxShadow = "";
        btn.style.border = "";
        btn.querySelector('i').className = "fa-solid fa-ghost";
        
        playSound('click');
        showToast("👤 تم كشف الهوية: عدت لاسمك الحقيقي");
    }

    // 3. تحديث قاعدة البيانات (عشان الرادار والناس التانية)
    if (currentUser) {
        try {
            await db.collection('users').doc(currentUser.uid).update({
                isGhost: isGhost,
                // بنمسح وقت الظهور عشان منظهرش أونلاين
                lastActive: isGhost ? null : firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error("فشل التحول لشبح:", e);
            showToast("❌ خطأ في الاتصال");
        }
    }
}

// --- دالة فحص الحالة عند فتح التطبيق ---
function checkGhostStatus() {
    if(!currentUser) return;
    
    db.collection('users').doc(currentUser.uid).get().then(doc => {
        if(doc.exists && doc.data().isGhost) {
            isGhost = true;
            const btn = document.getElementById('ghostBtn');
            if(btn) {
                // لو كان مفعل، نغير شكل الزرار فوراً
                btn.style.background = "#ff0000";
                btn.style.boxShadow = "0 0 20px #ff0000";
                btn.style.border = "2px solid #fff";
                btn.querySelector('i').className = "fa-solid fa-user-secret";
            }
        }
    });
}

// ==========================================
// 🛠️ دوال قائمة الخيارات وسجل النشاطات
// ==========================================

// 1. دالة فتح القائمة (بتحدد المحتوى حسب الشخص)
function showMoreOptions() {
    playSound('click');
    const sheet = document.getElementById('profileMenuSheet');
    const content = document.getElementById('profileMenuContent');
    
    // هل ده بروفايلي أنا؟
    const isMyProfile = (currentUser.uid === profileUid);

    content.innerHTML = ""; // تنظيف القديم

    if (isMyProfile) {
        // --- خياراتي أنا ---
        content.innerHTML = `
            <div class="sheet-option" onclick="openActivityLog()">
                <i class="fa-solid fa-clock-rotate-left" style="color:#00c6ff"></i> سجل النشاطات
            </div>
            <div class="sheet-option" onclick="location.href='settings.html'">
                <i class="fa-solid fa-gear"></i> إعدادات الحساب
            </div>
            <div class="sheet-option" onclick="copyProfileLink()">
                <i class="fa-solid fa-link"></i> نسخ رابط ملفي
            </div>
        `;
    } else {
        // --- خيارات الزائر ---
        content.innerHTML = `
            <div class="sheet-option" onclick="sendFriendRequestFromMenu()">
                <i class="fa-solid fa-user-plus" style="color:var(--success-color)"></i> إضافة صديق
            </div>
            
            <div class="sheet-option" onclick="sendPoke()">
                <i class="fa-solid fa-hand-point-up" style="color:#ffb533"></i> نكز (Poke) 👋
            </div>

            <div class="sheet-option" onclick="copyProfileLink()">
                <i class="fa-solid fa-link"></i> نسخ الرابط
            </div>

            <div class="sheet-option" onclick="openReportModal()" style="color:var(--danger-color)">
                <i class="fa-solid fa-triangle-exclamation"></i> إبلاغ عن المستخدم
            </div>

            <div class="sheet-option" onclick="blockUser()" style="color:var(--danger-color)">
                <i class="fa-solid fa-ban"></i> حظر المستخدم
            </div>
        `;
    }

    document.getElementById('overlay').style.display = 'block';
    sheet.classList.add('active');
}

// 2. دالة النكز (Poke)
// دالة النكز
async function sendPoke() {
    closeAllSheets();
    playSound('sent');
    pushNotification(profileUid, 'poke', 'قام بنكزك 👋', `profile.html?uid=${currentUser.uid}`);
    
    // تسجيل في السجل مع إرسال UID الشخص المنكوز
    logActivity('poke', `قمت بنكز ${document.getElementById('name').innerText}`, null, profileUid);
    
    showToast("تم إرسال النكزة 👋");
}


// 3. دالة الحظر (Block)
async function blockUser() {
    // 1. طلب تأكيد من المستخدم
    if(!confirm("هل أنت متأكد من حظر هذا المستخدم؟ لن تراه مجدداً ولن يتمكن من الوصول لملفك.")) return;
    
    closeAllSheets();
    try {
        // 2. تسجيل الحظر في قاعدة بيانات المستخدم الحالي
        await db.collection('users').doc(currentUser.uid).collection('blocked').doc(profileUid).set({
            uid: profileUid,
            name: document.getElementById('name').innerText,
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ✅ 3. تسجيل "الحظر" في سجل النشاطات الخاص بك
        logActivity('block', `قمت بحظر المستخدم: ${document.getElementById('name').innerText}`, null, profileUid);

        // 4. إظهار رسالة نجاح
        showToast("تم حظر المستخدم بنجاح 🚫");

        // 5. توجيه المستخدم للصفحة الرئيسية لأن الشخص ده مابقاش متاح
        setTimeout(() => location.href = 'home.html', 1500); 

    } catch(e) {
        console.error("خطأ في الحظر:", e);
        showToast("حدث خطأ أثناء محاولة الحظر");
    }
}


// 4. نسخ الرابط
function copyProfileLink() {
    closeAllSheets();
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => showToast("تم نسخ الرابط 🔗"));
}

// 5. ربط زر الصداقة بالقائمة
function sendFriendRequestFromMenu() {
    closeAllSheets();
    if(typeof sendRequest === 'function') sendRequest();
}

// ==========================================
// 📜 نظام سجل النشاطات (Activity Log)
// ==========================================

// أ) دالة التسجيل (بتحفظ الحركة في الداتابيز)
// دالة حفظ النشاط مع دعم صاحب المنشور للرابط
function logActivity(type, description, targetPostId = null, postOwnerId = null) {
    if (!currentUser) return;
    
    db.collection('users').doc(currentUser.uid).collection('activityLog').add({
        type: type, 
        description: description,
        targetPostId: targetPostId,    // آي دي المنشور
        postOwnerId: postOwnerId,      // آي دي صاحب المنشور (ضروري جداً للمعالجة)
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}

// ==========================================
// دالة عرض السجل (تم إصلاح خطأ actionUrl)
// ==========================================
function openActivityLog() {
    // 1. قفل القوائم وفتح الشيت
    closeAllSheets(); 
    const sheet = document.getElementById('activityLogSheet');
    const container = document.getElementById('activityLogList');
    
    document.getElementById('overlay').style.display = 'block';
    sheet.classList.add('active');
    
    container.innerHTML = '<div class="loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i> جاري تحميل السجل...</div>';

    // 2. جلب البيانات
    const logsRef = db.collection('users').doc(currentUser.uid).collection('activityLog');

    logsRef.orderBy('createdAt', 'desc').limit(30).get()
        .then(snap => {
            container.innerHTML = ""; 

            if (snap.empty) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#777;">
                        <i class="fa-solid fa-clipboard-list" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i><br>
                        لا يوجد نشاطات مسجلة بعد
                    </div>`;
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                let time = (d.createdAt && d.createdAt.toDate) ? moment(d.createdAt.toDate()).fromNow() : 'الآن';
                
                // --- تحديد الأيقونة واللون ---
                let icon = 'fa-circle'; 
                let color = '#777';

                if(d.type === 'like') { icon = 'fa-heart'; color = '#ff3b30'; }
                else if(d.type === 'comment') { icon = 'fa-comment'; color = '#00c6ff'; }
                else if(d.type === 'view') { icon = 'fa-eye'; color = '#34c759'; }
                else if(d.type === 'poke') { icon = 'fa-hand-point-up'; color = '#ffb533'; }
                else if(d.type === 'block') { icon = 'fa-ban'; color = '#ff3b30'; }
                else if(d.type === 'share') { icon = 'fa-share-nodes'; color = '#bf5af2'; }

                // --- 🔥 تصحيح الخطأ هنا: تعريف actionUrl ---
                let actionUrl = '#';
                // لو السجل فيه بيانات المنشور وصاحبه، بنعمل الرابط
                if (d.targetPostId && d.postOwnerId) {
                    actionUrl = `profile.html?uid=${d.postOwnerId}&post=${d.targetPostId}`;
                } 
                // دعم للأسماء القديمة لو موجودة (activityLog القديم)
                else if (d.postId && d.postOwnerUid) {
                    actionUrl = `profile.html?uid=${d.postOwnerUid}&post=${d.postId}`;
                }

                // رسم العنصر
                container.innerHTML += `
                    <div style="display:flex; align-items:center; gap:15px; padding:15px; border-bottom:1px solid var(--border-color); cursor:pointer;" 
                         onclick="${actionUrl !== '#' ? `location.href='${actionUrl}'` : "showToast('لا يمكن الوصول للمنشور')"}">
                        
                        <div style="width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.05); display:grid; place-items:center; flex-shrink:0;">
                            <i class="fa-solid ${icon}" style="color:${color}; font-size:18px;"></i>
                        </div>
                        
                        <div style="flex:1;">
                            <div style="font-size:14px; font-weight:bold; color:var(--text-color); margin-bottom:3px;">${d.description || d.detail || 'نشاط جديد'}</div>
                            <div style="font-size:11px; color:var(--secondary-text);">${time}</div>
                        </div>
                        
                        <div style="color:var(--secondary-text); font-size:12px;">
                            <i class="fa-solid fa-chevron-left"></i>
                        </div>
                    </div>
                `;
            });
        })
        .catch(error => {
            console.error(error);
            container.innerHTML = `<div style="text-align:center; padding:20px; color:red;">حدث خطأ في التحميل<br><small>${error.message}</small></div>`;
        });
}
// --- دوال التحكم في ظهور كرة اليورانيوم ---

// 1. دالة التشغيل عند التحميل (حطها في بداية التطبيق أو مع window.onload)
function initOrbState() {
    const isHidden = localStorage.getItem('nabd_orb_hidden') === 'true';
    const orb = document.getElementById('uraniumOrb');
    const toggle = document.getElementById('orbToggleSwitch');
    
    if (isHidden) {
        // لو محفوظ إنها مخفية -> اخفيها وطفي الزرار
        if(orb) orb.style.display = 'none';
        if(toggle) toggle.classList.remove('active');
        window.orbVisible = false; // نحدث متغير الفيزياء
    } else {
        // العكس
        if(orb) orb.style.display = 'flex';
        if(toggle) toggle.classList.add('active');
        window.orbVisible = true;
    }
}

// 2. دالة التبديل (لما يضغط على الزر)
function toggleOrbPreference() {
    playSound('click');
    const orb = document.getElementById('uraniumOrb');
    const toggle = document.getElementById('orbToggleSwitch');
    
    // بنشوف الحالة الحالية من الكلاس
    const isActive = toggle.classList.contains('active');
    
    if (isActive) {
        // هو شغال وعايز يطفيه
        toggle.classList.remove('active');
        orb.style.transition = '0.3s';
        orb.style.transform = 'scale(0)'; // انيميشن اختفاء
        setTimeout(() => orb.style.display = 'none', 300);
        
        localStorage.setItem('nabd_orb_hidden', 'true'); // حفظ الإخفاء
        showToast("تم إخفاء الكرة");
    } else {
        // هو مطفي وعايز يشغله
        toggle.classList.add('active');
        orb.style.display = 'flex';
        // استرجاع المكان الافتراضي
        orb.style.left = '20px';
        orb.style.top = (window.innerHeight - 100) + 'px';
        
        // انيميشن ظهور
        setTimeout(() => {
            orb.style.transform = 'scale(1)';
            orb.style.opacity = '1';
        }, 10);
        
        localStorage.setItem('nabd_orb_hidden', 'false'); // حفظ الظهور
        showToast("تم تفعيل الكرة");
    }
}

// 🔥 مهم جداً: استدعاء دالة التهيئة أول ما الصفحة تفتح
// ضيف السطر ده جوه auth.onAuthStateChanged أو في آخر السكريبت
initOrbState();


</script> 
    <div class="bottom-sheet" id="repliesSheet" style="height: 85vh; border-radius: 24px 24px 0 0;">
        <div class="sheet-handle"></div>
        <div class="cm-header">
            <i class="fa-solid fa-arrow-right" onclick="closeRepliesSheet()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
            <span style="flex:1; text-align:center;">الردود</span>
            <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
        </div>
        
        <div class="cm-body" id="repliesList" style="padding-bottom: 80px;">
            </div>
        
        <div class="cm-input-wrapper">
    <i class="fa-solid fa-face-laugh-beam sticker-trigger-btn" onclick="toggleStickerSheet('reply')"></i>

    <input type="text" class="cm-input" id="replyInput" placeholder="اكتب رداً..." autocomplete="off">
    <i class="fa-solid fa-paper-plane cm-send-btn" onclick="sendReplyToComment()"></i>
</div>

        </div>
    </div>
    <div class="custom-modal" id="editPostModal">
        <div class="modal-box">
            <h3>تعديل المنشور</h3>
            <textarea id="editPostInput" style="width:100%; height:120px; background:var(--input-bg); border:1px solid var(--border-color); color:var(--text-color); padding:10px; border-radius:10px; margin:15px 0; resize:none; outline:none; font-family:'Cairo';"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('editPostModal').style.display='none'">إلغاء</button>
                <button class="btn btn-primary" onclick="saveEditedPost()">حفظ التعديلات</button>
            </div>
        </div>
    </div>

    <div class="custom-modal" id="reportReasonModal">
        <div class="modal-box">
            <h3 style="color:var(--danger-color)">تقديم بلاغ</h3>
            <p style="color:var(--secondary-text); font-size:13px; margin-bottom:15px;">سيتم إرسال هذا البلاغ للإدارة للمراجعة</p>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button class="btn btn-secondary" onclick="submitReport('محتوى غير لائق')">🔞 محتوى غير لائق</button>
                <button class="btn btn-secondary" onclick="submitReport('خطاب كراهية أو تنمر')">🤬 خطاب كراهية / تنمر</button>
                <button class="btn btn-secondary" onclick="submitReport('احتيال أو نصب')">🚫 احتيال أو نصب</button>
                <button class="btn btn-secondary" onclick="submitReport('معلومات زائفة')">🤥 معلومات زائفة</button>
                <button class="btn btn-secondary" onclick="submitReport('آخر')">سبب آخر</button>
            </div>
            <button style="margin-top:15px; color:var(--secondary-text); font-size:12px;" onclick="document.getElementById('reportReasonModal').style.display='none'">تراجع</button>
        </div>
    </div>
<div class="bottom-sheet" id="replyOptionsSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    
    <div id="replyOwnerOptions" style="display:none;">
        <div class="c-option-item" onclick="triggerEditReplyAction()">
            <i class="fa-solid fa-pen"></i> تعديل الرد
        </div>
        <div class="c-option-item" onclick="triggerCopyReply()">
            <i class="fa-regular fa-copy"></i> نسخ النص
        </div>
        <div class="c-option-item danger" onclick="triggerDeleteReply()">
            <i class="fa-solid fa-trash"></i> حذف الرد
        </div>
    </div>

        <div id="replyViewerOptions" style="display:none;">
    <div class="c-option-item" onclick="triggerReplyToUser()" id="replyToUserBtn">
        <i class="fa-solid fa-reply"></i> رد
    </div>
    <div class="c-option-item" onclick="triggerCopyReply()">
        <i class="fa-regular fa-copy"></i> نسخ النص
    </div>
    <div class="c-option-item danger" onclick="reportComment()">
        <i class="fa-solid fa-triangle-exclamation"></i> إبلاغ
    </div>
</div>
    
    <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color)" onclick="closeAllSheets(true)">إلغاء</div>
</div>
<div class="custom-modal" id="chicConfirmModal" style="z-index: 9999;">
    <div class="modal-box" style="border: 1px solid var(--border-color); background: var(--card-color); max-width: 320px;">
        <div style="font-size: 40px; margin-bottom: 15px;" id="chicIcon"></div>
        <h3 id="chicTitle" style="margin-bottom: 10px; color: var(--text-color);">تأكيد</h3>
        <p id="chicMessage" style="color: var(--secondary-text); font-size: 14px; margin-bottom: 25px; line-height: 1.5;"></p>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeChicModal()" style="flex: 1;">إلغاء</button>
            <button class="btn btn-primary" id="chicConfirmBtn" style="flex: 1; background: var(--danger-color); box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3);">تأكيد</button>
        </div>
    </div>
</div>
<div class="bottom-sheet" id="stickerSheet" style="height: auto; max-height: 60vh; z-index: 250;">
    
    <i class="fa-solid fa-xmark sheet-close-btn" onclick="closeAllSheets()"></i>

    <div class="sheet-handle"></div>
    
    <div style="padding: 15px; text-align: center; font-weight: 800; border-bottom: 1px solid var(--border-color); color:var(--text-color)">
        استيكرات
    </div>

    <div class="stickers-grid" id="stickersGrid">
        </div>
</div>
<div class="bottom-sheet" id="profileMenuSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <div id="profileMenuContent" style="padding: 10px 0;">
        </div>
    <div style="padding:15px; text-align:center; color:var(--secondary-text); font-weight:600; cursor:pointer; border-top:1px solid var(--border-color)" onclick="closeAllSheets()">إلغاء</div>
</div>

<div class="bottom-sheet" id="activityLogSheet" style="height: 85vh;">
    <div class="sheet-handle"></div>
    <div class="cm-header">
        <span style="display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-clock-rotate-left" style="color:var(--primary-solid)"></i> سجل النشاطات
        </span>
        <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px"></i>
    </div>
    <div class="cm-body" id="activityLogList" style="padding: 0;">
        <div class="loading-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i> جاري تحميل السجل...</div>
    </div>
</div>
<div class="custom-modal" id="chicConfirmModal" style="z-index: 9999;">
    <div class="modal-box" style="border: 1px solid var(--border-color); background: var(--card-color); max-width: 320px;">
        <div style="font-size: 40px; margin-bottom: 15px;" id="chicIcon"></div>
        <h3 id="chicTitle" style="margin-bottom: 10px; color: var(--text-color);">تأكيد</h3>
        <p id="chicMessage" style="color: var(--secondary-text); font-size: 14px; margin-bottom: 25px; line-height: 1.5;"></p>
        
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeChicModal()" style="flex: 1;">إلغاء</button>
            <button class="btn btn-primary" id="chicConfirmBtn" style="flex: 1; background: var(--danger-color); box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3);">تأكيد</button>
        </div>
    </div>
</div>

</body>
</html>