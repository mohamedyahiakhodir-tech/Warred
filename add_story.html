<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Story Studio Pro | Nabd</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Tajawal:wght@500;800&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root { 
            --primary: #00f2ea; 
            --secondary: #ff0050;
            --bg-dark: #000000;
            --surface: #121212; 
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        
        * { 
            box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent; user-select: none; 
            -webkit-font-smoothing: antialiased; outline: none;
        }

        body { 
            background-color: #000; height: 100vh; width: 100vw; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .app-container { 
            width: 100%; height: 100%; position: relative; background: #000; 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        @media (min-width: 500px) {
            .app-container { width: 420px; height: 90vh; border-radius: 30px; border: 1px solid #333; }
        }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0; height: calc(60px + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            display: flex; justify-content: space-between; align-items: center; padding-left: 20px; padding-right: 20px;
            z-index: 100; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%);
            opacity: 0; pointer-events: none; transition: 0.4s ease;
        }
        
        .icon-btn { 
            color: white; font-size: 20px; width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            transition: 0.2s; cursor: pointer;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .top-actions { display: flex; gap: 10px; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ù… (Ø§Ù„ØµÙˆØ±) */
        .canvas-area { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #000; }
        
        /* === Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© === */
        .video-area {
            flex: 1; position: relative; overflow: hidden; display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ */
            align-items: center; justify-content: center; background-color: #000;
        }
        
        #mainVideoPlayer {
            width: 100%; height: 100%; object-fit: contain; z-index: 1;
            transition: filter 0.3s ease;
        }
        /* ÙƒØ§Ù†ÙØ§Ø³ Ø´ÙØ§Ù ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ù†ØµÙˆØµ */
        #videoOverlayCanvasContainer {
            position: absolute; inset: 0; z-index: 10; pointer-events: auto;
        }
        
        /* Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª */
        .trash-bin { 
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(150px); 
            width: 55px; height: 55px; background: rgba(30,30,30,0.9); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            color: #ff4d4d; font-size: 22px; z-index: 100; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: none; 
        }
        .trash-bin.visible { transform: translateX(-50%) translateY(0); }
        .trash-bin.active { transform: translateX(-50%) scale(1.2); background: #ff2c2c; color: white; border-color: transparent; }

        /* Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
        .center-line-v, .center-line-h { position: absolute; background-color: var(--primary); z-index: 90; display: none; pointer-events: none; box-shadow: 0 0 8px var(--primary); opacity: 0.8; }
        .center-line-v { width: 1px; height: 100%; top: 0; left: 50%; }
        .center-line-h { height: 1px; width: 100%; top: 50%; left: 0; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        .start-screen { 
            position: absolute; inset: 0; background: #101010; z-index: 200; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: white; transition: 0.5s ease; gap: 25px; 
        }
        .start-title { font-size: 28px; font-weight: 900; background: linear-gradient(45deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .start-options { display: flex; gap: 20px; }
        
        .upload-circle { 
            width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, #222, #111);
            border: 2px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 24px; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: pointer; position: relative;
            gap: 5px; transition: 0.2s;
        }
        .upload-circle:active { transform: scale(0.95); }
        .upload-circle span { font-size: 10px; font-weight: bold; color: #aaa; }
        
        /* ØªÙ„ÙˆÙŠÙ† Ø²Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        .upload-circle.video-btn::after { content: ''; position: absolute; inset: -3px; border-radius: 50%; background: linear-gradient(45deg, #ff0050, #ff8c00); z-index: -1; opacity: 0.8; }
        .upload-circle.photo-btn::after { content: ''; position: absolute; inset: -3px; border-radius: 50%; background: linear-gradient(45deg, #00f2ea, #0050ff); z-index: -1; opacity: 0.8; }

        .gradient-btn { background: rgba(255,255,255,0.08); padding: 14px 28px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 15px; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { 
            position: absolute; top: 80px; left: 15px; z-index: 50; display: flex; flex-direction: column; gap: 18px; 
            padding: 15px 10px; background: rgba(0,0,0,0.4); border-radius: 30px; border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(12px); opacity: 0; pointer-events: none; transform: translateX(-20px); transition: 0.4s;
        }
        .tool-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .tool-icon { width: 40px; height: 40px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 19px; transition: 0.2s; }
        .tool-label { color: rgba(255,255,255,0.8); font-size: 10px; font-weight: 600; }
        .tool-icon.active { color: var(--primary); text-shadow: 0 0 10px rgba(0, 242, 234, 0.5); }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ±Ø´Ø§Ø© */
        .brush-controls {
            position: absolute; top: 80px; left: 85px; z-index: 55; background: rgba(20,20,20,0.9); backdrop-filter: blur(15px);
            border-radius: 16px; padding: 12px; display: none; flex-direction: column; gap: 12px; border: 1px solid rgba(255,255,255,0.1);
        }
        .brush-controls.active { display: flex; }
        .brush-option { width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #aaa; }
        .brush-option.selected { background: var(--primary); color: #000; }

        /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-tools { 
            position: absolute; bottom: 90px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 12px; 
            z-index: 45; opacity: 0; pointer-events: none; transform: translateY(20px); transition: 0.4s ease;
        }
        .color-palette { background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); padding: 8px 15px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; align-items: center; }
        .color-circle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: 0.2s; }
        .color-circle.active { transform: scale(1.3); border-color: white; z-index: 2; }
        .action-btn-small { width: 38px; height: 38px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª */
        .sticker-panel { 
            position: absolute; bottom: 0; left: 0; right: 0; height: 60vh; background: #181818; border-radius: 25px 25px 0 0; 
            z-index: 60; padding: 20px; display: flex; flex-direction: column; gap: 20px; transform: translateY(110%); 
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .sticker-panel.show { transform: translateY(0); }
        .drag-handle { width: 40px; height: 5px; background: #333; border-radius: 3px; align-self: center; margin-bottom: 5px; }
        .smart-stickers { display: flex; gap: 12px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .smart-tag { 
            background: linear-gradient(135deg, #2a2a2a, #222); border: 1px solid #333; color: white; padding: 10px 18px; 
            border-radius: 12px; font-size: 13px; font-weight: 600; white-space: nowrap; display: flex; align-items: center; gap: 8px; cursor: pointer; 
        }
        .smart-tag i { color: var(--primary); }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; overflow-y: auto; padding-bottom: 20px; }
        .emoji-item { font-size: 32px; text-align: center; cursor: pointer; }

        /* Ø§Ù„ÙÙˆØªØ± */
        .footer { 
            position: absolute; bottom: 0; left: 0; right: 0; padding: 20px 25px calc(20px + var(--safe-area-bottom)); 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; justify-content: space-between; align-items: center; 
            z-index: 50; opacity: 0; pointer-events: none; transition: 0.4s; 
        }
        .publish-btn { 
            background: white; color: black; border: none; padding: 12px 28px; border-radius: 30px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 20px rgba(255,255,255,0.15); cursor: pointer;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø´Ø± */
        .publish-modal {
            position: absolute; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-radius: 30px 30px 0 0;
            z-index: 250; padding: 25px 25px calc(25px + var(--safe-area-bottom)); transform: translateY(110%); 
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); display: flex; flex-direction: column; gap: 20px;
            box-shadow: 0 -20px 50px rgba(0,0,0,0.6); border-top: 1px solid #333;
        }
        .publish-modal.active { transform: translateY(0); }
        .story-preview-row { display: flex; gap: 15px; align-items: flex-start; background: #222; padding: 10px; border-radius: 15px; }
        .mini-preview { width: 70px; height: 100px; object-fit: cover; border-radius: 10px; background: #000; border: 1px solid #333; }
        .caption-input { flex: 1; background: transparent; border: none; color: white; font-size: 14px; resize: none; height: 100px; padding: 5px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #2a2a2a; }
        .setting-label { color: #eee; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 12px; }
        .setting-select { background: transparent; color: var(--primary); border: none; font-family: 'Cairo'; font-weight: 700; cursor: pointer; direction: rtl; font-size: 13px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #383838; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }
        .final-actions { display: flex; gap: 12px; margin-top: 15px; }
        .btn-cancel { flex: 1; padding: 14px; border-radius: 12px; border: none; background: #2a2a2a; color: #aaa; font-weight: bold; cursor: pointer; }
        .btn-share { flex: 2; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(90deg, var(--primary), #20b2aa); color: #000; font-weight: 800; cursor: pointer; box-shadow: 0 5px 20px rgba(47, 224, 216, 0.3); }
        .upload-progress-container { margin-top: 15px; display: none; }
        .progress-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--primary); transition: 0.3s; }
        .progress-text { color: #888; font-size: 12px; margin-top: 8px; text-align: center; }

        .loader { position: absolute; inset: 0; background: #000; z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader i { color: var(--secondary); font-size: 60px; animation: heartbeat 1s infinite; filter: drop-shadow(0 0 20px var(--secondary)); }
        
        .ui-active { opacity: 1 !important; pointer-events: auto !important; transform: none !important; }
        
        /* Map Styles */
        .map-modal-container { position: absolute; inset: 0; z-index: 350; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: flex-end; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .map-modal-container.active { display: flex; opacity: 1; }
        .map-card { width: 100%; height: 85vh; background: #fff; border-radius: 25px 25px 0 0; overflow: hidden; display: flex; flex-direction: column; position: relative; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.8); }
        .map-modal-container.active .map-card { transform: translateY(0); }
        .map-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #ffffff; border-bottom: 1px solid #eee; color: black; }
        .map-title { font-weight: 800; color: #333; font-size: 16px; }
        .map-close-btn { color: #555; font-size: 20px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .map-body { flex: 1; position: relative; background: #eee; }
        #leafletMap { width: 100%; height: 100%; z-index: 1; outline: none; }
        .map-confirm-btn { position: absolute; bottom: 30px; left: 20px; right: 20px; background: linear-gradient(90deg, #ff0050, #00f2ea); color: white; padding: 15px; border-radius: 15px; border: none; font-weight: 800; font-size: 16px; box-shadow: 0 10px 25px rgba(0, 242, 234, 0.3); z-index: 400; cursor: pointer; text-align: center; transition: 0.2s; }
        .map-confirm-btn:active { transform: scale(0.98); }
        .map-location-preview { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 10px; color: #333; font-size: 13px; font-weight: bold; z-index: 400; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; pointer-events: none; }
        .map-location-preview i { color: #ff0050; }
        .leaflet-container { font-family: 'Cairo' !important; }

        @keyframes heartbeat { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.15); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="top-bar" id="topBar">
            <div class="icon-btn" onclick="clearCanvasConfirm()"><i class="fa-solid fa-xmark"></i></div>
            <div class="top-actions">
                <div class="icon-btn" onclick="undo()" id="undoBtn" style="opacity: 0.5;"><i class="fa-solid fa-rotate-left"></i></div>
                <div class="icon-btn" onclick="redo()" id="redoBtn" style="opacity: 0.5;"><i class="fa-solid fa-rotate-right"></i></div>
            </div>
        </div>

        <div class="canvas-area" id="canvasContainer">
            <div class="center-line-v" id="vLine"></div>
            <div class="center-line-h" id="hLine"></div>
            <canvas id="c"></canvas>
            <div class="trash-bin" id="trashBin"><i class="fa-solid fa-trash-can"></i></div>
        </div>

        <div class="video-area" id="videoContainer">
            <video id="mainVideoPlayer" loop playsinline autoplay></video>
            <div id="videoOverlayCanvasContainer">
                <canvas id="videoC"></canvas>
            </div>
        </div>

        <div class="start-screen" id="startScreen">
            <h2 class="start-title">Ø§Ø¨ØªÙƒØ± Ù‚ØµØªÙƒ</h2>
            
            <div class="start-options">
                <label class="upload-circle photo-btn">
                    <i class="fa-solid fa-camera"></i>
                    <span>ØµÙˆØ±Ø©</span>
                    <input type="file" id="imgLoader" accept="image/*" hidden>
                </label>

                <label class="upload-circle video-btn">
                    <i class="fa-solid fa-video"></i>
                    <span>ÙÙŠØ¯ÙŠÙˆ</span>
                    <input type="file" id="videoLoader" accept="video/*" hidden>
                </label>
            </div>

            <div class="gradient-btn" onclick="startWithGradient()">
                <div style="width:24px; height:24px; border-radius:50%; background:linear-gradient(45deg, #FF0050, #00f2ea); box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
                <span>Ø®Ù„ÙÙŠØ© Ù…Ù„ÙˆÙ†Ø©</span>
            </div>
            <div id="archiveBtn" class="gradient-btn" onclick="loadDraft()" style="display: none; background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1);">
                <i class="fa-solid fa-box-archive" style="color: #bbb;"></i>
                <span>Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ø³ÙˆØ¯Ø©</span>
            </div>
        </div>

        <div class="brush-controls" id="brushControls">
            <div class="brush-option selected" onclick="changeBrush('pencil', this)"><i class="fa-solid fa-pen"></i></div>
            <div class="brush-option" onclick="changeBrush('neon', this)"><i class="fa-solid fa-highlighter"></i></div>
            <div class="brush-option" onclick="changeBrush('spray', this)"><i class="fa-solid fa-spray-can"></i></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="tool-item" onclick="addText()"><div class="tool-icon"><i class="fa-solid fa-font"></i></div><span class="tool-label">Ù†Øµ</span></div>
            
            <div class="tool-item" id="drawToolItem" onclick="toggleDrawMode(this)"><div class="tool-icon" id="drawBtn"><i class="fa-solid fa-pen-nib"></i></div><span class="tool-label">Ø±Ø³Ù…</span></div>
            
            <div class="tool-item" onclick="toggleStickers()"><div class="tool-icon"><i class="fa-regular fa-face-smile"></i></div><span class="tool-label">Ù…Ù„ØµÙ‚</span></div>
            
            <div class="tool-item" onclick="applyFilter()"><div class="tool-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div><span class="tool-label">ÙÙ„ØªØ±</span></div>
            
            <div class="tool-item" onclick="downloadImage()"><div class="tool-icon"><i class="fa-solid fa-download"></i></div><span class="tool-label">Ø­ÙØ¸</span></div>
            <div style="width: 25px; height: 1px; background: rgba(255,255,255,0.15); margin: 2px 0;"></div>
            <div class="tool-item" onclick="moveLayer('up')"><div class="tool-icon"><i class="fa-solid fa-arrow-up-from-bracket"></i></div><span class="tool-label">Ø·Ø¨Ù‚Ø§Øª</span></div>
        </div>

        <div class="bottom-tools" id="colorTools">
            <div class="action-btn-small" id="fontChangeBtn" onclick="cycleFonts()" style="display:none;"><i class="fa-solid fa-text-height"></i></div>
            <div class="action-btn-small" id="textStyleBtn" onclick="toggleTextStyle()"><i class="fa-solid fa-fill-drip"></i></div>
            <div class="color-palette">
                <div class="color-circle" style="background: #ffffff;" onclick="setColor('#ffffff')"></div>
                <div class="color-circle" style="background: #000000;" onclick="setColor('#000000')"></div>
                <div class="color-circle" style="background: #ff0050;" onclick="setColor('#ff0050')"></div>
                <div class="color-circle" style="background: #00f2ea;" onclick="setColor('#00f2ea')"></div>
                <div class="color-circle" style="background: #ffe600;" onclick="setColor('#ffe600')"></div>
                <div class="color-circle" style="background: #8e44ad;" onclick="setColor('#8e44ad')"></div>
            </div>
        </div>

        <div class="sticker-panel" id="stickerPanel">
            <div class="drag-handle"></div>
            <div style="font-size: 14px; color: #888; font-weight: bold;">Ø£Ø¯ÙˆØ§Øª Ø°ÙƒÙŠØ©</div>
            <div class="smart-stickers">
                <div class="smart-tag" onclick="addDateSticker()"><i class="fa-regular fa-clock"></i> <span id="timeNow">--:--</span></div>
                <div class="smart-tag" onclick="openMapSelector()"><i class="fa-solid fa-location-dot"></i> Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                <div class="smart-tag" onclick="addTextSticker('@mention')"><i class="fa-solid fa-at"></i> Ø°ÙƒØ±</div>
                <div class="smart-tag" onclick="addMusicSticker()"><i class="fa-solid fa-music"></i> Ù…ÙˆØ³ÙŠÙ‚Ù‰</div>
                <div class="smart-tag" onclick="addPollSticker()"><i class="fa-solid fa-square-poll-vertical"></i> ØªØµÙˆÙŠØª</div>
            </div>
            <div style="font-size: 14px; color: #888; font-weight: bold; margin-top: 10px;">Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</div>
            <div class="emoji-grid">
                <div class="emoji-item" onclick="addEmoji('ğŸ”¥')">ğŸ”¥</div>
                <div class="emoji-item" onclick="addEmoji('â¤ï¸')">â¤ï¸</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ˜')">ğŸ˜</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ‰')">ğŸ‰</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ˜')">ğŸ˜</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ‘')">ğŸ‘</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ‘‘')">ğŸ‘‘</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ‘»')">ğŸ‘»</div>
                <div class="emoji-item" onclick="addEmoji('ğŸ’¯')">ğŸ’¯</div>
            </div>
        </div>

        <div class="map-modal-container" id="mapModal">
            <div class="map-card">
                <div class="map-header">
                    <div class="map-close-btn" onclick="closeMapSelector()"><i class="fa-solid fa-xmark"></i></div>
                    <div class="map-title">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                    <div style="width: 30px;"></div>
                </div>
                <div class="map-body">
                    <div class="map-location-preview" id="mapLocationText"><i class="fa-solid fa-location-arrow"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙƒØ§Ù†...</div>
                    <div id="leafletMap"></div>
                </div>
                <button class="map-confirm-btn" onclick="confirmMapSelection()">ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
            </div>
        </div>

        <div class="footer" id="footer">
            <button class="tool-icon" style="width: 45px; height: 45px; background: rgba(255,255,255,0.1); border:none;" onclick="location.href='home.html'"><i class="fa-solid fa-chevron-right"></i></button>
            <button class="publish-btn" onclick="publishStory()">
                <span>Ù†Ø´Ø± Ù‚ØµØªÙƒ</span>
                <i class="fa-solid fa-arrow-left" style="font-size: 14px;"></i>
            </button>
        </div>

        <div class="loader" id="loader"><i class="fa-solid fa-heart"></i></div>

        <div class="publish-modal" id="publishModal">
            <div class="drag-handle"></div>
            <div class="story-preview-row">
                <img id="miniPreviewImg" class="mini-preview" src="">
                <textarea id="storyCaption" class="caption-input" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..."></textarea>
            </div>
            <div class="setting-row">
                <div class="setting-label"><i class="fa-solid fa-earth-americas"></i> Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø±Ø¤ÙŠØ©</div>
                <select id="storyPrivacy" class="setting-select"><option value="public">Ø§Ù„Ø¬Ù…ÙŠØ¹</option><option value="friends">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</option><option value="private">Ø£Ù†Ø§ ÙÙ‚Ø·</option></select>
            </div>
            <div class="setting-row">
                <div class="setting-label"><i class="fa-regular fa-comment-dots"></i> Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø±Ø¯ÙˆØ¯</div>
                <label class="switch"><input type="checkbox" id="allowReplies" checked onchange="playSound('toggle')"><span class="slider round"></span></label>
            </div>
            <div class="setting-row" style="border-bottom: none;">
                <div class="setting-label"><i class="fa-solid fa-download"></i> Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                <label class="switch"><input type="checkbox" id="saveToGallery" checked onchange="playSound('toggle')"><span class="slider round"></span></label>
            </div>
            <div class="upload-progress-container" id="uploadProgress">
                <div class="progress-bar-bg"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
            </div>
            <div class="final-actions" id="actionButtons">
                <button class="btn-cancel" onclick="closePublishModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn-share" onclick="confirmUpload()">Ù…Ø´Ø§Ø±ÙƒØ©</button>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c", 
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();
        const db = firebase.firestore();

        // === Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙˆØ§Øª ===
        const audioSystem = {
            click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
            toggle: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            delete: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'),
            success: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3')
        };
        function playSound(type) {
            if (audioSystem[type]) {
                const sound = audioSystem[type].cloneNode(); 
                sound.volume = (type === 'success') ? 1.0 : 0.4;
                sound.play().catch(() => {}); 
            }
        }

        window.addEventListener('load', () => {
            const clickable = document.querySelectorAll('button, .icon-btn, .tool-item, .color-circle, .smart-tag, .btn-cancel, .btn-share, .gradient-btn, .emoji-item, .map-confirm-btn');
            clickable.forEach(el => el.addEventListener('click', () => playSound('click')));
            if(localStorage.getItem('nabd_story_draft')) {
                const archiveBtn = document.getElementById('archiveBtn');
                if(archiveBtn) archiveBtn.style.display = 'flex';
            }
        });

        // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ (ØµÙˆØ±Ø©) ===
        const container = document.getElementById('canvasContainer');
        const trashBin = document.getElementById('trashBin');
        const vLine = document.getElementById('vLine');
        const hLine = document.getElementById('hLine');
        let currentMode = 'photo'; // 'photo' or 'video'

        fabric.Object.prototype.set({
            transparentCorners: false, cornerColor: '#ffffff', cornerStrokeColor: '#000000',
            borderColor: '#00f2ea', cornerSize: 12, padding: 8, cornerStyle: 'circle', 
            borderDashArray: [4, 4], touchCornerSize: 30
        });
        fabric.Object.prototype.controls.mtr.offsetY = -35;
        fabric.Object.prototype.controls.mtr.withConnection = false;

        // Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØµÙˆØ±
        const canvas = new fabric.Canvas('c', {
            width: container.clientWidth, height: container.clientHeight, backgroundColor: '#000', preserveObjectStacking: true
        });

        // ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ù„Ø´ÙØ§ÙÙŠØ©)
        let videoCanvas = null;

        // === Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙˆØ§Ù„Ø­ÙØ¸ ===
        let history = []; let historyStep = -1; let isHistoryProcessing = false;
        function saveHistory() {
            if (isHistoryProcessing || currentMode === 'video') return; // Ù„Ø§ ØªØ±Ø§Ø¬Ø¹ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ØªØ¨Ø³ÙŠØ·
            if(historyStep < history.length - 1) history = history.slice(0, historyStep + 1);
            history.push(JSON.stringify(canvas));
            historyStep++;
            if(history.length > 15) { history.shift(); historyStep--; }
            updateUndoRedoUI();
            localStorage.setItem('nabd_story_draft', JSON.stringify(canvas));
        }
        function undo() { 
            if(currentMode === 'video') return;
            playSound('toggle'); if (historyStep > 0) { isHistoryProcessing = true; historyStep--; canvas.loadFromJSON(history[historyStep], function() { canvas.renderAll(); isHistoryProcessing = false; updateUndoRedoUI(); }); } 
        }
        function redo() { 
            if(currentMode === 'video') return;
            playSound('toggle'); if (historyStep < history.length - 1) { isHistoryProcessing = true; historyStep++; canvas.loadFromJSON(history[historyStep], function() { canvas.renderAll(); isHistoryProcessing = false; updateUndoRedoUI(); }); } 
        }
        function updateUndoRedoUI() { document.getElementById('undoBtn').style.opacity = historyStep > 0 ? '1' : '0.5'; document.getElementById('redoBtn').style.opacity = historyStep < history.length - 1 ? '1' : '0.5'; }
        
        canvas.on('object:added', () => { if(!isHistoryProcessing) saveHistory(); });
        canvas.on('object:modified', () => { if(!isHistoryProcessing) saveHistory(); });
        canvas.on('object:removed', () => { playSound('delete'); if(!isHistoryProcessing) saveHistory(); });

        function loadDraft() {
            const draft = localStorage.getItem('nabd_story_draft');
            if(draft) {
                currentMode = 'photo';
                isHistoryProcessing = true;
                canvas.loadFromJSON(draft, function() { canvas.renderAll(); isHistoryProcessing = false; showUI(); saveHistory(); });
                document.getElementById('startScreen').style.opacity = '0';
                setTimeout(() => document.getElementById('startScreen').style.display = 'none', 500);
            }
        }
        function clearCanvasConfirm() {
            playSound('toggle');
            Swal.fire({
                title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…ØŸ', text: "Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ff2c55', cancelButtonColor: '#333', background: '#222', color: '#fff', confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø®Ø±ÙˆØ¬', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) { 
                    canvas.clear(); 
                    if(videoCanvas) videoCanvas.clear();
                    localStorage.removeItem('nabd_story_draft'); 
                    history = []; historyStep = -1; 
                    location.reload(); 
                }
            })
        }

        let mainImage = null; let currentColor = '#ffffff'; let currentStoryBlob = null; let wasSnapped = false;
        
        // Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ù†Ø´Ø· (ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ)
        function getActiveCanvas() {
            return (currentMode === 'video') ? videoCanvas : canvas;
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ±
        function setupCanvasListeners(c) {
            c.on('object:moving', function(e) {
                const obj = e.target; const canvasCenter = c.getCenter(); let snapped = false;
                if (Math.abs(obj.left - canvasCenter.left) < 15) { obj.set({ left: canvasCenter.left }); if(currentMode === 'photo') vLine.style.display = 'block'; snapped = true; } else { vLine.style.display = 'none'; }
                if (Math.abs(obj.top - canvasCenter.top) < 15) { obj.set({ top: canvasCenter.top }); if(currentMode === 'photo') hLine.style.display = 'block'; snapped = true; } else { hLine.style.display = 'none'; }
                if(snapped && !wasSnapped) { if (navigator.vibrate) navigator.vibrate(20); wasSnapped = true; } else if (!snapped) { wasSnapped = false; }
                
                // Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª
                trashBin.classList.add('visible'); 
                const trashX = c.width / 2;
                if (obj.top > c.height - 120 && Math.abs(obj.left - trashX) < 60) { 
                    trashBin.classList.add('active'); obj.set('opacity', 0.5); if(navigator.vibrate) navigator.vibrate(40); 
                } else { 
                    trashBin.classList.remove('active'); obj.set('opacity', 1); 
                }
            });
            c.on('object:modified', function(e) { vLine.style.display = 'none'; hLine.style.display = 'none'; trashBin.classList.remove('visible'); if (trashBin.classList.contains('active')) { c.remove(e.target); trashBin.classList.remove('active'); } });
            
            c.on('selection:cleared', () => { if (!c.isDrawingMode) { document.getElementById('colorTools').classList.remove('ui-active'); document.getElementById('textStyleBtn').style.display = 'none'; document.getElementById('fontChangeBtn').style.display = 'none'; } });
            c.on('selection:created', (e) => handleSelection(e));
            c.on('selection:updated', (e) => handleSelection(e));
        }

        setupCanvasListeners(canvas);

        // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ===
        document.getElementById('imgLoader').onchange = function(e) {
            currentMode = 'photo';
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgObj = new Image(); imgObj.src = event.target.result;
                imgObj.onload = function() {
                    const imgInstance = new fabric.Image(imgObj);
                    const scaleX = canvas.width / imgInstance.width; const scaleY = canvas.height / imgInstance.height; const scale = Math.max(scaleX, scaleY);
                    imgInstance.set({ scaleX: scale, scaleY: scale, left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center', selectable: false });
                    mainImage = imgInstance; canvas.add(imgInstance); canvas.sendToBack(imgInstance);
                    document.getElementById('startScreen').style.opacity = '0'; setTimeout(() => document.getElementById('startScreen').style.display = 'none', 500); showUI(); saveHistory();
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯) ===
        let currentVideoFile = null;
        let currentVideoFilterIndex = 0;
        const videoFilters = ['none', 'grayscale(100%)', 'sepia(50%) contrast(1.1)', 'brightness(1.1) contrast(1.2) saturate(1.3) sepia(20%)', 'hue-rotate(90deg) contrast(1.5)'];
        // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ±: Ø¹Ø§Ø¯ÙŠØŒ Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯ØŒ ÙÙŠÙ†ØªØ§Ø¬ØŒ Ø¯Ø§ÙØ¦ØŒ Ø³Ø§ÙŠØ¨Ø±

        document.getElementById('videoLoader').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            currentMode = 'video';
            currentVideoFile = file;

            // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            document.getElementById('canvasContainer').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'flex';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙˆØ§Ù„Ø±Ø³Ù…
            document.getElementById('undoBtn').style.display = 'none';
            document.getElementById('redoBtn').style.display = 'none';
            document.getElementById('drawToolItem').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±Ø³Ù…

            const videoEl = document.getElementById('mainVideoPlayer');
            videoEl.src = URL.createObjectURL(file);
            videoEl.play();

            // ØªÙ‡ÙŠØ¦Ø© ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´ÙØ§Ù
            const videoContainer = document.getElementById('videoContainer');
            videoCanvas = new fabric.Canvas('videoC', {
                width: videoContainer.clientWidth, height: videoContainer.clientHeight, backgroundColor: null // Ø´ÙØ§Ù
            });
            setupCanvasListeners(videoCanvas); // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø±ÙŠÙƒ ÙˆØ§Ù„Ø­Ø°Ù

            document.getElementById('startScreen').style.opacity = '0'; 
            setTimeout(() => document.getElementById('startScreen').style.display = 'none', 500); 
            showUI();
        }

        function startWithGradient() {
            currentMode = 'photo';
            const grad = new fabric.Gradient({ type: 'linear', coords: { x1: 0, y1: 0, x2: canvas.width, y2: canvas.height }, colorStops: [ { offset: 0, color: '#4158D0' }, { offset: 0.5, color: '#C850C0' }, { offset: 1, color: '#FFCC70' } ] });
            canvas.setBackgroundColor(grad, canvas.renderAll.bind(canvas));
            document.getElementById('startScreen').style.opacity = '0'; setTimeout(() => document.getElementById('startScreen').style.display = 'none', 500); showUI(); saveHistory();
        }
        function showUI() { document.getElementById('sidebar').classList.add('ui-active'); document.getElementById('footer').classList.add('ui-active'); document.getElementById('topBar').classList.add('ui-active'); }
        
        // === Ø§Ù„Ø£Ø¯ÙˆØ§Øª ===
        function addText() { 
            disableDrawMode(); 
            const targetCanvas = getActiveCanvas();
            const text = new fabric.IText('Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹', { left: targetCanvas.width / 2, top: targetCanvas.height / 2, fontFamily: 'Cairo', fill: currentColor, fontSize: 40, originX: 'center', originY: 'center', fontWeight: '800', textAlign: 'center', shadow: 'rgba(0,0,0,0.5) 2px 2px 5px', customStyleID: 0, customFontID: 0 }); 
            targetCanvas.add(text); targetCanvas.setActiveObject(text); document.getElementById('colorTools').classList.add('ui-active'); 
        }

        const fontFamilies = ['Cairo', 'Tajawal', 'Amiri'];
        function cycleFonts() { 
            const targetCanvas = getActiveCanvas();
            const obj = targetCanvas.getActiveObject(); if (!obj || !obj.type.includes('text')) return; let f = obj.customFontID || 0; f = (f + 1) % fontFamilies.length; obj.customFontID = f; obj.set('fontFamily', fontFamilies[f]); targetCanvas.requestRenderAll(); 
        }

        function toggleTextStyle() { 
            const targetCanvas = getActiveCanvas();
            const obj = targetCanvas.getActiveObject(); if (!obj || !obj.type.includes('text')) return; let s = obj.customStyleID || 0; s = (s + 1) % 5; obj.customStyleID = s; obj.set({ backgroundColor: '', shadow: '', stroke: '', strokeWidth: 0, fill: currentColor }); if (s === 0) { obj.set({ shadow: 'rgba(0,0,0,0.5) 2px 2px 5px' }); } else if (s === 1) { obj.set({ backgroundColor: currentColor, fill: (currentColor === '#ffffff') ? '#000000' : '#ffffff', padding: 8 }); } else if (s === 2) { obj.set({ backgroundColor: 'rgba(0,0,0,0.5)', fill: '#ffffff', padding: 8 }); } else if (s === 3) { obj.set({ shadow: `${currentColor} 0 0 15px`, stroke: currentColor, strokeWidth: 1, fill: '#ffffff' }); } else if (s === 4) { obj.set({ stroke: currentColor, strokeWidth: 2, fill: 'transparent', shadow: new fabric.Shadow({ color: currentColor, blur: 15 }) }); } targetCanvas.renderAll(); 
        }

        function toggleDrawMode(btn) { 
            if(currentMode === 'video') return; // Ø§Ù„Ø±Ø³Ù… ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            canvas.isDrawingMode = !canvas.isDrawingMode; const icon = document.getElementById('drawBtn'); const brushControls = document.getElementById('brushControls'); if (canvas.isDrawingMode) { icon.parentElement.classList.add('active'); brushControls.classList.add('active'); if(!canvas.freeDrawingBrush) canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); canvas.freeDrawingBrush.width = 8; canvas.freeDrawingBrush.color = currentColor; canvas.discardActiveObject(); canvas.requestRenderAll(); document.getElementById('colorTools').classList.add('ui-active'); } else { icon.parentElement.classList.remove('active'); brushControls.classList.remove('active'); if(!canvas.getActiveObject()) { document.getElementById('colorTools').classList.remove('ui-active'); } } 
        }

        function changeBrush(type, element) { 
            if(currentMode === 'video') return;
            document.querySelectorAll('.brush-option').forEach(el => el.classList.remove('selected')); element.classList.add('selected'); if (type === 'spray') { canvas.freeDrawingBrush = new fabric.SprayBrush(canvas); canvas.freeDrawingBrush.width = 35; canvas.freeDrawingBrush.density = 20; } else { canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); canvas.freeDrawingBrush.width = (type === 'neon') ? 12 : 8; if (type === 'neon') { canvas.freeDrawingBrush.shadow = new fabric.Shadow({ blur: 15, offsetX: 0, offsetY: 0, color: currentColor }); } else { canvas.freeDrawingBrush.shadow = null; } } canvas.freeDrawingBrush.color = currentColor; 
        }

        function disableDrawMode() { 
            if(currentMode === 'photo') { canvas.isDrawingMode = false; }
            document.querySelector('.tool-icon.active')?.classList.remove('active'); document.getElementById('brushControls').classList.remove('active'); 
        }

        function moveLayer(direction) { 
            const targetCanvas = getActiveCanvas();
            const activeObj = targetCanvas.getActiveObject(); if (!activeObj) return; if (direction === 'up') activeObj.bringForward(); else { activeObj.sendBackwards(); if(mainImage && currentMode === 'photo') targetCanvas.sendToBack(mainImage); } targetCanvas.discardActiveObject(); targetCanvas.renderAll(); saveHistory(); 
        }

        function setColor(color) { 
            currentColor = color; document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); 
            const targetCanvas = getActiveCanvas();
            if (currentMode === 'photo' && canvas.isDrawingMode) { canvas.freeDrawingBrush.color = color; if(canvas.freeDrawingBrush.shadow) canvas.freeDrawingBrush.shadow.color = color; } 
            const activeObj = targetCanvas.getActiveObject(); if (activeObj && activeObj.type.includes('text')) { if(activeObj.customStyleID === 1) { activeObj.set('backgroundColor', color); activeObj.set('fill', (color === '#ffffff' || color === '#ffe600') ? '#000' : '#fff'); } else if(activeObj.customStyleID === 3) { activeObj.set('shadow', `${color} 0 0 15px`); activeObj.set('stroke', color); } else if(activeObj.customStyleID === 4) { activeObj.set('stroke', color); activeObj.set({ shadow: new fabric.Shadow({ color: color, blur: 15 }) }); } else { activeObj.set({ fill: color }); } targetCanvas.renderAll(); } 
        }

        // === Ø§Ù„ÙÙ„Ø§ØªØ± (Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ) ===
        function applyFilter() { 
            if(currentMode === 'photo') {
                if (!mainImage) return; const filters = [ new fabric.Image.filters.Grayscale(), new fabric.Image.filters.Contrast({ contrast: 0.3 }), new fabric.Image.filters.Sepia(), new fabric.Image.filters.Saturation({ saturation: 0.5 }) ]; if (mainImage.filters.length === 0) { mainImage.filters.push(filters[0]); Swal.fire({toast:true, position:'top', title:'Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯', background: '#333', color: '#fff', showConfirmButton:false, timer:1000}); } else if (mainImage.filters[0].type === 'Grayscale') { mainImage.filters = [filters[1]]; Swal.fire({toast:true, position:'top', title:'ØªØ¨Ø§ÙŠÙ† Ø¹Ø§Ù„ÙŠ', background: '#333', color: '#fff', showConfirmButton:false, timer:1000}); 
            } else if (mainImage.filters[0].type === 'Contrast') { 
                mainImage.filters = [filters[2]]; Swal.fire({toast:true, position:'top', title:'ÙÙŠÙ†ØªØ§Ø¬', background: '#333', color: '#fff', showConfirmButton:false, timer:1000}); 
            } else if (mainImage.filters[0].type === 'Sepia') { 
                mainImage.filters = [filters[3]]; Swal.fire({toast:true, position:'top', title:'Ø£Ù„ÙˆØ§Ù† Ø¯Ø§ÙØ¦Ø©', background: '#333', color: '#fff', showConfirmButton:false, timer:1000}); 
            } else { 
                mainImage.filters = []; Swal.fire({toast:true, position:'top', title:'Ø¹Ø§Ø¯ÙŠ', background: '#333', color: '#fff', showConfirmButton:false, timer:1000}); 
            } 
            mainImage.applyFilters(); canvas.requestRenderAll(); saveHistory();
        } 
        else if (currentMode === 'video') {
            // Ù…Ù†Ø·Ù‚ ÙÙ„Ø§ØªØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            currentVideoFilterIndex = (currentVideoFilterIndex + 1) % videoFilters.length;
            const filterName = ['Ø¹Ø§Ø¯ÙŠ', 'Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯', 'ÙÙŠÙ†ØªØ§Ø¬', 'Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ', 'Ù†ÙŠÙˆÙ†'][currentVideoFilterIndex];
            document.getElementById('mainVideoPlayer').style.filter = videoFilters[currentVideoFilterIndex];
            Swal.fire({toast:true, position:'top', title: filterName, background: '#333', color: '#fff', showConfirmButton:false, timer:1000});
        }
    }

    function toggleStickers() { 
        disableDrawMode();
        const panel = document.getElementById('stickerPanel');
        panel.classList.toggle('show');
    }

    // === ØªÙØ§Ø¹Ù„Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª (Ø³Ø­Ø¨ Ù„Ù„Ø¥ØºÙ„Ø§Ù‚) ===
    let startY = 0; const stickerPanel = document.getElementById('stickerPanel');
    stickerPanel.addEventListener('touchstart', e => { startY = e.touches[0].clientY; });
    stickerPanel.addEventListener('touchmove', e => { 
        const deltaY = e.touches[0].clientY - startY; 
        if(deltaY > 0) stickerPanel.style.transform = `translateY(${deltaY}px)`; 
    });
    stickerPanel.addEventListener('touchend', e => { 
        const deltaY = e.changedTouches[0].clientY - startY; 
        if (deltaY > 100) { stickerPanel.classList.remove('show'); } 
        stickerPanel.style.transform = ''; 
    });

    // === Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù…Ù„ØµÙ‚Ø§ØªØŒ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ) ===
    function addEmoji(emoji) {
        toggleStickers();
        const targetCanvas = getActiveCanvas();
        const text = new fabric.IText(emoji, { left: targetCanvas.width/2, top: targetCanvas.height/2, fontSize: 70, originX: 'center', originY: 'center', selectable: true });
        targetCanvas.add(text); targetCanvas.setActiveObject(text); saveHistory();
    }

    function addDateSticker() {
        toggleStickers();
        const targetCanvas = getActiveCanvas();
        const date = new Date();
        const timeString = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        const group = new fabric.Group([], { left: targetCanvas.width/2, top: targetCanvas.height/2, originX: 'center', originY: 'center' });
        
        const bg = new fabric.Rect({ width: 160, height: 50, rx: 10, ry: 10, fill: 'rgba(255,255,255,0.9)', originX: 'center', originY: 'center' });
        const text = new fabric.Text(timeString.toUpperCase(), { fontSize: 28, fontFamily: 'Oswald', fill: '#000', originX: 'center', originY: 'center', fontWeight: 'bold' });
        
        group.addWithUpdate(bg); group.addWithUpdate(text);
        targetCanvas.add(group); targetCanvas.setActiveObject(group); saveHistory();
    }

    function addTextSticker(txt) {
        toggleStickers();
        const targetCanvas = getActiveCanvas();
        Swal.fire({
            title: 'Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ', input: 'text', background: '#222', color: '#fff', confirmButtonColor: '#00f2ea',
            inputValidator: (value) => { if (!value) return 'Ø¹Ù„ÙŠÙƒ ÙƒØªØ§Ø¨Ø© Ø´ÙŠØ¡ Ù…Ø§!' }
        }).then((result) => {
            if (result.isConfirmed) {
                const textObj = new fabric.IText(result.value, { 
                    left: targetCanvas.width/2, top: targetCanvas.height/2, fontSize: 30, fill: '#fff', 
                    backgroundColor: 'rgba(0,0,0,0.6)', padding: 10, originX: 'center', originY: 'center', rx: 5, ry: 5 
                });
                targetCanvas.add(textObj); targetCanvas.setActiveObject(textObj); saveHistory();
            }
        });
    }

    function addPollSticker() {
        toggleStickers();
        const targetCanvas = getActiveCanvas();
        // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù„ØµÙ‚ ØªØµÙˆÙŠØª ÙƒØµÙˆØ±Ø© Ù…Ø¬Ù…Ø¹Ø©
        const group = new fabric.Group([], { left: targetCanvas.width/2, top: targetCanvas.height/2, originX: 'center', originY: 'center' });
        const bg = new fabric.Rect({ width: 200, height: 100, rx: 10, ry: 10, fill: '#fff', originX: 'center', originY: 'center' });
        const q = new fabric.Text('Ø§Ø³Ø£Ù„ Ø³Ø¤Ø§Ù„Ø§Ù‹...', { fontSize: 18, fill: '#aaa', top: -25, originX: 'center', originY: 'center' });
        const yes = new fabric.Rect({ width: 90, height: 35, fill: '#eee', left: -45, top: 20, originX: 'center', originY: 'center', rx: 5 });
        const no = new fabric.Rect({ width: 90, height: 35, fill: '#eee', left: 45, top: 20, originX: 'center', originY: 'center', rx: 5 });
        
        group.addWithUpdate(bg); group.addWithUpdate(q); group.addWithUpdate(yes); group.addWithUpdate(no);
        targetCanvas.add(group); targetCanvas.setActiveObject(group); saveHistory();
    }
    
    function addMusicSticker() {
        toggleStickers();
        const targetCanvas = getActiveCanvas();
        const group = new fabric.Group([], { left: targetCanvas.width/2, top: targetCanvas.height/2, originX: 'center', originY: 'center' });
        const bg = new fabric.Rect({ width: 180, height: 50, rx: 25, ry: 25, fill: 'rgba(30,30,30,0.8)', originX: 'center', originY: 'center' });
        const icon = new fabric.Text('â™«', { fontSize: 24, fill: '#00f2ea', left: -60, originX: 'center', originY: 'center' });
        const text = new fabric.Text('Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰', { fontSize: 16, fill: '#fff', left: 10, originX: 'center', originY: 'center' });
        
        group.addWithUpdate(bg); group.addWithUpdate(icon); group.addWithUpdate(text);
        targetCanvas.add(group); targetCanvas.setActiveObject(group); saveHistory();
    }

    // === Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ===
    function handleSelection(e) {
        const obj = e.selected[0];
        document.getElementById('trashBin').classList.add('visible');
        if (obj.type.includes('text')) {
            document.getElementById('colorTools').classList.add('ui-active');
            document.getElementById('textStyleBtn').style.display = 'flex';
            document.getElementById('fontChangeBtn').style.display = 'flex';
        } else if (obj.type === 'path') { // Ø±Ø³Ù…
            document.getElementById('colorTools').classList.add('ui-active');
        } else {
            document.getElementById('colorTools').classList.remove('ui-active');
        }
    }

    // === Ø§Ù„Ø®Ø±Ø§Ø¦Ø· (Leaflet) ===
    let map, mapMarker;
    function openMapSelector() {
        toggleStickers();
        document.getElementById('mapModal').classList.add('active');
        if(!map) initMap();
    }
    function closeMapSelector() { document.getElementById('mapModal').classList.remove('active'); }
    
    function initMap() {
        map = L.map('leafletMap').setView([30.0444, 31.2357], 13); // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        map.on('click', function(e) {
            if(mapMarker) map.removeLayer(mapMarker);
            mapMarker = L.marker(e.latlng).addTo(map);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('mapLocationText').innerHTML = `<i class="fa-solid fa-location-dot" style="color:#ff0050"></i> ${data.address.city || data.address.town || 'Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯'}`;
                    document.getElementById('mapLocationText').dataset.locName = data.address.city || data.address.town || 'Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯';
                });
        });
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 15);
            });
        }
    }

    function confirmMapSelection() {
        const locName = document.getElementById('mapLocationText').dataset.locName || 'Ù…ÙˆÙ‚Ø¹ÙŠ';
        closeMapSelector();
        
        const targetCanvas = getActiveCanvas();
        const group = new fabric.Group([], { left: targetCanvas.width/2, top: targetCanvas.height/2, originX: 'center', originY: 'center' });
        const bg = new fabric.Rect({ width: locName.length * 15 + 50, height: 45, rx: 10, ry: 10, fill: 'linear-gradient(45deg, #ff0050, #ff8c00)', originX: 'center', originY: 'center' });
        // Fabric Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¯Ø±Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù€ fill Ø§Ù„Ù…Ø®ØªØµØ± Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ Ù„Ø°Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù„ÙˆÙ† Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¯Ø±Ø¬ ÙŠØ¯ÙˆÙŠØ§. Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù„ÙˆÙ† Ø«Ø§Ø¨Øª Ù„Ù„Ø³Ø±Ø¹Ø©.
        bg.set('fill', '#fff');
        
        const icon = new fabric.Text('ğŸ“', { fontSize: 20, left: -(locName.length * 5) - 10, originX: 'center', originY: 'center' });
        const text = new fabric.Text(locName, { fontSize: 18, fill: '#333', left: 10, originX: 'center', originY: 'center', fontWeight: 'bold' });
        
        group.addWithUpdate(bg); group.addWithUpdate(icon); group.addWithUpdate(text);
        targetCanvas.add(group); targetCanvas.setActiveObject(group); saveHistory();
    }

    // === Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù†Ø´Ø± ===
    function downloadImage() {
        if(currentMode === 'video') {
             Swal.fire({icon: 'info', title: 'ØªÙ†Ø¨ÙŠÙ‡', text: 'Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø³ÙŠØªÙ… Ø­ÙØ¸ Ù„Ù‚Ø·Ø© Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø·.', background: '#222', color: '#fff'});
        }
        
        const targetCanvas = getActiveCanvas();
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        targetCanvas.discardActiveObject(); 
        targetCanvas.renderAll();
        
        // Ø¯Ù…Ø¬ Ø®Ù„ÙÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠØ¯ÙŠÙˆ (Ù…Ø­Ø§ÙƒØ§Ø©)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø¯Ù…Ø¬ Ù†Ø­ØªØ§Ø¬ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ù…ÙƒØªØ¨Ø© FFmpeg.wasm
        
        const dataURL = targetCanvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });
        const link = document.createElement('a');
        link.download = `nabd-story-${Date.now()}.png`;
        link.href = dataURL;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        playSound('success');
    }

    function publishStory() {
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        const targetCanvas = getActiveCanvas();
        targetCanvas.discardActiveObject(); targetCanvas.renderAll();
        
        const dataURL = targetCanvas.toDataURL({ format: 'png', quality: 0.8 });
        document.getElementById('miniPreviewImg').src = dataURL;
        
        document.getElementById('publishModal').classList.add('active');
        document.getElementById('footer').style.opacity = '0';
    }

    function closePublishModal() {
        document.getElementById('publishModal').classList.remove('active');
        document.getElementById('footer').style.opacity = '1';
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('actionButtons').style.display = 'flex';
    }

    // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© confirmUpload Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©


// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
function handleUploadTask(task, caption, privacy, type) {
    task.on('state_changed', 
        (snapshot) => {
            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... ${Math.round(progress)}%`;
        }, 
        (error) => {
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
            console.error("Upload Error:", error);
            Swal.fire({
                icon: 'error', 
                title: 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹', 
                text: error.message,
                background: '#222', color: '#fff'
            });
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.getElementById('actionButtons').style.display = 'flex';
            document.getElementById('uploadProgress').style.display = 'none';
        }, 
        () => {
            // Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­
            task.snapshot.ref.getDownloadURL().then((downloadURL) => {
                saveStoryToFirestore(downloadURL, caption, privacy, type);
            });
        }
    );
}


// ============================================================
// 1. Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù)
// ============================================================
function confirmUpload() {
    const user = auth.currentUser;
    if (!user) {
        Swal.fire({icon: 'error', title: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'});
        return;
    }

    const caption = document.getElementById('storyCaption').value;
    const privacy = document.getElementById('storyPrivacy').value;
    
    document.getElementById('actionButtons').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'block';

    let uploadTask;
    const timestamp = Date.now();
    let storagePath = '';
    
    // === ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø³Ø§Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ===
    
    // 1. Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    if (currentMode === 'video' && currentVideoFile) {
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø±ÙØ¹ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ stories Ø«Ù… Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙŠÙˆØ²Ø±
        storagePath = `stories/${user.uid}/video_${timestamp}.mp4`; 
        const storageRef = storage.ref(storagePath);
        uploadTask = storageRef.put(currentVideoFile);
        
        // Ù†Ù…Ø±Ø± 'video' ÙƒÙ†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
        handleUploadTask(uploadTask, caption, privacy, 'video'); 
    } 
    // 2. Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
    else {
        const targetCanvas = getActiveCanvas();
        targetCanvas.discardActiveObject();
        targetCanvas.renderAll();
        
        targetCanvas.getElement().toBlob(function(blob) {
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø±ÙØ¹ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ stories Ø«Ù… Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙŠÙˆØ²Ø±
            storagePath = `stories/${user.uid}/image_${timestamp}.png`;
            const storageRef = storage.ref(storagePath);
            uploadTask = storageRef.put(blob);
            
            // Ù†Ù…Ø±Ø± 'image' ÙƒÙ†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            handleUploadTask(uploadTask, caption, privacy, 'image');
        });
    }
}

// ============================================================
// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ØµØ­ÙŠØ­)
// ============================================================

// Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø£Ø¶ÙÙ†Ø§ Ù…Ø¹Ø§Ù…Ù„ (type) Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
function saveStoryToFirestore(url, caption, privacy, type) { 
    const user = auth.currentUser;
    const now = new Date();

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø´Ù† Ù‡Ù†Ø§ Ù„Ø£Ù†Ù‡Ø§ Ù„Ù… ØªÙƒÙ† ØªÙ…Ø±Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ù† handleUploadTask
    const hashtags = (caption.match(/#[\w\u0600-\u06FF]+/g) || []).map(tag => tag.slice(1));
    const mentions = (caption.match(/@[\w\u0600-\u06FF]+/g) || []).map(mention => mention.slice(1));

    if (!user) return;

    db.collection('stories').add({
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ‡Ø§Ø±Ø³)
        uid: user.uid,
        username: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…",
        photoURL: user.photoURL || "",
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
        url: url,          
        mediaUrl: url,
        type: type, // <--- Ù‡Ù†Ø§ Ø§Ù„ØªØµØ­ÙŠØ­: Ø¨ÙŠØ§Ø®Ø¯ Ø§Ù„Ù†ÙˆØ¹ (video Ø£Ùˆ image) Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ø´ Ø«Ø§Ø¨Øª

        // Ø§Ù„ØªÙˆÙ‚ÙŠØª (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ÙÙ‡Ø§Ø±Ø³ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© 32955)
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        expiresAt: firebase.firestore.Timestamp.fromDate(new Date(now.getTime() + (24 * 60 * 60 * 1000))),

        // Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        caption: caption || "",
        hashtags: hashtags,
        mentions: mentions,
        visibility: privacy,

        // Ø¹Ø¯Ø§Ø¯Ø§Øª
        viewers: [],
        viewCount: 0,
        likes: []

    }).then(() => {
        // Ù†Ø¬Ø§Ø­
        localStorage.removeItem('nabd_story_draft'); 
        document.getElementById('progressText').innerText = "ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!"; 
        document.getElementById('progressFill').style.backgroundColor = '#00f2ea';
        playSound('success');
        
        // Confetti
        if(typeof confetti === 'function') {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
        
        setTimeout(() => { window.location.href = 'home.html'; }, 3000);

    }).catch((err) => { 
        console.error("Firestore Error:", err); 
        Swal.fire({ title: "Ø®Ø·Ø£", text: err.message, icon: 'error', background: '#333', color: '#fff' }); 
        resetModalUI(); 
    });
}

    </script>
    <script src="global-call.js"></script>
</body>
</html>
