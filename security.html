<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NABD - Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
/* ================= Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (Dark Mode) ================= */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Verdana,sans-serif;transition:all .2s ease-in-out}
body{background:#0d0d0f;color:#fff}
a{text-decoration:none;color:inherit}

/* HEADER */
.header{
    display:flex;justify-content:flex-start;align-items:center;
    padding:18px 15px;font-size:20px;font-weight:900;
    border-bottom:1px solid #1f1f23;position:sticky;top:0;
    background:#0d0d0f;z-index:50;
}
.header-btn{cursor:pointer;font-size:22px;color:#7c3aed; margin-left: 15px;}
.header-name{font-size:20px;font-weight:700;}

/* SECURITY CONTAINER */
.security-container{
    max-width: 600px;
    margin: 20px auto;
    padding: 0 15px;
}
.setting-section{
    margin-bottom: 30px;
}
.setting-section h2{
    color: #fff;
    font-size: 16px;
    font-weight: bold;
    padding: 10px 0 5px 0;
}
.section-desc {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 15px;
}

/* SETTING ITEM */
.setting-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:15px 0;
    border-bottom:1px solid #1f1f23;
    cursor:pointer;
}
.setting-item:last-child{
    border-bottom:none;
}
.setting-label{
    font-size: 16px;
}
.setting-action{
    font-size: 14px;
    color: #7c3aed;
}

/* Modal for Password Change */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.modal-content {
    background: #1c1c1c;
    padding: 30px;
    border-radius: 10px;
    max-width: 350px;
    width: 90%;
}
.modal-content h3 {
    color: #7c3aed;
    margin-bottom: 20px;
    text-align: center;
}
.modal-content input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    background: #0d0d0f;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
}
.modal-content button {
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    flex: 1;
}
.modal-footer {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}
.modal-footer .btn-cancel { background: #333; color: #ccc; }
.modal-footer .btn-save { background: #7c3aed; color: #fff; }
#passwordError {
    color: #ff5555;
    margin-top: 10px;
    font-size: 13px;
    text-align: center;
    display: none;
}
#passwordSuccess {
    color: #33ff57;
    margin-top: 10px;
    font-size: 13px;
    text-align: center;
    display: none;
}
</style>
</head>

<body>

<div id="changePasswordModal" class="modal-overlay">
    <div class="modal-content">
        <h3>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
        <input type="password" id="currentPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
        <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±)">
        <input type="password" id="confirmNewPassword" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">

        <div class="modal-footer">
            <button class="btn-cancel" onclick="toggleModal(false)">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-save" onclick="changePassword()">Ø­ÙØ¸</button>
        </div>
        <p id="passwordError"></p>
        <p id="passwordSuccess"></p>
    </div>
</div>
<div class="header">
  <i class="fa-solid fa-arrow-right header-btn" onclick="goBack()"></i>
  <span class="header-name">Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†</span>
</div>

<div class="security-container">
    
    <div class="setting-section">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</h2>
        <div class="section-desc">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ÙˆØªÙØ¶ÙŠÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ·Ø±Ù‚ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯.</div>
        
        <div class="setting-item" onclick="toggleModal(true)">
            <span class="setting-label">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>

        <div class="setting-item" onclick="handleSecurityOption('two_factor.html')">
            <span class="setting-label">Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>
        
        <div class="setting-item" onclick="handleSecurityOption('saved_logins.html')">
            <span class="setting-label">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>
    </div>

    <div class="setting-section">
        <h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†</h2>
        <div class="section-desc">ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙˆØ¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ Ø¯ÙˆØ±ÙŠ.</div>

        <div class="setting-item" onclick="handleSecurityOption('login_locations.html')">
            <span class="setting-label">Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ØªÙŠ Ø³Ø¬Ù„Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù†Ù‡Ø§</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>

        <div class="setting-item" onclick="handleSecurityOption('login_alerts.html')">
            <span class="setting-label">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>
        
        <div class="setting-item" onclick="handleSecurityOption('recent_emails.html')">
            <span class="setting-label">Ø£Ø­Ø¯Ø« Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>

        <div class="setting-item" onclick="handleSecurityOption('security_check.html')">
            <span class="setting-label">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>
    </div>

    <div class="setting-section">
        <h2>Ø¯Ø±Ø¯Ø´Ø§Øª Ù…Ø´ÙØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†</h2>
        <div class="section-desc">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ù…Ø´ÙØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ†.</div>

        <div class="setting-item" onclick="handleSecurityOption('secure_storage.html')">
            <span class="setting-label">Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¢Ù…Ù†</span>
            <span class="setting-action"><i class="fa-solid fa-chevron-left"></i></span>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ğŸš¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù…Ù„ÙØ§Øª NABD ğŸš¨
const BASE_PATH = 'file:///storage/emulated/0/NABD/';

function getFilePath(fileName) {
    return BASE_PATH + fileName;
}


firebase.initializeApp({
  apiKey:"AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c", 
  authDomain:"pools-e4381.firebaseapp.com",
  projectId:"pools-e4381"
});

const auth = firebase.auth();
const modal = document.getElementById('changePasswordModal');
const currentPassEl = document.getElementById('currentPassword');
const newPassEl = document.getElementById('newPassword');
const confirmNewPassEl = document.getElementById('confirmNewPassword');
const errorEl = document.getElementById('passwordError');
const successEl = document.getElementById('passwordSuccess');

let currentUser;

auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
    } else {
        // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø·Ù„Ù‚
        location.href = getFilePath("login.html"); 
    }
});


function goBack() {
    // ğŸš¨ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØ¹ÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (settings.html) ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª ğŸš¨
    location.href = getFilePath("settings.html"); 
}

// Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„ØªÙˆØ¬ÙŠÙ‡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø·Ù„Ù‚)
function handleSecurityOption(page) {
    location.href = getFilePath(page);
}


function toggleModal(show) {
    errorEl.style.display = 'none';
    successEl.style.display = 'none';
    
    if (show) {
        currentPassEl.value = '';
        newPassEl.value = '';
        confirmNewPassEl.value = '';
        modal.style.display = 'flex';
    } else {
        modal.style.display = 'none';
    }
}

async function changePassword() {
    const currentPassword = currentPassEl.value;
    const newPassword = newPassEl.value;
    const confirmNewPassword = confirmNewPassEl.value;

    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    if (!currentPassword || !newPassword || !confirmNewPassword) {
        errorEl.innerText = "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
        errorEl.style.display = 'block';
        return;
    }

    if (newPassword !== confirmNewPassword) {
        errorEl.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø§Ù†.";
        errorEl.style.display = 'block';
        return;
    }
    
    if (newPassword.length < 6) {
        errorEl.innerText = "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
        errorEl.style.display = 'block';
        return;
    }
    
    // 1. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const credential = firebase.auth.EmailAuthProvider.credential(
        currentUser.email,
        currentPassword
    );

    try {
        await currentUser.reauthenticateWithCredential(credential);

        // 2. Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        await currentUser.updatePassword(newPassword);

        successEl.innerText = "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.";
        successEl.style.display = 'block';
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        setTimeout(() => {
            auth.signOut();
        }, 2000);

    } catch (error) {
        let errorMessage = "ÙØ´Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";
        if (error.code === 'auth/wrong-password') {
            errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        } else if (error.code === 'auth/requires-recent-login') {
             errorMessage = "ÙŠØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ø¯ÙŠØ«. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        }
        errorEl.innerText = errorMessage;
        errorEl.style.display = 'block';
        console.error("Error changing password:", error);
    }
}
</script>

</body>
</html>
