<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø´Ø± Ù…ÙŠØ¯ÙŠØ§ - NABD Pro Max</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>

    <style>
        * { box-sizing: border-box; font-family: "Cairo", sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            background-color: #0d0d0f;
            background-image: radial-gradient(circle at 50% 10%, rgba(93, 95, 239, 0.1) 0%, transparent 60%);
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* === Ø§Ù„Ù‡ÙŠØ¯Ø± === */
        .header {
            padding: 15px 20px;
            background: rgba(13, 13, 15, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 50;
        }
        .header-title { font-weight: 800; font-size: 18px; color: #fff; text-shadow: 0 0 10px rgba(93, 95, 239, 0.3); }
        .close-btn { font-size: 24px; color: #888; cursor: pointer; transition: 0.3s; width: 40px; height: 40px; display: grid; place-items: center; border-radius: 50%; }
        
        .header-actions { display: flex; gap: 10px; align-items: center; }

        .post-btn {
            background: linear-gradient(135deg, #5D5FEF, #7c3aed);
            border: none; padding: 8px 24px; border-radius: 50px;
            color: #fff; font-weight: 700; cursor: pointer; font-size: 14px;
            box-shadow: 0 4px 15px rgba(93, 95, 239, 0.4); transition: 0.3s;
        }
        .post-btn:disabled { background: #222; color: #555; box-shadow: none; cursor: not-allowed; }

        .draft-btn {
            background: rgba(255, 255, 255, 0.08); color: #ddd;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 16px; border-radius: 50px; cursor: pointer;
            font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px;
            transition: 0.2s; min-width: 90px; justify-content: center;
        }
        .draft-btn:hover { background: rgba(255, 255, 255, 0.15); color: #fff; border-color: #5D5FEF; }
        .draft-btn.saving { color: #5D5FEF; border-color: #5D5FEF; }
        .draft-btn.saved { color: #4caf50; border-color: #4caf50; }


        /* === Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… === */
        .user-area { display: flex; align-items: center; gap: 12px; padding: 15px 20px 5px; }
        .avatar { 
            width: 48px; height: 48px; border-radius: 50%; 
            background: #333; background-size: cover; background-position: center; 
            border: 2px solid #5D5FEF; 
        }
        .user-info { display: flex; flex-direction: column; gap: 4px; }
        .username { font-weight: bold; font-size: 16px; line-height: 1.2; }
        
        .privacy-btn {
            background: rgba(255,255,255,0.08); color: #aaa; font-size: 11px; padding: 4px 10px;
            border-radius: 6px; width: fit-content; cursor: pointer; display: flex;
            align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
        }
        .privacy-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

        /* === Ø§Ù„Ù…Ø­ØªÙˆÙ‰ === */
        .content { flex: 1; padding: 20px; overflow-y: auto; position: relative; padding-bottom: 50px; }
        
        .content.drag-active {
            background: rgba(93, 95, 239, 0.1);
            border: 2px dashed #5D5FEF;
            border-radius: 20px; margin: 10px;
        }

        .caption-wrapper {
            background: transparent; border: none;
            padding: 5px; margin-bottom: 5px; position: relative;
            transition: 0.3s;
        }
        .caption-wrapper:focus-within {
            background: linear-gradient(to bottom, rgba(93, 95, 239, 0.05), transparent);
            border-radius: 12px;
        }

        .caption-area {
            width: 100%; background: transparent; border: none; color: #eee;
            font-size: 18px; resize: none; min-height: 80px; padding: 10px 0; font-family: inherit;
            white-space: pre-wrap; word-wrap: break-word;
        }
        .caption-area:empty:before { content: attr(placeholder); color: #777; display: block; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø±Ø± */
        .mention-node {
            color: #5D5FEF; /* Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ù„Ù…Ù†Ø´Ù† */
            font-weight: 800;
            background: rgba(93, 95, 239, 0.15);
            border-radius: 6px;
            padding: 2px 6px;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            margin: 0 2px;
            transition: 0.2s;
        }
        .mention-node:hover { background: rgba(93, 95, 239, 0.3); }

        .char-counter {
            position: absolute; bottom: 10px; left: 10px; width: 24px; height: 24px; pointer-events: none;
        }
        .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 100%; transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 3; }
        .circle { fill: none; stroke-width: 3; stroke-linecap: round; transition: stroke-dasharray 0.3s ease, stroke 0.3s; stroke: #5D5FEF; }
        .circle.warning { stroke: #ff9800; }
        .circle.danger { stroke: #ff3b30; }

        .tools-bar {
            display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none;
            padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px;
        }
        .tool-chip {
            display: flex; align-items: center; gap: 8px; color: #ccc; 
            font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap;
            padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
        }
        .tool-chip:hover { background: rgba(93, 95, 239, 0.1); border-color: #5D5FEF; color: #fff; }

        .tags-wrapper {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 5px 0 15px;
        }
        .tag-chip {
            background: rgba(93, 95, 239, 0.15); border: 1px solid rgba(93, 95, 239, 0.3);
            color: #b0b2ff; padding: 6px 12px; border-radius: 20px; font-size: 13px;
            display: flex; align-items: center; gap: 6px; font-weight: bold; animation: fadeIn 0.3s;
        }
        .tag-chip i { cursor: pointer; font-size: 12px; opacity: 0.7; transition:0.2s; }
        .tag-chip i:hover { color: #ff3b30; opacity: 1; }
        @keyframes fadeIn { from{opacity:0; transform:scale(0.9);} to{opacity:1; transform:scale(1);} }

        /* === ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ === */
        .media-list {
            display: flex; flex-direction: column; gap: 25px; width: 100%;
        }

        .media-item {
            position: relative; width: 100%; border-radius: 16px; overflow: hidden;
            background: #000; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            aspect-ratio: 9 / 16;
        }

        .custom-video-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; 
            background: #000; 
        }
        .custom-video-wrapper video { 
            width: 100%; height: 100%; 
            object-fit: cover;
            display: block; 
        }
        .media-item img { width: 100%; height: 100%; object-fit: cover; display: block; }

        .custom-video-wrapper:fullscreen,
        .custom-video-wrapper:-webkit-full-screen {
            width: 100vw; height: 100vh; background: #000; 
            display: flex; justify-content: center; align-items: center;
        }
        .custom-video-wrapper:fullscreen video { max-height: 100vh; object-fit: contain; }

        .custom-controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 10px 15px; display: flex; align-items: center; gap: 10px;
            opacity: 0; transition: 0.3s; z-index: 20; direction: ltr;
        }
        .media-item:hover .custom-controls,
        .custom-video-wrapper.paused .custom-controls { opacity: 1; }

        .progress-container { flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 5px; cursor: pointer; position: relative; }
        .progress-filled { height: 100%; background: #5D5FEF; border-radius: 5px; width: 0%; pointer-events: none; }
        .center-play-btn {
            position: absolute; width: 60px; height: 60px; background: rgba(0,0,0,0.5);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 24px; cursor: pointer; backdrop-filter: blur(4px);
            border: 2px solid rgba(255,255,255,0.3); pointer-events: none; z-index: 50; transition: 0.2s;
        }
        .ctrl-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 16px; padding: 5px; }
        .time-display { font-size: 11px; color: #ddd; font-family: monospace; min-width: 35px; text-align: center; }

        .media-actions {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 100;
        }
        .action-btn {
            background: rgba(0,0,0,0.6); color: #fff; width: 32px; height: 32px;
            border-radius: 50%; display: grid; place-items: center; cursor: pointer;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); transition: 0.2s;
        }
        .action-btn:hover { background: #5D5FEF; border-color: #5D5FEF; }
        .action-btn.delete:hover { background: #ff3b30; border-color: #ff3b30; }

        .edit-cover-badge {
            position: absolute; top: 10px; left: 10px; 
            background: rgba(13, 13, 15, 0.8); color: #fff; padding: 6px 14px;
            border-radius: 20px; font-size: 11px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 6px;
            backdrop-filter: blur(4px); z-index: 100; transition: 0.2s;
        }
        .edit-cover-badge:hover { background: #5D5FEF; border-color: #5D5FEF; }

        /* === Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ === */
        .bottom-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none;
            align-items: flex-end; justify-content: center; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: #1a1a1a; width: 100%; border-radius: 20px 20px 0 0; padding: 25px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid #333; max-height: 80vh; display: flex; flex-direction: column;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 16px; color: #fff; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .list-opt { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            border-bottom: 1px solid #222; cursor: pointer; color: #ddd; border-radius: 8px; transition: 0.2s;
        }
        .list-opt:hover { background: #252525; }
        .list-opt.active { color: #5D5FEF; background: rgba(93, 95, 239, 0.1); }

        .cover-modal {
            position: fixed; inset: 0; background: #000; z-index: 4000; display: none;
            flex-direction: column;
        }
        .cm-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        .cm-title { font-weight: bold; font-size: 16px; }
        .cm-done { color: #5D5FEF; font-weight: bold; cursor: pointer; font-size: 16px; padding: 5px 10px; }
        .cm-preview-area { flex: 1; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; }
        .cm-video { max-width: 100%; max-height: 80vh; }
        .cm-controls { padding: 25px 20px; background: #161616; border-top: 1px solid #222; }
        .range-slider {
            -webkit-appearance: none; width: 100%; height: 50px; background: #222;
            border-radius: 8px; outline: none; overflow: hidden;
            background-image: linear-gradient(90deg, #333 1px, transparent 1px); background-size: 10px 100%;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 50px; background: #fff;
            border: 2px solid #5D5FEF; cursor: pointer; box-shadow: 0 0 10px rgba(93, 95, 239, 0.8);
        }

        .upload-overlay {
            position: fixed; inset: 0; background: rgba(5, 5, 8, 0.8); z-index: 5000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .progress-ring { width: 70px; height: 70px; border: 5px solid #222; border-top: 5px solid #5D5FEF; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

/* === Ø³ØªØ§ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ÙÙ‚Ø© === */
.sound-attachment {
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(135deg, rgba(29, 185, 84, 0.1), rgba(20, 20, 20, 0.8));
    border: 1px solid rgba(29, 185, 84, 0.3);
    padding: 10px 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    position: relative;
    animation: fadeIn 0.4s;
}

.sound-icon-wrapper {
    width: 40px; height: 40px;
    background: #1db954;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 18px;
    box-shadow: 0 4px 10px rgba(29, 185, 84, 0.3);
}

.sound-info-box {
    flex: 1;
    display: flex; flex-direction: column;
}

.sound-name-preview { font-weight: 800; font-size: 14px; color: #fff; }
.sound-author-preview { font-size: 11px; color: #aaa; }

.remove-sound-btn {
    width: 30px; height: 30px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: #ff3b30;
    transition: 0.2s;
}
.remove-sound-btn:hover { background: rgba(255, 59, 48, 0.1); }

    </style>
</head>

<body>

    <div class="upload-overlay" id="uploadOverlay">
        <div class="progress-ring"></div>
        <div style="font-weight:bold; font-size:18px; color:#fff;" id="statusMain">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...</div>
        <div style="color:#888; font-size:13px; margin-top:10px;" id="statusSub">0%</div>
    </div>

    <div class="bottom-modal" id="privacyModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span>
                <i class="fa-solid fa-xmark" onclick="closeModal('privacyModal')" style="cursor:pointer"></i>
            </div>
            <div class="list-opt active" id="opt-public" onclick="setPrivacy('public')">
                <i class="fa-solid fa-earth-americas"></i> <div>Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            </div>
            <div class="list-opt" id="opt-friends" onclick="setPrivacy('friends')">
                <i class="fa-solid fa-user-group"></i> <div>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</div>
            </div>
            <div class="list-opt" id="opt-private" onclick="setPrivacy('private')">
                <i class="fa-solid fa-lock"></i> <div>Ø£Ù†Ø§ ÙÙ‚Ø·</div>
            </div>
        </div>
    </div>

    <div class="bottom-modal" id="tagsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª</span>
                <i class="fa-solid fa-xmark" onclick="closeModal('tagsModal')" style="cursor:pointer"></i>
            </div>
            <input type="text" id="tagInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬..." style="width:100%; padding:14px; background:#222; border:1px solid #333; color:#fff; border-radius:12px; margin-bottom:15px; outline:none;" oninput="searchTags(this.value)">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">Ù…Ù‚ØªØ±Ø­Ø§Øª:</div>
            <div id="tagsResultsList" style="overflow-y:auto; max-height:300px; display:flex; flex-direction:column; gap:5px;"></div>
        </div>
    </div>

    <div class="bottom-modal" id="mentionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ ØµØ¯ÙŠÙ‚</span>
                <i class="fa-solid fa-xmark" onclick="closeModal('mentionsModal')" style="cursor:pointer"></i>
            </div>
            <input type="text" id="mentionInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." style="width:100%; padding:14px; background:#222; border:1px solid #333; color:#fff; border-radius:12px; margin-bottom:15px; outline:none;" oninput="searchUsers(this.value)">
            <div id="mentionsResultsList" style="overflow-y:auto; max-height:300px; display:flex; flex-direction:column; gap:5px;"></div>
        </div>
    </div>

    <div class="cover-modal" id="coverModal">
        <div class="cm-header">
            <span class="close-btn" onclick="closeCoverModal()">&times;</span>
            <span class="cm-title">Ø§Ø®ØªÙŠØ§Ø± Ù„Ù‚Ø·Ø© Ø§Ù„ØºÙ„Ø§Ù</span>
            <span class="cm-done" onclick="saveCoverSelection()">Ø­ÙØ¸</span>
        </div>
        <div class="cm-preview-area">
            <video id="coverVideoPlayer" class="cm-video" playsinline muted></video>
        </div>
        <div class="cm-controls">
            <input type="range" id="coverSlider" class="range-slider" min="0" max="100" step="0.1" value="0">
        </div>
    </div>

    <div class="header">
        <div class="close-btn" onclick="history.back()"><i class="fa-solid fa-arrow-right"></i></div>
        <div class="header-title">Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</div>
        
        <div class="header-actions">
            <button class="draft-btn" id="draftBtn" onclick="manualSaveDraft()">
                <i class="fa-regular fa-bookmark"></i> <span id="draftText">Ù…Ø³ÙˆØ¯Ø©</span>
            </button>
            <button class="post-btn" id="postBtn" onclick="handlePost()" disabled>Ù†Ø´Ø±</button>
        </div>
    </div>

    <div class="user-area" id="userArea" style="display:none;">
        <div class="avatar" id="userAvatar"></div>
        <div class="user-info">
            <div class="username" id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <div class="privacy-btn" onclick="openPrivacy()">
                <i class="fa-solid fa-earth-americas" id="privacyIcon"></i>
                <span id="privacyText">Ø§Ù„Ø¹Ø§Ù…Ø©</span>
                <i class="fa-solid fa-caret-down" style="font-size:10px;"></i>
            </div>
        </div>
    </div>

  <div class="content" id="dropZone">
    
    <div id="soundAttachmentContainer"></div>

    <div class="caption-wrapper">
        <div class="caption-area" id="editor" contenteditable="true" placeholder="Ø¨Ù… ØªÙÙƒØ± Ø§Ù„ÙŠÙˆÙ…ØŸ..." 
             oninput="onEditorInput(event)"></div>
            
            <div class="char-counter">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="charCircle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
            </div>
        </div>
        
        <div class="tools-bar">
            <label class="tool-chip">
                <i class="fa-solid fa-image" style="color:#4caf50;"></i> ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ
                <input type="file" id="fileInput" hidden multiple accept="image/*,video/*">
            </label>
            <div class="tool-chip" onclick="openTagsModal()">
                <i class="fa-solid fa-hashtag" style="color:#e91e63;"></i> Ù‡Ø§Ø´ØªØ§Ø¬
            </div>
            <div class="tool-chip" onclick="openMentionsModal()">
                <i class="fa-solid fa-user-tag" style="color:#2196f3;"></i> Ø¥Ø´Ø§Ø±Ø©
            </div>
        </div>
            
        <div class="tags-wrapper" id="visualTagsContainer"></div>

        <div class="media-list" id="mediaPreview"></div>

    </div>

    <canvas id="thumbCanvas" style="display:none;"></canvas>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app", 
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

        let mediaItems = []; 
        let currentUser = null;
        let currentUserData = null; 
        let activeEditId = null;
        let selectedTags = [];
        let currentPrivacy = 'public';
        let recentHashtags = JSON.parse(localStorage.getItem('my_recent_hashtags') || '[]');
        let savedRange = null; 
        let mentionedUsersMap = new Map();
        let autoSaveInterval = null;
        let lastDraftContent = ''; 
        let draftDB;
// ... Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ...
let attachedSound = null; 
let backgroundAudio = null; // <-- Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯

      // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª ---
        const dbRequest = indexedDB.open("NabdDraftsDB", 1);
        dbRequest.onupgradeneeded = function(event) {
            draftDB = event.target.result;
            if (!draftDB.objectStoreNames.contains('drafts')) {
                draftDB.createObjectStore('drafts', { keyPath: 'id' });
            }
        };
        dbRequest.onsuccess = function(event) {
            draftDB = event.target.result;
            setTimeout(loadDraft, 500);
            startAutoSave();
        };

        auth.onAuthStateChanged(u => { 
            if (!u) location.href = 'index.html'; 
            currentUser = u;
            document.getElementById('userArea').style.display = 'flex';
            loadUserData();
        });

        async function loadUserData() {
            try {
                const d = await db.collection("users").doc(currentUser.uid).get();
                const data = d.data();
                currentUserData = data; 
                document.getElementById('userName').innerText = data.name;
                if(data.profilePic) document.getElementById('userAvatar').style.backgroundImage = `url('${data.profilePic}')`;
            } catch(e){}
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†Ø´Ù† (ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§) ---
        function onEditorInput(e) {
            checkPostButton();
            // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ø¹Ù„Ø§Ù…Ø© @
            const sel = window.getSelection();
            if(sel.rangeCount) {
                const node = sel.anchorNode;
                const text = node.textContent;
                const offset = sel.anchorOffset;
                if (text.slice(offset - 1, offset) === '@') {
                    const range = document.createRange();
                    range.setStart(node, offset - 1);
                    range.setEnd(node, offset);
                    range.deleteContents(); 
                    openMentionsModal();
                }
            }
        }

        function openMentionsModal() {
            saveSelection();
            document.getElementById('mentionsModal').style.display = 'flex';
            const input = document.getElementById('mentionInput');
            input.value = '';
            input.focus();
            searchUsers('');
        }

        function saveSelection() {
            const sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                const range = sel.getRangeAt(0);
                const editor = document.getElementById('editor');
                if (editor.contains(range.commonAncestorContainer)) {
                    savedRange = range.cloneRange();
                }
            }
        }

        async function searchUsers(query) {
            const list = document.getElementById('mentionsResultsList');
            list.innerHTML = '';
            const cleanQuery = query.trim();
            try {
                let usersRef = db.collection('users');
                let snap;
                if(cleanQuery.length > 0) {
                    snap = await usersRef.where('name', '>=', cleanQuery).where('name', '<=', cleanQuery + '\uf8ff').limit(5).get();
                } else {
                    snap = await usersRef.limit(5).get();
                }
                if (snap.empty) { list.innerHTML = '<div style="text-align:center; color:#777; padding:10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }
                snap.forEach(doc => {
                    const userData = doc.data();
                    const uid = doc.id;
                    if(uid !== currentUser.uid) {
                        const avatar = userData.profilePic || 'https://via.placeholder.com/40';
                        const safeName = userData.name.replace(/'/g, "\\'"); 
                        list.innerHTML += `
                      <div class="list-opt" onclick="insertMentionTag('${uid}', '${safeName}', '${userData.profilePic || ''}')">
                            <div style="width:35px; height:35px; border-radius:50%; background:url('${avatar}') center/cover;"></div>
                            <div>
                                <div style="font-weight:bold">${userData.name}</div>
                                <div style="font-size:11px; color:#777">@${userData.username || 'user'}</div>
                            </div>
                        </div>`;
                    }
                });
            } catch(e) { console.log(e); }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
        // ØªØ¹Ø¯ÙŠÙ„ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© (pic) ÙˆØ­ÙØ¸Ù‡Ø§
function insertMentionTag(uid, name, pic) {
    closeModal('mentionsModal'); 
    const editor = document.getElementById('editor');
    editor.focus();
    
    if (savedRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedRange);
    }

    const mentionNode = document.createElement('span');
    mentionNode.className = 'mention-node';
    mentionNode.textContent = '@' + name; 
    mentionNode.contentEditable = "false"; 
    mentionNode.setAttribute('data-uid', uid);
    
    // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø­ÙØ¸Ù†Ø§ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ±
    const safePic = pic || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
    mentionNode.setAttribute('data-pic', safePic); 
    
    mentionNode.style.color = '#5D5FEF';
    mentionNode.style.fontWeight = 'bold';
    mentionNode.style.marginRight = '4px';

    const space = document.createTextNode('\u00A0'); 
    const sel = window.getSelection();
    if (sel.getRangeAt && sel.rangeCount) {
        const range = sel.getRangeAt(0);
        range.deleteContents(); 
        range.insertNode(mentionNode);
        range.setStartAfter(mentionNode);
        range.setEndAfter(mentionNode);
        range.insertNode(space);
        range.setStartAfter(space);
        range.setEndAfter(space);
        sel.removeAllRanges();
        sel.addRange(range);
    } else {
        editor.appendChild(mentionNode);
        editor.appendChild(space);
    }
    mentionedUsersMap.set(uid, true);
    checkPostButton();
}

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³ÙˆØ¯Ø§Øª ---
        function startAutoSave() { autoSaveInterval = setInterval(() => { saveDraft(true); }, 5000); }
        function manualSaveDraft() { saveDraft(false); }
        function saveDraft(isAuto = false) {
            const editorHTML = document.getElementById('editor').innerHTML;
            const textContent = document.getElementById('editor').innerText.trim();
            const hasContent = textContent.length > 0 || mediaItems.length > 0;
            if (!hasContent) return;
            const currentContentStr = editorHTML + mediaItems.length + selectedTags.join('');
            if (isAuto && currentContentStr === lastDraftContent) return;
            const btn = document.getElementById('draftBtn');
            const btnText = document.getElementById('draftText');
            if(isAuto) { btn.classList.add('saving'); btnText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; }
            const filesToSave = mediaItems.map(item => { return { file: item.file, type: item.type, thumbBlob: item.thumbBlob }; });
            const draftData = { id: 'current_draft', html: editorHTML, text: textContent, media: filesToSave, tags: selectedTags, timestamp: Date.now() };
            const transaction = draftDB.transaction(["drafts"], "readwrite");
            const store = transaction.objectStore("drafts");
            const request = store.put(draftData);
            request.onsuccess = function() {
                lastDraftContent = currentContentStr;
                btn.classList.remove('saving'); btn.classList.add('saved'); btnText.innerHTML = 'Ù…Ø­ÙÙˆØ¸ <i class="fa-solid fa-check"></i>';
                setTimeout(() => { btn.classList.remove('saved'); btnText.innerText = "Ù…Ø³ÙˆØ¯Ø©"; }, 2000);
            };
        }
        function loadDraft() {
            if(!draftDB) return;
            const transaction = draftDB.transaction(["drafts"], "readonly");
            const store = transaction.objectStore("drafts");
            const request = store.get('current_draft');
            request.onsuccess = function(event) {
                const draft = event.target.result;
                if (draft) {
                    Swal.fire({
                        title: 'Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø©', text: "ÙŠÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø©. Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ØŸ", icon: 'info',
                        showCancelButton: true, confirmButtonColor: '#5D5FEF', cancelButtonColor: '#333',
                        confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ù„Ø§', background: '#1a1a1a', color: '#fff'
                    }).then((result) => { if (result.isConfirmed) restoreDraftData(draft); else clearDraft(); });
                }
            };
        }
        function restoreDraftData(draft) {
            if(draft.html) document.getElementById('editor').innerHTML = draft.html;
            else if(draft.text) document.getElementById('editor').innerText = draft.text;
            if(draft.tags) { selectedTags = draft.tags; renderTags(); }
            if(draft.media && draft.media.length > 0) {
                mediaItems = []; 
                draft.media.forEach(savedItem => {
                    const id = Date.now() + Math.random().toString(16).slice(2);
                    mediaItems.push({ id: id, file: savedItem.file, type: savedItem.type, thumbBlob: savedItem.thumbBlob, previewUrl: URL.createObjectURL(savedItem.file) });
                });
                renderMediaList();
            }
            checkPostButton();
        }
        function clearDraft() {
            const transaction = draftDB.transaction(["drafts"], "readwrite");
            const store = transaction.objectStore("drafts");
            store.delete('current_draft');
        }

        // --- Drag & Drop & Files ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => { dropZone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }); });
        ['dragenter', 'dragover'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.add('drag-active')));
        ['dragleave', 'drop'].forEach(eName => dropZone.addEventListener(eName, () => dropZone.classList.remove('drag-active')));
        dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', e => handleFiles(e.target.files));
        function handleFiles(files) {
            const newFiles = Array.from(files);
            newFiles.forEach(file => {
                const isVideo = file.type.startsWith('video');
                const id = Date.now() + Math.random().toString(16).slice(2);
                mediaItems.push({ id: id, file: file, type: isVideo ? 'video' : 'image', thumbBlob: null, previewUrl: URL.createObjectURL(file) });
            });
            renderMediaList(); checkPostButton(); fileInput.value = ''; 
        }
        function renderMediaList() {
            const list = document.getElementById('mediaPreview'); list.innerHTML = '';
            mediaItems.forEach((item, index) => {
                let posterAttr = (item.type === 'video' && item.thumbBlob) ? `poster="${URL.createObjectURL(item.thumbBlob)}"` : '';

                let contentHtml = item.type === 'video' ? `
                    <div class="custom-video-wrapper paused" id="wrapper_${item.id}">
                        <video src="${item.previewUrl}" id="video_${item.id}" ${posterAttr} onclick="togglePlay('${item.id}')" ontimeupdate="updateProgress('${item.id}')" onended="resetPlayer('${item.id}')" playsinline></video>
                        <div class="center-play-btn" id="centerBtn_${item.id}"><i class="fa-solid fa-play"></i></div>
                        <div class="custom-controls">
                            <button class="ctrl-btn" onclick="togglePlay('${item.id}')"><i class="fa-solid fa-play" id="playIcon_${item.id}"></i></button>
                            <div class="time-display" id="currTime_${item.id}">0:00</div>
                            <div class="progress-container" onclick="seekVideo(event, '${item.id}')"><div class="progress-filled" id="progBar_${item.id}"></div></div>
                            <div class="time-display" id="durTime_${item.id}">0:00</div>
                            <button class="ctrl-btn" onclick="toggleFullscreen('${item.id}')"><i class="fa-solid fa-expand"></i></button>
                        </div>
                    </div>
                    <div class="edit-cover-badge" onclick="openCoverEditor('${item.id}')"><i class="fa-regular fa-image"></i> Ø§Ø®ØªØ± ØºÙ„Ø§Ù</div>` : `<img src="${item.previewUrl}">`;
                list.innerHTML += `<div class="media-item" data-id="${item.id}">${contentHtml}<div class="media-actions"><div class="action-btn delete" onclick="removeItem('${item.id}')"><i class="fa-solid fa-xmark"></i></div></div></div>`;
            });
            new Sortable(list, { animation: 250, handle: '.media-item', delay: 100, onEnd: function (evt) { const newOrderIds = Array.from(list.children).map(child => child.getAttribute('data-id')); mediaItems = newOrderIds.map(id => mediaItems.find(item => item.id === id)); } });
        }

        // --- Video Controls ---
        function togglePlay(id) {
    const vid = document.getElementById(`video_${id}`);
    const wrapper = document.getElementById(`wrapper_${id}`);
    const centerBtn = document.getElementById(`centerBtn_${id}`);
    const playIcon = document.getElementById(`playIcon_${id}`);

    if (vid.paused) { 
        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        vid.play().then(() => {
            // 2. Ø¥Ø°Ø§ Ø§Ø´ØªØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ù†Ø´ØºÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ÙÙ‚
            if (backgroundAudio) {
                backgroundAudio.currentTime = 0; // Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                backgroundAudio.play().catch(e => console.log("Audio play error:", e));
                
                // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙØ¹Ù„ "ÙƒØªÙ… Ø§Ù„Ø£ØµÙ„ÙŠ"ØŒ Ù†ÙƒØªÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ†Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
                if(typeof isOriginalMuted !== 'undefined' && isOriginalMuted) {
                    vid.muted = true;
                }
            }
        });

        wrapper.classList.remove('paused'); 
        centerBtn.style.opacity = '0'; 
        centerBtn.style.transform = 'scale(1.5)'; 
        playIcon.className = 'fa-solid fa-pause'; 

    } else { 
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        vid.pause(); 
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ÙÙ‚ ÙÙˆØ±Ø§Ù‹
        if (backgroundAudio) {
            backgroundAudio.pause();
        }

        wrapper.classList.add('paused'); 
        centerBtn.style.opacity = '1'; 
        centerBtn.style.transform = 'scale(1)'; 
        playIcon.className = 'fa-solid fa-play'; 
    }
}

        function updateProgress(id) {
            const vid = document.getElementById(`video_${id}`);
            const bar = document.getElementById(`progBar_${id}`);
            const curr = document.getElementById(`currTime_${id}`);
            if(vid.duration) { bar.style.width = `${(vid.currentTime / vid.duration) * 100}%`; curr.innerText = formatTime(vid.currentTime); }
        }
        function seekVideo(e, id) {
            const vid = document.getElementById(`video_${id}`);
            const rect = e.currentTarget.getBoundingClientRect();
            let pos = (e.clientX || e.touches[0].clientX) - rect.left;
            if(vid.duration) vid.currentTime = (Math.max(0, Math.min(pos, rect.width))/rect.width) * vid.duration;
        }
        function resetPlayer(id) {
    document.getElementById(`wrapper_${id}`).classList.add('paused');
    document.getElementById(`centerBtn_${id}`).style.opacity = '1';
    document.getElementById(`playIcon_${id}`).className = 'fa-solid fa-play';

    // ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª ÙˆØ±Ø¬Ø¹Ù‡ Ù„Ù„Ø£ÙˆÙ„
    if (backgroundAudio) {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
    }
}

        function toggleFullscreen(id) {
            const w = document.getElementById(`wrapper_${id}`), v = document.getElementById(`video_${id}`);
            if (!document.fullscreenElement) { (w.requestFullscreen || v.webkitEnterFullscreen).call(w.requestFullscreen ? w : v); } 
            else { document.exitFullscreen(); }
        }
        function formatTime(s) { if(!s) return "0:00"; const m=Math.floor(s/60); const sc=Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        function removeItem(id) { mediaItems = mediaItems.filter(item => item.id !== id); renderMediaList(); checkPostButton(); }

        // --- Cover Editor ---
        const coverModal = document.getElementById('coverModal'), coverVideo = document.getElementById('coverVideoPlayer'), coverSlider = document.getElementById('coverSlider');
        function openCoverEditor(id) {
            const item = mediaItems.find(x => x.id === id); if (!item) return;
            activeEditId = id; coverVideo.src = item.previewUrl; coverModal.style.display = 'flex';
            coverVideo.onloadedmetadata = () => { coverSlider.max = coverVideo.duration; coverSlider.value = 0; coverVideo.currentTime = 0; };
        }
        coverSlider.oninput = function() { coverVideo.currentTime = this.value; };
        function closeCoverModal() { coverModal.style.display = 'none'; coverVideo.pause(); activeEditId = null; }
        function saveCoverSelection() {
            if (!activeEditId) return;
            const canvas = document.getElementById('thumbCanvas');
            canvas.width = coverVideo.videoWidth; canvas.height = coverVideo.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(coverVideo, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
                const idx = mediaItems.findIndex(x => x.id === activeEditId);
                if (idx > -1) { 
                    mediaItems[idx].thumbBlob = blob; 
                    const vidEl = document.getElementById(`video_${activeEditId}`);
                    if(vidEl) vidEl.poster = URL.createObjectURL(blob);
                }
                closeCoverModal();
            }, 'image/jpeg', 0.85);
        }

        // --- Hashtags ---
        function openTagsModal() { document.getElementById('tagsModal').style.display = 'flex'; document.getElementById('tagInput').focus(); searchTags(''); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        async function searchTags(query) {
            const list = document.getElementById('tagsResultsList'), clean = query.replace('#','').toLowerCase(); list.innerHTML = '';
            if(clean.length > 0) list.innerHTML += `<div class="list-opt" onclick="addTag('${clean}')"><i class="fa-solid fa-plus"></i> <div><div>#${clean}</div><div style="font-size:11px;color:#777">Ø¬Ø¯ÙŠØ¯</div></div></div>`;
            if(clean.length === 0 && recentHashtags.length > 0) recentHashtags.forEach(tag => list.innerHTML += `<div class="list-opt" onclick="addTag('${tag}')"><i class="fa-solid fa-clock-rotate-left"></i> <div><div>#${tag}</div><div style="font-size:11px;color:#777">Ù…Ø¤Ø®Ø±Ø§Ù‹</div></div></div>`);
            if(clean.length >= 1) {
                try {
                    const s = await db.collection('hashtags').where('name','>=',clean).where('name','<=',clean+'\uf8ff').limit(5).get();
                    s.forEach(d => { if(d.data().name!==clean) list.innerHTML += `<div class="list-opt" onclick="addTag('${d.data().name}')"><i class="fa-solid fa-hashtag"></i> <div><div>#${d.data().name}</div></div></div>`; });
                } catch(e){}
            }
        }
        function addTag(tag) { if(!selectedTags.includes(tag)) { selectedTags.push(tag); renderTags(); } closeModal('tagsModal'); checkPostButton(); }
        function renderTags() {
            const c = document.getElementById('visualTagsContainer'); c.innerHTML = '';
            selectedTags.forEach(t => c.innerHTML += `<div class="tag-chip"><span>#${t}</span><i class="fa-solid fa-xmark" onclick="removeTag('${t}')"></i></div>`);
        }
        function removeTag(t) { selectedTags = selectedTags.filter(x => x!==t); renderTags(); checkPostButton(); }

        // --- Privacy & UI Checks ---
        function openPrivacy() { document.getElementById('privacyModal').style.display = 'flex'; }
        function setPrivacy(type) {
            currentPrivacy = type;
            const icon = document.getElementById('privacyIcon'), text = document.getElementById('privacyText');
            if(type==='public') { icon.className='fa-solid fa-earth-americas'; text.innerText='Ø§Ù„Ø¹Ø§Ù…Ø©'; }
            else if(type==='friends') { icon.className='fa-solid fa-user-group'; text.innerText='Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡'; }
            else { icon.className='fa-solid fa-lock'; text.innerText='Ø£Ù†Ø§ ÙÙ‚Ø·'; }
            document.querySelectorAll('.list-opt').forEach(el=>el.classList.remove('active'));
            document.getElementById(`opt-${type}`).classList.add('active');
            closeModal('privacyModal');
        }
        function checkPostButton() {
            const txt = document.getElementById('editor').innerText.trim();
            document.getElementById('postBtn').disabled = !(txt.length>0 || mediaItems.length>0 || selectedTags.length>0 || attachedSound !== null);
            document.getElementById('postBtn').disabled = !(txt.length>0 || mediaItems.length>0 || selectedTags.length>0);
            const circle = document.getElementById('charCircle'), percent = Math.min((txt.length / 2200) * 100, 100);
            if(circle) { circle.setAttribute('stroke-dasharray', `${percent}, 100`); circle.className = `circle ${percent > 90 ? 'danger' : (percent > 70 ? 'warning' : '')}`; }
        }

        // --- Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø± (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§) ---
        async function handlePost() {
    const overlay = document.getElementById('uploadOverlay');
    const progressTxt = document.getElementById('statusSub');
    overlay.style.display = 'flex';
    
    try {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
        if (!currentUserData) {
            const userDoc = await db.collection("users").doc(currentUser.uid).get();
            currentUserData = userDoc.data();
        }

        // 1. ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·
        const editor = document.getElementById('editor');
        let plainText = editor.innerText.trim();
        
        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = editor.innerHTML;
        
        let finalMentions = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ UID Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        let mentionsData = [];  // ğŸ”¥ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ØµÙˆØ±Ø©)

        tempDiv.querySelectorAll('.mention-node').forEach(span => {
            const uid = span.getAttribute('data-uid');
            const pic = span.getAttribute('data-pic'); // Ø¨Ù†Ø¬ÙŠØ¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù„ÙŠ Ø®Ø²Ù†Ø§Ù‡Ø§
            const name = span.innerText.replace('@', ''); // Ø§Ù„Ø§Ø³Ù… Ø¨Ø¯ÙˆÙ† @

            if(uid) {
                if(!finalMentions.includes(uid)) finalMentions.push(uid);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ù† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                mentionsData.push({
                    name: name,
                    pic: pic || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                    uid: uid
                });

                // ØªØ­ÙˆÙŠÙ„ Ù„Ø±Ø§Ø¨Ø· Ø¹Ø§Ø¯ÙŠ ÙÙŠ Ø§Ù„Ù€ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                const link = document.createElement('a');
                link.href = `profile.html?uid=${uid}`; 
                link.innerText = span.innerText; 
                link.style.color = '#5D5FEF';
                link.style.fontWeight = '800';
                link.style.textDecoration = 'none';
                span.parentNode.replaceChild(link, span);
            }
        });
        let finalHtml = tempDiv.innerHTML;
        // 2. Ø±ÙØ¹ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ (ØµÙˆØ± ÙˆÙÙŠØ¯ÙŠÙˆ)
        let uploadedMedia = [];
        for(let i=0; i<mediaItems.length; i++) {
            const item = mediaItems[i];
            let file = item.file;
            // Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            if(item.type === 'image') { 
                try { file = await imageCompression(file, {maxSizeMB:1, maxWidthOrHeight:1920}); } catch(e){} 
            }
            
            const fname = `${Date.now()}_${i}`;
            const ref = storage.ref(`posts/${currentUser.uid}/${fname}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            
            let mediaObj = { url: url, type: item.type };
            
            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
            if(item.type === 'video' && item.thumbBlob) {
                const tRef = storage.ref(`posts/${currentUser.uid}/thumb_${fname}`);
                await tRef.put(item.thumbBlob);
                mediaObj.thumbnail = await tRef.getDownloadURL();
            }
            uploadedMedia.push(mediaObj);
            progressTxt.innerText = Math.round(((i+1)/mediaItems.length)*100) + '%';
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª
        if(selectedTags.length > 0) {
            const batch = db.batch();
            selectedTags.forEach(t => { 
                recentHashtags = recentHashtags.filter(x=>x!==t); 
                recentHashtags.unshift(t); 
            });
            localStorage.setItem('my_recent_hashtags', JSON.stringify(recentHashtags.slice(0,20)));
            
            selectedTags.forEach(t => {
                const r = db.collection('hashtags').doc(t);
                batch.set(r, { name:t, postsCount: firebase.firestore.FieldValue.increment(1) }, {merge:true});
            });
            await batch.commit();
        }

        // --- ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ù…Ù†Ø·Ù‚ ÙŠØ´Ù…Ù„ Ø§Ù„ØµÙˆØª) ---
        let postType = 'text';
        if (uploadedMedia.length > 0) {
            postType = uploadedMedia.some(m => m.type === 'video') ? 'video' : 'image';
        } else if (attachedSound) {
            postType = 'sound'; // Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©
        }

        // 4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø¬Ø¯ÙˆÙ„ posts)
        const newPostRef = await db.collection('posts').add({
            uid: currentUser.uid,
            text: plainText,
            html: finalHtml, 
            media: uploadedMedia,
            hashtags: selectedTags,
            mentions: finalMentions,
            mentionsList: mentionsData,
            privacy: currentPrivacy,
            
            // === Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª ===
            hasSound: attachedSound !== null,
            soundInfo: attachedSound || null, 
            musicName: attachedSound ? attachedSound.name : null, 

            // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© Ø§Ù„Ù…Ø¶Ø§ÙØ©: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª (ÙƒØªÙ… Ø§Ù„Ø£ØµÙ„ÙŠ Ø£Ù… Ù„Ø§) ğŸ”¥ğŸ”¥ğŸ”¥
            soundSettings: {
                // Ø§Ù„Ù…ØªØºÙŠØ± isOriginalMuted Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¹Ø§Ù… (ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù†Ø³Ø®Øª Ø¯Ø§Ù„Ø© toggleMuteOriginal)
                muteOriginal: (typeof isOriginalMuted !== 'undefined') ? isOriginalMuted : false, 
                volume: 1.0 
            },

            type: postType,
            
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            likes: {}, 
            commentsCount: 0
        });

        // 5. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        if (finalMentions.length > 0) {
            const notifBatch = db.batch();
            const senderName = currentUserData ? currentUserData.name : "Ù…Ø³ØªØ®Ø¯Ù…";
            const senderPic = currentUserData ? currentUserData.profilePic : null;
            
            finalMentions.forEach(uid => {
                if (uid !== currentUser.uid) {
                    const newNotifRef = db.collection('notifications').doc();
                    notifBatch.set(newNotifRef, {
                        recipientId: uid,
                        senderUid: currentUser.uid,
                        senderName: senderName,
                        senderPic: senderPic,
                        type: 'mention', 
                        text: `Ø°ÙƒØ±Ùƒ ÙÙŠ Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯: ${plainText.substring(0, 30)}...`,
                        postId: newPostRef.id,
                        link: `profile.html?uid=${currentUser.uid}&post=${newPostRef.id}`, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        opened: false
                    });
                }
            });
            await notifBatch.commit();
        }

        clearDraft(); 
        location.href = 'home.html';

    } catch(e) {
        console.error(e);
        overlay.style.display = 'none';
        Swal.fire({icon:'error', title:'Ø®Ø·Ø£', 
        
        text:'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±'});
   await saveHashtagsToGlobalDB(plainText);

    }
    
}

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ù…Ø¹Ø±ÙØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙˆÙ‚)
// let attachedSound = null; 
// let backgroundAudio = null;

function checkUrlForSound() {
    const urlParams = new URLSearchParams(window.location.search);
    const sName = urlParams.get('soundName');
    const sAuthor = urlParams.get('soundAuthor');
    const sUrl = urlParams.get('soundUrl');
    const sImg = urlParams.get('soundImg');

    if (sName && sUrl) {
        attachedSound = {
            name: decodeURIComponent(sName),
            author: sAuthor ? decodeURIComponent(sAuthor) : 'Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶',
            url: decodeURIComponent(sUrl),
            img: sImg ? decodeURIComponent(sImg) : null
        };
        
        // ØªØ¬Ù‡ÙŠØ² Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Ù…Ø¬Ø±Ø¯ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ø¦Ù†)
        backgroundAudio = new Audio(attachedSound.url);
        backgroundAudio.loop = true;
        backgroundAudio.volume = 1.0;
        backgroundAudio.crossOrigin = "anonymous"; // Ù…Ø­Ø§ÙˆÙ„Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø¨Ø³ÙŠØ·Ø©

        renderSoundAttachment();
        checkPostButton(); 
    }
}

async function setupBackgroundAudio(url) {
    try {
        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙˆØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Blob)
        const response = await fetch(url);
        const blob = await response.blob();
        const localUrl = URL.createObjectURL(blob);

        // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ù„ÙŠ
        backgroundAudio = new Audio(localUrl);
        backgroundAudio.loop = true;
        backgroundAudio.volume = 1.0;

        // 3. ØªØ·Ø¨ÙŠÙ‚ Ø®Ø¯Ø¹Ø© "ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³"
        const unlock = () => {
            if (backgroundAudio.paused) {
                backgroundAudio.play().catch(e => console.log("Still waiting..."));
            }
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø©
            document.body.removeEventListener('click', unlock);
            document.body.removeEventListener('touchstart', unlock);
            document.body.removeEventListener('keydown', unlock);
        };

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ù…ÙƒÙ†Ø©
        document.body.addEventListener('click', unlock);
        document.body.addEventListener('touchstart', unlock);
        document.body.addEventListener('keydown', unlock); // Ø­ØªÙ‰ Ù„Ùˆ ÙƒØªØ¨ ÙÙŠ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠØ©
        backgroundAudio.play().catch(() => {
            // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ù†Ø¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ØµØºÙŠØ±Ø© Ø£Ùˆ Ø£ÙŠÙ‚ÙˆÙ†Ø©
            showToast("Ø§Ø¶ØºØ· ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ğŸ”Š");
        });

    } catch (e) {
        console.error("Error loading audio blob:", e);
        // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        backgroundAudio = new Audio(url);
    }
}

// Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù„Ù…Ø³Ø© Ù„Ù„Ø´Ø§Ø´Ø©
function unlockAudio() {
    if (!isAudioUnlocked && backgroundAudio) {
        backgroundAudio.play().then(() => {
            isAudioUnlocked = true;
            console.log("Audio unlocked by user interaction");
        }).catch(e => console.error(e));
    }
}


// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ
let isOriginalMuted = false; 

function renderSoundAttachment() {
    const container = document.getElementById('soundAttachmentContainer');
    if (!attachedSound) { container.innerHTML = ''; return; }

    container.innerHTML = `
        <div class="sound-attachment" onclick="forcePlaySound()"> <div class="sound-icon-wrapper" style="${attachedSound.img ? `background:url(${attachedSound.img}) center/cover` : ''}">
                ${attachedSound.img ? '' : '<i class="fa-solid fa-music"></i>'}
            </div>
            
            <div class="sound-info-box">
                <span class="sound-name-preview">${attachedSound.name}</span>
                <span class="sound-author-preview">${attachedSound.author}</span>
                
                <div style="display:flex; gap:10px;">
                    <label class="sound-option-label" style="display:flex; align-items:center; gap:5px; margin-top:5px; cursor:pointer;" onclick="event.stopPropagation()">
                        <input type="checkbox" id="muteOriginalCheckbox" onchange="toggleMuteOriginal()" style="accent-color:#5D5FEF;">
                        <span style="font-size:10px; color:#ddd;">ÙƒØªÙ… Ø§Ù„Ø£ØµÙ„ÙŠ</span>
                    </label>
                    
                    <div id="soundStatusIcon" style="font-size:10px; color:#ffb533; display:none; align-items:center; gap:3px;">
                        <i class="fa-solid fa-volume-xmark"></i> Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ…
                    </div>
                </div>
            </div>

            <div class="remove-sound-btn" onclick="removeAttachedSound(); event.stopPropagation();">
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
    `;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© Ù‡Ù„ Ø§Ø´ØªØºÙ„ Ø§Ù„ØµÙˆØª Ø£Ù… Ù„Ø§
    setTimeout(() => {
        if (backgroundAudio && backgroundAudio.paused) {
            document.getElementById('soundStatusIcon').style.display = 'flex';
        }
    }, 500);
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ
function forcePlaySound() {
    if(backgroundAudio && backgroundAudio.paused) {
        backgroundAudio.play();
        const icon = document.getElementById('soundStatusIcon');
        if(icon) icon.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ ØªØ­Ø°ÙŠØ± Ø§Ù„ÙƒØªÙ…
    }
}

function toggleMuteOriginal() {
    const checkbox = document.getElementById('muteOriginalCheckbox');
    isOriginalMuted = checkbox.checked;
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const allVideos = document.querySelectorAll('video[id^="video_"]');
    allVideos.forEach(vid => {
        vid.muted = isOriginalMuted;
    });
}

function removeAttachedSound() {
    if (backgroundAudio) {
        backgroundAudio.pause();
        backgroundAudio = null; // Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø¦Ù†
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙƒØªÙˆÙ…Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ÙÙ‚
    isOriginalMuted = false;
    const allVideos = document.querySelectorAll('video[id^="video_"]');
    allVideos.forEach(vid => vid.muted = false);

    attachedSound = null;
    renderSoundAttachment();
    checkPostButton();
    window.history.replaceState({}, document.title, window.location.pathname);
}


document.addEventListener('DOMContentLoaded', () => {
        checkUrlForSound();
    });
// Ø¶ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ ÙÙŠ Ù…Ù„Ù Javascript ÙˆØ§Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±
async function saveHashtagsToGlobalDB(text) {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØ¨Ø¯Ø£ Ø¨Ù€ #
    const tags = text.match(/#[\u0600-\u06FFa-zA-Z0-9_]+/g) || [];
    
    if (tags.length === 0) return;

    const batch = db.batch();

    tags.forEach(tagRaw => {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬ (Ù†Ø´ÙŠÙ„ #)
        const tagClean = tagRaw.replace('#', ''); 
        
        // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ (Ø¨Ù†Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬ ÙƒÙ€ ID Ø¹Ø´Ø§Ù† Ù…ÙŠØªÙƒØ±Ø±Ø´)
        const ref = db.collection('hashtags').doc(tagClean);
        
        // Ø¨Ù†Ø³ØªØ®Ø¯Ù… set Ù…Ø¹ merge ÙˆÙ…Ù‚Ø¯Ø§Ø± Ø§Ù„Ø²ÙŠØ§Ø¯Ø©
        batch.set(ref, {
            tag: tagClean, // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡
            count: firebase.firestore.FieldValue.increment(1), // ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯
            lastUsed: firebase.firestore.FieldValue.serverTimestamp() // ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ù„Ù„ØªØ±ÙŠÙ†Ø¯)
        }, { merge: true });
    });

    await batch.commit();
}


    </script>
</body>
</html>
