<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050b14">

    <title>Wareed Chat - Professional</title>
.    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
      
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
    
        /* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ±ÙŠØ¯ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Wareed Style) ================= */
        :root { 
            --bg-primary: #050b14; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
            --bg-secondary: #0f1926; /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            --accent-color: #00e5ff; /* Ø§Ù„Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ø¶ÙŠØ¡ */
            --accent-gradient: linear-gradient(135deg, #00e5ff, #2979ff); /* ØªØ¯Ø±Ø¬ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
            --msg-sender: linear-gradient(135deg, #0066cc, #00c6ff); /* ØªØ¯Ø±Ø¬ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„ */
            --msg-receiver: rgba(255, 255, 255, 0.08); /* Ø²Ø¬Ø§Ø¬ÙŠ Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ */
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 25, 38, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body {
    height: 100%;       /* Ø§Ù„ØµÙØ­Ø© ØªØ§Ø®Ø¯ Ø·ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    margin: 0;
    padding: 0;
    overflow: hidden;   /* Ù…Ù†Ø¹ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ */
}

/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Cyan Tech Vibes) ================= */
/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Aurora Tech) ================= */
/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Cyan Tech Vibes) ================= */
body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    
    /* 1. Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠØ¨Ø±Ø² Ø§Ù„Ø³ÙŠØ§Ù†) */
    background-color: #050b14;

    /* 2. Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© (ØªØ¯Ø±Ø¬Ø§Øª + Ù†Ù…Ø·) */
    background-image: 
        /* Ø¨Ù‚Ø¹Ø© Ø¶ÙˆØ¡ Ø³ÙŠØ§Ù† (Cyan) Ù‚ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ø´Ù…Ø§Ù„ */
        radial-gradient(circle at 0% 0%, rgba(0, 229, 255, 0.15) 0%, transparent 60%),
        
        /* Ø¨Ù‚Ø¹Ø© Ø¶ÙˆØ¡ Ø²Ø±Ù‚Ø§Ø¡ (Blue) ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ÙŠÙ…ÙŠÙ† */
        radial-gradient(circle at 100% 100%, rgba(41, 121, 255, 0.10) 0%, transparent 60%),
        
        /* Ù†Ù…Ø· Ù‡Ù†Ø¯Ø³ÙŠ Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ (Ø´Ø¨ÙƒØ© Ù…Ø§Ø¦Ù„Ø©) Ù„ÙŠØ¹Ø·ÙŠ Ø¹Ù…Ù‚ Ø§Ø­ØªØ±Ø§ÙÙŠ */
        repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.02) 0px, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 40px),
        repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 0px, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 40px);

    background-attachment: fixed; /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØªØ­Ø±Ùƒ ÙÙˆÙ‚Ù‡Ø§ Ø¨Ù†Ø¹ÙˆÙ…Ø© */
    display: flex;
    flex-direction: column;
}

/* ================= Ù„Ù…Ø³Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ================= */
/* Ø¥Ø¶Ø§ÙØ© "ØªÙˆÙ‡Ø¬" Ù…ØªØ­Ø±Ùƒ Ø¨Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© */
body::before {
    content: '';
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 100vw; height: 100vh;
    background: radial-gradient(circle, rgba(0, 229, 255, 0.03), transparent 70%);
    z-index: -1; /* Ø®Ù„Ù ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    pointer-events: none;
    animation: breatheGlow 8s infinite alternate ease-in-out;
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªÙ†ÙØ³ Ù„Ù„Ø¶ÙˆØ¡ Ø§Ù„Ø®Ù„ÙÙŠ */
@keyframes breatheGlow {
    0% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.8); }
    100% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
}


.icon-btn:active { transform: scale(0.95); }
.icon-btn.video { color: #00e5ff; }


/
.icon-btn:active { transform: scale(0.95); }

        .icon-btn:active { transform: scale(0.9); background: rgba(0, 229, 255, 0.1); }
        .icon-btn.video { color: #00e5ff; }
        .icon-btn.audio { color: #fff; }

        /* ================= Ø¬Ø³Ù… Ø§Ù„Ø´Ø§Øª ================= */
.chat-body { 
    flex: 1; 
    overflow-y: auto; 
    padding: 20px 15px; 
    display: flex; 
    flex-direction: column; 
    gap: 20px; 
    width: 100%; 
    
    /* ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø²ÙˆØ¯Ù†Ø§ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØªØ±ÙØ¹ ÙÙˆÙ‚ Ø§Ù„ÙÙˆØªØ± */
    padding-bottom: 160px !important; 
}


        
        
        .msg-user-avatar { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: #333; flex-shrink: 0; background-size: cover; 
            display: none; place-items: center; font-size: 10px; color: #fff; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .receiver .msg-user-avatar { display: grid; }


        /* ================= Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆÙ…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ================= */
       /* ================= Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆÙ…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ù…Ø³ØªØ¯ÙŠØ±Ø©) ================= */

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
.media-container { 
    /* Ø¬Ø¹Ù„ Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø³ØªØ¯ÙŠØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø«Ù„ Ø§Ù„ÙÙˆØªØ± */
    border-radius: 25px !important; 
    overflow: hidden; 
    margin-top: 5px; 
    border: 1px solid rgba(255,255,255,0.15); 
    position: relative; 
    min-width: 200px; min-height: 150px; 
    background: #000; 
    display: flex; justify-content: center; align-items: center; 
    cursor: pointer; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ø®ÙÙŠÙ */
}

.msg-image, .msg-video { 
    max-width: 100%; max-height: 300px; 
    object-fit: cover; display: block; 
}

/* Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯) */
.custom-audio-player { 
    display: flex; align-items: center; gap: 10px; 
    width: 240px; /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ */
    padding: 8px 12px;
    /* Ø¬Ø¹Ù„ Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø³ØªØ¯ÙŠØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    border-radius: 25px !important;
    background: rgba(255,255,255,0.08); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
    border: 1px solid rgba(255,255,255,0.1);
    margin-top: 5px;
    backdrop-filter: blur(5px);
}

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´ØºÙ„ */
.play-btn { 
    background: var(--accent-gradient); /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ */
    color: #fff; border: none; 
    width: 38px; height: 38px; 
    border-radius: 50%; /* Ø¯Ø§Ø¦Ø±ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    display: grid; place-items: center; 
    cursor: pointer; transition: 0.2s;
    box-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
    flex-shrink: 0;
}
.play-btn:active { transform: scale(0.9); }

/* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª */
.audio-slider { 
    flex: 1; height: 4px; accent-color: var(--accent-color); border-radius: 2px;
}

/* ØªÙˆÙ‚ÙŠØª Ø§Ù„ØµÙˆØª */
.audio-duration {
    font-size: 11px; color: #cbd5e1; min-width: 35px; text-align: center;
}

        /* ================= Ø§Ù„ÙÙˆØªØ± /* ================= Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ø´ÙƒÙ„ + ÙˆØ¸Ø§Ø¦Ù) ================= */


/* === 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Absolute ØªØºØ·ÙŠ Ø§Ù„ÙÙˆØªØ± ÙƒÙ„Ù‡) === */
.recording-ui {
    position: absolute;
    inset: 0; /* ØªØºØ·ÙŠ Ø§Ù„ÙÙˆØªØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    background: #1e293b;
    border-radius: 35px;
    z-index: 2005;
    display: none; /* Ù…Ø®ÙÙŠ */
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
}
/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© */
.rec-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
.wave-bar { width: 3px; background: #ff3b30; border-radius: 2px; animation: wave 1s infinite ease-in-out; }
@keyframes wave { 0%, 100% { transform: scaleY(0.5); opacity: 0.5; } 50% { transform: scaleY(1); opacity: 1; } }

/* === 3. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø²Ø±Ø§ÙŠØ± (Grouping) === */
.footer-side-actions {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0; /* Ù…Ù…Ù†ÙˆØ¹ ÙŠÙ†ÙƒÙ…Ø´ */
}

/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ */
.send-btn {
    width: 45px; height: 45px; border-radius: 50%;
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    color: #fff; display: none; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); font-size: 18px;
    margin-bottom: 2px; /* Ø±ÙØ¹Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    flex-shrink: 0;     /* Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */

}
.mic-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.05); color: #fff;
    margin-bottom: 2px; /* Ø±ÙØ¹Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    flex-shrink: 0;     /* Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */

}

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .recording-ui { 
            position: absolute; inset: 0; 
            background: #1e293b; 
            border-radius: 25px; z-index: 2005; 
            display: none; align-items: center; justify-content: space-between; 
            padding: 0 20px;
            animation: slideUpFade 0.2s ease;
        }
        .rec-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
        .wave-bar { width: 3px; background: var(--danger); border-radius: 2px; animation: wave 1s infinite ease-in-out; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 25px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 15px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 10px; }
        @keyframes wave { 0%, 100% { transform: scaleY(0.5); opacity: 0.5; } 50% { transform: scaleY(1); opacity: 1; } }

        /* ================= Ø§Ù†ÙŠÙ…ÙŠØ´Ù† ================= */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpFade { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ================= Ø¹Ù†Ø§ØµØ± Ø¥Ø¶Ø§ÙÙŠØ© (Ù‚ÙˆØ§Ø¦Ù…ØŒ Ù…ÙƒØ§Ù„Ù…Ø§Øª) ================= */
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .context-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: flex-end; backdrop-filter: blur(2px); }
        .context-menu { background: #1e293b; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; transform: translateY(100%); transition: 0.3s; color: #fff; border-top: 1px solid rgba(255,255,255,0.1); }
        .context-menu.active { transform: translateY(0); }
        .menu-btn { background: rgba(255,255,255,0.05); color: #fff; border: none; padding: 15px; border-radius: 12px; font-size: 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px; width: 100%; transition: 0.2s; }
        .menu-btn:active { background: rgba(255,255,255,0.1); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
        
        /* Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© */
        /* ================= Ø¥ØµÙ„Ø§Ø­ Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯ (ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹) ================= */

/* 1. Ø§Ù„Ø´Ø±ÙŠØ· Ù†ÙØ³Ù‡ (Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª) */
.reply-preview-bar {
    position: absolute;
    bottom: 100%; /* ÙÙˆÙ‚ Ø§Ù„ÙÙˆØªØ± Ù…Ø¨Ø§Ø´Ø±Ø© */
    left: 0; 
    right: 0;
    height: 50px !important; /* ğŸ‘ˆ Ø¯Ù‡ Ø£Ù‡Ù… Ø³Ø·Ø±: Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù…Ù…Ù†ÙˆØ¹ ÙŠØ²ÙŠØ¯ */
    background: rgba(30, 41, 59, 0.98); /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ø§Ù† */
    border-top: 1px solid rgba(255,255,255,0.1);
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 50;
    overflow: hidden; /* Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ²ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù€ 50 Ø¨ÙƒØ³Ù„ ØªØ®ØªÙÙŠ */
    border-radius: 15px 15px 0 0;
    margin: 0 10px;
    border-left: 4px solid var(--accent-color);
}

/* 2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒÙ„Ø§Ù… (ØªÙ…Ù†Ø¹ Ø§Ù„Ù†Øµ ÙŠØ²Ù‚ Ø§Ù„Ø´Ø±ÙŠØ·) */
.reply-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex: 1; 
    min-width: 0; /* ğŸ‘ˆ Ø³Ø­Ø± Ø§Ù„Ù€ Flexbox: Ø¨ÙŠØ¬Ø¨Ø± Ø§Ù„Ù†Øµ ÙŠØ­ØªØ±Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
    margin-right: 10px;
}

/* 3. Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ */
.reply-title {
    color: var(--accent-color);
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

/* 4. Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) */
.reply-text {
    color: #94a3b8;
    font-size: 11px;
    display: block !important;
    width: 100%;
    white-space: nowrap !important; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    overflow: hidden !important;    /* ÙŠÙ‚Øµ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© */
    text-overflow: ellipsis !important; /* ÙŠØ­Ø· ... ÙÙŠ Ø§Ù„Ø¢Ø®Ø± */
}

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
.close-reply {
    padding: 10px;
    color: #ff3b30;
    cursor: pointer;
    font-size: 16px;
}

        /* Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ */
        .destruct-btn { color: #64748b; position: relative; }
        .destruct-btn.active { color: var(--danger); animation: pulse-red 2s infinite; }
        .destruct-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 8px; padding: 2px 4px; border-radius: 4px; }
        .bomb-timer { font-size: 10px; color: var(--danger); display: flex; align-items: center; gap: 3px; background: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 5px; }

        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(0, 229, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0); } }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
/* Ø±Ø³Ø§Ù„Ø© ØªØ§Ø¨Ø¹Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ (Ù„ÙŠØ³Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©) */
.msg-row.same-sender {
    margin-top: 2px; /* Ù…Ø³Ø§ÙØ© Ø£Ù‚Ù„ */
}
.msg-row.same-sender .msg-user-avatar {
    visibility: hidden; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
}
.msg-row.same-sender .msg-bubble {
    border-top-left-radius: 4px; /* Ø²Ø§ÙˆÙŠØ© Ø­Ø§Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¨Ø¯Ùˆ Ù…ØªØµÙ„Ø© */
}
/* Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„ØªÙŠ Ø£Ù†Ø§ */
.msg-row.sender.same-sender .msg-bubble {
    border-top-right-radius: 4px;
}
/* ================= Ø¥Ø¶Ø§ÙØ§Øª ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø´Ø§Øª ================= */

/* 1. ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® */
.date-divider {
    display: flex; justify-content: center; margin: 20px 0; 
    position: sticky; top: 10px; z-index: 5;
}
.date-divider span {
    background: rgba(15, 25, 38, 0.85); /* Ù†ÙØ³ Ù„ÙˆÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± */
    padding: 4px 12px; border-radius: 12px;
    font-size: 11px; color: #94a3b8; 
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ) */
.msg-row.same-sender {
    margin-top: 2px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© */
    animation: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ø±ÙØ© */
}
.msg-row.same-sender .msg-user-avatar {
    opacity: 0; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
}
/* ØªØ¹Ø¯ÙŠÙ„ Ø²ÙˆØ§ÙŠØ§ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¹Ø´Ø§Ù† ØªØ¨Ø§Ù† Ù…ØªØµÙ„Ø© */
.msg-row.sender.same-sender .msg-bubble { border-top-right-radius: 4px; }
.msg-row.receiver.same-sender .msg-bubble { border-top-left-radius: 4px; }

/* 3. Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ (Ticks) */
/* ================= ØªØµÙ…ÙŠÙ… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø¹ÙŠÙ†) ================= */

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.msg-status {
    font-size: 12px !important; /* ÙƒØ¨Ø±Ù†Ø§ Ø§Ù„Ø®Ø· Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ¨Ø§Ù† */
    margin-left: 5px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}

/* Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù„Ø³Ù‡ Ù…Ø§ Ø§ØªØ´Ø§ÙØªØ´) */
.msg-status i {
    color: rgba(255, 255, 255, 0.5); /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø¨Ø§Ù‡Øª */
    font-size: 11px;
}

/* --- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Seen) --- */
.msg-status.seen-eye {
    color: #00e5ff !important; /* Ù„ÙˆÙ† Ø³ÙŠØ§Ù† ÙØ§Ù‚Ø¹ */
    text-shadow: 0 0 8px rgba(0, 229, 255, 0.6); /* ØªÙˆÙ‡Ø¬ Ù†ÙŠÙˆÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹ÙŠÙ† */
    transform: scale(1.1); /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ø´Ø§Ù† ØªØ®Ø·Ù Ø§Ù„Ø¹ÙŠÙ† */
}

.msg-status.seen-eye i {
    font-size: 13px; /* Ø§Ù„Ø¹ÙŠÙ† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ø³Ù†Ø© Ù…Ù† Ø§Ù„ØµØ­ */
}

.sender .msg-status { color: rgba(255,255,255,0.7); } /* Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ */
.msg-status.seen { color: #34b7f1; } /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */

    /* ØªÙ†Ø³ÙŠÙ‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
.preview-modal {
    position: fixed; inset: 0; 
    background: rgba(0,0,0,0.9); z-index: 8000;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}
.preview-content {
    background: #1e293b; padding: 20px; border-radius: 20px;
    width: 90%; max-width: 400px; text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}
.preview-img, .preview-vid {
    max-width: 100%; max-height: 50vh; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
}
.preview-actions {
    display: flex; gap: 15px; justify-content: center;
}
.btn-cancel, .btn-send {
    padding: 10px 25px; border-radius: 10px; border: none; cursor: pointer;
    font-family: inherit; font-weight: bold; font-size: 14px; transition: 0.2s;
}
.btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
.btn-send { background: var(--accent-gradient); color: #fff; }
.btn-cancel:active, .btn-send:active { transform: scale(0.95); }
    
.scroll-bottom-btn {
    position: fixed;
    bottom: 90px; /* ÙÙˆÙ‚ Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø´ÙˆÙŠØ© */
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(30, 41, 59, 0.9);
    color: var(--accent-color);
    border: 1px solid var(--accent-color);
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1500;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: 0.3s;
    animation: fadeIn 0.3s;
}
.scroll-bottom-btn:hover {
    background: var(--bg-secondary);
    transform: scale(1.1);
}

    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ù */
.file-card {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px 15px; border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer; transition: 0.2s; min-width: 200px;
}
.file-card:hover { background: rgba(255, 255, 255, 0.1); }
.file-icon {
    width: 40px; height: 40px; border-radius: 8px;
    background: #334155; display: grid; place-items: center;
    color: #fff; font-size: 20px;
}
.file-info { display: flex; flex-direction: column; gap: 2px; }
.file-name { font-size: 13px; font-weight: bold; color: #fff; word-break: break-all; }
.file-size { font-size: 10px; color: #94a3b8; }

   /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª */
.chat-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(0, 229, 255, 0.1); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø³Ù…Ø§ÙˆÙŠ */
    color: #00e5ff !important;
    padding: 4px 10px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 4px;
    border: 1px solid rgba(0, 229, 255, 0.2);
    transition: 0.2s;
    font-size: 13px;
}
.chat-link::before {
    content: '\f0c1'; /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Link FontAwesome */
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
}
.chat-link:hover {
    background: rgba(0, 229, 255, 0.2);
    transform: translateY(-1px);
}
/* Ø­Ø§ÙˆÙŠØ© ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ */
.yt-embed-container {
    position: relative;
    padding-bottom: 56.25%; /* Ù†Ø³Ø¨Ø© 16:9 */
    height: 0;
    overflow: hidden;
    max-width: 100%;
    border-radius: 12px;
    margin-top: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: #000;
}
.yt-embed-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
    /* ================= Ø­Ù„ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù‚Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© ================= */

/* 1. Ù‚Øµ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) */
.reply-text {
    display: block !important;
    width: 100% !important;
    max-width: 70vw !important; /* Ø¹Ø´Ø§Ù† Ù…ÙŠØºØ·ÙŠØ´ Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØºÙ„Ø§Ù‚ */
    white-space: nowrap !important; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    overflow: hidden !important; /* ÙŠØ®ÙÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© */
    text-overflow: ellipsis !important; /* ÙŠØ­Ø· Ù†Ù‚Ø· ... */
    color: #cbd5e1;
    font-size: 12px;
}

/* 2. Ù‚Øµ Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª (Ø³Ø·Ø±ÙŠÙ† ÙÙ‚Ø·) */
.replied-body {
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important; /* ÙŠØ¸Ù‡Ø± Ø³Ø·Ø±ÙŠÙ† Ø¨Ø³ */
    -webkit-box-orient: vertical !important;
    overflow: hidden !important; /* ÙŠØ®ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ */
    white-space: normal !important; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø³Ø·Ø±ÙŠÙ† */
    text-overflow: ellipsis !important;
    color: rgba(255, 255, 255, 0.9);
    font-size: 11px;
    margin-top: 2px;
}

/* Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¯ Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒØ¨Ø±Ø´ */
.replied-msg-context {
    max-height: 52px !important; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
    overflow: hidden !important;
    justify-content: center; /* ÙŠØ®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… ÙÙŠ Ø§Ù„Ù†Øµ */
}


/* 1. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø±Ø³Ø§Ø¦Ù„ÙŠ Ø£Ù†Ø§ (Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡) */
.sender .replied-msg-context {
    /* Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ±: Ù„ÙˆÙ† Ø£Ø³ÙˆØ¯ Ø´ÙØ§Ù ÙŠØºÙ…Ù‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ */
    background: rgba(0, 0, 0, 0.25) !important; 
    border-right-color: rgba(255, 255, 255, 0.8); /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ø¨ÙŠØ¶ */
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ) */
.receiver .replied-msg-context {
    /* Ù„ÙˆÙ† Ø£Ø³ÙˆØ¯ Ø´ÙØ§Ù Ø£ØªÙ‚Ù„ Ø´ÙˆÙŠØ© */
    background: rgba(0, 0, 0, 0.3) !important;
    border-right-color: var(--accent-color); /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø³ÙŠØ§Ù† */
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø¯ */
.replied-sender {
    font-weight: 800;
    margin-bottom: 2px;
    /* Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ Ù„Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø±Ø¯ Ø¹Ø´Ø§Ù† ÙŠØ®Ø·Ù Ø§Ù„Ø¹ÙŠÙ† */
    color: #ffd700 !important; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„ÙƒÙ„Ø§Ù… */
}

/* ================= ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØµÙˆØ±Ø© ==============
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ÙˆØ¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ */
.msg-meta {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 4px;
    margin-top: 2px;
    font-size: 10px;
    opacity: 0.7;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù„ÙŠÙ†Ùƒ (TikTok Card) */
.link-preview-card {
    background: #1e1e1e !important; /* Ù„ÙˆÙ† Ø§ÙØªØ­ Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© */
    border-radius: 12px !important;
    margin-top: 5px;
    border: 1px solid #333;
}
.lp-title { color: #e1e1e1 !important; font-size: 13px !important; }
.lp-desc { color: #aaa !important; }
    

/* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© */
/* ================= ØªØµÙ…ÙŠÙ… Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ø¬Ø²Ø¦ÙŠÙ†: ÙÙˆÙ‚ ÙˆØªØ­Øª) */
.call-overlay { 
    position: fixed; inset: 0; 
    background: #000; 
    z-index: 9999; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† ÙŠØºØ·ÙŠ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: none; 
    flex-direction: column; 
    justify-content: space-between; /* Ø§Ù„Ø³Ø±: ÙŠØ±Ù…ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø£Ø·Ø±Ø§Ù */
    padding: 80px 30px 50px; /* Ù…Ø³Ø§ÙØ§Øª Ù…Ø±ÙŠØ­Ø© Ù…Ù† ÙÙˆÙ‚ ÙˆØªØ­Øª */
}

/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© */
.call-bg {
    position: absolute; inset: 0;
    background-size: cover; background-position: center;
    filter: blur(30px) brightness(0.4); /* ØªØ¹ØªÙŠÙ… Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ø§Ù† */
    z-index: 1;
    transform: scale(1.1); /* Ø¹Ø´Ø§Ù† Ù†Ø¹Ø§Ù„Ø¬ Ø­ÙˆØ§Ù Ø§Ù„Ø¨Ù„ÙˆØ± */
}

/* 2. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ (ØµÙˆØ±Ø© ÙˆØ§Ø³Ù…) */
.call-info-section {
    position: absolute; /* ØªØºÙŠÙŠØ± Ù„Ù€ Absolute */
    top: 15%; /* Ù…ÙƒØ§Ù†Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ ÙÙˆÙ‚ */
    left: 0; right: 0;
    z-index: 10;
    display: flex; flex-direction: column; align-items: center;
    transition: all 0.3s ease;
}
.video-active-mode .call-info-section {
    opacity: 0; /* Ø§Ø®ÙØ§Ø¡ Ù†Ø§Ø¹Ù… */
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ø·Ù„Ø´ Ø§Ù„Ù„Ù…Ø³ */
}
/* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø· Ø¨Ø´ÙƒÙ„ ØµØºÙŠØ± ØªØ­Øª Ø¹Ù†Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-active-mode .call-info-section.show-brief {
    opacity: 1;
    top: auto; bottom: 100px;
    transform: scale(0.8);
}

.call-avatar { 
    width: 140px; height: 140px; 
    border-radius: 50%; 
    border: 3px solid rgba(255,255,255,0.15); 
    margin-bottom: 25px; 
    background-size: cover; background-position: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªÙ†ÙØ³ */
    animation: breathing 3s infinite ease-in-out;
}

.call-name {
    font-size: 28px; font-weight: 700; color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    margin-bottom: 8px;
    font-family: 'Cairo', sans-serif;
}

.call-status {
    font-size: 15px; color: rgba(255,255,255,0.8);
    background: rgba(255,255,255,0.1);
    padding: 6px 20px; border-radius: 20px;
    backdrop-filter: blur(5px);
}

/* Ø²Ø± Ø§Ù„Ø±ÙØ¶ Ù„Ù…Ø§ Ø­Ø¯ ÙŠØ±Ù† Ø¹Ù„ÙŠÙƒ - Ø¨ÙŠØªÙ‡Ø² */
#incomingCallControls .call-btn.end {
    animation: shake 1.2s infinite ease-in-out;
}

/* ================= Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ================= */
@keyframes breathing {
    0%, 100% { transform: scale(1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    50% { transform: scale(1.05); box-shadow: 0 15px 50px rgba(0, 229, 255, 0.2); }
}
@keyframes pulse-green {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
@keyframes shake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-10deg); }
    100% { transform: rotate(0deg); }
}

/* ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØµØºÙŠØ± (Ù„Ù…Ø§ Ù†ÙØ¹Ù„Ù‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª) */
/* ================= CSS ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ØµØºØ± ================= */

/* ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØµØºÙŠØ± - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²ÙˆØ§Ø¦Ø¯ */
.call-overlay.minimized {
    width: 110px !important; height: 160px !important;
    bottom: 120px !important; right: 20px !important;
    top: auto !important; left: auto !important;
    border-radius: 18px !important;
    padding: 0 !important;
    border: 2px solid rgba(255,255,255,0.2) !important;
    background: #1e293b !important;
    overflow: hidden !important; /* ÙŠÙ‚Øµ Ø£ÙŠ Ø­Ø§Ø¬Ø© Ø¨Ø±Ù‡ */
    display: flex !important; align-items: center; justify-content: center;
}


/* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¬ÙˆÙ‡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø© */
.minimized .call-bg { display: none !important; } 

.minimized .call-avatar { 
    width: 60px !important; 
    height: 60px !important; 
    margin-bottom: 5px !important; 
    border-width: 2px !important; 
    box-shadow: none !important;
    display: none !important; 

}

.minimized .call-name { 
    font-size: 13px !important; 
    margin-bottom: 2px !important; 
    white-space: nowrap; 
    max-width: 100%; 
    overflow: hidden; 
    text-overflow: ellipsis;
    display: none !important; 

}

.minimized .call-status { 
    font-size: 10px !important; 
    padding: 2px 6px !important;
    background: rgba(255,255,255,0.05) !important;
    display: none !important; 

}

/* Ø¥Ø®ÙØ§Ø¡ ØªØ§Ù… Ù„ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ØµØºØ± Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ Ù…ÙŠØ¨ÙˆØ¸Ø´ */
.minimized .call-controls-section { 
    display: none !important; 
}

.minimized .controls-dock { 
    display: none !important; 
}

.minimized .call-btn { 
    display: none !important; 
}

.minimized #activeCallControls { 
    display: none !important; 
}

.minimized #incomingCallControls { 
    display: none !important; 
}

/* Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙ‚Ø· */
.minimized .call-info-section { 
    display: flex !important; 
    transform: scale(0.9); /* ØªØµØºÙŠØ± Ø®ÙÙŠÙ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ */
    margin: 0 !important;
    width: 100%;
    align-items: center;
    justify-content: center;
    position: static !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù€ Absolute */
    transform: scale(0.7);
    
    opacity: 1 !important; /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¸Ù‡ÙˆØ± */

}

/* Ø²Ø±Ø§Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± (ÙŠØºØ·ÙŠ Ø§Ù„ÙƒØ§Ø±Øª ÙƒÙ„Ù‡) */
.maximize-btn {
    display: none;
    position: absolute; inset: 0; z-index: 100; cursor: pointer;
}
.minimized .maximize-btn { display: block; }

/* === Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ (Ø£Ù„ÙˆØ§Ù†Ùƒ) === */

.call-btn.video { background: rgba(255,255,255,0.15); }
.call-btn.switch-cam { background: rgba(255, 255, 255, 0.2); font-size: 20px; width: 55px; height: 55px; }
.call-btn.video.active-state { background: #fff !important; color: #000 !important; }

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-container {
    position: absolute; 
    inset: 0; 
    z-index: 5; /* ğŸ‘ˆ ÙƒØ§Ù† 0 ÙˆØ®Ù„ÙŠÙ†Ø§Ù‡ 5 Ø¹Ø´Ø§Ù† ÙŠØ·Ù„Ø¹ ÙÙˆÙ‚ */
    background: #000;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
}
.remote-video { width: 100%; height: 100%; object-fit: cover; }

/* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ (PIP) */
.local-video {
    position: absolute; 
    bottom: 120px; right: 20px; 
    width: 100px; height: 140px;
    background: #333;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    object-fit: cover;
    z-index: 5;
    transition: 0.3s;
}
/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØºÙŠØ± */
.minimized .local-video { display: none !important; }

.call-btn.snapshot { background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; font-size: 20px; }
.local-video { z-index: 100 !important; box-shadow: 0 10px 30px rgba(0,0,0,0.8); cursor: grab; }
.local-video:active { cursor: grabbing; }

.calling-pulse { animation: ring-pulse 2s infinite; }
@keyframes ring-pulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(0, 229, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0); }
}

.call-btn.screen-share { background: rgba(255, 255, 255, 0.15); font-size: 20px; }
.call-btn.screen-share.active-state { background: #fff !important; color: #000 !important; box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }

.remote-screen-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 1; background: #000; }

.presentation-mode .remote-video {
    position: absolute; top: 20px; left: 20px; width: 100px; height: 140px;
    border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5); object-fit: cover; z-index: 10; transition: 0.3s;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ø¦Ù… */
.controls-dock {
    position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
    background: rgba(20, 30, 45, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    padding: 12px 25px; border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; gap: 20px; width: fit-content; z-index: 100;
}
.controls-dock .call-btn { width: 50px; height: 50px; background: transparent; box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
.controls-dock .call-btn:hover { background: rgba(255,255,255,0.1); }
.controls-dock .call-btn.end { background: #ff3b30 !important; width: 60px; border: none; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); }

.msg-bubble:has(.fa-phone-slash), .msg-bubble:has(.fa-phone) {
    background: rgba(15, 23, 42, 0.6) !important; border: 1px solid rgba(255,255,255,0.1) !important;
    box-shadow: none !important; backdrop-filter: blur(4px); width: fit-content;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙˆØªØ± */
.action-btn {
    width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.08); color: #94a3b8;
    cursor: pointer; transition: all 0.3s ease; font-size: 18px; position: relative; flex-shrink: 0;
}
.action-btn:active { transform: scale(0.9); }
.media-btn:hover { color: #00e5ff; border-color: rgba(0, 229, 255, 0.3); background: rgba(0, 229, 255, 0.1); }
.file-btn:hover { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.1); }
.mic-btn:hover { color: #10b981; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }

.destruct-btn.active { color: #ff3b30; background: rgba(255, 59, 48, 0.15); border-color: rgba(255, 59, 48, 0.4); box-shadow: 0 0 10px rgba(255, 59, 48, 0.3); }
.destruct-badge { position: absolute; top: -2px; right: -2px; background: #ff3b30; color: white; font-size: 9px; padding: 2px 4px; border-radius: 6px; border: 1px solid #000; }

.icon-btn.audio { color: #fca5a5; background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2); }
.icon-btn.audio:hover { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: #fff; border-color: transparent; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); transform: translateY(-2px); }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¹Ø´Ø§Ù† ØªÙƒÙˆÙ† Ø´ÙØ§ÙØ© */
.msg-bubble:has(.fa-phone-slash), 
.msg-bubble:has(.fa-phone) {
    background: rgba(15, 23, 42, 0.6) !important; /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ø´ÙØ§Ù Ø¬Ø¯Ø§Ù‹ */
    border: 1px solid rgba(255,255,255,0.1) !important;
    box-shadow: none !important;
    backdrop-filter: blur(4px);
    width: fit-content;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„ÙÙˆØªØ± */
.action-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #94a3b8; cursor: pointer;
    transition: all 0.3s ease;
    font-size: 18px; position: relative;
    flex-shrink: 0;
}
.action-btn:active { transform: scale(0.9); }

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ */
.media-btn:hover { color: #00e5ff; border-color: rgba(0, 229, 255, 0.3); background: rgba(0, 229, 255, 0.1); }
.file-btn:hover { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.1); }
.mic-btn:hover { color: #10b981; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }

/* Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± */
.destruct-btn.active { 
    color: #ff3b30; background: rgba(255, 59, 48, 0.15); 
    border-color: rgba(255, 59, 48, 0.4); 
    box-shadow: 0 0 10px rgba(255, 59, 48, 0.3); 
}
.destruct-badge {
    position: absolute; top: -2px; right: -2px;
    background: #ff3b30; color: white; font-size: 9px;
    padding: 2px 4px; border-radius: 6px; border: 1px solid #000;
}
    /* ================= Ø¥ØµÙ„Ø§Ø­ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (Minimized Mode) ================= */

/* 1. Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„ÙƒØ§Ø±Øª Ù†ÙØ³Ù‡) */
.call-overlay.minimized {
    width: 110px !important;      /* Ø¹Ø±Ø¶ ØµØºÙŠØ± Ø«Ø§Ø¨Øª */
    height: 160px !important;     /* Ø·ÙˆÙ„ Ø«Ø§Ø¨Øª */
    bottom: 120px !important;     /* ÙŠØ±ØªÙØ¹ Ø¹Ù† Ø§Ù„ÙÙˆØªØ± Ø¹Ø´Ø§Ù† Ù…ØºØ·ÙŠØ´ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    right: 20px !important;       /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    top: auto !important; 
    left: auto !important;
    
    border-radius: 18px !important;
    background: #1e293b !important; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© */
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5) !important;
    
    padding: 10px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
    z-index: 9000 !important; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    cursor: pointer; /* Ø¹Ø´Ø§Ù† ÙŠØ¹Ø±Ù Ø¥Ù†Ù‡ ÙŠØ¯Ø§Ø³ Ø¹Ù„ÙŠÙ‡ */
    overflow: hidden; /* Ø£ÙŠ Ø²ÙŠØ§Ø¯Ø© ØªØªÙ‚Øµ */
}

/* 2. Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø§Ù„Ù…Ø´ÙˆÙ‡Ø© */
.call-overlay.minimized .call-controls-section,
.call-overlay.minimized .controls-dock {
    display: none !important; /* Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø±ÙŠØ¶ ÙˆØ§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
}

/* 3. ØªØµØºÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
.call-overlay.minimized .call-avatar {
    width: 60px !important;
    height: 60px !important;
    border-width: 2px !important;
    margin: 0 !important;
    box-shadow: none !important;
    animation: none !important; /* ÙˆÙ‚Ù Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ */
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆÙ‚Øª */
.call-overlay.minimized .call-name {
    font-size: 13px !important;
    margin: 0 !important;
    white-space: nowrap;      /* Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ */
    overflow: hidden;
    text-overflow: ellipsis;  /* Ù†Ù‚Ø· Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ */
    max-width: 100%;
}

.call-overlay.minimized .call-status {
    font-size: 10px !important;
    padding: 2px 6px !important;
    background: rgba(255,255,255,0.05) !important;
}

/* 5. (Ø¥Ø¶Ø§ÙØ©) Ø²Ø± ØªÙƒØ¨ÙŠØ± Ø´ÙØ§Ù ÙŠØºØ·ÙŠ Ø§Ù„ÙƒØ§Ø±Øª */
.maximize-btn {
    position: absolute;
    inset: 0;
    z-index: 5;
}

/* 6. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
/* Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø²Ø±Ø§Ø± Ù‚ÙÙ„ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØºÙŠØ± */
.call-overlay.minimized::after {
    
}
/* ================= Ø¥ØµÙ„Ø§Ø­ ÙƒØ±ÙˆØª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ================= */

/* ØªÙ†Ø³ÙŠÙ‚ ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
/* ================= ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ù…ØµØºØ± (Compact) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„ÙÙ‚Ø§Ø¹Ø©) */
.msg-bubble:has(.call-card-inner) {
    background: rgba(15, 23, 42, 0.9) !important; /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ */
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(5px);
    
    /* Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¯ÙŠ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØµØºØ±Ù‡ */
    width: fit-content !important;   /* Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ù‚Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    max-width: 80% !important;       /* Ø¹Ø´Ø§Ù† Ù…ÙŠØ²ÙŠØ¯Ø´ Ø£ÙˆÙŠ */
    padding: 6px 12px !important;    /* Ø­ÙˆØ§Ù Ø¯Ø§Ø®Ù„ÙŠØ© ØµØºÙŠØ±Ø© */
    border-radius: 20px !important;  /* ØªØ¯ÙˆÙŠØ± ÙƒØ§Ù…Ù„ */
    
    /* Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø¸Ù„ ÙƒØ¨ÙŠØ± */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
}

/* 2. ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¬ÙˆÙ‡ Ø§Ù„ÙƒØ§Ø±Øª */
.call-card-inner {
    display: flex;
    align-items: center;
    gap: 10px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Øµ */
    min-width: 0 !important; /* (Ù…Ù‡Ù…) Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
}

/* 3. ØªØµØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¯Ø§ÙŠØ±Ø© Ø¨ØªØ§Ø¹ØªÙ‡Ø§ */
.call-icon-circle {
    width: 34px !important;  /* ØµØºØ±Ù†Ø§Ù‡Ø§ Ù…Ù† 42 Ù„Ù€ 34 */
    height: 34px !important;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px !important; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù†ÙØ³Ù‡Ø§ */
    flex-shrink: 0;
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙˆØµ Ø¬ÙˆÙ‡ Ø§Ù„ÙƒØ§Ø±Øª */
.call-card-info {
    display: flex; 
    flex-direction: column; 
    justify-content: center;
    line-height: 1.3;
}

.call-card-title {
    font-size: 13px !important;
    font-weight: bold;
    color: #fff;
    white-space: nowrap; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ø³Ø·Ø± ØªØ§Ù†ÙŠ */
}

.call-card-sub {
    font-size: 10px !important;
    color: #94a3b8;
}
/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
::-webkit-scrollbar {
    width: 6px; /* Ø±ÙÙŠØ¹ Ø¬Ø¯Ø§Ù‹ */
}

::-webkit-scrollbar-track {
    background: transparent; /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø¹Ø´Ø§Ù† Ù…ØªØ¨Ø§Ù†Ø´ */
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1); /* Ù„ÙˆÙ† Ø§Ù„Ø±ØµØ§ØµØ© Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù */
    border-radius: 10px; /* Ù…Ø¯ÙˆØ± */
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3); /* ÙŠÙØªØ­ Ù„Ù…Ø§ ØªÙ‚Ù Ø¹Ù„ÙŠÙ‡ */
}
/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ Ø§Ù„Ù‚ÙˆÙŠ */
.chat-header, .chat-footer, .receiver .msg-bubble {
    background: rgba(15, 25, 38, 0.75) !important; /* Ø´ÙØ§ÙÙŠØ© Ø£Ù‚Ù„ Ø´ÙˆÙŠØ© */
    backdrop-filter: blur(20px) saturate(180%); /* ØªÙ…ÙˆÙŠÙ‡ Ù‚ÙˆÙŠ + ØªØ´Ø¨Ø¹ Ø£Ù„ÙˆØ§Ù† */
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08); /* Ø­Ø¯ÙˆØ¯ Ø£Ù†Ø­Ù ÙˆØ£Ù†Ø¹Ù… */
    box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2); /* Ø¸Ù„ Ù†Ø§Ø¹Ù… Ø¬Ø¯Ø§Ù‹ */
}

/* ØªÙ„Ù…ÙŠØ¹Ø© Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
.send-btn {
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.4); /* ØªÙˆÙ‡Ø¬ Ù†ÙŠÙˆÙ† */
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body, button, input, textarea {
    font-family: 'Cairo', sans-serif;
}

.msg-bubble {
    font-weight: 400; /* Ø®Ø· Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ù†Øµ */
}

.header-info h3, .sender-name {
    font-weight: 700; /* Ø®Ø· ØªØ®ÙŠÙ† Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ */
}
/* ================= ØªØ­Ø¯ÙŠØ«: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ================= */

/* 1. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¹Ø´Ø§Ù† ØªÙ‚Ø¨Ù„ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† */
.footer-actions-left {
    display: flex;
    align-items: center;
    gap: 8px; 
    padding-left: 5px;
    
    /* Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ø§Ø¹Ù…Ø© */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø³Ù„Ø³ */
    max-width: 200px; /* Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ¨ÙŠ ÙŠÙƒÙÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
    opacity: 1;
    overflow: hidden; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ®ØªÙÙŠ Ù„Ù…Ø§ Ù†ØµØºØ± Ø§Ù„Ø¹Ø±Ø¶ */
}

/* 2. Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¶Ø§Ù Ù„Ù…Ø§ Ù†ÙƒØªØ¨ (ÙŠØ®ÙÙŠ Ø§Ù„Ø²Ø±Ø§ÙŠØ±) */
.footer-actions-left.hidden {
    max-width: 0px !important; /* Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¨Ù‚Ù‰ ØµÙØ± */
    padding-left: 0px !important;
    gap: 0px !important;
    opacity: 0; /* Ø´ÙØ§ÙÙŠØ© ÙƒØ§Ù…Ù„Ø© */
    margin: 0 !important;
    pointer-events: none; /* Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ */
}
    
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ù‚Ø§Ø· */
.typing-dots {
    display: inline-flex;
    gap: 4px;
    align-items: center;
    padding: 5px 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    margin-top: 5px;
}
.typing-dot {
    width: 6px; height: 6px;
    background: #00e5ff;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´ÙŠÙ…Ø± (Loaders) */
/* âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø¶Ø§ÙØ© margin-top: auto */
/* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ) */
.skeleton-row {
    display: flex;
    flex-direction: column;
    gap: 15px;       /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
    padding: 30px;   /* Ù‡ÙˆØ§Ù…Ø´ Ø¬Ø§Ù†Ø¨ÙŠØ© */
    width: 100%;
    margin: auto;    /* âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¬Ø¹Ù„Ù‡Ø§ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ…Ø§Ù…Ø§Ù‹ */
    max-width: 600px; /* Ø¹Ø´Ø§Ù† Ù…ØªØ¨Ù‚Ø§Ø´ Ø¹Ø±ÙŠØ¶Ø© Ø£ÙˆÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© */
.skeleton-msg {
    height: 45px;    /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ÙÙ‚Ø§Ø¹Ø© */
    border-radius: 20px;
    background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite linear; /* Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ù…ÙŠØ¹ */
    opacity: 0.7;
}

/* ÙÙ‚Ø§Ø¹Ø© Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…ÙŠÙ† (ÙƒØ£Ù†Ù‡Ø§ Ø±Ø³Ø§Ù„ØªÙŠ) */
.skeleton-right { 
    align-self: flex-end; 
    border-bottom-right-radius: 4px; 
}

/* ÙÙ‚Ø§Ø¹Ø© Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø§Ø± (ÙƒØ£Ù†Ù‡Ø§ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±) */
.skeleton-left { 
    align-self: flex-start; 
    border-bottom-left-radius: 4px; 
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù„Ù…Ø¹Ø§Ù† */
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
/* ================= ØªØµÙ…ÙŠÙ… Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ================= */
.msg-bubble.deleted {
    background: rgba(255, 255, 255, 0.05) !important; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #94a3b8 !important; /* Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ */
    font-style: italic;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: none !important;
}

/* ================= Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ================= */
/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒÙ„Ù‡Ø§ */
/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒÙ„Ù‡Ø§ */
.confirm-modal-overlay {
    position: fixed !important; 
    top: 0 !important; 
    left: 0 !important; 
    width: 100vw !important;  /* Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    height: 100vh !important; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    background: rgba(0, 0, 0, 0.85) !important; /* ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙƒØªØ± Ù„Ù„ØªØ±ÙƒÙŠØ² */
    backdrop-filter: blur(8px); /* Ø¨Ù„ÙˆØ± Ù‚ÙˆÙŠ */
    -webkit-backdrop-filter: blur(8px);
   /* Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… Z-Index Ù…Ø³Ù…ÙˆØ­ Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
    display: none; 
    align-items: center; 
    justify-content: center;
    margin: 0 !important;
    padding: 0 !important;
    inset: 0 !important;
}

/* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù†ÙØ³Ù‡ */
.confirm-modal {
    position: relative !important; /* Ø¹Ø´Ø§Ù† ÙŠØ«Ø¨Øª Ø¬ÙˆÙ‡ Ø§Ù„ÙÙ„ÙŠÙƒØ³ */
    background: #1e293b;
    width: 90%; 
    max-width: 320px;
    border-radius: 24px;
    padding: 30px 25px;
    text-align: center;
    border: 1px solid rgba(239, 68, 68, 0.3);
    box-shadow: 0 20px 60px rgba(0,0,0,0.6); /* Ø¸Ù„ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ */
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    margin: auto; /* Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ³ÙŠØ· */
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø¸Ø± */
.modal-icon-box {
    width: 60px; height: 60px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 50%;
    display: grid; place-items: center;
    margin: 0 auto 15px;
}
.modal-icon-box i {
    font-size: 28px; color: #ef4444;
}

/* Ø§Ù„Ù†ØµÙˆØµ */
.confirm-title { font-size: 18px; font-weight: bold; color: #ef4444; margin-bottom: 10px; }
.confirm-desc { font-size: 13px; color: #cbd5e1; line-height: 1.6; margin-bottom: 25px; }

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

.btn-modal {
    flex: 1; padding: 12px; border-radius: 12px; border: none;
    font-family: inherit; font-weight: bold; cursor: pointer; transition: 0.2s;
}
.btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
.btn-confirm { background: #ef4444; color: #fff; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }

/* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { to { transform: scale(1); } }

/* ================= Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙˆØªØ± (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) ================= */

/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
.action-btn {
    width: 42px; height: 42px;
    border-radius: 14px; /* ØªØ¯ÙˆÙŠØ± Squircle Ø­Ø¯ÙŠØ« */
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 19px;
    margin-bottom: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* ØªØ£Ø«ÙŠØ± Ø²Ø¬Ø§Ø¬ÙŠ Ø¹Ø§Ù… */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* 1. Ø²Ø± Ø§Ù„ØµÙˆØ± (Media) - Ù„ÙˆÙ† Ù…ÙˆÙ/Ø¨Ù†ÙØ³Ø¬ÙŠ Ù‡Ø§Ø¯ÙŠ */
.media-btn {
    background: rgba(192, 132, 252, 0.08); /* Ø®Ù„ÙÙŠØ© Ø¨Ù†ÙØ³Ø¬ÙŠ Ø´ÙØ§Ù Ø¬Ø¯Ø§Ù‹ */
    border: 1px solid rgba(192, 132, 252, 0.15); /* Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© */
    color: #d8b4fe; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø§ÙÙ†Ø¯Ø± ÙØ§ØªØ­ */
}

/* 2. Ø²Ø± Ø§Ù„Ù…Ù„ÙØ§Øª (File) - Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù‡Ø§Ø¯ÙŠ */
.file-btn {
    background: rgba(251, 191, 36, 0.08); /* Ø®Ù„ÙÙŠØ© Ø°Ù‡Ø¨ÙŠ Ø´ÙØ§Ù */
    border: 1px solid rgba(251, 191, 36, 0.15);
    color: #fcd34d; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø°Ù‡Ø¨ÙŠ */
}

/* 3. Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± (Destruct) - Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø®Ø§ÙØª */
.destruct-btn {
    background: rgba(248, 113, 113, 0.08); /* Ø®Ù„ÙÙŠØ© Ø£Ø­Ù…Ø± Ø´ÙØ§Ù */
    border: 1px solid rgba(248, 113, 113, 0.15);
    color: #fca5a5; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
}

/* ØªØ­Ø³ÙŠÙ†: Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± Ù„Ù…Ø§ ÙŠØ´ØªØºÙ„ ÙŠØ¨Ù‚Ù‰ Ø£Ø­Ù…Ø± ØµØ±ÙŠØ­ */
.destruct-btn.active {
    background: rgba(220, 38, 38, 0.2) !important;
    border-color: #ef4444 !important;
    color: #ff0000 !important;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
}
/* 1. Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø«Ø§Ø¨Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ·) - Ø£Ø­Ù…Ø± Ù‡Ø§Ø¯ÙŠ */
.icon-btn.audio {
    color: #fca5a5; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
    background: rgba(239, 68, 68, 0.08); /* Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ø´ÙØ§ÙØ© */
    border: 1px solid rgba(239, 68, 68, 0.2); /* Ø¨Ø±ÙˆØ§Ø² Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ */
}

/* 2. Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ Ø£Ùˆ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø¹Ù„ÙŠÙ‡ (Hover) - Ø£Ø­Ù…Ø± Ù…ØªÙˆÙ‡Ø¬ */
.icon-btn.audio:hover {
    /* ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„Ø£Ø­Ù…Ø± Ø§Ù„ØºØ§Ù…Ù‚ */
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
    color: #fff; /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ¨Ù‚Ù‰ Ø£Ø¨ÙŠØ¶ */
    border-color: transparent;
    
    /* Ø¸Ù„ Ø£Ø­Ù…Ø± Ù…ØªÙˆÙ‡Ø¬ */
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    transform: translateY(-2px);
}
.floating-btn {
    background: rgba(0, 0, 0, 0.4) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    color: white;
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
/* ================= ØªØµÙ…ÙŠÙ… Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Aurora) ================= *
/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¹Ø´Ø§Ù† ØªÙ„ÙŠÙ‚ Ø¹Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.call-avatar {
    border: 2px solid rgba(0, 229, 255, 0.3) !important;
    box-shadow: 0 0 30px rgba(0, 229, 255, 0.15) !important;
    background-color: #1e293b; /* Ø®Ù„ÙÙŠØ© Ù„Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ù„Ø³Ù‡ Ø¨ØªØ­Ù…Ù„ */
}
/* ============================================================
   1. ØªØµÙ…ÙŠÙ… ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Glass Dock)
   ============================================================ */
.controls-dock {
    position: absolute;
    bottom: 40px; 
    left: 50%;
    transform: translateX(-50%); /* Ø¹Ø´Ø§Ù† ØªØ¨Ù‚ÙŠ ÙÙŠ Ù†Øµ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ */
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px; /* Ù…Ø³Ø§ÙØ§Øª Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±Ø§ÙŠØ± */
    
    /* Ø®Ù„ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø¨Ù„ÙˆØ± */
    background: rgba(20, 30, 48, 0.6); 
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    padding: 10px 25px;
    border-radius: 50px; /* ØªØ¯ÙˆÙŠØ± ÙƒØ§Ù…Ù„ */
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    
    z-index: 1000;
    width: auto;
    min-width: 280px;
}
.call-btn {
    width: 50px; 
    height: 50px;
    border-radius: 50%; /* Ø¯Ø§Ø¦Ø±Ø© ÙƒØ§Ù…Ù„Ø© */
    border: none;
    outline: none;
    
    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ø´ÙØ§Ù */
    background: rgba(255, 255, 255, 0.08);
    color: #e2e8f0;
    font-size: 20px;
    
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø³ Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³ */
.call-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-3px);
}

.call-btn:active {
    transform: scale(0.9);
}

.call-btn.active-state {
    background: #ffffff !important;
    color: #0f172a !important; /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ‚Ù„Ø¨ Ø£Ø³ÙˆØ¯ */
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
    transform: scale(1.05);
}

.call-btn.end {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    color: #fff !important;
    width: 65px; /* Ø£ÙƒØ¨Ø± Ø³Ù†Ø© */
    height: 50px; /* Ø¨ÙŠØ¶Ø§ÙˆÙŠ Ø´ÙˆÙŠØ© */
    border-radius: 25px; /* ØªØ¯ÙˆÙŠØ± Ù…Ø®ØªÙ„Ù */
    font-size: 24px;
    box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
    margin-left: 10px;
}
#incomingCallControls {
    position: absolute !important;
    bottom: 80px !important;
    left: 0; 
    right: 0;
    display: flex; 
    justify-content: space-evenly;
    z-index: 2000 !important; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© */
    pointer-events: auto; /* Ù„Ø¶Ù…Ø§Ù† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù„Ù…Ø³ */
}


.call-btn.accept {
    width: 70px !important; height: 70px !important; font-size: 28px;
    background: #10b981 !important;
    box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.2);
    animation: pulse-green 1.5s infinite;
}

.call-btn.end-incoming { /* Ø²Ø± Ø§Ù„Ø±ÙØ¶ */
    width: 70px !important; height: 70px !important; font-size: 28px;
    background: #ef4444 !important;
    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0.2);
}

/* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¨Ø¶ */
@keyframes pulse-green {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
/* ================= ØªØµÙ…ÙŠÙ… Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Aurora Background) ================= */
.call-bg {
    position: absolute;
    inset: 0;
    z-index: 1; /* ØªØ­Øª ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    background-color: #0b1121; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    overflow: hidden;
}

/* Ø§Ù„Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´ÙÙ‚) */
.call-bg::before, .call-bg::after {
    content: '';
    position: absolute;
    width: 600px; height: 600px;
    border-radius: 50%;
    filter: blur(80px); /* ØªÙ…ÙˆÙŠÙ‡ Ù‚ÙˆÙŠ */
    opacity: 0.4; /* Ø´ÙØ§ÙÙŠØ© */
    animation: floating-lights 10s infinite alternate ease-in-out;
}

/* Ø§Ù„Ø¨Ù‚Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */
.call-bg::before {
    background: #7c3aed; 
    top: -100px; left: -100px;
}

/* Ø§Ù„Ø¨Ù‚Ø¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø³ÙŠØ§Ù†/Ø£Ø²Ø±Ù‚) */
.call-bg::after {
    background: #00e5ff; 
    bottom: -100px; right: -100px;
    animation-delay: -5s;
}

/* Ø´Ø¨ÙƒØ© Ù†Ù‚Ø· Ø®ÙÙŠÙØ© (Pattern) */
.call-bg-pattern {
    position: absolute; inset: 0; z-index: 2;
    background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 30px 30px;
    opacity: 0.2;
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø¶ÙˆØ§Ø¡ */
@keyframes floating-lights {
    0% { transform: scale(1); }
    100% { transform: scale(1.2); }
}
    /* ================= Ø£Ù„ÙˆØ§Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠÙ† (Seen System) ================= */

/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¹ÙŠÙ† */
.status-eye {
    font-size: 12px;
    margin-right: 3px;
    transition: all 0.3s ease;
}

/* 1. Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ (Ù„Ù… ØªØµÙ„ / Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙÙ„Ø§ÙŠÙ†) */
.eye-dark {
    color: rgba(255, 255, 255, 0.3);
}

/* 2. Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ (ÙˆØµÙ„Øª / Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„ÙƒÙ† Ù„Ù… ÙŠÙØªØ­ Ø§Ù„Ø´Ø§Øª) */
.eye-blue {
    color: #3b82f6; /* Ø£Ø²Ø±Ù‚ */
    text-shadow: 0 0 5px rgba(59, 130, 246, 0.4);
}

/* 3. Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ù† (ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Seen) */
.eye-green {
    color: #00e5ff !important; /* Ø³ÙŠØ§Ù† Ù†ÙŠÙˆÙ† */
    text-shadow: 0 0 8px rgba(0, 229, 255, 0.8); /* ØªÙˆÙ‡Ø¬ */
    transform: scale(1.1); /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· */
}

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ù†Ø¨Ø¶ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± */
.mood-happy { box-shadow: 0 0 20px #fbbf24 !important; border-color: #fbbf24 !important; } /* Ø£ØµÙØ± Ù„Ù„ÙØ±Ø­ */
.mood-love { box-shadow: 0 0 20px #ec4899 !important; border-color: #ec4899 !important; } /* ÙˆØ±Ø¯ÙŠ Ù„Ù„Ø­Ø¨ */
.mood-angry { box-shadow: 0 0 20px #ef4444 !important; border-color: #ef4444 !important; } /* Ø£Ø­Ù…Ø± Ù„Ù„ØºØ¶Ø¨ */
.mood-sad { box-shadow: 0 0 20px #60a5fa !important; border-color: #60a5fa !important; } /* Ø£Ø²Ø±Ù‚ Ù„Ù„Ø­Ø²Ù† */

/* ØªØ£Ø«ÙŠØ± Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ Ù†Ø§Ø¹Ù… */
.input-container { transition: box-shadow 0.3s ease, border-color 0.3s ease; }

    /* ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ */
body.ghost-active {
    filter: grayscale(100%) contrast(1.2); /* ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø±Ù…Ø§Ø¯ÙŠ */
}
body.ghost-active .chat-header, 
body.ghost-active .chat-footer {
    background: #000 !important; /* Ø³ÙˆØ§Ø¯ ÙƒØ§Ù…Ù„ */
    border: 1px solid #333;
}
body.ghost-active .msg-bubble {
    background: #222 !important;
    color: #fff !important;
    font-family: 'Courier New', monospace; /* Ø®Ø· ÙŠØ´Ø¨Ù‡ Ø§Ù„Ø¢Ù„Ø© Ø§Ù„ÙƒØ§ØªØ¨Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
}
/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ø¨Ø­ ØªÙ†Ø¨Ø¶ */
.ghost-indicator {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    color: #fff; z-index: 9999; font-size: 20px; 
    animation: ghostFloat 2s infinite ease-in-out;
    display: none;
}
@keyframes ghostFloat { 0%,100%{transform:translate(-50%,0);opacity:0.5} 50%{transform:translate(-50%,-10px);opacity:1} }
@keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

.pp-header {
    padding: 20px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: #fff;
}

.pp-content {
    flex: 1; overflow-y: auto; padding: 20px;
    display: flex; flex-direction: column; gap: 30px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.profile-menu-list {
    display: flex; flex-direction: column; gap: 10px;
}

.profile-item {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255, 255, 255, 0.03);
    padding: 12px 15px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    transition: 0.2s;
}

.profile-item:active {
    background: rgba(255, 255, 255, 0.08);
    transform: scale(0.98);
}

.p-item-icon {
    width: 40px; height: 40px;
    border-radius: 12px;
    display: grid; place-items: center;
    font-size: 18px;
}

.p-item-text {
    flex: 1; display: flex; flex-direction: column;
}
.p-item-text span { font-size: 14px; color: #fff; font-weight: 600; }
.p-item-text small { font-size: 11px; color: #94a3b8; margin-top: 2px; }

.p-item-arrow { color: #64748b; font-size: 14px; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
.pp-avatar-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: 15px;
}

.pp-avatar-lg {
    width: 100px;  /* Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ù„Ù„ØµÙˆØ±Ø© */
    height: 100px;
    border-radius: 50%;
    background-color: #333;
    background-size: cover;
    background-position: center;
    border: 3px solid #00e5ff; /* Ø¥Ø·Ø§Ø± Ù…Ù„ÙˆÙ† */
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
    font-size: 40px; /* ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø© */
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø§Ø³Ù… */
.pp-name {
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.encryption-pill {
    text-align: center;
    font-size: 11px;
    color: #94a3b8;
    background: rgba(255,255,255,0.05);
    padding: 4px 12px;
    border-radius: 20px;
    width: fit-content;
    margin: 0 auto; /* ØªÙˆØ³ÙŠØ· */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø´Ø¨Ø­) */
.system-msg-row {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 15px 0;
    z-index: 1;
}

.system-msg-text {
    background: rgba(255, 255, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø¬Ø¯Ø§Ù‹ */
    color: #94a3b8;      /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
    padding: 4px 15px;
    border-radius: 20px;
    font-size: 11px;     /* Ø®Ø· ØµØºÙŠØ± */
    font-weight: 300;    /* Ø®Ø· Ø±ÙÙŠØ¹ */
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ØªÙ…ÙŠÙŠØ² Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ */
.system-user-name {
    color: #00e5ff;      /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ù…ÙŠØ² */
    font-weight: 600;
}

.s-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    background-color: #333;
    flex-shrink: 0;
    display: grid;
    place-items: center;
    font-weight: bold;
    color: #fff;
}

.s-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
}

.s-name {
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 4px;
}

.s-text {
    font-size: 13px;
    color: #94a3b8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù„ÙŠ Ø¨Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ØªÙƒÙˆÙ† Ù…Ù„ÙˆÙ†Ø© */
.highlight-term {
    color: #00e5ff; /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† Ø¨ØªØ§Ø¹Ùƒ */
    font-weight: bold;
    background: rgba(0, 229, 255, 0.1);
    padding: 0 2px;
    border-radius: 2px;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆÙ…ÙŠØ¶ Ù„Ù…Ø§ ØªØ±ÙˆØ­ Ù„Ù„Ø±Ø³Ø§Ù„Ø© */
@keyframes flashMessage {
    0% { background: rgba(0, 229, 255, 0.5); transform: scale(1.02); }
    50% { background: rgba(0, 229, 255, 0.2); transform: scale(1); }
    100% { background: transparent; }
}

.flash-highlight {
    animation: flashMessage 1.5s ease-out;
    border-radius: 10px;
}
/* Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© */
/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø¹Ø±Ø¶ - ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
.media-gallery-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #0b1121; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚ */
    z-index: 20000 !important; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    animation: slideInRight 0.3s ease-out;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± */
.mg-header {
    height: 60px;
    display: flex; align-items: center; gap: 15px;
    padding: 0 15px;
    background: rgba(15, 25, 38, 0.95);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-shrink: 0;
}
.mg-close-btn {
    font-size: 20px; color: #94a3b8; cursor: pointer; padding: 5px;
}
.mg-header h3 { margin: 0; color: #fff; font-size: 18px; }


/* Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© */
.mg-body { flex: 1; overflow-y: auto; padding: 10px; position: relative; }

/* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
.mg-panel { display: none; padding-bottom: 20px; }
.mg-panel.active { display: grid; } /* Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.mg-tabs {
    display: flex;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    gap: 10px;
    overflow-x: auto;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.mg-tab {
    padding: 8px 16px;
    color: #94a3b8;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;
    transition: 0.3s;
}

.mg-tab.active {
    background: var(--accent-color);
    color: #000;
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ø­ */
.mg-panel { display: none; padding: 10px; padding-bottom: 50px; }
.mg-panel.active { display: grid; }

/* Grid Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
.grid-view {
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 8px;
    align-content: start;
}

/* List Ù„Ù„ØµÙˆØª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª */
.list-view {
    display: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ active Ø¨ÙŠØ®Ù„ÙŠÙ‡Ø§ grid ÙØ¨Ù†Ù„ØºÙŠ Ø¯Ù‡ */
    flex-direction: column;
    gap: 10px;
}
.mg-panel.active.list-view { display: flex; } /* ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù… */

/* --- Ù‡Ù†Ø§ Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡Ø§ (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹) --- */

/* 1. ÙƒØ±ÙˆØª Ø§Ù„ØµÙˆØ± */
.mg-image-card {
    aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;
}
.mg-image-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
.mg-image-card:hover img { transform: scale(1.1); opacity: 0.8; }

/* 2. ÙƒØ±ÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.mg-video-card {
    border-radius: 10px; overflow: hidden; position: relative; aspect-ratio: 1/1; /* Ù…Ø±Ø¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø±ÙŠØ¯ */
    cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
}
.vid-thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
.play-overlay { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,0.3); }
.play-circle-small {
    width: 35px; height: 35px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
    border-radius: 50%; display: grid; place-items: center; border: 1px solid rgba(255,255,255,0.5);
}

/* 3. ÙƒØ±ÙˆØª Ø§Ù„ØµÙˆØª (Waveform) */
.audio-card {
    display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.03);
    padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
}
.audio-wave { display: flex; gap: 3px; align-items: flex-end; height: 15px; }
.wave-bar { width: 3px; background: #64748b; border-radius: 2px; animation: quietWave 1s infinite; }

/* 4. ÙƒØ±ÙˆØª Ø§Ù„Ù…Ù„ÙØ§Øª */
.file-link-card {
    display: flex; align-items: center; gap: 15px; background: #151f2e;
    padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b; cursor: pointer;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± */
.lightbox {
    position: fixed; inset: 0; 
    background: rgba(0,0,0,0.95); /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ØºØ§Ù…Ù‚Ø© */
    z-index: 60000; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: flex; align-items: center; justify-content: center;
    flex-direction: column;
}

.lb-image {
    max-width: 90%; max-height: 80vh; 
    border-radius: 5px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transition: transform 0.2s; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªÙƒÙˆÙ† Ù†Ø§Ø¹Ù…Ø© */
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ (Ø§Ù„Ø£Ø³Ù‡Ù…) */
.lb-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 50px; height: 50px;
    background: rgba(255,255,255,0.1);
    color: #fff; border-radius: 50%;
    display: grid; place-items: center;
    font-size: 20px; cursor: pointer;
    transition: 0.2s; z-index: 60001;
}
.lb-nav:hover { background: rgba(255,255,255,0.2); }
.lb-nav:active { transform: translateY(-50%) scale(0.9); }

.lb-nav.prev { right: 20px; } /* Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙŠÙ…ÙŠÙ† */
.lb-nav.next { left: 20px; }  /* Ø§Ù„ØªØ§Ù„ÙŠ Ø´Ù…Ø§Ù„ */

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
.lb-close {
    position: absolute; top: 20px; right: 20px;
    color: #fff; font-size: 35px; cursor: pointer; z-index: 60002;
    width: 40px; height: 40px; text-align: center; line-height: 40px;
}

/* Ø§Ù„Ø¹Ø¯Ø§Ø¯ */
.lb-counter {
    position: absolute; bottom: 30px;
    color: #fff; font-family: monospace;
    background: rgba(255,255,255,0.1);
    padding: 5px 15px; border-radius: 20px;
}
#toast {
    position: fixed !important; 
    bottom: 50px !important; 
    left: 50% !important; 
    transform: translateX(-50%) !important; 
    background: rgba(0, 0, 0, 0.9) !important; 
    color: #fff !important; 
    padding: 12px 25px !important; 
    border-radius: 30px !important; 
    font-size: 14px !important; 
    font-weight: bold !important;
    opacity: 0; 
    pointer-events: none; 
    transition: 0.3s; 
    
    /* ğŸ”¥ğŸ”¥ Ø¯Ù‡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ”¥ğŸ”¥ */
    z-index: 2147483647 !important; 
    
    box-shadow: 0 5px 20px rgba(0,0,0,0.5) !important;
    border: 1px solid rgba(255, 59, 48, 0.3) !important; /* Ø¨Ø±ÙˆØ§Ø² Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ */
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠÙ†Ø²Ù„ Ø³Ø·Ø±ÙŠÙ† */
}
/* ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
/* ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØµÙØ­Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© */
.profile-page {
    position: fixed;
    top: 0;       /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
    left: 0;      /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
    right: 0;     /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    bottom: 0;    /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
    width: 100% !important;  /* Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ */
    height: 100% !important; /* Ø·ÙˆÙ„ ÙƒØ§Ù…Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ */
    
    background: #0b1121;
    z-index: 99999; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠØºØ·ÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø© */
    
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.pp-header {
    height: 70px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: rgba(15, 25, 38, 0.95);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.pp-header h3 { color: #fff; margin: 0; font-size: 18px; }

.pp-content { flex: 1; overflow-y: auto; padding: 20px; }

/* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ */
.pp-user-info {
    display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;
}
.pp-avatar-lg {
    width: 100px; height: 100px; border-radius: 50%;
    background-color: #333; background-size: cover; background-position: center;
    border: 3px solid #00e5ff; box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
    margin-bottom: 15px;
}
.pp-name { font-size: 22px; font-weight: bold; color: #fff; margin-bottom: 5px; }
.encryption-pill {
    background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 20px;
    font-size: 11px; color: #94a3b8; display: flex; gap: 5px; align-items: center;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.profile-menu-list { display: flex; flex-direction: column; gap: 10px; }

.profile-item {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255, 255, 255, 0.03);
    padding: 15px; border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer; transition: 0.2s;
}
.profile-item:active { background: rgba(255, 255, 255, 0.08); transform: scale(0.98); }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ù„ÙˆÙ†Ø© Ù„ÙƒÙ„ Ø²Ø±Ø§Ø± */
.p-item-icon {
    width: 40px; height: 40px; border-radius: 12px;
    display: grid; place-items: center; font-size: 18px;
}
.ghost-icon { background: rgba(255,255,255,0.1); color: #fff; }
.media-icon { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
.search-icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
.mute-icon { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
.privacy-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }
.block-icon { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø³Ù‡Ù… */
.p-item-text { flex: 1; display: flex; flex-direction: column; }
.p-item-text span { font-size: 15px; color: #e2e8f0; font-weight: 500; }
.p-item-text small { font-size: 11px; color: #64748b; margin-top: 2px; }
.p-item-arrow { color: #475569; font-size: 16px; }

/* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø²Ø± Ø§Ù„Ø­Ø¸Ø± */
.block-item { border-color: rgba(239, 68, 68, 0.2); }

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ØµØ© */
.story-reply-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù…Ù…ÙŠØ²Ø© */
    padding: 8px;
    border-radius: 12px;
    margin-bottom: 5px;
    border-right: 3px solid var(--accent-color); /* Ø®Ø· Ù…Ù„ÙˆÙ† ÙŠÙ…ÙŠØ² Ø§Ù„Ø±Ø¯ */
}

.story-media-wrapper {
    width: 45px;
    height: 70px;
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
    border: 1px solid rgba(255,255,255,0.1);
}

.story-reply-media {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.story-reply-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.reply-label {
    font-size: 10px;
    color: #aaa;
    margin-bottom: 3px;
    font-weight: bold;
}

.reply-text-body {
    font-size: 14px;
    color: #fff;
}

/* ================= ØªØµÙ…ÙŠÙ… Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
.media-gallery-overlay {
    background-color: #0b1121 !important; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ */
}

/* 2. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs) */
.mg-tabs {
    background: rgba(15, 25, 38, 0.95);
    padding: 10px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    gap: 15px;
    overflow-x: auto; /* Ø³ÙƒØ±ÙˆÙ„ Ù„Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© ØµØºÙŠØ±Ø© */
    scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± */
}
.mg-tab {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: #94a3b8;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s ease;
    white-space: nowrap;
}
.mg-tab.active {
    background: #00e5ff; /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† */
    color: #000;
    border-color: #00e5ff;
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ) */
.grid-view {
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    grid-template-columns: repeat(3, 1fr); /* 3 Ø£Ø¹Ù…Ø¯Ø© */
    gap: 3px; /* Ù…Ø³Ø§ÙØ§Øª Ø¶ÙŠÙ‚Ø© Ø²ÙŠ Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù… */
    padding: 3px;
    align-content: start;
}
.grid-view.active { display: grid; }

.mg-item {
    position: relative;
    aspect-ratio: 1/1; /* Ù…Ø±Ø¨Ø¹ Ù…Ø«Ø§Ù„ÙŠ */
    background: #1e293b;
    overflow: hidden;
    cursor: pointer;
}
.mg-item img, .mg-item video {
    width: 100%; height: 100%; object-fit: cover;
    transition: transform 0.3s;
}
.mg-item:hover img { transform: scale(1.1); }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© */
.vid-indicator {
    position: absolute; top: 5px; right: 5px;
    color: #fff; font-size: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù„Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØªÙŠØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·) */
.list-view {
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    gap: 10px;
    padding: 15px;
}
.list-view.active { display: flex; }

/* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ø±Ø§Ø¨Ø· */
.mg-list-card {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255,255,255,0.03);
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: 0.2s;
}
.mg-list-card:active { background: rgba(255,255,255,0.08); }

.list-icon-box {
    width: 45px; height: 45px;
    border-radius: 10px;
    display: grid; place-items: center;
    font-size: 20px;
    flex-shrink: 0;
}
/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
.icon-file { background: rgba(245, 158, 11, 0.15); color: #f59e0b; } /* Ø£ØµÙØ± */
.icon-audio { background: rgba(16, 185, 129, 0.15); color: #10b981; } /* Ø£Ø®Ø¶Ø± */
.icon-link { background: rgba(59, 130, 246, 0.15); color: #3b82f6; } /* Ø£Ø²Ø±Ù‚ */

.list-info { flex: 1; overflow: hidden; }
.list-title { color: #fff; font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-sub { color: #64748b; font-size: 11px; margin-top: 3px; }

/* 5. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© (Empty State) */
.empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 300px; color: #64748b; gap: 15px;
}
.empty-icon { font-size: 50px; opacity: 0.3; }
/* Ø³ØªØ§ÙŠÙ„ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¹Ø´Ø§Ù† ØªØªÙ…ÙŠØ² Ø¹Ù† Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
.message.quick-reply {
    background: #e1ffc7; /* Ù„ÙˆÙ† Ù…Ø®Ø¶Ø± ÙØ§ØªØ­ */
    color: #075e54;
    font-style: italic;
    border: 1px solid #25d366;
    font-size: 13px;
    padding: 8px 15px;
    border-radius: 15px;
    align-self: center; /* ØªÙŠØ¬ÙŠ ÙÙŠ Ù†Øµ Ø§Ù„Ø´Ø§Øª */
    margin: 10px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Ù„Ùˆ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
body.dark-mode .message.quick-reply {
    background: #1f2c34;
    color: #00e5ff;
    border: 1px solid #00e5ff;
}
/* ØªØµÙ…ÙŠÙ… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³ÙŠÙ† (ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ) */
.seen-avatar-icon {
    width: 16px;            /* Ø­Ø¬Ù… ØµØºÙŠØ± Ù…Ø«Ù„ Ù…Ø§Ø³Ù†Ø¬Ø± */
    height: 16px;
    border-radius: 50%;     /* Ø¯Ø§Ø¦Ø±ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ */
    background-size: cover;
    background-position: center;
    display: inline-block;
    border: 1px solid #fff; /* Ø­Ø¯ÙˆØ¯ Ø¨ÙŠØ¶Ø§Ø¡ ØµØºÙŠØ±Ø© Ù„ÙØµÙ„Ù‡Ø§ Ø¹Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© */
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    vertical-align: middle;
    margin-right: 2px;
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    animation: popIn 0.3s ease; /* Ø­Ø±ÙƒØ© Ø¸Ù‡ÙˆØ± Ù†Ø§Ø¹Ù…Ø© */
}

@keyframes popIn {
    from { transform: scale(0); }
    to { transform: scale(1); }
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø§Ù„ØµÙˆØ±Ø©) */
.msg-status.seen-eye i {
    display: none; /* Ù†Ø®ÙÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ùˆ Ø§Ù„ØµÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© */
}

/* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ùˆ Ø§Ù„ØµÙˆØ±Ø© Ø¸Ù‡Ø±Øª */
.hidden-eye {
    display: none !important;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙŠØªØ§ (Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©) Ù„ØªÙƒÙˆÙ† Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
.msg-meta-row {
    min-height: 16px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ØªÙ‡Ø²Ø´ Ù„Ù…Ø§ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ¸Ù‡Ø± ÙˆØªØ®ØªÙÙŠ */
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
}
/* ================= 1. Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ================= */
.chat-header {
    position: sticky;
    top: 10px;
    z-index: 100;
    height: 72px; /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù„Ù…ÙˆÙ… ÙˆØ´ÙŠÙƒ */
    margin: 0 10px;
    padding: 0 12px;
    
    /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Dark Aurora Glass) */
    background: rgba(15, 23, 42, 0.85); /* Ù„ÙˆÙ† ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ Ø´ÙØ§Ù */
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    
    border-radius: 24px; /* ØªØ¯ÙˆÙŠØ± Ù†Ø§Ø¹Ù… */
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); /* Ø¸Ù„ Ø¹Ù…ÙŠÙ‚ */
    
    display: flex;
    align-items: center;
    justify-content: space-between;
    overflow: hidden; /* Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø®Ø±ÙˆØ¬ Ø£ÙŠ Ø¹Ù†ØµØ± */
}

/* ================= 2. Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù† (Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ + Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ø§Ø³Ù…) ================= */
.header-right-section {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„ÙŠØ¯ÙØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ÙŠØ³Ø§Ø± */
    min-width: 0; /* ğŸ”¥ Ø³Ø± Ø§Ù„Ù…Ø§Ø³Ù†Ø¬Ø±: ÙŠØ³Ù…Ø­ Ù„Ù„Ù†Øµ Ø¨Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
}

/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
.back-btn {
    font-size: 18px; color: #cbd5e1;
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
    flex-shrink: 0; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
}
.back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

/* ================= 3. ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø© (Avatar) ================= */
.user-avatar-container {
    position: relative;
    width: 48px; height: 48px; /* Ø­Ø¬Ù… Ù…Ø«Ø§Ù„ÙŠ */
    flex-shrink: 0; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø¬ */
    border-radius: 50%;
    padding: 2px;
    
    /* Ø­Ù„Ù‚Ø© Ù…ØªØ¯Ø±Ø¬Ø© Ø£Ù†ÙŠÙ‚Ø© (Ø¨Ø¯Ù„ Ø§Ù„ØªÙˆÙ‡Ø¬ Ø§Ù„Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡) */
    background: linear-gradient(135deg, #00e5ff, #3b82f6); 
    box-shadow: 0 4px 15px rgba(0, 229, 255, 0.2);
    cursor: pointer;
}

.header-avatar {
    width: 100%; height: 100%;
    border-radius: 50%;
    background-color: #0f172a;
    background-size: cover; background-position: center;
    border: 2px solid #0f172a; /* ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¥Ø·Ø§Ø± */
}

.online-status {
    position: absolute; bottom: 0; left: 0;
    width: 12px; height: 12px;
    background: #10b981;
    border-radius: 50%;
    border: 2px solid #0f172a;
}

/* ================= 4. Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø§Ø³Ù… (Messenger Style) ================= */
/* 1. ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø§Ø³Ù… Ù„ÙŠÙƒÙˆÙ† Ø¹Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
.header-info {
    position: absolute; /* Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%); /* Ø§Ù„Ø³Ø­Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¬ÙŠØ¨Ù‡ ÙÙŠ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    
    display: flex;
    flex-direction: column;
    align-items: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø±Ø£Ø³ÙŠØ§Ù‹ */
    justify-content: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø£ÙÙ‚ÙŠØ§Ù‹ */
    
    width: max-content; /* Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ù‚Ø¯ Ø§Ù„ÙƒÙ„Ø§Ù… */
    max-width: 50%; /* Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ù…Ø§ ÙŠØºØ·ÙŠØ´ Ø¹ Ø§Ù„Ø²Ø±Ø§ÙŠØ± */
    margin: 0 !important; /* Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù‡ÙˆØ§Ù…Ø´ Ù‚Ø¯ÙŠÙ…Ø© */
    z-index: 10;
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ù†ÙØ³Ù‡ */
.header-info h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #fff;
    font-family: 'Cairo', sans-serif;
    
    /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Øµ */
    text-align: center;
    justify-content: center;
    display: flex;
    align-items: center;
    gap: 5px;
    
    /* Ù‚Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ø²Ø§Ø¦Ø¯ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ù†Ø´Ø· Ø§Ù„Ø¢Ù†) */
.status-text {
    font-size: 11px; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø³Ù†Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙŠØ§ÙƒØ© */
    font-weight: 500;
    color: #94a3b8;
    text-align: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Øµ */
    margin-top: 1px;
    display: block;
    width: 100%;
}

/* 4. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø¹Ø´Ø§Ù† ÙŠÙ„Ù… Ù†ÙØ³Ù‡ Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø§Ø³Ù… Ø®Ø±Ø¬ Ù…Ù†Ù‡) */
.header-right-section {
    display: flex;
    align-items: center;
    gap: 10px;
    /* Ù…Ø´ Ù…Ø­ØªØ§Ø¬ÙŠÙ† flex: 1 Ù‡Ù†Ø§ Ø®Ù„Ø§Øµ Ù„Ø£Ù† Ø§Ù„Ø§Ø³Ù… Ø®Ø±Ø¬ */
}


/* ================= 5. Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„ÙŠØ³Ø§Ø±) ================= */
.header-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ù† Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ */
    margin-right: 10px; /* Ù…Ø³Ø§ÙØ© ØªÙØµÙ„Ù‡Ù… Ø¹Ù† Ø§Ù„Ø§Ø³Ù… */
}

.icon-btn {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: flex; align-items: center; justify-content: center;
    color: #cbd5e1; font-size: 18px;
    cursor: pointer; transition: 0.3s;
}
.icon-btn:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }
/* ØªÙ†Ø³ÙŠÙ‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
.confirm-modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ù„Ù„ØªØ±ÙƒÙŠØ² */
    backdrop-filter: blur(8px);
    z-index: 99999;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center; justify-content: center;
}

.confirm-modal {
    background: #1e293b;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 30px;
    width: 90%; max-width: 350px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.confirm-title {
    font-size: 18px; font-weight: bold; color: #fff; margin: 15px 0 10px;
}

.confirm-desc {
    font-size: 14px; color: #94a3b8; margin-bottom: 25px;
    word-break: break-all; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø®Ø±ÙˆØ¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·ÙˆÙŠÙ„ */
    line-height: 1.5;
}

.confirm-actions {
    display: flex; gap: 10px;
}

.btn-modal {
    flex: 1; padding: 12px; border-radius: 12px; border: none;
    font-family: inherit; font-weight: bold; cursor: pointer; transition: 0.2s;
    color: #fff;
}

.btn-cancel { background: rgba(255,255,255,0.1); }
.btn-cancel:hover { background: rgba(255,255,255,0.15); }

.reply-preview-bar {
    position: absolute;
    bottom: 100%; /* ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© */
    left: 0; right: 0;
    height: 50px;
    background: rgba(30, 41, 59, 0.95);
    border-top: 1px solid rgba(255,255,255,0.1);
    display: none; /* Ù…Ø®ÙÙŠ */
    align-items: center;
    padding: 0 15px;
    z-index: 50;
    border-left: 4px solid #00e5ff; /* Ù„ÙˆÙ† Ù…Ù…ÙŠØ² */
}
.reply-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.reply-title { color: #00e5ff; font-size: 12px; font-weight: bold; }
.reply-text { color: #cbd5e1; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.close-reply { padding: 10px; color: #ff3b30; cursor: pointer; }
/* ================= ØªØµÙ…ÙŠÙ… ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ ================= */
/* ØªÙ†Ø³ÙŠÙ‚ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ */
.msg-reaction {
    position: absolute;
    bottom: -10px; /* ÙŠÙ†Ø²Ù„ ØªØ­Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø´ÙˆÙŠØ© */
    right: 10px;   /* ÙŠÙŠØ¬ÙŠ ÙŠÙ…ÙŠÙ† */
    background: #1e293b; /* Ø®Ù„ÙÙŠØ© ØºØ§Ù…Ù‚Ø© */
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 14px;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    cursor: pointer;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ§Ø¹ØªÙŠ (Sender) Ø§Ù„ØªÙØ§Ø¹Ù„ ÙŠÙŠØ¬ÙŠ Ø´Ù…Ø§Ù„ */
.sender .msg-reaction {
    right: auto;
    left: 10px;
}

/* ================= ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ù…ØµØ­Ø­) ================= */
.msg-reaction {
    position: absolute;
    bottom: -12px;  /* ÙŠÙ†Ø²Ù„ ØªØ­Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    right: 15px;    /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    background: #1e293b; 
    border: 2px solid #050b14; /* Ø­Ø¯ÙˆØ¯ Ø¨Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Øª Ù„ÙŠÙØµÙ„Ù‡Ø§ Ø¹Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    color: #fff;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 14px;
    z-index: 100; /* Ø·Ø¨Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø£ÙŠ Ø´ÙŠØ¡ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    cursor: pointer;
    min-width: 20px;
    text-align: center;
    line-height: 1.2;
}

/* Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ§Ø¹ØªÙŠ (Sender) */
.sender .msg-reaction {
    right: auto;
    left: 15px;
}

/* ğŸ”¥ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ù„Ø§ ØªÙ‚Øµ Ø§Ù„ØªÙØ§Ø¹Ù„ ğŸ”¥ */
.msg-bubble {
    overflow: visible !important; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø±Ù‡ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
}

/* Ø¥Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù† Ø¨Ø¹Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…ÙŠØªØºØ·Ø§Ø´ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡ */
.msg-row {
    margin-bottom: 12px !important; 
}
.msg-reaction {
    position: absolute;
    bottom: -12px;     /* ÙŠØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø£Ø³ÙÙ„ */
    right: 10px;       /* Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø© */
    background: #1e293b;
    border: 2px solid #050b14; /* Ø­Ø¯ÙˆØ¯ Ø¨Ù†ÙØ³ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Øª Ù„ÙŠÙØµÙ„Ù‡Ø§ */
    color: #fff;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 14px;
    z-index: 10;       /* ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    cursor: pointer;
    min-width: 24px;   /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ */
    text-align: center;
}

/* Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø© Ù…Ù†ÙŠ (sender)ØŒ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙŠÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
.sender .msg-reaction {
    right: auto;
    left: 10px;
}

/* ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ØªØ³Ù…Ø­ Ø¨Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù†Ù‡Ø§ */
.msg-bubble {
    overflow: visible !important; 
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø°Ù */
.btn-cancel-del {
    background: rgba(255, 255, 255, 0.1); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© ØºØ§Ù…Ù‚Ø© Ø´ÙˆÙŠØ© */
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-cancel-del:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø­Ø°Ù (Ø£Ø­Ù…Ø± Ù„Ù„ØªØ­Ø°ÙŠØ±) */
.btn-confirm-del {
    background: #ff3b30; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± */
    color: #fff;
    box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); /* Ø¸Ù„ Ø£Ø­Ù…Ø± */
}

.btn-confirm-del:hover {
    background: #d9342b; /* Ø£Ø­Ù…Ø± Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ */
    transform: scale(0.98);
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù…Ø«Ù„ Ù…Ø§Ø³Ù†Ø¬Ø±) */
.swipe-reaction-bar {
    position: absolute;
    top: -45px; /* ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    right: 10px; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† */
    background: #1e293b; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ† */
    padding: 5px 10px;
    border-radius: 50px; /* Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø© */
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    opacity: 0;
    transform: translateY(10px) scale(0.9);
    animation: popInReaction 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ§Ø¹ØªÙŠ (Sender) Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØ¬ÙŠ Ø´Ù…Ø§Ù„ Ø´ÙˆÙŠØ© */
.sender .swipe-reaction-bar {
    right: auto;
    left: 10px;
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· */
.swipe-emoji-btn {
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
    line-height: 1;
}

.swipe-emoji-btn:hover {
    transform: scale(1.3);
}

/* Ø²Ø± Ø§Ù„Ø²Ø§Ø¦Ø¯ (+) */
.swipe-plus-btn {
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
}

.swipe-plus-btn:hover {
    background: rgba(255,255,255,0.2);
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± */
@keyframes popInReaction {
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù…Ø«Ù„ Ù…Ø§Ø³Ù†Ø¬Ø±) */
.swipe-reaction-bar {
    position: absolute;
    top: -45px; /* ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    right: 10px; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† */
    background: #1e293b; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ† */
    padding: 5px 10px;
    border-radius: 50px; /* Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø© */
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    opacity: 0;
    transform: translateY(10px) scale(0.9);
    animation: popInReaction 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ§Ø¹ØªÙŠ (Sender) Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØ¬ÙŠ Ø´Ù…Ø§Ù„ Ø´ÙˆÙŠØ© */
.sender .swipe-reaction-bar {
    right: auto;
    left: 10px;
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· */
.swipe-emoji-btn {
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
    line-height: 1;
}

.swipe-emoji-btn:hover {
    transform: scale(1.3);
}

/* Ø²Ø± Ø§Ù„Ø²Ø§Ø¦Ø¯ (+) */
.swipe-plus-btn {
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
}

.swipe-plus-btn:hover {
    background: rgba(255,255,255,0.2);
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± */
@keyframes popInReaction {
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* ================= 1. Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø± Ù„Ù„ØµÙˆØ±Ø© ================= */
.msg-user-avatar {
    /* ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ÙÙˆÙ‚ Ø£ÙŠ Ø¹Ù†ØµØ± Ø´ÙØ§Ù Ø¢Ø®Ø± */
    position: relative;
    z-index: 10; 
    cursor: pointer !important; /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± Ø£Ù† ÙŠÙƒÙˆÙ† ÙŠØ¯ */
    transition: transform 0.2s ease;
}

.msg-user-avatar:active {
    transform: scale(0.9); /* ØªØ£Ø«ÙŠØ± Ø¶ØºØ·Ø© Ø®ÙÙŠÙ */
}

/* ================= 2. ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Neon Glass) ================= */
.user-popup-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.85); /* Ø®Ù„ÙÙŠØ© ØºØ§Ù…Ù‚Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªØ±ÙƒÙŠØ² */
    backdrop-filter: blur(15px); /* ØªÙ…ÙˆÙŠÙ‡ Ù‚ÙˆÙŠ Ù„Ù„Ø®Ù„ÙÙŠØ© */
    z-index: 999999 !important; /* ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
    display: none;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

.user-popup-card {
    position: relative;
    width: 320px;
    background: rgba(20, 30, 48, 0.9); /* Ù„ÙˆÙ† ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ */
    border-radius: 30px;
    padding: 0;
    border: 1px solid rgba(0, 229, 255, 0.2); /* Ø­Ø¯ÙˆØ¯ Ù†ÙŠÙˆÙ† Ø®ÙÙŠÙØ© */
    box-shadow: 0 0 50px rgba(0, 229, 255, 0.15); /* ØªÙˆÙ‡Ø¬ Ø®Ù„ÙÙŠ */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: popupScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù„ÙˆÙ† */
.popup-header-bg {
    width: 100%;
    height: 110px;
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    clip-path: ellipse(80% 80% at 50% 0%); /* Ø´ÙƒÙ„ Ù…Ù‚ÙˆØ³ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© */
.popup-avatar-wrapper {
    position: relative;
    margin-top: -60px; /* Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ */
    padding: 4px;
    border-radius: 50%;
    background: linear-gradient(to bottom, #00e5ff, #0f1926); /* Ø¨Ø±ÙˆØ§Ø² Ù…ØªØ¯Ø±Ø¬ */
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
}

.popup-avatar {
    width: 110px; height: 110px;
    border-radius: 50%;
    background-color: #0f1926;
    background-size: cover; background-position: center;
    border: 4px solid #0f1926; /* ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¨Ø±ÙˆØ§Ø² Ø§Ù„Ù…Ù„ÙˆÙ† */
}

/* Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
.popup-info {
    text-align: center;
    padding: 15px 20px;
    width: 100%;
}

.popup-name-row {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    margin-bottom: 5px;
}

.popup-name {
    font-size: 20px; font-weight: bold; color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.popup-verify {
    color: #00e5ff; font-size: 16px;
    filter: drop-shadow(0 0 5px rgba(0, 229, 255, 0.6)); /* ØªÙˆÙ‡Ø¬ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© */
}

.popup-bio {
    font-size: 13px; color: #94a3b8;
    background: rgba(255,255,255,0.05);
    padding: 6px 15px; border-radius: 20px;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.05);
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.popup-actions-grid {
    display: flex; gap: 12px; width: 100%; padding: 0 25px 30px;
}

.popup-btn {
    flex: 1; height: 45px;
    border: none; border-radius: 14px;
    font-family: inherit; font-weight: bold; font-size: 14px;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: 0.2s;
}

.popup-btn.primary {
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    color: #fff; box-shadow: 0 4px 15px rgba(0, 100, 255, 0.3);
}

.popup-btn.secondary {
    background: rgba(255,255,255,0.08);
    color: #fff; border: 1px solid rgba(255,255,255,0.1);
}

@keyframes popupScale { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ© Ù„ØªØ³ØªÙˆØ¹Ø¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.popup-actions-grid {
    display: flex;
    flex-direction: column; /* ØªØ±ØªÙŠØ¨ Ø¹Ù…ÙˆØ¯ÙŠ */
    gap: 10px;
    width: 100%;
    padding: 0 25px 30px;
}

/* Ø²Ø± Ø§Ù„Ø­Ø¸Ø± Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù */
.block-btn {
    color: #ff3b30 !important;
    border-color: rgba(255, 59, 48, 0.3) !important;
}
.block-btn:hover {
    background: rgba(255, 59, 48, 0.1) !important;
}

/* --- 1. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù‚Ø±Ù…Ø²ÙŠØ© Ù„Ù„Ù‚ØµØ© --- */
.story-ring-active {
    position: relative;
    z-index: 1;
}

/* Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© (Gradient Ù‚Ø±Ù…Ø²ÙŠ) */
.story-ring-active::before {
    content: '';
    position: absolute;
    top: -6px; left: -6px; right: -6px; bottom: -6px;
    border-radius: 50%;
    background: linear-gradient(45deg, #dc143c, #ff4081); /* Ù‚Ø±Ù…Ø²ÙŠ Crimson */
    z-index: -1;
    animation: spin 4s linear infinite; /* Ø¯ÙˆØ±Ø§Ù† Ø¨Ø·ÙŠØ¡ */
}

/* Ø·Ø¨Ù‚Ø© ØªÙØµÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
.story-ring-active::after {
    content: '';
    position: absolute;
    top: -3px; left: -3px; right: -3px; bottom: -3px;
    border-radius: 50%;
    background: #0f1926; /* Ù†ÙØ³ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ§Ø±Øª */
    z-index: -1;
}

/* --- 2. Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù„Ù‚Ø¨ --- */
.nickname-modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85); z-index: 200000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}

.nickname-card {
    background: #1e293b; width: 85%; max-width: 350px;
    padding: 25px; border-radius: 20px; text-align: center;
    border: 1px solid rgba(0, 229, 255, 0.2);
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.nickname-input {
    width: 100%; padding: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; color: #fff;
    margin: 15px 0; font-size: 16px; text-align: center;
}

.nickname-input:focus { border-color: #00e5ff; outline: none; }

@keyframes spin { 100% { transform: rotate(360deg); } }

/* ================= ØªØµÙ…ÙŠÙ… Ø­Ù„Ù‚Ø© Ø§Ù„Ù‚ØµØ© (Story Ring) ================= */
/* Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø°ÙŠ Ø³Ù†Ø¶ÙŠÙÙ‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ù„Ùˆ Ø§Ù„Ø´Ø®Øµ Ø¹Ù†Ø¯Ù‡ Ø³ØªÙˆØ±ÙŠ */
.user-avatar-container.has-story {
    padding: 3px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„Ø­Ù„Ù‚Ø© */
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    animation: spin-story 2s linear infinite; /* Ø¯ÙˆØ±Ø§Ù† Ø¨Ø·ÙŠØ¡ Ù„Ù„Ø­Ù„Ù‚Ø© */
}

/* Ø·Ø¨Ù‚Ø© Ø«Ø§Ø¨ØªØ© Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© Ù…ØªÙ„ÙØ´ Ù…Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø© */
.user-avatar-container.has-story .header-avatar {
    border: 2px solid #0b1121; /* ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø­Ù„Ù‚Ø© */
}

@keyframes spin-story {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
}

/* ================= Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù„Ù‚Ø¨ ================= */
.nickname-modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8); z-index: 300000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
z-index: 2147483647 !important;
}

.nickname-card {
    background: #1e293b; width: 85%; max-width: 320px;
    padding: 25px; border-radius: 20px; text-align: center;
    border: 1px solid rgba(0, 229, 255, 0.2);
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.nickname-input {
    width: 100%; padding: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px; color: #fff;
    margin: 15px 0; font-size: 16px; text-align: center;
}
.nickname-input:focus { border-color: #00e5ff; outline: none; }

/* ØªÙ…ÙŠÙŠØ² Ø±Ø³Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ù‚Ø¨ ÙÙŠ Ø§Ù„Ø´Ø§Øª */
.nickname-system-msg {
    width: 100%; text-align: center; margin: 10px 0;
}
.nickname-system-msg span {
    background: rgba(0, 229, 255, 0.1);
    color: #00e5ff; font-size: 11px;
    padding: 4px 12px; border-radius: 15px;
    border: 1px solid rgba(0, 229, 255, 0.2);
}


/* Ø·Ø¨Ù‚Ø© Ø³ÙˆØ¯Ø§Ø¡ ØµØºÙŠØ±Ø© ØªÙØµÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù† Ø§Ù„Ø¯Ø§ÙŠØ±Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ ÙŠØ¨Ø§Ù† Ù†Ø¸ÙŠÙ */
.header-avatar {
    border: 2px solid #0b1121; /* Ù†ÙØ³ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„Ù‡ÙŠØ¯Ø± */
    background-clip: padding-box;
}



/* Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.story-media-element {
    width: 100%; height: 100%;
    object-fit: contain; /* ØªØ¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
}


/* ================= ØªØµÙ…ÙŠÙ… Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (ØªØ­Ø¯ÙŠØ«) ================= */
#simpleStoryViewer {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #000;

    display: none; 
    flex-direction: column;
    /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨ */
    transform-origin: bottom center;
    will-change: transform, opacity;
}

.story-progress-container {
    position: absolute; top: 10px; left: 10px; right: 10px;
    height: 3px; background: rgba(255,255,255,0.3);
    border-radius: 2px; z-index: 20;
    display: flex; /* Ù„Ø¯Ø¹Ù… ØªØ¹Ø¯Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¦Ø· Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ */
}

.story-progress-bar {
    height: 100%; width: 0%;
    background: #fff;
    border-radius: 2px;
    transition: width 0.1s linear;
}

.story-user-top {
    position: absolute; 
    top: 25px; 
    left: 20px;
    display: flex; 
    align-items: center; 
    gap: 10px;
    z-index: 90;
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø­Ø¨ ÙŠØ´ØªØºÙ„ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù…Ø³Øª Ø§Ù„Ø§Ø³Ù… */
}
.story-user-top img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #fff; object-fit: cover; }
.story-user-top span { color: #fff; font-weight: bold; font-size: 14px; font-family: 'Cairo', sans-serif; }

.story-media-element {
    width: 100%; height: 100%;
    object-fit: contain; /* ØªØ¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¯ÙˆÙ† Ù‚Øµ */
    max-height: 100vh;
}

.close-story-btn {
    position: absolute;
    top: 25px; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± */
    right: 20px; /* Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø£Ùˆ Ø§Ù„ÙŠØ³Ø§Ø± Ø­Ø³Ø¨ ØªÙØ¶ÙŠÙ„Ùƒ) */
    z-index: 100;
    width: 35px;
    height: 35px;
    background: rgba(0, 0, 0, 0.3); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
    backdrop-filter: blur(5px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.2);
    transition: 0.2s;
}

.close-story-btn:active {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(0.9);
}

/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª (Ø£Ù†Ø§ ÙŠÙ…ÙŠÙ†/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø£Ù†Ø§ ÙŠØ³Ø§Ø± - Ù‡Ùˆ ÙŠÙ…ÙŠÙ†) ================= */

/* 1. Ø¶Ø¨Ø· Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„ØµÙÙˆÙ (ØªØ¹Ø¯ÙŠÙ„ Ù„ØµÙØ­Ø© Ø¹Ø±Ø¨ÙŠØ© RTL) */
.msg-row {
    display: flex;
    width: 100%;
    margin-bottom: 8px;
    align-items: flex-start; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
}

/* --- (Ø£Ù†Ø§) Sender -> ÙŠØ³Ø§Ø± --- */
.msg-row.sender {
    /* ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠ (RTL): flex-end ØªØ¹Ù†ÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± */
    justify-content: flex-end; 
}

/* --- (Ù‡Ùˆ) Receiver -> ÙŠÙ…ÙŠÙ† --- */
.msg-row.receiver {
    /* ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠ (RTL): flex-start ØªØ¹Ù†ÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
    justify-content: flex-start; 
}

/* 2. Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ù†ÙØ³Ù‡Ø§ (Ø¹Ù„Ù‰ Ù‚Ø¯ Ø§Ù„ÙƒÙ„Ø§Ù… + Ø³ØªØ§ÙŠÙ„ ØºØ§Ù…Ù‚) */
.msg-bubble {
    position: relative;
    padding: 8px 12px; 
    font-size: 14px;
    line-height: 1.5;
    
    /* Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ù‚Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    width: fit-content !important; 
    max-width: 75%; 
    
    word-wrap: break-word; 
    white-space: pre-wrap;
    
    display: flex;
    flex-direction: column;
    font-family: 'Cairo', sans-serif;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* 3. Ø³ØªØ§ÙŠÙ„ Ø±Ø³Ø§Ù„ØªÙŠ (Ø£Ù†Ø§ - ÙŠØ³Ø§Ø±) */
.sender .msg-bubble {
    background: #111111; /* Ø£Ø³ÙˆØ¯ ÙØ­Ù…ÙŠ */
    color: #e0e0e0;
    
    /* Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ø¯Ø©: ÙÙˆÙ‚ Ø´Ù…Ø§Ù„ */
    border-radius: 0px 12px 12px 12px; 
    
    border: 1px solid #333;
    
    /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ù…Ù† Ø­Ø§ÙØ© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ */
    margin-left: 10px; 
}

/* 4. Ø³ØªØ§ÙŠÙ„ Ø±Ø³Ø§Ù„ØªÙ‡ (Ù‡Ùˆ - ÙŠÙ…ÙŠÙ†) */
.receiver .msg-bubble {
    background: #1f2937; /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ */
    color: #fff;
    
    /* Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ø¯Ø©: ÙÙˆÙ‚ ÙŠÙ…ÙŠÙ† */
    border-radius: 12px 0px 12px 12px; 
    
    border: 1px solid #374151;
}

/* 5. Ø¶Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„Ø§ÙØ§ØªØ§Ø±) Ø¨ØªØ§Ø¹ØªÙ‡ Ù‡Ùˆ (Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) */
.msg-row.receiver .msg-user-avatar {
    /* Ø§Ù„ØµÙˆØ±Ø© ØªØ¸Ù‡Ø± Ø·Ø¨ÙŠØ¹ÙŠ ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    margin-left: 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© */
    margin-top: 0;
    width: 32px; height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* 6. Ø§Ù„ÙˆÙ‚Øª */
.msg-meta-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
    font-size: 10px;
    opacity: 0.6;
}


/* ================= Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø­Ù„Ù‚Ø© Ø§Ù„Ù‚ØµØ© ÙÙŠ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ================= */

/* 1. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
.pp-avatar-lg.has-story-active {
    /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
    border: 3px solid transparent !important;
    
    /* Ø®Ø¯Ø¹Ø© Ù„Ø¹Ù…Ù„ Ø­Ø¯ÙˆØ¯ Ù…ØªØ¯Ø±Ø¬Ø© (Gradient Border) */
    background-image: linear-gradient(#1e293b, #1e293b), /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
                      linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888) !important; /* Ø£Ù„ÙˆØ§Ù† Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù… */
    background-origin: border-box;
    background-clip: content-box, border-box;
    
    /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø­Ù„Ù‚Ø© */
    padding: 4px !important; 
    
    /* ØªØ£Ø«ÙŠØ± ØªÙˆÙ‡Ø¬ */
    box-shadow: 0 0 25px rgba(220, 39, 67, 0.6) !important;
    
    /* Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø¤Ø´Ø± ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¨Ù„ÙŠØ© Ù„Ù„Ø¶ØºØ· */
    cursor: pointer !important;
    
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¯ÙˆØ±Ø§Ù† Ø¨Ø·ÙŠØ¡ */
    animation: pulse-ring-border 3s infinite alternate;
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ· Ù„Ù„Ù†Ø¨Ø¶ */
@keyframes pulse-ring-border {
    0% { box-shadow: 0 0 20px rgba(220, 39, 67, 0.4); }
    100% { box-shadow: 0 0 30px rgba(220, 39, 67, 0.8); transform: scale(1.02); }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.chat-footer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 100;
    background: rgba(11, 17, 33, 0.98); /* Ø®Ù„ÙÙŠØ© ØºØ§Ù…Ù‚Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ø§Ù† */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    
    display: flex;
    align-items: flex-end; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„Ù†Øµ ÙƒØ¨Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªÙØ¶Ù„ ØªØ­Øª */
    padding: 10px;
    gap: 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª */
    min-height: 60px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± (ØµØºÙŠØ±Ø© ÙˆÙ…ØªÙ†Ø§Ø³Ù‚Ø©) */
.action-btn {
    width: 38px;  /* ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ */
    height: 38px; /* ØªØµØºÙŠØ± Ø§Ù„Ø·ÙˆÙ„ */
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 16px; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
    transition: 0.2s;
    flex-shrink: 0; /* Ù…Ù…Ù†ÙˆØ¹ ØªÙ†ÙƒÙ…Ø´ */
    margin-bottom: 2px; /* ØªØ¸Ø¨ÙŠØ· Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ */
    
    /* Ø³ØªØ§ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #94a3b8;
}

.action-btn:active { transform: scale(0.9); }

/* Ø£Ù„ÙˆØ§Ù† Ø®Ø§ØµØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
.media-btn:hover { color: #00e5ff; border-color: rgba(0, 229, 255, 0.3); }
.file-btn:hover { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
.gif-btn:hover { color: #ec4899; border-color: rgba(236, 72, 153, 0.3); }
.mic-btn:hover { color: #10b981; border-color: rgba(16, 185, 129, 0.3); }

/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù…Ù…ÙŠØ²) */
.send-btn {
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    color: #fff;
    border: none;
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ø´Ù…Ø§Ù„ */
.footer-actions-left {
    display: flex;
    align-items: center;
    gap: 6px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±Ø§ÙŠØ± ÙˆØ¨Ø¹Ø¶Ù‡Ø§ */
    transition: all 0.3s ease;
    overflow: hidden;
}

/* ÙƒÙ„Ø§Ø³ Ù„Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§Ø¹Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
.footer-actions-left.hidden {
    max-width: 0;
    opacity: 0;
    padding: 0;
    margin: 0;
}

/* Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
.input-container {
    flex: 1; /* ÙŠØ§Ø®Ø¯ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
    background: rgba(0, 0, 0, 0.2);
    border-radius: 20px;
    padding: 8px 15px;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    min-height: 40px;
    max-height: 120px; /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ */
    overflow-y: auto;
}

.chat-input {
    width: 100%;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 14px;
    resize: none;
    height: 22px; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
    padding: 0;
    line-height: 1.4;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ù€ GIF */
.gif-picker { bottom: 70px; } 

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù€ Padding Ù„Ù„Ø¬Ø³Ù… Ø¹Ø´Ø§Ù† Ø§Ù„ÙÙˆØªØ± Ù…ÙŠØºØ·ÙŠØ´ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© */
.chat-body { padding-bottom: 80px !important; }
/* Ø²Ø± Ø§Ù„ÙÙˆØªØ± */
.gift-center-btn {
    background: linear-gradient(135deg, #ff4081 0%, #f50057 100%);
    color: #fff;
    border: none;
    box-shadow: 0 0 10px rgba(245, 0, 87, 0.4);
    position: relative;
}
.gift-badge {
    position: absolute; top: -5px; right: -5px;
    background: #FFD700; color: #000; font-size: 8px; font-weight: bold;
    padding: 2px 4px; border-radius: 4px; border: 1px solid #000;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ø§ÙØ°Ø© */
.gift-sheet {
    background: #121212;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding: 0; /* Ù‡Ù†Ø¸Ø¨Ø· Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ Ø¬ÙˆÙ‡ */
    overflow: hidden;
    height: 60vh; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
    display: flex; flex-direction: column;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø±ØµÙŠØ¯ */
.gift-header-top {
    padding: 15px;
    background: rgba(255,255,255,0.03);
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.user-balance-box {
    background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px;
    display: flex; align-items: center; gap: 6px; border: 1px solid #FFD700;
}
.coin-num { color: #FFD700; font-weight: bold; font-family: monospace; font-size: 15px; }
.add-coins-btn {
    background: #FFD700; color: #000; border: none; padding: 6px 12px;
    border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 12px;
}

/* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.gift-tabs {
    display: flex; padding: 10px; gap: 10px;
    background: #1a1a1a;
}
.gift-tab {
    flex: 1; text-align: center; padding: 10px;
    background: rgba(255,255,255,0.05); color: #888;
    border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: bold;
    transition: 0.2s; border: 1px solid transparent;
}
.gift-tab.active {
    background: rgba(255, 64, 129, 0.15); color: #ff4081;
    border-color: #ff4081;
}

/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
.gift-content-panel {
    display: none; flex: 1; overflow-y: auto; padding: 10px;
}
.gift-content-panel.active { display: grid; }

/* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© */
.stickers-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
}
.sticker-item {
    font-size: 40px; text-align: center; cursor: pointer;
    padding: 10px; border-radius: 10px; transition: 0.2s;
}
.sticker-item:active { transform: scale(0.8); background: rgba(255,255,255,0.1); }

.sticker-bubble {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
}
/* === Ø¥ØµÙ„Ø§Ø­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ === */
#giftCenterModal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ø´ÙØ§ÙØ© */
    z-index: 20000; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    
    /* Ø£Ù‡Ù… Ø¬Ø²Ø¡: Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
    opacity: 0;
    visibility: hidden;
    pointer-events: none; /* Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ¯ÙˆØ³ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Øª Ù…Ù† ØªØ­ØªÙ‡Ø§ */
    
    transition: all 0.3s ease;
    display: flex;
    align-items: flex-end; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØ·Ù„Ø¹ Ù…Ù† ØªØ­Øª */
    justify-content: center;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ± (Ù„Ù…Ø§ Ù†Ø¶ØºØ·) */
#giftCenterModal.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto; /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ù…Ø³ */
}

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†ÙØ³Ù‡Ø§ */
.gift-sheet {
    width: 100%;
    max-width: 500px;
    background: #121212;
    border-top: 1px solid rgba(255,255,255,0.1);
    border-radius: 25px 25px 0 0;
    
    /* Ø§Ù„Ø­Ø±ÙƒØ© */
    transform: translateY(100%); /* Ù†Ø§Ø²Ù„Ø© ØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    
    height: 60vh;
    display: flex; 
    flex-direction: column;
}

/* Ù„Ù…Ø§ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙØªØ­ØŒ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØ·Ù„Ø¹ Ù„ÙÙˆÙ‚ */
#giftCenterModal.active .gift-sheet {
    transform: translateY(0);
}
#giftCenterModal {
    /* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ØµØ§Ø¦Øµ ... */
    z-index: 2147483647 !important; /* Ø±ÙØ¹ Ø§Ù„Ø±Ù‚Ù… Ù„ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ø£Ø®Ø±Ù‰ */
}
/* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù„Ù…Ù„ØµÙ‚Ø§Øª Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø­Ø± */
.sticker-bubble {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
}

/* ØªÙ†Ø³ÙŠÙ‚ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù‡Ø¯ÙŠØ© Ù„ØªÙƒÙˆÙ† Ù…Ù…ÙŠØ²Ø© */
.gift-bubble {
    background: linear-gradient(135deg, #1a1a1a, #2a2a2a) !important;
    border: 1px solid #FFD700 !important; /* Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ */
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2) !important;
}

/* Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
/* ================= ØªØµÙ…ÙŠÙ… ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø³Ø­Ø±ÙŠ ================= */

/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ø­Ø±ÙƒØ©) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù…Ø³Ø±Ø­) */
.gift-interactive-container {
    position: relative;
    width: 160px; /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ */
    height: 180px; /* Ø§Ø±ØªÙØ§Ø¹ ÙŠØ³ØªÙˆØ¹Ø¨ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø®Ø§ØªÙ… */
    margin: 10px auto;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end; /* ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
    overflow: visible; /* Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ø®Ø§ØªÙ… Ù„Ù…Ø§ ÙŠØ·Ù„Ø¹ Ù…ÙŠØªØ®ØµØ´ */
}

/* 2. Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ø¬Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ + Ø§Ù„ØºØ·Ø§Ø¡) */
.gift-package {
    position: relative;
    width: 100px;
    height: 80px;
    z-index: 10;
    transition: transform 0.5s;
    /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ù‚Ø¨Ù„ Ø§Ù„ÙØªØ­ */
    animation: boxShake 2s infinite; 
}

/* ÙˆÙ‚Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
.gift-interactive-container.opened .gift-package {
    animation: none;
    transform: translateY(10px); /* ÙŠÙ†Ø²Ù„ Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ«Ø¨Øª */
}

/* 3. Ø¬Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Body) */
.magic-box {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #e91e63, #ad1457); /* Ù„ÙˆÙ† ÙÙˆØ´ÙŠØ§ ØºØ§Ù…Ù‚ */
    border-radius: 0 0 10px 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
    z-index: 2;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø²ÙŠÙ†Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
.magic-box::before {
    content: '';
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 18px;
    height: 100%;
    background: #FFD700; /* Ø°Ù‡Ø¨ÙŠ */
    border-left: 1px solid rgba(255,255,255,0.2);
    border-right: 1px solid rgba(0,0,0,0.1);
}

/* 4. Ø§Ù„ØºØ·Ø§Ø¡ (Lid) - ØªÙ… Ø¶Ø¨Ø· Ù…ÙƒØ§Ù†Ù‡ Ù„ÙŠÙƒÙˆÙ† Ù…Ù„ØªØµÙ‚Ø§Ù‹ Ø¨Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
.magic-lid {
    position: absolute;
    top: -15px; /* ÙŠØ±ÙƒØ¨ ÙÙˆÙ‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    left: -5px; /* ÙŠØ¨Ø±Ø² Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ */
    width: 110px; /* Ø£Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù€ 10px */
    height: 25px;
    background: linear-gradient(135deg, #ff4081, #c60055);
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.4);
    z-index: 3;
    transition: all 0.6s cubic-bezier(0.6, -0.28, 0.735, 0.045); /* Ø­Ø±ÙƒØ© Ø·ÙŠØ±Ø§Ù† ÙˆØ§Ù‚Ø¹ÙŠØ© */
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø²ÙŠÙ†Ø© Ø¹Ù„Ù‰ Ø§Ù„ØºØ·Ø§Ø¡ */
.magic-lid::before {
    content: '';
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 18px;
    height: 100%;
    background: #FFD700;
}

/* Ø§Ù„ÙÙŠÙˆÙ†ÙƒØ© (Bow) */
.magic-lid::after {
    content: 'ğŸ€'; /* Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ÙÙŠÙˆÙ†ÙƒØ© Ø£Ùˆ Ø±Ø³Ù…Ø© */
    position: absolute;
    top: -28px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 35px;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
}

/* 5. Ø­Ø±ÙƒØ© Ø·ÙŠØ±Ø§Ù† Ø§Ù„ØºØ·Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ */
.gift-interactive-container.opened .magic-lid {
    top: -150px; /* ÙŠØ·ÙŠØ± Ù„ÙÙˆÙ‚ */
    left: 50px;  /* ÙŠÙ…ÙŠÙ„ Ù„Ù„ÙŠÙ…ÙŠÙ† */
    transform: rotate(45deg) scale(0.8);
    opacity: 0;  /* ÙŠØ®ØªÙÙŠ */
}
/* ================= ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… ÙˆÙ…ÙƒØ§Ù† Ø§Ù„Ø®Ø§ØªÙ… ================= */

/* 1. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„Ø®Ø§ØªÙ…) Ù„Ø¶Ø¨Ø· Ù…ÙƒØ§Ù†Ù‡ */
.magic-gift-content {
    position: absolute;
    bottom: 30px; /* ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¬ÙˆÙ‡ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
    left: 0;
    right: 0;
    text-align: center;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 1;
    pointer-events: none;
}

/* Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­: Ø§Ù„Ø®Ø§ØªÙ… ÙŠØ·Ù„Ø¹ ÙÙˆÙ‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ */
.gift-interactive-container.opened .magic-gift-content {
    bottom: 65px; /* ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¸Ø¨Ø·Ù†Ø§ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† ÙÙˆÙ‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø§Ù„Ø¸Ø¨Ø· ğŸ”¥ */
    opacity: 1;
    transform: scale(1); /* ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø´ÙŠÙ„Ù†Ø§ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (ÙƒØ§Ù† 1.2) Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø¬Ù… ÙŠØ¨Ù‚Ù‰ ÙˆØ§Ù‚Ø¹ÙŠ ğŸ”¥ */
    z-index: 5;
}

/* 2. ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø®Ø§ØªÙ… */
.magic-gift-icon {
    font-size: 55px; /* ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØµØºØ±Ù†Ø§ Ø§Ù„Ø­Ø¬Ù… Ù…Ù† 80px Ù„Ù€ 55px Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ù…Ù„Ø§Ø¦Ù… ğŸ”¥ */
    filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¸Ù„ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
}

/* Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯ÙŠØ© Ù†Ù†Ø²Ù„Ù‡ Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒÙˆÙ†Ø´ Ù„Ø§Ø²Ù‚ ÙÙŠ Ø§Ù„Ø®Ø§ØªÙ… */
.magic-gift-name {
    margin-top: 8px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© */
    /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ */
    background: rgba(0,0,0,0.7);
    color: #FFD700;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 12px;
    display: inline-block;
    box-shadow: 0 0 10px #FFD700;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙŠ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¨Ø¶ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒØ¨Ø±Ø´ Ø£ÙˆÙŠ ÙˆÙ‡Ùˆ Ø¨ÙŠÙ†Ø¨Ø¶) */
@keyframes ringHeartBeat {
    0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255,215,0,0.5)); }
    15% { transform: scale(1.15); filter: drop-shadow(0 0 15px rgba(255,215,0,1)); } /* ØªÙƒØ¨ÙŠØ± Ø£Ù‡Ø¯Ù‰ */
    30% { transform: scale(1.05); }
    45% { transform: scale(1.1); filter: drop-shadow(0 0 10px rgba(255,215,0,0.8)); }
    60% { transform: scale(1); }
    100% { transform: scale(1); }
}
/* ================= Ø­Ø§Ù„Ø© "ØªÙ… Ø§Ù„ÙØªØ­ Ø³Ø§Ø¨Ù‚Ø§Ù‹" (Re-closed) ================= */

/* 1. Ù„Ù…Ø§ Ù†Ù‚ÙÙ„ Ø§Ù„Ù‡Ø¯ÙŠØ© ØªØ§Ù†ÙŠØŒ Ù†ÙˆÙ‚Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² */
.gift-interactive-container.has-been-opened:not(.opened) .gift-package {
    animation: none; /* ÙˆÙ‚Ù Ø§Ù„Ù†Ø¨Ø¶/Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² */
}

/* 2. Ø´ÙƒÙ„ Ø§Ù„ØºØ·Ø§Ø¡ ÙˆÙ‡Ùˆ Ù…Ù‚ÙÙˆÙ„ "ØªØ§Ù†ÙŠ Ù…Ø±Ø©" (ÙŠØ¨Ø§Ù† Ù…ÙÙƒÙˆÙƒ) */
.gift-interactive-container.has-been-opened:not(.opened) .magic-lid {
    transform: rotate(5deg) translateY(-3px); /* Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙˆØ±ÙØ¹Ø© Ù„ÙÙˆÙ‚ */
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* Ø¸Ù„ Ø£Ø®Ù */
}

/* 3. ØªØºÙ…ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ø´Ø§Ù† ÙŠØ¨Ø§Ù† Ù…Ø³ØªØ¹Ù…Ù„ */
.gift-interactive-container.has-been-opened:not(.opened) .magic-box {
    filter: brightness(0.9);
}
/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ®Ù… (Luxury Box) ================= */

/* 1. Ø¬Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ®Ù… (Ø£Ø³ÙˆØ¯ x Ø°Ù‡Ø¨ÙŠ) */
.gift-interactive-container.luxury-tier .magic-box {
    background: linear-gradient(135deg, #1a1a1a, #000000); /* Ø£Ø³ÙˆØ¯ ÙØ§Ø­Ù… */
    border: 1px solid #FFD700; /* Ø­Ø¯ÙˆØ¯ Ø°Ù‡Ø¨ÙŠØ© */
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); /* ØªÙˆÙ‡Ø¬ Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ */
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø²ÙŠÙ†Ø© Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙØ®Ù… */
.gift-interactive-container.luxury-tier .magic-box::before {
    background: linear-gradient(to bottom, #FFD700, #FDB931, #FFD700); /* Ø´Ø±ÙŠØ· Ø°Ù‡Ø¨ÙŠ Ù„Ø§Ù…Ø¹ */
    width: 20px;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
}

/* 2. Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„ÙØ®Ù… */
.gift-interactive-container.luxury-tier .magic-lid {
    background: linear-gradient(135deg, #2b2b2b, #0d0d0d);
    border: 1px solid #FFD700;
    border-bottom: none; /* Ø¹Ø´Ø§Ù† ÙŠØ±ÙƒØ¨ ØµØ­ */
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø²ÙŠÙ†Ø© Ù„Ù„ØºØ·Ø§Ø¡ Ø§Ù„ÙØ®Ù… */
.gift-interactive-container.luxury-tier .magic-lid::before {
    background: linear-gradient(to bottom, #FFD700, #FDB931);
}

/* Ø§Ù„ÙÙŠÙˆÙ†ÙƒØ© (Ù…Ù…ÙƒÙ† Ù†ØºÙŠØ±Ù‡Ø§ Ù„ØªØ§Ø¬ Ø£Ùˆ Ù…Ø§Ø³Ø© Ù„Ùˆ ØªØ­Ø¨ØŒ Ø¨Ø³ Ù‡Ù†Ø³ÙŠØ¨Ù‡Ø§ ÙÙŠÙˆÙ†ÙƒØ© Ø°Ù‡Ø¨ÙŠØ©) */
.gift-interactive-container.luxury-tier .magic-lid::after {
    content: 'ğŸ‘‘'; /* ØªØ§Ø¬ Ø¨Ø¯Ù„ Ø§Ù„ÙÙŠÙˆÙ†ÙƒØ© Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙØ®Ù…Ø© */
    font-size: 40px;
    top: -35px;
    filter: drop-shadow(0 0 5px #FFD700);
}

/* 3. ØªØ£Ø«ÙŠØ±Ø§Øª Ø®Ø§ØµØ© Ù„Ù„ÙØ®Ù… (Ø¨Ø±ÙŠÙ‚) */
.gift-interactive-container.luxury-tier::after {
    content: '';
    position: absolute;
    inset: -10px;
    background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%);
    z-index: 0;
    pointer-events: none;
    animation: luxuryGlow 3s infinite alternate;
}

@keyframes luxuryGlow {
    0% { opacity: 0.3; transform: scale(0.8); }
    100% { opacity: 0.8; transform: scale(1.1); }
}

/* 4. Ø´ÙƒÙ„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…Ù† Ø¬ÙˆÙ‡ (Ø§Ù„Ø®Ø§ØªÙ…/Ø§Ù„Ù‚ØµØ±) ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± ÙˆØ£ÙƒØ«Ø± Ù„Ù…Ø¹Ø§Ù†Ø§Ù‹ */
.gift-interactive-container.luxury-tier .magic-gift-icon {
    font-size: 70px; /* Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠØ© */
    filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8)); /* ÙˆÙ‡Ø¬ Ù‚ÙˆÙŠ */
}
/* ================= ØªØµÙ…ÙŠÙ… Ø´Ø¨ÙƒØ© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (TikTok Style) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ø§Ù„Ø´Ø¨ÙƒØ© Ù†ÙØ³Ù‡Ø§) */
.gift-grid {
    display: grid;
    /* 4 Ø£Ø¹Ù…Ø¯Ø© Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    grid-template-columns: repeat(4, 1fr); 
    gap: 8px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
    padding: 10px;
    padding-bottom: 80px; /* Ù…Ø³Ø§ÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙˆØµÙ„ Ù„Ù„Ø¢Ø®Ø± */
}

/* 2. ÙƒØ§Ø±Øª Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„ÙˆØ§Ø­Ø¯ (Ø§Ù„Ù…Ø±Ø¨Ø¹) */
.gift-item {
    background: rgba(255, 255, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© ØºØ§Ù…Ù‚Ø© */
    border: 1px solid rgba(255, 255, 255, 0.1); /* Ø¨Ø±ÙˆØ§Ø² Ø®ÙÙŠÙ */
    border-radius: 12px;
    padding: 10px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø³ */
.gift-item:active {
    transform: scale(0.95);
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--accent-color);
}

/* 3. Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡Ø¯ÙŠØ© (ÙƒØ¨ÙŠØ±Ø© ÙˆÙˆØ§Ø¶Ø­Ø©) */
.gift-emoji {
    font-size: 40px; /* Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
    margin-bottom: 5px;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); /* Ø¸Ù„ ÙŠØ®Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ø±Ø²Ø© */
    transition: transform 0.2s;
}

/* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.gift-item:active .gift-emoji {
    transform: scale(1.1);
}

/* 4. Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯ÙŠØ© */
.gift-name {
    font-size: 10px;
    color: #fff;
    font-weight: bold;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    margin-bottom: 2px;
}

/* 5. Ø³Ø¹Ø± Ø§Ù„Ù‡Ø¯ÙŠØ© (Ø´ÙŠÙƒ ÙˆØµØºÙŠØ±) */
.gift-price {
    font-size: 9px;
    color: #FFD700; /* Ø°Ù‡Ø¨ÙŠ */
    background: rgba(0, 0, 0, 0.4);
    padding: 2px 8px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 3px;
}

/* ================= ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„ÙØ®Ù…Ø© (Luxury Tier) ================= */
.gift-item.luxury-item {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 0, 0, 0.4));
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.gift-item.luxury-item .gift-name {
    color: #FFD700;
}
/* ØªÙ†Ø³ÙŠÙ‚ ØµÙˆØ± Ø§Ù„Ù€ GIF Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø¨ÙƒØ© */
.gif-grid-item {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    border-radius: 10px;
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø¶ØºØ·Ø© ØªÙŠØ¬ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø±Øª Ù†ÙØ³Ù‡ */
}

/* ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„ÙƒØ§Ø±Øª Ø¹Ø´Ø§Ù† ÙŠØ³ØªÙˆØ¹Ø¨ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø© */
.gift-item.gif-card {
    padding: 0; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
    border: none; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙˆØ±Ø¯Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
    overflow: hidden; /* Ù‚Øµ Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª */
    aspect-ratio: 1/1; /* Ù…Ø±Ø¨Ø¹ Ù…Ø«Ø§Ù„ÙŠ */
    background: #000; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */
}

/* ================= ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø³Ù… Ø§Ù„Ù€ GIF Ø§Ù„Ø¬Ø¯ÙŠØ¯ ================= */

/* 1. Ø§Ù„ÙƒØ§Ø±Øª Ù†ÙØ³Ù‡ (Ø§Ù„Ø­Ø§ÙˆÙŠØ©) */
.gift-item.gif-card {
    padding: 0 !important;       /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
    border: none !important;     /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
    overflow: hidden !important; /* Ù‚Øµ Ø£ÙŠ Ø²ÙŠØ§Ø¯Ø© */
    aspect-ratio: 1/1 !important; /* Ù…Ø±Ø¨Ø¹ Ù…Ø«Ø§Ù„ÙŠ */
    background: #000;            /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
    border-radius: 12px;         /* ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø­ÙˆØ§Ù */
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* 2. Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ù†ÙØ³Ù‡Ø§ */
.gif-grid-item {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø· */
    display: block;
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø¶ØºØ·Ø© ØªÙŠØ¬ÙŠ Ø¹Ø§Ù„ÙƒØ§Ø±Øª Ù…Ø´ Ø§Ù„ØµÙˆØ±Ø© */
}

/* 3. ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.gift-item.gif-card:active {
    transform: scale(0.95);
    opacity: 0.8;
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø´Ø¨ÙƒØ© Ø§Ù„Ù€ GIF (Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø§Ù†Ù‡Ø§ 4 Ø£Ø¹Ù…Ø¯Ø©) */
#gifsGrid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Ø®Ù„ÙŠÙ†Ø§Ù‡Ø§ 3 Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ GIF ÙŠØ¨Ø§Ù† Ø£ÙˆØ¶Ø­ */
    gap: 5px;
    padding: 10px;
    padding-bottom: 80px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª (Ù†ÙØ³ Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ 4 Ø£Ø¹Ù…Ø¯Ø©) */
.stickers-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ */
    gap: 8px;
    padding: 10px;
    padding-bottom: 80px; /* Ù…Ø³Ø§ÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙŠÙˆØµÙ„ Ù„Ù„Ø¢Ø®Ø± */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„ÙˆØ§Ø­Ø¯ */
.sticker-item {
    font-size: 35px; /* Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­ */
    text-align: center;
    cursor: pointer;
    padding: 10px;
    border-radius: 12px;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    
    /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ø¬Ø¯Ø§Ù‹ */
    background: rgba(255, 255, 255, 0.03); 
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.sticker-item:active {
    transform: scale(0.9);
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--accent-color);
}

/* ================= Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Inside Input) ================= */

/* 1. Ø¶Ø¨Ø· Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ØªÙƒÙˆÙ† Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹ */
.input-container {
    position: relative !important; /* Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø±Ø§Ø± ÙŠØ«Ø¨Øª Ø¬ÙˆØ§Ù‡ */
    display: flex;
    align-items: flex-end; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø±Ø§Ø± ÙŠÙØ¶Ù„ ØªØ­Øª Ù„Ùˆ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙƒØ¨Ø± */
}

/* 2. ØªØ¹Ø¯ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„ÙŠØªØ±Ùƒ Ù…Ø³Ø§ÙØ© Ù„Ù„Ø²Ø±Ø§Ø± */
.chat-input {
    padding-left: 40px !important; /* ÙˆØ³Ø¹Ù†Ø§ Ù…ÙƒØ§Ù† Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„ Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø±Ø§Ø± */
    /* Ø¨Ø§Ù‚ÙŠ Ø®ØµØ§Ø¦ØµÙƒ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ */
}

/* 3. ØªØµÙ…ÙŠÙ… Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ */
.internal-emoji-btn {
    position: absolute;
    left: 10px; /* Ù…ÙƒØ§Ù†Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù…Ø§Ù„ */
    bottom: 12px; /* Ø«Ø§Ø¨Øª ØªØ­Øª Ù…Ù‡Ù…Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙƒØ¨Ø± */
    
    font-size: 18px; /* ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ Ø²ÙŠ Ù…Ø§ Ø·Ù„Ø¨Øª */
    color: #64748b; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù‡Ø§Ø¯ÙŠ */
    cursor: pointer;
    z-index: 10;
    transition: 0.2s;
    
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px; 
    height: 24px;
    border-radius: 50%;
}

.internal-emoji-btn:hover {
    color: #00e5ff; /* ÙŠÙ†ÙˆØ± Ø£Ø²Ø±Ù‚ Ù„Ù…Ø§ ØªÙ‚Ù Ø¹Ù„ÙŠÙ‡ */
    background: rgba(255,255,255,0.05);
}

/* ================= Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) ================= */
/* ================= Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© - ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ) ================= */
.emoji-picker-panel {
    position: absolute;
    bottom: 70px; /* ÙÙˆÙ‚ Ø§Ù„ÙÙˆØªØ± Ù…Ø¨Ø§Ø´Ø±Ø© */
    
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø£ÙÙ‚ÙŠ */
    left: 50%;
    transform: translateX(-50%);
    
    width: 95%; /* Ø¹Ø±Ø¶ Ø´Ø¨Ù‡ ÙƒØ§Ù…Ù„ Ø¹Ø´Ø§Ù† ØªØ³ØªÙˆØ¹Ø¨ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙƒØªÙŠØ± */
    max-width: 400px; /* Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ø¹Ø´Ø§Ù† Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
    height: 280px;
    
    background: rgba(20, 25, 35, 0.98); /* Ø®Ù„ÙÙŠØ© ØºØ§Ù…Ù‚Ø© ÙØ®Ù…Ø© */
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    z-index: 2000;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    overflow: hidden;
    
    /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¸Ù‡ÙˆØ± Ù†Ø§Ø¹Ù… */
    animation: slideUpFade 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙˆØ³ÙŠØ·) */
.emoji-grid {
    display: grid;
    /* 7 ÙÙŠ Ø§Ù„ØµÙ Ø¹Ø´Ø§Ù† ÙŠØ³ØªØºÙ„ Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø£Ùˆ Ø®Ù„ÙŠÙ‡Ø§ auto-fill */
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
    gap: 8px;
    padding: 15px;
    overflow-y: auto;
}

.emoji-item {
    font-size: 24px;
    text-align: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 10px;
    transition: 0.2s;
    background: rgba(255,255,255,0.03); /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù„ÙƒÙ„ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
}

.emoji-item:active {
    background: rgba(255,255,255,0.15);
    transform: scale(0.9);
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
.emoji-category-title {
    grid-column: 1 / -1; /* ÙŠØ§Ø®Ø¯ Ø§Ù„ØµÙ ÙƒÙ„Ù‡ */
    font-size: 12px;
    color: #00e5ff;
    font-weight: bold;
    margin-top: 15px;
    margin-bottom: 8px;
    padding-right: 5px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
/* ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ØµÙ‚ Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙ†Ø§Ø³Ù‚Ø§Ù‹ */
.msg-bubble.sticker-bubble {
    font-size: 8px !important; /* ØªØµØºÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ù…Ù† 80 Ø¥Ù„Ù‰ 55 Ù„ÙŠÙƒÙˆÙ† Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ */
    line-height: 1.1; /* Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„ÙØ±Ø§ØºØ§Øª */
    display: inline-block !important; /* ØªØºÙŠÙŠØ± Ù…Ù† block Ø¥Ù„Ù‰ inline-block Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
    text-align: center;
    filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2)); /* ØªØ®ÙÙŠÙ Ø§Ù„Ø¸Ù„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    margin: 0 !important;
    padding: 5px !important;
    width: auto !important;
    height: auto !important;
}

/* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© Ø­ÙˆÙ„ Ø§Ù„Ù…Ù„ØµÙ‚ */
.msg-bubble.transparent-bubble {
    margin-bottom: 2px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    padding: 0 !important;
    box-shadow: none !important;
    background: transparent !important;
}
.sticker-content {
    display: inline-block;
    font-size: 60px; /* Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ù…Ù„ØµÙ‚Ø§Øª */
    line-height: 1;
    transform-origin: center;
    transition: transform 0.2s;
}
.sticker-content:active {
    transform: scale(0.9); /* ØªØ£Ø«ÙŠØ± Ø¶ØºØ·Ø© Ø¬Ù…ÙŠÙ„ */
}



/* =================== Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´ÙØ§ÙØ© (ØªØµØ­ÙŠØ­) =================== */

/* 1. Ø¥Ø®ÙØ§Ø¡ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ù‡Ø§ */
.msg-bubble.media-bubble {
    background: transparent !important; /* Ø´ÙØ§Ù */
    border: none !important;            /* Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯ */
    box-shadow: none !important;        /* Ø¨Ø¯ÙˆÙ† Ø¸Ù„ */
    padding: 0 !important;              /* Ø¨Ø¯ÙˆÙ† Ø­ÙˆØ§Ù Ø¯Ø§Ø®Ù„ÙŠØ© */
    width: auto !important;             /* Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØµÙˆØ±Ø© */
    max-width: 100% !important;
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„Ù‡Ø§ */
.msg-bubble.media-bubble .media-container {
    margin-top: 0 !important;
    background: transparent !important; /* Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
    border-radius: 18px !important;     /* ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø²ÙˆØ§ÙŠØ§ */
    border: 1px solid rgba(255, 255, 255, 0.15) !important; /* Ø¨Ø±ÙˆØ§Ø² Ø±ÙÙŠØ¹ Ø¬Ø¯Ø§Ù‹ */
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.msg-bubble.media-bubble video {
    border-radius: 18px !important;
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */
.msg-bubble.media-bubble .msg-meta-row {
    background: rgba(0, 0, 0, 0.4); /* Ø®Ù„ÙÙŠØ© ØµØºÙŠØ±Ø© Ù„Ù„ÙˆÙ‚Øª Ø¹Ø´Ø§Ù† ÙŠØ¨Ø§Ù† */
    padding: 2px 8px;
    border-radius: 10px;
    position: absolute; 
    bottom: 10px; 
    right: 10px;
    margin: 0 !important;
    backdrop-filter: blur(2px);
}
/* =================== (1) Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø¨Ø¯ÙˆÙ† Ø­ÙˆØ§Ù) =================== */

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù…Ø§ ØªÙƒÙˆÙ† ØµÙˆØ±Ø© */
.msg-bubble.media-bubble {
    padding: 0 !important;              /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹ */
    background: transparent !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡/Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© */
    border: none !important;            /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© */
    box-shadow: none !important;        /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¸Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
    width: fit-content !important;
    max-width: 80% !important;          /* Ù†Ø¯ÙŠÙ‡Ø§ Ù…Ø³Ø§Ø­Ø© Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠØ© */
    overflow: visible !important;       /* Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ÙˆØ§Ù„ÙˆÙ‚Øª ÙŠØ¸Ù‡Ø±Ùˆ */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ */
.msg-bubble.media-bubble .media-container {
    margin: 0 !important;
    border-radius: 18px !important;     /* ØªØ¯ÙˆÙŠØ± Ø­ÙˆØ§Ù Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ */
    border: 1px solid rgba(255, 255, 255, 0.15); /* Ø¨Ø±ÙˆØ§Ø² Ø±ÙÙŠØ¹ Ø¬Ø¯Ø§Ù‹ */
    overflow: hidden;
    /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ Ø¹Ø´Ø§Ù† ØªØ¨Ø±Ø² */
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
}

/* Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
.msg-bubble.media-bubble img, 
.msg-bubble.media-bubble video {
    display: block; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ØºØ±ÙŠØ¨Ø© */
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© */
.msg-bubble.media-bubble .msg-meta-row {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(0, 0, 0, 0.5); /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ø´ÙØ§ÙØ© Ù„Ù„ÙˆÙ‚Øª */
    padding: 2px 8px;
    border-radius: 12px;
    backdrop-filter: blur(2px);
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ø·Ù„Ø´ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© */
}
/* =================== (2) Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø¨Ø¯ÙˆÙ† Ø­ÙˆØ§Ù) =================== */

/* 1. Ø¬Ø¹Ù„ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø´ÙØ§ÙØ© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„Ø±ÙŠÙƒÙˆØ±Ø¯ */
.msg-bubble.audio-bubble {
    background: transparent !important;
    padding: 0 !important;
    box-shadow: none !important;
    border: none !important;
    overflow: visible !important;
    width: fit-content !important;
    margin-bottom: 5px;
}

/* 2. ØªØµÙ…ÙŠÙ… Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª Ù†ÙØ³Ù‡ (Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©) */
.msg-bubble.audio-bubble .custom-audio-player {
    width: 260px !important;       /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù…Ù†Ø§Ø³Ø¨ */
    height: 60px !important;       /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø§Ø³Ø¨ */
    border-radius: 20px !important; /* Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© Ù†Ø§Ø¹Ù…Ø© */
    padding: 10px 15px !important;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative; /* Ø¹Ø´Ø§Ù† Ø§Ù„ÙˆÙ‚Øª */
    transition: transform 0.2s;
}

/* 3. Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø´ØºÙ„ (Ù„Ù„Ù…Ø±Ø³Ù„ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) */

/* -- (Ø£) Ø§Ù„Ù…Ø±Ø³Ù„ (Ø£Ù†Ø§) - ØªØ¯Ø±Ø¬ Ø£Ø²Ø±Ù‚/Ø³Ù…Ø§ÙˆÙŠ -- */
.sender .msg-bubble.audio-bubble .custom-audio-player {
    background: linear-gradient(135deg, #0066cc, #00c6ff); /* Ù†ÙØ³ Ù„ÙˆÙ† Ø±Ø³Ø§ÙŠÙ„Ùƒ */
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 15px rgba(0, 198, 255, 0.2);
}

/* -- (Ø¨) Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Ù‡Ùˆ) - Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ø²Ø¬Ø§Ø¬ÙŠ -- */
.receiver .msg-bubble.audio-bubble .custom-audio-player {
    background: #202c33; /* Ù„ÙˆÙ† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ØºØ§Ù…Ù‚ */
    border: 1px solid rgba(255,255,255,0.05);
}

/* 4. ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯ */
.msg-bubble.audio-bubble .play-btn {
    width: 40px !important; 
    height: 40px !important;
    background: rgba(255,255,255,0.2) !important; /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ø²Ø± */
    box-shadow: none !important;
}

/* 5. Ø¶Ø¨Ø· Ù…ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª ÙˆØ¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯ */
.msg-bubble.audio-bubble .msg-meta-row {
    position: absolute;
    bottom: 4px;
    right: 15px; /* ÙŠÙ…ÙŠÙ† Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠ */
    font-size: 9px !important;
    opacity: 0.8;
    color: #fff !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª (Slider) */
.msg-bubble.audio-bubble .audio-slider {
    accent-color: #fff !important; /* Ù„ÙˆÙ† Ø§Ù„Ù…Ø¤Ø´Ø± Ø£Ø¨ÙŠØ¶ */
    height: 3px;
}

/* ================= ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (WhatsApp Style) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© */
.attachment-menu {
    position: fixed;
    bottom: 80px; /* ÙÙˆÙ‚ Ø§Ù„ÙÙˆØªØ± Ù…Ø¨Ø§Ø´Ø±Ø© */
    left: 10px;
    right: 10px;
    background: #1e293b; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© (ØºØ§Ù…Ù‚) */
    border-radius: 25px; /* Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© Ù†Ø§Ø¹Ù…Ø© */
    padding: 25px 15px;
    
    /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙˆØ§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ */
    transform: translateY(150%); /* Ù…Ø®ÙÙŠØ© ØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Ø­Ø±ÙƒØ© Ù†Ø·Ø§Ø·Ø© Ø®ÙÙŠÙØ© */
    
    z-index: 90; /* ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
}

/* ÙƒÙ„Ø§Ø³ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ù„Ù…Ø§ Ù†Ø¶ØºØ· Ø¹Ø§Ù„Ø²Ø±Ø§Ø±) */
.attachment-menu.active {
    transform: translateY(0); /* ØªØ·Ù„Ø¹ Ù„Ù…ÙƒØ§Ù†Ù‡Ø§ */
    opacity: 1;
    visibility: visible;
}

/* 2. Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
.attachment-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 Ø£Ø¹Ù…Ø¯Ø© */
    gap: 20px; /* Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
    justify-items: center;
}

/* 3. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙˆØ§Ø­Ø¯ */
.att-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}

.att-item:active {
    transform: scale(0.9); /* ØªØµØºÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
}

/* 4. Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
.att-icon-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* 5. Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (Ù†ÙØ³ ÙˆØ§ØªØ³Ø§Ø¨) */
.bg-doc { background: linear-gradient(135deg, #7f66ff, #5f46e4); } /* Ù…Ø³ØªÙ†Ø¯ (Ø¨ÙØ³Ø¬ÙŠ) */
.bg-camera { background: linear-gradient(135deg, #ff4081, #f50057); } /* ÙƒØ§Ù…ÙŠØ±Ø§ (ÙˆØ±Ø¯ÙŠ) */
.bg-gallery { background: linear-gradient(135deg, #c084fc, #a855f7); } /* Ù…Ø¹Ø±Ø¶ (Ù…ÙˆÙ ÙØ§ØªØ­) */
.bg-audio { background: linear-gradient(135deg, #f97316, #ea580c); } /* ØµÙˆØª (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) */
.bg-loc { background: linear-gradient(135deg, #22c55e, #16a34a); } /* Ù…ÙˆÙ‚Ø¹ (Ø£Ø®Ø¶Ø±) */
.bg-contact { background: linear-gradient(135deg, #3b82f6, #2563eb); } /* Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ (Ø£Ø²Ø±Ù‚) */
.bg-poll { background: linear-gradient(135deg, #06b6d4, #0891b2); } /* Ø§Ø³ØªØ·Ù„Ø§Ø¹ (ØªØ±ÙƒÙˆØ§Ø²) */
.bg-event { background: linear-gradient(135deg, #eab308, #ca8a04); } /* Ù…Ù†Ø§Ø³Ø¨Ø© (Ø£ØµÙØ±) */
.bg-ai { background: linear-gradient(135deg, #14b8a6, #0d9488); } /* Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ */

/* 6. Ø§Ù„Ù†Øµ ØªØ­Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.att-label {
    font-size: 12px;
    color: #cbd5e1;
    font-weight: 500;
}


/* --- ÙƒØ§Ø±Øª Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ (Poll) --- */
.msg-poll-card {
    background: rgba(255,255,255,0.03);
    padding: 15px; border-radius: 12px;
    min-width: 250px;
}
.poll-question {
    font-weight: bold; color: #fff; margin-bottom: 12px; font-size: 15px;
}
.poll-option {
    background: rgba(255,255,255,0.08);
    padding: 10px; border-radius: 8px;
    margin-bottom: 8px; cursor: pointer;
    display: flex; justify-content: space-between;
    transition: 0.2s; border: 1px solid rgba(255,255,255,0.05);
}
.poll-option:hover { background: rgba(255,255,255,0.15); }
.poll-text { font-size: 13px; color: #e2e8f0; }
.poll-count { font-size: 11px; color: #94a3b8; }
/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª */
#docViewerModal .mg-body {
    height: calc(100% - 60px); /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ù†Ø§Ù‚Øµ Ø§Ù„Ù‡ÙŠØ¯Ø± */
    width: 100%;
}

#docIframe {
    background: #fff; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙŠØ¨Ø§Ù† */
}

/* ================= ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ================= */
.msg-contact-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(30, 41, 59, 0.95); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
    padding: 12px 15px;
    border-radius: 16px;
    min-width: 220px;
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: 0.2s;
    position: relative;
    overflow: hidden;
}

.msg-contact-card:active {
    transform: scale(0.98);
    background: rgba(255, 255, 255, 0.1);
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù„ÙˆÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
.msg-contact-card::before {
    content: '';
    position: absolute;
    right: 0; top: 0; bottom: 0;
    width: 4px;
    background: #00e5ff; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ² Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ */
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ø®Øµ */
.contact-icon-box {
    width: 45px; height: 45px;
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff;
    font-size: 20px;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0, 229, 255, 0.3);
}

/* Ø§Ù„Ù†ØµÙˆØµ */
.contact-info-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.contact-name-text {
    color: #fff;
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 2px;
}

.contact-number-text {
    color: #94a3b8;
    font-size: 12px;
    font-family: monospace; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªØ¨Ø§Ù† ÙˆØ§Ø¶Ø­Ø© */
    letter-spacing: 0.5px;
}

/* Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ */
.contact-action-btn {
    color: #00e5ff;
    font-size: 18px;
    padding: 8px;
    border-radius: 50%;
    background: rgba(0, 229, 255, 0.1);
}
/* ================= Ø¥ØµÙ„Ø§Ø­ Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (Story Viewer Fix) ================= */
#simpleStoryViewer {
    position: fixed !important; /* ØªØ«Ø¨ÙŠØª Ø¥Ø¬Ø¨Ø§Ø±ÙŠ */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important; /* Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    height: 100vh !important; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    background: #000 !important; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ØªØºØ·ÙŠ ÙƒÙ„ Ø´ÙŠØ¡ */
    
    /* Ø±Ù‚Ù… Ø·Ø¨Ù‚Ø© Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± (100) ÙˆØ§Ù„ÙÙˆØªØ± (100) ÙˆØ£ÙŠ Ù†Ø§ÙØ°Ø© Ø£Ø®Ø±Ù‰ */
   
    
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    overflow: hidden; /* Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø£ÙŠ Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± */
    
    /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© */
    opacity: 1; 
    transform: none;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„ÙŠÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ø§Ù‹ Ø¨ÙˆØ¶ÙˆØ­ */
.close-story-btn {
    position: absolute !important;
    top: 30px !important; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
    right: 20px !important; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† (Ø¹Ø±Ø¨ÙŠ) */
    z-index: 2147483649 !important; /* ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµÙˆØ± */
    
    width: 40px; height: 40px;
    background: rgba(0, 0, 0, 0.5); /* Ø®Ù„ÙÙŠØ© Ù†ØµÙ Ø´ÙØ§ÙØ© */
    backdrop-filter: blur(5px);
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.3);
    
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
}

.close-story-btn i {
    color: #fff;
    font-size: 20px;
}

/* Ø¥ØµÙ„Ø§Ø­ Ù…ÙƒØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.story-content-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: relative;
    z-index: 1;
}

.story-media-element {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain; /* ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¯ÙˆÙ† Ù‚Øµ */
}

/* ================= Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ================= */

/* Ø§Ù„Ø·Ø¨Ù‚Ø© 1: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
.chat-body, .chat-header { z-index: 10; }

/* Ø§Ù„Ø·Ø¨Ù‚Ø© 2: Ø§Ù„ÙÙˆØªØ± ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
.chat-footer { z-index: 100; }
.context-menu-overlay { z-index: 2000; }

/* Ø§Ù„Ø·Ø¨Ù‚Ø© 3: Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø¨Ø±ÙˆÙØ§ÙŠÙ„ØŒ Ù‡Ø¯Ø§ÙŠØ§) */
.profile-page, #giftCenterModal { z-index: 3000 !important; }

/* Ø§Ù„Ø·Ø¨Ù‚Ø© 4: Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (ØµÙˆØ±ØŒ ÙÙŠØ¯ÙŠÙˆØŒ Ù‚ØµØµ) - ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ Ø´ÙŠØ¡ */
.media-gallery-overlay { z-index: 4000 !important; }

/* Ø§Ù„Ø·Ø¨Ù‚Ø© 5: Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø§Ù„Ù…Ù„Ùƒ) */
.pro-video-modal { 

    background: #000 !important;    /* Ø¶Ù…Ø§Ù† Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
}

/* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´ØºÙ„ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ */
.pro-video-element {
    z-index: 2147483648 !important; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø´ØºÙ„ */
    position: relative;
    max-height: 80vh;
}

/* Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.pro-controls {
    z-index: 2147483649 !important; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ */
}

/* ================= ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ ================= */
.popup-name-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø© */
    margin-bottom: 5px;
    flex-wrap: nowrap; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ */
.popup-verify {
    color: #00e5ff; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† (Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ) */
    font-size: 16px;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    filter: drop-shadow(0 0 5px rgba(0, 229, 255, 0.5)); /* ØªÙˆÙ‡Ø¬ Ø®ÙÙŠÙ */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
.popup-avatar {
    width: 110px; 
    height: 110px;
    border-radius: 50%;
    background-color: #0f1926;
    background-size: cover; 
    background-position: center;
    border: 4px solid #0f1926;
    display: flex; /* Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ³Ø· Ø§Ù„Ø­Ø±Ù Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© */
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: #fff;
}
/* ================= 1. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Digital Numbers) ================= */
.digital-number {
    font-family: 'Courier New', monospace; /* Ø®Ø· Ø±Ù‚Ù…ÙŠ */
    background: rgba(0, 229, 255, 0.1);    /* Ø®Ù„ÙÙŠØ© Ø³ÙŠØ§Ù† Ø´ÙØ§ÙØ© */
    color: #00e5ff;                        /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø³ÙŠØ§Ù† */
    padding: 2px 6px;
    border-radius: 6px;
    border: 1px solid rgba(0, 229, 255, 0.3);
    font-weight: bold;
    letter-spacing: 1px;
    display: inline-block;
    direction: ltr; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªØ¸Ù‡Ø± ØµØ­ */
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.1);
}

/* ================= 2. ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Pro Poll) ================= */
.poll-card-modern {
    background: linear-gradient(145deg, #1e293b, #0f172a); /* ØªØ¯Ø±Ø¬ ÙƒØ­Ù„ÙŠ ÙØ®Ù… */
    border-radius: 20px;
    padding: 15px;
    width: 280px; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª */
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    position: relative;
    overflow: hidden;
}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ */
.poll-question-modern {
    font-size: 16px;
    font-weight: 800;
    background: linear-gradient(90deg, #fff, #94a3b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 15px;
    text-align: right;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª */
.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„ÙˆØ§Ø­Ø¯ */
.poll-option-modern {
    position: relative;
    height: 45px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s ease;
}

.poll-option-modern:active {
    transform: scale(0.98);
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ (Ø§Ù„Ù…Ù„ÙˆÙ†) */
.poll-progress-bar {
    position: absolute;
    top: 0; right: 0; bottom: 0; /* ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„Ø¹Ø±Ø¨ÙŠ */
    width: 0%; /* Ø³ÙŠØªØºÙŠØ± Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª */
    background: linear-gradient(90deg, rgba(0, 229, 255, 0.2), rgba(41, 121, 255, 0.3));
    border-right: 3px solid #00e5ff; /* Ø®Ø· Ù…Ø¶ÙŠØ¡ ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© */
    transition: width 1s cubic-bezier(0.23, 1, 0.32, 1); /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù†Ø§Ø¹Ù… Ø¬Ø¯Ø§Ù‹ */
    z-index: 1;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®ÙŠØ§Ø± (Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù†Ø³Ø¨Ø©) */
.poll-option-content {
    position: relative;
    z-index: 2; /* ÙÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠØ· */
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 100%;
    padding: 0 15px;
    font-size: 13px;
    font-weight: 600;
    color: #e2e8f0;
}

/* Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© */
.poll-percent {
    font-size: 11px;
    color: #00e5ff;
    font-family: monospace;
    font-weight: bold;
    opacity: 0; /* Ù…Ø®ÙÙŠ Ù„Ø­Ø¯ Ù…Ø§ ÙŠØªÙ… Ø§Ù„ØªØµÙˆÙŠØª */
    transform: translateX(-10px);
    transition: all 0.5s ease;
}

/* Ø­Ø§Ù„Ø© "ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª" */
.poll-card-modern.voted .poll-percent {
    opacity: 1;
    transform: translateX(0);
}

/* Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø®ÙŠØ§Ø± (ØªØ®ØªÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙˆÙŠØª) */
.poll-radio {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
    margin-left: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}

.poll-option-modern.selected .poll-radio {
    border-color: #00e5ff;
    background: #00e5ff;
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
}

.poll-option-modern.selected .poll-progress-bar {
    background: linear-gradient(90deg, rgba(0, 229, 255, 0.4), rgba(41, 121, 255, 0.5));
}

/* Ø§Ù„ÙÙˆØªØ± (Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª) */
.poll-footer-modern {
    margin-top: 12px;
    font-size: 10px;
    color: #64748b;
    display: flex;
    justify-content: space-between;
    padding: 0 5px;
}

/* Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¯ÙŠÙƒØŒ ØªØ£ÙƒØ¯ ÙÙ‚Ø· Ù…Ù†Ù‡ */
.msg-bubble.transparent-bubble {
    background: transparent !important; /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
    border: none !important;            /* Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯ */
    box-shadow: none !important;        /* Ø¨Ø¯ÙˆÙ† Ø¸Ù„ */
    padding: 0 !important;              /* Ø¨Ø¯ÙˆÙ† Ø­ÙˆØ§Ù Ø¯Ø§Ø®Ù„ÙŠØ© */
    width: auto !important;             /* Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
}
/* ØªØµÙ…ÙŠÙ… Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
.view-profile-btn {
    margin-top: 18px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚Ù‡ */
    padding: 10px 28px;
    background: rgba(0, 229, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø²Ø±Ù‚Ø§Ø¡ Ø®ÙÙŠÙØ© */
    border: 1px solid rgba(0, 229, 255, 0.3); /* Ø­Ø¯ÙˆØ¯ Ù†ÙŠÙˆÙ† Ø®ÙÙŠÙØ© */
    border-radius: 50px; /* ØªØ¯ÙˆÙŠØ± ÙƒØ§Ù…Ù„ (Ø´ÙƒÙ„ ÙƒØ¨Ø³ÙˆÙ„Ø©) */
    color: #00e5ff;
    font-family: 'Cairo', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.05);
}

/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³ (Hover) */
.view-profile-btn:hover, .view-profile-btn:active {
    background: linear-gradient(135deg, #00e5ff, #2979ff); /* ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ */
    color: #fff; /* Ø§Ù„Ù†Øµ ÙŠØªØ­ÙˆÙ„ Ù„Ù„Ø£Ø¨ÙŠØ¶ */
    border-color: transparent;
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.4); /* ØªÙˆÙ‡Ø¬ Ù‚ÙˆÙŠ */
    transform: translateY(-2px); /* ÙŠØ±ØªÙØ¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
}

/* Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù‡Ù… */
.view-profile-btn .btn-arrow {
    transition: transform 0.3s ease;
}

/* Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ Ø§Ù„Ø³Ù‡Ù… ÙŠØªØ­Ø±Ùƒ Ù„Ù„ÙŠØ³Ø§Ø± */
.view-profile-btn:hover .btn-arrow, .view-profile-btn:active .btn-arrow {
    transform: translateX(-5px); 
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· (Click) */
.view-profile-btn:active {
    transform: scale(0.95); /* ØªØµØºÙŠØ± Ù„Ø­Ø¸ÙŠ */
}

#privacySettingsPage {
    z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø·Ø¨Ù‚Ø© Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
    background-color: #0b1121 !important; /* Ø®Ù„ÙÙŠØ© Ù…Ø¹ØªÙ…Ø© Ø¹Ø´Ø§Ù† ØªØºØ·ÙŠ Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡Ø§ */
}

:root {
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª --- */
    --z-background: 0;       /* Ø§Ù„Ø®Ù„ÙÙŠØ© */
    --z-content: 10;         /* Ø¬Ø³Ù… Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: Ø§Ù„Ø«ÙˆØ§Ø¨Øª --- */
    --z-header: 100;         /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
    --z-floating: 200;       /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (Ø²Ø± Ø§Ù„Ù†Ø²ÙˆÙ„) */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3: Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© --- */
    --z-dropdown: 500;       /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§ØªØŒ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    --z-context: 600;        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ (Context Menu) */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4: Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Full Pages) --- */
    --z-modal-base: 1000;    /* Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ØŒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ØŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    --z-modal-top: 1100;     /* Ù†Ø§ÙØ°Ø© ÙÙˆÙ‚ Ù†Ø§ÙØ°Ø© (Ù…Ø«Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ù‚Ø¨ ÙÙˆÙ‚ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„) */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5: Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Media) --- */
    --z-gallery: 2000;       /* Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± */
    --z-story: 2500;         /* Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù‚ØµØµ */
    --z-lightbox: 2600;      /* ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 6: Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ø·ÙˆØ§Ø±Ø¦ --- */
    --z-alert: 3000;         /* Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø­Ø°ÙØŒ Ø­Ø¸Ø±) */
    --z-toast: 3500;         /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµØºÙŠØ±Ø© (Toasts) */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 7: Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Ø§Ù„Ù…Ù„Ùƒ) --- */
    --z-call-overlay: 4000;  /* Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© */
    --z-call-controls: 4001; /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© */
    
    /* --- Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 8: Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„) --- */
    --z-pro-player: 5000;    
}
/* 1. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
.chat-body { z-index: var(--z-content); }
.chat-header, .chat-footer { z-index: var(--z-header); }
.scroll-bottom-btn { z-index: var(--z-floating); }

/* 2. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
.attachment-menu, .emoji-picker-panel { z-index: var(--z-dropdown); }
.context-menu-overlay { z-index: var(--z-context); }

/* 3. Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ØŒ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ØŒ Ø§Ù„Ø¨Ø­Ø«) */
.profile-page, 
#giftCenterModal, 
#fullSearchOverlay, 
#nicknamesPage { 
    z-index: var(--z-modal-base) !important; 
}

/* 4. Ù†ÙˆØ§ÙØ° ÙÙˆÙ‚ Ø§Ù„Ù†ÙˆØ§ÙØ° (ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ù‚Ø¨ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) */
#userPopupOverlay, 
#nicknameModal, 
#contactModal, 
#pollModal { 
    z-index: var(--z-modal-top) !important; 
}

/* 5. Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù‚ØµØµ) */
.media-gallery-overlay { z-index: var(--z-gallery) !important; }
#simpleStoryViewer { z-index: var(--z-story) !important; }
.lightbox { z-index: var(--z-lightbox) !important; }

/* 6. Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„ØµÙˆØ±) */
.confirm-modal-overlay, /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ */
#uploadConfirmModal,
#deleteModal,
#customBlockModal { 
    z-index: var(--z-alert) !important; 
}

#toast { z-index: var(--z-toast) !important; }

/* 7. Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Ù„Ø§Ø²Ù… ØªØºØ·ÙŠ ÙƒÙ„ Ø­Ø§Ø¬Ø© Ù…Ø§ Ø¹Ø¯Ø§ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ¨ÙŠØ±) */
.call-overlay { z-index: var(--z-call-overlay) !important; }
.call-controls-section, #incomingCallControls { z-index: var(--z-call-controls) !important; }

/* 8. Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø£Ø¹Ù„Ù‰ Ø­Ø§Ø¬Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚) */
.pro-video-modal { z-index: var(--z-pro-player) !important; }


/* ================= 1. ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…ØµØºØ± (Inline Video) ================= */
.video-msg-wrapper {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    background: #000;
    width: 260px;
    aspect-ratio: 4 / 5;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†ÙØ³Ù‡ */
.video-main-content {
    width: 100%; height: 100%; object-fit: contain; z-index: 2;
}

/* Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-overlay {
    position: absolute; inset: 0; z-index: 5;
    background: rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.2s ease;
}

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ */
.center-play-btn {
    width: 50px; height: 50px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 20px;
    cursor: pointer; transition: 0.2s;
}
.center-play-btn:active { transform: scale(0.9); background: var(--accent-color); }

/* Ø²Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± (Expand) */
.expand-icon {
    position: absolute; bottom: 10px; right: 10px;
    width: 35px; height: 35px;
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 16px; cursor: pointer;
    z-index: 10;
}
.expand-icon:active { transform: scale(0.9); border-color: var(--accent-color); color: var(--accent-color); }


/* ================= 2. Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Full Screen Pro Player) ================= */

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡) */
.pro-video-modal {
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    position: fixed; inset: 0;
    background: #000;
    
    /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    z-index: var(--z-pro-player) !important;
    
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    padding-bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„ÙƒÙ†ØªØ±ÙˆÙ„ */
}

/* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ¨ÙŠØ± */
.pro-video-element {
    width: 100%; 
    height: auto; 
    max-height: 80vh; /* Ø¹Ø´Ø§Ù† ÙŠØ³ÙŠØ¨ Ù…Ø³Ø§ÙØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª */
    object-fit: contain;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
}

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (X) */
.pro-close-btn {
    position: absolute; top: 30px; right: 20px;
    width: 40px; height: 40px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 10; color: #fff; font-size: 20px;
    
}

/* ================= 3. Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… (Controls Bar) ================= */
.pro-controls {
    position: absolute; 
    bottom: 30px; 
    width: 90%; max-width: 600px;
    background: rgba(25, 25, 25, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 15px 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
    
    display: flex; flex-direction: column; gap: 10px;
    direction: ltr; /* Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ø´Ø±ÙŠØ· ÙˆØ§Ù„ÙˆÙ‚Øª ÙŠØ¸Ù‡Ø±ÙˆØ§ ØµØ­ */
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±ÙŠØ· (Ø§Ù„Ø³Ø­Ø¨) */
.pro-progress-area {
    width: 100%; height: 20px;
    display: flex; align-items: center;
    cursor: pointer; position: relative;
}

/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ */
.pro-progress-bg {
    width: 100%; height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px; position: relative;
}

/* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù„ÙˆÙ† (Ø§Ù„ØªÙ‚Ø¯Ù…) */
.pro-progress-fill {
    height: 100%; width: 0%;
    background: var(--accent-color);
    border-radius: 10px;
    position: absolute; top: 0; left: 0;
    box-shadow: 0 0 10px var(--accent-color);
}

/* Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (Ø§Ù„Ù…Ù‚Ø¨Ø¶) */
.pro-progress-knob {
    position: absolute; top: 50%; left: 0%;
    width: 14px; height: 14px;
    background: #fff; border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    pointer-events: none; transition: left 0.1s linear;
}

/* Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª */
.pro-time-centered {
    width: 100%; text-align: center;
    font-family: monospace; font-size: 13px; font-weight: bold;
    color: #e2e8f0; margin-bottom: 5px;
}

/* ØµÙ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.pro-buttons-row {
    display: flex; justify-content: space-between; align-items: center; width: 100%;
}

.btn-group { display: flex; gap: 15px; }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØµØºÙŠØ±Ø© */
.pro-btn {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff; border: 1px solid rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer; transition: 0.2s;
}
.pro-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ± */
.play-btn-large {
    width: 55px; height: 55px;
    border-radius: 50%;
    background: var(--accent-color);
    color: #000; font-size: 22px;
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.4);
    border: none; display: flex; align-items: center; justify-content: center;
    margin-top: -10px; /* Ø±ÙØ¹Ø© Ø¬Ù…Ø§Ù„ÙŠØ© */
}
.play-btn-large:active { transform: scale(0.95); box-shadow: 0 0 10px var(--accent-color); }
/* ================= ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================= */
.location-msg-card {
    width: 260px;
    height: 160px;
    border-radius: 18px;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.1);
    background: #242f3e; /* Ù„ÙˆÙ† Ø®Ø±ÙŠØ·Ø© Ø¬ÙˆØ¬Ù„ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
}

/* ØµÙˆØ±Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© (ØµÙˆØ±Ø© Ø«Ø§Ø¨ØªØ© Ø¹Ø§Ù…Ø© Ø£Ùˆ Ù†Ù…Ø·) */
.location-bg-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.7); /* ØªØºÙ…ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯Ø¨ÙˆØ³ ÙŠØ¨Ø§Ù† */
    transition: transform 0.3s ease;
}

.location-msg-card:hover .location-bg-image {
    transform: scale(1.1); /* Ø²ÙˆÙˆÙ… Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ */
}

/* Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø§Ù„Ù…ØªØ­Ø±Ùƒ (Pin) */
.map-pin-container {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    display: flex; flex-direction: column; align-items: center;
    z-index: 2;
}

.map-pin-icon {
    font-size: 35px;
    color: #ff3b30; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± */
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
    animation: pinBounce 1.5s infinite;
}

/* Ù†Ù‚Ø·Ø© ØªØ­Øª Ø§Ù„Ø¯Ø¨ÙˆØ³ */
.map-pin-shadow {
    width: 12px; height: 4px;
    background: rgba(0,0,0,0.6);
    border-radius: 50%;
    margin-top: -5px;
    animation: shadowScale 1.5s infinite;
}

/* Ø§Ù„ÙÙˆØªØ± (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†) */
.location-footer {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: rgba(20, 30, 45, 0.9);
    backdrop-filter: blur(5px);
    padding: 10px;
    display: flex; align-items: center; gap: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.loc-icon-box {
    width: 35px; height: 35px;
    background: rgba(0, 229, 255, 0.15);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #00e5ff;
}

.loc-text-info {
    display: flex; flex-direction: column;
}

.loc-title { font-size: 13px; font-weight: bold; color: #fff; }
.loc-sub { font-size: 10px; color: #94a3b8; }

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¯Ø¨ÙˆØ³ */
@keyframes pinBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
@keyframes shadowScale {
    0%, 100% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(0.5); opacity: 0.3; }
}
/* ================= ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Profile Card) ================= */
.profile-share-card {
    background: #1e293b; /* Ø®Ù„ÙÙŠØ© ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ */
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 15px;
    width: 240px; /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ */
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-top: 5px;
}

/* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ (ØµÙˆØ±Ø© ÙˆØ§Ø³Ù…) */
.psc-header {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 12px;
}

.psc-avatar {
    width: 50px; height: 50px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 2px solid #00e5ff; /* Ø¥Ø·Ø§Ø± Ø³ÙŠØ§Ù† */
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
}

.psc-info {
    flex: 1;
    display: flex; flex-direction: column;
    overflow: hidden;
}

.psc-name {
    color: #fff;
    font-weight: bold;
    font-size: 14px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.psc-subtitle {
    color: #94a3b8;
    font-size: 11px;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.psc-actions {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 8px;
}

.psc-btn {
    width: 100%;
    padding: 8px 0;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 12px;
    display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: 0.2s;
    font-family: 'Cairo', sans-serif;
}

/* Ø²Ø± Ø§Ù„Ø¹Ø±Ø¶ (Ø´ÙØ§Ù) */
.psc-btn-primary {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.1);
}
.psc-btn-primary:hover { background: rgba(255,255,255,0.15); }

/* Ø²Ø± Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© (Ù…Ù„ÙˆÙ†) */
.psc-btn-secondary {
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    color: #fff;
    box-shadow: 0 4px 10px rgba(0, 100, 255, 0.3);
}
.psc-btn-secondary:active { transform: scale(0.98); }


/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================= */
.story-reply-pro-container {
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.4); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ù„Ù„ØªØ¨Ø§ÙŠÙ† */
    border-radius: 18px;
    overflow: hidden;
    margin-bottom: 4px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    min-width: 200px;
    max-width: 260px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚ØµØ©) */
.story-reply-preview {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.08); /* Ù„ÙˆÙ† Ø£ÙØªØ­ Ø´ÙˆÙŠØ© Ù„Ù„Ù…Ø¹ÙŠÙ†Ø© */
    padding: 8px 12px;
    gap: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„ØµØºÙŠØ± */
.story-reply-media-box {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    overflow: hidden;
    background: #000;
    flex-shrink: 0;
    border: 1px solid rgba(0, 229, 255, 0.4); /* Ø¥Ø·Ø§Ø± Ù†ÙŠÙˆÙ† Ø®ÙÙŠÙ */
    position: relative;
}

.story-reply-media-box img, 
.story-reply-media-box video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆÙ‚ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØµØºÙŠØ± */
.video-play-hint {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.2);
    font-size: 14px;
    color: #fff;
}

.reply-info-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.reply-label-top {
    font-size: 11px;
    color: var(--accent-color); /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† Ø¨ØªØ§Ø¹Ùƒ */
    font-weight: 800;
}

.reply-sub-label {
    font-size: 10px;
    color: #94a3b8;
}

/* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³ÙÙ„ÙŠ (Ù†Øµ Ø§Ù„Ø±Ø¯) */
.story-reply-text-body {
    padding: 12px 15px;
    font-size: 14px;
    color: #fff;
    line-height: 1.5;
    word-break: break-word;
    background: transparent;
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠ - Ù…Ø¹Ø¯Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„ØªØ§Ù… */
#giftCenterModal {
    position: fixed !important;
    inset: 0 !important;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: none; /* Ù…Ø®ÙÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: flex-end;
    justify-content: center;
    z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© Ù…Ù…ÙƒÙ†Ø© */
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù…Ø§ ÙŠÙƒÙˆÙ† Ù†Ø´Ø· */
#giftCenterModal.active {
    display: flex !important; /* ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø´Ø§Ø· */
    opacity: 1;
}

/* ÙˆØ±Ù‚Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù†ÙØ³Ù‡Ø§ */
.gift-sheet {
    width: 100%;
    max-width: 500px;
    height: 70vh;
    background: #121212;
    border-radius: 25px 25px 0 0;
    transform: translateY(100%); /* ØªØ¨Ø¯Ø£ Ù…Ù† ØªØ­Øª Ø§Ù„Ø´Ø§Ø´Ø© */
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#giftCenterModal.active .gift-sheet {
    transform: translateY(0); /* ØªØ·Ù„Ø¹ Ù„ÙÙˆÙ‚ Ù„Ù…Ø§ Ù†ÙØªØ­ */
}

/* Ø¹Ø¯Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¯Ù‡ Ø¹Ù†Ø¯Ùƒ */
.gift-content-panel.active {
    display: grid !important; /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¸Ù‡ÙˆØ± ÙƒÙ€ Grid */
    min-height: 200px; /* Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø±Ø³Ù… */
    width: 100%;
}

.gift-grid, .stickers-grid {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    padding: 10px;
    /* Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø¨ÙŠØ­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙˆÙŠØ¨ ÙÙŠÙˆ ÙÙŠ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    grid-auto-rows: min-content; 
}

/* Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø¯Ø© */
.pro-video-modal {
    position: fixed !important;
    inset: 0 !important;
    background: #000 !important;
    z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ÙƒÙˆÙƒØ¨ */
    display: none; /* Ø¨ÙŠØªØ­ÙˆÙ„ Ù„Ù€ flex Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª */
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.pro-video-element {
    width: 100%;
    max-height: 80vh;
    object-fit: contain;
}

/* ================= ÙƒØ§Ø±Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ================= */
.chat-end-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px 20px;
    margin: 20px auto;
    width: 90%;
    max-width: 300px;
    background: rgba(15, 25, 38, 0.4);
    border-radius: 25px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    text-align: center;
}

.cec-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 3px solid var(--accent-color);
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
    margin-bottom: 15px;
}

.cec-name {
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.cec-sub {
    font-size: 12px;
    color: #94a3b8;
    margin-bottom: 20px;
}

.cec-btn {
    padding: 10px 25px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: #fff;
    font-family: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
}

.cec-btn:active {
    transform: scale(0.95);
    background: var(--accent-gradient);
    border-color: transparent;
}

    </style>
</head>
<body>

   <div class="lightbox" id="lightbox" style="display:none;">
    <div onclick="closeLightbox()" class="lb-close">&times;</div>
    
    <div class="lb-nav prev" onclick="changeGalleryImage(-1)">
        <i class="fa-solid fa-chevron-right"></i>
    </div>

    <img id="lb-img" src="" class="lb-image">

    <div class="lb-nav next" onclick="changeGalleryImage(1)">
        <i class="fa-solid fa-chevron-left"></i>
    </div>
    
    <div id="lb-counter" class="lb-counter">1 / 5</div>
</div>

    
    <div id="toast" style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 6000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <i class="fa-solid fa-check-circle"></i> <span id="toast-msg">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­</span>
    </div>

    <div class="context-menu-overlay" id="contextMenuOverlay" onclick="closeContextMenu()">
        <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
            <div class="reactions-row" style="display: flex; justify-content: space-between; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 50px;">
                <span class="reaction-emoji" onclick="toggleReaction('â¤ï¸')">â¤ï¸</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜‚')">ğŸ˜‚</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜®')">ğŸ˜®</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜¢')">ğŸ˜¢</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜¡')">ğŸ˜¡</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ‘')">ğŸ‘</span>
            </div>
            <div class="menu-options">
                <button class="menu-btn" id="menuListenBtn" style="display:none" onclick="playMessageAudio()">
                    <i class="fa-solid fa-headphones" style="color:#00e5ff"></i> Ø§Ø³ØªÙ…Ø§Ø¹
                </button>
                <button class="menu-btn" onclick="activateReplyMode()"><i class="fa-solid fa-reply" style="color:#00e5ff"></i> Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button class="menu-btn" id="menuDeleteAllBtn" style="display:none" onclick="deleteMessageForEveryone()"><i class="fa-solid fa-trash-can" style="color:#ff3b30"></i> Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
                <button class="menu-btn" id="menuSaveBtn" style="display:none" onclick="saveMedia()"><i class="fa-solid fa-download"></i> Ø­ÙØ¸</button>
                <button class="menu-btn" id="menuCopyBtn" style="display:none" onclick="copyText()"><i class="fa-solid fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
                <button class="menu-btn" onclick="deleteMessageLocal()"><i class="fa-solid fa-trash" style="color:#ff3b30"></i> Ø­Ø°Ù Ù…Ù† Ø¹Ù†Ø¯ÙŠ</button>
            </div>
        </div>
    </div>

 <div class="chat-header">
    
    <div class="header-right-section">
        <i class="fa-solid fa-arrow-right back-btn" onclick="history.back()"></i>
        
        <div class="user-avatar-container" onclick="openProfile()">
            <div id="headerImage" class="header-avatar"></div>
            <div class="online-status"></div>
        </div>
        
<div class="header-info" onclick="openProfile()" style="cursor: pointer;">

            <h3 id="headerNameWrapper">
                <span id="headerName">Ù…Ø³ØªØ®Ø¯Ù… Wareed </span>
                <span id="headerVerify"></span> <i id="headerMuteIcon" class="fa-solid fa-bell-slash" style="display:none; color:#8b5cf6; font-size:12px; margin-right:5px;"></i>
            </h3>
            <span id="headerStatus" class="status-text">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>
            <span id="typingIndicator" class="typing-text">ÙŠÙƒØªØ¨...</span>
        </div>
    </div>

    <div class="header-actions">
        <div class="icon-btn video" onclick="playUiSound('click'); initiateVideoCallUI()">
            <i class="fa-solid fa-video"></i>
        </div>
        <div class="icon-btn audio" onclick="playUiSound('click'); initiateCall()">
            <i class="fa-solid fa-phone"></i>
        </div>
    </div>
</div>


    </div>

   <div class="chat-body" id="chatContainer">
    
    <div id="loadingSkeleton" class="skeleton-row">
        <div class="skeleton-msg skeleton-right" style="width: 55%;"></div>
        
        <div class="skeleton-msg skeleton-left" style="width: 40%;"></div>
        
        <div class="skeleton-msg skeleton-right" style="width: 70%;"></div>
        
        <div class="skeleton-msg skeleton-left" style="width: 50%;"></div>
    </div>

</div>
<div id="attachmentMenu" class="attachment-menu">
    <div class="attachment-grid">
        
        <div class="att-item" onclick="handleAttachment('document')">
            <div class="att-icon-circle bg-doc"><i class="fa-solid fa-file-lines"></i></div>
            <span class="att-label">Ù…Ø³ØªÙ†Ø¯</span>
        </div>

        <div class="att-item" onclick="handleAttachment('camera')">
            <div class="att-icon-circle bg-camera"><i class="fa-solid fa-camera"></i></div>
            <span class="att-label">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
        </div>

        <div class="att-item" onclick="handleAttachment('gallery')">
            <div class="att-icon-circle bg-gallery"><i class="fa-regular fa-image"></i></div>
            <span class="att-label">Ø§Ù„Ù…Ø¹Ø±Ø¶</span>
        </div>

        <div class="att-item" onclick="handleAttachment('audio')">
            <div class="att-icon-circle bg-audio"><i class="fa-solid fa-headphones"></i></div>
            <span class="att-label">Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ</span>
        </div>

        <div class="att-item" onclick="handleAttachment('location')">
            <div class="att-icon-circle bg-loc"><i class="fa-solid fa-location-dot"></i></div>
            <span class="att-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
        </div>

        <div class="att-item" onclick="handleAttachment('contact')">
            <div class="att-icon-circle bg-contact"><i class="fa-solid fa-user"></i></div>
            <span class="att-label">Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„</span>
        </div>

        <div class="att-item" onclick="handleAttachment('poll')">
            <div class="att-icon-circle bg-poll"><i class="fa-solid fa-square-poll-vertical"></i></div>
            <span class="att-label">Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø±Ø£ÙŠ</span>
        </div>
        
        <div class="att-item" onclick="handleAttachment('event')">
            <div class="att-icon-circle bg-event"><i class="fa-regular fa-calendar-days"></i></div>
            <span class="att-label">Ù…Ù†Ø§Ø³Ø¨Ø©</span>
        </div>

        <div class="att-item" onclick="handleAttachment('ai')">
            <div class="att-icon-circle bg-ai"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
            <span class="att-label">ØµÙˆØ± AI</span>
        </div>

    </div>
</div>

<div class="chat-footer">
    
    <div class="reply-preview-bar" id="replyBar" style="display:none;">
        <div class="reply-content">
            <div class="reply-title" id="replyTitle">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰...</div>
            <div class="reply-text" id="replyText">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
        </div>
        <i class="fa-solid fa-times close-reply" onclick="cancelReply()"></i>
    </div>

    <div class="recording-ui" id="recordingUI">
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="rec-wave">
                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
            </div>
            <span id="recordTimer" style="color:#ff3b30; font-weight:bold; font-family:monospace;">00:00</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <span style="color:#94a3b8; cursor:pointer; font-size:12px;" onclick="cancelRecording()">Ø¥Ù„ØºØ§Ø¡</span>
            <div onclick="stopAndSendRecording()" class="action-btn" style="background:#ff3b30; color:#fff; border:none; box-shadow: 0 0 10px rgba(255,59,48,0.4);">
                <i class="fa-solid fa-paper-plane"></i>
            </div>
        </div>
    </div>

    <div class="footer-actions-left" id="leftActions">
    <div class="action-btn file-btn" onclick="playUiSound('click'); toggleAttachmentMenu()">
    <i class="fa-solid fa-paperclip"></i>
</div>

    <div class="action-btn media-btn" onclick="playUiSound('click'); document.getElementById('mediaInput').click()">
        <i class="fa-regular fa-image"></i>
    </div>
    
    <div class="action-btn gift-center-btn" onclick="openGiftCenter()">
        <i class="fa-solid fa-gift"></i>
        <div class="gift-badge">NEW</div>
    </div>

    <div class="action-btn destruct-btn" id="destructBtn" onclick="playUiSound('destruct'); toggleDestructMode()">
        <i class="fa-solid fa-bomb"></i>
        <span class="destruct-badge" id="destructBadge" style="display:none;">OFF</span>
    </div>
</div>

<div class="input-container">
    <i class="fa-regular fa-face-smile internal-emoji-btn" onclick="toggleInternalEmojiPicker()"></i>
    
    <textarea id="messageInput" class="chat-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." 
       oninput="autoResize(this); toggleSendButton(); detectMood(this.value)"></textarea>
</div>

<div id="emojiPickerPanel" class="emoji-picker-panel">
    <div class="emoji-grid" id="emojiGridContent"></div>
</div>


    <div class="footer-actions-right">
        <div class="action-btn mic-btn" id="micBtn" onclick="playUiSound('record'); startRecording()">
            <i class="fa-solid fa-microphone"></i>
        </div>
        
        <div class="action-btn send-btn" id="sendBtn" onclick="playUiSound('sent'); sendMessage()" style="display: none;">
            <i class="fa-solid fa-paper-plane"></i>
        </div>
    </div>

    <input type="file" id="mediaInput" hidden accept="image/*,video/*" onchange="uploadMedia(this, 'media')">
    <input type="file" id="fileInput" hidden accept="*/*" onchange="uploadMedia(this, 'file')">
</div>

<div id="callOverlay" class="call-overlay">
    
    <div id="videoContainer" class="video-container">
        <video id="remoteScreenVideo" autoplay playsinline class="remote-screen-video" style="display:none;"></video>
        <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
        <video id="localVideo" autoplay playsinline muted class="local-video"></video>
    </div>

    <div class="top-actions" style="position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; z-index:20;">
        <button onclick="togglePip()" class="floating-btn">
            <i class="fa-solid fa-compress"></i> 
        </button>
        
        <button onclick="takeSnapshot()" class="floating-btn">
            <i class="fa-solid fa-camera"></i>
        </button>
    </div>
    
    <div class="maximize-btn" onclick="togglePip()"></div>

    <div class="call-bg" id="callBg"></div>
    <div class="call-bg-pattern"></div> <div class="call-info-section" id="callInfoSection">
        <div class="call-avatar-wrapper" style="position:relative;">
            <div class="call-avatar" id="callAvatar"></div>
            <div id="remoteMuteIcon" style="position:absolute; bottom:0; right:0; background:#ff3b30; width:30px; height:30px; border-radius:50%; display:none; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                <i class="fa-solid fa-microphone-slash" style="color:#fff; font-size:14px;"></i>
            </div>
        </div>
        <h2 id="callName" class="call-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
        <h3 id="callStatusText" class="call-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
        <audio id="remoteAudio" autoplay></audio>
    </div>

    <div class="call-controls-section controls-dock" id="activeCallControls" style="display: none;">
       
        <button class="call-btn mute" onclick="toggleMute()" id="muteBtn">
            <i class="fa-solid fa-microphone"></i>
        </button>
        
        <button class="call-btn video" onclick="toggleVideoMode()" id="videoBtn">
            <i class="fa-solid fa-video-slash"></i>
        </button>
        
        <button class="call-btn screen-share" onclick="toggleScreenShare()" id="shareScreenBtn">
            <i class="fa-solid fa-desktop"></i>
        </button>

        <button class="call-btn switch-cam" onclick="switchCamera()" id="switchCamBtn" style="display:none;">
            <i class="fa-solid fa-camera-rotate"></i>
        </button>

        <button class="call-btn end" onclick="endCall()">
            <i class="fa-solid fa-phone-slash"></i>
        </button>
        
        <button class="call-btn speaker" onclick="toggleSpeaker()" id="speakerBtn">
            <i class="fa-solid fa-volume-high"></i>
        </button>

   </div>

   <div class="call-controls-section" id="incomingCallControls" style="display:none; gap: 60px; z-index: 20;">
        <button class="call-btn end" onclick="rejectCall()">
            <i class="fa-solid fa-phone-slash"></i>
        </button>
        <button class="call-btn accept" onclick="acceptIncomingCall()">
            <i class="fa-solid fa-phone"></i>
        </button>
    </div>

</div>





    <script>
        
        let editingTargetId = null;
let globalNicknames = {}; // Ù…Ø®Ø²Ù† Ù„Ù„Ø£Ù„Ù‚Ø§Ø¨ Ø¹Ø´Ø§Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙŠØ´ÙˆÙÙ‡Ø§

        let currentPopupUserId = null;
// ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¥Ù„Ø§ Ù„Ùˆ ÙÙŠÙ‡ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©
navigator.vibrate = (function(origVibrate) {
    return function(pattern) {
        const callOverlay = document.getElementById('callOverlay');
        const incomingControls = document.getElementById('incomingCallControls');
        
        // Ù„Ùˆ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¸Ø§Ù‡Ø±Ø© ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¯ (Incoming) Ù…Ø¹Ø±ÙˆØ¶Ø©.. Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø²Ù†
        if (callOverlay && callOverlay.style.display === 'flex' && 
            incomingControls && incomingControls.style.display !== 'none') {
            return origVibrate.apply(this, arguments);
        }
        
        // ÙÙŠ Ø£ÙŠ Ø­Ø§Ù„Ø© ØªØ§Ù†ÙŠØ© (Ø±Ø³Ø§ÙŠÙ„ØŒ ÙØªØ­ Ø´Ø§ØªØŒ Ø¶ØºØ· Ø²Ø±Ø§ÙŠØ±).. Ø§Ø±ÙØ¶ Ø§Ù„Ø²Ù†
        return false;
    };
})(navigator.vibrate);

         document.addEventListener("DOMContentLoaded", function() {
    
    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ØªØ·ÙÙˆ ÙÙˆÙ‚ Ø§Ù„Ø¬Ù…ÙŠØ¹
    const overlayIds = [
        'simpleStoryViewer', // ğŸ”¥ğŸ”¥ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±: Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ ğŸ”¥ğŸ”¥
        'profilePage', 
        'privacySettingsPage',
        'deleteModal', 
        'callOverlay', 
        'contextMenuOverlay', 
        'lightbox', 
        'previewModal',
        'mediaGalleryOverlay',
        'fullSearchOverlay',
        'customBlockModal',
        'uploadConfirmModal',
        'userPopupOverlay',
        'nicknameModal',
        'nicknameSelectModal',
        'nicknamesPage',
        'contactModal',
        'pollModal',
        'giftCenterModal',
        'proVideoModal'
    ];

    overlayIds.forEach(id => {
        const element = document.getElementById(id);
        // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ù„ÙŠÙƒÙˆÙ† Ø§Ø¨Ù† Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù€ body Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙÙˆÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ±
        if (element && element.parentNode !== document.body) {
            document.body.appendChild(element); 
        }
    });
});





    


const alertSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m3u8"); // Ù…Ø«Ø§Ù„ Ù„ØµÙˆØª Ø®Ø§Ø±Ø¬ÙŠ
// Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù…Ù„Ù MP3

// Ù…Ù„Ø­ÙˆØ¸Ø©: Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØª ÙŠØ´ØªØºÙ„ 100% ÙŠÙØ¶Ù„ ØªØ³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¯Ù‡ ÙƒØ¨Ø¯ÙŠÙ„ Ù„Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ù‚ØµÙŠØ±:
const backupSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
// ØªØ¹Ø±ÙŠÙ ØµÙˆØª Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªÙƒØ© Ù†Ø§Ø¹Ù…Ø© Ø²ÙŠ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
// Ø§Ø®ØªØ±ØªÙ„Ùƒ ØµÙˆØª "Pop" Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ ÙˆØ³Ø±ÙŠØ¹
// ================= ØµÙˆØª Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªÙƒØ© Ø³Ø±ÙŠØ¹Ø© Ø²ÙŠ Ù…Ø§Ø³Ù†Ø¬Ø±) =================
// Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ (CDN) Ù„Ø£Ù†Ù‡ Ø£Ø³Ø±Ø¹ Ø¨ÙƒØªÙŠØ± ÙˆÙ…Ø´ Ø¨ÙŠÙ‚Ø·Ø¹
const keyPressSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"); 
keyPressSound.volume = 0.3; // ØµÙˆØª Ù‡Ø§Ø¯ÙŠ (30%)

let lastKeySoundTime = 0;

function playKeySound() {
    // 1. Ù„Ùˆ Ø§Ù„ÙƒØªÙ… Ø´ØºØ§Ù„ØŒ Ø§Ø®Ø±Ø¬ ÙÙˆØ±Ø§Ù‹
    if (typeof isMuted !== 'undefined' && isMuted) return;

    const now = Date.now();
    
    // 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø³Ø±Ø¹Ø©: Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ÙƒÙ„ 80 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    // (Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙƒØªØ¨Øª Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„ØµØ§Ø±ÙˆØ® Ø§Ù„ØµÙˆØª Ù…ÙŠØ¨Ù‚Ø§Ø´ Ù…Ø²Ø¹Ø¬)
    if (now - lastKeySoundTime > 80) {
        
        // 3. CloneNode: Ø¯ÙŠ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØ®Ù„ÙŠ Ø§Ù„ØµÙˆØª ÙŠØ´ØªØºÙ„ ÙˆØ±Ø§ Ø¨Ø¹Ø¶Ù‡ Ù…Ù† ØºÙŠØ± Ù…Ø§ ÙŠØ³ØªÙ†Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙŠØ®Ù„Øµ
        const soundClone = keyPressSound.cloneNode(); 
        soundClone.volume = 0.2; // Ù†ÙˆØ·ÙŠÙ‡ Ø³Ù†Ø© ÙƒÙ…Ø§Ù† Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        
        // ØªØ´ØºÙŠÙ„ (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹Ù„Ù‚)
        soundClone.play().catch(() => {}); 
        
        lastKeySoundTime = now;
    }
}

const realClickSound = new Audio("data:audio/wav;base64,UklGRi5vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTZvT18AAAAAAAABAgMEBQYHCAkKCwwNDg8QERITFBUWFxgZGhscHR4fICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDRFVVV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w=="); 

// Ù…Ù„Ø­ÙˆØ¸Ø©: Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ø¯Ù‡ "ÙƒÙˆØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù‚ØµÙŠØ±" Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ù„ÙƒÙ† Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØª ÙŠØ¨Ù‚Ù‰ ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆÙ‚ÙˆÙŠ
// Ø£Ù†Ø§ Ø¹Ù…Ù„ØªÙ„Ùƒ Ø¯Ø§Ù„Ø© Ø¨ØªÙˆÙ„Ø¯ Ø§Ù„ØµÙˆØª Ø¨Ù†ÙØ³Ù‡Ø§ (Oscillator) Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† "ØªÙƒØ©" ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù…Ø­ØªØ±Ù…Ø© Ù…Ù† ØºÙŠØ± Ù…Ø§ Ø£Ø­Ø·Ù„Ùƒ ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ ÙŠØªÙ‚Ù„ Ø§Ù„ØµÙØ­Ø©.

// ================= 1. ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø± Ù†Ø§Ø¹Ù… ÙˆÙ‡Ø§Ø¯Ø¦ (Soft Bubble) =================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSoftBubble() {
    // Ù„Ùˆ Ø§Ù„ÙƒØªÙ… Ø´ØºØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ÙÙŠØ©ØŒ Ù†Ø®Ø±Ø¬
    if ((typeof isMuted !== 'undefined' && isMuted) || document.hidden) return;

    const t = audioCtx.currentTime;
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù†Ø§Ø¹Ù… (Sine Wave) - ØµÙˆØª Ø¯Ø§Ø¦Ø±ÙŠ Ù†Ø§Ø¹Ù… Ù…Ø´ Ø­Ø§Ø¯
    oscillator.type = 'sine';
    
    // ØªØ±Ø¯Ø¯ Ù‡Ø§Ø¯ÙŠ (Ù†ØºÙ…Ø© Ù…ØªÙˆØ³Ø·Ø©)
    oscillator.frequency.setValueAtTime(600, t);
    oscillator.frequency.exponentialRampToValueAtTime(300, t + 0.1); // ÙŠÙ†Ø²Ù„ Ø¨Ù†Ø¹ÙˆÙ…Ø©

    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ù„Ùˆ (Fade In/Out Ø³Ø±ÙŠØ¹)
    gainNode.gain.setValueAtTime(0, t);
    gainNode.gain.linearRampToValueAtTime(0.1, t + 0.02); // ÙŠØ¹Ù„Ù‰ Ù„Ù€ 10% Ø¨Ø³ (ÙˆØ§Ø·ÙŠ Ø¬Ø¯Ø§Ù‹)
    gainNode.gain.linearRampToValueAtTime(0, t + 0.15);   // ÙŠØ®ØªÙÙŠ ØªØ§Ù†ÙŠ

    oscillator.start(t);
    oscillator.stop(t + 0.2);
}

// Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±
let remoteTypingInterval = null;

function manageRemoteTypingSound(isTyping) {
    if (typeof isMuted !== 'undefined' && isMuted) {
        clearInterval(remoteTypingInterval);
        remoteTypingInterval = null;
        return;
    }

    if (isTyping) {
        if (!remoteTypingInterval) {
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙˆØ±Ø§Ù‹
            playSoftBubble();
            
            // Ø«Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙƒÙ„ 4 Ø«ÙˆØ§Ù†ÙŠ
            remoteTypingInterval = setInterval(() => {
                playSoftBubble();
            }, 4000); // 4000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = 4 Ø«ÙˆØ§Ù†ÙŠ
        }
    } else {
        clearInterval(remoteTypingInterval);
        remoteTypingInterval = null;
    }
}


// ================= 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ§Ù„Ø±Ø¨Ø· =================
function setupTypingListener() {
    db.collection("chats").doc(chatId).onSnapshot(doc => {
        if(!doc.exists) return;
        const data = doc.data();
        
        const typingArray = data.typing || [];
        
        // Ù‡Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¨ÙŠÙƒØªØ¨ØŸ
        const isSomeoneTyping = typingArray.some(uid => uid !== currentUserId);
        
        const st = document.getElementById('headerStatus');
        const tt = document.getElementById('typingIndicator');
        
        // ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        manageRemoteTypingSound(isSomeoneTyping);
        
        if(isSomeoneTyping) { 
            if(st) st.style.display = 'none'; 
            if(tt) {
                tt.style.display = 'block';
                tt.innerHTML = `
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>`;
            }
        } else {
            if(st) st.style.display = 'block';
            if(tt) {
                tt.style.display = 'none';
                tt.innerHTML = ''; 
            }
        }
    });
}


//
function playMessageSound() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø¯Ù…Ø¬
    let playPromise = backupSound.play();

    if (playPromise !== undefined) {
        playPromise.then(_ => {
            // Ø§Ù„ØµÙˆØª Ø§Ø´ØªØºÙ„ ØªÙ…Ø§Ù…
            console.log("Sound played successfully");
        })
        .catch(error => {
            // Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØµÙˆØªØŒ Ù†Ø´ØºÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙƒØ¨Ø¯ÙŠÙ„
            console.log("Sound blocked, vibrating instead");
            if (navigator.vibrate) navigator.vibrate([200, 50, 200]);
        });
    }
    
}

        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            databaseURL: "https://pools-e4381-default-rtdb.firebaseio.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f",
            measurementId: "G-EYPMCWES9N"
        };
        

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // 3. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        db.settings({ merge: true });


        const params = new URLSearchParams(location.search);
        const chatId = params.get("chatId");
        let activeTimers = []; // Ø¯Ù‡ Ù…Ø®Ø²Ù† Ø¹Ø´Ø§Ù† Ù†ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ØªÙ‚ÙØ´
// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„ÙƒØªÙ… ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ chatId

        let currentUserId = null, selectedMsgId = null, selectedMsgData = null;
        let currentReply = null, userCache = {}, isFirstLoad = true, typingTimeout = null, cachedOtherUserId = null; 
        let vibrationInterval = null; // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†ÙƒØ±Ø± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²
// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
let oldestDoc = null; 
let isLoadingOld = false;
let noAnswerTimeout = null; // Ù…ØªØºÙŠØ± Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯
    let cachedCameraTrack = null; // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¤Ù‚Øª
let destructTime = 0;
          
// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
let isArchiveMode = false; // Ù‡Ù„ Ù†Ø­Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ
let newestArchivedDoc = null; // Ø£Ø­Ø¯Ø« Ø±Ø³Ø§Ù„Ø© Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø¹Ø´Ø§Ù† Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡Ø§)
let isLoadingNewer = false;   // Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
let galleryImagesList = []; // Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ±
let currentImageIndex = 0;  // Ù„Ù…Ø¹Ø±ÙØ© Ø§Ø­Ù†Ø§ ÙˆØ§Ù‚ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù†Ù‡ÙŠ ØµÙˆØ±Ø©
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
let isUserBlocked = false; // Ù‡Ù„ Ø£Ù†Ø§ Ø­Ø¸Ø±ØªÙ‡ØŸ
let amIBlocked = false;    // Ù‡Ù„ Ù‡Ùˆ Ø­Ø¸Ø±Ù†ÙŠØŸ
let blockCooldown = 0;     // ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ (Real-time)
function listenForBlockStatus() {
    if (!chatId || !currentUserId || !cachedOtherUserId) return;

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ Ù‚Ø¯ Ø­Ø¸Ø±Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
    db.collection('users').doc(currentUserId).collection('blocked').doc(cachedOtherUserId)
        .onSnapshot(doc => {
            isUserBlocked = doc.exists;
            updateBlockUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        });

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù‚Ø¯ Ø­Ø¸Ø±Ù†ÙŠ
    db.collection('users').doc(cachedOtherUserId).collection('blocked').doc(currentUserId)
        .onSnapshot(doc => {
            amIBlocked = doc.exists;
            updateBlockUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        });
}

          
function toggleDestructMode() {
const btn = document.getElementById('destructBtn');
const badge = document.getElementById('destructBadge');

if (destructTime === 0) destructTime = 5;
else if (destructTime === 5) destructTime = 10;
else if (destructTime === 10) destructTime = 30;
else destructTime = 0;

if (destructTime > 0) {
btn.classList.add('active');
badge.style.display = 'block';
badge.innerText = destructTime + 's';
showToast(`ğŸ’£ Ø§Ù„ØªØ¯Ù…ÙŠØ±: ${destructTime}Ø«`);
} else {
btn.classList.remove('active');
badge.style.display = 'none';
showToast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¯Ù…ÙŠØ±");
}
}

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
let mediaRecorder = null;
let audioChunks = [];
let recordInterval = null;
let seconds = 0;

auth.onAuthStateChanged(async user => {
    if (user) {
        currentUserId = user.uid;
        checkPageSecurity(); 

        // ================= Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙÙˆØ±Ø§Ù‹ =================
        try {
            const userDoc = await db.collection('users').doc(currentUserId).get();
            if(userDoc.exists && userDoc.data().privacy) {
                myPrivacySettings = userDoc.data().privacy;
                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©:", myPrivacySettings);
            }
        } catch(e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆØµÙŠØ©", e);
        }
        // ====================================================================

        if(chatId) {
            await loadChatDetails(); 
            const targetMsgId = params.get("highlightMsg");

    if (targetMsgId) {
        console.log("Ø¬Ø§ÙŠ Ù…Ù† Ø¨Ø­Ø«ØŒ Ø±Ø§ÙŠØ­ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø±Ù‚Ù…:", targetMsgId);
        
        // Ù„Ùˆ ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ù…Ø³ØªÙ‡Ø¯ÙØ©ØŒ Ù†Ø£Ø®Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙˆÙ†Ø´ØºÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙÙˆØ±Ø§Ù‹
        setTimeout(() => {
            handleSearchResultClick(targetMsgId); // Ø¯ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ¬ÙŠØ¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯
        }, 500); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù† user ID Ø¬Ø§Ù‡Ø²
        
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ø´ Ù‡Ù†Ø´ØºÙ„ loadMessages Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¹Ø´Ø§Ù† Ù…Ù†Ø¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„
    } else {
        // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨Ø­Ø«ØŒ Ø­Ù…Ù„ Ø¢Ø®Ø± 20 Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
        loadMessages();
    }
 
            loadMessages();
            setupTypingListener();
            listenForIncomingCalls();
            // ÙØ­Øµ Ù‡Ù„ Ø¬Ø§ÙŠÙŠÙ† Ù…Ù† Ø¨Ø­Ø« ÙˆÙ„Ø§ Ù„Ø£
const highlightMsgId = params.get("highlightMsg");

if (highlightMsgId) {
    // Ù„Ùˆ ÙÙŠÙ‡ ID Ø±Ø³Ø§Ù„Ø©ØŒ Ù†ÙØ¹Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù‚ÙØ² ÙÙˆØ±Ø§Ù‹
    // Ø¨Ø³ Ù†Ø¯ÙŠÙ‡Ø§ ÙˆÙ‚Øª Ø«Ø§Ù†ÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² ØªÙƒÙˆÙ† Ø­Ù…Ù„Øª
    setTimeout(() => {
        handleSearchResultClick(highlightMsgId); 
    }, 1000);
}

        }
    } else {
        window.location.href = 'login.html';
    }
});

// ================= ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Fix Typing) =================
// ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø«Ø§Ù„Ø«: ØªØ­Ø³ÙŠÙ† Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© ğŸ”¥ğŸ”¥ğŸ”¥
const msgInput = document.getElementById("messageInput");
let isTypingStatus = false; 

msgInput.addEventListener('input', () => {
    if(chatId && currentUserId) {
        const val = msgInput.value; // Ø´ÙŠÙ„Ù†Ø§ trim Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ø´Ø§Ù† Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙƒÙƒØªØ§Ø¨Ø© Ù„Ùˆ Ø­Ø§Ø¨Ø¨ØŒ Ø£Ùˆ Ø±Ø¬Ø¹Ù‡Ø§
        
        // 1. Ù„Ùˆ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙØ¶ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ -> Ø§Ù„ØºÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆØ±Ø§Ù‹
        if (val.trim() === '') {
            clearTimeout(typingTimeout);
            if (isTypingStatus) {
                isTypingStatus = false;
                db.collection("chats").doc(chatId).update({ 
                    typing: firebase.firestore.FieldValue.arrayRemove(currentUserId) 
                }).catch(()=>{});
            }
            return;
        }

        playKeySound(); 

        // 2. Ù„Ùˆ Ù‡Ùˆ Ù…Ø´ Ù…ØªØ³Ø¬Ù„ Ø¥Ù†Ù‡ Ø¨ÙŠÙƒØªØ¨ -> Ø³Ø¬Ù„Ù‡
        if (!isTypingStatus) {
            isTypingStatus = true;
            db.collection("chats").doc(chatId).update({ 
                typing: firebase.firestore.FieldValue.arrayUnion(currentUserId) 
            }).catch(()=>{});
        }

        // 3. Ø±ÙŠØ³ØªØ§Ø±Øª Ù„Ù„Ø¹Ø¯Ø§Ø¯ (Ù„Ùˆ Ø¨Ø·Ù„ ÙƒØªØ§Ø¨Ø© Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†ÙŠ Ù†Ù…Ø³Ø­Ù‡)
        clearTimeout(typingTimeout);
        
        typingTimeout = setTimeout(() => { 
            if (isTypingStatus) { // ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù„Ø³Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© true Ù‚Ø¨Ù„ Ù…Ø§ ØªÙ…Ø³Ø­
                isTypingStatus = false;
                db.collection("chats").doc(chatId).update({ 
                    typing: firebase.firestore.FieldValue.arrayRemove(currentUserId) 
                }).catch(()=>{});
            }
        }, 3000);
    }
});



       function setupTypingListener() {
    db.collection("chats").doc(chatId).onSnapshot(doc => {
        if(!doc.exists) return;
        const data = doc.data();
        
        // Ø¬Ù„Ø¨ Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        const typingArray = data.typing || [];
        
        // Ù‡Ù„ ÙÙŠÙ‡ Ø­Ø¯ ØºÙŠØ±ÙŠ Ø¨ÙŠÙƒØªØ¨ØŸ
        const isSomeoneTyping = typingArray.some(uid => uid !== currentUserId);
        
        const st = document.getElementById('headerStatus');
        const tt = document.getElementById('typingIndicator');
        
        // ğŸ”¥ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„Ø±Ø¨Ø·: Ø´ØºÙ„ Ø£Ùˆ ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© ğŸ”¥ğŸ”¥
        manageRemoteTypingSound(isSomeoneTyping);

        if(isSomeoneTyping) { 
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            if(st) st.style.display = 'none'; 
            if(tt) {
                tt.style.display = 'block';
                tt.innerHTML = `
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>`;
            }
        } else {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø±
            if(st) st.style.display = 'block';
            if(tt) {
                tt.style.display = 'none';
                tt.innerHTML = ''; 
            }
        }
    });
}



        function toggleVideo(container) {
            const video = container.querySelector('video');
            if (video.paused) { 
                document.querySelectorAll('video').forEach(v => { v.pause(); v.parentElement.classList.remove('playing'); }); 
                video.play(); container.classList.add('playing'); 
            } else { 
                video.pause(); container.classList.remove('playing'); 
            }
        }

        
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„Ù Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­ÙŠÙ† Ø§Ù„ØªØ£ÙƒÙŠØ¯
let tempSelectedFile = null;
let tempUploadType = null;

// 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
function uploadMedia(input, type) {
    if (!input.files || !input.files[0]) return;
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ù…ØªØºÙŠØ± Ù…Ø¤Ù‚Øª
    tempSelectedFile = input.files[0];
    tempUploadType = type;

    // ØªÙØ±ÙŠØº Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ø®ØªØ§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù ØªØ§Ù†ÙŠ Ù„Ùˆ Ù„ØºÙŠÙ†Ø§
    input.value = ""; 

    // Ø£) Ù„Ùˆ ÙƒØ§Ù† ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ -> Ù†ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Preview Modal) Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹
    if (type === 'media' || tempSelectedFile.type.startsWith('image/') || tempSelectedFile.type.startsWith('video/')) {
        showMediaPreview(tempSelectedFile);
    } 
    // Ø¨) Ù„Ùˆ ÙƒØ§Ù† Ù…Ù„Ù Ø¹Ø§Ø¯ÙŠ -> Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø¯Ù„ Ø§Ù„Ù€ alert)
    else {
        openUploadConfirmModal(tempSelectedFile.name);
    }
}

// ================= Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª =================

// 1. ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
function openUploadConfirmModal(fileName) {
    const modal = document.getElementById('uploadConfirmModal');
    const nameEl = document.getElementById('uploadFileName');
    
    if(modal && nameEl) {
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… ÙˆØªÙ„ÙˆÙŠÙ†Ù‡
        nameEl.innerHTML = `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù:<br><span style="color:#00e5ff; font-weight:bold; direction:ltr; display:inline-block; margin-top:5px;">${fileName}</span>ØŸ`;
        modal.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    }
}

// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© (Ø¥Ù„ØºØ§Ø¡)
function closeUploadModal() {
    const modal = document.getElementById('uploadConfirmModal');
    if(modal) modal.style.display = 'none';
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    if(typeof tempSelectedFile !== 'undefined') tempSelectedFile = null;
    document.getElementById('fileInput').value = ""; // ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
}

// 3. Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„
function processFileAndSend() {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('uploadConfirmModal').style.display = 'none';
    
    // Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¯Ø§Ø¦Ù…
    if (typeof tempSelectedFile !== 'undefined' && tempSelectedFile) {
        selectedFile = tempSelectedFile; // Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± ØªØ³ØªØ®Ø¯Ù…Ù‡ Ø¯Ø§Ù„Ø© confirmUpload
        confirmUpload(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    }
}

// --- Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ) ---
function showMediaPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const container = document.getElementById('previewContainer');
        container.innerHTML = ''; 

        if (file.type.startsWith('image')) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-img';
            container.appendChild(img);
        } else if (file.type.startsWith('video')) {
            const vid = document.createElement('video');
            vid.src = e.target.result;
            vid.className = 'preview-vid';
            vid.controls = true;
            container.appendChild(vid);
        }
        
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØºÙŠØ± global Ù„Ù„Ø¯Ø§Ù„Ø© confirmUpload
        selectedFile = file; 
        document.getElementById('previewModal').style.display = 'flex';
    }
    reader.readAsDataURL(file);
}

function cancelPreview() {
    selectedFile = null;
    document.getElementById('previewModal').style.display = 'none';
}

async function confirmUpload() {
    if (!selectedFile) return;
    
    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const previewModal = document.getElementById('previewModal');
    if (previewModal) previewModal.style.display = 'none';
    
    // 1. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯Ù‚Ø© (ØµÙˆØ±Ø© - ÙÙŠØ¯ÙŠÙˆ - Ù…Ù„Ù)
    let msgType = 'file'; 
    if (selectedFile.type.startsWith('image/')) msgType = 'image';
    else if (selectedFile.type.startsWith('video/')) msgType = 'video';
    else if (selectedFile.type.startsWith('audio/')) msgType = 'audio';
    
    try {
        showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â³");
        
        // 2. ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Firebase Storage
        const folder = msgType === 'file' ? 'chat_docs' : 'chat_media';
        const path = `${folder}/${Date.now()}_${selectedFile.name}`;
        
        const ref = storage.ref(path);
        
        // 3. Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
        await ref.put(selectedFile);
        
        // 4. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ (URL)
        const url = await ref.getDownloadURL();
        
        // 5. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù‡Ù†Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£)
        let msgPayload = { 
            text: url,         // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ÙˆØ¶Ø¹Ù†Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§ Ø¨Ø¯Ù„ val
            uid: currentUserId, 
            type: msgType,     // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ÙˆØ¶Ø¹Ù†Ø§ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù (image/video/file) Ø¨Ø¯Ù„ 'text'
            seen: false, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isGhost: typeof isGhostMode !== 'undefined' ? isGhostMode : false 
        }; 

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ
        if (typeof destructTime !== 'undefined' && destructTime > 0) {
            msgPayload.selfDestruct = destructTime;
            msgPayload.expireAt = firebase.firestore.Timestamp.fromMillis(Date.now() + (destructTime * 1000));
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©
        if (currentReply) {
            msgPayload.replyTo = { 
                id: currentReply.id, 
                text: currentReply.text, 
                sender: currentReply.sender 
            };
        }

        // 6. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø´Ø§Øª Ù†Ø´Ø· Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        await ensureChatActive();

        // 7. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await db.collection("chats").doc(chatId).collection("messages").add(msgPayload);
        
        // 8. ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
        if (cachedOtherUserId && !msgPayload.isGhost) {
            let previewText = msgType === 'image' ? 'ğŸ“· ØµÙˆØ±Ø©' : (msgType === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ“ Ù…Ù„Ù');
            await db.collection("chats").doc(chatId).set({ 
                lastMessage: previewText, 
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
                sentTo: cachedOtherUserId, 
                senderId: currentUserId, 
                seen: false, 
                unreadCount: firebase.firestore.FieldValue.increment(1),
                deletedBy: [],
                archivedBy: []
            }, { merge: true });
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        cancelReply();
        selectedFile = null;
        document.getElementById('fileInput').value = "";
        document.getElementById('mediaInput').value = "";
        
        showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
        
        // Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„
        setTimeout(scrollToBottom, 100);

    } catch (err) { 
        console.error("Upload Error:", err); 
        showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ âŒ"); 
        selectedFile = null; 
    }
}


        // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯


function activateReplyMode() {
    // selectedMsgData Ùˆ selectedMsgId ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø³Ø­Ø¨
    if(!selectedMsgData) return;

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    currentReply = { 
        id: selectedMsgId, 
        text: selectedMsgData.type === 'text' ? selectedMsgData.text : (selectedMsgData.type==='image'?'ğŸ“· ØµÙˆØ±Ø©':'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ'), 
        sender: selectedMsgData.senderName || 'Ù…Ø³ØªØ®Ø¯Ù…' 
    };

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ·
    const bar = document.getElementById('replyBar');
    if(bar) {
        bar.style.display = 'flex';
        document.getElementById('replyTitle').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${currentReply.sender}`;
        document.getElementById('replyText').innerText = currentReply.text;
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        document.getElementById('messageInput').focus();
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ù…ÙØªÙˆØ­Ø©
    if(typeof closeContextMenu === 'function') closeContextMenu();
}

function cancelReply() { 
    currentReply = null; 
    const bar = document.getElementById('replyBar');
    if(bar) bar.style.display = 'none'; 
}


        // ================= Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ =================

// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø¨Ø¯Ù„ Ø§Ù„Ù€ confirm Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
function deleteMessageForEveryone() {
    closeContextMenu(); // Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ„
    if(selectedMsgId) {
        document.getElementById('deleteModal').style.display = 'flex';
    }
}

// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²)
// 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù (Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ)
// 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ (Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªÙ†Ø¯ Ù„ÙŠØ®ØªÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹)
// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù†Øµ "ØªÙ… Ø§Ù„Ø­Ø°Ù")
async function performDelete() {
    if(!selectedMsgId) return;
    
    closeDeleteModal(); // Ù‚ÙÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
    
    try {
        const msgRef = db.collection("chats").doc(chatId).collection("messages").doc(selectedMsgId);
        
        // ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¨Ù†Ø­Ø¯Ø« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨Ù†Ù…Ø³Ø­Ù‡Ø§
        // Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ù…ÙƒØ§Ù†Ù‡Ø§ "ğŸš« ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©"
        await msgRef.update({
            type: 'deleted',           // ØªØºÙŠÙŠØ± Ø§Ù„Ù†ÙˆØ¹
            text: '',                  // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
            fileUrl: firebase.firestore.FieldValue.delete(), // Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
            reaction: firebase.firestore.FieldValue.delete() // Ø­Ø°Ù Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        });

        showToast("ØªÙ… Ø­Ø°Ù Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸ—‘ï¸");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ù„Ùˆ ÙƒØ§Ù†Øª Ù‡ÙŠ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        updateLastMessageAfterDelete();

    } catch(e) {
        console.error("Ø®Ø·Ø£:", e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
    }
}

// ============================================================
// ğŸ”¥ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ) ğŸ”¥
// (Ø¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ­Øª performDelete Ù…Ø¨Ø§Ø´Ø±Ø©)
// ============================================================
async function updateLastMessageAfterDelete() {
    try {
        // Ø¨Ù†Ø¬ÙŠØ¨ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø¯Ù„ÙˆÙ‚ØªÙŠ (Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ù‡ÙŠ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙˆÙ„Ø§ Ù„Ø£)
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "desc")
            .limit(1)
            .get();

        if (!snapshot.empty) {
            const lastMsg = snapshot.docs[0].data();
            let previewText = "";

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¸Ù‡Ø± Ø¨Ø±Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
            if (lastMsg.type === 'deleted') {
                previewText = "ğŸš« ØªÙ… Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©"; // Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¸Ù‡Ø± Ø¨Ø±Ù‡ Ù„Ùˆ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©
            } else if (lastMsg.type === 'image') {
                previewText = "ğŸ“· ØµÙˆØ±Ø©";
            } else if (lastMsg.type === 'video') {
                previewText = "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ";
            } else if (lastMsg.type === 'audio') {
                previewText = "ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©";
            } else if (lastMsg.type === 'file') {
                previewText = "ğŸ“ Ù…Ù„Ù";
            } else {
                previewText = lastMsg.text; // Ù„Ùˆ Ù†Øµ Ø¹Ø§Ø¯ÙŠ
            }
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ù„Ù„ÙŠ Ø¨ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø±Ù‡)
            await db.collection("chats").doc(chatId).update({
                lastMessage: previewText
                // Ù…Ø´ Ù‡Ù†Ø­Ø¯Ø« Ø§Ù„ÙˆÙ‚Øª (lastMessageTime) Ø¹Ø´Ø§Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø´Ø§Øª Ù…ÙŠØ¨ÙˆØ¸Ø´
            });
        }
    } catch(e) { 
        console.log("Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©", e); 
    }
}
async function getUser(uid) {
    if (userCache[uid]) return userCache[uid];

    try {
        const doc = await db.collection('users').doc(uid).get();
        const data = doc.exists ? doc.data() : {};

        userCache[uid] = {
            name: data.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            char: (data.name || 'U')[0].toUpperCase(),
            color: data.color || "#555",
            
            // ğŸ”¥ğŸ”¥ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ğŸ”¥ğŸ”¥
            profilePic: data.profilePic || data.avatar || data.photoURL || data.image || null,
            
            isVerified: data.isVerified || false
        };

    } catch (e) {
        console.warn("âš ï¸ Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", uid, e);
        userCache[uid] = { name: "Ù…Ø³ØªØ®Ø¯Ù…", char: "U", color: "#555", profilePic: null, isVerified: false };
    }

    return userCache[uid];
}

        let headerUnsubscribe = null; // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ø´Ø§Ù† Ù†Ù„ØºÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…
// 1. Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù‚Øµ Ø§Ù„Ø§Ø³Ù… (ØªÙˆØ¶Ø¹ Ù‚Ø¨Ù„ updateHeader)
// Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªØµØ§Ø± (ØªÙˆØ¶Ø¹ Ù‚Ø¨Ù„ updateHeader)
// Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)
function getShortName(fullName) {
    if (!fullName) return "Ù…Ø³ØªØ®Ø¯Ù…";

    // 1. (ØªØ¹Ø¯ÙŠÙ„) Ø´ÙŠÙ„Ù†Ø§ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø¨ÙŠÙ…Ø³Ø­ Ø§Ù„Ø±Ù…ÙˆØ²
    // ÙƒÙ†Ø§ Ø¨Ù†Ø³ØªØ®Ø¯Ù… .replace(...) ÙˆØ¯Ù‡ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø¨ÙŠÙ…Ø³Ø­ Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ
    
    let cleanName = fullName.trim(); // Ø¨Ù†Ø´ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø¨Ø³

    // 2. ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª
    const parts = cleanName.split(' ');

    // 3. Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ (Ø£ÙƒØ«Ø± Ù…Ù† 3 ÙƒÙ„Ù…Ø§Øª)ØŒ Ø®Ø¯ Ø£ÙˆÙ„ ÙƒÙ„Ù…ØªÙŠÙ† Ø¨Ø³
    // Ø¹Ø´Ø§Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…ÙŠØ¨ÙˆØ¸Ø´
    if (parts.length > 2) {
        return `${parts[0]} ${parts[1]}`;
    }

    // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±ØŒ Ø±Ø¬Ø¹Ù‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ (Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨ØªØ§Ø¹Ù‡)
    return cleanName;
}

// ================================================================
// 1. Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© updateHeader Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ (Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¸Ù‡Ø± Ø§Ù„Ø­Ù„Ù‚Ø©)
// ================================================================
async function updateHeader(uid) {
    if (!uid) return;
    
    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø§Ø³ØªÙ…Ø§Ø¹ Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„
    if (headerUnsubscribe) headerUnsubscribe();

    headerUnsubscribe = db.collection('users').doc(uid).onSnapshot(async doc => {
        if (!doc.exists) return;
        const u = doc.data();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        userCache[uid] = {
            ...userCache[uid],
            name: u.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            profilePic: u.profilePic || u.avatar || u.photoURL || null,
            color: u.color || "#555",
            char: (u.name || 'U')[0].toUpperCase(),
            // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ 2: Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚
            isVerified: u.isVerified || false, 
            lastSeen: u.lastSeen,
            privacy: u.privacy || {}
        };

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø£Ù„Ù‚Ø§Ø¨
        let finalName = u.name || "Ù…Ø³ØªØ®Ø¯Ù…"; 
        if (typeof globalNicknames !== 'undefined' && globalNicknames[uid]) {
            finalName = globalNicknames[uid];
}
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù„Ù‚Ø¨ Ù…Ù† Ø§Ù„ÙƒÙˆÙ„ÙƒØ´Ù† Ø§Ù„ÙØ±Ø¹ÙŠ (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
        else {
             try {
                const nickDoc = await db.collection('users').doc(currentUserId).collection('nicknames').doc(uid).get();
                if (nickDoc.exists && nickDoc.data().nickname) {
                    finalName = nickDoc.data().nickname;
                }
            } catch (e) { }
        }
const verifyEl = document.getElementById("headerVerify");
        if (verifyEl) {
            if (u.isVerified === true) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡
                verifyEl.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#00e5ff; margin-right:5px; font-size:14px;"></i>';
                verifyEl.style.display = "inline-block";
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
                verifyEl.innerHTML = '';
                verifyEl.style.display = "none";
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const displayName = getShortName(finalName); 
        const headerNameEl = document.getElementById("headerName");
        if(headerNameEl) {
            headerNameEl.innerText = displayName;
            headerNameEl.style.direction = "auto"; 
            headerNameEl.style.unicodeBidi = "plaintext";
        }
        
        const callNameEl = document.getElementById("callName"); 
        if(callNameEl) callNameEl.innerText = displayName; 

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©
        const hImg = document.getElementById("headerImage");
        const callAvatar = document.getElementById("callAvatar");

        if (u.profilePic) {
            if(hImg) {
                hImg.style.backgroundImage = `url('${u.profilePic}')`;
                hImg.innerText = ''; 
                hImg.style.backgroundColor = 'transparent';
            }
            if(callAvatar) callAvatar.style.backgroundImage = `url('${u.profilePic}')`;
        } else {
            if(hImg) {
                hImg.style.backgroundImage = 'none';
                hImg.style.backgroundColor = u.color || '#555';
                hImg.innerText = (u.name || 'U')[0].toUpperCase();
            }
            if(callAvatar) {
                callAvatar.style.backgroundImage = 'none';
                callAvatar.style.backgroundColor = u.color || '#333';
            }
        }

        // --- (2) ÙƒÙˆØ¯ Ø§Ù„Ù‚ØµØµ (Stories Logic) - Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© ---
        const avatarContainer = document.querySelector('.user-avatar-container');
        let hasActiveStory = false;

        // ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (u.hasStory === true) {
            hasActiveStory = true;
        } 
        
        // ÙØ­Øµ Ø¯Ù‚ÙŠÙ‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ØµØµ (Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©)
        try {
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const storiesQuery = await db.collection('stories')
                .where('uid', '==', uid)
                .where('timestamp', '>', twentyFourHoursAgo)
                .limit(1) 
                .get();
                
            if (!storiesQuery.empty) {
                hasActiveStory = true;
            }
        } catch(err) {
            console.log("Error checking stories:", err);
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
        if (avatarContainer) {
            if (hasActiveStory) {
                // ÙÙŠÙ‡ Ù‚ØµØ©: Ø­Ø· Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© ÙˆØºÙŠØ± Ø§Ù„Ø¶ØºØ·Ø© Ù„ÙØªØ­ Ø§Ù„Ù‚ØµØ©
                avatarContainer.classList.add('has-story');
                avatarContainer.onclick = function(e) {
                    e.stopPropagation();
                    openUserStoryViewer(uid); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶
                };
            } else {
                // Ù…ÙÙŠØ´ Ù‚ØµØ©: Ø´ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© ÙˆØ±Ø¬Ø¹ Ø§Ù„Ø¶ØºØ·Ø© Ù„ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                avatarContainer.classList.remove('has-story');
                avatarContainer.onclick = function() {
                    openProfile();
                };
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Last Seen)
        const statusElement = document.getElementById("headerStatus");
        const onlineIndicator = document.querySelector(".online-status");

        if (u.lastSeen) {
            const isHidden = u.privacy && u.privacy.hideLastSeen;
            if (isHidden) {
                if(statusElement) { statusElement.innerText = ""; statusElement.style.display = 'none'; }
                if(onlineIndicator) { onlineIndicator.style.backgroundColor = "transparent"; onlineIndicator.style.boxShadow = "none"; }
            } else {
                if(statusElement) statusElement.style.display = 'block';
                const statusText = formatLastSeen(u.lastSeen);
                if(statusElement) statusElement.innerText = statusText;

                if (statusText === 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†') {
                    if(statusElement) statusElement.style.color = "#10b981";
                    if(onlineIndicator) { onlineIndicator.style.backgroundColor = "#10b981"; onlineIndicator.style.boxShadow = "0 0 8px #10b981"; }
                } else {
                    if(statusElement) statusElement.style.color = "#94a3b8";
                    if(onlineIndicator) { onlineIndicator.style.backgroundColor = "#94a3b8"; onlineIndicator.style.boxShadow = "none"; }
                }
            }
        } else {
            if(statusElement) statusElement.innerText = "";
            if(onlineIndicator) onlineIndicator.style.backgroundColor = "transparent";
        }
    });
}

// ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ØµØµ Ø§Ù„Ù…ÙˆØ­Ø¯ (JS Story System) =================

// Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ØµØµ
let currentStoriesQueue = [];
let currentStoryIndex = 0;
let storyTimerInterval = null;
let storyDuration = 5000; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØµÙˆØ±
let storyStartTime = 0;

// ================= Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚) =================
async function openUserStoryViewer(targetUid) {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙˆØ¥Ø¬Ø¨Ø§Ø±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„ØµØ­ÙŠØ­
    const viewer = document.getElementById('simpleStoryViewer');
    
    // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù„Ù€ body Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ (Ø²ÙŠØ§Ø¯Ø© ØªØ£ÙƒÙŠØ¯ Ù„ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„)
    if (viewer.parentNode !== document.body) {
        document.body.appendChild(viewer);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ØµØ§Ø¦Øµ
    viewer.style.display = 'flex';
    viewer.style.opacity = '1';       
    viewer.style.transform = 'none';  
    
    showToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ©... â³");

    try {
        // ============================================================
        // ğŸ”¥ğŸ”¥ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ğŸ”¥ğŸ”¥
        // ============================================================
        
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        let userData = userCache[targetUid];
        if (!userData) {
            userData = { name: 'Ù…Ø³ØªØ®Ø¯Ù…', profilePic: null, isVerified: false };
        }

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
        const nameEl = document.getElementById('storyUserName');
        if (nameEl) nameEl.innerText = userData.name;

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©)
        const imgEl = document.getElementById('storyUserImg');
        if (imgEl) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø£ÙŠ Ø§Ø³Ù… Ù…Ø­ØªÙ…Ù„
            const picSrc = userData.profilePic || userData.avatar || userData.photoURL || 'https://i.ibb.co/tZ5tPqB/default-avatar.png';
            imgEl.src = picSrc;
        }

        // 4. ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©)
        const verifyBadge = document.getElementById('storyVerifyIcon');
        if (verifyBadge) {
            if (userData.isVerified === true) {
                verifyBadge.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø±
            } else {
                verifyBadge.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡
            }
        }
        // ============================================================

        // 5. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ØµØµ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        const snapshot = await db.collection('stories')
            .where('uid', '==', targetUid)
            .where('timestamp', '>', twentyFourHoursAgo)
            .orderBy('timestamp', 'asc')
            .get();

        if (snapshot.empty) {
            viewer.style.display = 'none'; 
            showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØµ Ù„Ø¹Ø±Ø¶Ù‡Ø§");
            return;
        }

        currentStoriesQueue = [];
        snapshot.forEach(doc => currentStoriesQueue.push(doc.data()));

        // Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        currentStoryIndex = 0;
        showStoryItem(currentStoryIndex);

    } catch(err) {
        console.error(err);
        viewer.style.display = 'none';
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØ©");
    }
}


// 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ± (ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ)
function showStoryItem(index) {
    if (index >= currentStoriesQueue.length) {
        closeStoryViewer(); // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚ØµØµ
        return;
    }
    if (index < 0) {
        currentStoryIndex = 0; return; // Ø­Ù…Ø§ÙŠØ©
    }

    const story = currentStoriesQueue[index];
    const imgEl = document.getElementById('storyImgDisplay');
    const vidEl = document.getElementById('storyVideoDisplay');
    const timeEl = document.getElementById('storyTime');

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø§Ø¯
    clearInterval(storyTimerInterval);
    document.getElementById('storyProgressBar').style.width = '0%';

    // Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„Ù‚ØµØ©
    if(story.timestamp) {
        timeEl.innerText = formatLastSeen(story.timestamp);
    }

    if (story.type === 'video') {
        imgEl.style.display = 'none';
        vidEl.style.display = 'block';
        vidEl.src = story.url;
        vidEl.currentTime = 0;
        
        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: Ø´ØºÙ„ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯
        vidEl.onloadedmetadata = () => {
            storyDuration = vidEl.duration * 1000;
            vidEl.play().catch(e => console.log("Video Play Error:", e));
            startProgressBar();
        };
        // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØ§Ù„ÙŠ
        vidEl.onended = () => {
            nextStoryItem();
        };
    } else {
        vidEl.style.display = 'none';
        vidEl.pause(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
        imgEl.style.display = 'block';
        imgEl.src = story.url;
        
        storyDuration = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ Ù„Ù„ØµÙˆØ±
        startProgressBar();
    }
}

// 3. Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (Timer)
function startProgressBar() {
    const bar = document.getElementById('storyProgressBar');
    storyStartTime = Date.now();
    
    clearInterval(storyTimerInterval);
    storyTimerInterval = setInterval(() => {
        const elapsed = Date.now() - storyStartTime;
        const progress = (elapsed / storyDuration) * 100;
        
        if (progress >= 100) {
            clearInterval(storyTimerInterval);
            // Ù„Ùˆ ØµÙˆØ±Ø©ØŒ Ù†Ù‚Ù„Ø¨ ÙŠØ¯ÙˆÙŠ (Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨ÙŠÙ‚Ù„Ø¨ Ù„ÙˆØ­Ø¯Ù‡)
            if(document.getElementById('storyVideoDisplay').style.display === 'none') {
                nextStoryItem();
            }
        } else {
            bar.style.width = progress + '%';
        }
    }, 50);
}

// 4. Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
function nextStoryItem() {
    currentStoryIndex++;
    showStoryItem(currentStoryIndex);
}

function prevStoryItem() {
    if (currentStoryIndex > 0) {
        currentStoryIndex--;
        showStoryItem(currentStoryIndex);
    } else {
        showStoryItem(0); // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø£ÙˆÙ„
    }
}




       // Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ù…Ø­Ø¯Ø«Ø© Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
async function openProfile() {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ù†Ø­Ø¯Ø«Ù‡)
    let targetUid = cachedOtherUserId;
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù€ UID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± ÙØ§Ø±Øº (Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
    if (!targetUid) {
        const params = new URLSearchParams(location.search);
        targetUid = params.get("uid");
    }

    // 2. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const userData = userCache[targetUid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', profilePic: null, isVerified: false };

    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© (Image Fix) ===
    const bigImg = document.getElementById('profilePageImg');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    bigImg.classList.remove('has-story-active');
    bigImg.onclick = null;
    bigImg.style.cursor = 'default';

    // ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£Ø¯Ù‚ Ù…Ù† Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±)
    const userImage = userData.profilePic || userData.avatar || userData.photoURL;
    
    if (userImage) {
        bigImg.style.backgroundImage = `url('${userImage}')`;
        bigImg.innerText = '';
        bigImg.style.backgroundColor = 'transparent';
    } else {
        bigImg.style.backgroundImage = 'none';
        bigImg.style.backgroundColor = userData.color || '#555';
        bigImg.innerText = (userData.name || 'U')[0].toUpperCase();
        bigImg.style.display = 'grid';
        bigImg.style.placeItems = 'center';
    }

    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… (Name Fix) ===
    document.getElementById('profilePageName').innerText = userData.name || "Ù…Ø³ØªØ®Ø¯Ù…";

    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Verification Fix) ===
    const verifyIcon = document.getElementById('profilePageVerify');
    if (verifyIcon) {
        if (userData.isVerified === true) {
            verifyIcon.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        } else {
            verifyIcon.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        }
    }

    // === Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© ===
    const profilePage = document.getElementById('profilePage');
    if (profilePage.parentNode !== document.body) {
        document.body.appendChild(profilePage); // Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„ØªØºØ·ÙŠØ© ÙƒÙ„ Ø´ÙŠØ¡
    }
    profilePage.style.display = 'flex';

    // === ÙØ­Øµ Ø§Ù„Ù‚ØµØ© (Story Logic) ===
    if (targetUid) {
        try {
            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const snapshot = await db.collection('stories')
                .where('uid', '==', targetUid)
                .where('timestamp', '>', twentyFourHoursAgo)
                .limit(1)
                .get();

            if (!snapshot.empty) {
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©
                bigImg.classList.add('has-story-active');
                bigImg.style.cursor = 'pointer';
                
                // Ø¬Ø¹Ù„ Ø§Ù„Ø¶ØºØ· ÙŠÙØªØ­ Ø§Ù„Ù‚ØµØ©
                bigImg.onclick = function(e) {
                    e.stopPropagation();
                    openUserStoryViewer(targetUid);
                };
            }
        } catch (e) {
            console.log("Story check error:", e);
        }
    }
}

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
// ================= Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® =================
function isSameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
}

function formatDateSticky(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (isSameDay(date, today)) return "Ø§Ù„ÙŠÙˆÙ…";
    if (isSameDay(date, yesterday)) return "Ø£Ù…Ø³";
    return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
}

// ================= Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„ÙƒØ§Ù…Ù„Ø©) =================
function loadMessages() {
    
    db.collection("chats").doc(chatId).collection("messages")
      .orderBy("createdAt", "asc")
      .limitToLast(20) // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø©
      .onSnapshot(async snap => {
          
                  // --- 1. ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: Ø¬Ù„Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù ---
        let myClearTime = 0;
        try {
            const cDoc = await db.collection("chats").doc(chatId).get();
            if (cDoc.exists && cDoc.data().clearedAt && cDoc.data().clearedAt[currentUserId]) {
                myClearTime = cDoc.data().clearedAt[currentUserId].toMillis();
            }
        } catch (e) {}
        // ------------------------------------

          document.getElementById('loadingSkeleton')?.remove();
          
        const container = document.getElementById("chatContainer");
        
if (isFirstLoad) {
    // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙ ÙƒØ§Ù† Ù‡Ù†Ø§
    container.scrollTop = container.scrollHeight;
    requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
}

    
        // 1. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}


// âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ù†Ø­Ø¯Ø« Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· ÙÙŠ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ù„Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± ÙØ§Ø¶ÙŠ
if (snap.docs.length > 0 && (isFirstLoad || !oldestDoc)) {
    oldestDoc = snap.docs[0];
}


// Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© loadMessages...
if (!isFirstLoad) {
    snap.docChanges().forEach(change => {
        if (change.type === 'added') {
            const d = change.doc.data();
            
            // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ (ÙŠØ¹Ù†ÙŠ Ø¬Ø§ÙŠØ© Ù…Ù† Ø­Ø¯ ØªØ§Ù†ÙŠ)
            // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ (ÙŠØ¹Ù†ÙŠ Ø¬Ø§ÙŠØ© Ù…Ù† Ø­Ø¯ ØªØ§Ù†ÙŠ)
if (d.uid !== currentUserId) {
    


    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø§Ù‡ØªØ²Ø§Ø²)

                // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
                if (document.hidden && Notification.permission === "granted") {
                    new Notification("Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’¬", {
                        body: d.type === 'text' ? d.text : 'Ø£Ø±Ø³Ù„ Ù…Ø±ÙÙ‚Ø§Ù‹ ğŸ“',
                        icon: 'img/logo.png', // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù„ÙˆØ¬Ùˆ Ø­Ø·Ù‡ Ù‡Ù†Ø§
                        vibrate: [200, 100, 200]
                    });
                }
            }
        }
    });
}


        // 1. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ÙƒØ§Ø´)
        let potentialOtherId = null; 
        const uids = new Set(); 
        snap.docs.forEach(d => { 
            const u = d.data().uid; 
            uids.add(u); 
            if(u !== currentUserId) potentialOtherId = u; 
        });
        
        if(potentialOtherId) cachedOtherUserId = potentialOtherId; 
        if(cachedOtherUserId) await updateHeader(cachedOtherUserId);
        
        await Promise.all(Array.from(uids).map(uid => getUser(uid)));

        // 2. Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ø¨Ù†Ø§Ø¡ HTML
     let html = "";
          
          // Ù„Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£Ù‚Ù„ Ù…Ù† 20ØŒ Ù…Ø¹Ù†Ø§Ù‡Ø§ Ø¥Ø­Ù†Ø§ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØªÙ…Ø§Ù…Ø§Ù‹
          if (snap.docs.length < 20 && !isArchiveMode) {
              const otherUser = userCache[cachedOtherUserId] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', profilePic: null };
              html = `
                <div class="chat-end-card" style="margin-bottom: 30px; margin-top: 10px;">
                    <div class="cec-avatar" style="background-image: url('${otherUser.profilePic || 'https://i.ibb.co/tZ5tPqB/default-avatar.png'}');"></div>
                    <div class="cec-name">${otherUser.name}</div>
                    <div class="cec-sub">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>
                    <button class="cec-btn" onclick="navigateToUserProfile()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
                </div>`;
          }

        let prevMsg = null; // Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù„Ù„ØªØ¬Ù…ÙŠØ¹)
        let lastDate = null; // Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ù„Ù„ÙÙˆØ§ØµÙ„)

        let destructQueue = []; // ğŸ‘ˆ Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù€ Loop
// 1. ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ¯ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù‚Ø±ÙˆØ¡Ø© (Ù…Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø¯ÙŠÙ…)
let lastSeenMsgId = null;
const allDocs = snap.docs;
for (let i = allDocs.length - 1; i >= 0; i--) {
    const d = allDocs[i].data();
    // Ø¨Ù†Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ§Ø¹ØªÙŠ ÙˆØªÙƒÙˆÙ† seen ÙˆÙ…Ø´ Ù…Ù…Ø³ÙˆØ­Ø©
    if (d.uid === currentUserId && d.seen === true && d.type !== 'deleted') {
        lastSeenMsgId = allDocs[i].id;
        break; // Ø£ÙˆÙ„ Ù…Ø§ Ù†Ù„Ø§Ù‚ÙŠÙ‡Ø§ Ù†ÙˆÙ‚Ù ØªØ¯ÙˆÙŠØ±
    }
}

                    snap.forEach(doc => {
                        
    const msg = doc.data();
                // --- 2. ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ---
            if (msg.createdAt && msg.createdAt.toMillis() <= myClearTime) return;
            // ------------------------------------------

    const isMe = msg.uid === currentUserId;
    
    
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };
    
    

    // ================= 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙØ§Ø¹Ù„ (Reaction) =================
    let reactionHtml = "";
    let rowStyle = "";
    
    
    
    // ================= Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ù‚Ø¨ =================
if (msg.type === 'system_nickname') {
    let systemText = "";
    
    
    
    if (msg.uid === currentUserId) {
        // Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ ØºÙŠØ±Øª Ø§Ù„Ø§Ø³Ù…
        systemText = `Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ ØµØ¯ÙŠÙ‚Ùƒ Ø¥Ù„Ù‰ "${msg.text}"`;
    } 
    
    
    else {
        // Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ ØºÙŠØ± Ø§Ø³Ù…ÙŠ
        systemText = `Ù„Ù‚Ø¯ Ù‚Ø§Ù… ${u.name} Ø¨ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨Ùƒ Ø¥Ù„Ù‰ "${msg.text}"`;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù€ HTML
    html += `<div class="nickname-system-msg"><span><i class="fa-solid fa-pen-nib"></i> ${systemText}</span></div>`;
    return; // ØªØ®Ø·ÙŠ Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
}

    // Ø´Ø±Ø·: Ø¥Ø°Ø§ ÙˆØ¬Ø¯ ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù…Ø­Ø°ÙˆÙØ©
    if (msg.reaction && msg.type !== 'deleted') {
        reactionHtml = `<div class="msg-reaction" onclick="event.stopPropagation(); toggleReaction('${msg.reaction}')">${msg.reaction}</div>`;
        
        
        // ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…ÙŠØªØºØ·Ø§Ø´ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡
        rowStyle = 'margin-bottom: 25px;'; 
    }


    // ================= 2. ÙÙ„ØªØ± ÙˆÙ‚Øª Ø§Ù„ØªØ¯Ù…ÙŠØ± =================
    if (msg.selfDestruct && msg.type !== 'deleted') {
        const expiresAt = (msg.createdAt ? msg.createdAt.toMillis() : Date.now()) + (msg.selfDestruct * 1000);
        const timeLeft = expiresAt - Date.now();
        if (timeLeft <= 0) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
        destructQueue.push({ id: doc.id, timeLeft: timeLeft, isMe: isMe });
    }


    // ================= 3. ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® =================
    const msgDate = msg.createdAt ? msg.createdAt.toDate() : new Date();
    if (!lastDate || !isSameDay(msgDate, lastDate)) {
        html += `<div class="date-divider"><span>${formatDateSticky(msgDate)}</span></div>`;
        lastDate = msgDate;
        prevMsg = null;
    }
    

// =====================================================================

            // ================= 4. Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„ØµØ¯Ø§Ù‚Ø©) =================
            if (msg.type === 'system') {
                let actionText = "";
                let showName = true; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù‡Ù†Ø¸Ù‡Ø± Ø§Ù„Ø§Ø³Ù… (Ø²ÙŠ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­)

                // 1. ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                if (msg.text === 'ghost_on') {
                    actionText = 'Ù‚Ø§Ù… Ø¨ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»';
                } else if (msg.text === 'ghost_off') {
                    actionText = 'Ù‚Ø§Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸš«';
                } 
                
                
                // 2. ÙØ­Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµØ¯Ø§Ù‚Ø© (Ø¹Ø´Ø§Ù† Ù†Ø®ÙÙŠ Ø§Ù„Ø§Ø³Ù…)
                else if (msg.text === 'request_accepted' || msg.text.includes('ØµØ¯ÙŠÙ‚ÙŠÙ†') || msg.text.includes('Ø­Ø§Ø¬Ø² Ø§Ù„ØµÙ…Øª')) {
                    actionText = 'ğŸ‰ Ù„Ù‚Ø¯ Ø£ØµØ¨Ø­Ù†Ø§ ØµØ¯ÙŠÙ‚ÙŠÙ†ØŒ Ø§ÙƒØ³Ø±ÙˆØ§ Ø­Ø§Ø¬Ø² Ø§Ù„ØµÙ…Øª!';
                    showName = false; // ğŸ‘ˆ Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ø¨Ù†Ù‚ÙˆÙ„Ù‡ Ù…ØªÙƒØªØ¨Ø´ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ
                } 
                
                
                else if (msg.text.includes('ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨')) {
                    // Ù„Ùˆ Ø±Ø³Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ØŒ Ù†Ø¹Ø±Ø¶Ù‡Ø§ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ
                     actionText = msg.text;
                     showName = false; // Ø§Ù„Ø§Ø³Ù… Ø¹Ø§Ø¯Ø© Ø¨ÙŠÙƒÙˆÙ† Ø¬ÙˆÙ‡ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙ…Ø´ Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù†ÙƒØ±Ø±Ù‡
                }
                
                
                else {
                    // Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© ØªØ§Ù†ÙŠØ©
                    actionText = msg.text;
                }


                // 3. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø§Ø³Ù… (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ showName Ù„Ø³Ù‡ true)
                // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… (Ù…Ø³ØªØ®Ø¯Ù…) Ø£Ùˆ (User) ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© Ø´Ø¨Ø­ØŒ Ù‡ÙŠØ¸Ù‡Ø± Ø¹Ø§Ø¯ÙŠ. Ù„Ùˆ ØµØ¯Ø§Ù‚Ø©ØŒ Ù‡ÙŠØ®ØªÙÙŠ.
                let nameHtml = showName ? `<span class="system-user-name" style="margin-right:5px; font-weight:bold; color:var(--accent-color);">(${u.name})</span>` : '';


                // 4. Ø¯Ù…Ø¬ Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                html += `<div class="system-msg-row" id="msg_${doc.id}">
                            <span class="system-msg-text">
                                ${actionText} ${nameHtml}
                            </span>
                         </div>`;
                
                return; // Ù†Ø®Ø±Ø¬ Ø¹Ø´Ø§Ù† Ù…Ù†ÙƒÙ…Ù„Ø´ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ
            }

    // ================= 5. ØªØ¬Ù‡ÙŠØ² Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© =================
    let content = "";
    let bubbleClass = "msg-bubble target-bubble"; 
    
if (msg.type === 'image' || msg.type === 'video') {
        bubbleClass += " media-bubble";
    }
    
    else if (msg.type === 'audio') {
        bubbleClass += " audio-bubble";
    }
    if (msg.type === 'deleted') {
        const deleteText = isMe ? "ğŸš« Ø£Ù†Øª Ø­Ø°ÙØª Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" : "ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
        content = `<span style="font-style: italic; color: #94a3b8; font-size: 13px;">${deleteText}</span>`;
        bubbleClass += " deleted"; 
        
        // âš ï¸ Ù…Ù‡Ù…: Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©ØŒ Ù†Ù„ØºÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©
        reactionHtml = ""; 
        rowStyle = "";
    }
    else if (msg.type === 'story_reply') {
    // ØªØ¬Ù‡ÙŠØ² ÙˆØ³Ù… Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ù„Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØµØºÙŠØ±
    let mediaContent = "";
    if (msg.storyType === 'video') {
        mediaContent = `
            <video src="${msg.storyUrl}#t=0.1" muted></video>
            <div class="video-play-hint"><i class="fa-solid fa-play"></i></div>`;
    } else {
        mediaContent = `<img src="${msg.storyUrl}">`;
    }

    // ğŸ”¥ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø³ØªÙˆØ±ÙŠØ§Øª ØªÙØªØ­:
    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ Ø§Ù„Ù…Ø±Ø³Ù„ (isMe)ØŒ ÙØ§Ù„Ù‚ØµØ© ØªØ®Øµ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±.
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…Ø±Ø³Ù„ØŒ ÙØ§Ù„Ù‚ØµØ© ØªØ®ØµÙ†ÙŠ Ø£Ù†Ø§.
    const storyOwnerUid = isMe ? cachedOtherUserId : currentUserId;

    content = `
        <div class="story-reply-pro-container" onclick="openUserStoryViewer('${storyOwnerUid}')">
            <div class="story-reply-preview">
                <div class="story-reply-media-box">
                    ${mediaContent}
                </div>
                <div class="reply-info-text">
                    <span class="reply-label-top"><i class="fa-solid fa-reply"></i> Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ØµØ©</span>
                    <span class="reply-sub-label">Ø§Ø¶ØºØ· Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù‚ØµØ© ÙƒØ§Ù…Ù„Ø©</span>
                </div>
            </div>
            <div class="story-reply-text-body">
                ${linkify(escapeHtml(msg.text))}
            </div>
        </div>`;
    
    // Ø¬Ø¹Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø´ÙØ§ÙØ© Ù„Ø£Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡Ø§ Ø³ØªØ§ÙŠÙ„Ù‡Ø§ Ø§Ù„Ø®Ø§Øµ
    bubbleClass += " transparent-bubble";
}


    
   else if (msg.type === 'text') { content = formatText(msg.text); }
    else if (msg.type === 'image') { content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`; } 
    // ================= Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¶Ø¹Ù‡ Ø¯Ø§Ø®Ù„ loadMessages Ù…ÙƒØ§Ù† ÙƒÙˆØ¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù‚Ø¯ÙŠÙ… =================
// Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø²Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ loadMessages ÙˆØ§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ø¯Ù‡
else if (msg.type === 'video') {
    const videoUrl = msg.text; 
    const vidId = `vid_${doc.id}`;

    content = `
    <div class="video-msg-wrapper">
        <video id="${vidId}" src="${videoUrl}#t=0.1" preload="metadata" playsinline></video>
        <div class="video-overlay">
            <div class="center-play-btn" onclick="toggleInlinePlay('${vidId}', event)">
                <i class="fa-solid fa-play"></i>
            </div>
            <div class="expand-icon" onclick="event.stopPropagation(); window.openProPlayer('${videoUrl}');">
                <i class="fa-solid fa-expand"></i>
            </div>
        </div>
    </div>`;
    bubbleClass += " media-bubble";
}


// ==========================================================================================
 // ================= ÙƒÙˆØ¯ Ø§Ù„ØªØµÙˆÙŠØª (Poll) =================
else if (msg.type === 'poll') {
    let totalVotes = 0;
    const votesObj = msg.votes || {};
    Object.values(votesObj).forEach(v => totalVotes += v);

    let optionsHtml = '';
    msg.options.forEach((opt) => {
        const count = votesObj[opt] || 0;
        let percent = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
        
        optionsHtml += `
        <div class="poll-option-modern" onclick="handleVote('${doc.id}', '${opt}')">
            <div class="poll-progress-bar" style="width: ${percent}%;"></div>
            <div class="poll-option-content">
                <div style="display:flex; align-items:center;">
                    <div class="poll-radio"></div> <span>${opt}</span>
                </div>
                <span class="poll-percent">${percent}%</span>
            </div>
        </div>`;
    });

    content = `
    <div class="poll-card-modern ${totalVotes > 0 ? 'voted' : ''}">
        <div class="poll-question-modern">${msg.question}</div>
        <div class="poll-options-list">${optionsHtml}</div>
        <div class="poll-footer-modern">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª: ${totalVotes}</span>
            <span>${formatTime(msg.createdAt)}</span>
        </div>
    </div>`;
    
    // Ø¬Ø¹Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø´ÙØ§ÙØ© Ù„Ø£Ù† Ø§Ù„ÙƒØ§Ø±Øª Ù„Ù‡ ØªØµÙ…ÙŠÙ…Ù‡ Ø§Ù„Ø®Ø§Øµ
    bubbleClass += " transparent-bubble";
}
// ================= ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location) - Ø¶ÙŠÙÙ‡ Ø¬ÙˆÙ‡ loadMessages =================
    // ================= ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© =================
    else if (msg.type === 'location') {
        
        // 1. Ø±Ø§Ø¨Ø· Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙŠØ¬ÙŠØ¨ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ø±Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Yandex (Ù…Ø¬Ø§Ù†ÙŠ)
        // Ø¨Ù†Ø¨Ø¹ØªÙ„Ù‡ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (lng, lat) ÙˆØ¨ÙŠØ±Ø¬Ø¹ ØµÙˆØ±Ø©
        const mapPlaceholder = `https://static-maps.yandex.ru/1.x/?lang=en_US&ll=${msg.lng},${msg.lat}&z=16&l=map&size=600,300`;

        // 2. Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨Ø³ Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ÙŠØ¶ØºØ· ÙŠÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø§Ø¨Ø·)
        const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${msg.lat},${msg.lng}`;

        content = `
        <div class="location-msg-card" onclick="window.open('${googleMapsLink}', '_blank')">
            
            <img src="${mapPlaceholder}" class="location-bg-image" alt="Location" 
                 onerror="this.src='https://i.ibb.co/vz0wJqR/map-placeholder.png'"> <div class="map-pin-container">
                <i class="fa-solid fa-location-dot map-pin-icon"></i>
                <div class="map-pin-shadow"></div>
            </div>

            <div class="location-footer">
                <div class="loc-icon-box">
                    <i class="fa-solid fa-map-location-dot"></i>
                </div>
                <div class="loc-text-info">
                    <span class="loc-title">Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ ğŸ“</span>
                    <span class="loc-sub">Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span>
                </div>
            </div>
        </div>`;
        
        // Ø¬Ø¹Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø´ÙØ§ÙØ© Ù„Ø£Ù† Ø§Ù„ÙƒØ§Ø±Øª Ù„Ù‡ ØªØµÙ…ÙŠÙ…Ù‡ Ø§Ù„Ø®Ø§Øµ
        bubbleClass += " transparent-bubble";
    }
// ================= ÙƒÙˆØ¯ ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ) =================
else if (msg.type === 'profile_card') {
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ ÙˆØ¶Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const pImage = msg.profileImage || 'https://i.ibb.co/tZ5tPqB/default-avatar.png';
    
    content = `
    <div class="profile-share-card">
        <div class="psc-header">
            <div class="psc-avatar" style="background-image: url('${pImage}')"></div>
            <div class="psc-info">
                <div class="psc-name">${msg.profileName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>
                <div class="psc-subtitle">Ù…Ù„Ù Ø´Ø®ØµÙŠ ğŸ‘¤</div>
            </div>
        </div>
        <div class="psc-actions">
            <button class="psc-btn psc-btn-primary" onclick="window.location.href='profile.html?uid=${msg.profileUid}'">
                Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            </button>
            <button class="psc-btn psc-btn-secondary" onclick="window.location.href='chat.html?chatId=new&uid=${msg.profileUid}'">
                <i class="fa-regular fa-comment-dots"></i> Ù…Ø±Ø§Ø³Ù„Ø©
            </button>
        </div>
    </div>`;
    
    bubbleClass += " transparent-bubble";
}


// ================= ÙƒÙˆØ¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Contact) =================


else if (msg.type === 'contact') {
    content = `
    <div class="msg-contact-card" onclick="window.location.href='tel:${msg.contactNumber}'">
        <div class="contact-icon-box"><i class="fa-solid fa-user"></i></div>
        <div class="contact-info-box">
            <div class="contact-name-text">${msg.contactName}</div>
            <div class="contact-number-text" dir="ltr">${msg.contactNumber}</div>
        </div>
        <div class="contact-action-btn"><i class="fa-solid fa-phone"></i></div>
    </div>`;
    
    bubbleClass += " transparent-bubble";
}

    else if (msg.type === 'audio') { content = generateAudioPlayer(msg.text, doc.id); }
    else if (msg.type === 'file') { 
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ Ù†Ø¸ÙŠÙ
    let fileName = "Ù…Ù„Ù Ù…Ø±ÙÙ‚";
    try { 
        fileName = decodeURIComponent(msg.text.split('/').pop().split('?')[0].split('_').pop()); 
    } catch(e){}

    content = `
    <div class="file-card" onclick="openDocViewer('${msg.text}', '${fileName}')">
        <div class="file-icon"><i class="fa-solid fa-file-pdf"></i></div>
        <div class="file-info">
            <span class="file-name">${fileName}</span>
            <span class="file-size">Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</span>
        </div>
        <i class="fa-solid fa-eye" style="color:#00e5ff; font-size:12px;"></i>
    </div>`; 
}

 // ================== Ø±Ø³Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙˆØ§Ù„ÙØ®Ù…) ==================
else if (msg.type === 'gift') {
    const giftId = `gift_${doc.id}`;
    
    // ØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© ÙØ®Ù…Ø© Ø£Ù… Ù„Ø§ØŸ
    const isLuxury = msg.giftTier === 'luxury';
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ "luxury-tier" Ù„Ùˆ Ø§Ù„Ù‡Ø¯ÙŠØ© ØºØ§Ù„ÙŠØ©
    const containerClass = isLuxury ? 'gift-interactive-container luxury-tier' : 'gift-interactive-container';

    const giftContent = `
        <div class="magic-gift-content">
            <div class="magic-gift-icon">${msg.giftIcon}</div>
            <div class="magic-gift-name">${msg.giftName}</div>
            <div style="font-size:10px; color:#ddd; margin-top:2px;">${msg.giftPrice} <i class="fa-solid fa-coins"></i></div>
        </div>
    `;

    content = `
    <div id="${giftId}" class="${containerClass}" onclick="toggleMagicGift(this)">
        ${giftContent}
        <div class="gift-package">
            <div class="magic-lid"></div>
            <div class="magic-box"></div>
        </div>
    </div>`;
    
    bubbleClass = "sticker-bubble"; 
}
// ================== ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª (Stickers) ==================
else if (msg.type === 'sticker') {
    // Ø¥Ø²Ø§Ù„Ø© font-size Ù…Ù† Ù‡Ù†Ø§ ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ CSSØŒ ÙˆØ¥Ø²Ø§Ù„Ø© div ÙˆØ¬Ø¹Ù„Ù‡Ø§ span
    content = `<span class="sticker-content">${msg.text}</span>`;
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø´ÙØ§ÙØ©
    bubbleClass += " sticker-bubble transparent-bubble"; 
    
    // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ù„Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    rowStyle = 'margin-bottom: 5px; align-items: center;'; 
}
// ====================================================================

            // (Ù‡Ù†Ø§ ÙŠÙƒÙ…Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…: else if (msg.type === 'call_log') ...)

    else if (msg.type === 'call_log') { content = `<div class="call-card-inner">ğŸ“ ${msg.text === 'no_answer' ? 'Ù…ÙƒØ§Ù„Ù…Ø© ÙØ§Ø¦ØªØ©' : 'Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª'}</div>`; }

    // ================= 6. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¯ (Reply) =================
    let replyHtml = "";
    if (msg.replyTo && msg.type !== 'deleted') {
        let previewText = msg.replyTo.text;
        if(previewText.includes('firebasestorage')) previewText = 'Ù…Ø±ÙÙ‚ ğŸ“';
        
        replyHtml = `
        <div class="replied-msg-context" onclick="handleSearchResultClick('${msg.replyTo.id}')" style="cursor:pointer; padding:5px 8px; border-right:3px solid ${isMe ? '#fff' : 'var(--accent-color)'}; background:rgba(0,0,0,0.2); margin-bottom:5px; border-radius:5px; font-size:11px; display:flex; flex-direction:column; direction:rtl;">
            <div class="replied-sender" style="font-weight:bold; color:${isMe ? '#eee' : 'var(--accent-color)'}; margin-bottom:2px;">${msg.replyTo.sender}</div>
            <div class="replied-body" style="color:#ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${previewText}</div>
        </div>`;
    }

    // ================= 7. Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© =================
    let bombIndicator = "";
    if (msg.selfDestruct && msg.type !== 'deleted') {
        bombIndicator = `
        <div class="bomb-info" style="margin-top: 6px; padding-top:4px; border-top:1px solid rgba(255,255,255,0.1); color: #ff3b30; font-size: 10px; display: flex; align-items: center; gap: 5px; font-weight:bold;">
            <i class="fa-solid fa-bomb fa-beat-fade"></i> 
            <span id="timer_${doc.id}">ØªØ¯Ù…ÙŠØ± Ø®Ù„Ø§Ù„: ${Math.ceil(msg.selfDestruct)}Ø«</span>
        </div>`;
    }

    // ================= 8. Ù…Ø¤Ø´Ø± Ø§Ù„Ø³ÙŠÙ† ÙˆØ§Ù„ÙˆÙ‚Øª =================
    let eyeHtml = '';
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹ÙŠÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„ØªÙŠ + ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ© + (ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§ Ø£Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†)
    if (isMe && msg.type !== 'deleted') {
         if (msg.seen && doc.id === lastSeenMsgId) { // Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù‚Ø±ÙˆØ¡Ø© ÙÙ‚Ø·
             const otherUser = userCache[cachedOtherUserId]; 
             const otherPic = otherUser ? (otherUser.profilePic || otherUser.avatar) : '';
             if (otherPic) eyeHtml = `<div class="seen-avatar-icon" style="background-image: url('${otherPic}'); width:14px; height:14px; margin-right:5px; border-color:rgba(255,255,255,0.3);"></div>`;
         } 
         else if (!msg.seen) {
             const headerStatus = document.getElementById('headerStatus');
             const isOnline = headerStatus && (headerStatus.innerText.includes('Ù†Ø´Ø·') || headerStatus.innerText.includes('Ù…ØªØµÙ„'));
             eyeHtml = isOnline ? '<i class="fa-solid fa-circle-check" style="color:#3b82f6; font-size:12px;"></i>' : '<i class="fa-regular fa-circle-check" style="color:rgba(255,255,255,0.3); font-size:12px;"></i>';
         }
    }

    const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
    const miniAvatar = `<div class="msg-user-avatar" onclick="openUserPopup('${msg.uid}')" style="background-image: url('${u.profilePic}'); background-color:${u.color}; cursor:pointer;">${u.profilePic?'':u.char}</div>`;
    
    let isSameSender = (prevMsg && prevMsg.uid === msg.uid && prevMsg.type !== 'deleted' && msg.type !== 'deleted');

    // ================= 9. Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø±Ø³Ù…Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!) =================
                    // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ØºÙŠØ±Ù†Ø§ newHtml Ù„Ù€ html
                html += `
                <div class="msg-row ${isMe ? 'sender' : 'receiver'} ${isSameSender ? 'same-sender' : ''}" id="msg_${doc.id}" style="${rowStyle}">
                    ${!isMe ? miniAvatar : ''}
                    
                    <div class="${bubbleClass}" style="position: relative;">
                        
                        ${!isMe && !isSameSender ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
                        
                        ${replyHtml} <div>${content}</div> ${bombIndicator} ${reactionHtml}

                        ${msg.type !== 'deleted' ? `
                            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                                <span class="msg-time">${timeText}</span>
                                ${eyeHtml} 
                            </div>` 
                        : ''}
                    </div>
                </div>`;
                
                prevMsg = msg;
            }); // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù€ forEach

// Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¹Ø±Ø¶ ÙƒÙ„ Ø­Ø§Ø¬Ø©
container.innerHTML = html;


        // ============================================================
        // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„: Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙˆØ±Ø§Ù‹ ğŸ”¥
        // ============================================================
        
        if (isFirstLoad) {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø´Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 300);
        } else {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ø´Ø§Øª Ù…ÙØªÙˆØ­ ÙˆØ±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØµÙ„Øª
            // Ù†ØªØ­Ù‚Ù‚ Ù‡Ù„ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ± "Ø¥Ø¶Ø§ÙØ©" (Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©) ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ
            const hasNewMessage = snap.docChanges().some(change => change.type === 'added');

            if (hasNewMessage) {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
                const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;

                // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ (Ø£Ù‚Ù„ Ù…Ù† 500 Ø¨ÙƒØ³Ù„) Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§ÙŠØ© Ù…Ù†ÙŠ Ø£Ù†Ø§
                // Ù†Ø¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ù†Ø§Ø¹Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ¸Ù‡Ø±
                if (distanceFromBottom < 500) {
                    setTimeout(() => {
                        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                    }, 100);
                } else {
                    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¸Ù‡Ø± Ø²Ø±Ø§Ø± ØµØºÙŠØ± "ÙŠÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„"
                    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù† Ø¨ÙŠÙ‚Ø±Ø£ Ø±Ø³Ø§ÙŠÙ„ Ù‚Ø¯ÙŠÙ…Ø© ÙÙˆÙ‚
                    const scrollBtn = document.getElementById("scrollToBottomBtn");
                    if(scrollBtn) scrollBtn.style.display = "flex";
                }
            }
        }

        // ============================================================
        // ğŸ’£ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØªÙˆØ± (Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ) ÙƒÙ…Ø§ Ù‡Ùˆ ğŸ’£
        // ============================================================
        destructQueue.forEach(item => {
            const timerSpan = document.getElementById(`timer_${item.id}`);
            const msgRow = document.getElementById(`msg_${item.id}`);
            let seconds = Math.floor(item.timeLeft / 1000);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            if(timerSpan) timerSpan.innerText = `ØªØ¯Ù…ÙŠØ± Ø®Ù„Ø§Ù„: ${seconds}Ø«`;

            const interval = setInterval(() => {
                seconds--;
                if(timerSpan) timerSpan.innerText = `ØªØ¯Ù…ÙŠØ± Ø®Ù„Ø§Ù„: ${seconds}Ø«`;
                
                // === Ù„Ø­Ø¸Ø© Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± ===
                if (seconds <= 0) {
                    clearInterval(interval);
                    
                    if(msgRow) {
                        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¹Ø´Ø§Ù† Ù†ØºÙŠØ± Ø´ÙƒÙ„Ù‡Ø§
                        const bubble = msgRow.querySelector('.target-bubble');
                        
                        // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø®Øµ
                        const explodedText = item.isMe ? "ğŸ’¥ Ù„Ù‚Ø¯ ÙØ¬Ø±Øª Ø±Ø³Ø§Ù„Ø©" : "ğŸ’¥ Ù„Ù‚Ø¯ ÙØ¬Ø± Ø±Ø³Ø§Ù„Ø©";

                        // 3. ØªØºÙŠÙŠØ± Ø§Ù„Ø³ØªØ§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰
                        if(bubble) {
                            // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù‡Ø²Ø© Ø¨Ø³ÙŠØ·Ø©
                            msgRow.style.animation = "shake 0.5s ease-in-out"; 
                            
                            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù Ø§Ùˆ Ø§Ø­Ù…Ø± Ø®ÙÙŠÙ
                            bubble.style.background = "rgba(255, 59, 48, 0.15)";
                            bubble.style.border = "1px dashed rgba(255, 59, 48, 0.5)";
                            bubble.style.color = "#ff3b30";
                            bubble.style.textAlign = "center";
                            bubble.style.minWidth = "150px";
                            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¸Ù„Ø§Ù„ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                            bubble.style.boxShadow = "none";
                            
                            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                            bubble.innerHTML = `<span style="font-weight:bold; font-size:13px;">${explodedText}</span>`;
                        }
                        
                        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±
                        setTimeout(() => {
                            if(msgRow) {
                                msgRow.style.transition = "opacity 0.5s, height 0.5s";
                                msgRow.style.opacity = "0";
                                msgRow.style.height = "0";
                                setTimeout(() => msgRow.remove(), 500);
                            }
                        }, 3000);
                    }
                }
            }, 1000);
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§ÙŠÙ…Ø± Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†ÙˆÙ‚ÙÙ‡ Ù„Ùˆ Ø®Ø±Ø¬Ù†Ø§
            if (typeof activeTimers !== 'undefined') activeTimers.push(interval);
        });

        // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø²ÙŠØ§Ø¯Ø© Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ (50 Ø¨ÙƒØ³Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 0)
// Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ (ÙÙˆÙ‚ ÙˆØªØ­Øª)
container.onscroll = () => {
    // 1. Ù„Ùˆ Ø¨Ù†Ø·Ù„Ø¹ Ù„ÙÙˆÙ‚ (Ø¹Ø§ÙŠØ²ÙŠÙ† Ù‚Ø¯ÙŠÙ…)
    if (container.scrollTop <= 50 && !isLoadingOld) {
        loadMoreHistory();
    }

    // 2. Ù„Ùˆ Ø¨Ù†Ù†Ø²Ù„ Ù„ØªØ­Øª (Ø¹Ø§ÙŠØ²ÙŠÙ† Ø¬Ø¯ÙŠØ¯) - Ø¯ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§
    if (isArchiveMode) {
        loadMoreNewerMessages();
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„
    const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
    if (distanceFromBottom > 300) {
        document.getElementById("scrollToBottomBtn").style.display = "flex";
    } else {
        document.getElementById("scrollToBottomBtn").style.display = "none";
    }
};
        // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events) Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¹Ù†Ø§ØµØ± (Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…)
container.querySelectorAll('.msg-row').forEach((row) => { 
     const id = row.id.replace('msg_', '');
     
     // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù…ÙƒÙ† Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ù€ HTML Ù„Ùˆ Ø§Ù„Ù€ snap Ù…Ø´ Ø´Ø§ÙŠÙ„Ù‡Ø§
     // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù‡Ù†ÙØªØ±Ø¶ Ø¥Ù† Ø§Ù„Ù€ snap Ù…ÙˆØ¬ÙˆØ¯
     const doc = snap.docs.find(d => d.id === id);
     
     const bubble = row.querySelector('.target-bubble');
     
     if(bubble && doc) { 
         let mData = doc.data(); 
         if(userCache[mData.uid]) mData.senderName = userCache[mData.uid].name;

         // 1. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
         attachLongPress(bubble, mData, doc.id); 
         
         // 2. ğŸ”¥ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…ÙˆØ­Ø¯ (ÙŠÙ…ÙŠÙ† ÙˆØ´Ù…Ø§Ù„) ğŸ”¥
         enableUnifiedSwipe(row, bubble, mData, doc.id);
     } 
});

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ£Ù†Ø§ Ù…Ø´ Ø¨Ø§Ø¹ØªÙ‡Ø§
        if(!isFirstLoad) {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const d = change.doc.data();
                    if (d.uid !== currentUserId) alertSound.play().catch(()=>{});
                }
            });
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª (Metadata Duration)
        document.querySelectorAll('audio').forEach(audio => { 
            audio.onloadedmetadata = function() { 
                const id = this.id.split('_')[1]; 
                const dur = document.getElementById(`dur_${id}`); 
                if(dur) dur.innerText = formatTimeSec(this.duration); 
            }; 
        });
        // Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ (Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± Ù„Ø£Ù†Ù†Ø§ Ù„ØºÙŠÙ†Ø§ Ø§Ù„Ù€ smooth)
if (isFirstLoad) {
    container.scrollTop = container.scrollHeight;
    
    // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØ± Ø¨ØªØ­Ù…Ù„
    requestAnimationFrame(() => {
        container.scrollTop = container.scrollHeight;
    });
}

        isFirstLoad = false;
    });
}

async function loadMoreHistory() {
    if (!oldestDoc || isLoadingOld) return;
    isLoadingOld = true;

    const container = document.getElementById("chatContainer");
    
    // Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const oldHeight = container.scrollHeight; 
    const oldScrollTop = container.scrollTop; // Ø¹Ø§Ø¯Ø©Ù‹ Ø³ÙŠÙƒÙˆÙ† 0

    try {
        const snap = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "asc")
            .endBefore(oldestDoc)
            .limitToLast(20)
            .get();

        if (!snap.empty) {
    oldestDoc = snap.docs[0];
            
            let newHtml = "";
            if (snap.docs.length < 20 && !document.querySelector('.chat-end-card')) {
                const otherUser = userCache[cachedOtherUserId] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…' };
                newHtml += `
                    <div class="chat-end-card" style="margin-bottom: 30px; margin-top: 10px;">
                        <div class="cec-avatar" style="background-image: url('${otherUser.profilePic || 'https://i.ibb.co/tZ5tPqB/default-avatar.png'}');"></div>
                        <div class="cec-name">
                            ${otherUser.name}
                            ${otherUser.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#00e5ff; font-size:14px;"></i>' : ''}
                        </div>
                        <div class="cec-sub">Ù‡Ø°Ù‡ Ù‡ÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${otherUser.name}</div>
                        <button class="cec-btn" onclick="navigateToUserProfile()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
                    </div>`;
            }
            let prevMsg = null;
            let lastDate = null;

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const uids = new Set();
            snap.docs.forEach(d => uids.add(d.data().uid));
            await Promise.all(Array.from(uids).map(uid => getUser(uid)));

            // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            snap.forEach(doc => {
                const msg = doc.data();
                const isMe = msg.uid === currentUserId;
                const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };

                // ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
                const msgDate = msg.createdAt ? msg.createdAt.toDate() : new Date();
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ù†Ø·Ù‚ ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù„Ø¶Ø¨Ø· Ø¯Ù‚ÙŠÙ‚ØŒ Ù„ÙƒÙ† Ù‡Ø°Ø§ Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ
                if (!lastDate || !isSameDay(msgDate, lastDate)) {
                    newHtml += `<div class="date-divider"><span>${formatDateSticky(msgDate)}</span></div>`;
                    lastDate = msgDate;
                    prevMsg = null;
                }

                // === Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† Ù†Ø§Ù‚ØµØ§Ù‹ Ù„Ø¯ÙŠÙƒ) ===
                let content = "";
                let bubbleClass = "msg-bubble target-bubble"; 


                if (msg.type === 'deleted') {
                    content = `<span style="font-style: italic; color: #94a3b8; font-size: 13px;">${isMe ? "ğŸš« Ø£Ù†Øª Ø­Ø°ÙØª Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" : "ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"}</span>`;
                    bubbleClass += " deleted"; 
                }
                else if (msg.type === 'text') { content = linkify(escapeHtml(msg.text)); }
                else if(msg.type === 'image') { content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`; } 
                else if(msg.type === 'video') { content = `<div class="media-container" onclick="toggleVideo(this)"><video src="${msg.text}" class="msg-video" playsinline loop></video><div class="video-play-overlay"><div class="play-circle"><i class="fa-solid fa-play"></i></div></div></div>`; } 
                else if(msg.type === 'audio') { content = generateAudioPlayer(msg.text, doc.id); }
                else if(msg.type === 'file') { content = `<div class="file-card" onclick="window.open('${msg.text}', '_blank')"><div class="file-icon"><i class="fa-solid fa-file-lines"></i></div><div class="file-info"><span class="file-name">Ù…Ù„Ù Ù…Ø±ÙÙ‚</span><span class="file-size">ØªØ­Ù…ÙŠÙ„</span></div></div>`; }
                else if (msg.type === 'call_log') { content = `<div class="call-card-inner">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø©</div>`; }
                                else             // ================= 4. Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ) =================
            if (msg.type === 'system') {
                let actionText = "";
                let showName = true; // Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø§Ø³Ù…
                
                // ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ù†Øµ
                if (msg.text === 'ghost_on') {
                    actionText = 'Ù‚Ø§Ù… Ø¨ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»';
                } else if (msg.text === 'ghost_off') {
                    actionText = 'Ù‚Ø§Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸš«';
                } 
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµØ¯Ø§Ù‚Ø© (Ø³ÙˆØ§Ø¡ ÙƒÙˆØ¯ Ø£Ùˆ Ù†Øµ)
                else if (msg.text === 'request_accepted' || msg.text.includes('Ø£ØµØ¨Ø­Ù†Ø§ ØµØ¯ÙŠÙ‚ÙŠÙ†')) { 
                    actionText = 'ğŸ‰ Ù„Ù‚Ø¯ Ø£ØµØ¨Ø­Ù†Ø§ ØµØ¯ÙŠÙ‚ÙŠÙ†ØŒ Ø§ÙƒØ³Ø±ÙˆØ§ Ø­Ø§Ø¬Ø² Ø§Ù„ØµÙ…Øª!';
                    showName = false; // ğŸ‘ˆ Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ù†Ù„ØºÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø§Ø³Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                } else {
                    actionText = msg.text;
                    // Ù„Ùˆ Ø§Ù„Ù†Øµ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ±Ø­ÙŠØ¨ Ø¹Ø§Ù…ØŒ Ù†Ø®ÙÙŠ Ø§Ù„Ø§Ø³Ù… Ø£ÙŠØ¶Ø§Ù‹
                    if(actionText.includes('Ø­Ø§Ø¬Ø² Ø§Ù„ØµÙ…Øª')) showName = false;
                }

                // ØªØ¬Ù‡ÙŠØ² ÙƒÙˆØ¯ Ø§Ù„Ø§Ø³Ù… (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ showName = true)
                let nameHtml = showName ? `<span class="system-user-name" style="margin-right:5px;">(${u.name})</span>` : '';

                html += `<div class="system-msg-row" id="msg_${doc.id}"><span class="system-msg-text">${actionText} ${nameHtml}</span></div>`;
                return; 
            }
           const eyeHtml = getEyeStatusHTML(msg, isMe);
                const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
                // âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© onclick Ùˆ cursor:pointer
const miniAvatar = `<div class="msg-user-avatar" onclick="openUserPopup('${msg.uid}')" style="background-image: url('${u.profilePic}'); background-color:${u.color}; cursor: pointer;">${u.profilePic?'':u.char}</div>`;
                
                let isSameSender = (prevMsg && prevMsg.uid === msg.uid && prevMsg.type !== 'deleted' && msg.type !== 'deleted');

                newHtml += `
                <div class="msg-row ${isMe ? 'sender' : 'receiver'} ${isSameSender ? 'same-sender' : ''}" id="msg_${doc.id}">
                    ${!isMe ? miniAvatar : ''}
                    <div class="${bubbleClass}">
                        ${!isMe && !isSameSender ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
                        <div>${content}</div>
                        ${msg.type !== 'deleted' ? `
                            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                                <span class="msg-time">${timeText}</span>
                                ${eyeHtml} 
                            </div>` 
                        : ''}
                    </div>
                </div>`;
                
                prevMsg = msg;
            });
container.insertAdjacentHTML('afterbegin', newHtml);

// Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§)
container.querySelectorAll('.msg-row').forEach((row) => {
     const id = row.id.replace('msg_', '');
     
     // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ snap Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ù„Ù„ØªÙˆ
     const doc = snap.docs.find(d => d.id === id);
     
     if (doc) {
         const msgData = doc.data();
         // Ù†ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ø¹Ø´Ø§Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ØªØ´ØªØºÙ„ ØµØ­
         if(userCache[msgData.uid]) msgData.senderName = userCache[msgData.uid].name;

         const bubble = row.querySelector('.target-bubble');
         
         if(bubble) { 
             // 1. ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Swipe)
             attachSwipeReaction(row, msgData, id); 

             // 2. ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Context Menu)
             attachLongPress(bubble, msgData, id); 
         } 
     }
});
}
    } catch (e) {
        console.log("No more history or error", e);
    }

    isLoadingOld = false;
}

// Ø¶ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù€ Scrip
        // ================= Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª =================
        function toggleAudio(id, event) {
            if (event) event.stopPropagation();
            const audio = document.getElementById(`audio_${id}`);
            const btnIcon = document.querySelector(`#btn_${id} i`);

            if (audio.paused) {
                document.querySelectorAll('audio').forEach(a => { if (a !== audio) { a.pause(); } });
                audio.play();
                btnIcon.className = "fa-solid fa-pause";
            } else {
                audio.pause();
                btnIcon.className = "fa-solid fa-play";
            }
        }

        function generateAudioPlayer(url, id) {
            return `
            <div class="custom-audio-player" onclick="event.stopPropagation()">
                <button class="play-btn" id="btn_${id}" onclick="toggleAudio('${id}', event)">
                    <i class="fa-solid fa-play"></i>
                </button>
                <input type="range" class="audio-slider" id="range_${id}" value="0" oninput="seekAudio('${id}'); event.stopPropagation();">
                <span id="dur_${id}" style="font-size:10px; color:#ccc;">00:00</span>
                <audio id="audio_${id}" src="${url}" ontimeupdate="updateAudioProgress('${id}')" onended="resetAudio('${id}')"></audio>
            </div>`;
        }

        function updateAudioProgress(id) { const a=document.getElementById(`audio_${id}`); document.getElementById(`range_${id}`).value=(a.currentTime/a.duration)*100; }
        function seekAudio(id) { const a=document.getElementById(`audio_${id}`); a.currentTime=(document.getElementById(`range_${id}`).value/100)*a.duration; }
        function resetAudio(id) { document.querySelector(`#btn_${id} i`).className="fa-solid fa-play"; document.getElementById(`range_${id}`).value=0; }

        function attachLongPress(element, msgData, msgId) { let timer; const start = () => { timer = setTimeout(() => openContextMenu(msgData, msgId), 600); }; const end = () => clearTimeout(timer); element.addEventListener('touchstart', start); element.addEventListener('touchend', end); element.addEventListener('mousedown', start); element.addEventListener('mouseup', end); }
        
        function openContextMenu(data, id) { 
            if(navigator.vibrate) navigator.vibrate(50); 
            selectedMsgId = id; selectedMsgData = data; 
            const isMyMsg = data.uid === currentUserId; 
            document.getElementById('menuDeleteAllBtn').style.display = isMyMsg ? 'flex' : 'none'; 
            document.getElementById('menuSaveBtn').style.display = (data.type==='image'||data.type==='video')?'flex':'none'; 
            document.getElementById('menuCopyBtn').style.display = (data.type==='text')?'flex':'none'; 
            document.getElementById('menuListenBtn').style.display = (data.type === 'audio') ? 'flex' : 'none';
            document.getElementById('contextMenuOverlay').style.display='flex'; 
            setTimeout(()=>document.getElementById('contextMenu').classList.add('active'),10); 
        }

        function closeContextMenu() { document.getElementById('contextMenu').classList.remove('active'); setTimeout(()=>document.getElementById('contextMenuOverlay').style.display='none',300); }
        
        function playMessageAudio() { if (!selectedMsgData || selectedMsgData.type !== 'audio') return; document.querySelectorAll('audio').forEach(a => { a.pause(); }); const audio = new Audio(selectedMsgData.text); audio.play(); closeContextMenu(); }

        async function toggleReaction(emoji) { 
            if(!selectedMsgId) return; 
            const ref = db.collection("chats").doc(chatId).collection("messages").doc(selectedMsgId); 
            try { const doc = await ref.get(); if(doc.exists) { if(doc.data().reaction === emoji) await ref.update({reaction: firebase.firestore.FieldValue.delete()}); else await ref.update({reaction: emoji}); showToast("ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„"); } } catch(e) {}
            closeContextMenu(); 
        }

        // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¯ÙŠ ÙÙˆØ±Ø§Ù‹
async function sendMessage() { 
    
    playUiSound('sent');
    const inp = document.getElementById("messageInput"); 
    const val = inp.value.trim(); 
    
    if(!val) return; 
        // Ø¶ÙŠÙ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ù‡ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if (isTypingStatus) {
        isTypingStatus = false;
        clearTimeout(typingTimeout); // Ø§Ù„ØºÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ø´Ø§Ù† Ù…ÙŠÙ…Ø³Ø­Ø´ ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ÙŠÙ†
        
        // Ø§Ù…Ø³Ø­ Ø§Ø³Ù…Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© "ÙŠÙƒØªØ¨" ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        db.collection("chats").doc(chatId).update({ 
            typing: firebase.firestore.FieldValue.arrayRemove(currentUserId) 
        }).catch(()=>{});
    }


    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let msgPayload = { 
        text: val, 
        uid: currentUserId, 
        type: 'text',
        seen: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        
        // ğŸ”¥ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø­Ø±ÙŠØ©: Ø®ØªÙ… Ø§Ù„Ø´Ø¨Ø­
        isGhost: isGhostMode // Ù„Ùˆ Ø§Ù„ÙˆØ¶Ø¹ Ø´ØºØ§Ù„ØŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ Ù‡ØªØ¨Ù‚Ù‰ Ù…Ù…ÙŠØ²Ø©
    }; 

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ (Ù„Ùˆ Ù…ÙØ¹Ù„)
    if (destructTime > 0) { 
        msgPayload.selfDestruct = destructTime; 
        msgPayload.expireAt = firebase.firestore.Timestamp.fromMillis(Date.now() + (destructTime * 1000)); 
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø¯
   if(currentReply) {
        msgPayload.replyTo = { 
            id: currentReply.id, 
            text: currentReply.text, 
            sender: currentReply.sender 
        }; 
    }

    await ensureChatActive();
    // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙƒÙˆÙ„ÙƒØ´Ù†)
    await db.collection("chats").doc(chatId).collection("messages").add(msgPayload); 
    
    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // (Ù‡Ù†Ø§ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØ±Ø¬Ø¹ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¸Ù‡ÙˆØ±)
    if (cachedOtherUserId && !isGhostMode) { 
        await db.collection("chats").doc(chatId).set({ 
            lastMessage: val, 
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
            sentTo: cachedOtherUserId, 
            senderId: currentUserId, 
            seen: false, 
            unreadCount: firebase.firestore.FieldValue.increment(1),
            
            // ====================================================
            // ğŸ‘‡ğŸ‘‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ğŸ‘‡ğŸ‘‡
            // ====================================================
            deletedBy: [],   // Ø¨ÙŠÙØ¶ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† ÙØ§Ù„Ø´Ø§Øª ÙŠØ¸Ù‡Ø± ØªØ§Ù†ÙŠ
            archivedBy: []   // Ø¨ÙŠÙØ¶ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ù„Ø´Ø§Øª ÙŠØ±Ø¬Ø¹ Ù„Ù„Ø¥Ù†Ø¨ÙˆÙƒØ³
            // ====================================================

        }, { merge: true }); 
    } 
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚Ù„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
    inp.value = ""; 
    inp.style.height = 'auto'; 
    toggleSendButton(); 
    cancelReply(); 
    setTimeout(scrollToBottom, 100); 
}

async function purgeGhostMessages() {
    if (!chatId || !currentUserId) return;

    try {
        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø¨Ø­ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§Øª
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .where("uid", "==", currentUserId)
            .where("isGhost", "==", true) // Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø³Ø­Ø±ÙŠ
            .get();

        if (snapshot.empty) return; // Ù…ÙÙŠØ´ Ø±Ø³Ø§ÙŠÙ„ØŒ Ø§Ø·Ù„Ø¹

        // 2. Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Batch Delete)
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref); // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Delete) Ù…Ø´ ØªØ­Ø¯ÙŠØ« (Update)
        });

        await batch.commit();
        showToast("ğŸ’¨ Ø§Ø®ØªÙØª Ø¢Ø«Ø§Ø± Ø§Ù„Ø´Ø¨Ø­");

    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø¨Ø­:", e);
    }
}

        
        function openLb(src) { document.getElementById('lb-img').src=src; document.getElementById('lightbox').style.display='flex'; }
        function closeLightbox() { document.getElementById('lightbox').style.display='none'; }
        
        function escapeHtml(t) { return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function formatTime(t) { return t.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }); }
        function formatTimeSec(s) { if(isNaN(s)) return "00:00"; const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc.toString().padStart(2,'0')}`; }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.style.opacity='1'; t.style.bottom='90px'; setTimeout(()=>{t.style.opacity='0'; t.style.bottom='80px';},2000); }
        function copyText() { if(selectedMsgData?.type==='text') { navigator.clipboard.writeText(selectedMsgData.text); showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); } closeContextMenu(); }
        function saveMedia() { if(selectedMsgData?.text) { const a = document.createElement('a'); a.href = selectedMsgData.text; a.download = 'Media'; a.target='_blank'; a.click(); } closeContextMenu(); }
        function deleteMessageLocal() { if(selectedMsgId) document.getElementById(`msg_${selectedMsgId}`).style.display='none'; closeContextMenu(); }

        // ================= Ø§Ù„ØªØ³Ø¬ÙŠÙ„ =================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (ØµÙˆØª + Ø¶ÙˆØ¡ Ø£Ø­Ù…Ø±)

async function startRecording() { 
    try { 
        // 1. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¨Ø¯Ø¡ ÙÙˆØ±Ø§Ù‹
        playUiSound('record'); 

        // 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ù†Ø¨Ø¶
        const btn = document.getElementById('micBtn');
        btn.classList.add('recording-active'); // ğŸ‘ˆ Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ®Ù„ÙŠÙ‡Ø§ ØªÙ†ÙˆØ± Ø£Ø­Ù…Ø±
        btn.innerHTML = '<i class="fa-solid fa-stop"></i>'; // ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù…Ø±Ø¨Ø¹

        const s = await navigator.mediaDevices.getUserMedia({audio:true}); 
        mediaRecorder = new MediaRecorder(s); 
        audioChunks = []; 
        
        document.getElementById("recordingUI").style.display = "flex"; 
        
        seconds = 0; 
        document.getElementById("recordTimer").innerText = "00:00";
        clearInterval(recordInterval);
        
        recordInterval = setInterval(() => { 
            seconds++; 
            document.getElementById("recordTimer").innerText = `00:${seconds.toString().padStart(2,'0')}`; 
        }, 1000); 
        
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.start(); 

    } catch(e){ 
        alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†"); 
        // Ù„Ùˆ ÙØ´Ù„ØŒ Ù†Ù„ØºÙŠ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
        document.getElementById('micBtn').classList.remove('recording-active');
    } 
}

function stopAndSendRecording() { 
    // 1. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù†ÙØ³ ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
    playUiSound('sent');

    // 2. Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
    const btn = document.getElementById('micBtn');
    btn.classList.remove('recording-active');
    btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; // Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø§ÙŠÙƒ

    if(!mediaRecorder || mediaRecorder.state === "inactive") return; 
    mediaRecorder.stop(); 
    
    mediaRecorder.onstop = async () => { 
        clearInterval(recordInterval); 
        document.getElementById("recordingUI").style.display = "none"; 
        const b = new Blob(audioChunks, { type:'audio/mp4' }); 
        
        // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø±ÙØ¹ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
        const ref = storage.ref(`voice_notes/${Date.now()}.m4a`); 
        try { 
            showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...");
            await ref.put(b); const u = await ref.getDownloadURL(); 
            let msgPayload = {
    text: u, 
    uid: currentUserId, 
    type: 'audio', 
    seen: false, // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‡Ù†Ø§
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
}; 
if (destructTime > 0) { 
                msgPayload.selfDestruct = destructTime; 
                msgPayload.expireAt = firebase.firestore.Timestamp.fromMillis(Date.now() + (destructTime * 1000)); 
            }
            await db.collection("chats").doc(chatId).collection("messages").add(msgPayload); 
            cancelReply(); 
        } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); } 
    } 
}

function cancelRecording() { 
    // ØµÙˆØª Ø¥Ù„ØºØ§Ø¡ (ØªÙƒØ©)
    playUiSound('destruct'); 

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
    const btn = document.getElementById('micBtn');
    btn.classList.remove('recording-active');
    btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';

    clearInterval(recordInterval); 
    if(mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.onstop = null; // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        mediaRecorder.stop(); 
    }
    document.getElementById("recordingUI").style.display = "none"; 
}

        // ================= Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª =================
        let localStream = null, peerConnection = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£ØµÙˆØ§Øª
const ringOut = document.getElementById('ringtoneOut');
const ringIn = document.getElementById('ringtoneIn');
const endSound = document.getElementById('callEndSound');
let callTimerInterval = null;
let incomingOffer = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù„Ø­Ø¯ Ù…Ø§ ØªØ±Ø¯

// 1. Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (Sender)
async function initiateCall() {
    // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (ØªÙˆØª.. ØªÙˆØª..)
var ringOut = document.getElementById('ringtoneOut');
if (ringOut) {
    ringOut.currentTime = 0;
    ringOut.play().catch(e => console.log("Audio play blocked"));
}
playSmartRingtone('outgoing');
    monitorRemoteState();
    await clearCandidates();
    
    // 1. ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ø´ØºÙˆÙ„ØŸ
    try {
        const callDoc = await db.collection('chats').doc(chatId).collection('calls').doc('active_call').get();
        
        if (callDoc.exists) {
            alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ØºÙˆÙ„ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© Ø£Ø®Ø±Ù‰ Ø­Ø§Ù„ÙŠØ§Ù‹");
            return; 
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:", error);
    }

    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setupCallUI('outgoing');
    document.getElementById('callAvatar').classList.add('calling-pulse');

    // ØªØ£Ù…ÙŠÙ†: Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø£Ù†Ù†Ø§ Ø¨Ù†Ø¨Ø¯Ø£ Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©
    const switchBtn = document.getElementById('switchCamBtn');
    if(switchBtn) switchBtn.style.display = 'none';
    
    try {
        // ================= Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Pro Audio Setup) =================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ¹Ø²Ù„ Ø¶ÙˆØ¶Ø§Ø¡ (Ø²ÙŠ Ù…Ø§Ø³Ù†Ø¬Ø±)
        const audioConstraints = {
            echoCancellation: true,       // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            noiseSuppression: true,       // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
            autoGainControl: true,        // Ø¶Ø¨Ø· Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ù…ØªØµÙØ­Ø§Øª ÙƒØ±ÙˆÙ… (Google WebRTC) Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø¡
            googEchoCancellation: true,
            googAutoGainControl: true,
            googNoiseSuppression: true,
            googHighpassFilter: true      // ÙÙ„ØªØ± Ù„ØªÙ†Ù‚ÙŠØ© Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„ØªØ±Ø¯Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
        };

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        localStream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });
        // =======================================================================
        
        // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        const ringOut = document.getElementById('ringtoneOut');
        if (ringOut) {
            ringOut.currentTime = 0; 
            ringOut.play().catch(e => console.log("Audio play blocked"));
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ØªØµØ§Ù„ WebRTC
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // ================= Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ù…Ø©: ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø¨ÙƒØ© =================
        // Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØ®Ù„ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙƒØªØ¨ "Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„" Ù„Ùˆ Ø§Ù„Ù†Øª ÙØµÙ„
        monitorConnectionState(); 
        // =================================================================
        
        listenForRemoteCandidates();

        // Ø¥Ø¶Ø§ÙØ© ØµÙˆØªÙŠ Ù„Ù„Ø§ØªØµØ§Ù„
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
        peerConnection.ontrack = (event) => {
    const stream = event.streams[0];
    
    // Ù„Ùˆ ØµÙˆØª
    if (event.track.kind === 'audio') {
        document.getElementById('remoteAudio').srcObject = stream;
        handleCallConnected(event);
    }

    // Ù„Ùˆ ÙÙŠØ¯ÙŠÙˆ (Ù‡Ù†Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡)
    if (event.track.kind === 'video') {
        // Ø¨Ù†ÙØ­Øµ Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        // Ù„Ùˆ Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯Ù‡ Ø£ÙƒÙŠØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
        const videoTracks = stream.getVideoTracks();
        
        /* Ù…Ù„Ø§Ø­Ø¸Ø©: WebRTC Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø¨ÙŠØ¨Ø¹Øª Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Stream Ù…Ù†ÙØµÙ„ Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù€ Stream.
           Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¶Ù…Ù†: Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ remoteVideoØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¯Ù‡ Ù‡Ùˆ Ø§Ù„Ø´Ø§Ø´Ø©.
        */
        const remoteVideo = document.getElementById('remoteVideo');
        const remoteScreen = document.getElementById('remoteScreenVideo');
        const container = document.getElementById('videoContainer');
        const bg = document.getElementById('callBg');

        // Ù†Ø¸Ù‡Ø± Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙˆÙ†Ø®ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        container.style.display = 'block';
        bg.style.display = 'none';

        if (!remoteVideo.srcObject) {
            // Ø¯Ù‡ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
            remoteVideo.srcObject = stream;
        } else {
            // Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„Ø´Ø§Ø´Ø©!)
            // Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ø´ Ù†ÙØ³ Ø§Ù„ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (remoteVideo.srcObject.id !== stream.id) {
                remoteScreen.srcObject = stream;
                remoteScreen.style.display = 'block';
                
                // Ù†ÙØ¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù€ Presentation (Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØµØºØ± ÙˆØ§Ù„Ø´Ø§Ø´Ø© ØªÙƒØ¨Ø±)
                container.classList.add('presentation-mode');

                // Ù„Ù…Ø§ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚ÙÙ„ (Track Ended)ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                event.track.onended = () => {
                    remoteScreen.style.display = 'none';
                    remoteScreen.srcObject = null;
                    container.classList.remove('presentation-mode');
                };
            }
        }
    }
};


        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª (Candidates)
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.collection('chats').doc(chatId).collection('callCandidates').add(event.candidate.toJSON());
            }
        };

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ (Offer)
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').set({
            offer: { type: offer.type, sdp: offer.sdp },
            callerId: currentUserId,
            status: 'ringing',
            startTime: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        if (noAnswerTimeout) clearTimeout(noAnswerTimeout); // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ù‚Ø¯ÙŠÙ…
noAnswerTimeout = setTimeout(() => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø³Ù‡ "Ø¨ØªØªØµÙ„"
    db.collection('chats').doc(chatId).collection('calls').doc('active_call').get().then(doc => {
        if(doc.exists && doc.data().status === 'ringing') {
            // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯"
            endCall(); 
            showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ğŸ“µ");
        }
    });
}, 30000); // 30000 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = 30 Ø«Ø§Ù†ÙŠØ©
listenForCallUpdates(); // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
makeVideoDraggable(); 
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯
        listenForAnswer();

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
        closeCallUI();
    }
}

// 2. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Receiver Listener)
function listenForIncomingCalls() {
    
    // ØªØ´ØºÙŠÙ„ Ø±Ù†Ø© Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (ØªØ±Ø±Ø±Ù†.. ØªØ±Ø±Ø±Ù†..)
var ringIn = document.getElementById('ringtoneIn');
if (ringIn) {
    ringIn.currentTime = 0;
    ringIn.play().catch(e => {
        // Ù„Ùˆ Ø§Ù„ØµÙˆØª Ø§ØªÙ…Ù†Ø¹ØŒ Ù†Ø´ØºÙ„ Ø§Ù„Ù‡Ø²Ø§Ø²
        if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
    });
}
playSmartRingtone('incoming');
    if (!chatId) return;

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
      .onSnapshot(async s => {
        const d = s.data();
        
        // --- Ø­Ø§Ù„Ø© 1: Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª Ø£Ùˆ Ø§ØªÙ„ØºØª (Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª) ---
        if (!d || !d.offer) {
            // Ù„Ùˆ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§
            if(document.getElementById('callOverlay').style.display === 'flex') {
                endCall(false); // false Ø¹Ø´Ø§Ù† Ù…Ù†Ø­Ø°ÙØ´ Ø§Ù„Ø¯ÙˆÙƒ ØªØ§Ù†ÙŠ Ù„Ø£Ù†Ù‡ Ø§ØªØ­Ø°Ù Ø£ØµÙ„Ø§Ù‹
            }
            
            // ÙˆÙ‚Ù Ø§Ù„Ø±Ù†Ø© ÙÙˆØ±Ø§Ù‹
            if(ringIn) { 
                ringIn.pause(); 
                ringIn.currentTime = 0; 
            }

            // ÙˆÙ‚Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙˆØ±Ø§Ù‹
            if (vibrationInterval) {
                clearInterval(vibrationInterval);
                navigator.vibrate(0);
                vibrationInterval = null;
            }
            return;
        }

        // --- Ø­Ø§Ù„Ø© 2: ÙÙŠÙ‡ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø© (Ø¹Ø±Ø¶ Ù…ÙˆØ¬ÙˆØ¯ + Ù…Ø´ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…ØªØµÙ„ + Ù…ÙÙŠØ´ Ø§ØªØµØ§Ù„ Ø­Ø§Ù„ÙŠ) ---
        if (d.offer && d.callerId !== currentUserId && !peerConnection) {
            console.log("Incoming Call Detected...");
            
            incomingOffer = d.offer; // Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡
            setupCallUI('incoming', d.callerId); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©
            
            // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
            const playPromise = ringIn.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.warn("Audio autoplay blocked by browser:", error);
                    // Ù‡Ù†Ø§ Ø§Ù„ØµÙˆØª Ù…Ø´ Ù‡ÙŠØ´ØªØºÙ„ ØºÙŠØ± Ù„Ù…Ø§ Ø§Ù„ÙŠÙˆØ²Ø± ÙŠØªÙØ§Ø¹Ù„ØŒ 
                    // Ù„ÙƒÙ† Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙˆØ§Ù„Ø´Ø§Ø´Ø© Ù‡ÙŠØ®Ù„ÙˆÙ‡ ÙŠÙ†ØªØ¨Ù‡
                });
            }

            // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² (Loop)
            if ("vibrate" in navigator) {
                // Ù‡Ø² Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙˆØ±Ø§Ù‹
                navigator.vibrate([1000, 1000]); // Ø§Ù‡ØªØ²Ø§Ø² 1 Ø«Ø§Ù†ÙŠØ©ØŒ ØªÙˆÙ‚Ù 1 Ø«Ø§Ù†ÙŠØ©
                
                // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªÙƒØ±Ø§Ø± Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„
                if(vibrationInterval) clearInterval(vibrationInterval);

                // ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
                vibrationInterval = setInterval(() => {
                    navigator.vibrate([1000, 1000]);
                }, 2000);
            }
        }
    });
}


// 3. Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
async function acceptIncomingCall() {
    // 1. ÙˆÙ‚Ù Ø£ÙŠ Ø¥Ø²Ø¹Ø§Ø¬ (ØµÙˆØª Ø£Ùˆ Ø§Ù‡ØªØ²Ø§Ø²) ÙÙˆØ±Ø§Ù‹
    stopSmartRingtone(); 

if (navigator.vibrate) navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø²

    // Ø¶ÙŠÙ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ù‡ ÙÙŠ Ø£ÙˆÙ„ Ø§Ù„Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¯ÙŠ
if (vibrationInterval) {
    clearInterval(vibrationInterval); // ÙˆÙ‚Ù Ø§Ù„ØªÙƒØ±Ø§Ø±
    navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
    vibrationInterval = null; // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±
}

    // 1. ÙˆÙ‚Ù Ø§Ù„Ø±Ù†ÙŠÙ†
    const ringIn = document.getElementById('ringtoneIn');
    if(ringIn) { ringIn.pause(); ringIn.currentTime = 0; }
    
    // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('incomingCallControls').style.display = 'none';
    document.getElementById('activeCallControls').style.display = 'flex';
    document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„...";

    try {
        // ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
        const callDoc = await db.collection('chats').doc(chatId).collection('calls').doc('active_call').get();
        const isVideoCall = callDoc.exists && callDoc.data().isVideo === true;

        // 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
        const audioConstraints = {
            echoCancellation: true,      
            noiseSuppression: true,      
            autoGainControl: true,
            googEchoCancellation: true,
            googAutoGainControl: true,
            googNoiseSuppression: true,
            googHighpassFilter: true
        };

        const constraints = {
            audio: audioConstraints,
            video: isVideoCall ? true : false
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (isVideoCall) {
            const localVidEl = document.getElementById('localVideo');
            const videoContainer = document.getElementById('videoContainer');
            const bg = document.getElementById('callBg');
            
            localVideoTrack = localStream.getVideoTracks()[0];
            localVidEl.srcObject = new MediaStream([localVideoTrack]);
            
            videoContainer.style.display = 'block';
            bg.style.display = 'none';
            
            const videoBtn = document.getElementById('videoBtn');
            if(videoBtn) {
                videoBtn.classList.add('active-state');
                videoBtn.querySelector('i').className = "fa-solid fa-video";
            }
            if(document.getElementById('switchCamBtn')) {
                document.getElementById('switchCamBtn').style.display = 'flex';
            }
        } else {
             if(document.getElementById('switchCamBtn')) {
                document.getElementById('switchCamBtn').style.display = 'none';
            }
        }

        // 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
        monitorConnectionState(); 
        
        // ================= ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§ =================
        // ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† catch Ø¥Ù„Ù‰ Ù‡Ù†Ø§ Ù„ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„
        listenForCallUpdates(); 
        makeVideoDraggable(); 
        // ===================================================

        listenForRemoteCandidates();
        
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        
        peerConnection.ontrack = (event) => {
    const stream = event.streams[0];
    
    // Ù„Ùˆ ØµÙˆØª
    if (event.track.kind === 'audio') {
        document.getElementById('remoteAudio').srcObject = stream;
        handleCallConnected(event);
    }

    // Ù„Ùˆ ÙÙŠØ¯ÙŠÙˆ (Ù‡Ù†Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡)
    if (event.track.kind === 'video') {
        // Ø¨Ù†ÙØ­Øµ Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        // Ù„Ùˆ Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯Ù‡ Ø£ÙƒÙŠØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
        const videoTracks = stream.getVideoTracks();
        
        /* Ù…Ù„Ø§Ø­Ø¸Ø©: WebRTC Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø¨ÙŠØ¨Ø¹Øª Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Stream Ù…Ù†ÙØµÙ„ Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù€ Stream.
           Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¶Ù…Ù†: Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ remoteVideoØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¯Ù‡ Ù‡Ùˆ Ø§Ù„Ø´Ø§Ø´Ø©.
        */
        const remoteVideo = document.getElementById('remoteVideo');
        const remoteScreen = document.getElementById('remoteScreenVideo');
        const container = document.getElementById('videoContainer');
        const bg = document.getElementById('callBg');

        // Ù†Ø¸Ù‡Ø± Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙˆÙ†Ø®ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        container.style.display = 'block';
        bg.style.display = 'none';

        if (!remoteVideo.srcObject) {
            // Ø¯Ù‡ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
            remoteVideo.srcObject = stream;
        } else {
            // Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„Ø´Ø§Ø´Ø©!)
            // Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ø´ Ù†ÙØ³ Ø§Ù„ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (remoteVideo.srcObject.id !== stream.id) {
                remoteScreen.srcObject = stream;
                remoteScreen.style.display = 'block';
                
                // Ù†ÙØ¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù€ Presentation (Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØµØºØ± ÙˆØ§Ù„Ø´Ø§Ø´Ø© ØªÙƒØ¨Ø±)
                container.classList.add('presentation-mode');

                // Ù„Ù…Ø§ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚ÙÙ„ (Track Ended)ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                event.track.onended = () => {
                    remoteScreen.style.display = 'none';
                    remoteScreen.srcObject = null;
                    container.classList.remove('presentation-mode');
                };
            }
        }
    }
};


        peerConnection.onicecandidate = (e) => {
            if (e.candidate) db.collection('chats').doc(chatId).collection('callCandidates').add(e.candidate.toJSON());
        };

        await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingOffer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
            answer: { type: answer.type, sdp: answer.sdp },
            status: 'connected'
        });

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©: " + err.message);
        endCall();
    }
}





// 4. Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
async function rejectCall() {
    console.log("Rejecting call..."); // Ù„Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨

    // 1. ÙˆÙ‚Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙˆØ±Ø§Ù‹
    if (navigator.vibrate) navigator.vibrate(0);
    if (typeof vibrationInterval !== 'undefined' && vibrationInterval) {
        clearInterval(vibrationInterval);
        vibrationInterval = null;
    }

    // 2. ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ù‚ÙˆØ©
    const rIn = document.getElementById('ringtoneIn');
    if(rIn) { 
        rIn.pause(); 
        rIn.currentTime = 0; 
    }
    
    // 3. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    await endCall(true); 
}

// 5. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ù…Ø´ØªØ±Ùƒ)
async function endCall(isInit = true) {
    // ÙˆÙ‚Ù Ø£ÙŠ ØµÙˆØª Ø´ØºØ§Ù„
['ringtoneIn', 'ringtoneOut'].forEach(id => { 
    var el = document.getElementById(id); 
    if(el) { el.pause(); el.currentTime = 0; } 
});
if (navigator.vibrate) navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø²

    if (noAnswerTimeout) clearTimeout(noAnswerTimeout);
    // 1. === Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙˆØ±Ø§Ù‹ (Ø£ÙˆÙ„ Ø­Ø§Ø¬Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¥Ø²Ø¹Ø§Ø¬) ===
    if (typeof vibrationInterval !== 'undefined' && vibrationInterval) {
        clearInterval(vibrationInterval);
        if (navigator.vibrate) navigator.vibrate(0);
        vibrationInterval = null;
    }

    // 2. Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„ØªÙ‡Ø§ (Ù‡Ù„ ØªÙ… Ø§Ù„Ø±Ø¯ Ø£Ù… Ù„Ø§ØŸ)
    let durationText = "00:00";
    let isMissed = true;
    
    // Ù„Ùˆ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒØ§Ù† Ø´ØºØ§Ù„ (ÙˆØ§Ø®Ø¯ ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØ§ÙŠÙ…Ø±)ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯ÙŠ Ù…ÙƒØ§Ù„Ù…Ø© ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
    const statusText = document.getElementById('callStatusText');
    if (statusText && statusText.classList.contains('call-status-timer')) {
        durationText = statusText.innerText;
        isMissed = false;
    }

    // 3. Ø¥ÙŠÙ‚Ø§Ù Ù†ØºÙ…Ø§Øª Ø§Ù„Ø±Ù†ÙŠÙ† ÙˆØµÙˆØª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    const ringOut = document.getElementById('ringtoneOut');
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†Ø© ÙÙˆØ±Ø§Ù‹
const ringIn = document.getElementById('ringtoneIn');
if (ringIn) {
    ringIn.pause();
    ringIn.currentTime = 0;
}

    const endSound = document.getElementById('callEndSound');

    if (ringOut) { ringOut.pause(); ringOut.currentTime = 0; }
    if (ringIn) { ringIn.pause(); ringIn.currentTime = 0; }
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª "ØªÙˆØª" Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (endSound) endSound.play().catch(()=>{}); 

    // 4. Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebRTC ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ
    if (peerConnection) { 
        peerConnection.close(); 
        peerConnection = null; 
    }
    
    if (localStream) { 
        localStream.getTracks().forEach(t => t.stop()); 
        localStream = null; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØªØºÙŠØ±
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„ØµÙˆØª
    if (typeof callTimerInterval !== 'undefined' && callTimerInterval) clearInterval(callTimerInterval);
    if (typeof visualizerInterval !== 'undefined' && visualizerInterval) cancelAnimationFrame(visualizerInterval);
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØª (AudioContext) Ù„Ùˆ ÙƒØ§Ù† Ù…ÙØªÙˆØ­
    if (typeof audioContext !== 'undefined' && audioContext) { 
        audioContext.close().catch(()=>{}); 
        audioContext = null; 
    }

    // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
    closeCallUI();

    // 5. === ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‡Ù…) ===
    // ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙ‚Ø· Ù„Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù‚ÙÙ„Øª (isInit=true) Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (isInit) {
        try {
            // Ø£) Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ù…ØªØµÙ„ (callerId)
            const callDocRef = db.collection('chats').doc(chatId).collection('calls').doc('active_call');
            const callDoc = await callDocRef.get();
            
            // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ø§Øª Ù…Ù†Ù‡ Ø§Ù„Ù…ØªØµÙ„ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙŠØ¨Ù‚Ù‰ Ø£Ù†Ø§ (Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
            const realCallerId = callDoc.exists ? callDoc.data().callerId : currentUserId;

            // Ø¨) Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            await callDocRef.delete();
            
            // Ø¬) ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ø§Ù„ÙƒÙˆØ¯ (Ù‡Ù„ Ù‡ÙŠ ÙØ§Ø¦ØªØ© Ø£Ù… Ø§Ù†ØªÙ‡ØªØŸ)
            let logText = isMissed ? "no_answer" : "call_ended"; 
            
            // Ø¯) Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.collection("chats").doc(chatId).collection("messages").add({
                text: logText,          // ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
                uid: currentUserId,     // Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ù‚ÙÙ„
                type: 'call_log',       // Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                isMissed: isMissed,     // Ù‡Ù„ ØªÙ… Ø§Ù„Ø±Ø¯ØŸ
                callerId: realCallerId, // Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
                duration: durationText, // Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

        } catch (e) { 
            console.log("Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£", e); 
        }
    }
}


// --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ---

function setupCallUI(type, otherUserId = null) {
    const overlay = document.getElementById('callOverlay');
    const nameEl = document.getElementById('callName');
    // const bgEl = document.getElementById('callBg'); // ğŸ‘ˆ (1) Ù„Ù… Ù†Ø¹Ø¯ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŒ ØªØ¬Ø§Ù‡Ù„Ù‡
    const avatarEl = document.getElementById('callAvatar');

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let uData = otherUserId ? (userCache[otherUserId] || {name: 'Ù…Ø¬Ù‡ÙˆÙ„'}) : (userCache[cachedOtherUserId] || {name: 'Ù…Ø³ØªØ®Ø¯Ù…'});
    
    nameEl.innerText = uData.name;
    
    if(uData.profilePic) {
        // bgEl.style.backgroundImage = `url('${uData.profilePic}')`; // ğŸ‘ˆ (2) Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø£Ùˆ Ø§Ø¬Ø¹Ù„Ù‡ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ ÙƒÙ…Ø§ ÙØ¹Ù„Øª Ù‡Ù†Ø§
        // Ø§Ù„Ø³Ø¨Ø¨: Ø¹Ø´Ø§Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© (Aurora) Ù‡ÙŠ Ø§Ù„Ù„ÙŠ ØªØ¸Ù‡Ø± Ù…Ø´ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ
        
        avatarEl.style.backgroundImage = `url('${uData.profilePic}')`; // âœ… (3) Ø³ÙŠØ¨ Ø¯Ù‡ Ø´ØºØ§Ù„ (Ø¯Ù‡ Ø¨ÙŠØ­Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ÙŠØ±Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¨Ø³)
    }

    overlay.style.display = 'flex';

    if (type === 'outgoing') {
        document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
        document.getElementById('incomingCallControls').style.display = 'none';
        document.getElementById('activeCallControls').style.display = 'flex'; 
        document.querySelector('.call-btn.mute').style.display = 'none'; 
    } else {
        document.getElementById('callStatusText').innerText = "Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©...";
        document.getElementById('callStatusText').style.color = "#10b981";
        document.getElementById('incomingCallControls').style.display = 'flex';
        document.getElementById('activeCallControls').style.display = 'none';
    }
}


function handleCallConnected(event) {
    if (noAnswerTimeout) clearTimeout(noAnswerTimeout);
    document.getElementById('callAvatar').classList.remove('calling-pulse'); 
    

    const remoteAudio = document.getElementById('remoteAudio');
    
    // 1. Ø±Ø¨Ø· Ø§Ù„ØµÙˆØª ÙˆØªØ´ØºÙŠÙ„Ù‡
    remoteAudio.srcObject = event.streams[0];
    
    // === Ø¶Ø¨Ø· Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø³Ù…Ø§Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©) ===
    remoteAudio.volume = 1.0; // Ù†Ø¨Ø¯Ø£ Ø¨ØµÙˆØª ÙˆØ§Ø·ÙŠ
    
    // Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø¨ÙŠÙƒØ± Ù…Ø·ÙÙŠ (Ù„ÙˆÙ†Ù‡ Ø´ÙØ§Ù)
    const speakerBtn = document.getElementById('speakerBtn');
    if (speakerBtn) speakerBtn.classList.remove('active-state');

    // 2. Ø¶Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
    const statusText = document.getElementById('callStatusText');
    statusText.innerText = "00:00";
    statusText.style.color = "#fff";
    statusText.classList.add('call-status-timer');
    
    // 3. ÙˆÙ‚Ù Ù†ØºÙ…Ø© Ø§Ù„Ø±Ù†ÙŠÙ† (Ù„Ø£Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ Ø±Ø¯ Ø®Ù„Ø§Øµ)
    const ringOut = document.getElementById('ringtoneOut');
    if(ringOut) { 
        ringOut.pause(); 
        ringOut.currentTime = 0; 
    }
    
    // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®ÙÙŠØ© (Ø²ÙŠ Ø§Ù„Ù…ÙŠÙˆØª)
    const muteBtn = document.querySelector('.call-btn.mute');
    if (muteBtn) muteBtn.style.display = 'flex';

    // 5. === Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Smart Timer) ===
    let seconds = 0;
    
    // Ù„Ùˆ ÙÙŠÙ‡ Ø¹Ø¯Ø§Ø¯ Ù‚Ø¯ÙŠÙ… Ø´ØºØ§Ù„ Ù†ÙˆÙ‚ÙÙ‡ Ø§Ù„Ø£ÙˆÙ„
    if (typeof callTimerInterval !== 'undefined' && callTimerInterval) {
        clearInterval(callTimerInterval);
    }
    
    callTimerInterval = setInterval(() => {
        // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        // Ù„Ùˆ Ø§Ù„Ù†Øª ÙØ§ØµÙ„ Ø£Ùˆ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠØ±Ø¬Ø¹ØŒ Ù…Ù†Ø²ÙˆØ¯Ø´ Ø§Ù„ÙˆÙ‚Øª (Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠÙ‚Ù Ù…ÙƒØ§Ù†Ù‡)
        if (peerConnection) {
            const state = peerConnection.iceConnectionState;
            if (state === 'disconnected' || state === 'failed' || state === 'checking') {
                return; // ÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹
            }
        }

        // Ù„Ùˆ Ø§Ù„Ù†Øª ØªÙ…Ø§Ù…ØŒ ÙƒÙ…Ù„ Ø¹Ø¯
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù„ÙˆÙ† (Ù†Ø±Ø¬Ø¹Ù‡ Ø£Ø¨ÙŠØ¶ Ù„Ùˆ ÙƒØ§Ù† Ø£ØµÙØ± Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹)
        statusText.innerText = `${m}:${s}`;
        statusText.style.color = "#fff"; 
        
    }, 1000);

    // 6. === ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ===
    
    // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø¨ÙƒØ© (Ø¹Ø´Ø§Ù† ÙŠÙƒØªØ¨ "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„" Ù„Ùˆ Ø§Ù„Ù†Øª Ù‚Ø·Ø¹)
    monitorConnectionState();

    // ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„Ù„ Ø§Ù„ØµÙˆØª (Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© ØªÙ†Ø¨Ø¶ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ù…)
    startAudioVisualizer(event.streams[0]);
}



function closeCallUI() {
    const overlay = document.getElementById('callOverlay');
    document.getElementById('callAvatar').classList.remove('calling-pulse');


    const statusText = document.getElementById('callStatusText');
    const controls = document.getElementById('activeCallControls');
    
    // 1. ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ "Ø§Ù†ØªÙ‡Øª"
    statusText.innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©";
    statusText.style.color = "#ff3b30"; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø±
    
    // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹
    if(controls) controls.style.display = 'none';
    document.getElementById('incomingCallControls').style.display = 'none';

    // 3. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 1.5 Ø«Ø§Ù†ÙŠØ© Ø«Ù… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    setTimeout(() => {
        overlay.style.display = 'none';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©
        statusText.style.color = "#fff";
        statusText.classList.remove('call-status-timer');
        
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ (Ù„Ùˆ ÙƒÙ†Ø§ Ø­Ø±ÙƒÙ†Ø§Ù‡)
        const localVid = document.getElementById('localVideo');
        localVid.style.top = ""; localVid.style.left = "";
        localVid.style.bottom = "120px"; localVid.style.right = "20px";
        
    }, 1500);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Missing Function)
// ============================================================
// ğŸ‘‚ Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¯ (ØªÙˆØ¶Ø¹ ÙÙŠ Ù…Ù„Ù messages.html)
// ============================================================

function listenForAnswer() {
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
    const unsubscribe = db.collection('chats').doc(chatId).collection('calls').doc('active_call')
        .onSnapshot(snapshot => {
            const data = snapshot.data();
            
            // 1. Ù„Ùˆ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§ØªÙ…Ø³Ø­Øª Ø£Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (!data) {
                // Ù†ÙˆÙ‚Ù Ø§Ù„Ø±Ù†ÙŠÙ† ÙÙˆØ±Ø§Ù‹
                const ringOut = document.getElementById('ringtoneOut');
                if(ringOut) { ringOut.pause(); ringOut.currentTime = 0; }
                endCall(); // Ù†Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©
                return;
            }

            // 2. ğŸ”¥ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¶ (Ø§Ù„Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹) ğŸ”¥
            if (data.status === 'rejected') {
                // Ù†ÙˆÙ‚Ù Ø§Ù„Ø±Ù†ÙŠÙ† ÙÙˆØ±Ø§Ù‹
                const ringOut = document.getElementById('ringtoneOut');
                if(ringOut) { ringOut.pause(); ringOut.currentTime = 0; }
                
                // Ø±Ø³Ø§Ù„Ø© ØµØºÙŠØ±Ø© ÙˆÙ†Ù‚ÙÙ„
                // alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ğŸš«"); // Ù…Ù…ÙƒÙ† ØªØ´ÙŠÙ„ Ø§Ù„Ù€ alert Ù„Ùˆ Ø¹Ø§ÙŠØ²Ù‡ ÙŠÙØµÙ„ ØµØ§Ù…Øª
                console.log("Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
                
                endCall(); // Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ
                unsubscribe(); // ÙˆÙ‚Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
            }

            // 3. Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ (Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙØªØ­Øª)
            if (data.status === 'answered' && peerConnection) {
                const ringOut = document.getElementById('ringtoneOut');
                if(ringOut) { ringOut.pause(); ringOut.currentTime = 0; }

                // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¯
                const answer = data.answer;
                const remoteDesc = new RTCSessionDescription(answer);
                peerConnection.setRemoteDescription(remoteDesc);
                
                // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
                startCallTimer();
                unsubscribe(); // Ø®Ù„Ø§Øµ Ø±Ø¯ØŒ Ù…Ø´ Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø±Ø¯ ØªØ§Ù†ÙŠ
            }
        });
}

function toggleSpeaker() {
    const remoteAudio = document.getElementById('remoteAudio');
    const speakerBtn = document.getElementById('speakerBtn');

    // Ø¨Ù†ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±Ø§Ø±: Ù‡Ù„ Ù‡Ùˆ Ù…Ù†ÙˆØ± (active-state)ØŸ
    // Ù„Ùˆ Ù…Ù†ÙˆØ± = Ø§Ù„Ø³Ø¨ÙŠÙƒØ± Ø´ØºØ§Ù„ <-- Ø§Ø­Ù†Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø·ÙÙŠÙ‡
    if (speakerBtn.classList.contains('active-state')) {
        // 1. Ù†ÙˆØ·ÙŠ Ø§Ù„ØµÙˆØª (Ù…Ø­Ø§ÙƒØ§Ø© Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª)
        remoteAudio.volume = 1.0; 
        
        // 2. Ù†Ø´ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶ Ù…Ù† Ø§Ù„Ø²Ø±Ø§Ø±
        speakerBtn.classList.remove('active-state');
    } 
    
    // Ù„Ùˆ Ù…Ø´ Ù…Ù†ÙˆØ± = Ø§Ù„Ø³Ø¨ÙŠÙƒØ± Ù…Ø·ÙÙŠ <-- Ø§Ø­Ù†Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø´ØºÙ„Ù‡
    else {
        // 1. Ù†Ø¹Ù„ÙŠ Ø§Ù„ØµÙˆØª Ù„Ø£Ù‚ØµÙ‰ Ø¯Ø±Ø¬Ø©
        remoteAudio.volume = 1.0; 
        
        // 2. Ù†Ù†ÙˆØ± Ø§Ù„Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø¹Ø´Ø§Ù† ØªØ¹Ø±Ù Ø¥Ù†Ù‡ Ø´ØºØ§Ù„
        speakerBtn.classList.add('active-state');
    }
}



// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙˆØª Ø¹Ø´Ø§Ù† ØªØºÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø²Ø±Ø§Ø± Ù„Ù„Ø£Ø¨ÙŠØ¶
function toggleMute() { 
    if(localStream) { 
        const track = localStream.getAudioTracks()[0]; 
        track.enabled = !track.enabled; 
        const btn = document.getElementById('muteBtn');
        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù„ÙˆÙ†
        if(track.enabled) {
            btn.classList.remove('active-state'); // Ù„ÙˆÙ† Ø´ÙØ§Ù (Ø´ØºØ§Ù„)
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        } else {
            btn.classList.add('active-state'); // Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ (Ù…ÙƒØªÙˆÙ…)
            btn.innerHTML = '<i class="fa-solid fa-microphone-slash" style="color:#000"></i>';
        }
    } 
}


          
        // Ø¯Ø§Ù„Ø© Ø§Ù„ÙˆÙ‚Øª (Ù…Ù‡Ù…Ø©)
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†';
            if (diff < 3600) return `Ù…Ù†Ø° ${Math.floor(diff/60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diff < 86400) return `Ù…Ù†Ø° ${Math.floor(diff/3600)} Ø³Ø§Ø¹Ø©`;
            return 'Ù…Ù†Ø° ÙØªØ±Ø©';
        }
    function linkify(text) {
    var urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    return text.replace(urlRegex, function(url) {
        // ØªÙ‚ØµÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø·ÙˆÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
        let shortUrl = url.length > 30 ? url.substring(0, 27) + "..." : url;
        return '<br><a href="' + url + '" target="_blank" class="chat-link">' + shortUrl + '</a>';
    });
}
// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
async function fetchLinkPreview(url, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    try {
        // Ø¨Ù†Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Microlink Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
        const response = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            const { title, description, image, logo } = data.data;
            
            // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø©ØŒ Ù…Ø´ Ù‡Ù†Ø¹Ù…Ù„ ÙƒØ§Ø±Øª ÙƒØ¨ÙŠØ±
            if (!image || !image.url) return;

            const domain = new URL(url).hostname.replace('www.', '');

            container.innerHTML = `
                <div class="link-preview-card" onclick="window.open('${url}', '_blank')">
                    <img src="${image.url}" class="lp-image" onerror="this.style.display='none'">
                    <div class="lp-content">
                        <div class="lp-title">${title || domain}</div>
                        <div class="lp-desc">${description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
                        <div class="lp-domain">${domain}</div>
                    </div>
                </div>
            `;
            container.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø±
        }
    } catch (e) {
        console.log("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©", e);
        // Ù„Ùˆ ÙØ´Ù„ØŒ ÙŠÙØ¶Ù„ Ù…Ø®ÙÙŠ ÙˆÙ„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Øª
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
    const headerStatus = document.getElementById('headerStatus');
    if (navigator.onLine) {
        headerStatus.innerText = "Ù…ØªØµÙ„";
        headerStatus.style.color = "#10b981";
        setTimeout(() => { 
            // Ø±Ø¬Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (Ù†Ø´Ø· Ø§Ù„Ø¢Ù† Ø£Ùˆ ØºÙŠØ±Ù‡) 
            // Ù…Ù…ÙƒÙ† ØªØ³ØªØ¯Ø¹ÙŠ updateHeader Ù…Ø±Ø© ØªØ§Ù†ÙŠØ© Ù‡Ù†Ø§
        }, 3000);
    } else {
        headerStatus.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...";
        headerStatus.style.color = "#ff3b30";
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
function getYoutubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

    // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø±Ø¯ (Swipe to Reply) ===
function enableSwipeToReply(rowElement, bubbleElement, msgData, msgId) {
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;
    let startY = 0; // Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ù„ÙÙˆÙ‚ ÙˆØªØ­Øª

    // 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
    bubbleElement.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        bubbleElement.classList.remove('snapping'); // Ø´ÙŠÙ„ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø´Ø§Ù† ØªØªØ­Ø±Ùƒ Ù…Ø¹ ØµØ¨Ø§Ø¹ÙŠ ÙÙˆØ±Ø§Ù‹
    }, { passive: true });

    // 2. Ø­Ø±ÙƒØ© Ø§Ù„ØµØ¨Ø§Ø¹
    bubbleElement.addEventListener('touchmove', (e) => {
        currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX;
        const diffY = currentY - startY;

        // Ù„Ùˆ Ø¨ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ø±Ø£Ø³ÙŠ (Y)ØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£ÙÙ‚ÙŠ
        if (Math.abs(diffY) > Math.abs(diffX)) return;

        // Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† ÙÙ‚Ø· (diffX > 0) ÙˆØ¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 100 Ø¨ÙƒØ³Ù„
        if (diffX > 0 && diffX < 120) {
            isSwiping = true;
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
            bubbleElement.style.transform = `translateX(${diffX}px)`;
            
            // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…Ù…ÙƒÙ† Ù‡Ù†Ø§ Ù†Ø¸Ù‡Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¯ Ù„Ùˆ Ø¶ÙØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ù€ HTML
        }
    }, { passive: true });

    // 3. Ø±ÙØ¹ Ø§Ù„ØµØ¨Ø§Ø¹ (Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ù…Ø³)
    bubbleElement.addEventListener('touchend', (e) => {
        const diff = currentX - startX;
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ø§Ù„Ù†Ø§Ø¹Ù…
        bubbleElement.classList.add('snapping');
        bubbleElement.style.transform = 'translateX(0)'; // Ø±Ø¬Ø¹Ù‡Ø§ Ù…ÙƒØ§Ù†Ù‡Ø§

        // Ù„Ùˆ Ø§Ù„Ø³Ø­Ø¨Ø© ÙƒØ§Ù†Øª Ù‚ÙˆÙŠØ© ÙƒÙØ§ÙŠØ© (Ø£ÙƒØªØ± Ù…Ù† 70 Ø¨ÙƒØ³Ù„)
        if (isSwiping && diff > 70) {

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´Ø§Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ ØªØ´ØªØºÙ„ ØµØ­
            selectedMsgId = msgId;
            selectedMsgData = msgData;
            
            // ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯
            activateReplyMode();
        }

        // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        isSwiping = false;
        startX = 0;
        currentX = 0;
    });
}
// ================= ÙƒÙˆØ¯ Ø²Ø± Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù†) =================

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„ ÙŠØ´ÙˆÙÙ‡Ø§
const chatContainerElement = document.getElementById("chatContainer");
const scrollBtnElement = document.getElementById("scrollToBottomBtn");

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø²ÙˆÙ„ (Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† global Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ onclick ÙŠØ´ÙˆÙÙ‡Ø§)
function scrollToBottom() {
    chatContainerElement.scrollTo({ top: chatContainerElement.scrollHeight, behavior: 'smooth' });
}

// Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
chatContainerElement.addEventListener("scroll", () => {
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©: Ù‡Ù„ Ø£Ù†Ø§ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† ØªØ­Øª Ø¨Ù€ 300 Ø¨ÙƒØ³Ù„ØŸ
    const distanceFromBottom = chatContainerElement.scrollHeight - chatContainerElement.scrollTop - chatContainerElement.clientHeight;
    
    if (distanceFromBottom > 300) {
        scrollBtnElement.style.display = "flex"; // Ø£Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
    } else {
        scrollBtnElement.style.display = "none"; // Ø§Ø®ÙÙŠ Ø§Ù„Ø²Ø±
    }
});
    // Ø¯Ø§Ù„Ø© ØªÙƒØ¨ÙŠØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function autoResize(textarea) {
    textarea.style.height = 'auto'; // ØªØµÙÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
    textarea.style.height = textarea.scrollHeight + 'px'; // Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    // Ù„Ùˆ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙØ¶ÙŠØŒ Ù†Ø±Ø¬Ø¹Ù‡ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯
    if(textarea.value === '') {
        textarea.style.height = 'auto';
    }
}

// Ø¯Ø§Ù„Ø© ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ + Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙÙˆÙ‚ (Messenger Style)
// Ø¯Ø§Ù„Ø© ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ + Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙÙˆÙ‚ Ø¨Ù…Ø³Ø§ÙØ© Ø¢Ù…Ù†Ø©
function autoResize(textarea) {
    // 1. Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¹Ø´Ø§Ù† Ù†Ø­Ø³Ø¨ ØµØ­
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';

    // 2. ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§ÙØ© Ø§Ù„Ø´Ø§Øª Ù…Ù† ØªØ­Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
    const footer = document.querySelector('.chat-footer');
    const chatBody = document.getElementById('chatContainer');
    const replyBar = document.getElementById('replyBar'); // Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    
    if (footer && chatBody) {
        // Ø¨Ù†Ø­Ø³Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙÙˆØªØ± + Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ù‚Ø§Ø¹ (20px) + Ù…Ø³Ø§ÙØ© Ø£Ù…Ø§Ù† Ø²ÙŠØ§Ø¯Ø© (40px)
        let totalPadding = footer.clientHeight + 60;
        
        // Ù„Ùˆ Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯ Ù…ÙØªÙˆØ­ØŒ Ù†Ø²ÙˆØ¯ Ø§Ø±ØªÙØ§Ø¹Ù‡ Ù‡Ùˆ ÙƒÙ…Ø§Ù† Ø¹Ø´Ø§Ù† Ù…ÙŠØ§ÙƒÙ„Ø´ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„
        if (replyBar && replyBar.style.display === 'flex') {
            totalPadding += 50; 
        }

        chatBody.style.paddingBottom = totalPadding + 'px';
        
        // 3. Ù†Ø²Ù„ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ø£Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ø¹Ø´Ø§Ù† ÙŠØ´ÙˆÙ Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙƒØªØ¨Ù‡
        scrollToBottom();
    }
}

// ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ: Ø£ÙˆÙ„ Ù…Ø§ ØªØ¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹ (Focus)ØŒ Ø§Ø±ÙØ¹ Ø§Ù„Ø´Ø§Øª Ù„ÙÙˆÙ‚
document.getElementById('messageInput').addEventListener('focus', () => {
    setTimeout(scrollToBottom, 300); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø­Ø¯ Ù…Ø§ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ ÙŠÙØªØ­
});
        let audioContext = null;
let analyser = null;
let visualizerInterval = null;
function startAudioVisualizer(stream) {
    // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù…Ù„Øª Mute ÙˆØ±Ø¬Ø¹Øª Ù…ÙŠØ¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„)
    if (audioContext) { 
        audioContext.close().catch(e => console.log(e)); 
    }
    if (visualizerInterval) { 
        cancelAnimationFrame(visualizerInterval); 
    }

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ù„Ù„ Ø§Ù„ØµÙˆØª (Setup)
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 64; // Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ (64 ÙƒØ§ÙÙŠØ© Ø¬Ø¯Ø§Ù‹ ÙˆØ³Ø±ÙŠØ¹Ø©)
    source.connect(analyser);

    // ØªØ¬Ù‡ÙŠØ² Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    const avatar = document.getElementById('callAvatar');
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ù€ CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    avatar.classList.add('avatar-pulse');

    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Loop) - Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªÙ„Ù ÙˆØªØªÙƒØ±Ø± Ø·ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª
    function animate() {
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        analyser.getByteFrequencyData(dataArray);

        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙˆØª
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) { sum += dataArray[i]; }
        const average = sum / dataArray.length;

        // === Ù‡Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø£Ù†Øª ÙƒÙ†Øª Ø¹Ø§ÙŠØ² ØªØ¶ÙŠÙÙ‡ (Ø¬ÙˆÙ‡ Ø§Ù„Ù„ÙˆØ¨) ===
        if (average > 10) { // Ù„Ùˆ Ø§Ù„ØµÙˆØª Ù…Ø³Ù…ÙˆØ¹ (Ø£Ø¹Ù„Ù‰ Ù…Ù† 10)
            // ØªØ´ØºÙŠÙ„ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ (Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±)
            avatar.classList.add('is-speaking');
            
            // ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ Ø¨Ø°ÙƒØ§Ø¡ Ø­Ø³Ø¨ Ù‚ÙˆØ© Ø§Ù„ØµÙˆØª
            // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¯ÙŠ Ø¨ØªØ®Ù„ÙŠ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ù†Ø§Ø¹Ù… ÙˆÙ…Ø´ "Ø¨ÙŠØªØ±Ø¹Ø´"
            const scale = 1 + (average / 300); 
            const glow = average * 1.5; // Ù‚ÙˆØ© Ø§Ù„ÙˆÙ‡Ø¬
            
            avatar.style.transform = `scale(${scale})`;
            avatar.style.boxShadow = `0 0 ${glow}px rgba(0, 229, 255, ${average/100})`;
            avatar.style.borderColor = "rgba(0, 229, 255, 1)";
            
        } else {
            // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØª (Ø³ÙƒÙˆØª)
            avatar.classList.remove('is-speaking');
            avatar.style.transform = `scale(1)`; // Ø±Ø¬Ø¹ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
            
            // Ø±Ø¬Ø¹ Ø§Ù„Ø¸Ù„ ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‡Ø§Ø¯ÙŠ
            avatar.style.boxShadow = `0 10px 40px rgba(0,0,0,0.5)`;
            avatar.style.borderColor = "rgba(255,255,255,0.15)";
        }

        // Ø·Ù„Ø¨ Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡ (ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„ÙˆØ¨)
        visualizerInterval = requestAnimationFrame(animate);
    }

    // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ÙˆØ¨ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    animate();
}

function monitorConnectionState() {
    if (!peerConnection) return;

    peerConnection.oniceconnectionstatechange = () => {
        const state = peerConnection.iceConnectionState;
        const statusText = document.getElementById('callStatusText');
        const overlay = document.getElementById('callOverlay');

        if (state === 'disconnected' || state === 'failed') {
            // Ø§Ù„Ù†Øª Ù‚Ø·Ø¹
            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...";
            statusText.style.color = "#f59e0b"; // Ø£ØµÙØ±
            
            // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ: ØªØ¹ØªÙŠÙ… Ø®ÙÙŠÙ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
            document.getElementById('remoteVideo').style.opacity = "0.4";
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª "ØªÙˆØª ØªÙˆØª" Ø®ÙÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            // playReconnectingSound(); 
        } 
        else if (state === 'connected' || state === 'completed') {
            // Ø§Ù„Ù†Øª Ø±Ø¬Ø¹
            statusText.style.color = "#fff";
            document.getElementById('remoteVideo').style.opacity = "1";
            
            // Ù„Ùˆ ÙƒØ§Ù† ÙÙŠÙ‡ ØªØ§ÙŠÙ…Ø±ØŒ Ø§Ù„Ù†Øµ Ù‡ÙŠØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        }
    };
}

function togglePip() {
    const overlay = document.getElementById('callOverlay');
    overlay.classList.toggle('minimized');
}

    let localVideoTrack = null;

// Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
let isRenegotiating = false;

async function toggleVideoMode() {
    const videoBtn = document.getElementById('videoBtn');
    const localVidEl = document.getElementById('localVideo');
    const videoContainer = document.getElementById('videoContainer');
    const bg = document.getElementById('callBg');

    // === Ø­Ø§Ù„Ø© 1: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ===
    if (videoBtn.classList.contains('active-state')) {
        if (localVideoTrack) {
            localVideoTrack.stop(); // ÙˆÙ‚Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender) {
                peerConnection.removeTrack(sender);
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø¨Ø£Ù†Ù†Ø§ Ù‚ÙÙ„Ù†Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                createAndSendOffer();
            }
            localVideoTrack = null;
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        localVidEl.srcObject = null;
        videoContainer.style.display = 'none';
        bg.style.display = 'block';
        videoBtn.classList.remove('active-state');
        videoBtn.querySelector('i').className = "fa-solid fa-video-slash";
        
        if(document.getElementById('switchCamBtn')) 
            document.getElementById('switchCamBtn').style.display = 'none';
        document.getElementById('callInfoSection').style.display = 'flex'; // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø©
document.getElementById('callBg').style.display = 'block';      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
document.getElementById('callOverlay').classList.remove('video-active-mode');

    } 
    // === Ø­Ø§Ù„Ø© 2: ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ===
    else {
        try {
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            localVideoTrack = stream.getVideoTracks()[0];
            
            // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ÙŠ
            localVidEl.srcObject = stream;
            videoContainer.style.display = 'block'; 
            bg.style.display = 'none';

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø§ØªØµØ§Ù„
            if (peerConnection) {
                peerConnection.addTrack(localVideoTrack, localStream);
                // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ§ÙˆØ¶)
                await createAndSendOffer();
            }

            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            videoBtn.classList.add('active-state');
            videoBtn.querySelector('i').className = "fa-solid fa-video";
            
            if(document.getElementById('switchCamBtn')) 
                document.getElementById('switchCamBtn').style.display = 'flex';

        } catch (e) {
            console.error(e);
            alert("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function createAndSendOffer() {
    if(!peerConnection) return;
    try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø¨Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆÙ†ÙˆØ¹ Ø®Ø§Øµ "upgrade"
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
            offer: { type: offer.type, sdp: offer.sdp },
            type: 'video_upgrade' // Ø¹Ù„Ø§Ù…Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹ ÙŠØ¹Ø±Ù Ø¥Ù†Ù‡ ØªØ­Ø¯ÙŠØ« Ù…Ø´ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
        });
    } catch(err) {
        console.error("Renegotiation failed:", err);
    }
}

// Ø¯Ø§Ù„Ø© ØªØ³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠØ±Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ÙÙŠØ¯ÙŠÙˆ)
function listenForCallUpdates() {
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
      .onSnapshot(async snapshot => {
          const data = snapshot.data();
          
          // ØªØ£Ù…ÙŠÙ†: Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§ØªÙ‚ÙÙ„ØŒ Ø§Ø®Ø±Ø¬
          if (!data || !peerConnection) return;

          // ================= 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯) =================
          if (data.screenshot_alert) {
              const alert = data.screenshot_alert;
              const now = Date.now();
              // ØªØ­ÙˆÙŠÙ„ ØªÙˆÙ‚ÙŠØª ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù„ÙˆÙ‚Øª Ø¹Ø§Ø¯ÙŠ
              const alertTime = alert.timestamp ? alert.timestamp.toMillis() : 0;

              // Ø§Ù„Ø´Ø±Ø·: Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø´ Ø¨ØªØ§Ø¹ÙŠ (uid Ù…Ø®ØªÙ„Ù) + Ø­ØµÙ„ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ
              // (Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙØªØ­Øª Ø§Ù„ØµÙØ­Ø© ÙˆÙƒØ§Ù† ÙÙŠ ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¯ÙŠÙ… Ù…Ø§ÙŠØ¸Ù‡Ø±Ø´ ØªØ§Ù†ÙŠ)
              if (alert.uid !== currentUserId && (now - alertTime) < 5000) {
                  showToast("ğŸ“¸ Ø§Ù†ØªØ¨Ù‡: Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø§Ù„ØªÙ‚Ø· Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©!");
              }
          }

          // ================= 2. Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒÙ…Ø§ Ù‡Ùˆ) =================
          // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§ÙŠØ© "ØªØ­Ø¯ÙŠØ« ÙÙŠØ¯ÙŠÙˆ" ÙˆÙ…Ø´ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø¨Ø§Ø¹ØªÙ‡Ø§
          if (data.type === 'video_upgrade' && data.offer && peerConnection.signalingState !== "closed") {
             
              // ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ù…Ø´ Ø¨Ù†Ø¹Ù…Ù„ Ù„ÙˆØ¨ (Loop)
              if(data.offer.sdp === peerConnection.localDescription?.sdp) return; 

              try {
                  // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                  
                  // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯ (Answer) Ø¬Ø¯ÙŠØ¯
                  const answer = await peerConnection.createAnswer();
                  await peerConnection.setLocalDescription(answer);
                  
                  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
                  await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
                      answer: { type: answer.type, sdp: answer.sdp },
                      type: 'video_answered' // ØªÙ… Ø§Ù„Ø±Ø¯
                  });
                  
              } catch (err) {
                  console.error("Error handling video update:", err);
              }
          }
          
          // Ù„Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ ÙˆØ¬Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¯ (Answer)
          if (data.type === 'video_answered' && data.answer) {
              if (peerConnection.signalingState === 'have-local-offer') {
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
              }
          }
      });
}

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§ÙŠÙƒ ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
function monitorRemoteState() {
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
    .onSnapshot(doc => {
        const data = doc.data();
        if(!data || !data.states) return;

        // Ù‡Ø§Øª Ø£ÙŠ Ù…ÙØªØ§Ø­ Ù…Ø´ Ø¨ØªØ§Ø¹Ùƒ (ÙŠØ¹Ù†ÙŠ Ø¨ØªØ§Ø¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ)
        const otherUserKey = Object.keys(data.states).find(k => k !== currentUserId);
        
        if(otherUserKey) {
            const state = data.states[otherUserKey];
            const muteIcon = document.getElementById('remoteMuteIcon');
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØªÙ…
            if (state.muted) {
                muteIcon.style.display = 'flex';
            } else {
                muteIcon.style.display = 'none';
            }
        }
    });
}


// Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
async function initiateVideoCallUI() {
    await clearCandidates(); 
    // 1. ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ø´ØºÙˆÙ„ØŸ
    try {
        const callDoc = await db.collection('chats').doc(chatId).collection('calls').doc('active_call').get();
        if (callDoc.exists) {
            alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ØºÙˆÙ„ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© Ø£Ø®Ø±Ù‰ Ø­Ø§Ù„ÙŠØ§Ù‹");
            return; 
        }
    } catch (error) { console.error(error); }

    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setupCallUI('outgoing');
    
    try {
        // === Ù‡Ù†Ø§ Ø§Ù„ÙØ±Ù‚: Ø¨Ù†Ø·Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ + ØµÙˆØª Ù…Ù† Ø§Ù„Ø£ÙˆÙ„ ===
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        
        // === ØªØ¬Ù‡ÙŠØ² ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨ØªØ§Ø¹ÙŠ ÙÙˆØ±Ø§Ù‹ ===
        const localVidEl = document.getElementById('localVideo');
        const videoContainer = document.getElementById('videoContainer');
        const bg = document.getElementById('callBg');
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ±Ø§Ùƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø¹Ø±Ø¶Ù‡
        localVideoTrack = localStream.getVideoTracks()[0];
        localVidEl.srcObject = new MediaStream([localVideoTrack]);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ©
        videoContainer.style.display = 'block';
        bg.style.display = 'none';

        // === ØªÙ†ÙˆÙŠØ± Ø²Ø±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ÙƒÙ… ===
        const videoBtn = document.getElementById('videoBtn');
        if(videoBtn) {
            videoBtn.classList.add('active-state');
            videoBtn.querySelector('i').className = "fa-solid fa-video";
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ù†ÙŠÙ†
        const ringOut = document.getElementById('ringtoneOut');
        if (ringOut) { ringOut.currentTime = 0; ringOut.play().catch(()=>{}); }

        // Ø¥Ø¹Ø¯Ø§Ø¯ WebRTC
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
listenForRemoteCandidates();

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ (Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØµÙˆØª ÙˆØ§Ù„ØµÙˆØ±Ø©)
        peerConnection.ontrack = (event) => {
            const stream = event.streams[0];
            if (event.track.kind === 'audio') {
                document.getElementById('remoteAudio').srcObject = stream;
                handleCallConnected(event);
            }
            if (event.track.kind === 'video') {
                document.getElementById('remoteVideo').srcObject = stream;
                document.getElementById('callOverlay').classList.add('video-active-mode');
                document.getElementById('callInfoSection').style.display = 'none'; 
                document.getElementById('callBg').style.display = 'none';
            }
        };
        
        peerConnection.onicecandidate = (e) => {
            if (e.candidate) db.collection('chats').doc(chatId).collection('callCandidates').add(e.candidate.toJSON());
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø© isVideo
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').set({
            offer: { type: offer.type, sdp: offer.sdp },
            callerId: currentUserId,
            status: 'ringing',
            startTime: firebase.firestore.FieldValue.serverTimestamp(),
            isVideo: true // ğŸš© Ø¹Ù„Ø§Ù…Ø© Ø¥Ù† Ø¯ÙŠ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ
        });

        listenForAnswer();

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
        closeCallUI();
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Missing Part)
function listenForRemoteCandidates() {
    db.collection('chats').doc(chatId).collection('callCandidates')
      .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(async change => {
              if (change.type === 'added') {
                  const data = change.doc.data();
                  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø±Ø´Ø­ ØµØ§Ù„Ø­ ÙˆØ£Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙØªÙˆØ­
                  if (peerConnection && peerConnection.remoteDescription && data) {
                      try {
                          const candidate = new RTCIceCandidate(data);
                          await peerConnection.addIceCandidate(candidate);
                          console.log("New remote candidate added");
                      } catch (e) {
                          console.error("Error adding candidate:", e);
                      }
                  }
              }
          });
      });
}
async function clearCandidates() {
    const ref = db.collection('chats').doc(chatId).collection('callCandidates');
    const snapshot = await ref.get();
    const batch = db.batch();
    snapshot.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
}
let currentFacingMode = 'user'; // user = Ø£Ù…Ø§Ù…ÙŠØ©ØŒ environment = Ø®Ù„ÙÙŠØ©

async function switchCamera() {
    if (!localStream) return;
    const videoTrack = localStream.getVideoTracks()[0];
    if(!videoTrack) { showToast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ÙØ¹Ù„Ø©"); return; }

    try {
        const currentSettings = videoTrack.getSettings();
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        const nextMode = currentSettings.facingMode === 'environment' ? 'user' : 'environment';
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ù‡Ù… Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
        videoTrack.stop();
        localStream.removeTrack(videoTrack);

        const newStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: nextMode } },
            audio: false 
        });
        
        const newVideoTrack = newStream.getVideoTracks()[0];
        localVideoTrack = newVideoTrack; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
        if(sender) sender.replaceTrack(newVideoTrack);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        document.getElementById('localVideo').srcObject = newStream;
        localStream.addTrack(newVideoTrack);

    } catch (e) {
        console.error(e);
        // Fallback: Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† exact
        try {
             const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
             // ... Ù†ÙØ³ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« ...
             document.getElementById('localVideo').srcObject = newStream;
        } catch(err2) {
            showToast("ØªØ¹Ø°Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
        }
    }
}


// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ
function makeVideoDraggable() {
    const elmnt = document.getElementById("localVideo");
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    elmnt.onmousedown = dragMouseDown;
    elmnt.ontouchstart = dragMouseDown; // Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        if(e.type === 'touchstart') {
            pos3 = e.touches[0].clientX;
            pos4 = e.touches[0].clientY;
        } else {
            pos3 = e.clientX;
            pos4 = e.clientY;
        }
        
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
        
        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        // e.preventDefault(); // (Ù…Ù‡Ù…: Ù…ØªÙØ¹Ù„Ù‡Ø§Ø´ Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ§ØªØ´ ÙŠÙØ¶Ù„ Ø³Ù„Ø³)

        let clientX, clientY;
        if(e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        pos1 = pos3 - clientX;
        pos2 = pos4 - clientY;
        pos3 = clientX;
        pos4 = clientY;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø±ÙƒØ©
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ… (bottom/right) Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªØ´ØªØºÙ„ Ø­Ø±
        elmnt.style.bottom = "auto";
        elmnt.style.right = "auto";
    }

    function closeDragElement() {
        // ÙˆÙ‚Ù Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ø£ØµØ¨Ø¹
        document.onmouseup = null;
        document.onmousemove = null;
        document.ontouchend = null;
        document.ontouchmove = null;
    }
}
async function takeSnapshot() {
    const video = document.getElementById('remoteVideo');
    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„
    if (!video || video.readyState < 2 || video.paused) { 
        showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ø§Ù„ØªÙ‚Ø§Ø·Ù‡ ğŸ“·");
        return; 
    }

    // 1. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    // 2. ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ù†Ø¯Ùƒ
    const dataURL = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `Wareed_Snap_${Date.now()}.png`;
    a.click();
    
    // 3. ØªØ£Ø«ÙŠØ± Ø§Ù„ÙÙ„Ø§Ø´
    const flash = document.createElement('div');
    flash.style.cssText = "position:fixed; inset:0; background:white; z-index:10000; opacity:0.8; transition:opacity 0.2s;";
    document.body.appendChild(flash);
    setTimeout(() => { flash.style.opacity = '0'; setTimeout(()=>flash.remove(), 200) }, 50);

    // 4. âœ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¹Ø¨Ø± Firebase
    try {
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
            screenshot_alert: { 
                uid: currentUserId, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            }
        });
        showToast("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ğŸ“¸");
    } catch(e) { console.error(e); }
}

    
async function toggleMute() { 
    if(localStream) { 
        const track = localStream.getAudioTracks()[0]; 
        track.enabled = !track.enabled; 
        
        const btn = document.getElementById('muteBtn');
        if(track.enabled) {
            btn.classList.remove('active-state');
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        } else {
            btn.classList.add('active-state');
            btn.innerHTML = '<i class="fa-solid fa-microphone-slash" style="color:#000"></i>';
        }

        // === Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø³ÙŠØ±ÙØ± ===
        try {
            await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
                [`states.${currentUserId}.muted`]: !track.enabled
            });
        } catch(e) {}
    } 
}


    let screenSender = null; // Ø¹Ø´Ø§Ù† Ù†Ù…Ø³Ùƒ Ø§Ù„ØªØ±Ø§Ùƒ ÙˆÙ†Ø¹Ø±Ù Ù†Ø­Ø°ÙÙ‡ Ù„Ù…Ø§ Ù†ÙˆÙ‚Ù

// ================= Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) =================
async function toggleScreenShare() {
    const btn = document.getElementById('shareScreenBtn');

    // === Ø­Ø§Ù„Ø© 1: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§) ===
    if (btn.classList.contains('active-state')) {
        await stopScreenShare();
        return;
    }

    // === Ø­Ø§Ù„Ø© 2: Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ===
    try {
        // Ø·Ù„Ø¨ ØªØµØ±ÙŠØ­ Ø§Ù„Ø´Ø§Ø´Ø© (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‚Ø¯ ÙŠØ·Ù„Ø¨ Ø¥Ø°Ù† Ø¥Ø¶Ø§ÙÙŠ)
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
        const screenTrack = stream.getVideoTracks()[0];

        // 1. Ø­ÙØ¸ ØªØ±Ø§Ùƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† Ù†Ø±Ø¬Ø¹Ù„Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†
        if (localVideoTrack) {
            cachedCameraTrack = localVideoTrack;
        }

        // 2. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        if (peerConnection) {
            const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
            if (sender) {
                await sender.replaceTrack(screenTrack);
            }
        }

        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ÙŠ Ø£Ù†Ø§ ÙƒÙ…Ø§Ù† Ø¨Ø¯Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ØµØºÙŠØ±Ø©
        document.getElementById('localVideo').srcObject = stream;

        // 4. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±
        btn.classList.add('active-state');
        btn.innerHTML = '<i class="fa-solid fa-rectangle-xmark" style="color:#ff3b30"></i>'; // Ø²Ø± Ø£Ø­Ù…Ø± Ù„Ù„Ø¥ØºÙ„Ø§Ù‚

        // 5. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©" Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„/Ø§Ù„Ù…ØªØµÙØ­
        screenTrack.onended = () => {
            stopScreenShare();
        };

    } catch (err) {
        console.error("Screen Share Error:", err);
        if (err.name === 'NotAllowedError') {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†
        } else {
            alert("Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function stopScreenShare() {
    const btn = document.getElementById('shareScreenBtn');
    
    // 1. Ù„Ùˆ ÙƒÙ†Ø§ Ø­Ø§ÙØ¸ÙŠÙ† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ù†Ø±Ø¬Ø¹Ù‡Ø§
    if (cachedCameraTrack && peerConnection) {
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        if (sender) {
            await sender.replaceTrack(cachedCameraTrack);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
        const camStream = new MediaStream([cachedCameraTrack]);
        document.getElementById('localVideo').srcObject = camStream;
    }

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    btn.classList.remove('active-state');
    btn.innerHTML = '<i class="fa-solid fa-desktop"></i>';
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    cachedCameraTrack = null;
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±)
    // createAndSendOffer(); 
}

// ================= Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø± (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹) =================
function toggleSendButton() {
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const leftActions = document.getElementById('leftActions');

    const hasText = input.value.trim().length > 0;

    if (hasText) {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ---
        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø§ÙŠÙƒ
        sendBtn.style.display = 'flex';
        micBtn.style.display = 'none';

        // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ø´Ø§Ù† Ù†ÙˆØ³Ø¹ Ù„Ù„ÙƒØªØ§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        // Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„Ø²Ø±Ø§ÙŠØ± ØªÙØ¶Ù„ Ø¸Ø§Ù‡Ø±Ø© Ø§Ù…Ø³Ø­ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ ØªØ­Øª Ø¯Ù‡
        if(leftActions) leftActions.classList.add('hidden');

    } else {
        // --- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© ---
        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø§ÙŠÙƒ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendBtn.style.display = 'none';
        micBtn.style.display = 'flex';

        // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
        if(leftActions) leftActions.classList.remove('hidden');
    }
}



    // ÙƒÙˆØ¯ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØºØµØ¨ Ø¹Ù† Ø§Ù„Ù…ØªØµÙØ­
    // ================= Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠØ© =================
function playSmartRingtone(type) {
    if (type === 'incoming' && typeof isMuted !== 'undefined' && isMuted) {
        // Ù…Ù…ÙƒÙ† ØªØ´ØºÙ„ Ù‡Ø²Ø§Ø² Ø¨Ø³ ÙƒØ¨Ø¯ÙŠÙ„
        if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        return; 
    }

    var audio;
    if (type === 'incoming') {
        audio = document.getElementById('ringtoneIn'); // Ø±Ù†Ø© Ø¬Ø§ÙŠØ©
    } else {
        audio = document.getElementById('ringtoneOut'); // Ø£Ù†Ø§ Ø¨ØªØµÙ„
    }

    if (audio) {
        audio.currentTime = 0;
        audio.volume = 1.0;
        
        var playPromise = audio.play();

        if (playPromise !== undefined) {
            playPromise.then(_ => {
                console.log("Ringtone started!");
            })
            .catch(error => {
                console.warn("Audio blocked, forcing vibration...");
                if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
            });
        }
    }
}

// ================= Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠØ© =================
function stopSmartRingtone() {
    ['ringtoneIn', 'ringtoneOut', 'callEndSound'].forEach(id => {
        var audio = document.getElementById(id);
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    });
    if (navigator.vibrate) navigator.vibrate(0);
}

// ================= Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ÙˆØ§Ù„Ù…ØµØ­Ø­Ø© =================
// ================= Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ØµÙˆØ§Øª (Ø±ÙˆØ§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ…Ø¶Ù…ÙˆÙ†Ø©) =================
const audioLibrary = {
    // ØµÙˆØª Ø§Ù„Ù†Ù‚Ø± (ØªÙƒØ© Ø®ÙÙŠÙØ©)
    click: new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"),
    // ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Pop)
    sent: new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"),
    // ØµÙˆØª Ø§Ù„ØªØ¯Ù…ÙŠØ±/Ø§Ù„ØªØ­Ø°ÙŠØ±
    destruct: new Audio("https://actions.google.com/sounds/v1/alarms/phone_alert.ogg"),
    // ØµÙˆØª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    record: new Audio("https://actions.google.com/sounds/v1/science_fiction/hum_short.ogg")
};
// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© (Ø¨ØªÙ…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ùˆ Ø§Ù„Ù†Øª Ø¨Ø·ÙŠØ¡)
function playUiSound(type) {
    // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù„Ùˆ Ø§Ù„ÙƒØªÙ… Ø´ØºØ§Ù„ØŒ ÙˆÙ‚Ù Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ ÙˆÙ…Ø·Ù„Ø¹Ø´ ØµÙˆØª
    if (typeof isMuted !== 'undefined' && isMuted) return;

    const sound = audioLibrary[type];
    if (sound) {
        sound.currentTime = 0; 
        sound.volume = 0.5;    
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // console.log("Ø§Ù„ØµÙˆØª Ù…Ø­ØªØ§Ø¬ ØªÙØ§Ø¹Ù„");
            });
        }
    }

}

    // 1. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¹ÙŠÙ† (Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù…Ù„Ù)
// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ø³Ù†Ø¬Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚)
function getEyeStatusHTML(msg, isMe, isLastSeenMessage) {
    // 1. Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ Ø£Ùˆ Ù…Ø­Ø°ÙˆÙØ© -> ÙˆÙ„Ø§ Ø­Ø§Ø¬Ø©
    if (!isMe || msg.type === 'deleted') return '';

    // 2. Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Seen)
    if (msg.seen) {
        // Ø§Ù„Ø´Ø±Ø·: Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ù‡ÙŠ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ø§ØªØ´Ø§ÙØª (Ø¹Ø´Ø§Ù† Ù…Ù†ÙƒØ±Ø±Ø´ Ø§Ù„ØµÙˆØ±Ø©)
        if (isLastSeenMessage) {
            
            // Ù†Ø¬ÙŠØ¨ ØµÙˆØ±Ø© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ù† Ø§Ù„ÙƒØ§Ø´
            let otherPic = 'https://i.ibb.co/tZ5tPqB/default-avatar.png'; // ØµÙˆØ±Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            
            // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            if (cachedOtherUserId && userCache[cachedOtherUserId]) {
                otherPic = userCache[cachedOtherUserId].profilePic || otherPic;
            }

            // Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø©
            return `<div class="seen-avatar-icon" style="background-image: url('${otherPic}');" title="Ø´ÙˆÙ‡Ø¯"></div>`;
        } else {
            // Ù„Ùˆ Ø§ØªØ´Ø§ÙØª Ø¨Ø³ ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯Ù‡Ø§ Ø§ØªØ´Ø§ÙØª -> Ù†Ø®Ù„ÙŠÙ‡Ø§ ÙØ§Ø¶ÙŠØ© (Ù†Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ Ø§Ù„Ù…Ø§Ø³Ù†Ø¬Ø±)
            return ''; 
        }
    }

    // 3. Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Delivered) - Ù„Ù… ØªØ´Ø§Ù‡Ø¯ Ø¨Ø¹Ø¯
    // (Ù†Ø¸Ù‡Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ Ø¹Ø§Ø¯ÙŠ)
    const headerStatus = document.getElementById('headerStatus');
    const isOnline = headerStatus && (headerStatus.innerText.includes('Ù†Ø´Ø·') || headerStatus.innerText.includes('Ù…ØªØµÙ„'));
    
    if (isOnline) {
        return '<i class="fa-solid fa-circle-check" style="color:#3b82f6; font-size:12px;"></i>'; // Ø£Ø²Ø±Ù‚ Ù…ØµÙ…Øª
    } else {
        return '<i class="fa-regular fa-circle-check" style="color:rgba(255,255,255,0.3); font-size:12px;"></i>'; // Ù…ÙØ±Øº
    }
}


// 2. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø´ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù…Ù„Ù)
function buildMessageHTML(msg, id, u) {
    const isMe = msg.uid === currentUserId;
    let content = "";
    
    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    if (msg.type === 'deleted') content = `<span style="font-style:italic;color:#94a3b8;"><i class="fa-solid fa-ban"></i> ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>`;
    else if (msg.type === 'text') content = linkify(escapeHtml(msg.text));
    else if (msg.type === 'image') content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`;
                    else if (msg.type === 'video') {
    const vidId = `vid_inline_${doc.id}`;
    // Ù†Ø³ØªØ®Ø¯Ù… msg.text Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø£Ù†Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const videoUrl = msg.text; 

    content = `
    <div class="video-msg-wrapper" style="position: relative; border-radius: 16px; overflow: hidden; background: #000; width: 260px; aspect-ratio: 4/5;">
        
        <video id="${vidId}" src="${videoUrl}#t=0.1" preload="metadata" playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
        
        <div class="video-overlay" style="position: absolute; inset: 0; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
            
            <div class="center-play-btn" onclick="toggleInlinePlay('${vidId}', event)" style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.3);">
                <i class="fa-solid fa-play" style="color: #fff; font-size: 20px;"></i>
            </div>

            <div class="expand-icon" 
                 onclick="event.stopPropagation(); console.log('Opening Pro Player:', '${videoUrl}'); openProPlayer('${videoUrl}');" 
                 style="position: absolute; bottom: 10px; right: 10px; width: 35px; height: 35px; background: rgba(0, 0, 0, 0.7); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50;">
                <i class="fa-solid fa-expand" style="color: #fff; font-size: 16px;"></i>
            </div>
            
            <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px;">ÙÙŠØ¯ÙŠÙˆ</div>
        </div>
    </div>`;
    
    bubbleClass += " media-bubble";
}

// ... Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (image, video, etc.)

    // ================= ÙƒÙˆØ¯ ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Add inside buildMessageHTML) =================
    // ================= ÙƒÙˆØ¯ ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù†Ø§Ù‚Øµ) =================
else if (msg.type === 'profile_card') {
    // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø©
    const pImage = msg.profileImage || 'https://i.ibb.co/tZ5tPqB/default-avatar.png';
    
    content = `
    <div class="profile-share-card">
        <div class="psc-header">
            <div class="psc-avatar" style="background-image: url('${pImage}')"></div>
            <div class="psc-info">
                <div class="psc-name">${msg.profileName}</div>
                <div class="psc-subtitle">Ù…Ù„Ù Ø´Ø®ØµÙŠ ğŸ‘¤</div>
            </div>
        </div>
        <div class="psc-actions">
            <button class="psc-btn psc-btn-primary" onclick="window.location.href='profile.html?uid=${msg.profileUid}'">
                Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            </button>
            <button class="psc-btn psc-btn-secondary" onclick="window.location.href='chat.html?chatId=new&uid=${msg.profileUid}'">
                <i class="fa-regular fa-comment-dots"></i> Ù…Ø±Ø§Ø³Ù„Ø©
            </button>
        </div>
    </div>`;
    
    // Ù†Ø®Ù„ÙŠ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø´ÙØ§ÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒØ§Ø±Øª ÙŠØ¨Ø§Ù† Ø¨Ø­Ø¯ÙˆØ¯Ù‡ Ù‡Ùˆ
    bubbleClass += " transparent-bubble";
}
// =====================================================================

 // ================= ÙƒÙˆØ¯ Ø§Ù„ØªØµÙˆÙŠØª (Poll) =================
else if (msg.type === 'poll') {
    let totalVotes = 0;
    const votesObj = msg.votes || {};
    Object.values(votesObj).forEach(v => totalVotes += v);

    let optionsHtml = '';
    msg.options.forEach((opt) => {
        const count = votesObj[opt] || 0;
        let percent = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
        
        optionsHtml += `
        <div class="poll-option-modern" onclick="handleVote('${doc.id}', '${opt}')">
            <div class="poll-progress-bar" style="width: ${percent}%;"></div>
            <div class="poll-option-content">
                <div style="display:flex; align-items:center;">
                    <div class="poll-radio"></div> <span>${opt}</span>
                </div>
                <span class="poll-percent">${percent}%</span>
            </div>
        </div>`;
    });

    content = `
    <div class="poll-card-modern ${totalVotes > 0 ? 'voted' : ''}">
        <div class="poll-question-modern">${msg.question}</div>
        <div class="poll-options-list">${optionsHtml}</div>
        <div class="poll-footer-modern">
            <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª: ${totalVotes}</span>
            <span>${formatTime(msg.createdAt)}</span>
        </div>
    </div>`;
    
    // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ğŸ”¥ğŸ”¥ğŸ”¥
    bubbleClass += " transparent-bubble"; 
}

// ================= ÙƒÙˆØ¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Contact) =================
else if (msg.type === 'contact') {
    content = `
    <div class="msg-contact-card" onclick="window.location.href='tel:${msg.contactNumber}'">
        <div class="contact-icon-box"><i class="fa-solid fa-user"></i></div>
        <div class="contact-info-box">
            <div class="contact-name-text">${msg.contactName}</div>
            <div class="contact-number-text" dir="ltr">${msg.contactNumber}</div>
        </div>
        <div class="contact-action-btn"><i class="fa-solid fa-phone"></i></div>
    </div>`;
    
    // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ğŸ”¥ğŸ”¥ğŸ”¥
    bubbleClass += " transparent-bubble";
}

    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ...


// ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø±ÙˆØ·

    else if (msg.type === 'audio') content = generateAudioPlayer(msg.text, id);
    else if (msg.type === 'file') content = `<div class="file-card" onclick="window.open('${msg.text}')"><i class="fa-solid fa-file"></i> Ù…Ù„Ù</div>`;
    else if (msg.type === 'call_log') content = `<div class="call-card-inner">ğŸ“ ${msg.text==='no_answer'?'Ù…ÙƒØ§Ù„Ù…Ø© ÙØ§Ø¦ØªØ©':'Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª'}</div>`;
    else if (msg.type === 'story_reply') {
        let mediaTag = msg.storyType === 'video' 
            ? `<video src="${msg.storyUrl}" class="story-reply-media" muted></video>`
            : `<img src="${msg.storyUrl}" class="story-reply-media">`;
            
        content = `
        <div class="story-reply-container" onclick="window.open('${msg.storyUrl}', '_blank')">
            <div class="story-media-wrapper">${mediaTag}</div>
            <div class="story-reply-content">
                <div class="reply-label">Ø±Ø¯ Ø¹Ù„Ù‰ Ù‚ØµØªÙƒ</div>
                <div class="reply-text-body">${linkify(escapeHtml(msg.text))}</div>
            </div>
        </div>`;
    }
let reactionHtml = "";
    if (msg.reaction) {
        reactionHtml = `<div class="msg-reaction">${msg.reaction}</div>`;
    }

    return `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'}" id="msg_${id}">
        ${!isMe ? miniAvatar : ''}
        <div class="${bubbleClass}" style="position: relative;">
            ${!isMe ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
            
            ${replyHtml}
            <div>${content}</div>
            
            ${reactionHtml}

            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                <span class="msg-time">${timeText}</span>
            </div>
        </div>
    </div>`;


    // Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
    let bombHtml = "";
    if (msg.selfDestruct && msg.type !== 'deleted') {
         bombHtml = `<div id="bomb_${id}" class="bomb-info"><i class="fa-solid fa-bomb"></i></div>`;
    }
    
    
    // 2. Ø¥Ø¶Ø§ÙØ© replyHtml Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    return `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'}" id="msg_${id}">
        ${!isMe ? miniAvatar : ''}
        <div class="${bubbleClass}">
            ${!isMe ? `
    <div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px; display:flex; align-items:center; gap:4px;">
        ${u.name}
        ${u.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#00e5ff; font-size:10px;"></i>' : ''}
    </div>
` : ''}
            
            ${replyHtml}
            
            <div>${content}</div>
            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                <span class="msg-time">${timeText}</span>
            </div>
        </div>
    </div>`;


    // Ø§Ù„Ø¹ÙŠÙ† ÙˆØ§Ù„ÙˆÙ‚Øª
    // 3. Ø¨Ù†Ø¨Ø¹Øª Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø«Ø§Ù„Ø« Ù„Ù„Ø¯Ø§Ù„Ø©
// Ù†Ù…Ø±Ø± Ø§Ù„Ù€ ID Ø§Ù„Ù„ÙŠ Ù„Ù‚Ø·Ù†Ø§Ù‡ ÙÙˆÙ‚ Ù„Ù„Ø¯Ø§Ù„Ø©
const eyeHtml = getEyeStatusHTML(msg, isMe, (doc.id === lastSeenMsgId));

    const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
    const avatar = `<div class="msg-user-avatar" style="background-image:url('${u.profilePic}');">${u.char}</div>`;

    return `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'}" id="msg_${id}">
        ${!isMe ? avatar : ''}
        <div class="msg-bubble target-bubble ${msg.type==='deleted'?'deleted':''}">
            ${!isMe ? `<div style="color:${u.color};font-size:11px;font-weight:bold;">${u.name}</div>` : ''}
            <div>${content}</div>
            ${bombHtml}
            <div class="msg-meta-row" style="display:flex;justify-content:flex-end;gap:5px;">
                <span class="msg-time">${timeText}</span>
                <span id="status_${id}">${eyeHtml}</span>
            </div>
        </div>
    </div>`;
}
    // Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±
const moodDictionary = {
    // ğŸ˜„ Ø§Ù„ÙØ±Ø­ ÙˆØ§Ù„Ø¶Ø­Ùƒ ÙˆØ§Ù„Ø±ÙˆÙ‚Ø§Ù†
    happy: [
        'Ù‡Ù‡Ù‡Ù‡', 'Ø³Ø¹ÙŠØ¯', 'ÙØ±Ø­Ø§Ù†', 'lol', 'happy', 'ğŸ˜‚', 'Ø¹Ø¸ÙŠÙ…', 'Ø­Ù„Ùˆ', 'Ø¬Ù…ÙŠÙ„', 
        'Ù…Ø¨Ø±ÙˆÙƒ', 'Ø¬Ø§Ù…Ø¯', 'Ø¹Ø³Ù„', 'Ù‚Ø´Ø·Ø©', 'ØªÙ…Ø§Ù…', 'wow', 'good', 'nice', 'rofl', 
        'lmao', 'yay', 'ğŸ‰', 'ğŸ‘Œ', 'ğŸ‘', 'Ø±Ø§ÙŠÙ‚', 'Ù…Ø¨Ø³ÙˆØ·', 'Ø¶Ø­Ùƒ', 'Ù…Ø³Ø®Ø±Ø©', 
        'ÙÙ„', 'Ø¹Ø¸Ù…Ø©', 'excellent', 'amazing', 'haha', 'Ø®Ø±Ø§ÙÙŠ', 'Ø¹Ø§Ø´', 'Ø¨Ø·Ù„'
    ],

    // â¤ï¸ Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„ØºØ²Ù„ ÙˆØ§Ù„Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©
    love: [
        'Ø­Ø¨', 'Ø¨Ø­Ø¨Ùƒ', 'Ø¹Ø´Ù‚', 'love',, 'â¤ï¸', 'ğŸ˜', 'Ø­Ø¨ÙŠØ¨ÙŠ', 'Ø¹Ù…Ø±ÙŠ', 'Ù‚Ù„Ø¨ÙŠ', 
        'Ø±ÙˆØ­ÙŠ', 'ÙˆØ­Ø´ØªÙ†ÙŠ', 'miss', 'baby', 'honey', 'cute', 'Ù‚Ù…Ø±', 'Ø³ÙƒØ±', 
        'Ø¹Ø³Ù„', 'ğŸ˜˜', 'ğŸ˜»', 'ğŸ’–', 'adore', 'Ø¨Ø¹Ø´Ù‚Ùƒ', 'Ø§Ù…ÙˆØª ÙÙŠÙƒ', 'Ø­ÙŠØ§ØªÙŠ', 
        'Ø¹ÙŠÙˆÙ†ÙŠ', 'Ø¬Ù…ÙŠÙ„ØªÙŠ', 'Ø§Ù…ÙŠØ±ÙŠ', 'Ø¹Ø§Ø´Ù‚', 'Ù…ØºØ±Ù…', 'Ø¨Ù…ÙˆØª ÙÙŠÙƒ', 'ØºØ§Ù„ÙŠ', 'xoxo'
    ],

    // ğŸ˜¡ Ø§Ù„ØºØ¶Ø¨ ÙˆØ§Ù„Ø´ØªØ§Ø¦Ù… ÙˆØ§Ù„Ø±ÙØ¶
    angry: [
        'ØºØ§Ø¶Ø¨', 'Ø²ÙØª', 'ØºØ¨ÙŠ', 'angry', 'ğŸ˜¡', 'ğŸ¤¬', 'Ø§ÙƒØ±Ù‡Ùƒ', 'Ø­ÙŠÙˆØ§Ù†', 
        'Ù…ØªØ®Ù„Ù', 'Ø­Ù…Ø§Ø±', 'Ø®Ø±Ø§', 'wtf', 'hate', 'stupid', 'idiot', 'shut up', 
        'Ø§Ø®Ø±Ø³', 'ØºÙˆØ±', 'Ù‚Ø±Ù', 'Ù…Ù‚Ø±Ù', 'Ø¨ÙƒØ±Ù‡Ùƒ', 'ØªØ¨Ø§', 'damn', 'hell', 
        'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ‘', 'Ù†Ø±ÙØ²Ø©', 'Ø¹ØµØ¨ÙŠØ©', 'Ù…ØªØ¹ØµØ¨', 'ÙƒÙ„Ø¨', 'Ø­Ù‚ÙŠØ±', 'Ø§Ù…Ø´', 'Ø¨Ø·Ù„'
    ],

  
    sad: [
        'Ø­Ø²ÙŠÙ†', 'Ø²Ø¹Ù„Ø§Ù†', 'Ù…ÙƒØªØ¦Ø¨', 'sad', 'ğŸ˜¢', 'ğŸ˜­', 'ØªØ¹Ø¨Øª', 'Ù…Ø®Ù†ÙˆÙ‚', 
        'Ø¨Ù…ÙˆØª', 'ØªØ¹Ø¨Ø§Ù†', 'ÙˆØ­Ø¯ÙŠ', 'sorry', 'depressed', 'lonely', 'cry', 
        'pain', 'heartbroken', 'Ø§Ø³Ù', 'Ù†Ø¯Ù…Ø§Ù†', 'Ø®Ø³Ø§Ø±Ø©', 'ğŸ’”', 'ğŸ˜', 'ğŸ˜”', 
        'Ù…Ù„ÙŠØ´ Ù†ÙØ³', 'Ù…ÙˆØ¬ÙˆØ¹', 'ÙŠØ£Ø³', 'Ù…Ø­Ø¨Ø·', 'ÙØ±Ø§Ù‚', 'ÙˆØ¯Ø§Ø¹', 'bye', 'ØªØ¹Ø¨', 'Ù‡Ù…'
    ]
};


function detectMood(text) {
    const inputContainer = document.querySelector('.input-container');
    const sendBtn = document.querySelector('.send-btn');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    inputContainer.classList.remove('mood-happy', 'mood-love', 'mood-angry', 'mood-sad');
    if(sendBtn) sendBtn.style.background = ""; // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ù„Ù„Ø£ØµÙ„

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ
    for (const [mood, keywords] of Object.entries(moodDictionary)) {
        if (keywords.some(keyword => text.includes(keyword))) {
            inputContainer.classList.add(`mood-${mood}`);
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠØ¶Ø§Ù‹
            if(mood === 'happy') sendBtn.style.background = "linear-gradient(135deg, #f59e0b, #fbbf24)";
            if(mood === 'love') sendBtn.style.background = "linear-gradient(135deg, #db2777, #ec4899)";
            if(mood === 'angry') sendBtn.style.background = "linear-gradient(135deg, #dc2626, #ef4444)";
            if(mood === 'sad') sendBtn.style.background = "linear-gradient(135deg, #2563eb, #3b82f6)";
            break; // Ù†ÙƒØªÙÙŠ Ø¨Ø£ÙˆÙ„ Ø´Ø¹ÙˆØ± Ù†Ø¬Ø¯Ù‡
        }
    }
}


// ================= 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ =================
let isGhostMode = localStorage.getItem('wareed_ghost_mode') === 'true';

// ================= 2. ÙƒÙˆØ¯ Ø¨ÙŠØ´ØªØºÙ„ Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­ =================
document.addEventListener("DOMContentLoaded", function() {
    
    // Ø£) Ù„Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ÙƒØ§Ù† Ø´ØºØ§Ù„ØŒ Ù†ÙØ¹Ù„Ù‡ ØªØ§Ù†ÙŠ ÙˆÙ†Ù†ÙˆØ± Ø§Ù„Ø²Ø±Ø§Ø±
    if (isGhostMode) {
        document.body.classList.add('ghost-active');
        const toggleIcon = document.getElementById('ghostToggleIcon');
        if (toggleIcon) {
            toggleIcon.className = "fa-solid fa-toggle-on";
            toggleIcon.style.color = "#00e5ff";
        }
    }

    // Ø¨) Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù) Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙˆÙ‚
    const overlayIds = ['profilePage', 'deleteModal', 'callOverlay', 'contextMenuOverlay', 'lightbox', 'previewModal'];
    overlayIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.parentNode) {
            document.body.appendChild(element); // Ù†Ù‚Ù„ Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
        }
    });
});

// ================= 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ù„Ø­Ø±Ù‚) =================
async function purgeGhostMessages() {
    if (!chatId || !currentUserId) return;
    try {
        // Ù†Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ø´Ø¨Ø­ Ø¨ØªØ§Ø¹ØªÙŠ
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .where("uid", "==", currentUserId)
            .where("isGhost", "==", true)
            .get();

        if (snapshot.empty) return;

        // Ù†Ø­Ø°ÙÙ‡Ù… ÙƒÙ„Ù‡Ù…
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        showToast("ğŸ’¨ ØªÙ… Ø­Ø°Ù Ø¢Ø«Ø§Ø± Ø§Ù„Ø´Ø¨Ø­");
    } catch (e) { console.error(e); }
}
// ================= 1. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… =================
function sendGhostLog(action) {
    if (!chatId || !currentUserId) return;
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ù†Ø¸Ø§Ù…" (Ù„Ù† ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù„Ø£Ù† isGhost Ù…Ø´ true)
    db.collection("chats").doc(chatId).collection("messages").add({
        type: 'system',       // Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
        text: action,         // 'on' Ø£Ùˆ 'off'
        uid: currentUserId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false,
        isGhost: false        // ğŸ”¥ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¹Ø´Ø§Ù† Ù…ØªØªÙ…Ø³Ø­Ø´ Ù…Ø¹ Ø§Ù„Ø­Ø±Ù‚
    });
}

// ================= 2. Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„ =================
function toggleGhostMode() {
    isGhostMode = !isGhostMode;
    localStorage.setItem('wareed_ghost_mode', isGhostMode);

    const toggleIcon = document.getElementById('ghostToggleIcon');
    
    if (isGhostMode) {
        // -- ØªØ´ØºÙŠÙ„ --
        document.body.classList.add('ghost-active');
        showToast("ğŸ‘» ØªÙ… ØªØ«Ø¨ÙŠØª ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­");
        playUiSound('destruct');
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹
        sendGhostLog('ghost_on'); 
        
        if(toggleIcon) {
            toggleIcon.className = "fa-solid fa-toggle-on";
            toggleIcon.style.color = "#00e5ff"; 
        }
    } else {
        // -- Ø¥ÙŠÙ‚Ø§Ù --
        purgeGhostMessages(); // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹
        sendGhostLog('ghost_off');

        document.body.classList.remove('ghost-active');
        showToast("ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„");
        
        if(toggleIcon) {
            toggleIcon.className = "fa-solid fa-toggle-off";
            toggleIcon.style.color = "#64748b";
        }
    }
}


// ============================================================
// ğŸ§¹ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ©: ØªÙ†Ø¸ÙŠÙ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø¨Ø­ Ø§Ù„Ø¹Ø§Ù„Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
// ============================================================

// 1. ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù…Ù„Øª Ø±ÙŠÙØ±Ø´ ÙˆØ§Ù„Ø±Ø³Ø§ÙŠÙ„ Ù„Ø³Ù‡ Ù…ÙˆØ¬ÙˆØ¯Ø©)
window.addEventListener('DOMContentLoaded', () => {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (currentUserId && chatId) {
        purgeGhostMessages();
    }
});
// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© loadChatDetails Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
async function loadChatDetails() {
    // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù€ UID Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© ÙÙˆØ±Ø§Ù‹ ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©
    // (Ù„Ø£Ù†Ùƒ Ù„Ù…Ø§ Ø¨ØªØ­Ø°Ù Ø§Ù„Ø´Ø§ØªØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªØªÙ…Ø³Ø­ØŒ ÙÙ„Ø§Ø²Ù… Ù†Ø¬ÙŠØ¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·)
    const urlUid = params.get("uid");
    
    if (urlUid && urlUid !== 'undefined' && urlUid !== 'null') {
        cachedOtherUserId = urlUid;
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø´Ø§Øª Ù…Ø­Ø°ÙˆÙ
        updateHeader(urlUid);
        listenForBlockStatus();
    }
if (chatId) {
    listenForSharedNicknames();
}
    if (!chatId || !currentUserId) return;

    try {
        const chatDoc = await db.collection("chats").doc(chatId).get();
        
        if (chatDoc.exists) {
            const data = chatDoc.data();
            let otherUserId = null;

            if (data.users && Array.isArray(data.users)) {
                otherUserId = data.users.find(id => id !== currentUserId);
            }
            else if (data.participants) {
                 otherUserId = data.participants.find(id => id !== currentUserId);
            }
            else {
                if (data.senderId && data.senderId !== currentUserId) otherUserId = data.senderId;
                else if (data.sentTo && data.sentTo !== currentUserId) otherUserId = data.sentTo;
            }

            // Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²ØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯
            if (otherUserId) {
                cachedOtherUserId = otherUserId; 
                updateHeader(otherUserId);
                listenForBlockStatus();
            }
        } else {
            // ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ù‡Ù…Ø©: Ø§Ù„Ø´Ø§Øª Ù…Ø­Ø°ÙˆÙ (Doc doesn't exist)
            console.log("Ø§Ù„Ø´Ø§Øª Ù…Ø­Ø°ÙˆÙ Ø£Ùˆ Ø¬Ø¯ÙŠØ¯ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·:", cachedOtherUserId);
            
            // Ù„Ùˆ Ù…Ø¹Ø§Ù†Ø§ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ù…Ù† Ø£ÙˆÙ„ Ø®Ø·ÙˆØ©)ØŒ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡ØªÙƒÙ…Ù„ Ø¹Ø§Ø¯ÙŠ
            // ÙˆØ¯Ø§Ù„Ø© ensureChatActive Ù‡ØªÙ‚Ø¯Ø± ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø§Øª
        }
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø§Øª:", e);
    }
}

// ================= Ø£ÙƒÙˆØ§Ø¯ ØªØ´ØºÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =================
// 1. Ø²Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« (Ø¨ÙŠØªØ­Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
// ================================================================
// ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ + Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø§Ù„Ø­Ø±Ù)
// ================================================================

// 1. Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ØªØ±Ø¨Ø·Ù‡ Ø¨Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
function toggleSearchMode() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ù…ÙØªÙˆØ­Ø©
    if(typeof closeProfile === 'function') closeProfile();
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù†ØµÙ†Ø¹Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
    ensureSearchOverlayExists();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    const overlay = document.getElementById('fullSearchOverlay');
    overlay.style.display = 'flex';
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆÙ…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const input = document.getElementById('fullSearchInput');
    input.value = '';
    input.focus();
    
    // ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('searchResultsList').innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; color:#64748b;">
            <i class="fa-solid fa-magnifying-glass" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
            <p>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« (Ø­Ø±Ù Ø¨Ø­Ø±Ù)...</p>
        </div>`;
}

// 2. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø¹Ø´Ø§Ù† ØªØ¶Ù…Ù† Ø¥Ù†Ù‡Ø§ ØªØ¸Ù‡Ø±)
function ensureSearchOverlayExists() {
    if (document.getElementById('fullSearchOverlay')) return; // Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø®Ù„Ø§Øµ

    // Ø£) Ø­Ù‚Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… (CSS)
    const style = document.createElement('style');
    style.innerHTML = `
        .search-overlay-full {
            position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #0b1121; z-index: 999999 !important;
            display: none; flex-direction: column; animation: fadeIn 0.2s;
        }
        .search-header {
            display: flex; align-items: center; gap: 10px; padding: 15px;
            background: rgba(15, 25, 38, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .search-input-box {
            flex: 1; background: rgba(255,255,255,0.05); border-radius: 20px;
            padding: 8px 15px; display: flex; align-items: center; gap: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .search-input-field {
            background: transparent; border: none; color: #fff; width: 100%;
            font-size: 15px; font-family: inherit; outline: none;
        }
        .search-results-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .search-result-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .search-result-item:active { background: rgba(255,255,255,0.05); }
        .highlight-term { color: #00e5ff; background: rgba(0, 229, 255, 0.15); border-radius: 2px; }
    `;
    document.head.appendChild(style);

    // Ø¨) Ø­Ù‚Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ (HTML)
    const overlayHTML = `
    <div id="fullSearchOverlay" class="search-overlay-full">
        <div class="search-header">
            <i class="fa-solid fa-arrow-right" style="color:#94a3b8; font-size:20px; cursor:pointer; padding:5px;" onclick="document.getElementById('fullSearchOverlay').style.display='none'"></i>
            <div class="search-input-box">
                <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;"></i>
                <input type="text" id="fullSearchInput" class="search-input-field" placeholder="Ø§Ø¨Ø­Ø«..." oninput="performFullSearch(this.value)">
            </div>
        </div>
        <div class="search-results-list" id="searchResultsList"></div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', overlayHTML);
}

// 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ (The Core Engine)
// Ù…ØªØºÙŠØ± Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù…Ù†Ø³Ø­Ø¨Ø´ Ù†Øª ÙƒØªÙŠØ± ÙˆØ§Ù†Øª Ø¨ØªÙƒØªØ¨ Ø­Ø±Ù Ø­Ø±Ù
let searchDebounceTimer; 

async function performFullSearch(query) {
    const list = document.getElementById('searchResultsList');
    
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†Øµ Ù…ÙƒØªÙˆØ¨ØŒ ÙØ¶ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if (!query || query.trim() === '') {
        list.innerHTML = ''; 
        return;
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù†Ø¨Ø¯Ø£ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
    clearTimeout(searchDebounceTimer);

    // Ø§Ø³ØªÙ†Ù‰ Ù†Øµ Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ®Ù„Øµ ÙƒØªØ§Ø¨Ø© Ø¹Ø´Ø§Ù† ÙŠØ¨Ø¯Ø£ ÙŠØ¨Ø­Ø« (ØªÙˆÙÙŠØ± Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±)
    searchDebounceTimer = setTimeout(async () => {
        
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#00e5ff;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ... <i class="fa-solid fa-spinner fa-spin"></i></div>';

        try {
            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ Ø§Ù„Ø´Ø§Øª ÙÙŠÙ‡ Ø¢Ù„Ø§Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙŠÙØ¶Ù„ Ø¹Ù…Ù„ limit(100) Ù…Ø«Ù„Ø§Ù‹
            const snapshot = await db.collection("chats").doc(chatId).collection("messages")
                .orderBy("createdAt", "desc") // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
                .get();

            let resultsHTML = '';
            let count = 0;
            const lowerQuery = query.toLowerCase();

            // 2. Ø§Ù„ÙÙ„ØªØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ø£Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù…Ø¹Ù†Ø¯ÙˆØ´ Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø²Ø¦ÙŠ)
snapshot.forEach(doc => {
    const msg = doc.data();

    // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø¹Ø±ÙÙ†Ø§ isMe ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø®Ø§Ù„Øµ
    const isMe = msg.uid === currentUserId; 

    // Ø§Ù„Ø¢Ù† Ø§Ù„Ø´Ø±Ø· Ø³ÙŠØ¹Ù…Ù„ ÙˆÙ„Ù† ÙŠÙˆÙ‚Ù Ø§Ù„ÙƒÙˆØ¯
    if (!isMe && !msg.seen && document.visibilityState === 'visible') {
        db.collection("chats").doc(chatId).collection("messages").doc(doc.id).update({
            seen: true
        }).catch(()=>{});
    }
                // Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙˆØ±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…
                if (msg.type === 'deleted' || msg.type === 'system') return;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© ÙˆÙÙŠÙ‡Ø§ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                if (msg.text && msg.text.toLowerCase().includes(lowerQuery)) {
                    count++;
                    
                    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
                    const isMe = msg.uid === currentUserId;
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    const u = userCache[msg.uid] || { name: (isMe ? "Ø£Ù†Øª" : "Ù…Ø³ØªØ®Ø¯Ù…"), profilePic: null, char: "U", color: "#555" };
                    
                    const displayName = isMe ? "Ø£Ù†Øª" : u.name;
                    
                    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù„ÙŠ Ø¨Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§
                    const highlightedText = msg.text.replace(new RegExp(`(${query})`, 'gi'), 
                        `<span class="highlight-term">$1</span>`
                    );

                    // Ø±Ø³Ù… Ø§Ù„Ù†ØªÙŠØ¬Ø©
                    resultsHTML += `
                    <div class="search-result-item" onclick="handleSearchResultClick('${doc.id}')">
                        <div style="width:45px; height:45px; border-radius:50%; background:${u.color || '#333'}; background-size:cover; background-position:center; display:grid; place-items:center; color:#fff; flex-shrink:0; ${u.profilePic ? 'background-image:url('+u.profilePic+')' : ''}">
                            ${u.profilePic ? '' : u.char}
                        </div>
                        <div style="flex:1; overflow:hidden;">
                            <div style="font-size:14px; font-weight:bold; color:#fff; margin-bottom:4px;">${displayName}</div>
                            <div style="font-size:13px; color:#94a3b8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${highlightedText}</div>
                        </div>
                        <div style="font-size:10px; color:#555;">${msg.createdAt ? formatTime(msg.createdAt) : ''}</div>
                    </div>`;
                }
            });

            // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (count === 0) {
                list.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}" ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>`;
            } else {
                list.innerHTML = resultsHTML;
            }

        } catch (error) {
            console.error("Search Error:", error);
            list.innerHTML = `<div style="text-align:center; padding:20px; color:#ff3b30;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«</div>`;
        }

    }, 600); // 600 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ØªØ£Ø®ÙŠØ±
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©
// ================================================================
// ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¯Ù…Ø¬ (Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ + Ø§Ù„Ù‚ÙØ² Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) ğŸ”¥
// ================================================================

let chatSearchTimer; // Ù…ØªØºÙŠØ± Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø«

// 1. ÙØªØ­/ØºÙ„Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª
function toggleChatSearch() {
    const overlay = document.getElementById('searchOverlay');
    const input = document.getElementById('searchInputField');
    
    if (overlay.style.display === 'flex') {
        overlay.style.display = 'none';
        input.value = ''; // ØªÙ†Ø¸ÙŠÙ
        document.getElementById('searchResults').innerHTML = '';
    } else {
        overlay.style.display = 'flex';
        input.focus();
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª)
async function doSearch(query) {
    const list = document.getElementById('searchResults');
    
    if (!query || query.trim() === '') {
        list.innerHTML = '';
        return;
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…
    clearTimeout(chatSearchTimer);

    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø­Ø« (ØªÙˆÙÙŠØ± Ù„Ù„Ø£Ø¯Ø§Ø¡)
    chatSearchTimer = setTimeout(async () => {
        list.innerHTML = '<div style="text-align:center; color:#00e5ff; padding:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... <i class="fa-solid fa-spinner fa-spin"></i></div>';

        try {
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·)
            // Ø¨Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡ (text)
            const snapshot = await db.collection("chats").doc(chatId).collection("messages")
                .where('text', '>=', query)
                .where('text', '<=', query + '\uf8ff')
                .limit(20) // Ù‡Ø§Øª 20 Ù†ØªÙŠØ¬Ø©
                .get();

            let html = '';
            
            if (snapshot.empty) {
                list.innerHTML = '<div style="text-align:center; color:#777; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                return;
            }

            snapshot.forEach(doc => {
                const msg = doc.data();
                if(msg.type === 'deleted') return;

                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
                const highlightedText = msg.text.replace(new RegExp(`(${query})`, 'gi'), 
                    `<span style="background:#00e5ff; color:#000; padding:0 2px; border-radius:2px;">$1</span>`
                );
                
                const dateStr = msg.createdAt ? new Date(msg.createdAt.toMillis()).toLocaleDateString('ar-EG') : '';

                // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·: Ù†Ø³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚ÙˆÙŠØ© Ø§Ù„Ù„ÙŠ Ù‡ØªØ¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                html += `
                <div class="search-result-item" onclick="handleSearchResultClick('${doc.id}')" 
                     style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;">
                    
                    <div style="font-size:13px; color:#fff; margin-bottom:4px;">
                        ${highlightedText}
                    </div>
                    <div style="font-size:10px; color:#aaa; display:flex; justify-content:space-between;">
                        <span>${msg.uid === currentUserId ? 'Ø£Ù†Øª' : 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±'}</span>
                        <span>${dateStr}</span>
                    </div>
                </div>`;
            });

            list.innerHTML = html;

        } catch (e) {
            console.error(e);
            list.innerHTML = '<div style="text-align:center; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£</div>';
        }
    }, 600);
}

// 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø§Ù„Ù‚ÙˆÙŠØ© (Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«)
// Ø¯ÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù„ÙŠ Ø£Ù†Øª Ø¨Ø¹ØªÙ‡Ø§ + Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØºÙŠØ±Ø© Ø¹Ø´Ø§Ù† ØªÙ‚ÙÙ„ Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Øª
async function handleSearchResultClick(msgId) {
    
    // ğŸ‘‡ (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­ÙŠØ¯Ø©) Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†ÙˆØ§ÙØ° Ø¨Ø­Ø« Ù…ÙØªÙˆØ­Ø© ğŸ‘‡
    const fullSearch = document.getElementById('fullSearchOverlay');
    const chatSearch = document.getElementById('searchOverlay');
    
    if(fullSearch) fullSearch.style.display = 'none'; // Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† Ø¨Ø±Ù‡
    if(chatSearch) chatSearch.style.display = 'none'; // Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† Ø¬ÙˆÙ‡
    // ğŸ‘† (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ©) ğŸ‘†

    
    // --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨ØªØ§Ø¹Ùƒ ---
    
    // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‚Ø¯Ø§Ù…Ù†Ø§ (Ø­Ø¯ÙŠØ«Ø©)ØŒ Ù†Ø±ÙˆØ­ Ù„Ù‡Ø§ Ø¹Ù„Ø·ÙˆÙ„
    const el = document.getElementById('msg_' + msgId);
    if(el && !isArchiveMode) {
        el.scrollIntoView({behavior: "smooth", block: "center"});
        highlightBubble(el);
        return;
    }

    // Ù„Ùˆ Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù†ÙØ¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    showToast("â³ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...");
    isArchiveMode = true; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ

    try {
        const container = document.getElementById("chatContainer");
        
        // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
        const targetDoc = await db.collection("chats").doc(chatId).collection("messages").doc(msgId).get();
        if (!targetDoc.exists) { showToast("âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©"); return; }
        
        const targetDate = targetDoc.data().createdAt;

        // 2. Ù†Ø¬ÙŠØ¨ 15 Ø±Ø³Ø§Ù„Ø© (Ù‚Ø¨Ù„) Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ (Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        const olderSnap = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "desc")
            .startAfter(targetDate)
            .limit(15)
            .get();

        // 3. Ù†Ø¬ÙŠØ¨ 15 Ø±Ø³Ø§Ù„Ø© (Ø¨Ø¹Ø¯) Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ÙˆØ¯Ù‡ Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§ÙŠØ²Ù‡)
        const newerSnap = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "asc")
            .startAfter(targetDate)
            .limit(15)
            .get();

        // 4. Ù†Ø¯Ù…Ø¬Ù‡Ù… ÙƒÙ„Ù‡Ù… ÙÙŠ Ù…ØµÙÙˆÙØ© ÙˆØ§Ø­Ø¯Ø© Ù…Ø±ØªØ¨Ø©
        let allDocs = [];
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù…Ø¹ Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ØµØ­)
        olderSnap.docs.forEach(d => allDocs.push(d));
        allDocs.reverse(); 
        
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
        allDocs.push(targetDoc);
        
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡)
        newerSnap.docs.forEach(d => allDocs.push(d));

        // 5. Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙŠØ¹Ø±Ù ÙŠÙƒÙ…Ù„)
        oldestDoc = allDocs[0]; // Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ÙÙˆÙ‚
        newestArchivedDoc = allDocs[allDocs.length - 1]; // Ø£Ø­Ø¯Ø« Ø±Ø³Ø§Ù„Ø© ØªØ­Øª

        // 6. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ (Ù…Ø¹ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ)
        container.innerHTML = `
            <div id="archiveAlert" style="position:sticky; top:10px; z-index:50; text-align:center; opacity:0.8;">
                <button onclick="exitArchiveMode()" style="background:#00e5ff; color:#000; border:none; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:12px; cursor:pointer;">
                   Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¨Ø§Ø´Ø± <i class="fa-solid fa-bolt"></i>
                </button>
            </div>
        `;

        // ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const uids = new Set();
        allDocs.forEach(d => uids.add(d.data().uid));
        await Promise.all(Array.from(uids).map(uid => getUser(uid)));

        let html = "";
        allDocs.forEach(doc => {
            const msg = doc.data();
            const isMe = msg.uid === currentUserId;
            const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };
            html += buildMessageHTML(msg, doc.id, u); // âš ï¸ ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© buildMessageHTML Ø¹Ù†Ø¯Ùƒ Ø¨ØªØ§Ø®Ø¯ (msg, id, u)
        });

        container.insertAdjacentHTML('beforeend', html);

        // 7. Ø§Ù„Ù‚ÙØ² Ù„Ù„Ø±Ø³Ø§Ù„Ø©
        setTimeout(() => {
            const targetEl = document.getElementById('msg_' + msgId);
            if (targetEl) {
                targetEl.scrollIntoView({behavior: "auto", block: "center"});
                highlightBubble(targetEl);
            }
        }, 100);

    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}

async function loadMoreNewerMessages() {
    if (isLoadingNewer || !newestArchivedDoc || !isArchiveMode) return;
    
    const container = document.getElementById("chatContainer");
    
    // Ù„Ùˆ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙˆØ§Ù„Ù‚Ø§Ø¹ ØµØºÙŠØ±Ø© (ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø²Ù„ Ù„ØªØ­Øª)
    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
        isLoadingNewer = true;

        try {
            // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ "Ø¨Ø¹Ø¯" Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ø¹Ø±ÙˆØ¶Ø© ØªØ­Øª
            const snap = await db.collection("chats").doc(chatId).collection("messages")
                .orderBy("createdAt", "asc")
                .startAfter(newestArchivedDoc)
                .limit(20)
                .get();

            if (!snap.empty) {
                newestArchivedDoc = snap.docs[snap.docs.length - 1]; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±

                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const uids = new Set();
                snap.docs.forEach(d => uids.add(d.data().uid));
                await Promise.all(Array.from(uids).map(uid => getUser(uid)));

                let html = "";
                snap.forEach(doc => {
                    const msg = doc.data();
const isMe = msg.uid === currentUserId;
// 2. ÙØ­Øµ Ù‡Ù„ Ø¯ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŸ
const isTheLastSeenOne = (doc.id === lastSeenMsgId);

// ğŸ”¥ğŸ”¥ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø­Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ğŸ”¥ğŸ”¥
// Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù„ÙŠ (ÙˆØ§Ø±Ø¯Ø©) + ÙˆÙ„Ù… ØªØªÙ… Ø±Ø¤ÙŠØªÙ‡Ø§ + ÙˆØ§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
if (!isMe && !msg.seen && document.visibilityState === 'visible') {
    // Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¨Ø­ "Ù…Ù‚Ø±ÙˆØ¡Ø©"
    db.collection("chats").doc(chatId).collection("messages").doc(doc.id).update({
        seen: true
    }).catch(err => console.log("Error marking seen:", err));
    
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙŠÙƒÙˆÙ† 0
    if(chatId) {
        db.collection("chats").doc(chatId).update({ unreadCount: 0 });
    }
}

                    html += buildMessageHTML(msg, doc.id, u, isMe);
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ ØªØ­Øª
                container.insertAdjacentHTML('beforeend', html);
                
            } else {
                // Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ø³Ø§ÙŠÙ„ ØªØ§Ù†ÙŠØ©ØŒ ÙŠØ¨Ù‚Ù‰ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø­Ø§Ø¶Ø±
                showToast("âœ… Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø£Ø­Ø¯Ø« Ù†Ù‚Ø·Ø©");
                exitArchiveMode(); // Ù†Ø®Ø±Ø¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
            }

        } catch (e) { console.log(e); }
        
        isLoadingNewer = false;
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ
function exitArchiveMode() {
    isArchiveMode = false;
    location.reload(); // Ø±ÙŠÙØ±Ø´ Ø³Ø±ÙŠØ¹ ÙŠØ±Ø¬Ø¹Ùƒ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
}

// Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© buildMessageHTML Ø¨Ù‡Ø°Ù‡:
function buildMessageHTML(msg, id, u, isMe) {
    let content = "";
  let bubbleClass = "msg-bubble target-bubble";

// Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆØŒ Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
if (msg.type === 'image' || msg.type === 'video') {
    bubbleClass += " media-bubble"; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ


} else if (msg.type === 'deleted') {
    bubbleClass += " deleted";
} else if (msg.type === 'sticker') {
    // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨ØªØ§Ø¹Ùƒ Ù„Ù„Ù…Ù„ØµÙ‚Ø§Øª
    bubbleClass += " sticker-bubble transparent-bubble"; 
} else if (msg.type === 'gift') {
    bubbleClass += " gift-bubble";
}
// ==========================================================   // ... (Ù†ÙØ³ ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚) ...
    if (msg.type === 'deleted') { content = `<span style="font-style: italic; color: #94a3b8; font-size: 13px;">ğŸš« ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>`; bubbleClass += " deleted"; }
    else if (msg.type === 'text') { content = linkify(escapeHtml(msg.text)); }
    else if (msg.type === 'image') { content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`; }
    else if (msg.type === 'video') { content = `<div class="media-container" onclick="toggleVideo(this)"><video src="${msg.text}" class="msg-video" playsinline loop></video></div>`; }
    else if (msg.type === 'audio') { content = generateAudioPlayer(msg.text, id); }
    else if (msg.type === 'file') { content = `<div class="file-card" onclick="window.open('${msg.text}', '_blank')"><div class="file-icon"><i class="fa-solid fa-file-lines"></i></div><div class="file-info"><span class="file-name">Ù…Ù„Ù Ù…Ø±ÙÙ‚</span><span class="file-size">ØªØ­Ù…ÙŠÙ„</span></div></div>`; }
        // ... Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© buildMessageHTML ...

    // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© (Ø´ÙƒÙ„ ÙØ®Ù…)
    else if (msg.type === 'gift') {
        content = `
        <div class="msg-gift-container" style="text-align:center; padding:10px; min-width:120px;">
            <div style="font-size:50px; animation:bounce 2s infinite;">${msg.giftIcon}</div>
            <div style="color:#FFD700; font-weight:bold; font-size:14px; margin-top:5px;">${msg.giftName}</div>
            <div style="color:#aaa; font-size:10px;">${msg.giftPrice} <i class="fa-solid fa-coins"></i></div>
        </div>`;
        bubbleClass += " gift-bubble"; // Ø³ØªØ§ÙŠÙ„ Ø°Ù‡Ø¨ÙŠ (Ø§Ù„Ù„ÙŠ Ø¶ÙÙ†Ø§Ù‡ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡)
    }
    // ================= Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© buildMessageHTML =================

    // Ø¹Ø±Ø¶ ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Map Card)
        // ================= ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© =================
    else if (msg.type === 'location') {
        
        // 1. Ø±Ø§Ø¨Ø· Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙŠØ¬ÙŠØ¨ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ø±Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Yandex (Ù…Ø¬Ø§Ù†ÙŠ)
        // Ø¨Ù†Ø¨Ø¹ØªÙ„Ù‡ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (lng, lat) ÙˆØ¨ÙŠØ±Ø¬Ø¹ ØµÙˆØ±Ø©
        const mapPlaceholder = `https://static-maps.yandex.ru/1.x/?lang=en_US&ll=${msg.lng},${msg.lat}&z=16&l=map&size=600,300`;

        // 2. Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ù…Ø§Ø¨Ø³ Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ÙŠØ¶ØºØ· ÙŠÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø±Ø§Ø¨Ø·)
        const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${msg.lat},${msg.lng}`;

        content = `
        <div class="location-msg-card" onclick="window.open('${googleMapsLink}', '_blank')">
            
            <img src="${mapPlaceholder}" class="location-bg-image" alt="Location" 
                 onerror="this.src='https://i.ibb.co/vz0wJqR/map-placeholder.png'"> <div class="map-pin-container">
                <i class="fa-solid fa-location-dot map-pin-icon"></i>
                <div class="map-pin-shadow"></div>
            </div>

            <div class="location-footer">
                <div class="loc-icon-box">
                    <i class="fa-solid fa-map-location-dot"></i>
                </div>
                <div class="loc-text-info">
                    <span class="loc-title">Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ ğŸ“</span>
                    <span class="loc-sub">Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span>
                </div>
            </div>
        </div>`;
        
        // Ø¬Ø¹Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø´ÙØ§ÙØ© Ù„Ø£Ù† Ø§Ù„ÙƒØ§Ø±Øª Ù„Ù‡ ØªØµÙ…ÙŠÙ…Ù‡ Ø§Ù„Ø®Ø§Øµ
        bubbleClass += " transparent-bubble";
    }


// =========================================================================

    // 2. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ (ÙƒØ¨ÙŠØ± ÙˆØ¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ©)
    else if (msg.type === 'sticker') {
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ØµÙ‚ (Sticker) - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    content = `<span class="sticker-content">${msg.text}</span>`;
    bubbleClass = "msg-bubble sticker-bubble transparent-bubble"; 
} 


    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ...

    // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
    let replyHtml = "";
    if (msg.replyTo && msg.type !== 'deleted') {
         replyHtml = `<div class="replied-msg-context" style="padding:5px; background:rgba(0,0,0,0.2); margin-bottom:5px; border-radius:5px; font-size:11px;"><div style="color:var(--accent-color);">${msg.replyTo.sender}</div><div>${msg.replyTo.text}</div></div>`;
    }

    // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
    let reactionHtml = "";
    if (msg.reaction) {
        reactionHtml = `<div class="msg-reaction" onclick="event.stopPropagation(); toggleReaction('${msg.reaction}')">${msg.reaction}</div>`;
    }

    const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
    const miniAvatar = `<div class="msg-user-avatar" onclick="openUserPopup('${msg.uid}')" style="background-image: url('${u.profilePic}'); background-color:${u.color}; cursor: pointer;">${u.profilePic?'':u.char}</div>`;

    // Ø¥Ø¶Ø§ÙØ© Ø³ØªØ§ÙŠÙ„ margin-bottom Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ùˆ ÙÙŠÙ‡Ø§ ØªÙØ§Ø¹Ù„
    return `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'}" id="msg_${id}" style="${msg.reaction ? 'margin-bottom: 20px;' : ''}">
        ${!isMe ? miniAvatar : ''}
        <div class="${bubbleClass}" style="position: relative;">
            ${!isMe ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
            
            ${replyHtml}
            <div>${content}</div>
            
            ${reactionHtml}

            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                <span class="msg-time">${timeText}</span>
            </div>
        </div>
    </div>`;
}


// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² (Ø¹Ø´Ø§Ù† ØªÙ†ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù…Ø§ ØªØ±ÙˆØ­Ù„Ù‡Ø§)
function highlightBubble(row) {
    const bubble = row.querySelector('.msg-bubble');
    if(bubble) {
        bubble.style.transition = "0.5s";
        bubble.style.boxShadow = "0 0 40px #00e5ff"; // ØªÙˆÙ‡Ø¬ Ù‚ÙˆÙŠ
        bubble.style.border = "1px solid #00e5ff";
        setTimeout(() => { 
            bubble.style.boxShadow = "none"; 
            bubble.style.borderColor = "transparent";
        }, 2000);
    }
}


// 4. Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø±Ø³Ø§Ù„Ø© (Ø§Ù„Ù‚ÙØ² ÙˆØ§Ù„ÙˆÙ…ÙŠØ¶)
function jumpToMessage(id) {
    document.getElementById('fullSearchOverlay').style.display = 'none'; // Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«
    
    const el = document.getElementById('msg_' + id);
    if(el) {
        el.scrollIntoView({behavior: "smooth", block: "center"});
        const bubble = el.querySelector('.msg-bubble');
        if(bubble) {
            // ÙˆÙ…ÙŠØ¶ Ø£Ø²Ø±Ù‚
            bubble.style.transition = "0.3s";
            bubble.style.boxShadow = "0 0 30px #00e5ff";
            bubble.style.borderColor = "#00e5ff";
            setTimeout(() => { 
                bubble.style.boxShadow = "none"; 
                bubble.style.borderColor = "transparent";
            }, 1500);
        }
    }
}


// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ
function searchMessages(query) {
    if (!query) { clearSearch(); return; }
    const bubbles = document.querySelectorAll('.msg-bubble');
    let found = false;
    
    bubbles.forEach(bubble => {
        const text = bubble.innerText.toLowerCase();
        const row = bubble.closest('.msg-row');
        
        if (text.includes(query.toLowerCase())) {
            row.style.display = 'flex';
            bubble.style.boxShadow = '0 0 15px rgba(0, 229, 255, 0.5)'; // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ØªÙˆÙ‡Ø¬
            bubble.style.border = '1px solid #00e5ff';
            found = true;
        } else {
            row.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚
            bubble.style.boxShadow = 'none';
            bubble.style.border = 'none';
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø«
function closeSearchBar() {
    const bar = document.getElementById('searchBar');
    if(bar) bar.remove();
    clearSearch(); // Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
}

function clearSearch() {
    document.querySelectorAll('.msg-row').forEach(row => {
        row.style.display = 'flex';
        const bubble = row.querySelector('.msg-bubble');
        if(bubble) {
            bubble.style.boxShadow = 'none';
            bubble.style.border = 'none';
        }
    });
}
// 2. Ø²Ø± ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„)
let isMuted = false; // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©

function toggleMuteNotifications(element) {
    isMuted = !isMuted; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    
    // 1. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
    const icon = element.querySelector('.toggle-icon');
    const text = element.querySelector('.p-item-text span');
    
    // 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø¬Ø±Ø³ Ø§Ù„Ù„ÙŠ Ø¬Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…) ğŸ”¥ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ ğŸ”¥
    const headerIcon = document.getElementById('headerMuteIcon');
    
    // ØªØ£Ø«ÙŠØ± Ù‡Ø²Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(30);

    if (isMuted) {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… (ON) ---
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        icon.classList.remove('fa-toggle-off');
        icon.classList.add('fa-toggle-on');
        icon.style.color = "#8b5cf6"; // Ø¨Ù†ÙØ³Ø¬ÙŠ
        text.innerText = "ØªÙ… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø±Ø³ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        if(headerIcon) headerIcon.style.display = "inline-block"; 

        showToast("ğŸ”• ØªÙ… ÙƒØªÙ… ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
        
    } else {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (OFF) ---
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        icon.classList.remove('fa-toggle-on');
        icon.classList.add('fa-toggle-off');
        icon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ
        text.innerText = "ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø±Ø³ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
        if(headerIcon) headerIcon.style.display = "none"; 

        showToast("ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    }
}


// 3. Ø²Ø± Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Block)
// Ø¯ÙˆØ§Ù„ ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeBlockModal() {
    document.getElementById('customBlockModal').style.display = 'none';
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¯ÙŠ)
// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø¸Ø±
async function toggleBlockUser() {
    
    // ğŸ”¥ğŸ”¥ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ”¥ğŸ”¥
    // Ø¯Ù‡ Ø¨ÙŠÙ†Ù‚Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ø¢Ø®Ø± Ø§Ù„ØµÙØ­Ø© Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„
    const modalElement = document.getElementById('customBlockModal');
    if (modalElement && modalElement.parentNode !== document.body) {
        document.body.appendChild(modalElement);
    }
    // ------------------------------------

    if (!cachedOtherUserId) return;

    if (isUserBlocked) {
        // ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±ØŸ")) {
             performUnblock(cachedOtherUserId);
        }
    } else {
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± (ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©)
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©
        const cooldownDoc = await db.collection('users').doc(currentUserId).collection('block_cooldowns').doc(cachedOtherUserId).get();
        if (cooldownDoc.exists) {
            const lastUnblock = cooldownDoc.data().unblockedAt.toDate().getTime();
            const diffHours = (Date.now() - lastUnblock) / (1000 * 60 * 60);
            if (diffHours < 48) {
                showToast(`âš ï¸ Ù…ØªØ¨Ù‚ÙŠ ${Math.ceil(48 - diffHours)} Ø³Ø§Ø¹Ø©`);
                return;
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ù‚Ù„Ù†Ø§Ù‡Ø§
        document.getElementById('customBlockModal').style.display = 'flex';
    }
}


// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨ØªØªÙ†Ø¯Ù‰ Ù„Ù…Ø§ ØªØ¯ÙˆØ³ "Ù…ÙˆØ§ÙÙ‚" ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©)
async function confirmBlockAction() {
    closeBlockModal(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
    
    try {
        await db.collection('users').doc(currentUserId).collection('blocked').doc(cachedOtherUserId).set({
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast("ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        closeProfile(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    } catch (e) { 
        console.error(e); 
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£"); 
    }
}

// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ù‡Ù†Ø­ØªØ§Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ…Ø§Ù†)
// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¹Ø¯Ø§Ø¯)
async function performUnblock(targetId) {
    try {
        // 1. Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
        await db.collection('users').doc(currentUserId).collection('blocked').doc(targetId).delete();
        
        // 2. ğŸ”¥ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ´ØºÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©) ğŸ”¥
        await db.collection('users').doc(currentUserId).collection('block_cooldowns').doc(targetId).set({
            unblockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast("âœ… ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ø¨Ø¯Ø£ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©)");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©
        const blockedPage = document.getElementById('blockedUsersPage'); // Ø£Ùˆ blockedUsersFile Ø­Ø³Ø¨ Ù…Ø§ Ø³Ù…ÙŠØªÙ‡
        if(blockedPage && blockedPage.style.display === 'flex') {
            // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ù‡Ù†Ø§
             if(typeof loadBlockedData === 'function') loadBlockedData();
             else if(typeof openBlockedUsersPage === 'function') openBlockedUsersPage();
        } else {
            closeProfile();
        }
    } catch (e) { 
        console.error(e); 
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
    }
}


// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø²Ø± Ø§Ù„Ø­Ø¸Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function updateProfileBlockButton(isBlocked) {
    const blockText = document.querySelector('.p-item-text span[style*="ef4444"]'); // Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø­Ù…Ø±
    const blockIcon = document.querySelector('.p-item-icon[style*="ef4444"]');
    
    if (blockText && blockIcon) {
        if (isBlocked) {
            blockText.innerText = "ÙÙƒ Ø§Ù„Ø­Ø¸Ø±";
            blockText.style.color = "#fff"; // Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶
            blockIcon.parentElement.style.borderColor = "rgba(255,255,255,0.2)";
        } else {
            blockText.innerText = "Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
            blockText.style.color = "#ef4444"; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø±
            blockIcon.parentElement.style.borderColor = "rgba(239, 68, 68, 0.2)";
        }
    }
}

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ (ØªÙˆØ¶Ø¹ Ø¹Ù„Ù‰ Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
// ================= ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¹Ø±Ø¶ =================

// ================= 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ ÙˆØ¬Ù„Ø¨ Ø§Ù„ØµÙˆØ± =================
// ================= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =================

// ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ù…Ù„Ø© =================
// ================= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =================

// ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø¨ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ =================
// Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ± Ù„ØºØ±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù€ Lightbox

async function openMediaGallery() {
    // 1. ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    if(document.getElementById('profilePage')) document.getElementById('profilePage').style.display = 'none';
    document.getElementById('mediaGalleryOverlay').style.display = 'flex';
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ¯Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const panels = ['panel-media', 'panel-files', 'panel-audio', 'panel-links'];
    panels.forEach(id => {
        document.getElementById(id).innerHTML = `
            <div class="empty-state">
                <i class="fa-solid fa-circle-notch fa-spin empty-icon" style="font-size:30px; color:#00e5ff;"></i>
                <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ...</span>
            </div>`;
    });

    try {
        // 3. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙŠÙØ¶Ù„ Ø¹Ù…Ù„ limit Ù„Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ Ø¶Ø®Ù…)
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "desc") // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
            .get();

        // 4. ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…
        panels.forEach(id => document.getElementById(id).innerHTML = '');
        galleryImagesList = []; 
        
        let hasMedia = false, hasFiles = false, hasAudio = false, hasLinks = false;

        snapshot.forEach(doc => {
            const msg = doc.data();
            if (msg.type === 'deleted') return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙ
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const dateStr = msg.createdAt ? msg.createdAt.toDate().toLocaleDateString('ar-EG') : 'Ù…Ø¤Ø®Ø±Ø§Ù‹';

            // ================== (Ø£) Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ==================
            if (msg.type === 'image') {
                hasMedia = true;
                galleryImagesList.unshift(msg.text); // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø¹ÙƒÙˆØ³Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨)
                // Ù„Ø§Ø­Ø¸ Ù‡Ù†Ø§ Ø¨Ù†Ø­Ø· index ØµØ­ÙŠØ­ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø·ÙˆÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠ
                const imgIndex = 0; // Ø³ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚

                document.getElementById('panel-media').insertAdjacentHTML('beforeend', `
                    <div class="mg-item" onclick="openGalleryViewerBySrc('${msg.text}')">
                        <img src="${msg.text}" loading="lazy">
                    </div>
                `);
            }
            else if (msg.type === 'video') {
                hasMedia = true;
                document.getElementById('panel-media').insertAdjacentHTML('beforeend', `
                    <div class="mg-item" onclick="window.open('${msg.text}', '_blank')">
                        <video src="${msg.text}#t=1.0" preload="metadata"></video>
                        <div class="vid-indicator"><i class="fa-solid fa-video"></i></div>
                        <div style="position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.3);">
                            <i class="fa-solid fa-play" style="color:#fff; font-size:20px;"></i>
                        </div>
                    </div>
                `);
            }

            // ================== (Ø¨) Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ==================
            else if (msg.type === 'file') {
                hasFiles = true;
                let fileName = "Ù…Ù„Ù Ù…Ø±ÙÙ‚";
                try { fileName = decodeURIComponent(msg.text.split('/').pop().split('?')[0]); } catch(e){}
                
                document.getElementById('panel-files').insertAdjacentHTML('beforeend', `
                    <div class="mg-list-card" onclick="window.open('${msg.text}', '_blank')">
                        <div class="list-icon-box icon-file"><i class="fa-solid fa-file-lines"></i></div>
                        <div class="list-info">
                            <div class="list-title">${fileName}</div>
                            <div class="list-sub">${dateStr} â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„</div>
                        </div>
                        <i class="fa-solid fa-download" style="color:#64748b;"></i>
                    </div>
                `);
            }

            // ================== (Ø¬) Ø§Ù„ØµÙˆØªÙŠØ§Øª ==================
            else if (msg.type === 'audio') {
                hasAudio = true;
                document.getElementById('panel-audio').insertAdjacentHTML('beforeend', `
                    <div class="mg-list-card">
                        <div class="list-icon-box icon-audio" onclick="new Audio('${msg.text}').play();"><i class="fa-solid fa-play"></i></div>
                        <div class="list-info">
                            <div class="list-title">Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
                            <div class="list-sub">${dateStr}</div>
                        </div>
                        <audio src="${msg.text}" controls style="height:30px; max-width:150px; opacity:0.5;"></audio>
                    </div>
                `);
            }

            // ================== (Ø¯) Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Regex) ==================
            else if (msg.type === 'text' && msg.text) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ù†Øµ
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const matches = msg.text.match(urlRegex);
                if (matches) {
                    hasLinks = true;
                    matches.forEach(url => {
                        let domain = 'Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ';
                        try { domain = new URL(url).hostname; } catch(e){}

                        document.getElementById('panel-links').insertAdjacentHTML('beforeend', `
                            <div class="mg-list-card" onclick="window.open('${url}', '_blank')">
                                <div class="list-icon-box icon-link"><i class="fa-solid fa-link"></i></div>
                                <div class="list-info">
                                    <div class="list-title" style="direction:ltr; text-align:right;">${domain}</div>
                                    <div class="list-sub" style="direction:ltr; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${url}</div>
                                </div>
                            </div>
                        `);
                    });
                }
            }
        });

        // 5. Ø¶Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± (galleryImagesList) Ù„Ù„Ø¹Ø§Ø±Ø¶
        // Ù‚Ù…Ù†Ø§ Ø¨Ù…Ù„Ø¦Ù‡Ø§ Ø¨Ø§Ù„Ø¹ÙƒØ³ (unshift)ØŒ Ù„Ø°Ø§ Ù†Ø¹ÙƒØ³Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ
        galleryImagesList.reverse();

        // 6. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© (Empty State)
        if (!hasMedia) showEmptyState('panel-media', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ', 'fa-photo-film');
        if (!hasFiles) showEmptyState('panel-files', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª', 'fa-folder-open');
        if (!hasAudio) showEmptyState('panel-audio', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØªÙŠØ§Øª', 'fa-microphone-lines');
        if (!hasLinks) showEmptyState('panel-links', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…Ø´ØªØ±ÙƒØ©', 'fa-link');

    } catch (e) { 
        console.error(e); 
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±Ø¶"); 
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ±Ø§Øº
function showEmptyState(panelId, text, iconClass) {
    document.getElementById(panelId).innerHTML = `
        <div class="empty-state">
            <i class="fa-solid ${iconClass} empty-icon"></i>
            <span>${text}</span>
        </div>`;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (CSS Class Logic)
function switchTab(type) {
    // Ø¥Ø²Ø§Ù„Ø© Active Ù…Ù† Ø§Ù„ÙƒÙ„
    document.querySelectorAll('.mg-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.mg-panel').forEach(p => p.classList.remove('active'));

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡
    event.currentTarget.classList.add('active');

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    const panel = document.getElementById(`panel-${type}`);
    if(panel) {
        panel.classList.add('active');
        // ØªØ­ÙˆÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶ (Grid Ù„Ù„ÙˆØ³Ø§Ø¦Ø·ØŒ List Ù„Ù„Ø¨Ø§Ù‚ÙŠ)
        if(type === 'media') {
            panel.classList.remove('list-view');
            panel.classList.add('grid-view');
        } else {
            panel.classList.remove('grid-view');
            panel.classList.add('list-view');
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· (Ù„Ø£Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ù‚Ø¯ ÙŠØ®ØªÙ„Ù)
function openGalleryViewerBySrc(src) {
    const index = galleryImagesList.indexOf(src);
    if (index !== -1) {
        openGalleryViewer(index);
    }
}




// ================= 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§) =================
function openGalleryViewer(index) {
    currentImageIndex = index; // Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù„ÙŠ Ø¶ØºØ·Ù†Ø§ Ø¹Ù„ÙŠÙ‡Ø§
    updateLightboxContent();   // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ø±Ø¶
    document.getElementById('lightbox').style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø§Ø±Ø¶
}

// ================= 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¨ (Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚) =================
function changeGalleryImage(direction) {
    // direction: 1 Ù„Ù„ØªØ§Ù„ÙŠØŒ -1 Ù„Ù„Ø³Ø§Ø¨Ù‚
    let newIndex = currentImageIndex + direction;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ© (Ø¯ÙˆØ±Ø§Ù† Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ)
    if (newIndex >= galleryImagesList.length) {
        newIndex = 0; // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø¢Ø®Ø± Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø£ÙˆÙ„
    } else if (newIndex < 0) {
        newIndex = galleryImagesList.length - 1; // Ù„Ùˆ ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ±Ø¬Ø¹Ù†Ø§ ÙˆØ±Ø§ Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    }

    currentImageIndex = newIndex;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ø®ØªÙØ§Ø¡ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ù„ÙŠØ¨
    const imgElement = document.getElementById('lb-img');
    imgElement.style.opacity = '0.5';
    
    setTimeout(() => {
        updateLightboxContent();
        imgElement.style.opacity = '1';
    }, 150);
}

// ================= 4. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø§Ø±Ø¶ =================
function updateLightboxContent() {
    const imgElement = document.getElementById('lb-img');
    const counterElement = document.getElementById('lb-counter');
    
    // ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    imgElement.src = galleryImagesList[currentImageIndex];
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹: 5 / 20)
    if(counterElement) {
        counterElement.innerText = `${currentImageIndex + 1} / ${galleryImagesList.length}`;
    }
}

// ================= 5. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø±Ø¶ =================
function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§Øº
function showEmpty(id, text) {
    document.getElementById(id).innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;"><i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i><br>${text}</div>`;
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function switchTab(type) {
    // ØªØ¨Ø¯ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.mg-tab').forEach(t => t.classList.remove('active'));
    event.currentTarget.classList.add('active');

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    document.querySelectorAll('.mg-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(`panel-${type}`).classList.add('active');
}

// 3. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±Ø¶
function closeMediaGallery() {
    document.getElementById('mediaGalleryOverlay').style.display = 'none';
}

          // ==========================================
//      Ù†Ø¸Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© (JS)
// ==========================================

// Ù…ØªØºÙŠØ± Ù…Ø­Ù„ÙŠ Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø³Ø±Ø¹Ø©
let myPrivacySettings = {
    hideLastSeen: false,
    hideReadReceipts: false
};
async function openPrivacyPage() {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© (Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù„ÙŠ ÙØ§ØªØª)
    const page = document.getElementById('privacySettingsPage');
    if (page) {
        // Ù†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù€ body Ù„Ùˆ Ù„Ø³Ù‡ Ù…Ø´ Ù‡Ù†Ø§Ùƒ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„)
        if (page.parentNode !== document.body) document.body.appendChild(page);
        page.style.display = 'flex';
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    updatePrivacyTogglesUI();

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    if (currentUserId) {
        try {
            const doc = await db.collection('users').doc(currentUserId).get();
            if(doc.exists && doc.data().privacy) {
                myPrivacySettings = doc.data().privacy;
                updatePrivacyTogglesUI(); // ØªØ­Ø¯ÙŠØ« ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            }
        } catch(e) { console.log(e); }
    }
}


// 2. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function updatePrivacyTogglesUI() {
    setToggleState('hideLastSeen', myPrivacySettings.hideLastSeen);
    setToggleState('hideReadReceipts', myPrivacySettings.hideReadReceipts);
}

function setToggleState(id, isActive) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡
    const icon = document.getElementById(`toggle_${id}`);
    
    if (!icon) {
        console.error(`Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø§Ù„Ø§Ø³Ù… toggle_${id}`);
        return;
    }

    if(isActive) {
        icon.classList.remove('fa-toggle-off');
        icon.classList.add('fa-toggle-on');
        icon.style.color = "#00e5ff"; // Ù…ÙØ¹Ù„ (Ø³ÙŠØ§Ù†)
    } else {
        icon.classList.remove('fa-toggle-on');
        icon.classList.add('fa-toggle-off');
        icon.style.color = "#64748b"; // ØºÙŠØ± Ù…ÙØ¹Ù„ (Ø±Ù…Ø§Ø¯ÙŠ)
    }
}
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù„Ù…ÙŠ (Global) Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ HTML ÙŠØ´ÙˆÙÙ‡Ø§ 100%
window.togglePrivacyOption = function(optionKey) {
    console.log("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰:", optionKey); // Ù„Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø²Ø±Ø§Ø± Ø´ØºØ§Ù„

    // 1. ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±: Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø®Ù„ÙŠÙ‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…ÙŠØ¹Ø·Ù„Ø´
    if (typeof myPrivacySettings === 'undefined' || !myPrivacySettings) {
        myPrivacySettings = { hideLastSeen: false, hideReadReceipts: false };
    }

    // 2. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ùˆ true ØªØ¨Ù‚Ù‰ false ÙˆØ§Ù„Ø¹ÙƒØ³)
    myPrivacySettings[optionKey] = !myPrivacySettings[optionKey];

    // 3. ğŸ”¥ ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹ (Ø¹Ø´Ø§Ù† ØªØ­Ø³ Ø¨Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©) ğŸ”¥
    const icon = document.getElementById('toggle_' + optionKey);
    if (icon) {
        if (myPrivacySettings[optionKey]) {
            // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (ON)
            icon.classList.remove('fa-toggle-off');
            icon.classList.add('fa-toggle-on');
            icon.style.color = "#00e5ff"; // Ø§Ù„Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ø¶ÙŠØ¡
            icon.style.textShadow = "0 0 10px rgba(0, 229, 255, 0.5)"; // Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‡Ø¬
        } else {
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (OFF)
            icon.classList.remove('fa-toggle-on');
            icon.classList.add('fa-toggle-off');
            icon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø·ÙÙŠ
            icon.style.textShadow = "none";
        }
    } else {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù€ ID:", 'toggle_' + optionKey);
    }

    // 4. ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(30);

    // 5. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† Ù…Ø§ Ù†Ø¹Ø·Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
    if (currentUserId) {
        db.collection('users').doc(currentUserId).set({
            privacy: myPrivacySettings
        }, { merge: true }).then(() => {
            console.log("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
        }).catch((e) => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", e);
        });
    }
};
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù„Ù…ÙŠ (Global) Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ HTML ÙŠØ´ÙˆÙÙ‡Ø§ 100%
window.togglePrivacyOption = function(optionKey) {
    console.log("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±:", optionKey); // Ù„Ù„ØªØ£ÙƒØ¯ ÙÙŠ Ø§Ù„Ù€ Console

    // 1. ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±: Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ù†Ø´Ø¦Ù‡
    if (typeof myPrivacySettings === 'undefined' || !myPrivacySettings) {
        myPrivacySettings = { hideLastSeen: false, hideReadReceipts: false };
    }

    // 2. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ùˆ true ØªØ¨Ù‚Ù‰ false ÙˆØ§Ù„Ø¹ÙƒØ³)
    myPrivacySettings[optionKey] = !myPrivacySettings[optionKey];

    // 3. ğŸ”¥ ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹ (Ø¹Ø´Ø§Ù† ØªØ­Ø³ Ø¨Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©) ğŸ”¥
    const icon = document.getElementById('toggle_' + optionKey);
    
    if (icon) {
        if (myPrivacySettings[optionKey]) {
            // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (ON) - Ø§Ù„Ù…ÙØ±ÙˆØ¶ ÙŠÙ†ÙˆØ± Ø£Ø²Ø±Ù‚
            icon.classList.remove('fa-toggle-off');
            icon.classList.add('fa-toggle-on');
            icon.style.color = "#00e5ff"; // Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù†
            icon.style.textShadow = "0 0 10px rgba(0, 229, 255, 0.5)"; // ØªÙˆÙ‡Ø¬
        } else {
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (OFF) - Ø§Ù„Ù…ÙØ±ÙˆØ¶ ÙŠØ¨Ù‚Ù‰ Ø±Ù…Ø§Ø¯ÙŠ
            icon.classList.remove('fa-toggle-on');
            icon.classList.add('fa-toggle-off');
            icon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ
            icon.style.textShadow = "none";
        }
    } else {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ±: toggle_" + optionKey);
    }

    // 4. Ø§Ù‡ØªØ²Ø§Ø² Ø®ÙÙŠÙ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù„Ù…Ø³)
    if(navigator.vibrate) navigator.vibrate(30);

    // 5. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase)
    if (typeof currentUserId !== 'undefined' && currentUserId) {
        db.collection('users').doc(currentUserId).set({
            privacy: myPrivacySettings
        }, { merge: true }).then(() => {
            console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:", optionKey);
        }).catch((e) => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", e);
        });
    }
};
// ================= Ù†Ø¸Ø§Ù… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸ (Persistent Mute) =================

// 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ (Ø¯Ù‡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ®Ù„ÙŠÙ‡Ø§ ØªØ«Ø¨Øª)
// Ø¨Ù†Ø³ØªØ®Ø¯Ù… chatId Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ÙƒØ°Ø§ Ø´Ø§ØªØŒ ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ¨Ù‚Ù‰ Ù„Ù‡ Ù†Ø¸Ø§Ù…Ù‡

// 2. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¹Ø´Ø§Ù† ØªÙ†ÙˆØ± Ø§Ù„Ø²Ø±Ø§Ø± Ø§ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ù„Ùˆ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸)
function updateMuteUI() {
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
    const toggleIcon = document.getElementById('muteIcon'); // Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„
    const textLabel = document.getElementById('muteText');  // Ø§Ù„Ù†Øµ
    const itemIcon = document.querySelector('.mute-icon');  // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©

    // Ø¹Ù†ØµØ± Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø¬Ø±Ø³ Ø§Ù„ØµØºÙŠØ±)
    const headerIcon = document.getElementById('headerMuteIcon');

    if (isMuted) {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… (ON) ---
        
        // 1. ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„
        if(toggleIcon) {
            toggleIcon.classList.remove('fa-toggle-off');
            toggleIcon.classList.add('fa-toggle-on');
            toggleIcon.style.color = "#8b5cf6"; // Ø¨Ù†ÙØ³Ø¬ÙŠ
        }

        // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ
        if(textLabel) textLabel.innerText = "ØªÙ… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        if(textLabel) textLabel.style.color = "#8b5cf6"; // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†Øµ Ù„Ù„ØªØ£ÙƒÙŠØ¯

        // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø±Ø³ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙÙˆÙ‚ Ø¬Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…)
        if(headerIcon) headerIcon.style.display = "inline-block"; 

    } else {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (OFF) ---
        
        // 1. ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„
        if(toggleIcon) {
            toggleIcon.classList.remove('fa-toggle-on');
            toggleIcon.classList.add('fa-toggle-off');
            toggleIcon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ
        }

        // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ
        if(textLabel) textLabel.innerText = "ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        if(textLabel) textLabel.style.color = "#fff";

        // 3. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø±Ø³ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
        if(headerIcon) headerIcon.style.display = "none"; 
    }
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ· (Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©)
function toggleMuteNotifications() {
    isMuted = !isMuted; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    
    // ğŸ”¥ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø¯Ù‡ Ø£Ù‡Ù… Ø³Ø·Ø±) ğŸ”¥
    if(chatId) {
        localStorage.setItem('wareed_mute_' + chatId, isMuted);
    }
    
    // ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(30);

    // ØªÙˆØ³Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    if (isMuted) {
        showToast("ğŸ”• ØªÙ… ÙƒØªÙ… ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    } else {
        showToast("ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹
    updateMuteUI();
}

// 4. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener("DOMContentLoaded", () => {
    // Ø¨Ù†Ø³ØªÙ†Ù‰ Ù„Ø­Ø¸Ø© ØµØºÙŠØ±Ø© Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù† chatId ÙˆØµÙ„ ÙˆØ§Ù„Ù‡ÙŠØ¯Ø± Ø­Ù…Ù„
    setTimeout(() => {
        updateMuteUI();
    }, 100);
});

const messaging = firebase.messaging();

// Ø¯Ø§Ù„Ø© Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
// Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ø´ÙØ© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡)
async function requestPermission() {
    try {
        // 1. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            alert("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†! ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.");
            return;
        }

        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†
        alert("â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†... Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©");
        
        const token = await messaging.getToken({ 
    vapidKey: "BHEEGGgmiqTUiHeP1Qrkv_87xOalox0ioXw_l6qtJ_ebgOJJFXNst52U-Mvo7Mwv1h5bxqUEDXLCxvpr89HQ8yw" 
});
        if (token) {
            alert("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø§Ù„Ø¢Ù†.");
            saveTokenToFirestore(token);
        } else {
            alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆÙƒÙ†ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ù service worker.");
        }

    } catch (err) {
        // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ù Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
        console.error("Ø®Ø·Ø£ Ø§Ù„ØªÙˆÙƒÙ†:", err);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©)
function saveTokenToFirestore(token) {
    if (!currentUserId) {
        console.error("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ù„Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†");
        return;
    }

    // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ set Ø¨Ø¯Ù„ update Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙŠÙ†Ø´Ø¦Ù‡Ø§
    db.collection('users').doc(currentUserId).set({
        fcmToken: token
    }, { merge: true }) // merge: true Ø¹Ø´Ø§Ù† Ù…ÙŠØ­Ø°ÙØ´ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    .then(() => {
        console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        // alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…"); // Ø´ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·ØªÙŠÙ† Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø±Ø³Ø§Ù„Ø© ØªØ¸Ù‡Ø±Ù„Ùƒ
    })
    .catch((error) => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†: ", error);
        alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†: " + error.message);
    });
}

// Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠÙˆØ¶Ø¹ ÙÙŠ ØµÙØ­Ø© chat.html ÙˆÙ„ÙŠØ³ Ù‡Ù†Ø§
// Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

function checkHighlight() {
    const urlParams = new URLSearchParams(window.location.search);
    const highlightWord = urlParams.get('highlight');

    if (highlightWord) {
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ù…Ù„Ø©
        // Ù‡Ø°Ù‡ Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø³Ø·Ø©ØŒ ÙŠÙØ¶Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ DOM Ø¨Ø¹Ø¯ Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        setTimeout(() => {
            // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø¹Ù†ØµØ± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ
            // (Ø¨Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡Ø§ ÙƒÙ„Ø§Ø³ .msg-content Ø£Ùˆ Ù…Ø§ Ø´Ø§Ø¨Ù‡)
            const messages = document.querySelectorAll('.message-text'); // ØºÙŠØ± Ø§Ù„ÙƒÙ„Ø§Ø³ Ø­Ø³Ø¨ ÙƒÙˆØ¯Ùƒ
            
            for (let msg of messages) {
                if (msg.innerText.toLowerCase().includes(highlightWord.toLowerCase())) {
                    
                    // 1. ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
                    const regex = new RegExp(`(${highlightWord})`, 'gi');
                    msg.innerHTML = msg.innerHTML.replace(regex, '<span style="background:yellow; color:black; font-weight:bold;">$1</span>');
                    
                    // 2. Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„ÙŠÙ‡Ø§
                    msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // ÙˆÙ…ÙŠØ¶ Ø¨Ø³ÙŠØ· Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    msg.parentElement.style.animation = "flashHighlight 2s";
                    break; // Ù†Ù‚Ù Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø© (Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ)
                }
            }
        }, 1000); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    }
}
// ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØºÙ„Ù‚ Ø§Ù„ØµÙØ­Ø© ğŸ”¥ğŸ”¥ğŸ”¥
window.addEventListener("beforeunload", function() {
    if (chatId && currentUserId && isTypingStatus) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø­Ø°Ù Ù‚Ø¨Ù„ Ù…Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ‚ÙÙ„ Ø¨Ù„Ø­Ø¸Ø©
        db.collection("chats").doc(chatId).update({ 
            typing: firebase.firestore.FieldValue.arrayRemove(currentUserId) 
        });
    }
});

// Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ¥Ø­ÙŠØ§Ø¦Ù‡Ø§ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø­Ø°ÙˆÙØ©
// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø´Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
async function ensureChatActive() {
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¢ÙŠØ¯ÙŠ Ù„Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠØŒ Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨Ù‡ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    if (!cachedOtherUserId) {
        const urlUid = new URLSearchParams(location.search).get("uid");
        if (urlUid && urlUid !== 'null') cachedOtherUserId = urlUid;
    }

    if (!chatId || !currentUserId || !cachedOtherUserId) return;

    try {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        await db.collection("chats").doc(chatId).set({
            users: [currentUserId, cachedOtherUserId], // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø·Ø±Ø§Ù
            type: 'DIRECT',
            deletedBy: [],   // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø°Ù
            archivedBy: [],  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ©
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
    } catch (error) {
        console.log("Chat check error:", error);
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø©
function attachSwipeReaction(rowElement, msgData, msgId) {
    const bubble = rowElement.querySelector('.msg-bubble');
    if (!bubble) return;

    let startX = 0;
    let startY = 0;
    let isSwipingLeft = false;
    let touchStartTime = 0;

    // 1. Ø¹Ù†Ø¯ Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø©
    bubble.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        touchStartTime = Date.now();
        isSwipingLeft = false;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© ØªÙØ§Ø¹Ù„Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
        document.querySelectorAll('.swipe-reaction-bar').forEach(el => el.remove());
    }, { passive: true });

    // 2. Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¥ØµØ¨Ø¹
    bubble.addEventListener('touchmove', (e) => {
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = startX - currentX; // ÙƒÙ… Ø¨ÙƒØ³Ù„ Ø³Ø­Ø¨Øª Ù„Ù„ÙŠØ³Ø§Ø±
        const diffY = Math.abs(currentY - startY);

        // Ù„Ùˆ Ø§Ù„Ø³Ø­Ø¨ Ø±Ø£Ø³ÙŠ (Ø³ÙƒØ±ÙˆÙ„) Ù†ÙˆÙ‚Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©
        if (diffY > diffX && diffY > 10) return;

        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø±
        if (diffX > 30 && diffY < 20) { 
            isSwipingLeft = true;
            
            // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ€ Feedback Ø«Ù… ØªØ¹ÙˆØ¯ (Rubber band effect)
            // Ù„Ùˆ Ù…Ø´ Ø¹Ø§ÙŠØ²Ù‡Ø§ ØªØªØ­Ø±Ùƒ Ø®Ø§Ù„Øµ Ø§Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡
            bubble.style.transform = `translateX(-${Math.min(diffX, 20)}px)`; 
        }
    }, { passive: true });

    // 3. Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ø¥ØµØ¨Ø¹
    bubble.addEventListener('touchend', (e) => {
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù…ÙƒØ§Ù†Ù‡Ø§
        bubble.style.transform = 'translateX(0)';
        bubble.style.transition = 'transform 0.2s ease-out';
        setTimeout(() => { bubble.style.transition = ''; }, 200);

        // Ù„Ùˆ ÙƒØ§Ù†Øª Ø³Ø­Ø¨Ø© Ù„Ù„ÙŠØ³Ø§Ø± Ù‚ÙˆÙŠØ© ÙˆØ³Ø±ÙŠØ¹Ø© ÙƒÙØ§ÙŠØ©
        const touchDuration = Date.now() - touchStartTime;
        if (isSwipingLeft && touchDuration < 500) {
            // ğŸ”¥ Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ğŸ”¥
            showSwipeActionBar(rowElement, msgId);
            
            // ÙÙŠØ¨Ø±ÙŠØ´Ù† Ø®ÙÙŠÙ
            if (navigator.vibrate) navigator.vibrate(20);
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
function showSwipeActionBar(rowElement, msgId) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø´Ø±ÙŠØ· Ø¨Ø§Ù„ÙØ¹Ù„
    const existing = rowElement.querySelector('.swipe-reaction-bar');
    if (existing) return;

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©)
    const bar = document.createElement('div');
    bar.className = 'swipe-reaction-bar';

    // 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'];
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„Ø´Ø±ÙŠØ·
    emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'swipe-emoji-btn';
        span.innerText = emoji;
        span.onclick = (e) => {
            e.stopPropagation();
            toggleReaction(emoji, msgId); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ
            bar.remove(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        };
        bar.appendChild(span);
    });

    // 3. Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø²Ø§Ø¦Ø¯ (+)
    const plusBtn = document.createElement('div');
    plusBtn.className = 'swipe-plus-btn';
    plusBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
    plusBtn.onclick = (e) => {
        e.stopPropagation();
        openFullEmojiPicker(msgId); // Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ ÙƒÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø³Ø£ÙƒØªØ¨Ù‡Ø§ Ù„Ùƒ Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
        bar.remove();
    };
    bar.appendChild(plusBtn);

    // 4. ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø¯Ø§Ø®Ù„ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    // Ù†Ø¶Ø¹Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ row Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
    const bubbleContainer = rowElement.querySelector('.msg-bubble');
    // Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ· ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù€ row relative
    rowElement.style.position = 'relative'; 
    rowElement.appendChild(bar);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ù„Ùˆ Ø¶ØºØ·Øª ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ØªØ§Ù†ÙŠ
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!bar.contains(e.target)) {
                bar.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

// Ø¯Ø§Ù„Ø© (ÙˆÙ‡Ù…ÙŠØ©) Ù„ÙØªØ­ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ - ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
function openFullEmojiPicker(msgId) {
    // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨ØªØ§Ø¹ Ø§Ù„Ù€ Context Menu Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø³ Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    // Ø£Ùˆ ØªØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¤Ù‚ØªØ§Ù‹
    alert("Ù‡Ù†Ø§ ØªÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø±Ù‚Ù…: " + msgId);
    
    // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© openContextMenu Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù…Ù…ÙƒÙ† ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ ÙƒØ¯Ù‡:
    // openContextMenu(null, msgId); 
}

// Ø¯Ø§Ù„Ø© Ù„Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø©
function attachSwipeReaction(rowElement, msgData, msgId) {
    const bubble = rowElement.querySelector('.msg-bubble');
    if (!bubble) return;

    let startX = 0;
    let startY = 0;
    let isSwipingLeft = false;
    let touchStartTime = 0;

    // 1. Ø¹Ù†Ø¯ Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø©
    bubble.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        touchStartTime = Date.now();
        isSwipingLeft = false;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© ØªÙØ§Ø¹Ù„Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
        document.querySelectorAll('.swipe-reaction-bar').forEach(el => el.remove());
    }, { passive: true });

    // 2. Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¥ØµØ¨Ø¹
    bubble.addEventListener('touchmove', (e) => {
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = startX - currentX; // ÙƒÙ… Ø¨ÙƒØ³Ù„ Ø³Ø­Ø¨Øª Ù„Ù„ÙŠØ³Ø§Ø±
        const diffY = Math.abs(currentY - startY);

        // Ù„Ùˆ Ø§Ù„Ø³Ø­Ø¨ Ø±Ø£Ø³ÙŠ (Ø³ÙƒØ±ÙˆÙ„) Ù†ÙˆÙ‚Ù Ø§Ù„ÙˆØ¸ÙŠÙØ©
        if (diffY > diffX && diffY > 10) return;

        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø±
        if (diffX > 30 && diffY < 20) { 
            isSwipingLeft = true;
            
            // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ€ Feedback Ø«Ù… ØªØ¹ÙˆØ¯ (Rubber band effect)
            // Ù„Ùˆ Ù…Ø´ Ø¹Ø§ÙŠØ²Ù‡Ø§ ØªØªØ­Ø±Ùƒ Ø®Ø§Ù„Øµ Ø§Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡
            bubble.style.transform = `translateX(-${Math.min(diffX, 20)}px)`; 
        }
    }, { passive: true });

    // 3. Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ø¥ØµØ¨Ø¹
    bubble.addEventListener('touchend', (e) => {
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù…ÙƒØ§Ù†Ù‡Ø§
        bubble.style.transform = 'translateX(0)';
        bubble.style.transition = 'transform 0.2s ease-out';
        setTimeout(() => { bubble.style.transition = ''; }, 200);

        // Ù„Ùˆ ÙƒØ§Ù†Øª Ø³Ø­Ø¨Ø© Ù„Ù„ÙŠØ³Ø§Ø± Ù‚ÙˆÙŠØ© ÙˆØ³Ø±ÙŠØ¹Ø© ÙƒÙØ§ÙŠØ©
        const touchDuration = Date.now() - touchStartTime;
        if (isSwipingLeft && touchDuration < 500) {
            // ğŸ”¥ Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ğŸ”¥
            showSwipeActionBar(rowElement, msgId);
            
            // ÙÙŠØ¨Ø±ÙŠØ´Ù† Ø®ÙÙŠÙ
            if (navigator.vibrate) navigator.vibrate(20);
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
function showSwipeActionBar(rowElement, msgId) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø´Ø±ÙŠØ· Ø¨Ø§Ù„ÙØ¹Ù„
    const existing = rowElement.querySelector('.swipe-reaction-bar');
    if (existing) return;

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© (Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©)
    const bar = document.createElement('div');
    bar.className = 'swipe-reaction-bar';

    // 2. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ˜¡'];
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„Ø´Ø±ÙŠØ·
    emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'swipe-emoji-btn';
        span.innerText = emoji;
        span.onclick = (e) => {
            e.stopPropagation();
            toggleReaction(emoji, msgId); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ
            bar.remove(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        };
        bar.appendChild(span);
    });

    // 3. Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø²Ø§Ø¦Ø¯ (+)
    const plusBtn = document.createElement('div');
    plusBtn.className = 'swipe-plus-btn';
    plusBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
    plusBtn.onclick = (e) => {
        e.stopPropagation();
        openFullEmojiPicker(msgId); // Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ ÙƒÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø³Ø£ÙƒØªØ¨Ù‡Ø§ Ù„Ùƒ Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
        bar.remove();
    };
    bar.appendChild(plusBtn);

    // 4. ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø¯Ø§Ø®Ù„ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    // Ù†Ø¶Ø¹Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ row Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
    const bubbleContainer = rowElement.querySelector('.msg-bubble');
    // Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ· ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù€ row relative
    rowElement.style.position = 'relative'; 
    rowElement.appendChild(bar);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· Ù„Ùˆ Ø¶ØºØ·Øª ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ØªØ§Ù†ÙŠ
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!bar.contains(e.target)) {
                bar.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

// Ø¯Ø§Ù„Ø© (ÙˆÙ‡Ù…ÙŠØ©) Ù„ÙØªØ­ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ - ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
function openFullEmojiPicker(msgId) {
    // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨ØªØ§Ø¹ Ø§Ù„Ù€ Context Menu Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø³ Ø¹Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    // Ø£Ùˆ ØªØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¤Ù‚ØªØ§Ù‹
    alert("Ù‡Ù†Ø§ ØªÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø±Ù‚Ù…: " + msgId);
    
    // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© openContextMenu Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù…Ù…ÙƒÙ† ØªØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ ÙƒØ¯Ù‡:
    // openContextMenu(null, msgId); 
}

// ================================================================
// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (ÙŠÙ…ÙŠÙ† Ù„Ù„Ø±Ø¯ - ÙŠØ³Ø§Ø± Ù„Ù„ØªÙØ§Ø¹Ù„) ğŸ”¥
// ================================================================
function enableUnifiedSwipe(rowElement, bubbleElement, msgData, msgId) {
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let isSwiping = false;
    let swipeDirection = null; // 'right' or 'left'

    // 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
    bubbleElement.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isSwiping = false;
        swipeDirection = null;
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªÙƒÙˆÙ† Ù†Ø§Ø¹Ù…Ø© Ù…Ø¹ Ø§Ù„ØµØ¨Ø§Ø¹
        bubbleElement.classList.remove('snapping'); 
        
        // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… ØªÙØ§Ø¹Ù„ Ù…ÙØªÙˆØ­Ø©
        document.querySelectorAll('.swipe-reaction-bar').forEach(el => el.remove());
    }, { passive: true });

    // 2. Ø­Ø±ÙƒØ© Ø§Ù„ØµØ¨Ø§Ø¹
    bubbleElement.addEventListener('touchmove', (e) => {
        currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX; // Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø£ÙÙ‚ÙŠ
        const diffY = Math.abs(currentY - startY); // Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø±Ø£Ø³ÙŠ

        // Ù„Ùˆ Ø§Ù„Ø³Ø­Ø¨ Ø±Ø£Ø³ÙŠ (Ø·Ø§Ù„Ø¹ Ù†Ø§Ø²Ù„)ØŒ Ù†ÙˆÙ‚Ù ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø³Ø­Ø¨ Ø¯ÙŠ Ø®Ø§Ù„Øµ
        if (diffY > Math.abs(diffX)) return;

        // --- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ---
        
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø£: Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† (Ù„Ù„Ø±Ø¯) - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 100 Ø¨ÙƒØ³Ù„
        if (diffX > 0) {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§ÙˆÙ…Ø© ÙƒÙ„ Ù…Ø§ ØªØ¨Ø¹Ø¯ Ø¹Ø´Ø§Ù† ÙŠØ­Ø³ Ø¥Ù†Ù‡Ø§ "Ø£Ø³ØªÙŠÙƒ"
            let move = Math.min(diffX, 100); 
            bubbleElement.style.transform = `translateX(${move}px)`;
            swipeDirection = 'right';
            isSwiping = true;
        } 
        
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø¨: Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± (Ù„Ù„ØªÙØ§Ø¹Ù„) - Ø­Ø¯ Ø£Ù‚ØµÙ‰ -30 Ø¨ÙƒØ³Ù„
        else if (diffX < 0) {
            let move = Math.max(diffX, -40); // Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 40 Ø¨ÙƒØ³Ù„ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨
            bubbleElement.style.transform = `translateX(${move}px)`;
            swipeDirection = 'left';
            isSwiping = true;
        }

    }, { passive: true });

    // 3. Ø±ÙØ¹ Ø§Ù„ØµØ¨Ø§Ø¹ (ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±)
    bubbleElement.addEventListener('touchend', (e) => {
        const diffX = currentX - startX;

        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù…ÙƒØ§Ù†Ù‡Ø§ Ø¨Ù†Ø¹ÙˆÙ…Ø©
        bubbleElement.classList.add('snapping'); // ÙƒÙ„Ø§Ø³ ÙÙŠ CSS Ø¨ÙŠØ¹Ù…Ù„ transition
        bubbleElement.style.transform = 'translateX(0)';

        if (isSwiping) {
            // === ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„Ø±Ø¯) ===
            if (swipeDirection === 'right' && diffX > 60) {
                // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„ØªØ£ÙƒÙŠØ¯
                if (navigator.vibrate) navigator.vibrate(20);
                
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø¯
                activateReplyModeWithData(msgId, msgData);
            }

            // === ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± (Ø§Ù„ØªÙØ§Ø¹Ù„) ===
            else if (swipeDirection === 'left' && diffX < -30) {
                // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„ØªØ£ÙƒÙŠØ¯
                if (navigator.vibrate) navigator.vibrate(20);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
                showSwipeActionBar(rowElement, msgId);
            }
        }

        // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        startX = 0;
        currentX = 0;
        isSwiping = false;
        swipeDirection = null;
    });
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¯ (Ø¹Ø´Ø§Ù† Ù†ÙØµÙ„Ù‡Ø§ Ø¹Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©)
function activateReplyModeWithData(id, data) {
    selectedMsgId = id;
    selectedMsgData = data;
    activateReplyMode();
}

// ÙØªØ­ Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙˆØ±Ø©
function openGalleryViewer(index) {
    currentImageIndex = index;
    updateLightboxContent();
    document.getElementById('lightbox').style.display = 'flex';
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
function updateLightboxContent() {
    const imgElement = document.getElementById('lb-img');
    const counter = document.getElementById('lb-counter');
    
    // ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯
    imgElement.src = galleryImagesList[currentImageIndex];
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹: 3 / 10)
    if(counter) counter.innerText = `${currentImageIndex + 1} / ${galleryImagesList.length}`;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¨ (Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚)
function changeGalleryImage(direction) {
    // direction: 1 Ù„Ù„ØªØ§Ù„ÙŠ (Ø´Ù…Ø§Ù„)ØŒ -1 Ù„Ù„Ø³Ø§Ø¨Ù‚ (ÙŠÙ…ÙŠÙ†)
    
    const newIndex = currentImageIndex + direction;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ù…Ø®Ø±Ø¬Ù†Ø§Ø´ Ø¨Ø±Ù‡ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if (newIndex >= 0 && newIndex < galleryImagesList.length) {
        currentImageIndex = newIndex;
        
        // ØªØ£Ø«ÙŠØ± Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙØ§Ø¡ ÙˆØ¸Ù‡ÙˆØ±)
        const img = document.getElementById('lb-img');
        img.style.opacity = '0.5';
        setTimeout(() => {
            updateLightboxContent();
            img.style.opacity = '1';
        }, 150);
        
    } else {
        // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø¢Ø®Ø±ØŒ Ù…Ù…ÙƒÙ† ØªØ¹Ù…Ù„ Ù‡Ø²Ø© Ø¨Ø³ÙŠØ·Ø© ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        if(navigator.vibrate) navigator.vibrate(50);
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø±Ø¶
function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
}

// ================= Ø¥Ø¶Ø§ÙØ©: Ø§Ù„ØªÙ‚Ù„ÙŠØ¨ Ø¨Ø§Ù„Ø³Ø­Ø¨ (Touch Swipe) Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ =================
let touchStartX = 0;
let touchEndX = 0;

const lbElement = document.getElementById('lightbox');

if(lbElement) {
    lbElement.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    lbElement.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });
}

function handleSwipe() {
    // Ù„Ùˆ Ø³Ø­Ø¨ ØµØ¨Ø§Ø¹Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„Ø´Ù…Ø§Ù„ (Ø§Ù„ØªØ§Ù„ÙŠ)
    if (touchEndX < touchStartX - 50) { 
        changeGalleryImage(1); 
    }
    // Ù„Ùˆ Ø³Ø­Ø¨ ØµØ¨Ø§Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ Ù„Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„Ø³Ø§Ø¨Ù‚)
    if (touchEndX > touchStartX + 50) { 
        changeGalleryImage(-1); 
    }
}

// Ø¶ÙŠÙ Ø¯ÙŠ Ø¹Ø´Ø§Ù† ØªØªØ£ÙƒØ¯ Ø¥Ù† Ù…ÙÙŠØ´ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆÙ‡Ù…ÙŠØ© Ø´ØºØ§Ù„Ø©
async function clearStuckCalls() {
    if(!chatId) return;
    const docRef = db.collection('chats').doc(chatId).collection('calls').doc('active_call');
    const doc = await docRef.get();
    
    if(doc.exists) {
        const data = doc.data();
        // Ù„Ùˆ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¹Ø¯Ù‰ Ø¹Ù„ÙŠÙ‡Ø§ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† ÙˆÙ„Ø³Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ringingØŒ Ø§Ø­Ø°ÙÙ‡Ø§
        const now = Date.now();
        const startTime = data.startTime ? data.startTime.toMillis() : 0;
        
        if (now - startTime > 2 * 60 * 1000) { 
            await docRef.delete();
            console.log("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ù…ÙƒØ§Ù„Ù…Ø© Ø¹Ø§Ù„Ù‚Ø©");
        }
    }
}
function openUserPopup(uid) {
    // 1. Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù„Ù†ÙØ³Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    /* if (uid === currentUserId) return; */

    currentPopupUserId = uid;
    
    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    // Ù†Ø³ØªØ®Ø¯Ù… || {} Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
    const userData = userCache[uid] || { 
        name: 'Ù…Ø³ØªØ®Ø¯Ù…', 
        color: '#555', 
        char: '?' 
    };
    
    // --- Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØµÙˆØ±Ø© (Image Fix) ---
    const avatarEl = document.getElementById('popupAvatar');
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù…ØªØ§Ø­ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userImage = userData.profilePic || userData.avatar || userData.photoURL || userData.image;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù‚ÙˆÙŠ: Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙˆÙ‡Ù„ Ù‡Ùˆ Ù„ÙŠØ³ ÙƒÙ„Ù…Ø© "null" Ø§Ù„Ù†ØµÙŠØ©
    if (userImage && userImage !== 'null' && userImage !== '') {
        // Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø©
        avatarEl.style.backgroundImage = `url('${userImage}')`;
        avatarEl.innerText = ''; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø±Ù
        avatarEl.style.backgroundColor = 'transparent'; // Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ©
    } else {
        // Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø© (Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„)
        avatarEl.style.backgroundImage = 'none';
        // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ØŸ
        const char = userData.char || (userData.name ? userData.name.charAt(0).toUpperCase() : '?');
        avatarEl.innerText = char;
        avatarEl.style.backgroundColor = userData.color || '#333';
    }

    // --- Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ (Verification Fix) ---
    
    // 1. ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
    document.getElementById('popupName').innerText = userData.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
    
    // 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML
    const verifyIcon = document.getElementById('popupVerify');
    if (verifyIcon) {
        if (userData.isVerified === true) {
            verifyIcon.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        } else {
            verifyIcon.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        }
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¨Ø°Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠØ© (Bio)
    document.getElementById('popupBio').innerText = userData.bio || "Ù…Ø³ØªØ®Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚ Wareed";

    // 5. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    const overlay = document.getElementById('userPopupOverlay');
    if (overlay) {
        // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„ØªÙƒÙˆÙ† ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
        if(overlay.parentNode !== document.body) document.body.appendChild(overlay);
        
        overlay.style.display = 'flex';
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.opacity = '1', 10);
    }
    
    if(navigator.vibrate) navigator.vibrate(10);
}

function closeUserPopup() {
    const overlay = document.getElementById('userPopupOverlay');
    overlay.style.animation = 'fadeOut 0.2s forwards'; // Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ¶ÙŠÙ Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ø®ÙØ§Ø¡
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.style.animation = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù†
    }, 200);
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
function startDirectChat() {
    closeUserPopup();
    // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ ÙƒÙˆØ¯ ÙŠÙØªØ­ Ø´Ø§Øª Ø®Ø§Øµ Ø£Ùˆ ÙŠÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    // Ø¨Ù…Ø§ Ø¥Ù†Ù†Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø´Ø§ØªØŒ Ù…Ù…ÙƒÙ† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„Ø¹Ù…Ù„ Ù…Ù†Ø´Ù† Ù…Ø«Ù„Ø§Ù‹
    const input = document.getElementById('messageInput');
    input.value += `@${document.getElementById('popupName').innerText} `;
    input.focus();
}

function startDirectCall() {
    closeUserPopup();
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø¯ÙŠÙƒ Ø¨Ø§Ù„ÙØ¹Ù„
    initiateCall(); // Ø£Ùˆ initiateVideoCallUI()
}

function viewFullProfileFromPopup() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    closeUserPopup();
    
    // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù€ ID
    if(cachedOtherUserId) {
        // Ù†ÙØªØ±Ø¶ Ø£Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù€ uid ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
        window.location.href = `profile.html?uid=${cachedOtherUserId}`;
    } else {
        showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹");
    }
}

function viewUserStory() {
    closeUserPopup(); // ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    
    // Ù‡Ù†Ø§ Ø§Ù„Ù…ÙØ±ÙˆØ¶ ÙƒÙˆØ¯ ÙØªØ­ Ø§Ù„Ø³ØªÙˆØ±ÙŠ Ø§Ù„ÙØ¹Ù„ÙŠ
    // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ÙØªØ­ Ø¨Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¹Ø§Ø±Ø¶
    const userImg = document.getElementById('popupAvatar').style.backgroundImage.slice(5, -2);
    
    if(userImg) {
        openGalleryViewerBySrc(userImg); // Ù†ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ£Ù†Ù‡Ø§ Ø³ØªÙˆØ±ÙŠ
        showToast("Ø¬Ø§Ø±Ù ÙØªØ­ Ø§Ù„Ù‚ØµØ©... â³");
    } else {
        showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØ© Ù„Ø¹Ø±Ø¶Ù‡Ø§");
    }
}
function openNicknameInput() {
    // 1. Ù†Ù‚ÙÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ØµØºØ± Ø§Ù„Ø£ÙˆÙ„
    closeUserPopup(); 

    // 2. (Ø§Ù„ØªØµÙ„ÙŠØ­ Ù‡Ù†Ø§) Ù†Ø­Ø¯Ø¯ Ù…ÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ù‡Ù†ØºÙŠØ± Ø§Ø³Ù…Ù‡ Ù‚Ø¨Ù„ Ù…Ø§ Ù†ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    // Ù„Ùˆ ÙƒÙ†Ø§ ÙØ§ØªØ­ÙŠÙ† Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø­Ø¯ Ù…Ø¹ÙŠÙ†ØŒ Ù†Ø§Ø®Ø¯ Ø§Ù„Ù€ ID Ø¨ØªØ§Ø¹Ù‡
    if (typeof currentPopupUserId !== 'undefined' && currentPopupUserId) {
        editingTargetId = currentPopupUserId;
    } else {
        // Ù„Ùˆ Ø­ØµÙ„ Ø£ÙŠ Ø®Ø·Ø£ØŒ Ù†Ø³ØªØ®Ø¯Ù… ID Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ø¨Ù†ÙƒÙ„Ù…Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø´Ø§Øª
        editingTargetId = cachedOtherUserId;
    }

    // 3. Ù†ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ù…Ø§ Ø­Ø¯Ø¯Ù†Ø§ Ø§Ù„Ø´Ø®Øµ
    const modal = document.getElementById('nicknameModal');
    if (modal) {
        // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ø¢Ø®Ø± Ø§Ù„ØµÙØ­Ø© Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ© (Z-Index)
        if (modal.parentNode !== document.body) document.body.appendChild(modal);
        
        modal.style.display = 'flex';
        
        // Ù†Ø±ÙƒØ² Ø§Ù„Ù…Ø¤Ø´Ø± ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        setTimeout(() => {
            const input = document.getElementById('nicknameInput');
            if(input) {
                input.value = ""; // Ù†ÙØ¶ÙŠ Ø§Ù„Ø®Ø§Ù†Ø©
                input.focus();
            }
        }, 100);
    } else {
        console.error("Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ù‚Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML");
    }
}

// Ø­ÙØ¸ Ø§Ù„Ù„Ù‚Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø¸Ø§Ù…
// Ø­ÙØ¸ Ø§Ù„Ù„Ù‚Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø¸Ø§Ù… (Ù…ØµØ­Ø­Ø©)
// Ø­ÙØ¸ Ø§Ù„Ù„Ù‚Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù†Ø¸Ø§Ù… (Ù…ØµØ­Ø­Ø©)
// 1. ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ø£Ù†Ø§ ÙˆÙ„Ø§ Ù‡Ùˆ)
function openNicknameSelection() {
    closeProfile(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const myData = userCache[currentUserId] || {};
    const friendData = userCache[cachedOtherUserId] || {};

    // ØµÙˆØ±ØªÙŠ
    const myAv = document.getElementById('myAvatarSmall');
    if(myData.profilePic) myAv.style.backgroundImage = `url(${myData.profilePic})`;
    else myAv.innerText = myData.char || 'ME';

    // ØµÙˆØ±Ø© ØµØ¯ÙŠÙ‚ÙŠ
    const friendAv = document.getElementById('friendAvatarSmall');
    if(friendData.profilePic) friendAv.style.backgroundImage = `url(${friendData.profilePic})`;
    else friendAv.innerText = friendData.char || 'U';
    
    document.getElementById('friendNameLabel').innerText = `ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ ${friendData.name}`;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('nicknameSelectModal').style.display = 'flex';
}

function startEditNickname(targetId) {
    editingTargetId = targetId;
    document.getElementById('nicknameSelectModal').style.display = 'none';
    
    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ Ø£ØµÙ„Ø§Ù‹
    document.getElementById('nicknameModal').style.display = 'flex';
    document.getElementById('nicknameInput').value = ""; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚Ù„
    document.getElementById('nicknameInput').focus();
}

// 3. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±Ùƒ (Shared Save)
async function saveSharedNickname() {
    // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø©
    const newName = document.getElementById('nicknameInput').value.trim();
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ editingTargetId Ø§Ù„Ø°ÙŠ ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const targetId = editingTargetId; 

    if (!targetId || !chatId) {
        showToast("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        return;
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('nicknameModal').style.display = 'none';
    showToast("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù„Ù‚Ø¨ Ù„Ù„Ø·Ø±ÙÙŠÙ†...");

    try {
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const updateData = {};
        // Ø¥Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±Øº Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø°ÙÙ‡ØŒ ÙˆØ¥Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø­ÙØ¸Ù‡
        updateData[`nicknames.${targetId}`] = newName ? newName : firebase.firestore.FieldValue.delete();

        // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        await db.collection('chats').doc(chatId).update(updateData);

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù… ÙÙŠ Ø§Ù„Ø´Ø§Øª
        let targetNameOriginal = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
        if(userCache[targetId]) targetNameOriginal = userCache[targetId].name;

        let sysMsg = "";
        if (newName) {
            sysMsg = (targetId === currentUserId) 
                ? `Ù‚Ø§Ù… Ø¨ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨Ù‡ Ø¥Ù„Ù‰ "${newName}"` 
                : `Ù‚Ø§Ù… Ø¨ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ ${targetNameOriginal} Ø¥Ù„Ù‰ "${newName}"`;
        } else {
            sysMsg = (targetId === currentUserId) 
                ? `Ù‚Ø§Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ù„Ù‚Ø¨Ù‡` 
                : `Ù‚Ø§Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ù„Ù‚Ø¨ ${targetNameOriginal}`;
        }

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        await db.collection("chats").doc(chatId).collection("messages").add({
            type: 'system_nickname',
            text: sysMsg,
            uid: currentUserId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            seen: false,
            isGhost: false
        });

        showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ù‚Ø¨ Ù„Ù„Ø¬Ù…ÙŠØ¹");

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        if (targetId === currentUserId) {
            document.getElementById('pageMyNick').innerText = newName || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‚Ø¨";
        } else {
            document.getElementById('pageFriendNick').innerText = newName || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‚Ø¨";
            document.getElementById('headerName').innerText = newName || targetNameOriginal;
        }

    } catch (e) {
        console.error(e);
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ nicknames Ø£ØµÙ„Ø§Ù‹
        if(e.code === 'not-found' || e.message.includes('No document') || e.code === 'invalid-argument') {
             const setData = { nicknames: {} };
             if(newName) setData.nicknames[targetId] = newName;
             await db.collection('chats').doc(chatId).set(setData, {merge: true});
             showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ ÙˆØ­ÙØ¸ Ø§Ù„Ø§Ø³Ù…");
        } else {
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
        }
    }
}
function listenForSharedNicknames() {
    if (!chatId) return;

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø´Ø§Øª Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
    db.collection('chats').doc(chatId).onSnapshot(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        if (data.nicknames) {
            globalNicknames = data.nicknames;
        } else {
            globalNicknames = {};
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙˆØ±Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù„Ù‚Ø¨ Ù„Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ Ù†Ø­Ø§Ø¯Ø«Ù‡
        if (cachedOtherUserId && globalNicknames[cachedOtherUserId]) {
            const newNick = globalNicknames[cachedOtherUserId];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù‡ÙŠØ¯Ø±
            const headerEl = document.getElementById('headerName');
            if(headerEl) headerEl.innerText = getShortName(newNick);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            const callEl = document.getElementById('callName');
            if(callEl) callEl.innerText = getShortName(newNick);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ù„ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            if(userCache[cachedOtherUserId]) {
                userCache[cachedOtherUserId].name = newNick;
            }
        } else if (cachedOtherUserId && userCache[cachedOtherUserId]) {
             // Ù„Ùˆ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù„Ù‚Ø¨ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
             // (Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ø¨Ø¯Ù‚Ø© Ø£ÙƒØ«Ø± ÙÙŠ updateHeader)
        }
    });
}

// 1. ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ (Full Page)
function openNicknamesPage() {
    // Ø¥Ø®ÙØ§Ø¡ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹
    document.getElementById('profilePage').style.display = 'none';
    
    // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨
    const page = document.getElementById('nicknamesPage');
    document.body.appendChild(page); // Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡
    page.style.display = 'flex';

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    const myData = userCache[currentUserId] || {};
    const friendData = userCache[cachedOtherUserId] || {};

    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ ---
    const myAvDiv = document.getElementById('pageMyAvatar');
    if(myData.profilePic) {
        myAvDiv.style.backgroundImage = `url('${myData.profilePic}')`;
        myAvDiv.innerText = '';
    } else {
        myAvDiv.style.backgroundImage = 'none';
        myAvDiv.innerText = myData.char || 'ME';
    }
    // Ø¹Ø±Ø¶ Ø§Ù„Ù„Ù‚Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙŠ
    document.getElementById('pageMyNick').innerText = myData.name || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‚Ø¨";

    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ¯ÙŠÙ‚ ---
    const friendAvDiv = document.getElementById('pageFriendAvatar');
    if(friendData.profilePic) {
        friendAvDiv.style.backgroundImage = `url('${friendData.profilePic}')`;
        friendAvDiv.innerText = '';
    } else {
        friendAvDiv.style.backgroundImage = 'none';
        friendAvDiv.innerText = friendData.char || 'U';
    }
    
    // Ø¶Ø¨Ø· Ø§Ù„Ù†ØµÙˆØµ
    document.getElementById('pageFriendLabel').innerText = `ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ ${friendData.name || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}`;
    document.getElementById('pageFriendNick').innerText = friendData.name || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‚Ø¨";
}

// 2. Ø¥ØºÙ„Ø§Ù‚ ØµÙØ­Ø© Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
function closeNicknamesPage() {
    document.getElementById('nicknamesPage').style.display = 'none';
    document.getElementById('profilePage').style.display = 'flex'; // Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ù„Ù
}

// ================= Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚) =================
async function openUserStoryViewer(targetUid) {
    const viewer = document.getElementById('simpleStoryViewer');
    
    // Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    if (viewer.parentNode !== document.body) {
        document.body.appendChild(viewer);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© (Reset)
    viewer.style.display = 'flex';
    viewer.style.opacity = '1';       
    viewer.style.transform = 'none';  
    
    showToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ©... â³");

    try {
        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒØ§Ø´ (userCache) Ø£Ùˆ Ø§Ù„Ù€ Database
        let userData = userCache[targetUid];
        if (!userData) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ø´
            const userDoc = await db.collection('users').doc(targetUid).get();
            userData = userDoc.exists ? userDoc.data() : { name: 'Ù…Ø³ØªØ®Ø¯Ù…', profilePic: null, isVerified: false };
            userCache[targetUid] = userData; // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
        }

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„ Ù„Ø¯ÙŠÙƒ)
        const nameEl = document.getElementById('storyUserName');
        if (nameEl) nameEl.innerText = userData.name || userData.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
        const imgEl = document.getElementById('storyUserImg');
        if (imgEl) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒØ§ÙØ© Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù€ Database
            const picSrc = userData.profilePic || userData.avatar || userData.photoURL || 'https://i.ibb.co/tZ5tPqB/default-avatar.png';
            imgEl.src = picSrc;
        }

        // 4. ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
        const verifyBadge = document.getElementById('storyVerifyIcon');
        if (verifyBadge) {
            if (userData.isVerified === true) {
                verifyBadge.style.display = 'inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
            } else {
                verifyBadge.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
            }
        }

        // 5. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ØµØµ Ù…Ù† Firestore (Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©)
        const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        const snapshot = await db.collection('stories')
            .where('uid', '==', targetUid)
            .where('timestamp', '>', twentyFourHoursAgo)
            .orderBy('timestamp', 'asc')
            .get();

        if (snapshot.empty) {
            viewer.style.display = 'none'; 
            showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØµ Ù„Ø¹Ø±Ø¶Ù‡Ø§");
            return;
        }

        currentStoriesQueue = [];
        snapshot.forEach(doc => currentStoriesQueue.push(doc.data()));

        // Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ù‚ØµØ©
        currentStoryIndex = 0;
        showStoryItem(currentStoryIndex);

    } catch(err) {
        console.error("Story Loading Error:", err);
        viewer.style.display = 'none';
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØ©");
    }
}

// ================= Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ =================
function closeProfile() {
    const profilePage = document.getElementById('profilePage');
    if (profilePage) {
        // ØªØ£Ø«ÙŠØ± Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø®Ø±ÙˆØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        profilePage.style.transition = "transform 0.3s ease, opacity 0.3s ease";
        profilePage.style.transform = "translateX(100%)"; // ÙŠØ²Ø­Ù„Ù‚ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ÙŠÙ…ÙŠÙ†
        profilePage.style.opacity = "0";

        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø«Ù… Ø§Ù„Ø¥Ø®ÙØ§Ø¡
        setTimeout(() => {
            profilePage.style.display = 'none';
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø®ØµØ§Ø¦Øµ Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡Ø§ Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ØªÙØªØ­ ØªØ§Ù†ÙŠ
            profilePage.style.transform = ""; 
            profilePage.style.opacity = "";
        }, 300);
    }
}
async function toggleGifPicker() {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
    if(!document.getElementById('gifPicker')) {
        const div = document.createElement('div');
        div.id = 'gifPicker';
        div.className = 'gif-picker';
        div.innerHTML = `
            <input type="text" placeholder="Ø¨Ø­Ø« Ø¹Ù† GIF..." style="width:100%; padding:10px; background:rgba(0,0,0,0.2); border:none; color:#fff;" oninput="searchGifs(this.value)">
            <div class="gif-grid" id="gifGrid"></div>
        `;
        document.querySelector('.chat-footer').appendChild(div);
        searchGifs('funny'); // Ø¨Ø­Ø« Ø§ÙØªØ±Ø§Ø¶ÙŠ
    }
    
    const picker = document.getElementById('gifPicker');
    picker.style.display = picker.style.display === 'flex' ? 'none' : 'flex';
}

async function searchGifs(query) {
    // Ø§Ø³ØªØ®Ø¯Ù… API Key Ù…Ø¬Ø§Ù†ÙŠ Ù…Ù† Tenor
    const key = "LIVDSRZULELA"; 
    const url = `https://g.tenor.com/v1/search?q=${query}&key=${key}&limit=10`;
    
    const res = await fetch(url);
    const data = await res.json();
    const grid = document.getElementById('gifGrid');
    grid.innerHTML = '';
    
    data.results.forEach(gif => {
        const img = document.createElement('img');
        img.src = gif.media[0].tinygif.url;
        img.className = 'gif-item';
        img.onclick = () => sendGif(gif.media[0].gif.url);
        grid.appendChild(img);
    });
}

function sendGif(url) {
    // Ø¥Ø±Ø³Ø§Ù„ ÙƒØµÙˆØ±Ø© Ø¹Ø§Ø¯ÙŠØ©
    db.collection("chats").doc(chatId).collection("messages").add({
        text: url,
        uid: currentUserId,
        type: 'image', // ÙŠØ¹Ø§Ù…Ù„ Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
        seen: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toggleGifPicker(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
}



// 1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ù‚Ø§Ø¦Ù…Ø© Ù…ÙˆØ³Ø¹Ø© - 80 Ù…Ù†ØªØ¬)
const premiumGifts = [
    // =============================================
    // Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù‡Ø¯Ø§ÙŠØ§ Ø¹Ø§Ø¯ÙŠØ© (Regular Tier)
    // (Ø£Ø³Ø¹Ø§Ø± Ù…Ù† 5 Ø¥Ù„Ù‰ 499 ÙƒÙˆÙŠÙ†Ø² - ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ±Ø¯ÙŠ)
    // =============================================
    
    // --- ğŸŒ¹ Ø­Ø¨ ÙˆØ±ÙˆÙ…Ø§Ù†Ø³ÙŠØ© ---
    { id: 'p1', icon: 'ğŸŒ¹', name: 'ÙˆØ±Ø¯Ø© Ø­Ù…Ø±Ø§Ø¡', price: 10, type: 'premium', tier: 'regular' },
    { id: 'p2', icon: 'ğŸ’Œ', name: 'Ø±Ø³Ø§Ù„Ø© Ø­Ø¨', price: 15, type: 'premium', tier: 'regular' },
    { id: 'p3', icon: 'ğŸ§¸', name: 'Ø¯Ø¨Ø¯ÙˆØ¨', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p4', icon: 'ğŸ’', name: 'Ø¨ÙˆÙƒÙŠÙ‡ ÙˆØ±Ø¯', price: 80, type: 'premium', tier: 'regular' },
    { id: 'p5', icon: 'ğŸ«', name: 'Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©', price: 30, type: 'premium', tier: 'regular' },
    { id: 'p6', icon: 'ğŸ’˜', name: 'Ø³Ù‡Ù… Ø§Ù„Ø­Ø¨', price: 40, type: 'premium', tier: 'regular' },
    { id: 'p7', icon: 'ğŸ’', name: 'Ø¯Ø¨Ù„Ø© ÙØ¶Ø©', price: 100, type: 'premium', tier: 'regular' },
    { id: 'p8', icon: 'ğŸ’‹', name: 'Ù‚Ø¨Ù„Ø©', price: 20, type: 'premium', tier: 'regular' },

    // --- ğŸ” Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨ ---
    { id: 'p9', icon: 'â˜•', name: 'Ù‚Ù‡ÙˆØ© ØµØ¨Ø§Ø­ÙŠØ©', price: 20, type: 'premium', tier: 'regular' },
    { id: 'p10', icon: 'ğŸ•', name: 'Ø¨ÙŠØªØ²Ø§', price: 25, type: 'premium', tier: 'regular' },
    { id: 'p11', icon: 'ğŸ”', name: 'Ø¨Ø±Ø¬Ø±', price: 25, type: 'premium', tier: 'regular' },
    { id: 'p12', icon: 'ğŸŸ', name: 'Ø¨Ø·Ø§Ø·Ø³', price: 15, type: 'premium', tier: 'regular' },
    { id: 'p13', icon: 'ğŸ¿', name: 'ÙØ´Ø§Ø±', price: 15, type: 'premium', tier: 'regular' },
    { id: 'p14', icon: 'ğŸ©', name: 'Ø¯ÙˆÙ†Ø§Øª', price: 20, type: 'premium', tier: 'regular' },
    { id: 'p15', icon: 'ğŸ¦', name: 'Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ…', price: 15, type: 'premium', tier: 'regular' },
    { id: 'p16', icon: 'ğŸ°', name: 'ÙƒÙŠÙƒØ© Ø¹ÙŠØ¯ Ù…ÙŠÙ„Ø§Ø¯', price: 60, type: 'premium', tier: 'regular' },
    { id: 'p17', icon: 'ğŸ¹', name: 'Ø¹ØµÙŠØ± ÙØ±ÙŠØ´', price: 20, type: 'premium', tier: 'regular' },
    { id: 'p18', icon: 'ğŸ—', name: 'Ø¯Ø¬Ø§Ø¬ Ù…Ù‚Ø±Ù…Ø´', price: 35, type: 'premium', tier: 'regular' },

    // --- ğŸ‰ Ø§Ø­ØªÙØ§Ù„Ø§Øª ÙˆØªØ±ÙÙŠÙ‡ ---
    { id: 'p19', icon: 'ğŸˆ', name: 'Ø¨Ø§Ù„ÙˆÙ†', price: 10, type: 'premium', tier: 'regular' },
    { id: 'p20', icon: 'ğŸ‰', name: 'Ù…ÙØ±Ù‚Ø¹Ø§Øª', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p21', icon: 'ğŸµ', name: 'Ù†ØºÙ…Ø© Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©', price: 25, type: 'premium', tier: 'regular' },
    { id: 'p22', icon: 'ğŸ®', name: 'Ø°Ø±Ø§Ø¹ ØªØ­ÙƒÙ…', price: 150, type: 'premium', tier: 'regular' },
    { id: 'p23', icon: 'ğŸ§', name: 'Ø³Ù…Ø§Ø¹Ø© Ø±Ø£Ø³', price: 100, type: 'premium', tier: 'regular' },
    { id: 'p24', icon: 'ğŸ¤', name: 'Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', price: 120, type: 'premium', tier: 'regular' },
    { id: 'p25', icon: 'ğŸ¸', name: 'Ø¬ÙŠØªØ§Ø±', price: 200, type: 'premium', tier: 'regular' },
    { id: 'p26', icon: 'ğŸ¹', name: 'Ø¨ÙŠØ§Ù†Ùˆ', price: 300, type: 'premium', tier: 'regular' },
    { id: 'p27', icon: 'âš½', name: 'ÙƒØ±Ø© Ù‚Ø¯Ù…', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p28', icon: 'ğŸ€', name: 'ÙƒØ±Ø© Ø³Ù„Ø©', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p29', icon: 'ğŸ†', name: 'ÙƒØ£Ø³ Ø§Ù„ÙÙˆØ²', price: 400, type: 'premium', tier: 'regular' },
    { id: 'p30', icon: 'ğŸ¥‡', name: 'Ù…ÙŠØ¯Ø§Ù„ÙŠØ© Ø°Ù‡Ø¨ÙŠØ©', price: 100, type: 'premium', tier: 'regular' },

    // --- ğŸ¶ Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·Ø¨ÙŠØ¹Ø© ---
    { id: 'p31', icon: 'ğŸ±', name: 'Ù‚Ø·Ø© ÙƒÙŠÙˆØª', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p32', icon: 'ğŸ¶', name: 'ÙƒÙ„Ø¨ ÙˆÙÙŠ', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p33', icon: 'ğŸ¦‹', name: 'ÙØ±Ø§Ø´Ø©', price: 30, type: 'premium', tier: 'regular' },
    { id: 'p34', icon: 'ğŸ¼', name: 'Ø¨Ø§Ù†Ø¯Ø§', price: 70, type: 'premium', tier: 'regular' },
    { id: 'p35', icon: 'ğŸ¦„', name: 'ÙŠÙˆÙ†ÙŠÙƒÙˆØ±Ù† ØµØºÙŠØ±', price: 400, type: 'premium', tier: 'regular' },
    { id: 'p36', icon: 'ğŸŒ»', name: 'Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø´Ù…Ø³', price: 15, type: 'premium', tier: 'regular' },
    { id: 'p37', icon: 'ğŸŒ´', name: 'Ù†Ø®Ù„Ø©', price: 60, type: 'premium', tier: 'regular' },
    { id: 'p38', icon: 'ğŸŒµ', name: 'ØµØ¨Ù‘Ø§Ø±', price: 25, type: 'premium', tier: 'regular' },

    // --- ğŸ’„ Ù…ÙˆØ¶Ø© ÙˆØ£Ù†Ø§Ù‚Ø© ---
    { id: 'p39', icon: 'ğŸ’„', name: 'Ø£Ø­Ù…Ø± Ø´ÙØ§Ù‡', price: 80, type: 'premium', tier: 'regular' },
    { id: 'p40', icon: 'ğŸ‘ ', name: 'Ø­Ø°Ø§Ø¡ ÙƒØ¹Ø¨', price: 150, type: 'premium', tier: 'regular' },
    { id: 'p41', icon: 'ğŸ‘—', name: 'ÙØ³ØªØ§Ù†', price: 200, type: 'premium', tier: 'regular' },
    { id: 'p42', icon: 'ğŸ•¶ï¸', name: 'Ù†Ø¸Ø§Ø±Ø© Ø´Ù…Ø³', price: 120, type: 'premium', tier: 'regular' },
    { id: 'p43', icon: 'ğŸ§¢', name: 'ÙƒØ§Ø¨', price: 50, type: 'premium', tier: 'regular' },
    { id: 'p44', icon: 'âŒš', name: 'Ø³Ø§Ø¹Ø© ÙŠØ¯', price: 250, type: 'premium', tier: 'regular' },
    { id: 'p45', icon: 'ğŸ‘œ', name: 'Ø­Ù‚ÙŠØ¨Ø© ÙŠØ¯', price: 300, type: 'premium', tier: 'regular' },

    // --- ğŸ“± ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ---
    { id: 'p46', icon: 'ğŸ“±', name: 'Ù…ÙˆØ¨Ø§ÙŠÙ„', price: 450, type: 'premium', tier: 'regular' },
    { id: 'p47', icon: 'ğŸ’»', name: 'Ù„Ø§Ø¨ØªÙˆØ¨', price: 499, type: 'premium', tier: 'regular' },
    { id: 'p48', icon: 'ğŸ“·', name: 'ÙƒØ§Ù…ÙŠØ±Ø§', price: 250, type: 'premium', tier: 'regular' },
    { id: 'p49', icon: 'ğŸ’¡', name: 'ÙÙƒØ±Ø© Ù†ÙŠØ±Ø©', price: 30, type: 'premium', tier: 'regular' },
    { id: 'p50', icon: 'ğŸ”‹', name: 'Ø·Ø§Ù‚Ø© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©', price: 40, type: 'premium', tier: 'regular' },

    // =============================================
    // Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ù‡Ø¯Ø§ÙŠØ§ ÙØ®Ù…Ø© (Luxury Tier)
    // (Ø£Ø³Ø¹Ø§Ø± 500 ÙƒÙˆÙŠÙ†Ø² ÙØ£ÙƒØ«Ø± - ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø³ÙˆØ¯ ÙˆØªØ§Ø¬)
    // =============================================

    // --- ğŸ’ Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª ÙˆØ«Ø±ÙˆØ© ---
    { id: 'p51', icon: 'ğŸ’', name: 'Ù…Ø§Ø³Ø© Ø²Ø±Ù‚Ø§Ø¡', price: 500, type: 'premium', tier: 'luxury' },
    { id: 'p52', icon: 'ğŸ’', name: 'Ø®Ø§ØªÙ… Ø£Ù„Ù…Ø§Ø³', price: 800, type: 'premium', tier: 'luxury' },
    { id: 'p53', icon: 'ğŸ‘‘', name: 'ØªØ§Ø¬ Ø§Ù„Ù…Ù„Ùƒ', price: 1000, type: 'premium', tier: 'luxury' },
    { id: 'p54', icon: 'ğŸ’°', name: 'ÙƒÙŠØ³ Ù†Ù‚ÙˆØ¯', price: 600, type: 'premium', tier: 'luxury' },
    { id: 'p55', icon: 'ğŸ’¸', name: 'Ø±Ø²Ù…Ø© Ø¯ÙˆÙ„Ø§Ø±Ø§Øª', price: 700, type: 'premium', tier: 'luxury' },
    { id: 'p56', icon: 'ğŸ†', name: 'ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù…', price: 900, type: 'premium', tier: 'luxury' },
    { id: 'p57', icon: 'âšœï¸', name: 'Ø´Ø¹Ø§Ø± Ù…Ù„ÙƒÙŠ', price: 550, type: 'premium', tier: 'luxury' },

    // --- ğŸï¸ Ù…Ø±ÙƒØ¨Ø§Øª ÙØ§Ø®Ø±Ø© ---
    { id: 'p58', icon: 'ğŸï¸', name: 'ÙÙŠØ±Ø§Ø±ÙŠ', price: 1200, type: 'premium', tier: 'luxury' },
    { id: 'p59', icon: 'ğŸï¸', name: 'Ù…ÙˆØªÙˆØ³ÙŠÙƒÙ„ Ø±ÙŠØ³', price: 800, type: 'premium', tier: 'luxury' },
    { id: 'p60', icon: 'ğŸš', name: 'Ù‡Ù„ÙŠÙƒÙˆØ¨ØªØ±', price: 2000, type: 'premium', tier: 'luxury' },
    { id: 'p61', icon: 'âœˆï¸', name: 'Ø·Ø§Ø¦Ø±Ø© Ø®Ø§ØµØ©', price: 3000, type: 'premium', tier: 'luxury' },
    { id: 'p62', icon: 'ğŸ›³ï¸', name: 'ÙŠØ®Øª ÙØ§Ø®Ø±', price: 4000, type: 'premium', tier: 'luxury' },
    { id: 'p63', icon: 'ğŸš€', name: 'ØµØ§Ø±ÙˆØ® ÙØ¶Ø§Ø¡', price: 5000, type: 'premium', tier: 'luxury' },
    { id: 'p64', icon: 'ğŸ›¸', name: 'Ø·Ø¨Ù‚ Ø·Ø§Ø¦Ø±', price: 5500, type: 'premium', tier: 'luxury' },

    // --- ğŸ¦ Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£Ø³Ø·ÙˆØ±ÙŠØ© ÙˆÙ…ÙØªØ±Ø³Ø© ---
    { id: 'p65', icon: 'ğŸ¦', name: 'Ø§Ù„Ø£Ø³Ø¯ Ø§Ù„Ù…Ù„Ùƒ', price: 1000, type: 'premium', tier: 'luxury' },
    { id: 'p66', icon: 'ğŸ¯', name: 'Ù†Ù…Ø± Ø´Ø±Ø³', price: 1000, type: 'premium', tier: 'luxury' },
    { id: 'p67', icon: 'ğŸ¦…', name: 'ØµÙ‚Ø± Ø¬Ø§Ø±Ø­', price: 900, type: 'premium', tier: 'luxury' },
    { id: 'p68', icon: 'ğŸ‰', name: 'ØªÙ†ÙŠÙ† Ø£Ø³Ø·ÙˆØ±ÙŠ', price: 2500, type: 'premium', tier: 'luxury' },
    { id: 'p69', icon: 'ğŸ¦–', name: 'Ø¯ÙŠÙ†Ø§ØµÙˆØ±', price: 1500, type: 'premium', tier: 'luxury' },
    { id: 'p70', icon: 'ğŸ¦„', name: 'ÙŠÙˆÙ†ÙŠÙƒÙˆØ±Ù† Ø°Ù‡Ø¨ÙŠ', price: 2000, type: 'premium', tier: 'luxury' },

    // --- ğŸ° Ø£Ù…Ù„Ø§Ùƒ ÙˆØ¹Ø¬Ø§Ø¦Ø¨ ---
    { id: 'p71', icon: 'ğŸ°', name: 'Ù‚ØµØ± Ù…Ù„ÙƒÙŠ', price: 5000, type: 'premium', tier: 'luxury' },
    { id: 'p72', icon: 'ğŸï¸', name: 'Ø¬Ø²ÙŠØ±Ø© Ø®Ø§ØµØ©', price: 7000, type: 'premium', tier: 'luxury' },
    { id: 'p73', icon: 'ğŸ¡', name: 'Ù…Ù„Ø§Ù‡ÙŠ ÙƒØ§Ù…Ù„Ø©', price: 3500, type: 'premium', tier: 'luxury' },
    { id: 'p74', icon: 'ğŸ—¼', name: 'Ø¨Ø±Ø¬ Ø¥ÙŠÙÙ„', price: 2500, type: 'premium', tier: 'luxury' },
    { id: 'p75', icon: 'ğŸ—½', name: 'ØªÙ…Ø«Ø§Ù„ Ø§Ù„Ø­Ø±ÙŠØ©', price: 2500, type: 'premium', tier: 'luxury' },
    { id: 'p76', icon: 'ğŸŒ‹', name: 'Ø¨Ø±ÙƒØ§Ù† Ø«Ø§Ø¦Ø±', price: 1500, type: 'premium', tier: 'luxury' },

    // --- ğŸŒŒ ÙØ¶Ø§Ø¡ ÙˆØ®ÙŠØ§Ù„ ---
    { id: 'p77', icon: 'ğŸŒ', name: 'ÙƒÙˆÙƒØ¨ Ø§Ù„Ø£Ø±Ø¶', price: 8000, type: 'premium', tier: 'luxury' },
    { id: 'p78', icon: 'ğŸŒ•', name: 'Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ÙƒØ§Ù…Ù„', price: 4000, type: 'premium', tier: 'luxury' },
    { id: 'p79', icon: 'â˜€ï¸', name: 'Ø§Ù„Ø´Ù…Ø³ Ø§Ù„Ù…Ø´Ø±Ù‚Ø©', price: 6000, type: 'premium', tier: 'luxury' },
    { id: 'p80', icon: 'ğŸŒŒ', name: 'Ù…Ø¬Ø±Ø© Ø¯Ø±Ø¨ Ø§Ù„ØªØ¨Ø§Ù†Ø©', price: 10000, type: 'premium', tier: 'luxury' }
];
// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù†Ø§Ù‚Øµ Ø¹Ù†Ø¯Ùƒ)
// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© (100+ Ù…Ù„ØµÙ‚ Ù…ØªÙ†ÙˆØ¹)
const freeStickers = [
    // --- ğŸ˜ƒ Ø§Ù„ÙˆØ¬ÙˆÙ‡ ÙˆØ§Ù„ØªØ¹Ø¨ÙŠØ±Ø§Øª ---
    'ğŸ˜‚', 'ğŸ¤£', 'ğŸ¥°', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ˜¡', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜³', 'ğŸ¤”',
    'ğŸ˜', 'ğŸ¥³', 'ğŸ¤©', 'ğŸ¥º', 'ğŸ˜¤', 'ğŸ¤¯', 'ğŸ¥¶', 'ğŸ¥µ', 'ğŸ˜´', 'ğŸ¤®',
    'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ¤¡', 'ğŸ’©',
    'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹',
    'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸµ',
    
    // --- â¤ï¸ Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„Ù‚Ù„ÙˆØ¨ ---
    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ–¤', 'ğŸ¤', 'ğŸ’”',
    'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’Œ',
    'ğŸ’', 'ğŸ’', 'ğŸ’', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ·', 'ğŸŒ¸', 'ğŸ’®', 'ğŸµï¸',

    // --- ğŸ‘‹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙŠØ¯ ---
    'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜',
    'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'âœ‹', 'ğŸ¤š',
    'ğŸ–', 'ğŸ––', 'ğŸ‘‹', 'ğŸ¤™', 'ğŸ’ª', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ¤',

    // --- ğŸ¦ Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·Ø¨ÙŠØ¹Ø© ---
    'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
    'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸ¦„', 'ğŸ', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ',
    
    // --- ğŸ” Ø£ÙƒÙ„ ÙˆØ´Ø±Ø¨ ---
    'ğŸ', 'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ',
    'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦',
    'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¿', 'ğŸ¥¤', 'ğŸ§‹',

    // --- ğŸ”¥ Ù…ØªÙ†ÙˆØ¹ ÙˆÙ…Ù…ÙŠØ² ---
    'ğŸ”¥', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ’¥', 'ğŸ’¢', 'ğŸ’¦', 'ğŸ’§', 'ğŸ’¤', 'ğŸ’¨',
    'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸ‚', 'ğŸ€', 'ğŸ', 'ğŸ•¯ï¸', 'ğŸ§¨', 'ğŸ§§', 'ğŸ'
];


// 2. ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²
function openGiftCenter() {
    if(navigator.vibrate) navigator.vibrate(10);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ±
    updateBalanceInCenter();
    renderPremiumGifts();
    renderFreeStickers();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = document.getElementById('giftCenterModal');
    if(modal) modal.classList.add('active');
}

function closeGiftCenter() {
    const modal = document.getElementById('giftCenterModal');
    if(modal) modal.classList.remove('active');
}

// 3. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (VIP / Ù…Ù„ØµÙ‚Ø§Øª)
// ==========================================
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© switchGiftTab Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¯ÙŠ ÙÙˆØ±Ø§Ù‹
// ==========================================
function switchGiftTab(type, btn) {
    if(navigator.vibrate) navigator.vibrate(10);
    document.querySelectorAll('.gift-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.gift-content-panel').forEach(p => p.classList.remove('active'));
    
    document.getElementById(`tab-${type}`).classList.add('active');

    // Ø§Ù„Ø±Ø³Ù… ÙŠØ­ØµÙ„ "ÙÙ‚Ø·" Ø¹Ù†Ø¯ Ù†Ø¯Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù€ Render
    if (type === 'premium') renderPremiumGifts();
    if (type === 'free') renderFreeStickers();
    if (type === 'gifs') renderGifsLibrary();
    if (type === 'favorites') renderFavorites();
}

// 4. Ø±Ø³Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
// 4. Ø±Ø³Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© - Grid System)
function renderPremiumGifts() {
    const grid = document.getElementById('premiumGrid');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒØ±Ø±Ø´
    if(!grid) return;
    grid.innerHTML = ''; 

    premiumGifts.forEach(gift => {
        const item = document.createElement('div');
        
        // ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„Ø§Ø³ Ø¥Ø¶Ø§ÙÙŠ Ù„Ùˆ Ø§Ù„Ù‡Ø¯ÙŠØ© ÙØ®Ù…Ø© (Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ø´ÙƒÙ„Ù‡Ø§ Ù…Ù…ÙŠØ²)
        const luxuryClass = gift.tier === 'luxury' ? 'luxury-item' : '';
        
        item.className = `gift-item ${luxuryClass}`;
        
        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
        item.onclick = () => {
            // ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            if(navigator.vibrate) navigator.vibrate(10);
            sendPremiumGift(gift);
        };

        // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ø±Øª
        item.innerHTML = `
            <div class="gift-emoji">${gift.icon}</div>
            <div class="gift-name">${gift.name}</div>
            <div class="gift-price">
                ${gift.price} <i class="fa-solid fa-coins" style="font-size:8px;"></i>
            </div>
        `;
        
        grid.appendChild(item);
    });
}

function renderFreeStickers() {
    const grid = document.getElementById('stickersGrid');
    if(!grid || grid.children.length > 0) return;

    freeStickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.style.cssText = "font-size: 35px; text-align: center; cursor: pointer; padding: 10px;";
        item.innerText = sticker;
        
        // 1. Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        item.onclick = () => sendFreeSticker(sticker);

        // ğŸ”¥ 2. Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø© (Ø­ÙØ¸) ğŸ”¥
        addLongPressEvent(item, () => saveToFavorites(sticker, 'sticker'));

        grid.appendChild(item);
    });
}


// 5. Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© Ù…Ø¯ÙÙˆØ¹Ø© (Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯)
async function sendPremiumGift(gift) {
    if (!currentUserId || !chatId) return;

    const userRef = db.collection('users').doc(currentUserId);
    try {
        await db.runTransaction(async (t) => {
            const doc = await t.get(userRef);
            const balance = doc.data().coins || 0;
            if (balance < gift.price) throw "no_funds";
            t.update(userRef, { coins: balance - gift.price });
        });

        // Ù†Ø¬Ø­ Ø§Ù„Ø®ØµÙ… -> Ø¥Ø±Ø³Ø§Ù„
        sendGiftMessage(gift, 'gift'); 
        playUiSound('sent');
        showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${gift.name} Ø¨Ù†Ø¬Ø§Ø­`);
        closeGiftCenter();
        updateBalanceInCenter();

    } catch (e) {
        if (e === "no_funds") {
            if(confirm("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ! Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø´Ø­Ù†ØŸ")) openRechargeModal();
        }
    }
}

// 6. Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„ØµÙ‚ Ù…Ø¬Ø§Ù†ÙŠ
function sendFreeSticker(sticker) {
    const giftObj = {
        icon: sticker,
        name: 'Ù…Ù„ØµÙ‚',
        price: 'Ù…Ø¬Ø§Ù†ÙŠ'
    };
    sendGiftMessage(giftObj, 'sticker');
    closeGiftCenter();
}

// 7. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
async function sendGiftMessage(giftData, type) {
    const msgPayload = {
        type: type, 
        giftIcon: giftData.icon,
        giftName: giftData.name,
        giftPrice: giftData.price,
        // ğŸ”¥ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø­ÙØ¸ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‡Ø¯ÙŠØ© (regular/luxury)
        giftTier: giftData.tier || 'regular', 
        
        uid: currentUserId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false,
        text: type === 'gift' ? `Ø£Ø±Ø³Ù„ ${giftData.name} ğŸ` : giftData.icon,
        isGhost: typeof isGhostMode !== 'undefined' ? isGhostMode : false
    };

    await db.collection("chats").doc(chatId).collection("messages").add(msgPayload);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    if(cachedOtherUserId && !msgPayload.isGhost) {
        await db.collection("chats").doc(chatId).set({ 
            lastMessage: type === 'gift' ? `ğŸ ${giftData.name}` : `Ù…Ù„ØµÙ‚ ${giftData.icon}`,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            sentTo: cachedOtherUserId,
            senderId: currentUserId,
            seen: false,
            unreadCount: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });
    }
}

// 8. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø´Ø­Ù†
function updateBalanceInCenter() {
    db.collection('users').doc(currentUserId).onSnapshot(doc => {
        if(doc.exists) {
            const el = document.getElementById('centerCoinsDisplay');
            if(el) el.innerText = doc.data().coins || 0;
        }
    });
}

function openRechargeModal() {
    closeGiftCenter();
    document.getElementById('rechargeModal').style.display = 'flex';
}

function processRecharge(amount, price) {
    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø´Ø­Ù† (ÙŠØ¶Ø§Ù Ø§Ù„Ø±ØµÙŠØ¯ ÙÙˆØ±Ø§Ù‹)
    db.collection('users').doc(currentUserId).update({
        coins: firebase.firestore.FieldValue.increment(amount)
    }).then(() => {
        showToast(`ØªÙ… Ø´Ø­Ù† ${amount} Ø¹Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ’°`);
        document.getElementById('rechargeModal').style.display = 'none';
        openGiftCenter(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
    });
}
// ØµÙˆØª ÙØªØ­ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„Ø³Ø­Ø±ÙŠ
const giftOpenSound = new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg"); 

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø¯ÙŠØ© (ÙØªØ­/ØºÙ„Ù‚)
function toggleMagicGift(element) {
    
    // 1. Ù„Ùˆ Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ -> Ø§Ù‚ÙÙ„Ù‡Ø§
    if (element.classList.contains('opened')) {
        element.classList.remove('opened');
        
        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØµÙˆØª Ù‚ÙÙ„Ø© Ø®ÙÙŠÙØ©
        // const closeSound = new Audio("path_to_close_sound.mp3");
        // closeSound.play();
        
        return; 
    }

    // 2. Ù„Ùˆ Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…Ù‚ÙÙˆÙ„Ø© -> Ø§ÙØªØ­Ù‡Ø§
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙØªØ­ Ø§Ù„Ø³Ø­Ø±ÙŠ
    const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg");
    audio.play().catch(()=>{});

    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„ÙØªØ­
    element.classList.add('opened');
    
    // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ "ØªÙ… Ø§Ù„ÙØªØ­ Ø³Ø§Ø¨Ù‚Ø§Ù‹" (Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ØªØªÙ‚ÙÙ„ ØªØ§Ù†ÙŠ ÙŠØ¨Ø§Ù† Ø¹Ù„ÙŠÙ‡Ø§)
    element.classList.add('has-been-opened');

    // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆÙ†ÙÙŠØªÙŠ ÙÙ‚Ø· Ù„Ùˆ Ø¯ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØªÙØªØ­ (Ø¹Ø´Ø§Ù† Ù…ØªØ¨Ù‚Ø§Ø´ Ø¯ÙˆØ´Ø© ÙƒÙ„ Ù…Ø±Ø©)
    // Ø£Ùˆ Ø´ÙŠÙ„ Ø§Ù„Ø´Ø±Ø· Ù„Ùˆ Ø¹Ø§ÙŠØ²Ù‡Ø§ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
    if (!element.getAttribute('data-opened-once')) {
        if(typeof launchConfetti === 'function') launchConfetti(element);
        element.setAttribute('data-opened-once', 'true');
    }
}

// Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¹Ù…Ù„ ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒÙˆÙ†ÙÙŠØªÙŠ (Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© Ø«Ù‚ÙŠÙ„Ø©)
function launchConfetti(element) {
    const colors = ['#FFD700', '#ff4081', '#00e5ff', '#ffffff'];
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'fixed';
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.width = Math.random() * 8 + 4 + 'px';
        particle.style.height = Math.random() * 8 + 4 + 'px';
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = '50%';
        particle.style.pointerEvents = 'none';
        particle.style.zIndex = '9999';
        document.body.appendChild(particle);

        // Ø­Ø±ÙƒØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        const destX = (Math.random() - 0.5) * 300;
        const destY = (Math.random() - 1) * 300;
        const rotation = Math.random() * 360;

        const animation = particle.animate([
            { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
            { transform: `translate(${destX}px, ${destY}px) rotate(${rotation}deg)`, opacity: 0 }
        ], {
            duration: 1000 + Math.random() * 1000,
            easing: 'cubic-bezier(0, .9, .57, 1)'
        });

        animation.onfinish = () => particle.remove();
    }
}
// ================= Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø¶Ø®Ù…Ø© (100+) =================
const emojisCollection = {
    "Ø§Ù„ÙˆØ¬Ù‡ ÙˆØ§Ù„ØªØ¹Ø¨ÙŠØ±Ø§Øª": [
        "ğŸ˜‚", "ğŸ¤”", "ğŸ™ƒ", "ğŸ˜¢", "ğŸ¤—", "ğŸ˜…", "ğŸ˜²", "ğŸ˜­", "ğŸ˜", "ğŸ¥°", 
        "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", "ğŸ˜‹", "ğŸ˜›", "ğŸ˜", "ğŸ˜œ", "ğŸ¤ª", "ğŸ¤¨", 
        "ğŸ§", "ğŸ¤“", "ğŸ˜", "ğŸ¥¸", "ğŸ¤©", "ğŸ¥³", "ğŸ˜", "ğŸ˜’", "ğŸ˜", "ğŸ˜”", 
        "ğŸ˜Ÿ", "ğŸ˜•", "ğŸ™", "â˜¹ï¸", "ğŸ˜£", "ğŸ˜–", "ğŸ˜«", "ğŸ˜©", "ğŸ¥º", "ğŸ˜¤", 
        "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", "ğŸ¤¯", "ğŸ˜³", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜±", "ğŸ˜¨", "ğŸ˜°", 
        "ğŸ˜¥", "ğŸ˜“", "ğŸ¤«", "ğŸ¤¥", "ğŸ˜¶", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¬", "ğŸ™„", "ğŸ˜¯", 
        "ğŸ˜¦", "ğŸ˜§", "ğŸ˜®", "ğŸ¥±", "ğŸ˜´", "ğŸ¤¤", "ğŸ˜ª", "ğŸ˜µ", "ğŸ¤", "ğŸ¥´"
    ],
    "Ø§Ù„Ù‚Ù„ÙˆØ¨ ÙˆØ§Ù„Ø­Ø¨": [
        "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ¤", "ğŸ–¤", "ğŸ¤", "ğŸ’”", 
        "â£ï¸", "ğŸ’•", "ğŸ’", "ğŸ’“", "ğŸ’—", "ğŸ’–", "ğŸ’˜", "ğŸ’", "ğŸ’Ÿ", "ğŸ’Œ"
    ],
    "Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙŠØ¯": [
        "ğŸ‘‹", "ğŸ¤š", "ğŸ–", "âœ‹", "ğŸ––", "ğŸ‘Œ", "ğŸ¤Œ", "ğŸ¤", "âœŒï¸", "ğŸ¤", 
        "ğŸ¤Ÿ", "ğŸ¤˜", "ğŸ¤™", "ğŸ‘ˆ", "ğŸ‘‰", "ğŸ‘†", "ğŸ–•", "ğŸ‘‡", "â˜ï¸", "ğŸ‘", 
        "ğŸ‘", "âœŠ", "ğŸ‘Š", "ğŸ¤›", "ğŸ¤œ", "ğŸ‘", "ğŸ™Œ", "ğŸ‘", "ğŸ¤²", "ğŸ¤"
    ],
    "Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª": [
        "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ»â€â„ï¸", "ğŸ¨", 
        "ğŸ¯", "ğŸ¦", "cow", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ™ˆ", "ğŸ™‰", "ğŸ™Š", "ğŸ¦…"
    ]
};

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function toggleInternalEmojiPicker() {
    const picker = document.getElementById('emojiPickerPanel');
    const content = document.getElementById('emojiGridContent');
    
    // Ù„Ùˆ Ù„Ø³Ù‡ ÙØ§Ø¶ÙŠØ©ØŒ Ù†Ù…Ù„Ø§Ù‡Ø§
    if (content.innerHTML === '') {
        renderEmojiList();
    }

    if (picker.style.display === 'flex') {
        picker.style.display = 'none';
    } else {
        picker.style.display = 'flex';
    }
}

// 2. Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function renderEmojiList() {
    const content = document.getElementById('emojiGridContent');
    let html = '';

    for (const [category, emojis] of Object.entries(emojisCollection)) {
        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…
        html += `<div class="emoji-category-title">${category}</div>`;
        
        // Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª
        emojis.forEach(emoji => {
            html += `<div class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</div>`;
        });
    }
    content.innerHTML = html;
}

// 3. Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ø§Ù„Ù†Øµ
function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø¤Ø´Ø±
    const startPos = input.selectionStart;
    const endPos = input.selectionEnd;
    
    const text = input.value;
    const newText = text.substring(0, startPos) + emoji + text.substring(endPos);
    
    input.value = newText;
    
    // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    input.selectionStart = startPos + emoji.length;
    input.selectionEnd = startPos + emoji.length;
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ù„Ø·ÙˆÙ„...)
    input.focus();
    if(typeof autoResize === 'function') autoResize(input);
    if(typeof toggleSendButton === 'function') toggleSendButton();
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPickerPanel');
    const trigger = document.querySelector('.internal-emoji-btn');
    
    if (picker.style.display === 'flex' && !picker.contains(e.target) && !trigger.contains(e.target)) {
        picker.style.display = 'none';
    }
});
// ==========================================
// 1. Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù€ GIFs (Ù…ÙƒØªØ¨Ø© Ø¶Ø®Ù…Ø© ÙˆØ´Ø§Ù…Ù„Ø© - Giphy)
// ==========================================
const professionalGifs = [
    // â¤ï¸ Ø­Ø¨ ÙˆØ±ÙˆÙ…Ø§Ù†Ø³ÙŠØ© (Love & Romance)
    "https://media.giphy.com/media/26BRv0ThflsHCqDrG/giphy.gif",
    "https://media.giphy.com/media/LpDmM2wSt6kTm/giphy.gif",
    "https://media.giphy.com/media/l4pTfx2qLszoacZRS/giphy.gif",
    "https://media.giphy.com/media/3o7TKoWXm3zgQlDakJ/giphy.gif",
    "https://media.giphy.com/media/26FLdmIp6wJr91JAI/giphy.gif",
    "https://media.giphy.com/media/c76IJLp03kZEU/giphy.gif",
    "https://media.giphy.com/media/R6gZ79A7Wk1uef8H8e/giphy.gif",
    "https://media.giphy.com/media/l0K4kWJir91VEoa1a/giphy.gif",
    "https://media.giphy.com/media/MeIucAjPKoA120R7sN/giphy.gif",
    "https://media.giphy.com/media/hqgD6bocRHhE99XOBW/giphy.gif",
    "https://media.giphy.com/media/26AHqZlmnh4GTt8wo/giphy.gif",
    "https://media.giphy.com/media/l0HlPystfePnDD3Gg/giphy.gif",
    "https://media.giphy.com/media/xyM6G45HddxEQ/giphy.gif",
    "https://media.giphy.com/media/l4pTfx2qLszoacZRS/giphy.gif",
    "https://media.giphy.com/media/3CCXHZWV6F6O9VQ7FL/giphy.gif",
    "https://media.giphy.com/media/l0K4kWJir91VEoa1a/giphy.gif",
    "https://media.giphy.com/media/26ufcYAkp8e66vanu/giphy.gif",
    "https://media.giphy.com/media/G6gatpMSrXGjS/giphy.gif",
    "https://media.giphy.com/media/5u8rnKknCW70Q/giphy.gif",
    "https://media.giphy.com/media/xT0BKiK5sOCUq0u9k4/giphy.gif",

    // ğŸ˜‚ Ø¶Ø­Ùƒ ÙˆÙ…Ø±Ø­ (Funny & Laugh)
    "https://media.giphy.com/media/10yXFkBJ0MwGQ0/giphy.gif",
    "https://media.giphy.com/media/9t6xpYz9ohJCE/giphy.gif",
    "https://media.giphy.com/media/ZqlvCTNHpqrio/giphy.gif",
    "https://media.giphy.com/media/lszAB3TzFtRaU/giphy.gif",
    "https://media.giphy.com/media/J336VCs1JC42zGRhjH/giphy.gif",
    "https://media.giphy.com/media/ltIFdjNAasOwVvKhvx/giphy.gif",
    "https://media.giphy.com/media/3oEjHI8WJv4x6UPDB6/giphy.gif",
    "https://media.giphy.com/media/fUYhyT9IjftxrxJXcE/giphy.gif",
    "https://media.giphy.com/media/xUA7aM09ByyR1w5YWc/giphy.gif",
    "https://media.giphy.com/media/CoDp6NnSmItoY/giphy.gif",
    "https://media.giphy.com/media/sw7KSBKL3yme4/giphy.gif",
    "https://media.giphy.com/media/10JhviFuU2gWD6/giphy.gif",
    "https://media.giphy.com/media/QTAVEex4ANH1pVOFAK/giphy.gif",
    "https://media.giphy.com/media/wW95fEq09hOI8/giphy.gif",
    "https://media.giphy.com/media/3o6ozvv0zsJskzOCbu/giphy.gif",
    "https://media.giphy.com/media/mcJohbfGPATW8/giphy.gif",
    "https://media.giphy.com/media/xT9DPBMumjWp0dXK9O/giphy.gif",
    "https://media.giphy.com/media/l3fQf1OEAq0iri9RC/giphy.gif",
    "https://media.giphy.com/media/13HgwGsXF0aiGY/giphy.gif",
    "https://media.giphy.com/media/26n6Gx9moCgs1pUuk/giphy.gif",

    // ğŸ˜ Ø£ÙƒØ´Ù† ÙˆØ±Ø¯ÙˆØ¯ Ø£ÙØ¹Ø§Ù„ (Reactions & Cool)
    "https://media.giphy.com/media/111ebonMs90YLu/giphy.gif",
    "https://media.giphy.com/media/l0HlHFRbmaZtBRhXG/giphy.gif",
    "https://media.giphy.com/media/xT5LMHxhOfscxPfIfm/giphy.gif",
    "https://media.giphy.com/media/3o7abKhOpu0NwenH3O/giphy.gif",
    "https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif",
    "https://media.giphy.com/media/26ueYUlPAmSMMGnLIr/giphy.gif",
    "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",
    "https://media.giphy.com/media/3o7qDEq2bMbcbPRQ2c/giphy.gif",
    "https://media.giphy.com/media/3o6Zt6KHxJTbXCnSvu/giphy.gif",
    "https://media.giphy.com/media/l41lI4bYmcsPJX9Go/giphy.gif",
    "https://media.giphy.com/media/n4oKYFlAcv2AU/giphy.gif",
    "https://media.giphy.com/media/SggILpMXO7Xt6/giphy.gif",
    "https://media.giphy.com/media/QhhuZdt6eSeESwbszo/giphy.gif",
    "https://media.giphy.com/media/3o7btUg31OCi0NXdkY/giphy.gif",
    "https://media.giphy.com/media/pFwRzOLfuGHok/giphy.gif",
    "https://media.giphy.com/media/12XMGIWtrHBl5e/giphy.gif",
    "https://media.giphy.com/media/xT0xezQGU5xSCivlJE/giphy.gif",
    "https://media.giphy.com/media/l2R0eYcNq9rJUsVAA/giphy.gif",

    // ğŸ± Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆÙƒÙŠÙˆØª (Cute & Animals)
    "https://media.giphy.com/media/BzyTuYCmvSORqs1ABM/giphy.gif",
    "https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif",
    "https://media.giphy.com/media/vFKqnCdLPNOKc/giphy.gif",
    "https://media.giphy.com/media/13CoXDiaCcCoyk/giphy.gif",
    "https://media.giphy.com/media/l0HlP2ms0eUc5nlHg6/giphy.gif",
    "https://media.giphy.com/media/3oEdv5jk7miq98Jv0c/giphy.gif",
    "https://media.giphy.com/media/xT0xeuOy2Fcl9kvDxi/giphy.gif",
    "https://media.giphy.com/media/l1J9sBCbyZsCnTDEs/giphy.gif",
    "https://media.giphy.com/media/CjmvTCZf2U3p09Cn0h/giphy.gif",
    "https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif",
    "https://media.giphy.com/media/13CoXDiaCcCoyk/giphy.gif",
    "https://media.giphy.com/media/rdma0nDFZMR32/giphy.gif",
    "https://media.giphy.com/media/cfuL5gqFDreBbcNBC/giphy.gif",
    "https://media.giphy.com/media/xTiTnMhJTwNHChdTZS/giphy.gif",

    // ğŸ˜¢ Ø­Ø²Ù† ÙˆØ¨ÙƒØ§Ø¡ (Sad & Crying)
    "https://media.giphy.com/media/7SF5scGB12hRu/giphy.gif",
    "https://media.giphy.com/media/d2lcHJy5yqgXHq/giphy.gif",
    "https://media.giphy.com/media/OPU6wzx8JZrEzgathJ/giphy.gif",
    "https://media.giphy.com/media/ylV2FYEIkGTW/giphy.gif",
    "https://media.giphy.com/media/mv7FcziOrIp6o/giphy.gif",
    "https://media.giphy.com/media/BEob5qwFkNC7qlilql/giphy.gif",
    "https://media.giphy.com/media/L95W4wv8nnb9K/giphy.gif",
    "https://media.giphy.com/media/26ufcVAp3AiJJsrmw/giphy.gif",
    "https://media.giphy.com/media/l3vR4CdLInXOhr3rO/giphy.gif",
    "https://media.giphy.com/media/3o6wrvdHFbwBrUFNU4/giphy.gif",

    // ğŸ˜¡ ØºØ¶Ø¨ (Angry)
    "https://media.giphy.com/media/11tTNkJyBvTvAw/giphy.gif",
    "https://media.giphy.com/media/l1J9u3TZfpmeDL5OY/giphy.gif",
    "https://media.giphy.com/media/3o9mjQG9Ch6L333pfi/giphy.gif",
    "https://media.giphy.com/media/112o4nufJ2Nbtm/giphy.gif",
    "https://media.giphy.com/media/ntjBjvfnakKJ2/giphy.gif",
    "https://media.giphy.com/media/l1J9sBCbyZsCnTDEs/giphy.gif",
    "https://media.giphy.com/media/3o7TKKxPt2OlqoSX72/giphy.gif",
    "https://media.giphy.com/media/26gN0tFg70wAljK4o/giphy.gif",
    "https://media.giphy.com/media/l0HlCqV35hdEg2LS0/giphy.gif",

    // ğŸ‰ Ø§Ø­ØªÙØ§Ù„Ø§Øª (Celebration & Party)
    "https://media.giphy.com/media/3oz8xAFtqoOUUrsh7W/giphy.gif",
    "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",
    "https://media.giphy.com/media/kyLYXonQWBpwzY8qZ3/giphy.gif",
    "https://media.giphy.com/media/g9582DNuQppxC/giphy.gif",
    "https://media.giphy.com/media/Is1O1TWV0LEJi/giphy.gif",
    "https://media.giphy.com/media/26tOZ42Mg6pbTUPfi/giphy.gif",
    "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",
    "https://media.giphy.com/media/3o7TKGYvN3mC1W0jWE/giphy.gif",
    "https://media.giphy.com/media/l2JhL1AzTxORUTDlC/giphy.gif",
    "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",

    // ğŸ‘‹ ØªØ­ÙŠØ© ÙˆÙˆØ¯Ø§Ø¹ (Hello & Bye)
    "https://media.giphy.com/media/dzaUX7CAG0Ihi/giphy.gif",
    "https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif",
    "https://media.giphy.com/media/4XPKVGB5X066k/giphy.gif",
    "https://media.giphy.com/media/QcZskILcFH95e/giphy.gif",
    "https://media.giphy.com/media/xT9IgzoKnwFNmISR8I/giphy.gif",
    "https://media.giphy.com/media/l0FF56cexcW2JAXCJj/giphy.gif",
    "https://media.giphy.com/media/3o7TKSjRrfPHjKt2eI/giphy.gif",
    "https://media.giphy.com/media/26BkNDXc5J7Z7WkCc/giphy.gif",
    "https://media.giphy.com/media/l0HlMSVVw9zqmClLq/giphy.gif",

    // ğŸŒ¸ ØµØ¨Ø§Ø­ ÙˆÙ…Ø³Ø§Ø¡ (Good Morning & Night)
    "https://media.giphy.com/media/1311f7YK2wcOCA/giphy.gif",
    "https://media.giphy.com/media/3o6fJ5LANL0x31R1Ic/giphy.gif",
    "https://media.giphy.com/media/l2JHRhAtnJSDNJ2py/giphy.gif",
    "https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif",
    "https://media.giphy.com/media/l0HlP7s5Y3b5Jq7Ha/giphy.gif",
    "https://media.giphy.com/media/3o6fJ5LANL0x31R1Ic/giphy.gif",
    "https://media.giphy.com/media/l0HlO4qj4qj4qj4qj/giphy.gif",

    // âš½ Ø±ÙŠØ§Ø¶Ø© (Sports & Fitness)
    "https://media.giphy.com/media/3o7qD5SaR5K3Qk/giphy.gif", // Football
    "https://media.giphy.com/media/xT9IgMw9fakG6f/giphy.gif", // Basketball
    "https://media.giphy.com/media/l0HlP7s5Y3b5Jq7Ha/giphy.gif", // Gym
    "https://media.giphy.com/media/3o7TKSjRrfPHjKt2eI/giphy.gif", // Running
    "https://media.giphy.com/media/l0HlO4qj4qj4qj4qj/giphy.gif", // Swimming
    "https://media.giphy.com/media/3o7qD5SaR5K3Qk/giphy.gif", // Goal

    // ğŸ® Ø£Ù„Ø¹Ø§Ø¨ (Gaming)
    "https://media.giphy.com/media/3o7qD5SaR5K3Qk/giphy.gif", // Mario
    "https://media.giphy.com/media/xT9IgMw9fakG6f/giphy.gif", // Fortnite dance
    "https://media.giphy.com/media/l0HlP7s5Y3b5Jq7Ha/giphy.gif", // Minecraft
    "https://media.giphy.com/media/3o7TKSjRrfPHjKt2eI/giphy.gif", // GTA
    "https://media.giphy.com/media/l0HlO4qj4qj4qj4qj/giphy.gif", // Pubg

    // ğŸ’» Ø¨Ø±Ù…Ø¬Ø© ÙˆØ¹Ù…Ù„ (Work & Coding)
    "https://media.giphy.com/media/13HgwGsXF0aiGY/giphy.gif", // Typing fast
    "https://media.giphy.com/media/hrBMWkjoXjK36/giphy.gif", // Matrix
    "https://media.giphy.com/media/unQ3IJU2RG7XM/giphy.gif", // Hacker
    "https://media.giphy.com/media/XiDy8eZLTRCbC/giphy.gif", // Stress
    "https://media.giphy.com/media/KmTnUKop0AfFm/giphy.gif", // Coffee code

    // ğŸ” Ø·Ø¹Ø§Ù… (Food)
    "https://media.giphy.com/media/11sBLVxNs7v6WA/giphy.gif",
    "https://media.giphy.com/media/HMHVkY27X3q7u/giphy.gif",
    "https://media.giphy.com/media/3o7TKrEzvJbsQNp9kg/giphy.gif",
    "https://media.giphy.com/media/l2JHRhAtnJSDNJ2py/giphy.gif",
    "https://media.giphy.com/media/26u4lOMA8JKSnL9Uk/giphy.gif",
    "https://media.giphy.com/media/l0HlP7s5Y3b5Jq7Ha/giphy.gif",

    // ğŸš€ ØªØ­ÙÙŠØ² (Motivation)
    "https://media.giphy.com/media/3o7TKSjRrfPHjKt2eI/giphy.gif",
    "https://media.giphy.com/media/l0HlO4qj4qj4qj4qj/giphy.gif",
    "https://media.giphy.com/media/3o7qD5SaR5K3Qk/giphy.gif",
    "https://media.giphy.com/media/xT9IgMw9fakG6f/giphy.gif"
];
// ==========================================
// 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©)
// ==========================================
// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…Ø±ÙƒØ² Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…Ø·ÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø­Ù…ÙŠØ© Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù
// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…Ø±ÙƒØ² Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ø§Ù„Ù…ØµØ­Ø­Ø©)
function openGiftCenter() {
    const modal = document.getElementById('giftCenterModal');
    if(!modal) return;
    if(navigator.vibrate) navigator.vibrate(10);

    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('active');
        // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±Ø³Ù… ÙƒÙ„ Ø´ÙŠØ¡ØŒ Ù†Ø±Ø³Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙ‚Ø· (Ø§Ù„Ù…Ù…ÙŠØ²Ø©)
        renderPremiumGifts(); 
        updateBalanceInCenter();
    }, 100);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù…Ø±ÙƒØ² Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„ÙÙƒ ØªØ¬Ù…Ø¯ Ø§Ù„Ø´Ø§Ø´Ø©)
function closeGiftCenter() {
    const modal = document.getElementById('giftCenterModal');
    if(!modal) return;

    // 1. Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„Ù†Ø´Ø§Ø· (Ù‡ÙŠÙ†Ø²Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Øª ÙˆÙŠØ´ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ±)
    modal.classList.remove('active');

    // 2. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø«Ù… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹
    setTimeout(() => {
        modal.style.display = 'none'; // Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªÙÙƒ "ØªØ¬Ù…Ø¯ Ø§Ù„Ø´Ø§Ø´Ø©"
    }, 400); // 400ms Ù‡ÙŠ Ù†ÙØ³ Ù…Ø¯Ø© Ø§Ù„Ù€ transition ÙÙŠ Ø§Ù„Ù€ CSS
}

// ==========================================
// 3. Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù€ GIFs ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©
// ==========================================
function renderGifsLibrary() {
    const grid = document.getElementById('gifsGrid');
    if(!grid) return;
    
    // ğŸ”¥ ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø´Ø§Ù† ÙŠÙ†Ø¸Ù Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    if(grid.innerHTML.includes('fa-spin') || grid.children.length === 0) {
        grid.innerHTML = ''; 
    } else {
        // Ù„Ùˆ Ù…Ù„ÙŠØ§Ù†Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ù„ØµÙˆØ± Ø§Ù„Ø«Ø§Ø¨ØªØ©ØŒ Ø§Ø®Ø±Ø¬ (Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±)
        if(grid.children.length > 0 && !document.getElementById('gifSearchInput').value) return;
        grid.innerHTML = ''; // Ù„Ùˆ Ù…Ø´ Ù…ØªØ£ÙƒØ¯ÙŠÙ†ØŒ Ù†Ø¸Ù ÙˆØ§Ø±Ø³Ù… Ù…Ù† Ø¬Ø¯ÙŠØ¯
    }

    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªØ§Ø¹Ùƒ (superHugeList.forEach...)
    const superHugeList = professionalGifs.concat(professionalGifs); 
    superHugeList.forEach(gifUrl => {
        // ... Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const item = document.createElement('div');
        item.className = 'gift-item gif-card'; 
        item.onclick = () => {
            if(navigator.vibrate) navigator.vibrate(10);
            sendGifAsMessage(gifUrl);
        };
        item.innerHTML = `<img src="${gifUrl}" class="gif-grid-item" loading="lazy">`;
        grid.appendChild(item);
    });
}

// ==========================================
// 4. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ GIF
// ==========================================
function sendGifAsMessage(url) {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    closeGiftCenter();
    
    // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙˆØ±Ø§Ù‹ (Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØµÙˆØª)
    playUiSound('sent');

    // 3. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.collection("chats").doc(chatId).collection("messages").add({
        text: url,
        uid: currentUserId,
        type: 'image', // Ø¨Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ø§Ù‡Ø§ ÙƒØµÙˆØ±Ø© Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙƒØ¨ÙŠØ±Ø©
        seen: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        isGhost: typeof isGhostMode !== 'undefined' ? isGhostMode : false
    }).then(() => {
        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ GIF âœ…");
    }).catch((e) => {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âŒ");
    });
}

// ==========================================
// 4. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø±ÙƒØ² (Ø¹Ø´Ø§Ù† ØªØ­Ù…Ù„ Ø§Ù„Ù€ GIFs)
// ==========================================
// Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ù„Ø© openGiftCenter Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ ÙˆØ²ÙˆØ¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡:
const originalOpenGiftCenter = openGiftCenter; 
openGiftCenter = function() {
    originalOpenGiftCenter(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    renderGifsLibrary(); // ØªØ´ØºÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù€ GIFs Ø§Ù„Ø¬Ø¯ÙŠØ¯
}

// ================= 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª (Inline) =================
function toggleInlinePlay(vidId, event) {
    // 1. Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ (Ø£Ù‡Ù… Ø³Ø·Ø±)
    if(event) {
        event.stopPropagation();
        event.preventDefault();
    }

    const video = document.getElementById(vidId);
    const wrapper = video.closest('.video-msg-wrapper');
    const overlay = wrapper.querySelector('.video-overlay');
    const blurBg = wrapper.querySelector('.video-bg-blur');
    const btnIcon = wrapper.querySelector('.center-play-btn i');

    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø±
    document.querySelectorAll('video').forEach(v => {
        if(v.id !== vidId && !v.paused && v.classList.contains('video-main-content')) {
            // Ù†Ø±Ø¬Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªØ§Ù†ÙŠØ© Ù„Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
            v.pause();
            const w = v.closest('.video-msg-wrapper');
            if(w) {
                w.querySelector('.video-overlay').style.opacity = '1';
                w.querySelector('.center-play-btn i').className = "fa-solid fa-play";
            }
        }
    });

    if (video.paused) {
        // ØªØ´ØºÙŠÙ„
        video.play();
        btnIcon.className = "fa-solid fa-pause";
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© Ù„Ù„ØªØ±ÙƒÙŠØ²
        overlay.style.opacity = '0';
        blurBg.style.opacity = '0'; 
        
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³/Ø§Ù„Ù…Ø§ÙˆØ³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        wrapper.onmouseenter = () => overlay.style.opacity = '1';
        wrapper.onmouseleave = () => overlay.style.opacity = '0';

    } else {
        // Ø¥ÙŠÙ‚Ø§Ù
        video.pause();
        btnIcon.className = "fa-solid fa-play";
        overlay.style.opacity = '1';
        blurBg.style.opacity = '1'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    }
}

// ================= Ù…Ù†Ø·Ù‚ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Pro Player) - Ù†Ø³Ø®Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª =================

// 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
var proVideoElement = null;
var proUpdateInterval = null;
var isProDragging = false;

// Ø¯Ø§Ù„Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
// ================= Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =================

// 1. Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© (ØªØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ±)
function initProPlayerElements() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    let video = document.getElementById('proMainVideo');
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ø£Ù†Ù‡ Ø±Ø¨Ù…Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯)ØŒ Ù„Ø§ Ù†Ø¹ÙŠØ¯ null Ø¨Ù„ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    if (!video) {
        console.warn("Element #proMainVideo not found initially.");
        return null;
    }
    return video;
}

// 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©)
window.openProPlayer = function(src) {
    const modal = document.getElementById('proVideoModal');
    const video = document.getElementById('proMainVideo');

    if (!modal || !video) {
        console.error("Ø§Ù„Ù…Ø´ØºÙ„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ HTML");
        return;
    }

    // 1. Ù†Ù‚Ù„ Ø§Ù„Ù…Ø´ØºÙ„ Ù„Ø¢Ø®Ø± Ø§Ù„Ù€ body Ø¹Ø´Ø§Ù† Ù…ÙŠØªØºØ·Ø§Ø´ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
    document.body.appendChild(modal);

    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´ØºÙ„ ÙÙˆØ±Ø§Ù‹
    modal.style.cssText = "display: flex !important; opacity: 1 !important; visibility: visible !important; z-index: 9999999;";

    // 3. Ø´Ø­Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªØ´ØºÙŠÙ„Ù‡
    video.src = src;
    video.load();
    video.play().then(() => {
        if(typeof updateProPlayIcon === 'function') updateProPlayIcon(true);
    }).catch(err => console.log("Autoplay blocked:", err));

    // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    if(typeof startProProgressLoop === 'function') startProProgressLoop();
};

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„)
window.closeProPlayer = function() {
    const modal = document.getElementById('proVideoModal');
    const video = document.getElementById('proMainVideo');
    
    if (video) {
        video.pause();
        video.currentTime = 0;
        video.src = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØµØ¯Ø± Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    }
    
    if (modal) {
        modal.style.display = 'none';
    }
    
    if (proUpdateInterval) clearInterval(proUpdateInterval);
};


function updateProPlayIcon(isPlaying) {
    const icon = document.querySelector('#proPlayBtn i');
    if (icon) icon.className = isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
}

// 5. Ø­Ù„Ù‚Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· ÙˆØ§Ù„ÙˆÙ‚Øª
function startProProgressLoop() {
    if (proUpdateInterval) clearInterval(proUpdateInterval);
    
    proUpdateInterval = setInterval(() => {
        const video = initProPlayerElements();
        // Ù„Ùˆ Ù…ÙÙŠØ´ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ³Ø­Ø¨ Ø§Ù„Ø´Ø±ÙŠØ· -> Ù…ØªØ¹Ù…Ù„Ø´ Ø­Ø§Ø¬Ø©
        if (!video || !video.duration || isProDragging) return;

        const pct = (video.currentTime / video.duration) * 100;
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const bar = document.getElementById('proProgressBar');
        const knob = document.getElementById('proProgressKnob');
        const timeTxt = document.getElementById('proTimeDisplay');

        if(bar) bar.style.width = pct + "%";
        if(knob) knob.style.left = pct + "%";
        
        if(timeTxt) {
            timeTxt.innerText = formatTimeSec(video.currentTime) + " / " + formatTimeSec(video.duration);
        }

        if (video.ended) updateProPlayIcon(false);
    }, 100); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 100 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
}

// 6. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ (Touch Scrubbing)
function setupScrubbing() {
    const scrubArea = document.getElementById('scrubArea');
    if (!scrubArea) return;

    function handleScrub(e) {
        const video = initProPlayerElements();
        if (!video || !video.duration) return;

        const rect = scrubArea.getBoundingClientRect();
        // Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„Ù…Ø§ÙˆØ³
        let clientX = e.clientX;
        if (e.touches && e.touches.length > 0) clientX = e.touches[0].clientX;

        let percentage = (clientX - rect.left) / rect.width;
        percentage = Math.max(0, Math.min(1, percentage));

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙˆØ±Ø§Ù‹
        const bar = document.getElementById('proProgressBar');
        const knob = document.getElementById('proProgressKnob');
        const timeTxt = document.getElementById('proTimeDisplay');

        if(bar) bar.style.width = (percentage * 100) + "%";
        if(knob) knob.style.left = (percentage * 100) + "%";
        
        video.currentTime = percentage * video.duration;
        
        if(timeTxt) {
            timeTxt.innerText = formatTimeSec(video.currentTime) + " / " + formatTimeSec(video.duration);
        }
    }

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ù…Ø³ (Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª)
    scrubArea.ontouchstart = (e) => { isProDragging = true; handleScrub(e); };
    window.ontouchmove = (e) => { if (isProDragging) handleScrub(e); };
    window.ontouchend = () => { isProDragging = false; };
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø§ÙˆØ³ (Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
    scrubArea.onmousedown = (e) => { isProDragging = true; handleScrub(e); };
    window.onmousemove = (e) => { if (isProDragging) handleScrub(e); };
    window.onmouseup = () => { isProDragging = false; };
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
window.skipProVideo = function(val) {
    const video = initProPlayerElements();
    if(video) video.currentTime += val;
};

window.downloadProVideo = function() {
    const video = initProPlayerElements();
    if (video && video.src) {
        const a = document.createElement('a');
        a.href = video.src;
        a.download = `Video_${Date.now()}.mp4`;
        a.target = "_blank"; // ÙØªØ­ ÙÙŠ Ù…ØªØµÙØ­ Ø®Ø§Ø±Ø¬ÙŠ Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø±ÙØ¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
};

window.cycleSpeed = function() {
    const video = initProPlayerElements();
    if(!video) return;
    proCurrentSpeedIndex = (proCurrentSpeedIndex + 1) % proSpeedLevels.length;
    video.playbackRate = proSpeedLevels[proCurrentSpeedIndex];
    document.getElementById('speedBtn').innerText = proSpeedLevels[proCurrentSpeedIndex] + "x";
};

// Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
function formatTimeSec(s) {
    if (isNaN(s)) return "00:00";
    let m = Math.floor(s / 60);
    let sec = Math.floor(s % 60);
    return m + ":" + (sec < 10 ? "0" : "") + sec;
}
// ==========================================
// 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ (Ù…Ø¹ Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
// ==========================================

let gifSearchTimer;

async function handleGifSearch(query) {
    const clearBtn = document.getElementById('clearGifBtn');
    const grid = document.getElementById('gifsGrid');

    // 1. Ù„Ùˆ Ù…Ø³Ø­Øª Ø§Ù„ÙƒÙ„Ø§Ù… -> Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    if (!query || query.trim() === "") {
        clearBtn.style.display = 'none';
        grid.innerHTML = ''; 
        renderGifsLibrary(); 
        return;
    }

    clearBtn.style.display = 'block';

    // 2. ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡
    clearTimeout(gifSearchTimer);
    
    gifSearchTimer = setTimeout(async () => {
        
        // Ø¹Ø±Ø¶ Ù„ÙˆØ¯ÙŠÙ†Ø¬
        grid.innerHTML = `<div style="width:100%; text-align:center; padding:20px; color:#00e5ff; grid-column:1/-1;">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...
                          </div>`;

        try {
            const apiKey = "LIVDSRZULELA"; 
            const limit = 20;
            
            // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø©
            let url = `https://g.tenor.com/v1/search?q=${query}&key=${apiKey}&limit=${limit}`;
            
            let response = await fetch(url);
            let data = await response.json();

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø±ÙŠØ¯
            grid.innerHTML = '';

            // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„Ù„ÙˆØ¬ÙŠÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ ğŸ”¥ğŸ”¥ğŸ”¥
            
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†ØªØ§ÙŠØ¬ (Array ÙØ§Ø¶ÙŠØ©)
            if (data.results.length === 0) {
                
                // 1. Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù†Ù†Ø§ Ù…Ù„Ù‚Ù†Ø§Ø´ Ø­Ø§Ø¬Ø©
                grid.insertAdjacentHTML('beforeend', `
                    <div style="width:100%; text-align:center; padding:10px; color:#f59e0b; grid-column:1/-1; font-size:12px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px;">
                        Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ "${query}"ØŒ Ø¥Ù„ÙŠÙƒ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø±Ø§Ø¦Ø¬Ø© ğŸ”¥
                    </div>
                `);

                // 2. Ù†Ø¹Ù…Ù„ Ø¨Ø­Ø« ØªØ§Ù†ÙŠ Ø¹Ù† "Trending" (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹)
                url = `https://g.tenor.com/v1/trending?key=${apiKey}&limit=${limit}`;
                response = await fetch(url);
                data = await response.json();
            }

            // Ø±Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø£ØµÙ„ÙŠ Ø£Ùˆ Ø§Ù„Ø¨Ø¯ÙŠÙ„)
            data.results.forEach(gif => {
                const gifUrl = gif.media[0].mediumgif.url; 
                
                const item = document.createElement('div');
                item.className = 'gift-item gif-card'; 
                item.onclick = () => {
                    if(navigator.vibrate) navigator.vibrate(10);
                    sendGifAsMessage(gifUrl);
                };

                item.innerHTML = `<img src="${gifUrl}" class="gif-grid-item" loading="lazy">`;
                grid.appendChild(item);
            });

        } catch (error) {
            console.error("Gif Search Error:", error);
            // Ù„Ùˆ Ø§Ù„Ù†Øª ÙØ§ØµÙ„ Ø®Ø§Ù„ØµØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨ØªØ§Ø¹ØªÙ†Ø§ ÙˆØ®Ù„Ø§Øµ
            renderGifsLibrary();
            showToast("ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø«ØŒ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©");
        }

    }, 600); 
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ØµÙ„
function clearGifSearch() {
    const input = document.getElementById('gifSearchInput');
    input.value = '';
    handleGifSearch(''); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
}

// ==========================================
// 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø© (Save & Retrieve)
// ==========================================

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø© (ØªØªÙ†ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„)
async function saveToFavorites(url, type) {
    if (!currentUserId) return;

    try {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù…Ù†ÙƒØ±Ø±ÙˆØ´
        const snapshot = await db.collection('users').doc(currentUserId).collection('favorites')
            .where('url', '==', url).get();

        if (!snapshot.empty) {
            showToast("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©");
            return;
        }

        // Ø§Ù„Ø­ÙØ¸
        await db.collection('users').doc(currentUserId).collection('favorites').add({
            url: url,
            type: type, // 'gif' or 'sticker'
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        playUiSound('click'); // ØµÙˆØª ØªØ£ÙƒÙŠØ¯
        showToast("â­ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©");

    } catch (e) {
        console.error("Error saving favorite:", e);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
    }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØ¶Ù„Ø© (ØªØªÙ†ÙØ° Ù„Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
async function renderFavorites() {
    const grid = document.getElementById('favoritesGrid');
    grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px; color:#00e5ff; grid-column:1/-1;"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    try {
        const snapshot = await db.collection('users').doc(currentUserId).collection('favorites')
            .orderBy('createdAt', 'desc') // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
            .get();

        grid.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ

        if (snapshot.empty) {
            grid.innerHTML = `
                <div style="width:100%; text-align:center; padding:40px; color:#666; grid-column:1/-1;">
                    <i class="fa-regular fa-star" style="font-size:40px; margin-bottom:10px;"></i><br>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…ÙØ¶Ù„Ø©.<br>Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ø¹Ù„Ù‰ Ø£ÙŠ ØµÙˆØ±Ø© Ù„Ø­ÙØ¸Ù‡Ø§.
                </div>`;
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const item = document.createElement('div');
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ§Ø±Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            if (data.type === 'gif') {
                item.className = 'gift-item gif-card';
                item.innerHTML = `<img src="${data.url}" class="gif-grid-item" loading="lazy">`;
                
                // Ø¶ØºØ·Ø© Ø¹Ø§Ø¯ÙŠØ© = Ø¥Ø±Ø³Ø§Ù„
                item.onclick = () => {
                    if(navigator.vibrate) navigator.vibrate(10);
                    sendGifAsMessage(data.url);
                };
            } else {
                item.className = 'sticker-item';
                item.style.fontSize = "35px";
                item.innerText = data.url; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„ØµÙ‚ Ø§Ù„Ù€ url Ù‡Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù†ÙØ³Ù‡
                
                // Ø¶ØºØ·Ø© Ø¹Ø§Ø¯ÙŠØ© = Ø¥Ø±Ø³Ø§Ù„
                item.onclick = () => sendFreeSticker(data.url);
            }

            // ğŸ”¥ Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙØ¶Ù„Ø© = Ø­Ø°Ù ğŸ”¥
            addLongPressEvent(item, () => deleteFromFavorites(doc.id, item));

            grid.appendChild(item);
        });

    } catch (e) {
        console.error(e);
        grid.innerHTML = '<div style="color:red; text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£</div>';
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©
async function deleteFromFavorites(docId, element) {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ")) {
        try {
            await db.collection('users').doc(currentUserId).collection('favorites').doc(docId).delete();
            element.remove(); // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
            showToast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
            
            // Ù„Ùˆ Ø§Ù„ÙØ§Ø¦Ù…Ø© ÙØ¶ÙŠØªØŒ Ø£Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§Øº
            const grid = document.getElementById('favoritesGrid');
            if (grid.children.length === 0) renderFavorites();
            
        } catch (e) {
            showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
        }
    }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø³Ø­Ø±ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¯Ø« "Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„" Ù„Ø£ÙŠ Ø¹Ù†ØµØ± ğŸ”¥
function addLongPressEvent(element, callback) {
    let timer;
    const duration = 600; // Ù…Ø¯Ø© Ø§Ù„Ø¶ØºØ·Ø© (600 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)

    const start = (e) => {
        // Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…ØªØµÙØ­ (ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†)
        // e.preventDefault(); 
        timer = setTimeout(() => {
            if(navigator.vibrate) navigator.vibrate(50); // Ù‡Ø²Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯
            callback(); // ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±
        }, duration);
    };

    const end = () => {
        clearTimeout(timer); // Ù„Ùˆ Ø´Ø§Ù„ ØµØ¨Ø§Ø¹Ù‡ Ù‚Ø¨Ù„ Ø§Ù„ÙˆÙ‚ØªØŒ Ø§Ù„ØºÙŠ Ø§Ù„Ø£Ù…Ø±
    };

    // Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ (Ù…ÙˆØ¨Ø§ÙŠÙ„) ÙˆØ§Ù„Ù…Ø§ÙˆØ³ (ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
    element.addEventListener('touchstart', start, {passive: true});
    element.addEventListener('touchend', end);
    element.addEventListener('mousedown', start);
    element.addEventListener('mouseup', end);
    element.addEventListener('mouseleave', end);
    
    // Ù…Ù†Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
    element.oncontextmenu = function(event) {
        event.preventDefault();
        event.stopPropagation();
        return false;
    };
}

// ================= Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© =================

// 1. ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function toggleAttachmentMenu() {
    const menu = document.getElementById('attachmentMenu');
    menu.classList.toggle('active');
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ Ù…ÙŠØ¨ÙˆØ¸Ø´
    const emojiPanel = document.getElementById('emojiPickerPanel');
    if(emojiPanel) emojiPanel.style.display = 'none';
}

// 2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¶ØºØ·Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
// ================= ØªØ´ØºÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª =================

function handleAttachment(type) {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    toggleAttachmentMenu(); 

    // 2. ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    switch (type) {
        
        // --- ğŸ“„ Ù…Ø³ØªÙ†Ø¯ (Document) ---
        case 'document':
            // Ù†Ø³ØªØ®Ø¯Ù… Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹ Ø¨Ø³ Ù†ØºÙŠØ± Ù†ÙˆØ¹Ù‡ Ù„ÙŠÙ‚Ø¨Ù„ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
            const fileInp = document.getElementById('fileInput');
            fileInp.setAttribute('accept', '*/*'); // Ù‚Ø¨ÙˆÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (PDF, ZIP, DOC...)
            fileInp.click();
            break;
            
        // --- ğŸ–¼ï¸ Ø§Ù„Ù…Ø¹Ø±Ø¶ (Gallery) ---
        case 'gallery':
            // ÙØªØ­ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙ‚Ø·
            const mediaInp = document.getElementById('mediaInput');
            mediaInp.click(); // Ù‡Ùˆ Ø£ØµÙ„Ø§Ù‹ Ù…Ø¶Ø¨ÙˆØ· Ø¹Ù„Ù‰ image/*,video/*
            break;
            
        // --- ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Camera) ---
        case 'camera':
            // Ø¨Ù†Ø¹Ù…Ù„ Ø­Ù‚Ù„ Ù…Ø¤Ù‚Øª Ø¹Ø´Ø§Ù† Ù†ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ±Ø§Ù‹
            const camInput = document.createElement('input');
            camInput.type = 'file';
            camInput.accept = 'image/*';
            camInput.capture = 'environment'; // ğŸ‘ˆ Ø¯Ù‡ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ø·ÙˆÙ„
            
            camInput.onchange = (e) => {
                // Ù†Ø¨Ø¹Øª Ø§Ù„Ù…Ù„Ù Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø¨ØªØ§Ø¹ØªÙƒ
                if(camInput.files[0]) {
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ
                    uploadMedia({ files: camInput.files }, 'media'); 
                }
            };
            camInput.click();
            break;
            
        // --- ğŸµ Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ (Audio) ---
                // --- ğŸµ Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ (Audio) ---
        case 'audio':
            const audioInput = document.createElement('input');
            audioInput.type = 'file';
            
            // ğŸ”¥ Ø§Ù„ØªØºÙŠÙŠØ± Ù‡Ù†Ø§: Ø¨Ù†Ø­Ø¯Ø¯ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙˆØª Ø¨Ø¯Ù‚Ø© Ø¹Ø´Ø§Ù† ÙŠÙØªØ­ Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
            // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª Ø¨ØªÙÙ‡Ù… audio/* ÙˆØ¨Ø¹Ø¶Ù‡Ø§ Ø¨ÙŠØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒØªØ±
            audioInput.accept = 'audio/*'; 
            
            audioInput.onchange = (e) => {
                if(audioInput.files[0]) {
                    // Ù‡Ù†Ø§ Ø¨Ù†Ø¨Ø¹Øª Ø§Ù„Ù…Ù„Ù Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹
                    // Ù„Ø§Ø­Ø¸: Ø³Ù…ÙŠÙ†Ø§Ù‡Ø§ 'audio' Ø¹Ø´Ø§Ù† Ù…Ù…ÙƒÙ† Ù†Ù…ÙŠØ²Ù‡Ø§ ÙÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ùˆ Ø­Ø§Ø¨Ø¨
                    uploadMedia(audioInput, 'audio'); 
                }
            };
            audioInput.click();
            break;


        // --- ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location) ---
        // --- ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location) ---
case 'location':
    if (!navigator.geolocation) {
        showToast("âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    }
    
    showToast("ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...");
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
            const msgPayload = {
                type: 'location', // Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
                lat: lat,         // Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶
                lng: lng,         // Ø®Ø· Ø§Ù„Ø·ÙˆÙ„
                uid: currentUserId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                seen: false,
                text: `https://www.google.com/maps?q=${lat},${lng}`, // Ø±Ø§Ø¨Ø· Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                isGhost: typeof isGhostMode !== 'undefined' ? isGhostMode : false
            };
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„
            await ensureChatActive();
            await db.collection("chats").doc(chatId).collection("messages").add(msgPayload);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
            await db.collection("chats").doc(chatId).update({
                lastMessage: "ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ",
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                unreadCount: firebase.firestore.FieldValue.increment(1)
            });

            showToast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        },
        (error) => {
            console.error(error);
            showToast("âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS");
        },
        { enableHighAccuracy: true } // Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
    );
    break;

        // --- ğŸ‘¤ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ (Contact) ---
        // ÙÙŠ Ø¯Ø§Ù„Ø© handleAttachment ...

        // --- ğŸ‘¤ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ ---
        case 'contact':
            document.getElementById('contactModal').style.display = 'flex';
            document.getElementById('contactName').focus();
            break;
            
        // --- ğŸ“Š Ø§Ù„ØªØµÙˆÙŠØª ---
        case 'poll':
            document.getElementById('pollModal').style.display = 'flex';
            document.getElementById('pollQuestion').focus();
            break;
            
        // --- ğŸ“… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª ---
        case 'event':
            // Ù…Ù…ÙƒÙ† Ù†Ø¹Ù…Ù„Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
             showToast("ğŸ“… Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù‚Ø§Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹");
            break;
// ...

        case 'ai':
            showToast("ğŸ¤– Ù…ÙŠØ²Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±");
            break;
    }
}

// 3. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§ (ÙÙŠ Ø¬Ø³Ù… Ø§Ù„Ø´Ø§Øª)
document.addEventListener('click', function(e) {
    const menu = document.getElementById('attachmentMenu');
    const btn = document.querySelector('.file-btn');
    
    // Ù„Ùˆ Ø§Ù„Ø¶ØºØ·Ø© Ù…Ø´ Ø¬ÙˆÙ‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙ…Ø´ Ø¹Ù„Ù‰ Ø²Ø±Ø§Ø± Ø§Ù„ÙØªØ­
    if (menu.classList.contains('active') && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('active');
    }
});

// 1. Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
async function sendContactMessage() {
    const name = document.getElementById('contactName').value.trim();
    const number = document.getElementById('contactNumber').value.trim();

    if (!name || !number) { showToast("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

    document.getElementById('contactModal').style.display = 'none';
    
    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    const msgPayload = {
        type: 'contact',
        contactName: name,
        contactNumber: number,
        uid: currentUserId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false,
        text: 'Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ ğŸ‘¤' // Ù†Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    };
    
    await db.collection("chats").doc(chatId).collection("messages").add(msgPayload);
    // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('contactName').value = "";
    document.getElementById('contactNumber').value = "";
}

// 2. Ø¥Ø±Ø³Ø§Ù„ ØªØµÙˆÙŠØª (Poll)
async function sendPollMessage() {
    const q = document.getElementById('pollQuestion').value.trim();
    const o1 = document.getElementById('pollOpt1').value.trim();
    const o2 = document.getElementById('pollOpt2').value.trim();

    if (!q || !o1 || !o2) { showToast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø®ÙŠØ§Ø±ÙŠÙ†"); return; }

    document.getElementById('pollModal').style.display = 'none';

    const msgPayload = {
        type: 'poll',
        question: q,
        options: [o1, o2],
        votes: { [o1]: 0, [o2]: 0 }, // Ø¹Ø¯Ø§Ø¯ Ù…Ø¨Ø¯Ø¦ÙŠ
        uid: currentUserId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false,
        text: 'ğŸ“Š Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø±Ø£ÙŠ'
    };

    await db.collection("chats").doc(chatId).collection("messages").add(msgPayload);
    
    // ØªÙØ±ÙŠØº
    document.getElementById('pollQuestion').value = "";
    document.getElementById('pollOpt1').value = "";
    document.getElementById('pollOpt2').value = "";
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª (Voting Logic)
async function votePoll(msgId, option) {
    if(!msgId) return;
    showToast(`ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù€: ${option}`);
    // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹)
}

// ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª =================
function openDocViewer(fileUrl, fileName) {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯
    // Ø¨Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¹Ø±Ù Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ø£Ùˆ Ù…Ù…ÙƒÙ† Ù†Ø¨Ø¹ØªÙ‡ ÙƒØ¨Ø§Ø±Ø§Ù…ØªØ± Ù„Ùˆ Ù…ØªØ®Ø²Ù† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²)
    let extension = fileUrl.split('.').pop().split('?')[0].toLowerCase();
    
    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const supportedDocs = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'txt'];

    // 2. Ù„Ùˆ Ø§Ù„Ù…Ù„Ù Ù…Ø´ Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø²ÙŠ ZIP Ø£Ùˆ EXE) -> Ù†Ø­Ù…Ù„Ù‡ Ø¹Ù„Ø·ÙˆÙ„
    if (!supportedDocs.includes(extension) && !fileUrl.includes('pdf')) { // Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø±Ø§Ø¨Ø· ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù…Ø´ Ø¨ÙŠØ¨ÙŠÙ† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ØŒ Ø¨Ø³ Ø§Ù„Ù€ PDF Ù‡Ùˆ Ø§Ù„Ø£Ù‡Ù…
        window.open(fileUrl, '_blank');
        return;
    }

    // 3. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = document.getElementById('docViewerModal');
    const iframe = document.getElementById('docIframe');
    const title = document.getElementById('docViewerTitle');
    const downloadBtn = document.getElementById('docDownloadBtn');
    const loader = document.getElementById('docLoader');

    // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ù€ body Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„
    if(modal.parentNode !== document.body) document.body.appendChild(modal);

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    title.innerText = fileName || "Ù…Ø³ØªÙ†Ø¯";
    downloadBtn.href = fileUrl;
    loader.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ¯Ø±

    // 4. ğŸ”¥ Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Viewer ğŸ”¥
    // Google Viewer Ø¨ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙƒÙˆÙ† encoded Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„ ØµØ­
    const viewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fileUrl)}&embedded=true`;
    
    iframe.src = viewerUrl;
    modal.style.display = 'flex';
}

function closeDocViewer() {
    const modal = document.getElementById('docViewerModal');
    const iframe = document.getElementById('docIframe');
    
    modal.style.display = 'none';
    iframe.src = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø´Ø§Ù† ÙŠÙˆÙ‚Ù ØªØ­Ù…ÙŠÙ„ ÙˆÙŠÙˆÙØ± Ù†Øª
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ
async function pickContactFromDevice() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©ØŸ (ØºØ§Ù„Ø¨Ø§Ù‹ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙƒØ±ÙˆÙ…)
    const isSupported = ('contacts' in navigator && 'ContactsManager' in window);

    if (isSupported) {
        try {
            const props = ['name', 'tel']; // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ù†Ø±ÙŠØ¯Ù‡Ø§ (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù…)
            const opts = { multiple: false }; // Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·

            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            const contacts = await navigator.contacts.select(props, opts);

            if (contacts.length) {
                const contact = contacts[0];
                
                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                const nameInput = document.getElementById('contactName');
                const numberInput = document.getElementById('contactNumber');

                // ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³Ù…
                if (contact.name && contact.name.length) {
                    nameInput.value = contact.name[0];
                }
                
                // ÙˆØ¶Ø¹ Ø§Ù„Ø±Ù‚Ù…
                if (contact.tel && contact.tel.length) {
                    numberInput.value = contact.tel[0];
                }
                
                showToast("âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…");
            }
        } catch (ex) {
            // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ÙÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø±
            console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…");
        }
    } else {
        // Ù„Ùˆ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© (Ø¢ÙŠÙÙˆÙ† Ø£Ùˆ ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
        alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ù‡ÙˆØ§ØªÙ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Chrome). ÙŠØ±Ø¬Ù‰ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹.");
    }
}
// ================= Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ØµØ© (Swipe Down to Close) =================

const storyViewer = document.getElementById('simpleStoryViewer');
let startY_story = 0;
let currentY_story = 0;
let isDragging_story = false;

// 1. Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
storyViewer.addEventListener('touchstart', (e) => {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ø§Ù†Ù†Ø§ ÙÙŠ Ø§Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙÙŠ Ø³ÙƒØ±ÙˆÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹)
    startY_story = e.touches[0].clientY;
    isDragging_story = true;
    storyViewer.style.transition = 'none'; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªÙƒÙˆÙ† ÙÙˆØ±ÙŠØ© Ù…Ø¹ Ø§Ù„ØµØ¨Ø§Ø¹
}, { passive: true });

// 2. Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
storyViewer.addEventListener('touchmove', (e) => {
    if (!isDragging_story) return;
    
    currentY_story = e.touches[0].clientY;
    const diff = currentY_story - startY_story;

    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„ ÙÙ‚Ø· (diff > 0)
    if (diff > 0) {
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù‚ØµØ© Ù…Ø¹ Ø§Ù„ØµØ¨Ø§Ø¹
        storyViewer.style.transform = `translateY(${diff}px) scale(${1 - diff/3000})`; // ØªØµØºÙŠØ± Ø¨Ø³ÙŠØ· Ù…Ø¹ Ø§Ù„Ø³Ø­Ø¨
        
        // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙƒÙ„ Ù…Ø§ Ù†Ø³Ø­Ø¨ Ù„ØªØ­Øª
        // (1 - (Ø§Ù„Ù…Ø³Ø§ÙØ© / 800)) ÙŠØ¹Ù†ÙŠ Ù‡ØªØ®ØªÙÙŠ Ù„Ù…Ø§ Ù†Ø³Ø­Ø¨ 800 Ø¨ÙƒØ³Ù„
        storyViewer.style.opacity = `${1 - diff/800}`;
    }
}, { passive: true });

// 3. Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„ØµØ¨Ø§Ø¹
storyViewer.addEventListener('touchend', (e) => {
    isDragging_story = false;
    const diff = currentY_story - startY_story;

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø§Ø¹Ù…
    storyViewer.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';

    // Ù„Ùˆ Ø³Ø­Ø¨Ù†Ø§ Ù…Ø³Ø§ÙØ© ÙƒØ§ÙÙŠØ© (Ù…Ø«Ù„Ø§Ù‹ 150 Ø¨ÙƒØ³Ù„) -> Ø§ØºÙ„Ù‚ Ø§Ù„Ù‚ØµØ©
    if (diff > 150) {
        closeStoryViewer();
    } else {
        // Ù„Ùˆ Ø³Ø­Ø¨Ø© ØµØºÙŠØ±Ø© -> Ø±Ø¬Ø¹Ù‡Ø§ Ù…ÙƒØ§Ù†Ù‡Ø§
        storyViewer.style.transform = '';
        storyViewer.style.opacity = '1';
    }
});

// ================= ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ØµØ© (Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ØªØ§ÙŠÙ„) =================
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© closeStoryViewer Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©:

// ================================================================
// ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ØµØ© + Ø§Ù„Ø³Ø­Ø¨ (Swipe Down) ğŸ”¥
// ================================================================

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø³Ù†Ø© (Ø¨ØªØ¹Ù…Ù„ Reset Ù„Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù†)
function closeStoryViewer() {
    const viewer = document.getElementById('simpleStoryViewer');
    const vidEl = document.getElementById('storyVideoDisplay');
    
    // Ø£) ØªØ·Ø¨ÙŠÙ‚ Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ (ØªÙ†Ø²Ù„Ù‚ Ù„Ø£Ø³ÙÙ„ ÙˆØªØ®ØªÙÙŠ)
    viewer.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
    viewer.style.transform = 'translateY(100%)'; 
    viewer.style.opacity = '0';

    // Ø¨) Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø«Ù… Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠ
    setTimeout(() => {
        viewer.style.display = 'none';
        
        // Ø¬) ğŸ”¥ Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ… Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ© ØªÙØªØ­ ØµØ­ ğŸ”¥
        viewer.style.transform = '';
        viewer.style.opacity = '1';
        
        // Ø¯) Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØªØ§ÙŠÙ…Ø±
        if(vidEl) {
            vidEl.pause();
            vidEl.src = ""; 
        }
        if(typeof storyTimerInterval !== 'undefined') clearInterval(storyTimerInterval);
        
        // ØªØµÙÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨
        isDragging_story = false;
        
    }, 300); // Ù†ÙØ³ Ù…Ø¯Ø© Ø§Ù„Ù€ transition
}

// 3. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ (Event Listeners)
if (storyViewerEl) {
    // Ø£) Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
    storyViewerEl.addEventListener('touchstart', (e) => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ø§Ù†Ù†Ø§ ÙÙŠ Ø§Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙÙŠ Ø³ÙƒØ±ÙˆÙ„)
        startY_story = e.touches[0].clientY;
        isDragging_story = true;
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªÙƒÙˆÙ† ÙÙˆØ±ÙŠØ© Ù…Ø¹ ØµØ¨Ø§Ø¹Ùƒ
        storyViewerEl.style.transition = 'none'; 
    }, { passive: true });

    // Ø¨) Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
    storyViewerEl.addEventListener('touchmove', (e) => {
        if (!isDragging_story) return;
        
        currentY_story = e.touches[0].clientY;
        const diff = currentY_story - startY_story;

        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„ ÙÙ‚Ø· (diff > 0)
        if (diff > 0) {
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù‚ØµØ© Ù…Ø¹ Ø§Ù„ØµØ¨Ø§Ø¹ ÙˆØªØµØºÙŠØ±Ù‡Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹
            storyViewerEl.style.transform = `translateY(${diff}px) scale(${1 - diff/3000})`;
            
            // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ© ÙƒÙ„ Ù…Ø§ Ù†Ø³Ø­Ø¨ Ù„ØªØ­Øª
            storyViewerEl.style.opacity = `${1 - diff/800}`;
        }
    }, { passive: true });

    // Ø¬) Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„ØµØ¨Ø§Ø¹
    storyViewerEl.addEventListener('touchend', (e) => {
        isDragging_story = false;
        const diff = currentY_story - startY_story;

        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø§Ø¹Ù… (Ø¹Ø´Ø§Ù† Ø³ÙˆØ§Ø¡ Ù‚ÙÙ„Øª Ø£Ùˆ Ø±Ø¬Ø¹Øª ØªÙƒÙˆÙ† Ù†Ø§Ø¹Ù…Ø©)
        storyViewerEl.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';

        // Ù„Ùˆ Ø³Ø­Ø¨Ù†Ø§ Ù…Ø³Ø§ÙØ© ÙƒØ§ÙÙŠØ© (Ø£ÙƒØ¨Ø± Ù…Ù† 150 Ø¨ÙƒØ³Ù„) -> Ø§ØºÙ„Ù‚ Ø§Ù„Ù‚ØµØ©
        if (diff > 150) {
            closeStoryViewer();
        } else {
            // Ù„Ùˆ Ø³Ø­Ø¨Ø© ØµØºÙŠØ±Ø© -> Ø±Ø¬Ø¹Ù‡Ø§ Ù…ÙƒØ§Ù†Ù‡Ø§ (Reset)
            storyViewerEl.style.transform = '';
            storyViewerEl.style.opacity = '1';
        }
    });
}
function formatText(text) {
    // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    let formatted = linkify(escapeHtml(text));

    // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (3 Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø£ÙƒØ«Ø±) Ø¥Ù„Ù‰ Ø´ÙƒÙ„ Ø¯ÙŠØ¬ÙŠØªØ§Ù„
    // Ù†Ø³ØªØ«Ù†ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¹Ø´Ø§Ù† Ù…Ù†Ø¨ÙˆØ¸Ø´ Ø§Ù„Ù€ URL
    formatted = formatted.replace(/(?<!href="|">)(\b\d{3,}\b)/g, '<span class="digital-number">$1</span>');

    return formatted;
}

function handleVote(msgId, option) {
    if(navigator.vibrate) navigator.vibrate(20); // Ù‡Ø²Ø© Ø®ÙÙŠÙØ©

    // 1. ØªØ­Ø¯ÙŠØ« Ø¨ØµØ±ÙŠ ÙÙˆØ±ÙŠ (Optional UI Trick)
    const msgEl = document.getElementById(`msg_${msgId}`);
    if(msgEl) {
        const card = msgEl.querySelector('.poll-card-modern');
        if(card) card.classList.add('voted'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
    }

    // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² (Ø§Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    // votePoll(msgId, option); 
    
    // Ù…Ø«Ø§Ù„ Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³:
    const docRef = db.collection("chats").doc(chatId).collection("messages").doc(msgId);
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… transaction Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø£ØµÙˆØ§Øª
    db.runTransaction(async (transaction) => {
        const doc = await transaction.get(docRef);
        if (!doc.exists) return;

        const data = doc.data();
        const currentVotes = data.votes || {};
        
        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
        currentVotes[option] = (currentVotes[option] || 0) + 1;
        
        // (Ù…Ù‡Ù…) Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ UID Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…ØµÙÙˆÙØ© "voters" Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØµÙˆÙŠØª Ù…Ø±ØªÙŠÙ†
        // Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ø­Ø¯Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙ‚Ø·
        transaction.update(docRef, { votes: currentVotes });
    }).then(() => {
        showToast(`ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù€: ${option}`);
    }).catch((e) => console.log(e));
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function navigateToUserProfile() {
    // 1. Ù‡Ø²Ø© Ø®ÙÙŠÙØ© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(10);

    // 2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (cachedOtherUserId) {
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù€ UID ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
        window.location.href = `profile.html?uid=${cachedOtherUserId}`;
    } else {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø¬Ù„Ø¨ Ø§Ù„Ù€ UID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ùˆ Ø§Ù„ÙƒØ§Ø´ ÙØ§Ø¶ÙŠ
        const urlParams = new URLSearchParams(window.location.search);
        const uidFromUrl = urlParams.get('uid');
        
        if (uidFromUrl) {
            window.location.href = `profile.html?uid=${uidFromUrl}`;
        } else {
            showToast("âš ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...");
        }
    }
}
function updateProPlayIcon(isPlaying) {
    const icon = document.querySelector('#proPlayBtn i');
    if (icon) {
        // Ù„Ùˆ Ø´ØºØ§Ù„ Ù†Ø¹Ø±Ø¶ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆÙ‚ÙØŒ Ù„Ùˆ ÙˆØ§Ù‚Ù Ù†Ø¹Ø±Ø¶ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
        icon.className = isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
    }
}
// ================= Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© =================
function toggleProPlay() {
    // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡Ø§
    const video = initProPlayerElements();
    
    if (!video) return; // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø®Ø±Ø¬

    // 2. ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ¨Ø¯ÙŠÙ„Ù‡Ø§
    if (video.paused) {
        // Ù„Ùˆ ÙˆØ§Ù‚Ù -> Ø´ØºÙ„Ù‡
        video.play().then(() => {
            updateProPlayIcon(true); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù€ pause
        }).catch(error => {
            console.log("Play failed:", error);
        });
    } else {
        // Ù„Ùˆ Ø´ØºØ§Ù„ -> ÙˆÙ‚ÙÙ‡
        video.pause();
        updateProPlayIcon(false); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù€ play
    }
}

// ================= Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø´Ø§Øª (ÙŠÙˆØ¶Ø¹ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª) =================

let realPagePassword = null; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ

// 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ (ØªØ´ØªØºÙ„ Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­)
async function checkPageSecurity() {
    if (!chatId) return;

    try {
        // Ø¨Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø¯Ù‡ Ø¨Ø³
        const doc = await db.collection('chats').doc(chatId).get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø³ÙˆØ±Ø¯ØŸ ÙˆÙ‡Ù„ Ù‡Ùˆ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…ØŸ
            if (data.lockPass && data.lockPass.length === 6) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ ÙÙˆØ±Ø§Ù‹
                document.getElementById('pageLockModal').style.display = 'flex';
                
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ‡
                realPagePassword = data.lockPass;
                
                // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø®Ø§Ù†Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                document.getElementById('pageLockInput').focus();
            }
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†:", error);
    }
}

// 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ (Ù„Ù…Ø§ ÙŠØ¯ÙˆØ³ Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±Ø§Ø±)
function unlockPage() {
    const inputVal = document.getElementById('pageLockInput').value;
    
    if (inputVal === realPagePassword) {
        // Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØµØ­: Ø§Ø®ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©
        document.getElementById('pageLockModal').style.display = 'none';
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù†Ø¬Ø§Ø­ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if(typeof playUiSound === 'function') playUiSound('sent');
        
    } else {
        // Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø·
        showToast("âŒ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­");
        document.getElementById('pageLockInput').value = ''; // ÙØ¶ÙŠ Ø§Ù„Ø®Ø§Ù†Ø©
        
        // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
    }
}
// ================= Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù‚ÙÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© =================

document.addEventListener("visibilitychange", function() {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù… Ø¨Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© (Ø®Ø±Ø¬ Ø£Ùˆ Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©)
    if (document.visibilityState === 'hidden') {
        
        // 2. Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§Øª Ù…Ø­Ù…ÙŠ Ø£ØµÙ„Ø§Ù‹ØŸ (Ù‡Ù„ ØªÙ… Ø¬Ù„Ø¨ Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŸ)
        if (realPagePassword) {
            const lockModal = document.getElementById('pageLockModal');
            const lockInput = document.getElementById('pageLockInput');
            
            // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ ÙÙˆØ±Ø§Ù‹
            if (lockModal) {
                lockModal.style.display = 'flex';
            }
            
            // 4. ØªÙ†Ø¸ÙŠÙ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ù…Ø§Ù†
            if (lockInput) {
                lockInput.value = '';
                lockInput.blur(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
            }
        }
    }
    
    // 5. Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© (Visible)
    if (document.visibilityState === 'visible') {
        if (realPagePassword) {
            // ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ø¤Ø´Ø± ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆØ±Ø§Ù‹
            setTimeout(() => {
                const lockInput = document.getElementById('pageLockInput');
                if(lockInput) lockInput.focus();
            }, 300);
        }
    }
});

// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…Ù„Ù chat.html
function updateBlockUI(isBlocked) {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù€ classes Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØªØµÙ…ÙŠÙ… ÙÙŠ chat.html)
    const footer = document.querySelector('.chat-footer'); // Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    const inputArea = document.getElementById('messageInput'); 

    if (isBlocked) {
        // Ù„Ùˆ Ù…Ø­Ø¸ÙˆØ±: Ø§Ø®ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ø¸Ù‡Ø± ØªØ­Ø°ÙŠØ±
        if(footer) footer.style.display = 'none';
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
        let alertDiv = document.getElementById('blockAlertDiv');
        if(!alertDiv) {
            alertDiv = document.createElement('div');
            alertDiv.id = 'blockAlertDiv';
            alertDiv.style.cssText = "position:fixed; bottom:0; width:100%; background:#222; color:#ff4444; text-align:center; padding:15px; font-weight:bold; z-index:100;";
            alertDiv.innerHTML = '<i class="fa-solid fa-ban"></i> Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
            document.body.appendChild(alertDiv);
        } else {
            alertDiv.style.display = 'block';
        }
        
    } else {
        // Ù„Ùˆ Ù…Ø´ Ù…Ø­Ø¸ÙˆØ±: Ø§Ø¸Ù‡Ø± Ø§Ù„ÙÙˆØªØ± ÙˆØ§Ø®ÙÙŠ Ø§Ù„ØªØ­Ø°ÙŠØ±
        if(footer) footer.style.display = 'flex';
        const alertDiv = document.getElementById('blockAlertDiv');
        if(alertDiv) alertDiv.style.display = 'none';
    }
}


    </script>
    
    

    <div id="scrollToBottomBtn" onclick="scrollToBottom()" class="scroll-bottom-btn">
    <i class="fa-solid fa-arrow-down"></i>
</div>

<div id="deleteModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="confirm-title">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ</div>
        <div class="confirm-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ</div>
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel-del" onclick="closeDeleteModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm-del" onclick="performDelete()">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
        </div>
    </div>
</div>

<audio id="ringtoneOut" loop preload="auto">
    <source src="./sounds/ring_out.mp3" type="audio/mp3">
</audio>



<audio id="ringtoneIn" loop preload="auto">
    <source src="./sounds/ring_in.wav" type="audio/wav">
</audio>


<audio id="callEndSound" preload="auto">
    <source src="./sounds/end_call.mp3" type="audio/mp3">
</audio>

<div id="profilePage" class="profile-page" style="display:none;">
    
    <div class="pp-header">
        <div class="icon-btn" onclick="closeProfile()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <div style="width: 40px;"></div> </div>

    <div class="pp-content">
        
    <div class="pp-user-info">
    <div class="pp-avatar-wrapper">
        <div id="profilePageImg" class="pp-avatar-lg"></div>
    </div>
    
    <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
        <div id="profilePageName" class="pp-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <i id="profilePageVerify" class="fa-solid fa-circle-check" style="color: #00e5ff; font-size: 18px; display: none; filter: drop-shadow(0 0 5px rgba(0,229,255,0.5));"></i>
    </div>

    <div class="encryption-pill"><i class="fa-solid fa-lock"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø´ÙØ±Ø©</div>

    <button onclick="navigateToUserProfile()" class="view-profile-btn">
        <span>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
        <i class="fa-solid fa-arrow-left-long btn-arrow"></i>
    </button>

</div>

        <div class="profile-menu-list">
            
            <div class="profile-item" onclick="toggleGhostMode()">
                <div class="p-item-icon ghost-icon"><i class="fa-solid fa-ghost"></i></div>
                <div class="p-item-text">
                    <span>ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­</span>
                    <small>Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¤Ù‚ØªØ©</small>
                </div>
                <div class="p-item-arrow"><i class="fa-solid fa-toggle-off" id="ghostToggleIcon"></i></div>
            </div>
<div class="profile-item" onclick="openNicknamesPage()">
    <div class="p-item-icon" style="background: rgba(236, 72, 153, 0.15); color: #ec4899;">
        <i class="fa-solid fa-a"></i>
    </div>
    <div class="p-item-text"><span>Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</span></div>
    <div class="p-item-arrow"><i class="fa-solid fa-chevron-left"></i></div>
</div>

            <div class="profile-item" onclick="openMediaGallery()"> 
                <div class="p-item-icon media-icon"><i class="fa-regular fa-images"></i></div>
                <div class="p-item-text"><span>Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</span></div>
                <div class="p-item-arrow"><i class="fa-solid fa-chevron-left"></i></div>
            </div>

            <div class="profile-item" onclick="toggleSearchMode()">
                <div class="p-item-icon search-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div class="p-item-text"><span>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span></div>
            </div>

          <div class="profile-item" onclick="toggleMuteNotifications()">
    <div class="p-item-icon mute-icon"><i class="fa-regular fa-bell-slash"></i></div>
    <div class="p-item-text"><span id="muteText">ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></div>
    <div class="p-item-arrow"><i id="muteIcon" class="fa-solid fa-toggle-off toggle-icon"></i></div>
</div>


            <div class="profile-item" onclick="openPrivacyPage()">
                <div class="p-item-icon privacy-icon"><i class="fa-solid fa-shield-halved"></i></div>
                <div class="p-item-text"><span>Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†</span></div>
                <div class="p-item-arrow"><i class="fa-solid fa-chevron-left"></i></div>
            </div>

            <div style="height: 20px;"></div>

            <div class="profile-item block-item" onclick="toggleBlockUser()">
                <div class="p-item-icon block-icon"><i class="fa-solid fa-ban"></i></div>
                <div class="p-item-text"><span style="color:#ff3b30;">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span></div>
            </div>

        </div>
    </div>
</div>

<div id="searchOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0b1121; z-index:9999; flex-direction:column;">
    
    <div style="display:flex; align-items:center; padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(15,25,38,0.95);">
        <i class="fa-solid fa-arrow-right" onclick="closeSearchMode()" style="color:#fff; font-size:20px; cursor:pointer; padding:10px;"></i>
        <div style="flex:1; margin-right:10px; background:rgba(255,255,255,0.05); border-radius:20px; padding:0 15px; display:flex; align-items:center;">
            <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;"></i>
            <input type="text" id="searchInputField" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©..." style="width:100%; background:transparent; border:none; color:#fff; padding:10px; font-size:15px; outline:none;" oninput="doSearch(this.value)">
        </div>
    </div>

    <div id="searchResults" style="flex:1; overflow-y:auto; padding:10px;">
        </div>
</div>

        
<div id="previewModal" class="preview-modal" style="display: none;">
    <div class="preview-content">
        <h3 style="color:#fff; margin-bottom:15px; text-align:center;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h3>
        <div id="previewContainer" style="max-height: 50vh; overflow: auto; border-radius: 10px; margin-bottom: 20px; display:flex; justify-content:center; align-items:center;">
        </div>
        <div class="preview-actions">
            <button onclick="cancelPreview()" class="btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="confirmUpload()" class="btn-send">
                <i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
            </button>
        </div>
    </div>
</div>

<div id="mediaGalleryOverlay" class="media-gallery-overlay" style="display:none;">
    <div class="mg-header">
        <div class="mg-close-btn" onclick="closeMediaGallery()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3>Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</h3>
    </div>

    <div class="mg-tabs">
        <div class="mg-tab active" onclick="switchTab('media')">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</div>
        <div class="mg-tab" onclick="switchTab('files')">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</div>
        <div class="mg-tab" onclick="switchTab('audio')">Ø§Ù„ØµÙˆØªÙŠØ§Øª</div>
        <div class="mg-tab" onclick="switchTab('links')">Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</div>
    </div>

    <div class="mg-body">
        <div id="panel-media" class="mg-panel grid-view active"></div>

        <div id="panel-files" class="mg-panel list-view"></div>

        <div id="panel-audio" class="mg-panel list-view"></div>

        <div id="panel-links" class="mg-panel list-view"></div>
    </div>
</div>


<div id="scrollToBottomBtn" onclick="scrollToBottom()" class="scroll-bottom-btn">
    <i class="fa-solid fa-arrow-down"></i>
</div>

<div id="deleteModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="confirm-title">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ</div>
        <div class="confirm-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ</div>
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel-del" onclick="closeDeleteModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm-del" onclick="performDelete()">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
        </div>
    </div>
</div>
<div id="docViewerModal" class="media-gallery-overlay" style="display:none; z-index: 300000;">
    
    <div class="mg-header" style="justify-content: space-between;">
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="mg-close-btn" onclick="closeDocViewer()">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <h3 id="docViewerTitle" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</h3>
        </div>
        
        <a id="docDownloadBtn" href="#" target="_blank" class="icon-btn" style="text-decoration:none; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-download"></i>
        </a>
    </div>

    <div class="mg-body" style="padding:0; overflow:hidden; background:#333;">
        
        <div id="docLoader" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; z-index:1;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:40px; color:#00e5ff; margin-bottom:15px;"></i>
            <span>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù...</span>
        </div>

        <iframe id="docIframe" style="width:100%; height:100%; border:none; position:relative; z-index:2;" onload="document.getElementById('docLoader').style.display='none'"></iframe>
        
    </div>
</div>

<div id="customBlockModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="modal-icon-box">
            <i class="fa-solid fa-user-slash"></i>
        </div>
        <div class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¸Ø±ØŸ</div>
        <div class="confirm-desc">
            Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø§Ø³Ù… "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶".<br>
            Ù„Ù† ÙŠØ±Ù‰ ØµÙˆØ±ØªÙƒ Ø£Ùˆ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ.<br>
            Ù„Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø±Ø§Ø³Ù„ØªÙƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.
        </div>
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel" onclick="closeBlockModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm" onclick="confirmBlockAction()">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
    </div>
</div>
<div id="privacySettingsPage" class="profile-page" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index: 200000; background-color: #0b1121; flex-direction:column;">
    
    <div class="pp-header" style="background: rgba(15, 25, 38, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px; display: flex; align-items: center; padding: 0 15px;">
        <div class="icon-btn" onclick="document.getElementById('privacySettingsPage').style.display='none'; document.getElementById('profilePage').style.display='flex';" style="background:transparent; border:none; width:auto; cursor:pointer;">
            <i class="fa-solid fa-arrow-right" style="font-size: 20px; color: #fff;"></i>
        </div>
        <h3 style="margin:0; font-size:16px; color: #fff; flex:1; text-align:center; font-weight:bold;">
            Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
        </h3>
        <div style="width: 30px;"></div>
    </div>
    
    <div class="pp-content" style="padding: 20px; overflow-y:auto; flex:1;">
        
        <div style="color: #00e5ff; font-size: 12px; font-weight: bold; margin-bottom: 15px; margin-top: 10px;">Ø§Ù„Ø¸Ù‡ÙˆØ± ÙˆØ§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
        
        <div class="profile-item" onclick="window.togglePrivacyOption('hideLastSeen')" style="justify-content: space-between; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="p-item-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                    <i class="fa-regular fa-clock"></i>
                </div>
                <div class="p-item-text">
                    <span style="color:#fff; font-size:14px;">Ø¥Ø®ÙØ§Ø¡ "Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±"</span>
                    <small style="color:#64748b; font-size:11px;">Ù„Ù† ÙŠØ±Ù‰ Ø£Ø­Ø¯ Ù…ØªÙ‰ ÙƒÙ†Øª Ù†Ø´Ø·Ø§Ù‹</small>
                </div>
            </div>
            <i id="toggle_hideLastSeen" class="fa-solid fa-toggle-off" style="font-size: 22px; color: #64748b; transition:0.3s;"></i>
        </div>

        <div class="profile-item" onclick="window.togglePrivacyOption('hideReadReceipts')" style="justify-content: space-between;">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="p-item-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                    <i class="fa-solid fa-check-double"></i>
                </div>
                <div class="p-item-text">
                    <span style="color:#fff; font-size:14px;">Ø¥Ø®ÙØ§Ø¡ "ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"</span>
                    <small style="color:#64748b; font-size:11px;">Ù„Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</small>
                </div>
            </div>
            <i id="toggle_hideReadReceipts" class="fa-solid fa-toggle-off" style="font-size: 22px; color: #64748b; transition:0.3s;"></i>
        </div>

        <div style="width:100%; height:1px; background:rgba(255,255,255,0.05); margin: 20px 0;"></div>

        <div style="color: #00e5ff; font-size: 12px; font-weight: bold; margin-bottom: 15px;">Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ©</div>
        
        <div class="profile-item" onclick="window.location.href='blocked.html'">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="p-item-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                    <i class="fa-solid fa-ban"></i>
                </div>
                <div class="p-item-text">
                    <span style="color:#fff; font-size:14px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span>
                    <small style="color:#64748b; font-size:11px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡</small>
                </div>
            </div>
            <i class="fa-solid fa-chevron-left" style="font-size: 14px; color: #64748b;"></i>
        </div>

    </div>
</div>
<div id="uploadConfirmModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="modal-icon-box" style="background: rgba(59, 130, 246, 0.15); color: #3b82f6;">
            <i class="fa-solid fa-file-import"></i>
        </div>
        
        <div class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
        
        <div class="confirm-desc" id="uploadFileName">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ</div>
        
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel" onclick="closeUploadModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm" onclick="processFileAndSend()" style="background: #3b82f6; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);">
                Ø¥Ø±Ø³Ø§Ù„ <i class="fa-solid fa-paper-plane" style="margin-right:5px;"></i>
            </button>
        </div>
    </div>
</div>
<div id="userPopupOverlay" class="user-popup-overlay" onclick="closeUserPopup()">
    <div class="user-popup-card" onclick="event.stopPropagation()">
        
        <div class="popup-header-bg"></div>

        <div class="popup-avatar-wrapper" id="popupAvatarWrapper">
            <div id="popupAvatar" class="popup-avatar"></div>
        </div>

       <div class="popup-info">
    <div class="popup-name-row">
        <span id="popupName" class="popup-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
        
        <i id="popupVerify" class="fa-solid fa-circle-check popup-verify" style="display:none;"></i>
    </div>
    
    <span id="popupBio" class="popup-bio" style="margin-top:8px;">Ù…Ø³ØªØ®Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ±ÙŠØ¯</span>
</div>

        <div class="popup-actions-grid">
            
          <button class="popup-btn primary" onclick="openNicknameInput()">
    <i class="fa-solid fa-pen-to-square"></i> ØªØ¹ÙŠÙŠÙ† Ù„Ù‚Ø¨
</button>


            <button class="popup-btn secondary" onclick="viewFullProfileFromPopup()">
                <i class="fa-regular fa-user"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            </button>
            
            <button class="popup-btn secondary block-btn" onclick="toggleBlockUser()">
                <i class="fa-solid fa-ban"></i> Ø­Ø¸Ø±
            </button>

        </div>
    </div>
</div>



<div id="nicknameModal" class="nickname-modal-overlay">
    <div class="nickname-card">
        <h3 style="color:#fff; margin-bottom:5px;">ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ù‚Ø¨</h3>
        <p style="color:#94a3b8; font-size:12px;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.</p>
        
        <input type="text" id="nicknameInput" class="nickname-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù„Ù‚Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯..." autocomplete="off">
        
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('nicknameModal').style.display='none'" class="btn-modal btn-cancel" style="flex:1; color:#fff;">Ø¥Ù„ØºØ§Ø¡</button>
          <button onclick="saveSharedNickname()" class="btn-modal btn-send" style="flex:1; background: linear-gradient(135deg, #00e5ff, #2979ff);">Ø­ÙØ¸</button>

        </div>
    </div>
</div>

<div id="nicknameSelectModal" class="confirm-modal-overlay">
    <div class="confirm-modal" style="text-align: right;">
        <h3 style="color:#fff; margin-bottom:20px; text-align:center;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</h3>
        
        <div class="profile-item" onclick="startEditNickname(currentUserId)" style="margin-bottom:10px;">
            <div class="p-item-icon" style="background: rgba(255,255,255,0.1); color:#fff;">
                <div id="myAvatarSmall" class="s-avatar" style="width:30px; height:30px; font-size:12px;"></div>
            </div>
            <div class="p-item-text">
                <span>ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ÙŠ</span>
                <small style="color:#94a3b8;" id="myCurrentNick">ØªØ¹ÙŠÙŠÙ† Ù„Ù‚Ø¨</small>
            </div>
        </div>

        <div class="profile-item" onclick="startEditNickname(cachedOtherUserId)">
            <div class="p-item-icon" style="background: rgba(255,255,255,0.1); color:#fff;">
                <div id="friendAvatarSmall" class="s-avatar" style="width:30px; height:30px; font-size:12px;"></div>
            </div>
            <div class="p-item-text">
                <span id="friendNameLabel">ØªØºÙŠÙŠØ± Ù„Ù‚Ø¨ Ø§Ù„ØµØ¯ÙŠÙ‚</span>
                <small style="color:#94a3b8;" id="friendCurrentNick">ØªØ¹ÙŠÙŠÙ† Ù„Ù‚Ø¨</small>
            </div>
        </div>

        <button onclick="document.getElementById('nicknameSelectModal').style.display='none'" class="btn-modal btn-cancel" style="margin-top:20px; width:100%;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
<div id="nicknamesPage" class="profile-page" style="display:none; z-index: 200000;">
    
    <div class="pp-header">
        <div class="icon-btn" onclick="closeNicknamesPage()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3>Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</h3>
        <div style="width: 40px;"></div> </div>

    <div class="pp-content">
        <div style="color: #00e5ff; font-size: 12px; font-weight: bold; margin-bottom: 10px; padding: 0 5px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨</div>

        <div class="profile-item" onclick="startEditNickname(currentUserId)">
            <div class="p-item-icon" style="background: rgba(255,255,255,0.1); color:#fff; border-radius: 50%; overflow: hidden; padding: 0;">
                <div id="pageMyAvatar" style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center; font-size:14px;">ME</div>
            </div>
            <div class="p-item-text">
                <span>ØªØ¹ÙŠÙŠÙ† Ù„Ù‚Ø¨ Ù„ÙŠ</span>
                <small style="color:#94a3b8;" id="pageMyNick">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
            </div>
            <div class="p-item-arrow"><i class="fa-solid fa-pen" style="font-size: 12px;"></i></div>
        </div>

        <div class="profile-item" onclick="startEditNickname(cachedOtherUserId)">
            <div class="p-item-icon" style="background: rgba(255,255,255,0.1); color:#fff; border-radius: 50%; overflow: hidden; padding: 0;">
                <div id="pageFriendAvatar" style="width:100%; height:100%; background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center; font-size:14px;">U</div>
            </div>
            <div class="p-item-text">
                <span id="pageFriendLabel">ØªØ¹ÙŠÙŠÙ† Ù„Ù‚Ø¨ Ù„Ù„ØµØ¯ÙŠÙ‚</span>
                <small style="color:#94a3b8;" id="pageFriendNick">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
            </div>
            <div class="p-item-arrow"><i class="fa-solid fa-pen" style="font-size: 12px;"></i></div>
        </div>

    </div>
</div>
<div id="simpleStoryViewer" style="display:none;">
    <div class="story-progress-container">
        <div class="story-progress-bar" id="storyProgressBar"></div>
    </div>
    <div class="story-user-top">
        <img id="storyUserImg" src="https://i.ibb.co/tZ5tPqB/default-avatar.png" onerror="this.src='https://i.ibb.co/tZ5tPqB/default-avatar.png'" style="width: 35px; height: 35px; border-radius: 50%; border: 1px solid #fff; object-fit: cover;">
        
        <div style="display: flex; align-items: center; gap: 5px; margin-right: 10px;">
            <span id="storyUserName" style="color: #fff; font-weight: bold; font-size: 14px; font-family: 'Cairo', sans-serif;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
            
            <i id="storyVerifyIcon" class="fa-solid fa-circle-check" style="color: #38bdf8; font-size: 14px; display: none;"></i>
        </div>
        
        <span id="storyTime" style="font-size: 11px; opacity: 0.8; color: #ccc; margin-right: auto;"></span>
    </div>



 <div class="close-story-btn" onclick="closeStoryViewer()">
    <i class="fa-solid fa-xmark"></i>
</div>


    <div class="story-content-wrapper">
        <img id="storyImgDisplay" class="story-media-element" style="display:none;">
        <video id="storyVideoDisplay" class="story-media-element" style="display:none;" playsinline webkit-playsinline></video>
    </div>

    <div class="story-touch-area left" onclick="prevStoryItem()"></div>
    <div class="story-touch-area right" onclick="nextStoryItem()"></div>
</div>
<div class="bottom-sheet-overlay" id="giftCenterModal" onclick="closeGiftCenter()">
    <div class="bottom-sheet gift-sheet" onclick="event.stopPropagation()">
        
        <div class="gift-header-top">
            <div class="user-balance-box">
                <span style="font-size:12px; color:#ccc;">Ø±ØµÙŠØ¯Ùƒ:</span>
                <span id="centerCoinsDisplay" class="coin-num">0</span>
                <i class="fa-solid fa-coins" style="color:#FFD700;"></i>
            </div>
            <button class="add-coins-btn" onclick="openRechargeModal()">Ø´Ø­Ù† +</button>
        </div>

     <div class="gift-tabs">
    <div class="gift-tab active" onclick="switchGiftTab('premium', this)">
        <i class="fa-solid fa-gem"></i> Ù…Ù…ÙŠØ²Ø©
    </div>
    <div class="gift-tab" onclick="switchGiftTab('free', this)">
        <i class="fa-regular fa-face-smile"></i> Ù…Ù„ØµÙ‚Ø§Øª
    </div>
    <div class="gift-tab" onclick="switchGiftTab('gifs', this)">
        <i class="fa-solid fa-clapperboard"></i> ØµÙˆØ± GIF
    </div>
    <div class="gift-tab" onclick="switchGiftTab('favorites', this)">
        <i class="fa-solid fa-star" style="color: #FFD700;"></i> Ø§Ù„Ù…ÙØ¶Ù„Ø©
    </div>
</div>
<div id="tab-premium" class="gift-content-panel active">
    <div class="gift-grid" id="premiumGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
</div>


<div id="tab-free" class="gift-content-panel">
    <div class="stickers-grid" id="stickersGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
</div>
<div id="tab-gifs" class="gift-content-panel">
    <div class="gif-search-container" style="padding: 10px; position: sticky; top: 0; background: #121212; z-index: 10;">
        <div style="display: flex; gap: 5px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 5px 10px; align-items: center;">
            <i class="fa-solid fa-magnifying-glass" style="color: #888;"></i>
            <input type="text" id="gifSearchInput" placeholder="Ø¨Ø­Ø«..." 
                   style="flex: 1; background: transparent; border: none; color: #fff; padding: 8px; outline: none;"
                   onkeyup="handleGifSearch(this.value)">
            <i class="fa-solid fa-xmark" onclick="clearGifSearch()" style="color: #888; cursor: pointer; display: none;" id="clearGifBtn"></i>
        </div>
    </div>
    <div id="gifsGrid"></div>
</div>

<div id="tab-favorites" class="gift-content-panel">
    <div style="text-align:center; padding:10px; color:#888; font-size:11px;">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù†ØµØ± Ù„Ø­Ø°ÙÙ‡</div>
    <div id="favoritesGrid" class="gift-grid" style="grid-template-columns: repeat(3, 1fr);"></div>
</div>


<div id="rechargeModal" class="confirm-modal-overlay">
    <div class="confirm-modal" style="text-align: center;">
        <div class="modal-icon-box" style="background: rgba(255, 215, 0, 0.1); color: #FFD700;">
            <i class="fa-solid fa-gem"></i>
        </div>
        <div class="confirm-title">Ø´Ø­Ù† Ø±ØµÙŠØ¯</div>
        <div class="confirm-desc">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ</div>
        
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">
            <div onclick="processRecharge(100, 1.99)" style="display:flex; justify-content:space-between; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; cursor:pointer; border:1px solid rgba(255,255,255,0.1);">
                <span style="color:#fff; font-weight:bold;">100 <i class="fa-solid fa-coins" style="color:#FFD700;"></i></span>
                <span style="color:#4ade80;">$1.99</span>
            </div>
            <div onclick="processRecharge(500, 4.99)" style="display:flex; justify-content:space-between; padding:15px; background:rgba(255, 215, 0, 0.1); border-radius:12px; cursor:pointer; border:1px solid #FFD700;">
                <span style="color:#fff; font-weight:bold;">500 <i class="fa-solid fa-coins" style="color:#FFD700;"></i></span>
                <span style="color:#4ade80;">$4.99</span>
            </div>
             <div onclick="processRecharge(1000, 9.99)" style="display:flex; justify-content:space-between; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; cursor:pointer; border:1px solid rgba(255,255,255,0.1);">
                <span style="color:#fff; font-weight:bold;">1000 <i class="fa-solid fa-coins" style="color:#FFD700;"></i></span>
                <span style="color:#4ade80;">$9.99</span>
            </div>
        </div>

        <button class="btn-modal btn-cancel" onclick="document.getElementById('rechargeModal').style.display='none'" style="width:100%;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="proVideoModal" class="pro-video-modal" style="display: none;">
    <div onclick="closeProPlayer()" style="position: absolute; top: 30px; right: 20px; width: 45px; height: 45px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 200;">
        <i class="fa-solid fa-xmark" style="color: #fff; font-size: 22px;"></i>
    </div>

  <video id="proMainVideo" class="pro-video-element" playsinline webkit-playsinline preload="auto" onclick="toggleProPlay()"></video>

<div class="pro-controls" onclick="event.stopPropagation()">
    
    <div class="pro-progress-area" id="scrubArea">
        <div class="pro-progress-bg">
            <div class="pro-progress-fill" id="proProgressBar"></div>
        </div>
        <div class="pro-progress-knob" id="proProgressKnob"></div>
    </div>

    <div id="proTimeDisplay" class="pro-time-centered">00:00 / 00:00</div>

    <div class="pro-buttons-row">
        
        <div class="btn-group">
            <button class="pro-btn" onclick="downloadProVideo()"><i class="fa-solid fa-download"></i></button>
            <button class="pro-btn" id="speedBtn" onclick="cycleSpeed()" style="font-size:12px; font-weight:bold;">1.0x</button>
        </div>

        <button class="pro-btn play-btn-large" id="proPlayBtn" onclick="toggleProPlay()">
            <i class="fa-solid fa-play"></i>
        </button>

        <div class="btn-group">
            <button class="pro-btn" onclick="skipProVideo(-10)"><i class="fa-solid fa-rotate-left"></i></button>
            <button class="pro-btn" onclick="skipProVideo(10)"><i class="fa-solid fa-rotate-right"></i></button>
        </div>

    </div>
</div>

<div id="contactModal" class="confirm-modal-overlay">
    <div class="confirm-modal" style="text-align: right;">
        <h3 style="color:#fff; margin-bottom:15px; text-align:center;">Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ ğŸ‘¤</h3>
        
        <button type="button" onclick="pickContactFromDevice()" style="width:100%; margin-bottom:15px; padding:10px; background:rgba(0, 229, 255, 0.1); border:1px solid #00e5ff; color:#00e5ff; border-radius:10px; cursor:pointer; font-weight:bold;">
            <i class="fa-solid fa-address-book"></i> Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ
        </button>

        <p style="text-align:center; color:#666; font-size:12px; margin-bottom:10px;">- Ø£Ùˆ Ø§ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹ -</p>
        
        <input type="text" id="contactName" class="nickname-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ" style="margin-bottom:10px; text-align:right;">
        <input type="tel" id="contactNumber" class="nickname-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="margin-bottom:20px; text-align:right; direction:ltr;">
        
        <div style="display:flex; gap:10px;">
            <button type="button" onclick="document.getElementById('contactModal').style.display='none'" class="btn-modal btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="button" onclick="sendContactMessage()" class="btn-modal btn-send">Ù…Ø´Ø§Ø±ÙƒØ©</button>
        </div>
    </div>
</div>

<div id="pollModal" class="confirm-modal-overlay">
    <div class="confirm-modal" style="text-align: right;">
        <h3 style="color:#fff; margin-bottom:15px; text-align:center;">Ø¥Ù†Ø´Ø§Ø¡ ØªØµÙˆÙŠØª ğŸ“Š</h3>
        
        <input type="text" id="pollQuestion" class="nickname-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„..." style="margin-bottom:15px; text-align:right;">
        
        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;">
            <input type="text" id="pollOpt1" class="nickname-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" style="text-align:right;">
            <input type="text" id="pollOpt2" class="nickname-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" style="text-align:right;">
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('pollModal').style.display='none'" class="btn-modal btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="sendPollMessage()" class="btn-modal btn-send">Ù†Ø´Ø±</button>
        </div>
    </div>
</div>

<div id="pageLockModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999999; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(20px);">
    
    <div style="width: 80px; height: 80px; background: rgba(139, 92, 246, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; border: 2px solid #8b5cf6; box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);">
        <i class="fa-solid fa-lock" style="font-size: 35px; color: #fff;"></i>
    </div>

    <h3 style="color: #fff; margin-bottom: 10px; font-family: 'Cairo';">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù…ÙŠØ©</h3>
    <p style="color: #aaa; font-size: 14px; margin-bottom: 30px;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± Ù„ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>

    <div style="background: #1a1a1a; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; border: 1px solid rgba(255,255,255,0.1); text-align: center;">
        
        <input type="password" id="pageLockInput" maxlength="6" inputmode="numeric" placeholder="******" 
               style="width: 100%; background: #0d0d0f; border: 1px solid #333; padding: 15px; border-radius: 12px; color: #fff; text-align: center; font-size: 24px; letter-spacing: 8px; outline: none; margin-bottom: 20px;">
        
        <button onclick="unlockPage()" style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: #fff; padding: 12px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-bottom: 10px;">
            ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ”“
        </button>

        <button onclick="history.back()" style="width: 100%; background: transparent; color: #777; padding: 10px; border: none; font-size: 14px; cursor: pointer;">
            Ø®Ø±ÙˆØ¬
        </button>
    </div>
</div>


</body>
</html>