<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050b14">

    <title>Wareed Chat - Professional</title>
.    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ±ÙŠØ¯ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Wareed Style) ================= */
        :root { 
            --bg-primary: #050b14; /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
            --bg-secondary: #0f1926; /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            --accent-color: #00e5ff; /* Ø§Ù„Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ø¶ÙŠØ¡ */
            --accent-gradient: linear-gradient(135deg, #00e5ff, #2979ff); /* ØªØ¯Ø±Ø¬ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
            --msg-sender: linear-gradient(135deg, #0066cc, #00c6ff); /* ØªØ¯Ø±Ø¬ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„ */
            --msg-receiver: rgba(255, 255, 255, 0.08); /* Ø²Ø¬Ø§Ø¬ÙŠ Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ */
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 25, 38, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body {
    height: 100%;       /* Ø§Ù„ØµÙØ­Ø© ØªØ§Ø®Ø¯ Ø·ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    margin: 0;
    padding: 0;
    overflow: hidden;   /* Ù…Ù†Ø¹ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ */
}

body {
    display: flex;              /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø³Ù… Ù„Ø­Ø§ÙˆÙŠØ© Ù…Ø±Ù†Ø© */
    flex-direction: column;     /* ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙˆÙ‚ Ø¨Ø¹Ø¶ */
    background-color: #0b1121;
    /* ... Ø¨Ø§Ù‚ÙŠ Ø®Ù„ÙÙŠØªÙƒ ÙˆØ£Ù„ÙˆØ§Ù†Ùƒ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ ... */
    background-image: ...; /* Ø³ÙŠØ¨ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø²ÙŠ Ù…Ø§ ÙƒØ§Ù†Øª Ø¹Ù†Ø¯Ùƒ */
}


.chat-header { 
    /* Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ù…ÙƒØ§Ù† */
    position: sticky; 
    top: 15px; 
    z-index: 100;
    
    /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ù€ 85px Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ù…Ø±ÙŠØ­ ÙˆØ´ÙŠÙƒ */
    height: 85px; 
    margin: 0 15px; /* Ù‡ÙˆØ§Ù…Ø´ Ø¬Ø§Ù†Ø¨ÙŠØ© */
    padding: 0 18px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
    
    /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
    background: rgba(11, 17, 33, 0.90); /* ØªØºÙ…ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ù„ÙˆØ¶ÙˆØ­ */
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    
    /* Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© */
    border-radius: 28px !important; /* ØªØ¯ÙˆÙŠØ± Ø£ÙƒØ¨Ø± Ø³Ù†Ø© */
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); /* Ø¸Ù„ Ø£Ù‚ÙˆÙ‰ Ù„Ù„Ø¹Ù…Ù‚ */
    
    display: flex; 
    align-items: center; 
    justify-content: space-between;
}

/* Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù† */
.header-right-section { display: flex; align-items: center; gap: 15px; }

/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
.back-btn { 
    font-size: 22px; color: #94a3b8; 
    padding: 10px; border-radius: 50%;
    cursor: pointer; transition: 0.2s; 
}
.back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

/* === ØªÙƒØ¨ÙŠØ± Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ === */
.user-avatar-container { 
    position: relative; 
    width: 54px; height: 54px; /* ÙƒØ¨Ø±Ù†Ø§Ù‡Ø§ Ù…Ù† 48 Ù„Ù€ 54 */
    border-radius: 50%; 
    padding: 2px;
    background: linear-gradient(135deg, #00e5ff, #2979ff); 
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4); 
    cursor: pointer;
}

.header-avatar { 
    width: 100%; height: 100%; 
    border-radius: 50%; 
    background-color: #0b1121; 
    background-size: cover; background-position: center;
    border: 2px solid #0b1121; 
    display: grid; place-items: center;
    color: #fff; font-weight: bold;
}

/* Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
.online-status { 
    position: absolute; bottom: 2px; left: 2px; 
    width: 13px; height: 13px; 
    background: #10b981; 
    border-radius: 50%; 
    border: 2px solid #0b1121;
    box-shadow: 0 0 8px #10b981;
}

/* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.header-info { display: flex; flex-direction: column; justify-content: center; }

.header-info h3 { 
    margin: 0; font-size: 18px; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø³Ù†Ø© */
    font-weight: 700; color: #fff; 
    letter-spacing: 0.5px;
    display: flex; align-items: center; gap: 5px;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.verify-badge { color: #38bdf8; font-size: 15px; margin-right: 3px; }

.status-text { 
    font-size: 13px; font-weight: 500; 
    background: linear-gradient(to right, #00e5ff, #2979ff); 
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0.9; 
    margin-top: 2px;
}

.typing-text { 
    font-size: 12px; color: #38bdf8; font-weight: bold; 
    display: none; animation: fadeIn 0.3s; 
}

/* === ØªÙƒØ¨ÙŠØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ === */
.header-actions { display: flex; gap: 12px; }

.icon-btn {
    width: 48px; height: 48px; /* ÙƒØ¨Ø±Ù†Ø§Ù‡Ø§ Ù…Ù† 42 Ù„Ù€ 48 */
    border-radius: 14px; /* Squircle Ø£ÙƒØ¨Ø± */
    background: rgba(255, 255, 255, 0.05); 
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex; align-items: center; justify-content: center;
    color: #e2e8f0; font-size: 20px; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
    cursor: pointer; transition: 0.3s;
}

.icon-btn:hover { 
    background: rgba(0, 229, 255, 0.15); 
    color: #00e5ff; 
    border-color: rgba(0, 229, 255, 0.3);
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.2);
    transform: translateY(-2px);
}

.icon-btn:active { transform: scale(0.95); }
.icon-btn.video { color: #00e5ff; }


/* Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù† */
.header-right-section { display: flex; align-items: center; gap: 15px; }

/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
.back-btn { 
    font-size: 20px; color: #94a3b8; 
    padding: 8px; border-radius: 50%;
    cursor: pointer; transition: 0.2s; 
}
.back-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.back-btn:active { transform: scale(0.9); }

/* === Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© (Ø­Ù„Ù‚Ø© Ù†ÙŠÙˆÙ†) === */
.user-avatar-container { 
    position: relative; 
    width: 48px; height: 48px; 
    border-radius: 50%; 
    padding: 2px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
    background: linear-gradient(135deg, #00e5ff, #2979ff); 
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); 
    cursor: pointer;
}

.header-avatar { 
    width: 100%; height: 100%; 
    border-radius: 50%; 
    background-color: #0b1121; 
    background-size: cover; background-position: center;
    border: 2px solid #0b1121; 
    display: grid; place-items: center;
    color: #fff; font-weight: bold;
}

/* Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
.online-status { 
    position: absolute; bottom: 0; left: 0; 
    width: 12px; height: 12px; 
    background: #10b981; 
    border-radius: 50%; 
    border: 2px solid #0b1121;
    box-shadow: 0 0 8px #10b981;
}

/* === Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… === */
.header-info { display: flex; flex-direction: column; justify-content: center; }

.header-info h3 { 
    margin: 0; font-size: 17px; font-weight: 700; color: #fff; 
    letter-spacing: 0.5px;
    display: flex; align-items: center; gap: 5px;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
}

/* Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ù…Ù‡Ù…Ø© Ø¹Ø´Ø§Ù† Ù…ØªØ¨ÙˆØ¸Ø´) */
.verify-badge { color: #38bdf8; font-size: 14px; margin-right: 3px; }

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ù†Øµ Ù…ØªØ¯Ø±Ø¬) */
.status-text { 
    font-size: 12px; font-weight: 500; 
    background: linear-gradient(to right, #00e5ff, #2979ff); 
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0.9; 
}

/* Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…Ù‡Ù…Ø©) */
.typing-text { 
    font-size: 11px; color: #38bdf8; font-weight: bold; 
    display: none; animation: fadeIn 0.3s; 
}

/* === Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯) === */
.header-actions { display: flex; gap: 10px; }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙÙŠØ¯ÙŠÙˆ / ØµÙˆØª) */
.icon-btn {
    width: 44px; height: 44px;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.03); /* Ø´ÙØ§Ù ÙÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: flex; align-items: center; justify-content: center;
    color: #cbd5e1;
    font-size: 19px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
}

/* Ø²Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ - ØªØ¯Ø±Ø¬ Ø³Ù…Ø§ÙˆÙŠ Ù…Ø´Ø±Ù‚ */
.icon-btn.video:hover {
    background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
    transform: translateY(-2px);
}

/* Ø²Ø± Ø§Ù„ØµÙˆØª - ØªØ¯Ø±Ø¬ Ø£Ø®Ø¶Ø± ÙÙŠØ±ÙˆØ²ÙŠ */
.icon-btn.audio:hover {
    background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
}

.icon-btn:active { transform: scale(0.95); }

        .icon-btn:active { transform: scale(0.9); background: rgba(0, 229, 255, 0.1); }
        .icon-btn.video { color: #00e5ff; }
        .icon-btn.audio { color: #fff; }

        /* ================= Ø¬Ø³Ù… Ø§Ù„Ø´Ø§Øª ================= */
       .chat-body { 
    flex: 1; overflow-y: auto; padding: 20px 15px; 
    display: flex; flex-direction: column; gap: 20px; width: 100%; 
    /* ØªÙ… Ø­Ø°Ù scroll-behavior */
    padding-bottom: 90px;
}

@keyframes messagePop {
    0% { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95); 
    }
    100% { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

        .msg-row { display: flex; width: 100%; align-items: flex-end; gap: 10px; position: relative; animation: fadeInSlide 0.3s ease; }
        .msg-row.sender { justify-content: flex-end; }
        .msg-row.receiver { justify-content: flex-start; }
        
        .msg-user-avatar { 
            width: 32px; height: 32px; border-radius: 50%; 
            background: #333; flex-shrink: 0; background-size: cover; 
            display: none; place-items: center; font-size: 10px; color: #fff; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .receiver .msg-user-avatar { display: grid; }

        .msg-bubble { 
            padding: 12px 16px; border-radius: 20px; max-width: 75%; 
            font-size: 15px; line-height: 1.5; position: relative; word-wrap: break-word; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
        }
        
        .sender .msg-bubble { 
            background: var(--msg-sender); 
            color: #fff; 
            border-bottom-right-radius: 4px; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .receiver .msg-bubble { 
            background: var(--msg-receiver); 
            color: #e2e8f0; 
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .msg-time {
            font-size: 9px; opacity: 0.7; margin-top: 4px; display: block; text-align: left;
        }
        .sender .msg-time { text-align: right; color: rgba(255,255,255,0.8); }

        /* ================= Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆÙ…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ================= */
       /* ================= Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆÙ…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ù…Ø³ØªØ¯ÙŠØ±Ø©) ================= */

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
.media-container { 
    /* Ø¬Ø¹Ù„ Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø³ØªØ¯ÙŠØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø«Ù„ Ø§Ù„ÙÙˆØªØ± */
    border-radius: 25px !important; 
    overflow: hidden; 
    margin-top: 5px; 
    border: 1px solid rgba(255,255,255,0.15); 
    position: relative; 
    min-width: 200px; min-height: 150px; 
    background: #000; 
    display: flex; justify-content: center; align-items: center; 
    cursor: pointer; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ø®ÙÙŠÙ */
}

.msg-image, .msg-video { 
    max-width: 100%; max-height: 300px; 
    object-fit: cover; display: block; 
}

/* Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯) */
.custom-audio-player { 
    display: flex; align-items: center; gap: 10px; 
    width: 240px; /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ */
    padding: 8px 12px;
    /* Ø¬Ø¹Ù„ Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø³ØªØ¯ÙŠØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    border-radius: 25px !important;
    background: rgba(255,255,255,0.08); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
    border: 1px solid rgba(255,255,255,0.1);
    margin-top: 5px;
    backdrop-filter: blur(5px);
}

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´ØºÙ„ */
.play-btn { 
    background: var(--accent-gradient); /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ */
    color: #fff; border: none; 
    width: 38px; height: 38px; 
    border-radius: 50%; /* Ø¯Ø§Ø¦Ø±ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    display: grid; place-items: center; 
    cursor: pointer; transition: 0.2s;
    box-shadow: 0 2px 10px rgba(0, 229, 255, 0.3);
    flex-shrink: 0;
}
.play-btn:active { transform: scale(0.9); }

/* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª */
.audio-slider { 
    flex: 1; height: 4px; accent-color: var(--accent-color); border-radius: 2px;
}

/* ØªÙˆÙ‚ÙŠØª Ø§Ù„ØµÙˆØª */
.audio-duration {
    font-size: 11px; color: #cbd5e1; min-width: 35px; text-align: center;
}

        /* ================= Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¹Ø§Ø¦Ù… (Floating Footer) ================= */
       /* ================= ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØªØ± (Messenger Style) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø£Ø³ÙÙ„ */
/* ================= Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Cockpit Style Footer) ================= */

/* ================= Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ø´ÙƒÙ„ + ÙˆØ¸Ø§Ø¦Ù) ================= */

.chat-footer {
    position: fixed;
    bottom: 20px; left: 15px; right: 15px;
    z-index: 100;
    
    background: rgba(11, 17, 33, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    border-radius: 30px; /* ØªØ¯ÙˆÙŠØ± Ø§Ù„ÙÙˆØªØ± Ù†ÙØ³Ù‡ */
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    
    display: flex;
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ğŸ‘‡: Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø£Ø³ÙÙ„ */
    align-items: flex-end; 
    padding: 8px 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ Ø´ÙˆÙŠØ© */
    min-height: 60px;
    gap: 8px;
}


/* === 1. Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Absolute Ø¹Ø´Ø§Ù† Ù…ÙŠØ¨ÙˆØ¸Ø´ Ø§Ù„Ø´ÙƒÙ„) === */
.reply-preview-bar {
    position: absolute;
    bottom: 100%; /* ÙÙˆÙ‚ Ø§Ù„ÙÙˆØªØ± Ù…Ø¨Ø§Ø´Ø±Ø© */
    left: 15px; right: 15px; /* Ù†ÙØ³ Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØªØ± */
    height: 50px;
    background: rgba(30, 41, 59, 0.95);
    border-radius: 15px 15px 0 0;
    border: 1px solid rgba(255,255,255,0.1);
    border-bottom: none;
    display: none; /* Ù…Ø®ÙÙŠ ÙˆÙ‡ÙŠØªÙØ¹Ù„ Ø¨Ø§Ù„Ù€ JS */
    align-items: center;
    padding: 0 15px;
    z-index: 1999;
    backdrop-filter: blur(10px);
}
.reply-content { flex: 1; overflow: hidden; }
.reply-title { color: #00e5ff; font-size: 12px; font-weight: bold; }
.reply-text { color: #cbd5e1; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* === 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Absolute ØªØºØ·ÙŠ Ø§Ù„ÙÙˆØªØ± ÙƒÙ„Ù‡) === */
.recording-ui {
    position: absolute;
    inset: 0; /* ØªØºØ·ÙŠ Ø§Ù„ÙÙˆØªØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    background: #1e293b;
    border-radius: 35px;
    z-index: 2005;
    display: none; /* Ù…Ø®ÙÙŠ */
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
}
/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© */
.rec-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
.wave-bar { width: 3px; background: #ff3b30; border-radius: 2px; animation: wave 1s infinite ease-in-out; }
@keyframes wave { 0%, 100% { transform: scaleY(0.5); opacity: 0.5; } 50% { transform: scaleY(1); opacity: 1; } }

/* === 3. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø²Ø±Ø§ÙŠØ± (Grouping) === */
.footer-side-actions {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0; /* Ù…Ù…Ù†ÙˆØ¹ ÙŠÙ†ÙƒÙ…Ø´ */
}

/* === 4. Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© (ÙŠØ§Ø®Ø¯ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¨Ø§Ù‚ÙŠØ©) === */
.input-container {
    flex: 1;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 20px; /* ØªØ¯ÙˆÙŠØ± Ø£Ù‚Ù„ Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ø´ÙƒÙ„Ù‡ Ø­Ù„Ùˆ ÙˆÙ‡Ùˆ ÙƒØ¨ÙŠØ± */
    padding: 10px 15px;  /* ØªØ¸Ø¨ÙŠØ· Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
    display: flex;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.05);
    
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù… Ù‡Ù†Ø§ ğŸ‘‡ */
    height: auto !important; /* ÙŠÙ„ØºÙŠ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø«Ø§Ø¨Øª */
    min-height: 45px;        /* Ø£Ù‚Ù„ Ø§Ø±ØªÙØ§Ø¹ */
    max-height: 140px;       /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ù‚Ø¨Ù„ Ù…Ø§ ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ */
    overflow-y: auto;        /* Ø³ÙƒØ±ÙˆÙ„ Ù„Ùˆ Ø§Ù„ÙƒÙ„Ø§Ù… Ø²Ø§Ø¯ Ø£ÙˆÙŠ */
    transition: 0.2s;
}

.input-container:focus-within { background: rgba(0,0,0,0.4); border-color: rgba(0,229,255,0.3); }

.chat-input {
    width: 100%; background: transparent; border: none; color: #fff;
    font-size: 15px; resize: none; height: 24px; padding: 0;
    max-height: 100px; overflow-y: auto; font-family: inherit;
}

/* === 5. Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø²Ø±Ø§ÙŠØ± === */
/* ================= ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ================= */

/* ================= Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙˆØªØ± (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) ================= */

/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
.action-btn {
    width: 42px; height: 42px;
    border-radius: 14px; /* ØªØ¯ÙˆÙŠØ± Squircle Ø­Ø¯ÙŠØ« */
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 19px;
    margin-bottom: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* ØªØ£Ø«ÙŠØ± Ø²Ø¬Ø§Ø¬ÙŠ Ø¹Ø§Ù… */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* 1. Ø²Ø± Ø§Ù„ØµÙˆØ± (Media) - Ù„ÙˆÙ† Ù…ÙˆÙ/Ø¨Ù†ÙØ³Ø¬ÙŠ Ù‡Ø§Ø¯ÙŠ */
.media-btn {
    background: rgba(192, 132, 252, 0.08); /* Ø®Ù„ÙÙŠØ© Ø¨Ù†ÙØ³Ø¬ÙŠ Ø´ÙØ§Ù Ø¬Ø¯Ø§Ù‹ */
    border: 1px solid rgba(192, 132, 252, 0.15); /* Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© */
    color: #d8b4fe; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø§ÙÙ†Ø¯Ø± ÙØ§ØªØ­ */
}

/* 2. Ø²Ø± Ø§Ù„Ù…Ù„ÙØ§Øª (File) - Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù‡Ø§Ø¯ÙŠ */
.file-btn {
    background: rgba(251, 191, 36, 0.08); /* Ø®Ù„ÙÙŠØ© Ø°Ù‡Ø¨ÙŠ Ø´ÙØ§Ù */
    border: 1px solid rgba(251, 191, 36, 0.15);
    color: #fcd34d; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø°Ù‡Ø¨ÙŠ */
}

/* 3. Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± (Destruct) - Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø®Ø§ÙØª */
.destruct-btn {
    background: rgba(248, 113, 113, 0.08); /* Ø®Ù„ÙÙŠØ© Ø£Ø­Ù…Ø± Ø´ÙØ§Ù */
    border: 1px solid rgba(248, 113, 113, 0.15);
    color: #fca5a5; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
}

/* ØªØ­Ø³ÙŠÙ†: Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± Ù„Ù…Ø§ ÙŠØ´ØªØºÙ„ ÙŠØ¨Ù‚Ù‰ Ø£Ø­Ù…Ø± ØµØ±ÙŠØ­ */
.destruct-btn.active {
    background: rgba(220, 38, 38, 0.2) !important;
    border-color: #ef4444 !important;
    color: #ff0000 !important;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
}

/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ */
.send-btn {
    width: 45px; height: 45px; border-radius: 50%;
    background: linear-gradient(135deg, #00e5ff, #2979ff);
    color: #fff; display: none; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); font-size: 18px;
    margin-bottom: 2px; /* Ø±ÙØ¹Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    flex-shrink: 0;     /* Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */

}
.mic-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.05); color: #fff;
    margin-bottom: 2px; /* Ø±ÙØ¹Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    flex-shrink: 0;     /* Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */

}

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .recording-ui { 
            position: absolute; inset: 0; 
            background: #1e293b; 
            border-radius: 25px; z-index: 2005; 
            display: none; align-items: center; justify-content: space-between; 
            padding: 0 20px;
            animation: slideUpFade 0.2s ease;
        }
        .rec-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
        .wave-bar { width: 3px; background: var(--danger); border-radius: 2px; animation: wave 1s infinite ease-in-out; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 25px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 15px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 10px; }
        @keyframes wave { 0%, 100% { transform: scaleY(0.5); opacity: 0.5; } 50% { transform: scaleY(1); opacity: 1; } }

        /* ================= Ø§Ù†ÙŠÙ…ÙŠØ´Ù† ================= */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpFade { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ================= Ø¹Ù†Ø§ØµØ± Ø¥Ø¶Ø§ÙÙŠØ© (Ù‚ÙˆØ§Ø¦Ù…ØŒ Ù…ÙƒØ§Ù„Ù…Ø§Øª) ================= */
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .context-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: flex-end; backdrop-filter: blur(2px); }
        .context-menu { background: #1e293b; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; transform: translateY(100%); transition: 0.3s; color: #fff; border-top: 1px solid rgba(255,255,255,0.1); }
        .context-menu.active { transform: translateY(0); }
        .menu-btn { background: rgba(255,255,255,0.05); color: #fff; border: none; padding: 15px; border-radius: 12px; font-size: 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px; width: 100%; transition: 0.2s; }
        .menu-btn:active { background: rgba(255,255,255,0.1); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
        
        /* Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© */
        /* ================= Ø¥ØµÙ„Ø§Ø­ Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯ (ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹) ================= */

/* 1. Ø§Ù„Ø´Ø±ÙŠØ· Ù†ÙØ³Ù‡ (Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª) */
.reply-preview-bar {
    position: absolute;
    bottom: 100%; /* ÙÙˆÙ‚ Ø§Ù„ÙÙˆØªØ± Ù…Ø¨Ø§Ø´Ø±Ø© */
    left: 0; 
    right: 0;
    height: 50px !important; /* ğŸ‘ˆ Ø¯Ù‡ Ø£Ù‡Ù… Ø³Ø·Ø±: Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª Ù…Ù…Ù†ÙˆØ¹ ÙŠØ²ÙŠØ¯ */
    background: rgba(30, 41, 59, 0.98); /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ø§Ù† */
    border-top: 1px solid rgba(255,255,255,0.1);
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 50;
    overflow: hidden; /* Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ²ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù€ 50 Ø¨ÙƒØ³Ù„ ØªØ®ØªÙÙŠ */
    border-radius: 15px 15px 0 0;
    margin: 0 10px;
    border-left: 4px solid var(--accent-color);
}

/* 2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒÙ„Ø§Ù… (ØªÙ…Ù†Ø¹ Ø§Ù„Ù†Øµ ÙŠØ²Ù‚ Ø§Ù„Ø´Ø±ÙŠØ·) */
.reply-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex: 1; 
    min-width: 0; /* ğŸ‘ˆ Ø³Ø­Ø± Ø§Ù„Ù€ Flexbox: Ø¨ÙŠØ¬Ø¨Ø± Ø§Ù„Ù†Øµ ÙŠØ­ØªØ±Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
    margin-right: 10px;
}

/* 3. Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ */
.reply-title {
    color: var(--accent-color);
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

/* 4. Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) */
.reply-text {
    color: #94a3b8;
    font-size: 11px;
    display: block !important;
    width: 100%;
    white-space: nowrap !important; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    overflow: hidden !important;    /* ÙŠÙ‚Øµ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© */
    text-overflow: ellipsis !important; /* ÙŠØ­Ø· ... ÙÙŠ Ø§Ù„Ø¢Ø®Ø± */
}

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
.close-reply {
    padding: 10px;
    color: #ff3b30;
    cursor: pointer;
    font-size: 16px;
}

        /* Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ */
        .destruct-btn { color: #64748b; position: relative; }
        .destruct-btn.active { color: var(--danger); animation: pulse-red 2s infinite; }
        .destruct-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 8px; padding: 2px 4px; border-radius: 4px; }
        .bomb-timer { font-size: 10px; color: var(--danger); display: flex; align-items: center; gap: 3px; background: rgba(255, 59, 48, 0.1); padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 5px; }

        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(0, 229, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0); } }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
/* Ø±Ø³Ø§Ù„Ø© ØªØ§Ø¨Ø¹Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ (Ù„ÙŠØ³Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©) */
.msg-row.same-sender {
    margin-top: 2px; /* Ù…Ø³Ø§ÙØ© Ø£Ù‚Ù„ */
}
.msg-row.same-sender .msg-user-avatar {
    visibility: hidden; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
}
.msg-row.same-sender .msg-bubble {
    border-top-left-radius: 4px; /* Ø²Ø§ÙˆÙŠØ© Ø­Ø§Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¨Ø¯Ùˆ Ù…ØªØµÙ„Ø© */
}
/* Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„ØªÙŠ Ø£Ù†Ø§ */
.msg-row.sender.same-sender .msg-bubble {
    border-top-right-radius: 4px;
}
/* ================= Ø¥Ø¶Ø§ÙØ§Øª ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø´Ø§Øª ================= */

/* 1. ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® */
.date-divider {
    display: flex; justify-content: center; margin: 20px 0; 
    position: sticky; top: 10px; z-index: 5;
}
.date-divider span {
    background: rgba(15, 25, 38, 0.85); /* Ù†ÙØ³ Ù„ÙˆÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± */
    padding: 4px 12px; border-radius: 12px;
    font-size: 11px; color: #94a3b8; 
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* 2. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ) */
.msg-row.same-sender {
    margin-top: 2px !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© */
    animation: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ø±ÙØ© */
}
.msg-row.same-sender .msg-user-avatar {
    opacity: 0; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© */
}
/* ØªØ¹Ø¯ÙŠÙ„ Ø²ÙˆØ§ÙŠØ§ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¹Ø´Ø§Ù† ØªØ¨Ø§Ù† Ù…ØªØµÙ„Ø© */
.msg-row.sender.same-sender .msg-bubble { border-top-right-radius: 4px; }
.msg-row.receiver.same-sender .msg-bubble { border-top-left-radius: 4px; }

/* 3. Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ (Ticks) */
/* ================= ØªØµÙ…ÙŠÙ… Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø¹ÙŠÙ†) ================= */

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.msg-status {
    font-size: 12px !important; /* ÙƒØ¨Ø±Ù†Ø§ Ø§Ù„Ø®Ø· Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ¨Ø§Ù† */
    margin-left: 5px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}

/* Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù„Ø³Ù‡ Ù…Ø§ Ø§ØªØ´Ø§ÙØªØ´) */
.msg-status i {
    color: rgba(255, 255, 255, 0.5); /* Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø¨Ø§Ù‡Øª */
    font-size: 11px;
}

/* --- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Seen) --- */
.msg-status.seen-eye {
    color: #00e5ff !important; /* Ù„ÙˆÙ† Ø³ÙŠØ§Ù† ÙØ§Ù‚Ø¹ */
    text-shadow: 0 0 8px rgba(0, 229, 255, 0.6); /* ØªÙˆÙ‡Ø¬ Ù†ÙŠÙˆÙ† Ø­ÙˆÙ„ Ø§Ù„Ø¹ÙŠÙ† */
    transform: scale(1.1); /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ø´Ø§Ù† ØªØ®Ø·Ù Ø§Ù„Ø¹ÙŠÙ† */
}

.msg-status.seen-eye i {
    font-size: 13px; /* Ø§Ù„Ø¹ÙŠÙ† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ø³Ù†Ø© Ù…Ù† Ø§Ù„ØµØ­ */
}

.sender .msg-status { color: rgba(255,255,255,0.7); } /* Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ */
.msg-status.seen { color: #34b7f1; } /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */

    /* ØªÙ†Ø³ÙŠÙ‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
.preview-modal {
    position: fixed; inset: 0; 
    background: rgba(0,0,0,0.9); z-index: 8000;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}
.preview-content {
    background: #1e293b; padding: 20px; border-radius: 20px;
    width: 90%; max-width: 400px; text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}
.preview-img, .preview-vid {
    max-width: 100%; max-height: 50vh; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
}
.preview-actions {
    display: flex; gap: 15px; justify-content: center;
}
.btn-cancel, .btn-send {
    padding: 10px 25px; border-radius: 10px; border: none; cursor: pointer;
    font-family: inherit; font-weight: bold; font-size: 14px; transition: 0.2s;
}
.btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
.btn-send { background: var(--accent-gradient); color: #fff; }
.btn-cancel:active, .btn-send:active { transform: scale(0.95); }
    
.scroll-bottom-btn {
    position: fixed;
    bottom: 90px; /* ÙÙˆÙ‚ Ù…ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø´ÙˆÙŠØ© */
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(30, 41, 59, 0.9);
    color: var(--accent-color);
    border: 1px solid var(--accent-color);
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1500;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: 0.3s;
    animation: fadeIn 0.3s;
}
.scroll-bottom-btn:hover {
    background: var(--bg-secondary);
    transform: scale(1.1);
}

    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ù */
.file-card {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px 15px; border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer; transition: 0.2s; min-width: 200px;
}
.file-card:hover { background: rgba(255, 255, 255, 0.1); }
.file-icon {
    width: 40px; height: 40px; border-radius: 8px;
    background: #334155; display: grid; place-items: center;
    color: #fff; font-size: 20px;
}
.file-info { display: flex; flex-direction: column; gap: 2px; }
.file-name { font-size: 13px; font-weight: bold; color: #fff; word-break: break-all; }
.file-size { font-size: 10px; color: #94a3b8; }

   /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª */
.chat-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(0, 229, 255, 0.1); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø³Ù…Ø§ÙˆÙŠ */
    color: #00e5ff !important;
    padding: 4px 10px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 4px;
    border: 1px solid rgba(0, 229, 255, 0.2);
    transition: 0.2s;
    font-size: 13px;
}
.chat-link::before {
    content: '\f0c1'; /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Link FontAwesome */
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
}
.chat-link:hover {
    background: rgba(0, 229, 255, 0.2);
    transform: translateY(-1px);
}
/* ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· */
.link-preview-card {
    margin-top: 8px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    flex-direction: column;
    max-width: 100%;
}
.link-preview-card:hover {
    background: rgba(0, 0, 0, 0.5);
    border-color: var(--accent-color);
}
.lp-image {
    width: 100%;
    height: 140px;
    object-fit: cover;
    background: #0f1926;
}
.lp-content {
    padding: 10px;
}
.lp-title {
    font-size: 13px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.lp-desc {
    font-size: 11px;
    color: #94a3b8;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.lp-domain {
    font-size: 10px;
    color: var(--accent-color);
    margin-top: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
/* Ø­Ø§ÙˆÙŠØ© ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ */
.yt-embed-container {
    position: relative;
    padding-bottom: 56.25%; /* Ù†Ø³Ø¨Ø© 16:9 */
    height: 0;
    overflow: hidden;
    max-width: 100%;
    border-radius: 12px;
    margin-top: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: #000;
}
.yt-embed-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
/* ÙƒÙ„Ø§Ø³ Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ø§Ø¹Ù…Ø© Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Modern Bubbles) ================= */

/* 1. Ø´ÙƒÙ„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø¹Ø§Ù… */
.msg-bubble {
    padding: 8px 12px; /* Ù…Ø³Ø§ÙØ§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
    border-radius: 18px; /* ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø­ÙˆØ§Ù Ø¨Ø´ÙƒÙ„ Ù†Ø§Ø¹Ù… */
    max-width: 75%;
    font-size: 14px;
    line-height: 1.5;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø¯ ÙŠÙŠØ¬ÙŠ ÙÙˆÙ‚ Ø§Ù„Ù†Øµ */
    min-width: 120px; /* Ø¹Ø±Ø¶ Ø£Ø¯Ù†Ù‰ Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ Ù…ÙŠØ¨Ù‚Ø§Ø´ Ø±ÙÙŠØ¹ Ø£ÙˆÙŠ */
}

/* 2. Ø±Ø³Ø§Ù„ØªÙŠ Ø£Ù†Ø§ (Sender) */
/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„ (Ø£Ù†Ø§) - ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ ÙØ®Ù… */
.sender .msg-bubble {
    /* Ø§Ù„ØªØ¯Ø±Ø¬: Ù…Ù† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ù„Ø£Ø²Ø±Ù‚ */
    background: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
    color: #fff;
    
    /* Ø¸Ù„ Ø®ÙÙŠÙ Ù…Ù„ÙˆÙ† Ø¨Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Glow Effect) */
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    
    border: none;
    border-bottom-right-radius: 4px; /* Ø­Ø§ÙØ© Ø­Ø§Ø¯Ø© ØµØºÙŠØ±Ø© */
}

/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ) - Ø²Ø¬Ø§Ø¬ÙŠ ØºØ§Ù…Ù‚ */
.receiver .msg-bubble {
    background: rgba(30, 41, 59, 0.7); /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ø´ÙØ§Ù */
    backdrop-filter: blur(10px);        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ */
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.08); /* Ø­Ø¯ Ø±ÙÙŠØ¹ Ø¬Ø¯Ø§Ù‹ */
    color: #e2e8f0;
    
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    border-bottom-left-radius: 4px;
}


/* 3. Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Receiver) */
.receiver .msg-bubble {
    background: #202c33; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ø²ÙŠ ÙˆØ§ØªØ³Ø§Ø¨ */
    color: #e9edef;
    border-bottom-left-radius: 4px;
    border: none;
}
    /* ================= Ø­Ù„ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù‚Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© ================= */

/* 1. Ù‚Øµ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·) */
.reply-text {
    display: block !important;
    width: 100% !important;
    max-width: 70vw !important; /* Ø¹Ø´Ø§Ù† Ù…ÙŠØºØ·ÙŠØ´ Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØºÙ„Ø§Ù‚ */
    white-space: nowrap !important; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    overflow: hidden !important; /* ÙŠØ®ÙÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© */
    text-overflow: ellipsis !important; /* ÙŠØ­Ø· Ù†Ù‚Ø· ... */
    color: #cbd5e1;
    font-size: 12px;
}

/* 2. Ù‚Øµ Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª (Ø³Ø·Ø±ÙŠÙ† ÙÙ‚Ø·) */
.replied-body {
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important; /* ÙŠØ¸Ù‡Ø± Ø³Ø·Ø±ÙŠÙ† Ø¨Ø³ */
    -webkit-box-orient: vertical !important;
    overflow: hidden !important; /* ÙŠØ®ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ */
    white-space: normal !important; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø³Ø·Ø±ÙŠÙ† */
    text-overflow: ellipsis !important;
    color: rgba(255, 255, 255, 0.9);
    font-size: 11px;
    margin-top: 2px;
}

/* Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¯ Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒØ¨Ø±Ø´ */
.replied-msg-context {
    max-height: 52px !important; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
    overflow: hidden !important;
    justify-content: center; /* ÙŠØ®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… ÙÙŠ Ø§Ù„Ù†Øµ */
}


/* 1. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø±Ø³Ø§Ø¦Ù„ÙŠ Ø£Ù†Ø§ (Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡) */
.sender .replied-msg-context {
    /* Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ±: Ù„ÙˆÙ† Ø£Ø³ÙˆØ¯ Ø´ÙØ§Ù ÙŠØºÙ…Ù‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ */
    background: rgba(0, 0, 0, 0.25) !important; 
    border-right-color: rgba(255, 255, 255, 0.8); /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ø¨ÙŠØ¶ */
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ) */
.receiver .replied-msg-context {
    /* Ù„ÙˆÙ† Ø£Ø³ÙˆØ¯ Ø´ÙØ§Ù Ø£ØªÙ‚Ù„ Ø´ÙˆÙŠØ© */
    background: rgba(0, 0, 0, 0.3) !important;
    border-right-color: var(--accent-color); /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø³ÙŠØ§Ù† */
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø¯ */
.replied-sender {
    font-weight: 800;
    margin-bottom: 2px;
    /* Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ Ù„Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø±Ø¯ Ø¹Ø´Ø§Ù† ÙŠØ®Ø·Ù Ø§Ù„Ø¹ÙŠÙ† */
    color: #ffd700 !important; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„ÙƒÙ„Ø§Ù… */
}

/* ================= ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØµÙˆØ±Ø© ==============
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ÙˆØ¹Ù„Ø§Ù…Ø© Ø§Ù„ØµØ­ */
.msg-meta {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 4px;
    margin-top: 2px;
    font-size: 10px;
    opacity: 0.7;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù„ÙŠÙ†Ùƒ (TikTok Card) */
.link-preview-card {
    background: #1e1e1e !important; /* Ù„ÙˆÙ† Ø§ÙØªØ­ Ù…Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© */
    border-radius: 12px !important;
    margin-top: 5px;
    border: 1px solid #333;
}
.lp-title { color: #e1e1e1 !important; font-size: 13px !important; }
.lp-desc { color: #aaa !important; }
    
 
  /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ØªÙ…Ø¯Ø¯ */
.chat-input {
    width: 100%;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 15px;
    resize: none;
    font-family: inherit;
    line-height: 1.4; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ± Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… Ù…ÙŠØ¨Ù‚Ø§Ø´ Ù„Ø§Ø²Ù‚ */
    
    /* Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙŠØªØ¶Ø¨Ø· */
    height: 24px; /* Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ */
    max-height: 140px; 
    padding: 0;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ù†Øµ */
.input-container {
    align-items: center;
    min-height: 50px;
}

/* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© */
/* ================= ØªØµÙ…ÙŠÙ… Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ø¬Ø²Ø¦ÙŠÙ†: ÙÙˆÙ‚ ÙˆØªØ­Øª) */
.call-overlay { 
    position: fixed; inset: 0; 
    background: #000; 
    z-index: 9999; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† ÙŠØºØ·ÙŠ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: none; 
    flex-direction: column; 
    justify-content: space-between; /* Ø§Ù„Ø³Ø±: ÙŠØ±Ù…ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø£Ø·Ø±Ø§Ù */
    padding: 80px 30px 50px; /* Ù…Ø³Ø§ÙØ§Øª Ù…Ø±ÙŠØ­Ø© Ù…Ù† ÙÙˆÙ‚ ÙˆØªØ­Øª */
}

/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© */
.call-bg {
    position: absolute; inset: 0;
    background-size: cover; background-position: center;
    filter: blur(30px) brightness(0.4); /* ØªØ¹ØªÙŠÙ… Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠØ¨Ø§Ù† */
    z-index: 1;
    transform: scale(1.1); /* Ø¹Ø´Ø§Ù† Ù†Ø¹Ø§Ù„Ø¬ Ø­ÙˆØ§Ù Ø§Ù„Ø¨Ù„ÙˆØ± */
}

/* 2. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ (ØµÙˆØ±Ø© ÙˆØ§Ø³Ù…) */
.call-info-section {
    position: absolute; /* ØªØºÙŠÙŠØ± Ù„Ù€ Absolute */
    top: 15%; /* Ù…ÙƒØ§Ù†Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ ÙÙˆÙ‚ */
    left: 0; right: 0;
    z-index: 10;
    display: flex; flex-direction: column; align-items: center;
    transition: all 0.3s ease;
}
.video-active-mode .call-info-section {
    opacity: 0; /* Ø§Ø®ÙØ§Ø¡ Ù†Ø§Ø¹Ù… */
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ø·Ù„Ø´ Ø§Ù„Ù„Ù…Ø³ */
}
/* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø· Ø¨Ø´ÙƒÙ„ ØµØºÙŠØ± ØªØ­Øª Ø¹Ù†Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-active-mode .call-info-section.show-brief {
    opacity: 1;
    top: auto; bottom: 100px;
    transform: scale(0.8);
}

.call-avatar { 
    width: 140px; height: 140px; 
    border-radius: 50%; 
    border: 3px solid rgba(255,255,255,0.15); 
    margin-bottom: 25px; 
    background-size: cover; background-position: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªÙ†ÙØ³ */
    animation: breathing 3s infinite ease-in-out;
}

.call-name {
    font-size: 28px; font-weight: 700; color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    margin-bottom: 8px;
    font-family: 'Cairo', sans-serif;
}

.call-status {
    font-size: 15px; color: rgba(255,255,255,0.8);
    background: rgba(255,255,255,0.1);
    padding: 6px 20px; border-radius: 20px;
    backdrop-filter: blur(5px);
}

/* 3. Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³ÙÙ„ÙŠ (Ø§Ù„Ø£Ø²Ø±Ø§Ø±) */
.call-btn { 
    width: 55px; height: 55px; /* ØªØµØºÙŠØ± Ù…Ù† 65 Ù„Ù€ 55 */
    font-size: 22px; 
    border-radius: 50%;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}


/* Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù… */

.call-btn:active { transform: scale(0.9); }

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (Ù…Ø§ÙŠÙƒ ÙˆØ§Ø³Ø¨ÙŠÙƒØ±) - Ø´ÙØ§ÙØ© */
.call-btn.mute, .call-btn.speaker { 
    background: rgba(255,255,255,0.15); 
}

/* Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø£Ø­Ù…Ø±) */
.call-btn.end { 
    background: #ff3b30; 
    width: 65px; height: 65px; font-size: 28px;
    box-shadow: 0 5px 20px rgba(255, 59, 48, 0.4);
}

/* Ø²Ø± Ø§Ù„Ø±Ø¯ (Ø£Ø®Ø¶Ø±) - ÙŠØ¸Ù‡Ø± Ø¨Ø³ Ù„Ù…Ø§ Ø­Ø¯ ÙŠØ±Ù† Ø¹Ù„ÙŠÙƒ */
.call-btn.accept { 
    background: #10b981; 
    width: 65px; height: 65px; font-size: 28px;
    box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
    /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¨Ø¶ */
    animation: pulse-green 1.5s infinite;
}

/* Ø²Ø± Ø§Ù„Ø±ÙØ¶ Ù„Ù…Ø§ Ø­Ø¯ ÙŠØ±Ù† Ø¹Ù„ÙŠÙƒ - Ø¨ÙŠØªÙ‡Ø² */
#incomingCallControls .call-btn.end {
    animation: shake 1.2s infinite ease-in-out;
}

/* ================= Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ================= */
@keyframes breathing {
    0%, 100% { transform: scale(1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    50% { transform: scale(1.05); box-shadow: 0 15px 50px rgba(0, 229, 255, 0.2); }
}
@keyframes pulse-green {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
@keyframes shake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-10deg); }
    100% { transform: rotate(0deg); }
}
/* ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØµØºÙŠØ± (Ù„Ù…Ø§ Ù†ÙØ¹Ù„Ù‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª) */
/* ================= CSS ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…ØµØºØ± ================= */

/* ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØµØºÙŠØ± - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²ÙˆØ§Ø¦Ø¯ */
.call-overlay.minimized {
    width: 110px !important; height: 160px !important;
    bottom: 120px !important; right: 20px !important;
    top: auto !important; left: auto !important;
    border-radius: 18px !important;
    padding: 0 !important;
    border: 2px solid rgba(255,255,255,0.2) !important;
    background: #1e293b !important;
    overflow: hidden !important; /* ÙŠÙ‚Øµ Ø£ÙŠ Ø­Ø§Ø¬Ø© Ø¨Ø±Ù‡ */
    display: flex !important; align-items: center; justify-content: center;
}


/* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¬ÙˆÙ‡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø© */
.minimized .call-bg { display: none !important; } 

.minimized .call-avatar { 
    width: 60px !important; 
    height: 60px !important; 
    margin-bottom: 5px !important; 
    border-width: 2px !important; 
    box-shadow: none !important;
    display: none !important; 

}

.minimized .call-name { 
    font-size: 13px !important; 
    margin-bottom: 2px !important; 
    white-space: nowrap; 
    max-width: 100%; 
    overflow: hidden; 
    text-overflow: ellipsis;
    display: none !important; 

}

.minimized .call-status { 
    font-size: 10px !important; 
    padding: 2px 6px !important;
    background: rgba(255,255,255,0.05) !important;
    display: none !important; 

}

/* Ø¥Ø®ÙØ§Ø¡ ØªØ§Ù… Ù„ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ØµØºØ± Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ Ù…ÙŠØ¨ÙˆØ¸Ø´ */
.minimized .call-controls-section { 
    display: none !important; 
}

.minimized .controls-dock { 
    display: none !important; 
}

.minimized .call-btn { 
    display: none !important; 
}

.minimized #activeCallControls { 
    display: none !important; 
}

.minimized #incomingCallControls { 
    display: none !important; 
}

/* Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙ‚Ø· */
.minimized .call-info-section { 
    display: flex !important; 
    transform: scale(0.9); /* ØªØµØºÙŠØ± Ø®ÙÙŠÙ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ */
    margin: 0 !important;
    width: 100%;
    align-items: center;
    justify-content: center;
    position: static !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù€ Absolute */
    transform: scale(0.7);
    
    opacity: 1 !important; /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¸Ù‡ÙˆØ± */

}

/* Ø²Ø±Ø§Ø± Ø§Ù„ØªÙƒØ¨ÙŠØ± (ÙŠØºØ·ÙŠ Ø§Ù„ÙƒØ§Ø±Øª ÙƒÙ„Ù‡) */
.maximize-btn {
    display: none;
    position: absolute; inset: 0; z-index: 100; cursor: pointer;
}
.minimized .maximize-btn { display: block; }

/* === Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ (Ø£Ù„ÙˆØ§Ù†Ùƒ) === */

.call-btn.video { background: rgba(255,255,255,0.15); }
.call-btn.switch-cam { background: rgba(255, 255, 255, 0.2); font-size: 20px; width: 55px; height: 55px; }
.call-btn.video.active-state { background: #fff !important; color: #000 !important; }

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-container {
    position: absolute; 
    inset: 0; 
    z-index: 5; /* ğŸ‘ˆ ÙƒØ§Ù† 0 ÙˆØ®Ù„ÙŠÙ†Ø§Ù‡ 5 Ø¹Ø´Ø§Ù† ÙŠØ·Ù„Ø¹ ÙÙˆÙ‚ */
    background: #000;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
}
.remote-video { width: 100%; height: 100%; object-fit: cover; }

/* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ (PIP) */
.local-video {
    position: absolute; 
    bottom: 120px; right: 20px; 
    width: 100px; height: 140px;
    background: #333;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    object-fit: cover;
    z-index: 5;
    transition: 0.3s;
}
/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØºÙŠØ± */
.minimized .local-video { display: none !important; }

.call-btn.snapshot { background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; font-size: 20px; }
.local-video { z-index: 100 !important; box-shadow: 0 10px 30px rgba(0,0,0,0.8); cursor: grab; }
.local-video:active { cursor: grabbing; }

.calling-pulse { animation: ring-pulse 2s infinite; }
@keyframes ring-pulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(0, 229, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 229, 255, 0); }
}

.call-btn.screen-share { background: rgba(255, 255, 255, 0.15); font-size: 20px; }
.call-btn.screen-share.active-state { background: #fff !important; color: #000 !important; box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }

.remote-screen-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 1; background: #000; }

.presentation-mode .remote-video {
    position: absolute; top: 20px; left: 20px; width: 100px; height: 140px;
    border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5); object-fit: cover; z-index: 10; transition: 0.3s;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ø¦Ù… */
.controls-dock {
    position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
    background: rgba(20, 30, 45, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    padding: 12px 25px; border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; gap: 20px; width: fit-content; z-index: 100;
}
.controls-dock .call-btn { width: 50px; height: 50px; background: transparent; box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
.controls-dock .call-btn:hover { background: rgba(255,255,255,0.1); }
.controls-dock .call-btn.end { background: #ff3b30 !important; width: 60px; border: none; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); }

.msg-bubble:has(.fa-phone-slash), .msg-bubble:has(.fa-phone) {
    background: rgba(15, 23, 42, 0.6) !important; border: 1px solid rgba(255,255,255,0.1) !important;
    box-shadow: none !important; backdrop-filter: blur(4px); width: fit-content;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙˆØªØ± */
.action-btn {
    width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.08); color: #94a3b8;
    cursor: pointer; transition: all 0.3s ease; font-size: 18px; position: relative; flex-shrink: 0;
}
.action-btn:active { transform: scale(0.9); }
.media-btn:hover { color: #00e5ff; border-color: rgba(0, 229, 255, 0.3); background: rgba(0, 229, 255, 0.1); }
.file-btn:hover { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.1); }
.mic-btn:hover { color: #10b981; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }

.destruct-btn.active { color: #ff3b30; background: rgba(255, 59, 48, 0.15); border-color: rgba(255, 59, 48, 0.4); box-shadow: 0 0 10px rgba(255, 59, 48, 0.3); }
.destruct-badge { position: absolute; top: -2px; right: -2px; background: #ff3b30; color: white; font-size: 9px; padding: 2px 4px; border-radius: 6px; border: 1px solid #000; }

.icon-btn.audio { color: #fca5a5; background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2); }
.icon-btn.audio:hover { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: #fff; border-color: transparent; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); transform: translateY(-2px); }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¹Ø´Ø§Ù† ØªÙƒÙˆÙ† Ø´ÙØ§ÙØ© */
.msg-bubble:has(.fa-phone-slash), 
.msg-bubble:has(.fa-phone) {
    background: rgba(15, 23, 42, 0.6) !important; /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ø´ÙØ§Ù Ø¬Ø¯Ø§Ù‹ */
    border: 1px solid rgba(255,255,255,0.1) !important;
    box-shadow: none !important;
    backdrop-filter: blur(4px);
    width: fit-content;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„ÙÙˆØªØ± */
.action-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #94a3b8; cursor: pointer;
    transition: all 0.3s ease;
    font-size: 18px; position: relative;
    flex-shrink: 0;
}
.action-btn:active { transform: scale(0.9); }

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ */
.media-btn:hover { color: #00e5ff; border-color: rgba(0, 229, 255, 0.3); background: rgba(0, 229, 255, 0.1); }
.file-btn:hover { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.1); }
.mic-btn:hover { color: #10b981; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }

/* Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± */
.destruct-btn.active { 
    color: #ff3b30; background: rgba(255, 59, 48, 0.15); 
    border-color: rgba(255, 59, 48, 0.4); 
    box-shadow: 0 0 10px rgba(255, 59, 48, 0.3); 
}
.destruct-badge {
    position: absolute; top: -2px; right: -2px;
    background: #ff3b30; color: white; font-size: 9px;
    padding: 2px 4px; border-radius: 6px; border: 1px solid #000;
}
    /* ================= Ø¥ØµÙ„Ø§Ø­ ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (Minimized Mode) ================= */

/* 1. Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„ÙƒØ§Ø±Øª Ù†ÙØ³Ù‡) */
.call-overlay.minimized {
    width: 110px !important;      /* Ø¹Ø±Ø¶ ØµØºÙŠØ± Ø«Ø§Ø¨Øª */
    height: 160px !important;     /* Ø·ÙˆÙ„ Ø«Ø§Ø¨Øª */
    bottom: 120px !important;     /* ÙŠØ±ØªÙØ¹ Ø¹Ù† Ø§Ù„ÙÙˆØªØ± Ø¹Ø´Ø§Ù† Ù…ØºØ·ÙŠØ´ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
    right: 20px !important;       /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    top: auto !important; 
    left: auto !important;
    
    border-radius: 18px !important;
    background: #1e293b !important; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© */
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5) !important;
    
    padding: 10px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
    z-index: 9000 !important; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    cursor: pointer; /* Ø¹Ø´Ø§Ù† ÙŠØ¹Ø±Ù Ø¥Ù†Ù‡ ÙŠØ¯Ø§Ø³ Ø¹Ù„ÙŠÙ‡ */
    overflow: hidden; /* Ø£ÙŠ Ø²ÙŠØ§Ø¯Ø© ØªØªÙ‚Øµ */
}

/* 2. Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø§Ù„Ù…Ø´ÙˆÙ‡Ø© */
.call-overlay.minimized .call-controls-section,
.call-overlay.minimized .controls-dock {
    display: none !important; /* Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø±ÙŠØ¶ ÙˆØ§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
}

/* 3. ØªØµØºÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
.call-overlay.minimized .call-avatar {
    width: 60px !important;
    height: 60px !important;
    border-width: 2px !important;
    margin: 0 !important;
    box-shadow: none !important;
    animation: none !important; /* ÙˆÙ‚Ù Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ */
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆÙ‚Øª */
.call-overlay.minimized .call-name {
    font-size: 13px !important;
    margin: 0 !important;
    white-space: nowrap;      /* Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ */
    overflow: hidden;
    text-overflow: ellipsis;  /* Ù†Ù‚Ø· Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ */
    max-width: 100%;
}

.call-overlay.minimized .call-status {
    font-size: 10px !important;
    padding: 2px 6px !important;
    background: rgba(255,255,255,0.05) !important;
}

/* 5. (Ø¥Ø¶Ø§ÙØ©) Ø²Ø± ØªÙƒØ¨ÙŠØ± Ø´ÙØ§Ù ÙŠØºØ·ÙŠ Ø§Ù„ÙƒØ§Ø±Øª */
.maximize-btn {
    position: absolute;
    inset: 0;
    z-index: 5;
}

/* 6. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© */
/* Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø²Ø±Ø§Ø± Ù‚ÙÙ„ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØºÙŠØ± */
.call-overlay.minimized::after {
    
}
/* ================= Ø¥ØµÙ„Ø§Ø­ ÙƒØ±ÙˆØª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ================= */

/* ØªÙ†Ø³ÙŠÙ‚ ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
/* ================= ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ù…ØµØºØ± (Compact) ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ø§Ù„ÙÙ‚Ø§Ø¹Ø©) */
.msg-bubble:has(.call-card-inner) {
    background: rgba(15, 23, 42, 0.9) !important; /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ */
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(5px);
    
    /* Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¯ÙŠ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØµØºØ±Ù‡ */
    width: fit-content !important;   /* Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ù‚Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    max-width: 80% !important;       /* Ø¹Ø´Ø§Ù† Ù…ÙŠØ²ÙŠØ¯Ø´ Ø£ÙˆÙŠ */
    padding: 6px 12px !important;    /* Ø­ÙˆØ§Ù Ø¯Ø§Ø®Ù„ÙŠØ© ØµØºÙŠØ±Ø© */
    border-radius: 20px !important;  /* ØªØ¯ÙˆÙŠØ± ÙƒØ§Ù…Ù„ */
    
    /* Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø¸Ù„ ÙƒØ¨ÙŠØ± */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
}

/* 2. ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¬ÙˆÙ‡ Ø§Ù„ÙƒØ§Ø±Øª */
.call-card-inner {
    display: flex;
    align-items: center;
    gap: 10px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Øµ */
    min-width: 0 !important; /* (Ù…Ù‡Ù…) Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
}

/* 3. ØªØµØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¯Ø§ÙŠØ±Ø© Ø¨ØªØ§Ø¹ØªÙ‡Ø§ */
.call-icon-circle {
    width: 34px !important;  /* ØµØºØ±Ù†Ø§Ù‡Ø§ Ù…Ù† 42 Ù„Ù€ 34 */
    height: 34px !important;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px !important; /* ØªØµØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù†ÙØ³Ù‡Ø§ */
    flex-shrink: 0;
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙˆØµ Ø¬ÙˆÙ‡ Ø§Ù„ÙƒØ§Ø±Øª */
.call-card-info {
    display: flex; 
    flex-direction: column; 
    justify-content: center;
    line-height: 1.3;
}

.call-card-title {
    font-size: 13px !important;
    font-weight: bold;
    color: #fff;
    white-space: nowrap; /* ÙŠÙ…Ù†Ø¹ Ù†Ø²ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ø³Ø·Ø± ØªØ§Ù†ÙŠ */
}

.call-card-sub {
    font-size: 10px !important;
    color: #94a3b8;
}
/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
::-webkit-scrollbar {
    width: 6px; /* Ø±ÙÙŠØ¹ Ø¬Ø¯Ø§Ù‹ */
}

::-webkit-scrollbar-track {
    background: transparent; /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø¹Ø´Ø§Ù† Ù…ØªØ¨Ø§Ù†Ø´ */
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1); /* Ù„ÙˆÙ† Ø§Ù„Ø±ØµØ§ØµØ© Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù */
    border-radius: 10px; /* Ù…Ø¯ÙˆØ± */
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3); /* ÙŠÙØªØ­ Ù„Ù…Ø§ ØªÙ‚Ù Ø¹Ù„ÙŠÙ‡ */
}

/* --- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„ (Sender) --- */
/* Ù„Ùˆ Ø±Ø³Ø§Ù„Ø© Ù…ØªÙƒØ±Ø±Ø© Ù„Ù†ÙØ³ Ø§Ù„Ø´Ø®ØµØŒ Ø®Ù„ÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠÙ…ÙŠÙ† Ø­Ø§Ø¯Ø© */
.msg-row.sender.same-sender .msg-bubble {
    border-top-right-radius: 4px !important;
    margin-top: 2px; /* Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ†Ù‡Ù… */
}

/* --- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Receiver) --- */
/* Ù„Ùˆ Ø±Ø³Ø§Ù„Ø© Ù…ØªÙƒØ±Ø±Ø©ØŒ Ø®Ù„ÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ø´Ù…Ø§Ù„ Ø­Ø§Ø¯Ø© */
.msg-row.receiver.same-sender .msg-bubble {
    border-top-left-radius: 4px !important;
    margin-top: 2px;
}

/* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ø¹Ø§Ù…Ø© Ø¹Ø´Ø§Ù† ØªØ¨Ù‚Ù‰ Smooth */
.msg-bubble {
    border-radius: 18px; /* ØªØ¯ÙˆÙŠØ± ÙƒØ¨ÙŠØ± */
}
/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ Ø§Ù„Ù‚ÙˆÙŠ */
.chat-header, .chat-footer, .receiver .msg-bubble {
    background: rgba(15, 25, 38, 0.75) !important; /* Ø´ÙØ§ÙÙŠØ© Ø£Ù‚Ù„ Ø´ÙˆÙŠØ© */
    backdrop-filter: blur(20px) saturate(180%); /* ØªÙ…ÙˆÙŠÙ‡ Ù‚ÙˆÙŠ + ØªØ´Ø¨Ø¹ Ø£Ù„ÙˆØ§Ù† */
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.08); /* Ø­Ø¯ÙˆØ¯ Ø£Ù†Ø­Ù ÙˆØ£Ù†Ø¹Ù… */
    box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2); /* Ø¸Ù„ Ù†Ø§Ø¹Ù… Ø¬Ø¯Ø§Ù‹ */
}

/* ØªÙ„Ù…ÙŠØ¹Ø© Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
.send-btn {
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.4); /* ØªÙˆÙ‡Ø¬ Ù†ÙŠÙˆÙ† */
    border: 1px solid rgba(255, 255, 255, 0.2);
}

body, button, input, textarea {
    font-family: 'Cairo', sans-serif;
}

.msg-bubble {
    font-weight: 400; /* Ø®Ø· Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ù†Øµ */
}

.header-info h3, .sender-name {
    font-weight: 700; /* Ø®Ø· ØªØ®ÙŠÙ† Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ */
}
/* ================= ØªØ­Ø¯ÙŠØ«: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ================= */

/* 1. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¹Ø´Ø§Ù† ØªÙ‚Ø¨Ù„ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† */
.footer-actions-left {
    display: flex;
    align-items: center;
    gap: 8px; 
    padding-left: 5px;
    
    /* Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ø§Ø¹Ù…Ø© */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø³Ù„Ø³ */
    max-width: 200px; /* Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ¨ÙŠ ÙŠÙƒÙÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
    opacity: 1;
    overflow: hidden; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ®ØªÙÙŠ Ù„Ù…Ø§ Ù†ØµØºØ± Ø§Ù„Ø¹Ø±Ø¶ */
}

/* 2. Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¶Ø§Ù Ù„Ù…Ø§ Ù†ÙƒØªØ¨ (ÙŠØ®ÙÙŠ Ø§Ù„Ø²Ø±Ø§ÙŠØ±) */
.footer-actions-left.hidden {
    max-width: 0px !important; /* Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¨Ù‚Ù‰ ØµÙØ± */
    padding-left: 0px !important;
    gap: 0px !important;
    opacity: 0; /* Ø´ÙØ§ÙÙŠØ© ÙƒØ§Ù…Ù„Ø© */
    margin: 0 !important;
    pointer-events: none; /* Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ */
}
    
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ù‚Ø§Ø· */
.typing-dots {
    display: inline-flex;
    gap: 4px;
    align-items: center;
    padding: 5px 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    margin-top: 5px;
}
.typing-dot {
    width: 6px; height: 6px;
    background: #00e5ff;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´ÙŠÙ…Ø± (Loaders) */
/* âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø¶Ø§ÙØ© margin-top: auto */
/* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ) */
.skeleton-row {
    display: flex;
    flex-direction: column;
    gap: 15px;       /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª */
    padding: 30px;   /* Ù‡ÙˆØ§Ù…Ø´ Ø¬Ø§Ù†Ø¨ÙŠØ© */
    width: 100%;
    margin: auto;    /* âœ… Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠØ¬Ø¹Ù„Ù‡Ø§ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ…Ø§Ù…Ø§Ù‹ */
    max-width: 600px; /* Ø¹Ø´Ø§Ù† Ù…ØªØ¨Ù‚Ø§Ø´ Ø¹Ø±ÙŠØ¶Ø© Ø£ÙˆÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© */
.skeleton-msg {
    height: 45px;    /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ÙÙ‚Ø§Ø¹Ø© */
    border-radius: 20px;
    background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite linear; /* Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ù…ÙŠØ¹ */
    opacity: 0.7;
}

/* ÙÙ‚Ø§Ø¹Ø© Ø¬Ù‡Ø© Ø§Ù„ÙŠÙ…ÙŠÙ† (ÙƒØ£Ù†Ù‡Ø§ Ø±Ø³Ø§Ù„ØªÙŠ) */
.skeleton-right { 
    align-self: flex-end; 
    border-bottom-right-radius: 4px; 
}

/* ÙÙ‚Ø§Ø¹Ø© Ø¬Ù‡Ø© Ø§Ù„ÙŠØ³Ø§Ø± (ÙƒØ£Ù†Ù‡Ø§ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±) */
.skeleton-left { 
    align-self: flex-start; 
    border-bottom-left-radius: 4px; 
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù„Ù…Ø¹Ø§Ù† */
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
/* ================= ØªØµÙ…ÙŠÙ… Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ================= */
.msg-bubble.deleted {
    background: rgba(255, 255, 255, 0.05) !important; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù */
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #94a3b8 !important; /* Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ */
    font-style: italic;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: none !important;
}

/* ================= Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ================= */
/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒÙ„Ù‡Ø§ */
/* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒÙ„Ù‡Ø§ */
.confirm-modal-overlay {
    position: fixed !important; 
    top: 0 !important; 
    left: 0 !important; 
    width: 100vw !important;  /* Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    height: 100vh !important; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    background: rgba(0, 0, 0, 0.85) !important; /* ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙƒØªØ± Ù„Ù„ØªØ±ÙƒÙŠØ² */
    backdrop-filter: blur(8px); /* Ø¨Ù„ÙˆØ± Ù‚ÙˆÙŠ */
    -webkit-backdrop-filter: blur(8px);
    z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… Z-Index Ù…Ø³Ù…ÙˆØ­ Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
    display: none; 
    align-items: center; 
    justify-content: center;
    margin: 0 !important;
    padding: 0 !important;
    inset: 0 !important;
}

/* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù†ÙØ³Ù‡ */
.confirm-modal {
    position: relative !important; /* Ø¹Ø´Ø§Ù† ÙŠØ«Ø¨Øª Ø¬ÙˆÙ‡ Ø§Ù„ÙÙ„ÙŠÙƒØ³ */
    background: #1e293b;
    width: 90%; 
    max-width: 320px;
    border-radius: 24px;
    padding: 30px 25px;
    text-align: center;
    border: 1px solid rgba(239, 68, 68, 0.3);
    box-shadow: 0 20px 60px rgba(0,0,0,0.6); /* Ø¸Ù„ Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ */
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    margin: auto; /* Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ³ÙŠØ· */
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø¸Ø± */
.modal-icon-box {
    width: 60px; height: 60px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 50%;
    display: grid; place-items: center;
    margin: 0 auto 15px;
}
.modal-icon-box i {
    font-size: 28px; color: #ef4444;
}

/* Ø§Ù„Ù†ØµÙˆØµ */
.confirm-title { font-size: 18px; font-weight: bold; color: #ef4444; margin-bottom: 10px; }
.confirm-desc { font-size: 13px; color: #cbd5e1; line-height: 1.6; margin-bottom: 25px; }

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.confirm-actions { display: flex; gap: 10px; justify-content: center; }

.btn-modal {
    flex: 1; padding: 12px; border-radius: 12px; border: none;
    font-family: inherit; font-weight: bold; cursor: pointer; transition: 0.2s;
}
.btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
.btn-confirm { background: #ef4444; color: #fff; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }

/* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { to { transform: scale(1); } }

/* Ø²Ø± Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† */
.mic-btn {
    width: 48px; height: 48px;
    border-radius: 50%; /* Ø¯Ø§Ø¦Ø±ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    
    /* Ø®Ù„ÙÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ ØºØ§Ù…Ù‚Ø© Ø¬Ø¯Ø§Ù‹ ÙˆØ´ÙØ§ÙØ© */
    background: rgba(16, 185, 129, 0.1); 
    border: 1px solid rgba(16, 185, 129, 0.2); 
    
    color: #34d399; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø®Ø¶Ø± Ù†ÙŠÙˆÙ† Ù‡Ø§Ø¯ÙŠ */
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s ease;
    margin-bottom: 2px;
}
/* ================= Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙˆØªØ± (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) ================= */

/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
.action-btn {
    width: 42px; height: 42px;
    border-radius: 14px; /* ØªØ¯ÙˆÙŠØ± Squircle Ø­Ø¯ÙŠØ« */
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    font-size: 19px;
    margin-bottom: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* ØªØ£Ø«ÙŠØ± Ø²Ø¬Ø§Ø¬ÙŠ Ø¹Ø§Ù… */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

/* 1. Ø²Ø± Ø§Ù„ØµÙˆØ± (Media) - Ù„ÙˆÙ† Ù…ÙˆÙ/Ø¨Ù†ÙØ³Ø¬ÙŠ Ù‡Ø§Ø¯ÙŠ */
.media-btn {
    background: rgba(192, 132, 252, 0.08); /* Ø®Ù„ÙÙŠØ© Ø¨Ù†ÙØ³Ø¬ÙŠ Ø´ÙØ§Ù Ø¬Ø¯Ø§Ù‹ */
    border: 1px solid rgba(192, 132, 252, 0.15); /* Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© */
    color: #d8b4fe; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø§ÙÙ†Ø¯Ø± ÙØ§ØªØ­ */
}

/* 2. Ø²Ø± Ø§Ù„Ù…Ù„ÙØ§Øª (File) - Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù‡Ø§Ø¯ÙŠ */
.file-btn {
    background: rgba(251, 191, 36, 0.08); /* Ø®Ù„ÙÙŠØ© Ø°Ù‡Ø¨ÙŠ Ø´ÙØ§Ù */
    border: 1px solid rgba(251, 191, 36, 0.15);
    color: #fcd34d; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø°Ù‡Ø¨ÙŠ */
}

/* 3. Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± (Destruct) - Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø®Ø§ÙØª */
.destruct-btn {
    background: rgba(248, 113, 113, 0.08); /* Ø®Ù„ÙÙŠØ© Ø£Ø­Ù…Ø± Ø´ÙØ§Ù */
    border: 1px solid rgba(248, 113, 113, 0.15);
    color: #fca5a5; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
}

/* ØªØ­Ø³ÙŠÙ†: Ø²Ø± Ø§Ù„ØªØ¯Ù…ÙŠØ± Ù„Ù…Ø§ ÙŠØ´ØªØºÙ„ ÙŠØ¨Ù‚Ù‰ Ø£Ø­Ù…Ø± ØµØ±ÙŠØ­ */
.destruct-btn.active {
    background: rgba(220, 38, 38, 0.2) !important;
    border-color: #ef4444 !important;
    color: #ff0000 !important;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
}
/* 1. Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø«Ø§Ø¨Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ·) - Ø£Ø­Ù…Ø± Ù‡Ø§Ø¯ÙŠ */
.icon-btn.audio {
    color: #fca5a5; /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
    background: rgba(239, 68, 68, 0.08); /* Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ø´ÙØ§ÙØ© */
    border: 1px solid rgba(239, 68, 68, 0.2); /* Ø¨Ø±ÙˆØ§Ø² Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ */
}

/* 2. Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ Ø£Ùˆ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø¹Ù„ÙŠÙ‡ (Hover) - Ø£Ø­Ù…Ø± Ù…ØªÙˆÙ‡Ø¬ */
.icon-btn.audio:hover {
    /* ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„Ø£Ø­Ù…Ø± Ø§Ù„ØºØ§Ù…Ù‚ */
    background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
    color: #fff; /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ¨Ù‚Ù‰ Ø£Ø¨ÙŠØ¶ */
    border-color: transparent;
    
    /* Ø¸Ù„ Ø£Ø­Ù…Ø± Ù…ØªÙˆÙ‡Ø¬ */
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    transform: translateY(-2px);
}
.floating-btn {
    background: rgba(0, 0, 0, 0.4) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    color: white;
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
/* ================= ØªØµÙ…ÙŠÙ… Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© (Aurora) ================= *
/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¹Ø´Ø§Ù† ØªÙ„ÙŠÙ‚ Ø¹Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.call-avatar {
    border: 2px solid rgba(0, 229, 255, 0.3) !important;
    box-shadow: 0 0 30px rgba(0, 229, 255, 0.15) !important;
    background-color: #1e293b; /* Ø®Ù„ÙÙŠØ© Ù„Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ù„Ø³Ù‡ Ø¨ØªØ­Ù…Ù„ */
}
/* ============================================================
   1. ØªØµÙ…ÙŠÙ… ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Glass Dock)
   ============================================================ */
.controls-dock {
    position: absolute;
    bottom: 40px; 
    left: 50%;
    transform: translateX(-50%); /* Ø¹Ø´Ø§Ù† ØªØ¨Ù‚ÙŠ ÙÙŠ Ù†Øµ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ */
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px; /* Ù…Ø³Ø§ÙØ§Øª Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø±Ø§ÙŠØ± */
    
    /* Ø®Ù„ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø¨Ù„ÙˆØ± */
    background: rgba(20, 30, 48, 0.6); 
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    
    padding: 10px 25px;
    border-radius: 50px; /* ØªØ¯ÙˆÙŠØ± ÙƒØ§Ù…Ù„ */
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    
    z-index: 1000;
    width: auto;
    min-width: 280px;
}
call-btn {
    width: 50px; 
    height: 50px;
    border-radius: 50%; /* Ø¯Ø§Ø¦Ø±Ø© ÙƒØ§Ù…Ù„Ø© */
    border: none;
    outline: none;
    
    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ø´ÙØ§Ù */
    background: rgba(255, 255, 255, 0.08);
    color: #e2e8f0;
    font-size: 20px;
    
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø³ Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³ */
.call-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-3px);
}

.call-btn:active {
    transform: scale(0.9);
}

.call-btn.active-state {
    background: #ffffff !important;
    color: #0f172a !important; /* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ‚Ù„Ø¨ Ø£Ø³ÙˆØ¯ */
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
    transform: scale(1.05);
}

.call-btn.end {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    color: #fff !important;
    width: 65px; /* Ø£ÙƒØ¨Ø± Ø³Ù†Ø© */
    height: 50px; /* Ø¨ÙŠØ¶Ø§ÙˆÙŠ Ø´ÙˆÙŠØ© */
    border-radius: 25px; /* ØªØ¯ÙˆÙŠØ± Ù…Ø®ØªÙ„Ù */
    font-size: 24px;
    box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
    margin-left: 10px;
}

#incomingCallControls {
    position: absolute !important;
    bottom: 80px !important;
    left: 0; right: 0;
    display: flex; justify-content: space-evenly;
    z-index: 2000;
}

.call-btn.accept {
    width: 70px !important; height: 70px !important; font-size: 28px;
    background: #10b981 !important;
    box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.2);
    animation: pulse-green 1.5s infinite;
}

.call-btn.end-incoming { /* Ø²Ø± Ø§Ù„Ø±ÙØ¶ */
    width: 70px !important; height: 70px !important; font-size: 28px;
    background: #ef4444 !important;
    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0.2);
}

/* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¨Ø¶ */
@keyframes pulse-green {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}
/* ================= ØªØµÙ…ÙŠÙ… Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Aurora Background) ================= */
.call-bg {
    position: absolute;
    inset: 0;
    z-index: 1; /* ØªØ­Øª ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    background-color: #0b1121; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    overflow: hidden;
}

/* Ø§Ù„Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´ÙÙ‚) */
.call-bg::before, .call-bg::after {
    content: '';
    position: absolute;
    width: 600px; height: 600px;
    border-radius: 50%;
    filter: blur(80px); /* ØªÙ…ÙˆÙŠÙ‡ Ù‚ÙˆÙŠ */
    opacity: 0.4; /* Ø´ÙØ§ÙÙŠØ© */
    animation: floating-lights 10s infinite alternate ease-in-out;
}

/* Ø§Ù„Ø¨Ù‚Ø¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø¨Ù†ÙØ³Ø¬ÙŠ) */
.call-bg::before {
    background: #7c3aed; 
    top: -100px; left: -100px;
}

/* Ø§Ù„Ø¨Ù‚Ø¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø³ÙŠØ§Ù†/Ø£Ø²Ø±Ù‚) */
.call-bg::after {
    background: #00e5ff; 
    bottom: -100px; right: -100px;
    animation-delay: -5s;
}

/* Ø´Ø¨ÙƒØ© Ù†Ù‚Ø· Ø®ÙÙŠÙØ© (Pattern) */
.call-bg-pattern {
    position: absolute; inset: 0; z-index: 2;
    background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 30px 30px;
    opacity: 0.2;
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø¶ÙˆØ§Ø¡ */
@keyframes floating-lights {
    0% { transform: scale(1); }
    100% { transform: scale(1.2); }
}
    /* ================= Ø£Ù„ÙˆØ§Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠÙ† (Seen System) ================= */

/* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¹ÙŠÙ† */
.status-eye {
    font-size: 12px;
    margin-right: 3px;
    transition: all 0.3s ease;
}

/* 1. Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ (Ù„Ù… ØªØµÙ„ / Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙÙ„Ø§ÙŠÙ†) */
.eye-dark {
    color: rgba(255, 255, 255, 0.3);
}

/* 2. Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ (ÙˆØµÙ„Øª / Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„ÙƒÙ† Ù„Ù… ÙŠÙØªØ­ Ø§Ù„Ø´Ø§Øª) */
.eye-blue {
    color: #3b82f6; /* Ø£Ø²Ø±Ù‚ */
    text-shadow: 0 0 5px rgba(59, 130, 246, 0.4);
}

/* 3. Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ù† (ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Seen) */
.eye-green {
    color: #00e5ff !important; /* Ø³ÙŠØ§Ù† Ù†ÙŠÙˆÙ† */
    text-shadow: 0 0 8px rgba(0, 229, 255, 0.8); /* ØªÙˆÙ‡Ø¬ */
    transform: scale(1.1); /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· */
}

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ù†Ø¨Ø¶ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± */
.mood-happy { box-shadow: 0 0 20px #fbbf24 !important; border-color: #fbbf24 !important; } /* Ø£ØµÙØ± Ù„Ù„ÙØ±Ø­ */
.mood-love { box-shadow: 0 0 20px #ec4899 !important; border-color: #ec4899 !important; } /* ÙˆØ±Ø¯ÙŠ Ù„Ù„Ø­Ø¨ */
.mood-angry { box-shadow: 0 0 20px #ef4444 !important; border-color: #ef4444 !important; } /* Ø£Ø­Ù…Ø± Ù„Ù„ØºØ¶Ø¨ */
.mood-sad { box-shadow: 0 0 20px #60a5fa !important; border-color: #60a5fa !important; } /* Ø£Ø²Ø±Ù‚ Ù„Ù„Ø­Ø²Ù† */

/* ØªØ£Ø«ÙŠØ± Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ Ù†Ø§Ø¹Ù… */
.input-container { transition: box-shadow 0.3s ease, border-color 0.3s ease; }

    /* ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ */
body.ghost-active {
    filter: grayscale(100%) contrast(1.2); /* ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø±Ù…Ø§Ø¯ÙŠ */
}
body.ghost-active .chat-header, 
body.ghost-active .chat-footer {
    background: #000 !important; /* Ø³ÙˆØ§Ø¯ ÙƒØ§Ù…Ù„ */
    border: 1px solid #333;
}
body.ghost-active .msg-bubble {
    background: #222 !important;
    color: #fff !important;
    font-family: 'Courier New', monospace; /* Ø®Ø· ÙŠØ´Ø¨Ù‡ Ø§Ù„Ø¢Ù„Ø© Ø§Ù„ÙƒØ§ØªØ¨Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
}
/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ø¨Ø­ ØªÙ†Ø¨Ø¶ */
.ghost-indicator {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    color: #fff; z-index: 9999; font-size: 20px; 
    animation: ghostFloat 2s infinite ease-in-out;
    display: none;
}
@keyframes ghostFloat { 0%,100%{transform:translate(-50%,0);opacity:0.5} 50%{transform:translate(-50%,-10px);opacity:1} }

    /* ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
.profile-page {
    position: fixed !important; /* Ù„Ø§Ø²Ù… important Ø¹Ø´Ø§Ù† ÙŠØ®Ø±Ø¬ Ø¨Ø±Ø§ ÙÙ„ÙƒØ³ Ø§Ù„Ø¨ÙˆØ¯ÙŠ */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    
    background: #0b1121; 
    z-index: 9999; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† ÙŠØºØ·ÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
    display: flex; 
    flex-direction: column;
    overflow: hidden; /* Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙÙŠÙ‡ Ø³ÙƒØ±ÙˆÙ„ Ø²ÙŠØ§Ø¯Ø© ÙŠØ®ØªÙÙŠ */
    animation: slideInRight 0.3s ease;
}
@keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

.pp-header {
    padding: 20px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: #fff;
}

.pp-content {
    flex: 1; overflow-y: auto; padding: 20px;
    display: flex; flex-direction: column; gap: 30px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.profile-menu-list {
    display: flex; flex-direction: column; gap: 10px;
}

.profile-item {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255, 255, 255, 0.03);
    padding: 12px 15px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    transition: 0.2s;
}

.profile-item:active {
    background: rgba(255, 255, 255, 0.08);
    transform: scale(0.98);
}

.p-item-icon {
    width: 40px; height: 40px;
    border-radius: 12px;
    display: grid; place-items: center;
    font-size: 18px;
}

.p-item-text {
    flex: 1; display: flex; flex-direction: column;
}
.p-item-text span { font-size: 14px; color: #fff; font-weight: 600; }
.p-item-text small { font-size: 11px; color: #94a3b8; margin-top: 2px; }

.p-item-arrow { color: #64748b; font-size: 14px; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
.pp-avatar-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: 15px;
}

.pp-avatar-lg {
    width: 100px;  /* Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± Ù„Ù„ØµÙˆØ±Ø© */
    height: 100px;
    border-radius: 50%;
    background-color: #333;
    background-size: cover;
    background-position: center;
    border: 3px solid #00e5ff; /* Ø¥Ø·Ø§Ø± Ù…Ù„ÙˆÙ† */
    box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
    font-size: 40px; /* ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø© */
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø§Ø³Ù… */
.pp-name {
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.encryption-pill {
    text-align: center;
    font-size: 11px;
    color: #94a3b8;
    background: rgba(255,255,255,0.05);
    padding: 4px 12px;
    border-radius: 20px;
    width: fit-content;
    margin: 0 auto; /* ØªÙˆØ³ÙŠØ· */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø´Ø¨Ø­) */
.system-msg-row {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 15px 0;
    z-index: 1;
}

.system-msg-text {
    background: rgba(255, 255, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø¬Ø¯Ø§Ù‹ */
    color: #94a3b8;      /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
    padding: 4px 15px;
    border-radius: 20px;
    font-size: 11px;     /* Ø®Ø· ØµØºÙŠØ± */
    font-weight: 300;    /* Ø®Ø· Ø±ÙÙŠØ¹ */
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ØªÙ…ÙŠÙŠØ² Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ */
.system-user-name {
    color: #00e5ff;      /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ù…ÙŠØ² */
    font-weight: 600;
}
/* ================= ØªØµÙ…ÙŠÙ… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« (Messenger Style) ================= */
.search-overlay-full {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #0b1121; /* Ù†ÙØ³ Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    z-index: 2500; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: none;
    flex-direction: column;
    animation: fadeIn 0.2s ease-out;
}

.search-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: rgba(15, 25, 38, 0.95);
}

.search-input-box {
    flex: 1;
    background: rgba(255,255,255,0.05);
    border-radius: 20px;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid rgba(255,255,255,0.1);
}

.search-input-field {
    background: transparent;
    border: none;
    color: #fff;
    width: 100%;
    font-size: 14px;
    font-family: inherit;
}

.search-results-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

/* ØªØµÙ…ÙŠÙ… Ø¹Ù†ØµØ± Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø²ÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø·) */
.search-result-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    cursor: pointer;
    transition: 0.2s;
}

.search-result-item:hover {
    background: rgba(255,255,255,0.05);
}

.s-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    background-color: #333;
    flex-shrink: 0;
    display: grid;
    place-items: center;
    font-weight: bold;
    color: #fff;
}

.s-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
}

.s-name {
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 4px;
}

.s-text {
    font-size: 13px;
    color: #94a3b8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù„ÙŠ Ø¨Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ØªÙƒÙˆÙ† Ù…Ù„ÙˆÙ†Ø© */
.highlight-term {
    color: #00e5ff; /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† Ø¨ØªØ§Ø¹Ùƒ */
    font-weight: bold;
    background: rgba(0, 229, 255, 0.1);
    padding: 0 2px;
    border-radius: 2px;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆÙ…ÙŠØ¶ Ù„Ù…Ø§ ØªØ±ÙˆØ­ Ù„Ù„Ø±Ø³Ø§Ù„Ø© */
@keyframes flashMessage {
    0% { background: rgba(0, 229, 255, 0.5); transform: scale(1.02); }
    50% { background: rgba(0, 229, 255, 0.2); transform: scale(1); }
    100% { background: transparent; }
}

.flash-highlight {
    animation: flashMessage 1.5s ease-out;
    border-radius: 10px;
}
/* Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© */
/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø¹Ø±Ø¶ - ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
.media-gallery-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #0b1121; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚ */
    z-index: 20000 !important; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    animation: slideInRight 0.3s ease-out;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡ÙŠØ¯Ø± */
.mg-header {
    height: 60px;
    display: flex; align-items: center; gap: 15px;
    padding: 0 15px;
    background: rgba(15, 25, 38, 0.95);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-shrink: 0;
}
.mg-close-btn {
    font-size: 20px; color: #94a3b8; cursor: pointer; padding: 5px;
}
.mg-header h3 { margin: 0; color: #fff; font-size: 18px; }

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.mg-tabs {
    display: flex; overflow-x: auto;
    background: #0f1926;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-shrink: 0;
}
.mg-tab {
    flex: 1; text-align: center; padding: 15px 0;
    color: #64748b; font-size: 14px; font-weight: 500;
    cursor: pointer; border-bottom: 2px solid transparent;
    min-width: 70px;
    transition: 0.2s;
}
.mg-tab.active {
    color: #00e5ff; border-bottom-color: #00e5ff; background: rgba(0, 229, 255, 0.05);
}

/* Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© */
.mg-body { flex: 1; overflow-y: auto; padding: 10px; position: relative; }

/* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
.mg-panel { display: none; padding-bottom: 20px; }
.mg-panel.active { display: grid; } /* Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.mg-tabs {
    display: flex;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    gap: 10px;
    overflow-x: auto;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.mg-tab {
    padding: 8px 16px;
    color: #94a3b8;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;
    transition: 0.3s;
}

.mg-tab.active {
    background: var(--accent-color);
    color: #000;
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ø­ */
.mg-panel { display: none; padding: 10px; padding-bottom: 50px; }
.mg-panel.active { display: grid; }

/* Grid Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
.grid-view {
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 8px;
    align-content: start;
}

/* List Ù„Ù„ØµÙˆØª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª */
.list-view {
    display: none; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ active Ø¨ÙŠØ®Ù„ÙŠÙ‡Ø§ grid ÙØ¨Ù†Ù„ØºÙŠ Ø¯Ù‡ */
    flex-direction: column;
    gap: 10px;
}
.mg-panel.active.list-view { display: flex; } /* ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù… */

/* --- Ù‡Ù†Ø§ Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡Ø§ (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹) --- */

/* 1. ÙƒØ±ÙˆØª Ø§Ù„ØµÙˆØ± */
.mg-image-card {
    aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative;
}
.mg-image-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
.mg-image-card:hover img { transform: scale(1.1); opacity: 0.8; }

/* 2. ÙƒØ±ÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.mg-video-card {
    border-radius: 10px; overflow: hidden; position: relative; aspect-ratio: 1/1; /* Ù…Ø±Ø¨Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø±ÙŠØ¯ */
    cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
}
.vid-thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
.play-overlay { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,0.3); }
.play-circle-small {
    width: 35px; height: 35px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
    border-radius: 50%; display: grid; place-items: center; border: 1px solid rgba(255,255,255,0.5);
}

/* 3. ÙƒØ±ÙˆØª Ø§Ù„ØµÙˆØª (Waveform) */
.audio-card {
    display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.03);
    padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
}
.audio-wave { display: flex; gap: 3px; align-items: flex-end; height: 15px; }
.wave-bar { width: 3px; background: #64748b; border-radius: 2px; animation: quietWave 1s infinite; }

/* 4. ÙƒØ±ÙˆØª Ø§Ù„Ù…Ù„ÙØ§Øª */
.file-link-card {
    display: flex; align-items: center; gap: 15px; background: #151f2e;
    padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b; cursor: pointer;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± */
.lightbox {
    position: fixed; inset: 0; 
    background: rgba(0,0,0,0.95); /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ØºØ§Ù…Ù‚Ø© */
    z-index: 60000; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    display: flex; align-items: center; justify-content: center;
    flex-direction: column;
}

.lb-image {
    max-width: 90%; max-height: 80vh; 
    border-radius: 5px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transition: transform 0.2s; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªÙƒÙˆÙ† Ù†Ø§Ø¹Ù…Ø© */
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ (Ø§Ù„Ø£Ø³Ù‡Ù…) */
.lb-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 50px; height: 50px;
    background: rgba(255,255,255,0.1);
    color: #fff; border-radius: 50%;
    display: grid; place-items: center;
    font-size: 20px; cursor: pointer;
    transition: 0.2s; z-index: 60001;
}
.lb-nav:hover { background: rgba(255,255,255,0.2); }
.lb-nav:active { transform: translateY(-50%) scale(0.9); }

.lb-nav.prev { right: 20px; } /* Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙŠÙ…ÙŠÙ† */
.lb-nav.next { left: 20px; }  /* Ø§Ù„ØªØ§Ù„ÙŠ Ø´Ù…Ø§Ù„ */

/* Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
.lb-close {
    position: absolute; top: 20px; right: 20px;
    color: #fff; font-size: 35px; cursor: pointer; z-index: 60002;
    width: 40px; height: 40px; text-align: center; line-height: 40px;
}

/* Ø§Ù„Ø¹Ø¯Ø§Ø¯ */
.lb-counter {
    position: absolute; bottom: 30px;
    color: #fff; font-family: monospace;
    background: rgba(255,255,255,0.1);
    padding: 5px 15px; border-radius: 20px;
}
// ÙØªØ­ Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø¨Ø±Ù‚Ù… Ø§Ù„ØµÙˆØ±Ø©
function openGalleryViewer(index) {
    currentImageIndex = index;
    updateLightboxContent();
    document.getElementById('lightbox').style.display = 'flex';
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
function updateLightboxContent() {
    const imgElement = document.getElementById('lb-img');
    const counter = document.getElementById('lb-counter');
    
    // ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯
    imgElement.src = galleryImagesList[currentImageIndex];
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹: 3 / 10)
    if(counter) counter.innerText = `${currentImageIndex + 1} / ${galleryImagesList.length}`;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¨ (Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚)
function changeGalleryImage(direction) {
    // direction: 1 Ù„Ù„ØªØ§Ù„ÙŠ (Ø´Ù…Ø§Ù„)ØŒ -1 Ù„Ù„Ø³Ø§Ø¨Ù‚ (ÙŠÙ…ÙŠÙ†)
    
    const newIndex = currentImageIndex + direction;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ù…Ø®Ø±Ø¬Ù†Ø§Ø´ Ø¨Ø±Ù‡ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if (newIndex >= 0 && newIndex < galleryImagesList.length) {
        currentImageIndex = newIndex;
        
        // ØªØ£Ø«ÙŠØ± Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙØ§Ø¡ ÙˆØ¸Ù‡ÙˆØ±)
        const img = document.getElementById('lb-img');
        img.style.opacity = '0.5';
        setTimeout(() => {
            updateLightboxContent();
            img.style.opacity = '1';
        }, 150);
        
    } else {
        // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø¢Ø®Ø±ØŒ Ù…Ù…ÙƒÙ† ØªØ¹Ù…Ù„ Ù‡Ø²Ø© Ø¨Ø³ÙŠØ·Ø© ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        if(navigator.vibrate) navigator.vibrate(50);
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø±Ø¶
function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
}

// ================= Ø¥Ø¶Ø§ÙØ©: Ø§Ù„ØªÙ‚Ù„ÙŠØ¨ Ø¨Ø§Ù„Ø³Ø­Ø¨ (Touch Swipe) Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ =================
let touchStartX = 0;
let touchEndX = 0;

const lbElement = document.getElementById('lightbox');

if(lbElement) {
    lbElement.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    lbElement.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });
}

function handleSwipe() {
    // Ù„Ùˆ Ø³Ø­Ø¨ ØµØ¨Ø§Ø¹Ù‡ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„Ø´Ù…Ø§Ù„ (Ø§Ù„ØªØ§Ù„ÙŠ)
    if (touchEndX < touchStartX - 50) { 
        changeGalleryImage(1); 
    }
    // Ù„Ùˆ Ø³Ø­Ø¨ ØµØ¨Ø§Ø¹Ù‡ Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ Ù„Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„Ø³Ø§Ø¨Ù‚)
    if (touchEndX > touchStartX + 50) { 
        changeGalleryImage(-1); 
    }
}
#toast {
    position: fixed !important; 
    bottom: 50px !important; 
    left: 50% !important; 
    transform: translateX(-50%) !important; 
    background: rgba(0, 0, 0, 0.9) !important; 
    color: #fff !important; 
    padding: 12px 25px !important; 
    border-radius: 30px !important; 
    font-size: 14px !important; 
    font-weight: bold !important;
    opacity: 0; 
    pointer-events: none; 
    transition: 0.3s; 
    
    /* ğŸ”¥ğŸ”¥ Ø¯Ù‡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ”¥ğŸ”¥ */
    z-index: 2147483647 !important; 
    
    box-shadow: 0 5px 20px rgba(0,0,0,0.5) !important;
    border: 1px solid rgba(255, 59, 48, 0.3) !important; /* Ø¨Ø±ÙˆØ§Ø² Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ */
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠÙ†Ø²Ù„ Ø³Ø·Ø±ÙŠÙ† */
}
/* ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
/* ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØµÙØ­Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© */
.profile-page {
    position: fixed;
    top: 0;       /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
    left: 0;      /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
    right: 0;     /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
    bottom: 0;    /* ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
    width: 100% !important;  /* Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ */
    height: 100% !important; /* Ø·ÙˆÙ„ ÙƒØ§Ù…Ù„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ */
    
    background: #0b1121;
    z-index: 99999; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠØºØ·ÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø© */
    
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.pp-header {
    height: 70px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: rgba(15, 25, 38, 0.95);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.pp-header h3 { color: #fff; margin: 0; font-size: 18px; }

.pp-content { flex: 1; overflow-y: auto; padding: 20px; }

/* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ */
.pp-user-info {
    display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;
}
.pp-avatar-lg {
    width: 100px; height: 100px; border-radius: 50%;
    background-color: #333; background-size: cover; background-position: center;
    border: 3px solid #00e5ff; box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
    margin-bottom: 15px;
}
.pp-name { font-size: 22px; font-weight: bold; color: #fff; margin-bottom: 5px; }
.encryption-pill {
    background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 20px;
    font-size: 11px; color: #94a3b8; display: flex; gap: 5px; align-items: center;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.profile-menu-list { display: flex; flex-direction: column; gap: 10px; }

.profile-item {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255, 255, 255, 0.03);
    padding: 15px; border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer; transition: 0.2s;
}
.profile-item:active { background: rgba(255, 255, 255, 0.08); transform: scale(0.98); }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ù„ÙˆÙ†Ø© Ù„ÙƒÙ„ Ø²Ø±Ø§Ø± */
.p-item-icon {
    width: 40px; height: 40px; border-radius: 12px;
    display: grid; place-items: center; font-size: 18px;
}
.ghost-icon { background: rgba(255,255,255,0.1); color: #fff; }
.media-icon { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
.search-icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
.mute-icon { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
.privacy-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }
.block-icon { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø³Ù‡Ù… */
.p-item-text { flex: 1; display: flex; flex-direction: column; }
.p-item-text span { font-size: 15px; color: #e2e8f0; font-weight: 500; }
.p-item-text small { font-size: 11px; color: #64748b; margin-top: 2px; }
.p-item-arrow { color: #475569; font-size: 16px; }

/* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø²Ø± Ø§Ù„Ø­Ø¸Ø± */
.block-item { border-color: rgba(239, 68, 68, 0.2); }

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ØµØ© */
.story-reply-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù…Ù…ÙŠØ²Ø© */
    padding: 8px;
    border-radius: 12px;
    margin-bottom: 5px;
    border-right: 3px solid var(--accent-color); /* Ø®Ø· Ù…Ù„ÙˆÙ† ÙŠÙ…ÙŠØ² Ø§Ù„Ø±Ø¯ */
}

.story-media-wrapper {
    width: 45px;
    height: 70px;
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
    border: 1px solid rgba(255,255,255,0.1);
}

.story-reply-media {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.story-reply-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.reply-label {
    font-size: 10px;
    color: #aaa;
    margin-bottom: 3px;
    font-weight: bold;
}

.reply-text-body {
    font-size: 14px;
    color: #fff;
}

/* ================= ØªØµÙ…ÙŠÙ… Ù…Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================= */

/* 1. Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
.media-gallery-overlay {
    background-color: #0b1121 !important; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ */
}

/* 2. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs) */
.mg-tabs {
    background: rgba(15, 25, 38, 0.95);
    padding: 10px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    gap: 15px;
    overflow-x: auto; /* Ø³ÙƒØ±ÙˆÙ„ Ù„Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© ØµØºÙŠØ±Ø© */
    scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± */
}
.mg-tab {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: #94a3b8;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s ease;
    white-space: nowrap;
}
.mg-tab.active {
    background: #00e5ff; /* Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù† */
    color: #000;
    border-color: #00e5ff;
    box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ) */
.grid-view {
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    grid-template-columns: repeat(3, 1fr); /* 3 Ø£Ø¹Ù…Ø¯Ø© */
    gap: 3px; /* Ù…Ø³Ø§ÙØ§Øª Ø¶ÙŠÙ‚Ø© Ø²ÙŠ Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù… */
    padding: 3px;
    align-content: start;
}
.grid-view.active { display: grid; }

.mg-item {
    position: relative;
    aspect-ratio: 1/1; /* Ù…Ø±Ø¨Ø¹ Ù…Ø«Ø§Ù„ÙŠ */
    background: #1e293b;
    overflow: hidden;
    cursor: pointer;
}
.mg-item img, .mg-item video {
    width: 100%; height: 100%; object-fit: cover;
    transition: transform 0.3s;
}
.mg-item:hover img { transform: scale(1.1); }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© */
.vid-indicator {
    position: absolute; top: 5px; right: 5px;
    color: #fff; font-size: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù„Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØªÙŠØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·) */
.list-view {
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    gap: 10px;
    padding: 15px;
}
.list-view.active { display: flex; }

/* ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù„Ù/Ø§Ù„Ø±Ø§Ø¨Ø· */
.mg-list-card {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255,255,255,0.03);
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: 0.2s;
}
.mg-list-card:active { background: rgba(255,255,255,0.08); }

.list-icon-box {
    width: 45px; height: 45px;
    border-radius: 10px;
    display: grid; place-items: center;
    font-size: 20px;
    flex-shrink: 0;
}
/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
.icon-file { background: rgba(245, 158, 11, 0.15); color: #f59e0b; } /* Ø£ØµÙØ± */
.icon-audio { background: rgba(16, 185, 129, 0.15); color: #10b981; } /* Ø£Ø®Ø¶Ø± */
.icon-link { background: rgba(59, 130, 246, 0.15); color: #3b82f6; } /* Ø£Ø²Ø±Ù‚ */

.list-info { flex: 1; overflow: hidden; }
.list-title { color: #fff; font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-sub { color: #64748b; font-size: 11px; margin-top: 3px; }

/* 5. ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© (Empty State) */
.empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 300px; color: #64748b; gap: 15px;
}
.empty-icon { font-size: 50px; opacity: 0.3; }


    </style>
</head>
<body>

   <div class="lightbox" id="lightbox" style="display:none;">
    <div onclick="closeLightbox()" class="lb-close">&times;</div>
    
    <div class="lb-nav prev" onclick="changeGalleryImage(-1)">
        <i class="fa-solid fa-chevron-right"></i>
    </div>

    <img id="lb-img" src="" class="lb-image">

    <div class="lb-nav next" onclick="changeGalleryImage(1)">
        <i class="fa-solid fa-chevron-left"></i>
    </div>
    
    <div id="lb-counter" class="lb-counter">1 / 5</div>
</div>

    
    <div id="toast" style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 6000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <i class="fa-solid fa-check-circle"></i> <span id="toast-msg">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­</span>
    </div>

    <div class="context-menu-overlay" id="contextMenuOverlay" onclick="closeContextMenu()">
        <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
            <div class="reactions-row" style="display: flex; justify-content: space-between; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 50px;">
                <span class="reaction-emoji" onclick="toggleReaction('â¤ï¸')">â¤ï¸</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜‚')">ğŸ˜‚</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜®')">ğŸ˜®</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜¢')">ğŸ˜¢</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ˜¡')">ğŸ˜¡</span>
                <span class="reaction-emoji" onclick="toggleReaction('ğŸ‘')">ğŸ‘</span>
            </div>
            <div class="menu-options">
                <button class="menu-btn" id="menuListenBtn" style="display:none" onclick="playMessageAudio()">
                    <i class="fa-solid fa-headphones" style="color:#00e5ff"></i> Ø§Ø³ØªÙ…Ø§Ø¹
                </button>
                <button class="menu-btn" onclick="activateReplyMode()"><i class="fa-solid fa-reply" style="color:#00e5ff"></i> Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                <button class="menu-btn" id="menuDeleteAllBtn" style="display:none" onclick="deleteMessageForEveryone()"><i class="fa-solid fa-trash-can" style="color:#ff3b30"></i> Ø­Ø°Ù Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
                <button class="menu-btn" id="menuSaveBtn" style="display:none" onclick="saveMedia()"><i class="fa-solid fa-download"></i> Ø­ÙØ¸</button>
                <button class="menu-btn" id="menuCopyBtn" style="display:none" onclick="copyText()"><i class="fa-solid fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
                <button class="menu-btn" onclick="deleteMessageLocal()"><i class="fa-solid fa-trash" style="color:#ff3b30"></i> Ø­Ø°Ù Ù…Ù† Ø¹Ù†Ø¯ÙŠ</button>
            </div>
        </div>
    </div>

    <div class="chat-header">
        <div class="header-right-section">
            <i class="fa-solid fa-arrow-right back-btn" onclick="history.back()"></i>
            <div class="user-avatar-container" onclick="openProfile()">
                <div id="headerImage" class="header-avatar"></div>
                <div class="online-status"></div>
            </div>
            <div class="header-info">
                <h3 id="headerNameWrapper">
                    <span id="headerName">...</span>
                    <span id="headerVerify"></span>
                  <i id="headerMuteIcon" class="fa-solid fa-bell-slash" style="display:none; color:#8b5cf6; font-size:14px; margin-right:8px;" title="ØªÙ… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"></i>

                </h3>
                <span id="headerStatus" class="status-text">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>
                <span id="typingIndicator" class="typing-text">ÙŠÙƒØªØ¨...</span>
            </div>
        </div>
      <div class="header-actions">
    <div class="icon-btn video" onclick="playUiSound('click'); initiateVideoCallUI()">
        <i class="fa-solid fa-video"></i>
    </div>
    <div class="icon-btn audio" onclick="playUiSound('click'); initiateCall()">
        <i class="fa-solid fa-phone"></i>
    </div>
</div>

    </div>

   <div class="chat-body" id="chatContainer">
    
    <div id="loadingSkeleton" class="skeleton-row">
        <div class="skeleton-msg skeleton-right" style="width: 55%;"></div>
        
        <div class="skeleton-msg skeleton-left" style="width: 40%;"></div>
        
        <div class="skeleton-msg skeleton-right" style="width: 70%;"></div>
        
        <div class="skeleton-msg skeleton-left" style="width: 50%;"></div>
    </div>

</div>


      <div class="chat-footer">
    <div class="reply-preview-bar" id="replyBar">
        <div class="reply-content">
            <div class="reply-title" id="replyTitle">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰...</div>
            <div class="reply-text" id="replyText">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
        </div>
        <i class="fa-solid fa-times close-reply" onclick="cancelReply()"></i>
    </div>

    <div class="recording-ui" id="recordingUI">
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="rec-wave">
                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
            </div>
            <span id="recordTimer" style="color:#ff3b30; font-weight:bold; font-family:monospace;">00:00</span>
        </div>
        <div style="display:flex; gap:20px; align-items:center;">
            <span style="color:#94a3b8; cursor:pointer; font-size:12px;" onclick="cancelRecording()">Ø¥Ù„ØºØ§Ø¡</span>
            <div onclick="stopAndSendRecording()" style="width:35px; height:35px; background:#ff3b30; border-radius:50%; display:grid; place-items:center; cursor:pointer; box-shadow: 0 0 10px rgba(255,59,48,0.4);">
                <i class="fa-solid fa-paper-plane" style="color:#fff; font-size:14px;"></i>
            </div>
        </div>
    </div>

    <div class="footer-actions-left">
        <div class="action-btn file-btn" onclick="playUiSound('click'); document.getElementById('fileInput').click()">
            <i class="fa-solid fa-paperclip"></i>
        </div>
        <div class="action-btn media-btn" onclick="playUiSound('click'); document.getElementById('mediaInput').click()">
            <i class="fa-regular fa-image"></i>
        </div>
    </div>

    <div class="action-btn destruct-btn" id="destructBtn" onclick="playUiSound('destruct'); toggleDestructMode()" style="margin-left: 5px; margin-right: 5px;">
        <i class="fa-solid fa-bomb"></i>
        <span class="destruct-badge" id="destructBadge" style="display:none;">OFF</span>
    </div>

    <div class="input-container">
       <textarea id="messageInput" class="chat-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." 
          oninput="autoResize(this); toggleSendButton(); detectMood(this.value)"></textarea>


    <div class="action-btn mic-btn" id="micBtn" onclick="playUiSound('record'); startRecording()" style="margin-right: 5px;">
        <i class="fa-solid fa-microphone"></i>
    </div>
    
    <div class="send-btn" id="sendBtn" onclick="playUiSound('sent'); sendMessage()">
        <i class="fa-solid fa-paper-plane"></i>
    </div>

    <input type="file" id="mediaInput" hidden accept="image/*,video/*" onchange="uploadMedia(this, 'media')">
    <input type="file" id="fileInput" hidden accept="*/*" onchange="uploadMedia(this, 'file')">
</div>


<div id="callOverlay" class="call-overlay">
    
    <div id="videoContainer" class="video-container">
        <video id="remoteScreenVideo" autoplay playsinline class="remote-screen-video" style="display:none;"></video>
        <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
        <video id="localVideo" autoplay playsinline muted class="local-video"></video>
    </div>

    <div class="top-actions" style="position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; z-index:20;">
        <button onclick="togglePip()" class="floating-btn">
            <i class="fa-solid fa-compress"></i> 
        </button>
        
        <button onclick="takeSnapshot()" class="floating-btn">
            <i class="fa-solid fa-camera"></i>
        </button>
    </div>
    
    <div class="maximize-btn" onclick="togglePip()"></div>

    <div class="call-bg" id="callBg"></div>
    <div class="call-bg-pattern"></div> <div class="call-info-section" id="callInfoSection">
        <div class="call-avatar-wrapper" style="position:relative;">
            <div class="call-avatar" id="callAvatar"></div>
            <div id="remoteMuteIcon" style="position:absolute; bottom:0; right:0; background:#ff3b30; width:30px; height:30px; border-radius:50%; display:none; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.3);">
                <i class="fa-solid fa-microphone-slash" style="color:#fff; font-size:14px;"></i>
            </div>
        </div>
        <h2 id="callName" class="call-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
        <h3 id="callStatusText" class="call-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
        <audio id="remoteAudio" autoplay></audio>
    </div>

    <div class="call-controls-section controls-dock" id="activeCallControls" style="display: none;">
       
        <button class="call-btn mute" onclick="toggleMute()" id="muteBtn">
            <i class="fa-solid fa-microphone"></i>
        </button>
        
        <button class="call-btn video" onclick="toggleVideoMode()" id="videoBtn">
            <i class="fa-solid fa-video-slash"></i>
        </button>
        
        <button class="call-btn screen-share" onclick="toggleScreenShare()" id="shareScreenBtn">
            <i class="fa-solid fa-desktop"></i>
        </button>

        <button class="call-btn switch-cam" onclick="switchCamera()" id="switchCamBtn" style="display:none;">
            <i class="fa-solid fa-camera-rotate"></i>
        </button>

        <button class="call-btn end" onclick="endCall()">
            <i class="fa-solid fa-phone-slash"></i>
        </button>
        
        <button class="call-btn speaker" onclick="toggleSpeaker()" id="speakerBtn">
            <i class="fa-solid fa-volume-high"></i>
        </button>

   </div>

   <div class="call-controls-section" id="incomingCallControls" style="display:none; gap: 60px; z-index: 20;">
        <button class="call-btn end" onclick="rejectCall()">
            <i class="fa-solid fa-phone-slash"></i>
        </button>
        <button class="call-btn accept" onclick="acceptIncomingCall()">
            <i class="fa-solid fa-phone"></i>
        </button>
    </div>

</div>





    <script>
// ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¥Ù„Ø§ Ù„Ùˆ ÙÙŠÙ‡ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©
navigator.vibrate = (function(origVibrate) {
    return function(pattern) {
        const callOverlay = document.getElementById('callOverlay');
        const incomingControls = document.getElementById('incomingCallControls');
        
        // Ù„Ùˆ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¸Ø§Ù‡Ø±Ø© ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¯ (Incoming) Ù…Ø¹Ø±ÙˆØ¶Ø©.. Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø²Ù†
        if (callOverlay && callOverlay.style.display === 'flex' && 
            incomingControls && incomingControls.style.display !== 'none') {
            return origVibrate.apply(this, arguments);
        }
        
        // ÙÙŠ Ø£ÙŠ Ø­Ø§Ù„Ø© ØªØ§Ù†ÙŠØ© (Ø±Ø³Ø§ÙŠÙ„ØŒ ÙØªØ­ Ø´Ø§ØªØŒ Ø¶ØºØ· Ø²Ø±Ø§ÙŠØ±).. Ø§Ø±ÙØ¶ Ø§Ù„Ø²Ù†
        return false;
    };
})(navigator.vibrate);

           
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª
        // 1. ØµÙˆØª Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…Ø¯Ù…Ø¬ Ø¬ÙˆÙ‡ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„ ÙÙˆØ±Ø§Ù‹)
// ================= Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø¨Ø¯ÙˆÙ† Ù†Øª) =================

// Ø¯Ù‡ ÙƒÙˆØ¯ ØµÙˆØª "Pop" Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ ÙˆÙ…Ø¯Ù…Ø¬ Ø¬ÙˆÙ‡ Ø§Ù„Ù…Ù„Ù (Ù…Ø´ Ù‡ÙŠØ­ØªØ§Ø¬ Ù†Øª)
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ù‡Ø°Ø§:
          document.addEventListener("DOMContentLoaded", function() {
    
    // Ø¶ÙŠÙÙ†Ø§ 'privacySettingsPage' Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯ÙŠ ğŸ‘‡
    const overlayIds = [
        'profilePage', 
        'privacySettingsPage', // <--- Ø¯ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©
        'deleteModal', 
        'callOverlay', 
        'contextMenuOverlay', 
        'lightbox', 
        'previewModal',
        'mediaGalleryOverlay',
        'fullSearchOverlay',
        'customBlockModal'
    ];

    overlayIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.parentNode) {
            document.body.appendChild(element); // Ø¨ÙŠÙ†Ù‚Ù„Ù‡Ø§ Ù„ØªÙƒÙˆÙ† Ø§Ø¨Ù† Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù€ body
        }
    });
});


const alertSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m3u8"); // Ù…Ø«Ø§Ù„ Ù„ØµÙˆØª Ø®Ø§Ø±Ø¬ÙŠ
// Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù…Ù„Ù MP3

// Ù…Ù„Ø­ÙˆØ¸Ø©: Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØª ÙŠØ´ØªØºÙ„ 100% ÙŠÙØ¶Ù„ ØªØ³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¯Ù‡ ÙƒØ¨Ø¯ÙŠÙ„ Ù„Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ù‚ØµÙŠØ±:
const backupSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
// ØªØ¹Ø±ÙŠÙ ØµÙˆØª Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªÙƒØ© Ù†Ø§Ø¹Ù…Ø© Ø²ÙŠ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
// Ø§Ø®ØªØ±ØªÙ„Ùƒ ØµÙˆØª "Pop" Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ ÙˆØ³Ø±ÙŠØ¹
// ================= ØµÙˆØª Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªÙƒØ© Ø³Ø±ÙŠØ¹Ø© Ø²ÙŠ Ù…Ø§Ø³Ù†Ø¬Ø±) =================
// Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ (CDN) Ù„Ø£Ù†Ù‡ Ø£Ø³Ø±Ø¹ Ø¨ÙƒØªÙŠØ± ÙˆÙ…Ø´ Ø¨ÙŠÙ‚Ø·Ø¹
const keyPressSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"); 
keyPressSound.volume = 0.3; // ØµÙˆØª Ù‡Ø§Ø¯ÙŠ (30%)

let lastKeySoundTime = 0;

function playKeySound() {
    // 1. Ù„Ùˆ Ø§Ù„ÙƒØªÙ… Ø´ØºØ§Ù„ØŒ Ø§Ø®Ø±Ø¬ ÙÙˆØ±Ø§Ù‹
    if (typeof isMuted !== 'undefined' && isMuted) return;

    const now = Date.now();
    
    // 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø³Ø±Ø¹Ø©: Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ÙƒÙ„ 80 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
    // (Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙƒØªØ¨Øª Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„ØµØ§Ø±ÙˆØ® Ø§Ù„ØµÙˆØª Ù…ÙŠØ¨Ù‚Ø§Ø´ Ù…Ø²Ø¹Ø¬)
    if (now - lastKeySoundTime > 80) {
        
        // 3. CloneNode: Ø¯ÙŠ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØ®Ù„ÙŠ Ø§Ù„ØµÙˆØª ÙŠØ´ØªØºÙ„ ÙˆØ±Ø§ Ø¨Ø¹Ø¶Ù‡ Ù…Ù† ØºÙŠØ± Ù…Ø§ ÙŠØ³ØªÙ†Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙŠØ®Ù„Øµ
        const soundClone = keyPressSound.cloneNode(); 
        soundClone.volume = 0.2; // Ù†ÙˆØ·ÙŠÙ‡ Ø³Ù†Ø© ÙƒÙ…Ø§Ù† Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
        
        // ØªØ´ØºÙŠÙ„ (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹Ù„Ù‚)
        soundClone.play().catch(() => {}); 
        
        lastKeySoundTime = now;
    }
}

const realClickSound = new Audio("data:audio/wav;base64,UklGRi5vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YTZvT18AAAAAAAABAgMEBQYHCAkKCwwNDg8QERITFBUWFxgZGhscHR4fICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDRFVVV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/w=="); 

// Ù…Ù„Ø­ÙˆØ¸Ø©: Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ø¯Ù‡ "ÙƒÙˆØ¯ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù‚ØµÙŠØ±" Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ù„ÙƒÙ† Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØª ÙŠØ¨Ù‚Ù‰ ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆÙ‚ÙˆÙŠ
// Ø£Ù†Ø§ Ø¹Ù…Ù„ØªÙ„Ùƒ Ø¯Ø§Ù„Ø© Ø¨ØªÙˆÙ„Ø¯ Ø§Ù„ØµÙˆØª Ø¨Ù†ÙØ³Ù‡Ø§ (Oscillator) Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† "ØªÙƒØ©" ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù…Ø­ØªØ±Ù…Ø© Ù…Ù† ØºÙŠØ± Ù…Ø§ Ø£Ø­Ø·Ù„Ùƒ ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ ÙŠØªÙ‚Ù„ Ø§Ù„ØµÙØ­Ø©.

// ================= 1. ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø± Ù†Ø§Ø¹Ù… ÙˆÙ‡Ø§Ø¯Ø¦ (Soft Bubble) =================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSoftBubble() {
    // Ù„Ùˆ Ø§Ù„ÙƒØªÙ… Ø´ØºØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ÙÙŠØ©ØŒ Ù†Ø®Ø±Ø¬
    if ((typeof isMuted !== 'undefined' && isMuted) || document.hidden) return;

    const t = audioCtx.currentTime;
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù†Ø§Ø¹Ù… (Sine Wave) - ØµÙˆØª Ø¯Ø§Ø¦Ø±ÙŠ Ù†Ø§Ø¹Ù… Ù…Ø´ Ø­Ø§Ø¯
    oscillator.type = 'sine';
    
    // ØªØ±Ø¯Ø¯ Ù‡Ø§Ø¯ÙŠ (Ù†ØºÙ…Ø© Ù…ØªÙˆØ³Ø·Ø©)
    oscillator.frequency.setValueAtTime(600, t);
    oscillator.frequency.exponentialRampToValueAtTime(300, t + 0.1); // ÙŠÙ†Ø²Ù„ Ø¨Ù†Ø¹ÙˆÙ…Ø©

    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ù„Ùˆ (Fade In/Out Ø³Ø±ÙŠØ¹)
    gainNode.gain.setValueAtTime(0, t);
    gainNode.gain.linearRampToValueAtTime(0.1, t + 0.02); // ÙŠØ¹Ù„Ù‰ Ù„Ù€ 10% Ø¨Ø³ (ÙˆØ§Ø·ÙŠ Ø¬Ø¯Ø§Ù‹)
    gainNode.gain.linearRampToValueAtTime(0, t + 0.15);   // ÙŠØ®ØªÙÙŠ ØªØ§Ù†ÙŠ

    oscillator.start(t);
    oscillator.stop(t + 0.2);
}

// Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±
let remoteTypingInterval = null;

function manageRemoteTypingSound(isTyping) {
    if (typeof isMuted !== 'undefined' && isMuted) {
        clearInterval(remoteTypingInterval);
        remoteTypingInterval = null;
        return;
    }

    if (isTyping) {
        if (!remoteTypingInterval) {
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙˆØ±Ø§Ù‹
            playSoftBubble();
            
            // Ø«Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙƒÙ„ 4 Ø«ÙˆØ§Ù†ÙŠ
            remoteTypingInterval = setInterval(() => {
                playSoftBubble();
            }, 4000); // 4000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = 4 Ø«ÙˆØ§Ù†ÙŠ
        }
    } else {
        clearInterval(remoteTypingInterval);
        remoteTypingInterval = null;
    }
}


// ================= 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ§Ù„Ø±Ø¨Ø· =================
function setupTypingListener() {
    db.collection("chats").doc(chatId).onSnapshot(doc => {
        if(!doc.exists) return;
        const data = doc.data();
        
        const typingArray = data.typing || [];
        
        // Ù‡Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¨ÙŠÙƒØªØ¨ØŸ
        const isSomeoneTyping = typingArray.some(uid => uid !== currentUserId);
        
        const st = document.getElementById('headerStatus');
        const tt = document.getElementById('typingIndicator');
        
        // ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        manageRemoteTypingSound(isSomeoneTyping);
        
        if(isSomeoneTyping) { 
            if(st) st.style.display = 'none'; 
            if(tt) {
                tt.style.display = 'block';
                tt.innerHTML = `
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>`;
            }
        } else {
            if(st) st.style.display = 'block';
            if(tt) {
                tt.style.display = 'none';
                tt.innerHTML = ''; 
            }
        }
    });
}


//
function playMessageSound() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø¯Ù…Ø¬
    let playPromise = backupSound.play();

    if (playPromise !== undefined) {
        playPromise.then(_ => {
            // Ø§Ù„ØµÙˆØª Ø§Ø´ØªØºÙ„ ØªÙ…Ø§Ù…
            console.log("Sound played successfully");
        })
        .catch(error => {
            // Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØµÙˆØªØŒ Ù†Ø´ØºÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙƒØ¨Ø¯ÙŠÙ„
            console.log("Sound blocked, vibrating instead");
            if (navigator.vibrate) navigator.vibrate([200, 50, 200]);
        });
    }
    
}

        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            databaseURL: "https://pools-e4381-default-rtdb.firebaseio.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f",
            measurementId: "G-EYPMCWES9N"
        };
        

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // 3. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();
        
        db.settings({ merge: true });


        const params = new URLSearchParams(location.search);
        const chatId = params.get("chatId");
        let activeTimers = []; // Ø¯Ù‡ Ù…Ø®Ø²Ù† Ø¹Ø´Ø§Ù† Ù†ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ØªÙ‚ÙØ´
// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„ÙƒØªÙ… ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ chatId

        let currentUserId = null, selectedMsgId = null, selectedMsgData = null;
        let currentReply = null, userCache = {}, isFirstLoad = true, typingTimeout = null, cachedOtherUserId = null; 
        let vibrationInterval = null; // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†ÙƒØ±Ø± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²
// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
let oldestDoc = null; 
let isLoadingOld = false;
let noAnswerTimeout = null; // Ù…ØªØºÙŠØ± Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯
    let cachedCameraTrack = null; // Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¤Ù‚Øª
let destructTime = 0;
          
// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
let isArchiveMode = false; // Ù‡Ù„ Ù†Ø­Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ
let newestArchivedDoc = null; // Ø£Ø­Ø¯Ø« Ø±Ø³Ø§Ù„Ø© Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø¹Ø´Ø§Ù† Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡Ø§)
let isLoadingNewer = false;   // Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
let galleryImagesList = []; // Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ±
let currentImageIndex = 0;  // Ù„Ù…Ø¹Ø±ÙØ© Ø§Ø­Ù†Ø§ ÙˆØ§Ù‚ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù†Ù‡ÙŠ ØµÙˆØ±Ø©
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
let isUserBlocked = false; // Ù‡Ù„ Ø£Ù†Ø§ Ø­Ø¸Ø±ØªÙ‡ØŸ
let amIBlocked = false;    // Ù‡Ù„ Ù‡Ùˆ Ø­Ø¸Ø±Ù†ÙŠØŸ
let blockCooldown = 0;     // ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ (Real-time)
function listenForBlockStatus() {
    if (!chatId || !currentUserId || !cachedOtherUserId) return;

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ Ù‚Ø¯ Ø­Ø¸Ø±Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
    db.collection('users').doc(currentUserId).collection('blocked').doc(cachedOtherUserId)
        .onSnapshot(doc => {
            isUserBlocked = doc.exists;
            updateBlockUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        });

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù‚Ø¯ Ø­Ø¸Ø±Ù†ÙŠ
    db.collection('users').doc(cachedOtherUserId).collection('blocked').doc(currentUserId)
        .onSnapshot(doc => {
            amIBlocked = doc.exists;
            updateBlockUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        });
}

          
function toggleDestructMode() {
const btn = document.getElementById('destructBtn');
const badge = document.getElementById('destructBadge');

if (destructTime === 0) destructTime = 5;
else if (destructTime === 5) destructTime = 10;
else if (destructTime === 10) destructTime = 30;
else destructTime = 0;

if (destructTime > 0) {
btn.classList.add('active');
badge.style.display = 'block';
badge.innerText = destructTime + 's';
showToast(`ğŸ’£ Ø§Ù„ØªØ¯Ù…ÙŠØ±: ${destructTime}Ø«`);
} else {
btn.classList.remove('active');
badge.style.display = 'none';
showToast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¯Ù…ÙŠØ±");
}
}

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
let mediaRecorder = null;
let audioChunks = [];
let recordInterval = null;
let seconds = 0;

auth.onAuthStateChanged(async user => {
    if (user) {
        currentUserId = user.uid;
        
        // ================= Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙÙˆØ±Ø§Ù‹ =================
        try {
            const userDoc = await db.collection('users').doc(currentUserId).get();
            if(userDoc.exists && userDoc.data().privacy) {
                myPrivacySettings = userDoc.data().privacy;
                console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©:", myPrivacySettings);
            }
        } catch(e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ØµÙˆØµÙŠØ©", e);
        }
        // ====================================================================

        if(chatId) {
            await loadChatDetails(); 
            loadMessages();
            setupTypingListener();
            listenForIncomingCalls();
        }
    } else {
        window.location.href = 'login.html';
    }
});

// ================= ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Fix Typing) =================
const msgInput = document.getElementById("messageInput");

msgInput.addEventListener('input', () => {
    if(chatId && currentUserId) {
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø¯Ø§Ù… arrayUnion ÙÙŠ Ø­Ù‚Ù„ 'typing' Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
        playKeySound(); 
        db.collection("chats").doc(chatId).update({ 
            typing: firebase.firestore.FieldValue.arrayUnion(currentUserId) 
        }).catch(err => {
            // Ù„Ùˆ Ø§Ù„Ù…Ù„Ù Ù„Ø³Ù‡ Ù…ÙÙŠØ´ ÙÙŠÙ‡ Ø­Ù‚Ù„ typingØŒ Ù†Ø³ØªØ®Ø¯Ù… set Ù…Ø¹ merge
            db.collection("chats").doc(chatId).set({ 
                typing: firebase.firestore.FieldValue.arrayUnion(currentUserId) 
            }, { merge: true });
        });

        clearTimeout(typingTimeout);
        
        // Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø§Ø³Ù…
        typingTimeout = setTimeout(() => { 
            db.collection("chats").doc(chatId).update({ 
                typing: firebase.firestore.FieldValue.arrayRemove(currentUserId) 
            }); 
        }, 3000);
    }
});

       function setupTypingListener() {
    db.collection("chats").doc(chatId).onSnapshot(doc => {
        if(!doc.exists) return;
        const data = doc.data();
        
        // Ø¬Ù„Ø¨ Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        const typingArray = data.typing || [];
        
        // Ù‡Ù„ ÙÙŠÙ‡ Ø­Ø¯ ØºÙŠØ±ÙŠ Ø¨ÙŠÙƒØªØ¨ØŸ
        const isSomeoneTyping = typingArray.some(uid => uid !== currentUserId);
        
        const st = document.getElementById('headerStatus');
        const tt = document.getElementById('typingIndicator');
        
        // ğŸ”¥ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„Ø±Ø¨Ø·: Ø´ØºÙ„ Ø£Ùˆ ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© ğŸ”¥ğŸ”¥
        manageRemoteTypingSound(isSomeoneTyping);

        if(isSomeoneTyping) { 
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            if(st) st.style.display = 'none'; 
            if(tt) {
                tt.style.display = 'block';
                tt.innerHTML = `
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>`;
            }
        } else {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø±
            if(st) st.style.display = 'block';
            if(tt) {
                tt.style.display = 'none';
                tt.innerHTML = ''; 
            }
        }
    });
}



        function toggleVideo(container) {
            const video = container.querySelector('video');
            if (video.paused) { 
                document.querySelectorAll('video').forEach(v => { v.pause(); v.parentElement.classList.remove('playing'); }); 
                video.play(); container.classList.add('playing'); 
            } else { 
                video.pause(); container.classList.remove('playing'); 
            }
        }

        
let currentUploadType = 'file'; 
let selectedFile = null;

function uploadMedia(input, type) {
    if (!input.files || !input.files[0]) return;
    
    selectedFile = input.files[0];
    currentUploadType = type; // Ø­ÙØ¸ Ø§Ù„Ù†ÙˆØ¹

    // Ù„Ùˆ ØµÙˆØ± Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    if (type === 'media' || selectedFile.type.startsWith('image/') || selectedFile.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const container = document.getElementById('previewContainer');
            container.innerHTML = ''; 

            if (selectedFile.type.startsWith('image')) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-img';
                container.appendChild(img);
            } else if (selectedFile.type.startsWith('video')) {
                const vid = document.createElement('video');
                vid.src = e.target.result;
                vid.className = 'preview-vid';
                vid.controls = true;
                container.appendChild(vid);
            }
            document.getElementById('previewModal').style.display = 'flex';
        }
        reader.readAsDataURL(selectedFile);
    } else {
        // Ù„Ùˆ Ù…Ù„Ù Ø¹Ø§Ø¯ÙŠ Ù†Ø±ÙØ¹Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù: ${selectedFile.name}ØŸ`)) {
            confirmUpload(); 
        } else {
            selectedFile = null;
            input.value = "";
        }
    }
    input.value = ""; 
}
function cancelPreview() {
    selectedFile = null;
    document.getElementById('previewModal').style.display = 'none';
}

async function confirmUpload() {
    if (!selectedFile) return;
    document.getElementById('previewModal').style.display = 'none';
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ Ø¨Ø¯Ù‚Ø© Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    let msgType = 'file'; 
    if (selectedFile.type.startsWith('image/')) msgType = 'image';
    else if (selectedFile.type.startsWith('video/')) msgType = 'video';
    
    try {
        showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...");
        
        // Ù…Ø³Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ†
        const folder = msgType === 'file' ? 'chat_docs' : 'chat_media';
        const path = `${folder}/${Date.now()}_${selectedFile.name}`;
        
        const ref = storage.ref(path);
        await ref.put(selectedFile);
        const url = await ref.getDownloadURL();
        
        let msgPayload = { 
    text: val, 
    uid: currentUserId, 
    type: 'text',
    seen: false, 
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    
    isGhost: isGhostMode  // ğŸ‘ˆ Ø£Ù‡Ù… Ø³Ø·Ø± (ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯)
}; 


        
        if (destructTime > 0) {
            msgPayload.selfDestruct = destructTime;
            msgPayload.expireAt = firebase.firestore.Timestamp.fromMillis(Date.now() + (destructTime * 1000));
        }

        if(currentReply) {
            msgPayload.replyTo = { 
                id: currentReply.id, 
                text: currentReply.text, 
                sender: currentReply.sender 
            };
        }

        await db.collection("chats").doc(chatId).collection("messages").add(msgPayload);
        
        cancelReply();
        selectedFile = null;
        showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");

    } catch (err) { 
        console.error(err); 
        showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ âŒ"); 
        selectedFile = null; 
    }
}


        function activateReplyMode() {
            if(!selectedMsgData) return;
            currentReply = { id: selectedMsgId, text: selectedMsgData.type === 'text' ? selectedMsgData.text : (selectedMsgData.type==='image'?'ğŸ“· ØµÙˆØ±Ø©':'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ'), sender: selectedMsgData.senderName || 'Ù…Ø³ØªØ®Ø¯Ù…' };
            document.getElementById('replyBar').style.display = 'flex';
            document.getElementById('replyTitle').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${currentReply.sender}`;
            document.getElementById('replyText').innerText = currentReply.text;
            document.getElementById('messageInput').focus();
            closeContextMenu();
        }
        function cancelReply() { currentReply = null; document.getElementById('replyBar').style.display = 'none'; }

        // ================= Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ =================

// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø¨Ø¯Ù„ Ø§Ù„Ù€ confirm Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
function deleteMessageForEveryone() {
    closeContextMenu(); // Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ„
    if(selectedMsgId) {
        document.getElementById('deleteModal').style.display = 'flex';
    }
}

// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²)
async function performDelete() {
    if(!selectedMsgId) return;
    
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙˆØ±Ø§Ù‹ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
    closeDeleteModal();
    
    try {
        const msgRef = db.collection("chats").doc(chatId).collection("messages").doc(selectedMsgId);
        
        // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… set Ù…Ø¹ merge Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
        await msgRef.set({
            type: 'deleted',          // ØªØºÙŠÙŠØ± Ø§Ù„Ù†ÙˆØ¹ Ù„Ù…Ø­Ø°ÙˆÙ
            text: '',                 // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ
            fileUrl: null,            // Ø­Ø°Ù Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø¥Ù† ÙˆØ¬Ø¯
            reaction: firebase.firestore.FieldValue.delete() // Ø­Ø°Ù Ø£ÙŠ ØªÙØ§Ø¹Ù„Ø§Øª
        }, { merge: true });

        showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸ—‘ï¸");
        
    } catch(e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ");
    }
}

   async function getUser(uid) { if(userCache[uid]) return userCache[uid]; try { const d = await db.collection('users').doc(uid).get(); const data = d.data() || {}; userCache[uid] = { name: data.name || "Ù…Ø³ØªØ®Ø¯Ù…", char: (data.name || 'U')[0].toUpperCase(), color: data.color || "#5D5FEF", isVerified: data.isVerified === true, profilePic: data.profilePic || null }; } catch(e) { userCache[uid] = { name: "Ù…Ø³ØªØ®Ø¯Ù…", char: "U", color: "#555", isVerified: false, profilePic: null }; } return userCache[uid]; }
        
        let headerUnsubscribe = null; // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ø´Ø§Ù† Ù†Ù„ØºÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…

async function updateHeader(uid) {
    if (!uid) return;

    // 1. Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø®Ø±Ø¬Øª ÙˆØ¯Ø®Ù„Øª Ø´Ø§Øª ØªØ§Ù†ÙŠ Ù…ÙŠØ¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„)
    if (headerUnsubscribe) headerUnsubscribe();

    // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ÙÙˆØ±ÙŠ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
    headerUnsubscribe = db.collection('users').doc(uid).onSnapshot(doc => {
        if (!doc.exists) return;
        const u = doc.data();

        // ============================================================
        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ ÙˆØ§Ø³Ù… Ø§Ù„Ø±Ø§Ø³Ù„)
        // ============================================================
        userCache[uid] = {
            ...userCache[uid], // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¯Ø§ØªØ§ Ù‚Ø¯ÙŠÙ…Ø©
            name: u.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            profilePic: u.profilePic || null,
            color: u.color || "#555",
            char: (u.name || 'U')[0].toUpperCase(),
            lastSeen: u.lastSeen, // Ø¨Ù†Ø­ØªØ§Ø¬Ù‡ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
            privacy: u.privacy || {} // ğŸ”¥ ØªØ®Ø²ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        };

        // ============================================================
        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        // ============================================================
        const displayName = u.name || "Ù…Ø³ØªØ®Ø¯Ù…";
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
        const headerNameEl = document.getElementById("headerName");
        if(headerNameEl) headerNameEl.innerText = displayName;
        
        const callNameEl = document.getElementById("callName"); 
        if(callNameEl) callNameEl.innerText = displayName; // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©
        const hImg = document.getElementById("headerImage");
        const callAvatar = document.getElementById("callAvatar"); // ØµÙˆØ±Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„

        if (u.profilePic) {
            // -- Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØ±Ø© --
            if(hImg) {
                hImg.style.backgroundImage = `url('${u.profilePic}')`;
                hImg.innerText = ''; 
                hImg.style.backgroundColor = 'transparent';
            }
            if(callAvatar) callAvatar.style.backgroundImage = `url('${u.profilePic}')`;

        } else {
            // -- Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø© (Ø­Ø±Ù ÙˆØ±Ù‚Ù…) --
            if(hImg) {
                hImg.style.backgroundImage = 'none';
                hImg.style.backgroundColor = u.color || '#555';
                hImg.innerText = (u.name || 'U')[0].toUpperCase();
            }
            if(callAvatar) {
                callAvatar.style.backgroundImage = 'none';
                callAvatar.style.backgroundColor = u.color || '#333';
            }
        }

        // ============================================================
        // 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Online Status) + ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙˆØµÙŠØ© ğŸ”¥
        // ============================================================
        const statusElement = document.getElementById("headerStatus");
        const onlineIndicator = document.querySelector(".online-status");

        if (u.lastSeen) {
            
            // ğŸ”¥ ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© (Ù‡Ù„ Ø£Ø®ÙÙ‰ Ø¸Ù‡ÙˆØ±Ù‡ØŸ) ğŸ”¥
            const isHidden = u.privacy && u.privacy.hideLastSeen;

            if (isHidden) {
                // Ù„Ùˆ Ù…ÙØ¹Ù„ Ø§Ù„Ø®ØµÙˆØµÙŠØ©: Ù†Ø®ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆÙ†Ø·ÙÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡
                if(statusElement) {
                    statusElement.innerText = ""; 
                    statusElement.style.display = 'none'; 
                }
                if(onlineIndicator) {
                    onlineIndicator.style.backgroundColor = "transparent"; 
                    onlineIndicator.style.boxShadow = "none";
                }
            } 
            else {
                // Ù„Ùˆ Ù…Ø´ Ù…ÙØ¹Ù„ Ø§Ù„Ø®ØµÙˆØµÙŠØ©: Ù†Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø¹Ø§Ø¯ÙŠ
                if(statusElement) statusElement.style.display = 'block';
                
                const statusText = formatLastSeen(u.lastSeen);
                if(statusElement) statusElement.innerText = statusText;

                if (statusText === 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†') {
                    // Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ø£Ø®Ø¶Ø±)
                    if(statusElement) statusElement.style.color = "#10b981";
                    if(onlineIndicator) {
                        onlineIndicator.style.backgroundColor = "#10b981";
                        onlineIndicator.style.boxShadow = "0 0 8px #10b981";
                    }
                } else {
                    // Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ø±Ù…Ø§Ø¯ÙŠ)
                    if(statusElement) statusElement.style.color = "#94a3b8";
                    if(onlineIndicator) {
                        onlineIndicator.style.backgroundColor = "#94a3b8"; 
                        onlineIndicator.style.boxShadow = "none";
                    }
                }
            }
        } else {
            // Ù„Ùˆ Ù…ÙÙŠØ´ lastSeen Ø£ØµÙ„Ø§Ù‹
            if(statusElement) statusElement.innerText = "";
            if(onlineIndicator) onlineIndicator.style.backgroundColor = "transparent";
        }
        

    });
}



       // Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ù…Ø­Ø¯Ø«Ø© Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
function openProfile() {
    // 1. Ø¨Ù†Ø§Ø®Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„ØµØºÙŠØ±
    const headerName = document.getElementById('headerName').innerText;
    const headerImgStyle = document.getElementById('headerImage').style.backgroundImage;
    const headerInitial = document.getElementById('headerImage').innerText;

    // 2. Ø¨Ù†Ø­Ø·Ù‡Ù… ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    const bigImg = document.getElementById('profilePageImg');
    document.getElementById('profilePageName').innerText = headerName;

    if (headerImgStyle && headerImgStyle !== 'none' && headerImgStyle !== '') {
        bigImg.style.backgroundImage = headerImgStyle;
        bigImg.innerText = '';
        bigImg.style.backgroundColor = 'transparent';
    } else {
        bigImg.style.backgroundImage = 'none';
        bigImg.style.backgroundColor = '#555';
        bigImg.style.display = 'grid';
        bigImg.style.placeItems = 'center';
        bigImg.style.fontSize = '40px';
        bigImg.style.color = '#fff';
        bigImg.innerText = headerInitial;
    }

    // 3. Ø¨Ù†Ø¸Ù‡Ø± Ø§Ù„ØµÙØ­Ø©
    document.getElementById('profilePage').style.display = 'flex';
}

        function closeProfile() { document.getElementById('profilePage').style.display='none'; }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
// ================= Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® =================
function isSameDay(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
}

function formatDateSticky(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (isSameDay(date, today)) return "Ø§Ù„ÙŠÙˆÙ…";
    if (isSameDay(date, yesterday)) return "Ø£Ù…Ø³";
    return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' });
}

// ================= Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„ÙƒØ§Ù…Ù„Ø©) =================
function loadMessages() {
    
    db.collection("chats").doc(chatId).collection("messages")
      .orderBy("createdAt", "asc")
      .limitToLast(20) // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø©
      .onSnapshot(async snap => {
          

          document.getElementById('loadingSkeleton')?.remove(); 
        const container = document.getElementById("chatContainer");
if (isFirstLoad) {
    // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙ ÙƒØ§Ù† Ù‡Ù†Ø§
    container.scrollTop = container.scrollHeight;
    requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
}

    
        // 1. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}
// âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ù†Ø­Ø¯Ø« Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· ÙÙŠ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ù„Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± ÙØ§Ø¶ÙŠ
if (snap.docs.length > 0 && (isFirstLoad || !oldestDoc)) {
    oldestDoc = snap.docs[0];
}
// Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© loadMessages...
if (!isFirstLoad) {
    snap.docChanges().forEach(change => {
        if (change.type === 'added') {
            const d = change.doc.data();
            
            // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ (ÙŠØ¹Ù†ÙŠ Ø¬Ø§ÙŠØ© Ù…Ù† Ø­Ø¯ ØªØ§Ù†ÙŠ)
            // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ (ÙŠØ¹Ù†ÙŠ Ø¬Ø§ÙŠØ© Ù…Ù† Ø­Ø¯ ØªØ§Ù†ÙŠ)
if (d.uid !== currentUserId) {
    


    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø§Ù‡ØªØ²Ø§Ø²)

                // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
                if (document.hidden && Notification.permission === "granted") {
                    new Notification("Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’¬", {
                        body: d.type === 'text' ? d.text : 'Ø£Ø±Ø³Ù„ Ù…Ø±ÙÙ‚Ø§Ù‹ ğŸ“',
                        icon: 'img/logo.png', // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù„ÙˆØ¬Ùˆ Ø­Ø·Ù‡ Ù‡Ù†Ø§
                        vibrate: [200, 100, 200]
                    });
                }
            }
        }
    });
}


        // 1. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ÙƒØ§Ø´)
        let potentialOtherId = null; 
        const uids = new Set(); 
        snap.docs.forEach(d => { 
            const u = d.data().uid; 
            uids.add(u); 
            if(u !== currentUserId) potentialOtherId = u; 
        });
        
        if(potentialOtherId) cachedOtherUserId = potentialOtherId; 
        if(cachedOtherUserId) await updateHeader(cachedOtherUserId);
        
        await Promise.all(Array.from(uids).map(uid => getUser(uid)));

        // 2. Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ø¨Ù†Ø§Ø¡ HTML
        let html = "";
        let prevMsg = null; // Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù„Ù„ØªØ¬Ù…ÙŠØ¹)
        let lastDate = null; // Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ù„Ù„ÙÙˆØ§ØµÙ„)

        let destructQueue = []; // ğŸ‘ˆ Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù€ Loop

                    snap.forEach(doc => {
                        
    const msg = doc.data();
    const isMe = msg.uid === currentUserId;
    const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };

    // 1. ÙÙ„ØªØ± ÙˆÙ‚Øª Ø§Ù„ØªØ¯Ù…ÙŠØ± (Ø¹Ø´Ø§Ù† ÙŠØ®ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ùˆ ÙˆÙ‚ØªÙ‡Ø§ Ø®Ù„Øµ)
    if (msg.selfDestruct && msg.type !== 'deleted') {
        const expiresAt = (msg.createdAt ? msg.createdAt.toMillis() : Date.now()) + (msg.selfDestruct * 1000);
        const timeLeft = expiresAt - Date.now();
        if (timeLeft <= 0) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        destructQueue.push({ id: doc.id, timeLeft: timeLeft, isMe: isMe });
    }

    // 2. ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const msgDate = msg.createdAt ? msg.createdAt.toDate() : new Date();
    if (!lastDate || !isSameDay(msgDate, lastDate)) {
        html += `<div class="date-divider"><span>${formatDateSticky(msgDate)}</span></div>`;
        lastDate = msgDate;
        prevMsg = null;
    }
            // ğŸ‘‡ğŸ‘‡ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§) ğŸ‘‡ğŸ‘‡
            if (msg.type === 'system') {
                const actionText = msg.text === 'ghost_on' 
                    ? 'Ù‚Ø§Ù… Ø¨ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»' 
                    : 'Ù‚Ø§Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸš«';
                    
                html += `
                <div class="system-msg-row" id="msg_${doc.id}">
                    <span class="system-msg-text">
                        ${actionText} Ø¨ÙˆØ§Ø³Ø·Ø© <span class="system-user-name">${u.name}</span>
                    </span>
                </div>`;
                
                return; // ğŸ›‘ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† ÙŠÙˆÙ‚Ù Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            }
            // ğŸ‘†ğŸ‘† Ù†Ù‡Ø§ÙŠØ© ÙƒÙˆØ¯ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ‘†ğŸ‘†

    // 3. Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    let content = "";
    let bubbleClass = "msg-bubble target-bubble"; 

    if (msg.type === 'deleted') {
        const deleteText = isMe ? "ğŸš« Ø£Ù†Øª Ø­Ø°ÙØª Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" : "ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
        content = `<span style="font-style: italic; color: #94a3b8; font-size: 13px;">${deleteText}</span>`;
        bubbleClass += " deleted"; 
    }
                        else if (msg.type === 'story_reply') {
    let mediaTag = '';
    // ØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ø§Ù„Ù‚ØµØ© ÙÙŠØ¯ÙŠÙˆ ÙˆÙ„Ø§ ØµÙˆØ±Ø©
    if (msg.storyType === 'video') {
        mediaTag = `<video src="${msg.storyUrl}" class="story-reply-media" muted></video>`;
    } else {
        mediaTag = `<img src="${msg.storyUrl}" class="story-reply-media">`;
    }

    content = `
        <div class="story-reply-container" onclick="window.open('${msg.storyUrl}', '_blank')">
            <div class="story-media-wrapper">
                ${mediaTag}
            </div>
            <div class="story-reply-content">
                <div class="reply-label"><i class="fa-solid fa-reply"></i> Ø±Ø¯ Ø¹Ù„Ù‰ Ù‚ØµØªÙƒ</div>
                <div class="reply-text-body">${linkify(escapeHtml(msg.text))}</div>
            </div>
        </div>
    `;
}

    else if (msg.type === 'text') { content = linkify(escapeHtml(msg.text)); }
    else if(msg.type === 'image') { content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`; } 
    else if(msg.type === 'video') { content = `<div class="media-container" onclick="toggleVideo(this)"><video src="${msg.text}" class="msg-video" playsinline loop></video><div class="video-play-overlay"><div class="play-circle"><i class="fa-solid fa-play"></i></div></div></div>`; } 
    else if(msg.type === 'audio') { content = generateAudioPlayer(msg.text, doc.id); }
    else if(msg.type === 'file') { content = `<div class="file-card" onclick="window.open('${msg.text}', '_blank')"><div class="file-icon"><i class="fa-solid fa-file-lines"></i></div><div class="file-info"><span class="file-name">Ù…Ù„Ù Ù…Ø±ÙÙ‚</span><span class="file-size">ØªØ­Ù…ÙŠÙ„</span></div></div>`; }
    else if (msg.type === 'call_log') { content = `<div class="call-card-inner">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø©</div>`; }

    // 4. Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
    let bombIndicator = "";
    if (msg.selfDestruct && msg.type !== 'deleted') {
        bombIndicator = `
        <div class="bomb-info" style="margin-top: 6px; padding-top:4px; border-top:1px solid rgba(255,255,255,0.1); color: #ff3b30; font-size: 10px; display: flex; align-items: center; gap: 5px; font-weight:bold;">
            <i class="fa-solid fa-bomb fa-beat-fade"></i> 
            <span id="timer_${doc.id}">ØªØ¯Ù…ÙŠØ± Ø®Ù„Ø§Ù„: ${Math.ceil(msg.selfDestruct)}Ø«</span>
        </div>`;
    }

    // ================= 5. (Ø§Ù„Ø¬Ø¯ÙŠØ¯) Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹ÙŠÙ† =================
    let eyeHtml = '';
    if (isMe && msg.type !== 'deleted') {
        
        // 1. Ø­Ø³Ø§Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ø¯Ø«
        let isUserOnline = false;
        // Ù†Ø³ØªØ®Ø¯Ù… u.lastSeen Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Ø¯Ø§Ù„Ø© updateHeader
        if (u && u.lastSeen) {
            const now = new Date();
            const lastSeenDate = u.lastSeen.toDate ? u.lastSeen.toDate() : new Date(u.lastSeen);
            // Ù„Ùˆ ÙØ§ØªØ­ ÙÙŠ Ø¢Ø®Ø± 60 Ø«Ø§Ù†ÙŠØ© ÙŠØ¹ØªØ¨Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
            if ((now - lastSeenDate) / 1000 < 65) {
                isUserOnline = true;
            }
        }

        // 2. ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¹ÙŠÙ†
        if (msg.seen) {
            // ğŸŸ¢ Ø´Ø§ÙÙ‡Ø§
            eyeHtml = '<i class="fa-solid fa-eye eye-green status-eye" title="ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©"></i>';
        } 
        else if (isUserOnline) { 
            // ğŸ”µ Ù‡Ùˆ ÙØ§ØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†) Ø¨Ø³ Ù„Ø³Ù‡ Ù…Ø§ Ø´Ø§ÙØ´ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹
            eyeHtml = '<i class="fa-solid fa-eye eye-blue status-eye" title="ÙˆØµÙ„Øª (Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†)"></i>';
        } 
        else {
            // âš« Ù‚Ø§ÙÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø®Ø§Ù„Øµ
            eyeHtml = '<i class="fa-solid fa-eye eye-dark status-eye" title="ØºÙŠØ± Ù…ØªØµÙ„"></i>';
        }
    }
    // ========================================================

    const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
    const miniAvatar = `<div class="msg-user-avatar" style="background-image: url('${u.profilePic}'); background-color:${u.color};">${u.profilePic?'':u.char}</div>`;
    let isSameSender = (prevMsg && prevMsg.uid === msg.uid && prevMsg.type !== 'deleted' && msg.type !== 'deleted');

    // 6. Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ eyeHtml Ø¨Ø¯Ù„ checkMarkHtml)
    html += `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'} ${isSameSender ? 'same-sender' : ''}" id="msg_${doc.id}">
        ${!isMe ? miniAvatar : ''}
        <div class="${bubbleClass}">
            ${!isMe && !isSameSender ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
            
            <div>${content}</div>
            ${bombIndicator}
            
            ${msg.type !== 'deleted' ? `
                <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                    <span class="msg-time">${timeText}</span>
                    ${eyeHtml} 
                </div>` 
            : ''}
        </div>
    </div>`;

    prevMsg = msg;
});

        container.innerHTML = html;
                 if (isFirstLoad) {
              // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø²ÙˆÙ„
              setTimeout(() => {
                  container.scrollTop = container.scrollHeight;
              }, 300); // 300 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (ÙˆÙ‚Øª ÙƒØ§ÙÙ Ø¬Ø¯Ø§Ù‹)
          }
         
          // === ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØªÙˆØ± Ø§Ù„Ù…Ø¹Ø¯Ù„ (ÙŠØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙØ¬ÙŠØ±) ===
destructQueue.forEach(item => {
    const timerSpan = document.getElementById(`timer_${item.id}`);
    const msgRow = document.getElementById(`msg_${item.id}`);
    let seconds = Math.floor(item.timeLeft / 1000);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙˆØ±Ø§Ù‹
    if(timerSpan) timerSpan.innerText = `ØªØ¯Ù…ÙŠØ± Ø®Ù„Ø§Ù„: ${seconds}Ø«`;

    const interval = setInterval(() => {
        seconds--;
        if(timerSpan) timerSpan.innerText = `ØªØ¯Ù…ÙŠØ± Ø®Ù„Ø§Ù„: ${seconds}Ø«`;
        
        // === Ù„Ø­Ø¸Ø© Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± ===
        if (seconds <= 0) {
            clearInterval(interval);
            
            if(msgRow) {
                // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¹Ø´Ø§Ù† Ù†ØºÙŠØ± Ø´ÙƒÙ„Ù‡Ø§
                const bubble = msgRow.querySelector('.target-bubble');
                
                // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø®Øµ (Ø²ÙŠ Ù…Ø§ Ø·Ù„Ø¨Øª)
                const explodedText = item.isMe ? "ğŸ’¥ Ù„Ù‚Ø¯ ÙØ¬Ø±Øª Ø±Ø³Ø§Ù„Ø©" : "ğŸ’¥ Ù„Ù‚Ø¯ ÙØ¬Ø± Ø±Ø³Ø§Ù„Ø©";

                // 3. ØªØºÙŠÙŠØ± Ø§Ù„Ø³ØªØ§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰
                if(bubble) {
                    // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù‡Ø²Ø© Ø¨Ø³ÙŠØ·Ø©
                    msgRow.style.animation = "shake 0.5s ease-in-out"; 
                    
                    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø´ÙØ§Ù Ø§Ùˆ Ø§Ø­Ù…Ø± Ø®ÙÙŠÙ
                    bubble.style.background = "rgba(255, 59, 48, 0.15)";
                    bubble.style.border = "1px dashed rgba(255, 59, 48, 0.5)";
                    bubble.style.color = "#ff3b30";
                    bubble.style.textAlign = "center";
                    bubble.style.minWidth = "150px";
                    
                    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    bubble.innerHTML = `<span style="font-weight:bold; font-size:13px;">${explodedText}</span>`;
                }
                
                // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ®ØªÙÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨Ø¹Ø¯ Ø¬Ù…Ù„Ø© Ø§Ù„ØªÙØ¬ÙŠØ± Ø¨Ù€ 3 Ø«ÙˆØ§Ù†ÙŠ Ù…Ø«Ù„Ø§Ù‹
                 setTimeout(() => msgRow.remove(), 3000);
            }
        }
    }, 1000);
    
    activeTimers.push(interval);
});

        // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ø²ÙŠØ§Ø¯Ø© Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ (50 Ø¨ÙƒØ³Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 0)
// Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ (ÙÙˆÙ‚ ÙˆØªØ­Øª)
container.onscroll = () => {
    // 1. Ù„Ùˆ Ø¨Ù†Ø·Ù„Ø¹ Ù„ÙÙˆÙ‚ (Ø¹Ø§ÙŠØ²ÙŠÙ† Ù‚Ø¯ÙŠÙ…)
    if (container.scrollTop <= 50 && !isLoadingOld) {
        loadMoreHistory();
    }

    // 2. Ù„Ùˆ Ø¨Ù†Ù†Ø²Ù„ Ù„ØªØ­Øª (Ø¹Ø§ÙŠØ²ÙŠÙ† Ø¬Ø¯ÙŠØ¯) - Ø¯ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§
    if (isArchiveMode) {
        loadMoreNewerMessages();
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„
    const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
    if (distanceFromBottom > 300) {
        document.getElementById("scrollToBottomBtn").style.display = "flex";
    } else {
        document.getElementById("scrollToBottomBtn").style.display = "none";
    }
};

        // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events) Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        container.querySelectorAll('.msg-row').forEach((row) => { 
             const id = row.id.replace('msg_', '');
             const doc = snap.docs.find(d => d.id === id);
             const bubble = row.querySelector('.target-bubble');
             
             if(bubble && doc) { 
                 let mData = doc.data(); 
                 mData.senderName = userCache[mData.uid]?.name || 'Ù…Ø³ØªØ®Ø¯Ù…'; 
                 // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
                 attachLongPress(bubble, mData, doc.id); 
                 enableSwipeToReply(row, bubble, mData, doc.id);

             } 
        });

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ£Ù†Ø§ Ù…Ø´ Ø¨Ø§Ø¹ØªÙ‡Ø§
        if(!isFirstLoad) {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const d = change.doc.data();
                    if (d.uid !== currentUserId) alertSound.play().catch(()=>{});
                }
            });
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª (Metadata Duration)
        document.querySelectorAll('audio').forEach(audio => { 
            audio.onloadedmetadata = function() { 
                const id = this.id.split('_')[1]; 
                const dur = document.getElementById(`dur_${id}`); 
                if(dur) dur.innerText = formatTimeSec(this.duration); 
            }; 
        });
        // Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ (Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± Ù„Ø£Ù†Ù†Ø§ Ù„ØºÙŠÙ†Ø§ Ø§Ù„Ù€ smooth)
if (isFirstLoad) {
    container.scrollTop = container.scrollHeight;
    
    // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙÙŠ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØ± Ø¨ØªØ­Ù…Ù„
    requestAnimationFrame(() => {
        container.scrollTop = container.scrollHeight;
    });
}

        isFirstLoad = false;
    });
}

async function loadMoreHistory() {
    if (!oldestDoc || isLoadingOld) return;
    isLoadingOld = true;

    const container = document.getElementById("chatContainer");
    
    // Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const oldHeight = container.scrollHeight; 
    const oldScrollTop = container.scrollTop; // Ø¹Ø§Ø¯Ø©Ù‹ Ø³ÙŠÙƒÙˆÙ† 0

    try {
        const snap = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "asc")
            .endBefore(oldestDoc)
            .limitToLast(20)
            .get();

        if (!snap.empty) {
    oldestDoc = snap.docs[0];
            
            let newHtml = "";
            let prevMsg = null;
            let lastDate = null;

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const uids = new Set();
            snap.docs.forEach(d => uids.add(d.data().uid));
            await Promise.all(Array.from(uids).map(uid => getUser(uid)));

            // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            snap.forEach(doc => {
                const msg = doc.data();
                const isMe = msg.uid === currentUserId;
                const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };

                // ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
                const msgDate = msg.createdAt ? msg.createdAt.toDate() : new Date();
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ù†Ø·Ù‚ ÙÙˆØ§ØµÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù„Ø¶Ø¨Ø· Ø¯Ù‚ÙŠÙ‚ØŒ Ù„ÙƒÙ† Ù‡Ø°Ø§ Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ
                if (!lastDate || !isSameDay(msgDate, lastDate)) {
                    newHtml += `<div class="date-divider"><span>${formatDateSticky(msgDate)}</span></div>`;
                    lastDate = msgDate;
                    prevMsg = null;
                }

                // === Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† Ù†Ø§Ù‚ØµØ§Ù‹ Ù„Ø¯ÙŠÙƒ) ===
                let content = "";
                let bubbleClass = "msg-bubble target-bubble"; 

                if (msg.type === 'deleted') {
                    content = `<span style="font-style: italic; color: #94a3b8; font-size: 13px;">${isMe ? "ğŸš« Ø£Ù†Øª Ø­Ø°ÙØª Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" : "ğŸš« ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"}</span>`;
                    bubbleClass += " deleted"; 
                }
                else if (msg.type === 'text') { content = linkify(escapeHtml(msg.text)); }
                else if(msg.type === 'image') { content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`; } 
                else if(msg.type === 'video') { content = `<div class="media-container" onclick="toggleVideo(this)"><video src="${msg.text}" class="msg-video" playsinline loop></video><div class="video-play-overlay"><div class="play-circle"><i class="fa-solid fa-play"></i></div></div></div>`; } 
                else if(msg.type === 'audio') { content = generateAudioPlayer(msg.text, doc.id); }
                else if(msg.type === 'file') { content = `<div class="file-card" onclick="window.open('${msg.text}', '_blank')"><div class="file-icon"><i class="fa-solid fa-file-lines"></i></div><div class="file-info"><span class="file-name">Ù…Ù„Ù Ù…Ø±ÙÙ‚</span><span class="file-size">ØªØ­Ù…ÙŠÙ„</span></div></div>`; }
                else if (msg.type === 'call_log') { content = `<div class="call-card-inner">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø©</div>`; }
                else if (msg.type === 'system') {
                    const actionText = msg.text === 'ghost_on' ? 'Ù‚Ø§Ù… Ø¨ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»' : 'Ù‚Ø§Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸš«';
                    newHtml += `<div class="system-msg-row" id="msg_${doc.id}"><span class="system-msg-text">${actionText} Ø¨ÙˆØ§Ø³Ø·Ø© <span class="system-user-name">${u.name}</span></span></div>`;
                    return; // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                }

                const eyeHtml = getEyeStatusHTML(msg, isMe);
                const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
                const miniAvatar = `<div class="msg-user-avatar" style="background-image: url('${u.profilePic}'); background-color:${u.color};">${u.profilePic?'':u.char}</div>`;
                
                let isSameSender = (prevMsg && prevMsg.uid === msg.uid && prevMsg.type !== 'deleted' && msg.type !== 'deleted');

                newHtml += `
                <div class="msg-row ${isMe ? 'sender' : 'receiver'} ${isSameSender ? 'same-sender' : ''}" id="msg_${doc.id}">
                    ${!isMe ? miniAvatar : ''}
                    <div class="${bubbleClass}">
                        ${!isMe && !isSameSender ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
                        <div>${content}</div>
                        ${msg.type !== 'deleted' ? `
                            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                                <span class="msg-time">${timeText}</span>
                                ${eyeHtml} 
                            </div>` 
                        : ''}
                    </div>
                </div>`;
                
                prevMsg = msg;
            });

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            container.insertAdjacentHTML('afterbegin', newHtml);

            // === Ø§Ù„Ø³Ø­Ø±: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ===
            // Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø·ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‡Ùˆ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ù‚Ù Ø¹Ù†Ø¯Ù‡
            container.scrollTop = container.scrollHeight - oldHeight;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Long Press & Swipe)
            container.querySelectorAll('.msg-row').forEach((row) => {
                 const id = row.id.replace('msg_', '');
                 // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù€ snap Ù‡Ù†Ø§ Ù„Ø£Ù†Ù†Ø§ Ù†Ø±ÙŠØ¯ ÙÙ‚Ø· Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                 // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø£Ùˆ ØªØ­Ø³ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ø§Ø­Ù‚Ø§Ù‹
                 const bubble = row.querySelector('.target-bubble');
                 if(bubble) {
                     // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù‚Ø© Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ù„ØªØ®Ø²ÙŠÙ†Ù‡Ø§ØŒ Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ·:
                     // Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø³ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                 }
            });
        }
    } catch (e) {
        console.log("No more history or error", e);
    }

    isLoadingOld = false;
}

// Ø¶ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù€ Scrip
        // ================= Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª =================
        function toggleAudio(id, event) {
            if (event) event.stopPropagation();
            const audio = document.getElementById(`audio_${id}`);
            const btnIcon = document.querySelector(`#btn_${id} i`);

            if (audio.paused) {
                document.querySelectorAll('audio').forEach(a => { if (a !== audio) { a.pause(); } });
                audio.play();
                btnIcon.className = "fa-solid fa-pause";
            } else {
                audio.pause();
                btnIcon.className = "fa-solid fa-play";
            }
        }

        function generateAudioPlayer(url, id) {
            return `
            <div class="custom-audio-player" onclick="event.stopPropagation()">
                <button class="play-btn" id="btn_${id}" onclick="toggleAudio('${id}', event)">
                    <i class="fa-solid fa-play"></i>
                </button>
                <input type="range" class="audio-slider" id="range_${id}" value="0" oninput="seekAudio('${id}'); event.stopPropagation();">
                <span id="dur_${id}" style="font-size:10px; color:#ccc;">00:00</span>
                <audio id="audio_${id}" src="${url}" ontimeupdate="updateAudioProgress('${id}')" onended="resetAudio('${id}')"></audio>
            </div>`;
        }

        function updateAudioProgress(id) { const a=document.getElementById(`audio_${id}`); document.getElementById(`range_${id}`).value=(a.currentTime/a.duration)*100; }
        function seekAudio(id) { const a=document.getElementById(`audio_${id}`); a.currentTime=(document.getElementById(`range_${id}`).value/100)*a.duration; }
        function resetAudio(id) { document.querySelector(`#btn_${id} i`).className="fa-solid fa-play"; document.getElementById(`range_${id}`).value=0; }

        function attachLongPress(element, msgData, msgId) { let timer; const start = () => { timer = setTimeout(() => openContextMenu(msgData, msgId), 600); }; const end = () => clearTimeout(timer); element.addEventListener('touchstart', start); element.addEventListener('touchend', end); element.addEventListener('mousedown', start); element.addEventListener('mouseup', end); }
        
        function openContextMenu(data, id) { 
            if(navigator.vibrate) navigator.vibrate(50); 
            selectedMsgId = id; selectedMsgData = data; 
            const isMyMsg = data.uid === currentUserId; 
            document.getElementById('menuDeleteAllBtn').style.display = isMyMsg ? 'flex' : 'none'; 
            document.getElementById('menuSaveBtn').style.display = (data.type==='image'||data.type==='video')?'flex':'none'; 
            document.getElementById('menuCopyBtn').style.display = (data.type==='text')?'flex':'none'; 
            document.getElementById('menuListenBtn').style.display = (data.type === 'audio') ? 'flex' : 'none';
            document.getElementById('contextMenuOverlay').style.display='flex'; 
            setTimeout(()=>document.getElementById('contextMenu').classList.add('active'),10); 
        }

        function closeContextMenu() { document.getElementById('contextMenu').classList.remove('active'); setTimeout(()=>document.getElementById('contextMenuOverlay').style.display='none',300); }
        
        function playMessageAudio() { if (!selectedMsgData || selectedMsgData.type !== 'audio') return; document.querySelectorAll('audio').forEach(a => { a.pause(); }); const audio = new Audio(selectedMsgData.text); audio.play(); closeContextMenu(); }

        async function toggleReaction(emoji) { 
            if(!selectedMsgId) return; 
            const ref = db.collection("chats").doc(chatId).collection("messages").doc(selectedMsgId); 
            try { const doc = await ref.get(); if(doc.exists) { if(doc.data().reaction === emoji) await ref.update({reaction: firebase.firestore.FieldValue.delete()}); else await ref.update({reaction: emoji}); showToast("ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„"); } } catch(e) {}
            closeContextMenu(); 
        }

        // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¯ÙŠ ÙÙˆØ±Ø§Ù‹
async function sendMessage() { 
    playUiSound('sent');
    const inp = document.getElementById("messageInput"); 
    const val = inp.value.trim(); 
    
    if(!val) return; 

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let msgPayload = { 
        text: val, 
        uid: currentUserId, 
        type: 'text',
        seen: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        
        // ğŸ”¥ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø­Ø±ÙŠØ©: Ø®ØªÙ… Ø§Ù„Ø´Ø¨Ø­
        isGhost: isGhostMode // Ù„Ùˆ Ø§Ù„ÙˆØ¶Ø¹ Ø´ØºØ§Ù„ØŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ Ù‡ØªØ¨Ù‚Ù‰ Ù…Ù…ÙŠØ²Ø©
    }; 

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ (Ù„Ùˆ Ù…ÙØ¹Ù„)
    if (destructTime > 0) { 
        msgPayload.selfDestruct = destructTime; 
        msgPayload.expireAt = firebase.firestore.Timestamp.fromMillis(Date.now() + (destructTime * 1000)); 
    }
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø¯
    if(currentReply) {
        msgPayload.replyTo = { 
            id: currentReply.id, 
            text: currentReply.text, 
            sender: currentReply.sender 
        }; 
    }
    
    // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙƒÙˆÙ„ÙƒØ´Ù†)
    await db.collection("chats").doc(chatId).collection("messages").add(msgPayload); 
    
    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // (Ù‡Ù†Ø§ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØ±Ø¬Ø¹ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¸Ù‡ÙˆØ±)
    if (cachedOtherUserId && !isGhostMode) { 
        await db.collection("chats").doc(chatId).set({ 
            lastMessage: val, 
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
            sentTo: cachedOtherUserId, 
            senderId: currentUserId, 
            seen: false, 
            unreadCount: firebase.firestore.FieldValue.increment(1),
            
            // ====================================================
            // ğŸ‘‡ğŸ‘‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ğŸ‘‡ğŸ‘‡
            // ====================================================
            deletedBy: [],   // Ø¨ÙŠÙØ¶ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† ÙØ§Ù„Ø´Ø§Øª ÙŠØ¸Ù‡Ø± ØªØ§Ù†ÙŠ
            archivedBy: []   // Ø¨ÙŠÙØ¶ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ù„Ø´Ø§Øª ÙŠØ±Ø¬Ø¹ Ù„Ù„Ø¥Ù†Ø¨ÙˆÙƒØ³
            // ====================================================

        }, { merge: true }); 
    } 
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚Ù„ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
    inp.value = ""; 
    inp.style.height = 'auto'; 
    toggleSendButton(); 
    cancelReply(); 
    setTimeout(scrollToBottom, 100); 
}

async function purgeGhostMessages() {
    if (!chatId || !currentUserId) return;

    try {
        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø¨Ø­ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø§Øª
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .where("uid", "==", currentUserId)
            .where("isGhost", "==", true) // Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø³Ø­Ø±ÙŠ
            .get();

        if (snapshot.empty) return; // Ù…ÙÙŠØ´ Ø±Ø³Ø§ÙŠÙ„ØŒ Ø§Ø·Ù„Ø¹

        // 2. Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Batch Delete)
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref); // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Delete) Ù…Ø´ ØªØ­Ø¯ÙŠØ« (Update)
        });

        await batch.commit();
        showToast("ğŸ’¨ Ø§Ø®ØªÙØª Ø¢Ø«Ø§Ø± Ø§Ù„Ø´Ø¨Ø­");

    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø¨Ø­:", e);
    }
}

        
        function openLb(src) { document.getElementById('lb-img').src=src; document.getElementById('lightbox').style.display='flex'; }
        function closeLightbox() { document.getElementById('lightbox').style.display='none'; }
        
        function escapeHtml(t) { return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function formatTime(t) { return t.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }); }
        function formatTimeSec(s) { if(isNaN(s)) return "00:00"; const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc.toString().padStart(2,'0')}`; }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.style.opacity='1'; t.style.bottom='90px'; setTimeout(()=>{t.style.opacity='0'; t.style.bottom='80px';},2000); }
        function copyText() { if(selectedMsgData?.type==='text') { navigator.clipboard.writeText(selectedMsgData.text); showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); } closeContextMenu(); }
        function saveMedia() { if(selectedMsgData?.text) { const a = document.createElement('a'); a.href = selectedMsgData.text; a.download = 'Media'; a.target='_blank'; a.click(); } closeContextMenu(); }
        function deleteMessageLocal() { if(selectedMsgId) document.getElementById(`msg_${selectedMsgId}`).style.display='none'; closeContextMenu(); }

        // ================= Ø§Ù„ØªØ³Ø¬ÙŠÙ„ =================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (ØµÙˆØª + Ø¶ÙˆØ¡ Ø£Ø­Ù…Ø±)

async function startRecording() { 
    try { 
        // 1. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¨Ø¯Ø¡ ÙÙˆØ±Ø§Ù‹
        playUiSound('record'); 

        // 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ù†Ø¨Ø¶
        const btn = document.getElementById('micBtn');
        btn.classList.add('recording-active'); // ğŸ‘ˆ Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ®Ù„ÙŠÙ‡Ø§ ØªÙ†ÙˆØ± Ø£Ø­Ù…Ø±
        btn.innerHTML = '<i class="fa-solid fa-stop"></i>'; // ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù…Ø±Ø¨Ø¹

        const s = await navigator.mediaDevices.getUserMedia({audio:true}); 
        mediaRecorder = new MediaRecorder(s); 
        audioChunks = []; 
        
        document.getElementById("recordingUI").style.display = "flex"; 
        
        seconds = 0; 
        document.getElementById("recordTimer").innerText = "00:00";
        clearInterval(recordInterval);
        
        recordInterval = setInterval(() => { 
            seconds++; 
            document.getElementById("recordTimer").innerText = `00:${seconds.toString().padStart(2,'0')}`; 
        }, 1000); 
        
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.start(); 

    } catch(e){ 
        alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†"); 
        // Ù„Ùˆ ÙØ´Ù„ØŒ Ù†Ù„ØºÙŠ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
        document.getElementById('micBtn').classList.remove('recording-active');
    } 
}

function stopAndSendRecording() { 
    // 1. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù†ÙØ³ ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
    playUiSound('sent');

    // 2. Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
    const btn = document.getElementById('micBtn');
    btn.classList.remove('recording-active');
    btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; // Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø§ÙŠÙƒ

    if(!mediaRecorder || mediaRecorder.state === "inactive") return; 
    mediaRecorder.stop(); 
    
    mediaRecorder.onstop = async () => { 
        clearInterval(recordInterval); 
        document.getElementById("recordingUI").style.display = "none"; 
        const b = new Blob(audioChunks, { type:'audio/mp4' }); 
        
        // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø±ÙØ¹ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
        const ref = storage.ref(`voice_notes/${Date.now()}.m4a`); 
        try { 
            showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...");
            await ref.put(b); const u = await ref.getDownloadURL(); 
            let msgPayload = {
    text: u, 
    uid: currentUserId, 
    type: 'audio', 
    seen: false, // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‡Ù†Ø§
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
}; 
if (destructTime > 0) { 
                msgPayload.selfDestruct = destructTime; 
                msgPayload.expireAt = firebase.firestore.Timestamp.fromMillis(Date.now() + (destructTime * 1000)); 
            }
            await db.collection("chats").doc(chatId).collection("messages").add(msgPayload); 
            cancelReply(); 
        } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); } 
    } 
}

function cancelRecording() { 
    // ØµÙˆØª Ø¥Ù„ØºØ§Ø¡ (ØªÙƒØ©)
    playUiSound('destruct'); 

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
    const btn = document.getElementById('micBtn');
    btn.classList.remove('recording-active');
    btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';

    clearInterval(recordInterval); 
    if(mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.onstop = null; // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        mediaRecorder.stop(); 
    }
    document.getElementById("recordingUI").style.display = "none"; 
}

        // ================= Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª =================
        let localStream = null, peerConnection = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£ØµÙˆØ§Øª
const ringOut = document.getElementById('ringtoneOut');
const ringIn = document.getElementById('ringtoneIn');
const endSound = document.getElementById('callEndSound');
let callTimerInterval = null;
let incomingOffer = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù„Ø­Ø¯ Ù…Ø§ ØªØ±Ø¯

// 1. Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (Sender)
async function initiateCall() {
    // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (ØªÙˆØª.. ØªÙˆØª..)
var ringOut = document.getElementById('ringtoneOut');
if (ringOut) {
    ringOut.currentTime = 0;
    ringOut.play().catch(e => console.log("Audio play blocked"));
}
playSmartRingtone('outgoing');
    monitorRemoteState();
    await clearCandidates();
    
    // 1. ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ø´ØºÙˆÙ„ØŸ
    try {
        const callDoc = await db.collection('chats').doc(chatId).collection('calls').doc('active_call').get();
        
        if (callDoc.exists) {
            alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ØºÙˆÙ„ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© Ø£Ø®Ø±Ù‰ Ø­Ø§Ù„ÙŠØ§Ù‹");
            return; 
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:", error);
    }

    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setupCallUI('outgoing');
    document.getElementById('callAvatar').classList.add('calling-pulse');

    // ØªØ£Ù…ÙŠÙ†: Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø£Ù†Ù†Ø§ Ø¨Ù†Ø¨Ø¯Ø£ Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©
    const switchBtn = document.getElementById('switchCamBtn');
    if(switchBtn) switchBtn.style.display = 'none';
    
    try {
        // ================= Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Pro Audio Setup) =================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© ÙˆØ¹Ø²Ù„ Ø¶ÙˆØ¶Ø§Ø¡ (Ø²ÙŠ Ù…Ø§Ø³Ù†Ø¬Ø±)
        const audioConstraints = {
            echoCancellation: true,       // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµØ¯Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            noiseSuppression: true,       // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
            autoGainControl: true,        // Ø¶Ø¨Ø· Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ù…ØªØµÙØ­Ø§Øª ÙƒØ±ÙˆÙ… (Google WebRTC) Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø¡
            googEchoCancellation: true,
            googAutoGainControl: true,
            googNoiseSuppression: true,
            googHighpassFilter: true      // ÙÙ„ØªØ± Ù„ØªÙ†Ù‚ÙŠØ© Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„ØªØ±Ø¯Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
        };

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        localStream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });
        // =======================================================================
        
        // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        const ringOut = document.getElementById('ringtoneOut');
        if (ringOut) {
            ringOut.currentTime = 0; 
            ringOut.play().catch(e => console.log("Audio play blocked"));
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ØªØµØ§Ù„ WebRTC
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // ================= Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ù…Ø©: ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø¨ÙƒØ© =================
        // Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØ®Ù„ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙƒØªØ¨ "Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„" Ù„Ùˆ Ø§Ù„Ù†Øª ÙØµÙ„
        monitorConnectionState(); 
        // =================================================================
        
        listenForRemoteCandidates();

        // Ø¥Ø¶Ø§ÙØ© ØµÙˆØªÙŠ Ù„Ù„Ø§ØªØµØ§Ù„
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
        peerConnection.ontrack = (event) => {
    const stream = event.streams[0];
    
    // Ù„Ùˆ ØµÙˆØª
    if (event.track.kind === 'audio') {
        document.getElementById('remoteAudio').srcObject = stream;
        handleCallConnected(event);
    }

    // Ù„Ùˆ ÙÙŠØ¯ÙŠÙˆ (Ù‡Ù†Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡)
    if (event.track.kind === 'video') {
        // Ø¨Ù†ÙØ­Øµ Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        // Ù„Ùˆ Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯Ù‡ Ø£ÙƒÙŠØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
        const videoTracks = stream.getVideoTracks();
        
        /* Ù…Ù„Ø§Ø­Ø¸Ø©: WebRTC Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø¨ÙŠØ¨Ø¹Øª Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Stream Ù…Ù†ÙØµÙ„ Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù€ Stream.
           Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¶Ù…Ù†: Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ remoteVideoØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¯Ù‡ Ù‡Ùˆ Ø§Ù„Ø´Ø§Ø´Ø©.
        */
        const remoteVideo = document.getElementById('remoteVideo');
        const remoteScreen = document.getElementById('remoteScreenVideo');
        const container = document.getElementById('videoContainer');
        const bg = document.getElementById('callBg');

        // Ù†Ø¸Ù‡Ø± Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙˆÙ†Ø®ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        container.style.display = 'block';
        bg.style.display = 'none';

        if (!remoteVideo.srcObject) {
            // Ø¯Ù‡ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
            remoteVideo.srcObject = stream;
        } else {
            // Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„Ø´Ø§Ø´Ø©!)
            // Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ø´ Ù†ÙØ³ Ø§Ù„ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (remoteVideo.srcObject.id !== stream.id) {
                remoteScreen.srcObject = stream;
                remoteScreen.style.display = 'block';
                
                // Ù†ÙØ¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù€ Presentation (Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØµØºØ± ÙˆØ§Ù„Ø´Ø§Ø´Ø© ØªÙƒØ¨Ø±)
                container.classList.add('presentation-mode');

                // Ù„Ù…Ø§ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚ÙÙ„ (Track Ended)ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                event.track.onended = () => {
                    remoteScreen.style.display = 'none';
                    remoteScreen.srcObject = null;
                    container.classList.remove('presentation-mode');
                };
            }
        }
    }
};


        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª (Candidates)
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.collection('chats').doc(chatId).collection('callCandidates').add(event.candidate.toJSON());
            }
        };

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ (Offer)
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').set({
            offer: { type: offer.type, sdp: offer.sdp },
            callerId: currentUserId,
            status: 'ringing',
            startTime: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        if (noAnswerTimeout) clearTimeout(noAnswerTimeout); // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ù‚Ø¯ÙŠÙ…
noAnswerTimeout = setTimeout(() => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø³Ù‡ "Ø¨ØªØªØµÙ„"
    db.collection('chats').doc(chatId).collection('calls').doc('active_call').get().then(doc => {
        if(doc.exists && doc.data().status === 'ringing') {
            // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯"
            endCall(); 
            showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ğŸ“µ");
        }
    });
}, 30000); // 30000 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = 30 Ø«Ø§Ù†ÙŠØ©
listenForCallUpdates(); // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
makeVideoDraggable(); 
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯
        listenForAnswer();

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
        closeCallUI();
    }
}

// 2. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Receiver Listener)
function listenForIncomingCalls() {
    
    // ØªØ´ØºÙŠÙ„ Ø±Ù†Ø© Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† (ØªØ±Ø±Ø±Ù†.. ØªØ±Ø±Ø±Ù†..)
var ringIn = document.getElementById('ringtoneIn');
if (ringIn) {
    ringIn.currentTime = 0;
    ringIn.play().catch(e => {
        // Ù„Ùˆ Ø§Ù„ØµÙˆØª Ø§ØªÙ…Ù†Ø¹ØŒ Ù†Ø´ØºÙ„ Ø§Ù„Ù‡Ø²Ø§Ø²
        if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
    });
}
playSmartRingtone('incoming');
    if (!chatId) return;

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
      .onSnapshot(async s => {
        const d = s.data();
        
        // --- Ø­Ø§Ù„Ø© 1: Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª Ø£Ùˆ Ø§ØªÙ„ØºØª (Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª) ---
        if (!d || !d.offer) {
            // Ù„Ùˆ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§
            if(document.getElementById('callOverlay').style.display === 'flex') {
                endCall(false); // false Ø¹Ø´Ø§Ù† Ù…Ù†Ø­Ø°ÙØ´ Ø§Ù„Ø¯ÙˆÙƒ ØªØ§Ù†ÙŠ Ù„Ø£Ù†Ù‡ Ø§ØªØ­Ø°Ù Ø£ØµÙ„Ø§Ù‹
            }
            
            // ÙˆÙ‚Ù Ø§Ù„Ø±Ù†Ø© ÙÙˆØ±Ø§Ù‹
            if(ringIn) { 
                ringIn.pause(); 
                ringIn.currentTime = 0; 
            }

            // ÙˆÙ‚Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙˆØ±Ø§Ù‹
            if (vibrationInterval) {
                clearInterval(vibrationInterval);
                navigator.vibrate(0);
                vibrationInterval = null;
            }
            return;
        }

        // --- Ø­Ø§Ù„Ø© 2: ÙÙŠÙ‡ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø© (Ø¹Ø±Ø¶ Ù…ÙˆØ¬ÙˆØ¯ + Ù…Ø´ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…ØªØµÙ„ + Ù…ÙÙŠØ´ Ø§ØªØµØ§Ù„ Ø­Ø§Ù„ÙŠ) ---
        if (d.offer && d.callerId !== currentUserId && !peerConnection) {
            console.log("Incoming Call Detected...");
            
            incomingOffer = d.offer; // Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡
            setupCallUI('incoming', d.callerId); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©
            
            // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
            const playPromise = ringIn.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.warn("Audio autoplay blocked by browser:", error);
                    // Ù‡Ù†Ø§ Ø§Ù„ØµÙˆØª Ù…Ø´ Ù‡ÙŠØ´ØªØºÙ„ ØºÙŠØ± Ù„Ù…Ø§ Ø§Ù„ÙŠÙˆØ²Ø± ÙŠØªÙØ§Ø¹Ù„ØŒ 
                    // Ù„ÙƒÙ† Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙˆØ§Ù„Ø´Ø§Ø´Ø© Ù‡ÙŠØ®Ù„ÙˆÙ‡ ÙŠÙ†ØªØ¨Ù‡
                });
            }

            // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² (Loop)
            if ("vibrate" in navigator) {
                // Ù‡Ø² Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙˆØ±Ø§Ù‹
                navigator.vibrate([1000, 1000]); // Ø§Ù‡ØªØ²Ø§Ø² 1 Ø«Ø§Ù†ÙŠØ©ØŒ ØªÙˆÙ‚Ù 1 Ø«Ø§Ù†ÙŠØ©
                
                // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ ØªÙƒØ±Ø§Ø± Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„
                if(vibrationInterval) clearInterval(vibrationInterval);

                // ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
                vibrationInterval = setInterval(() => {
                    navigator.vibrate([1000, 1000]);
                }, 2000);
            }
        }
    });
}


// 3. Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
async function acceptIncomingCall() {
    // 1. ÙˆÙ‚Ù Ø£ÙŠ Ø¥Ø²Ø¹Ø§Ø¬ (ØµÙˆØª Ø£Ùˆ Ø§Ù‡ØªØ²Ø§Ø²) ÙÙˆØ±Ø§Ù‹
    stopSmartRingtone(); 

if (navigator.vibrate) navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø²

    // Ø¶ÙŠÙ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ù‡ ÙÙŠ Ø£ÙˆÙ„ Ø§Ù„Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¯ÙŠ
if (vibrationInterval) {
    clearInterval(vibrationInterval); // ÙˆÙ‚Ù Ø§Ù„ØªÙƒØ±Ø§Ø±
    navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
    vibrationInterval = null; // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±
}

    // 1. ÙˆÙ‚Ù Ø§Ù„Ø±Ù†ÙŠÙ†
    const ringIn = document.getElementById('ringtoneIn');
    if(ringIn) { ringIn.pause(); ringIn.currentTime = 0; }
    
    // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('incomingCallControls').style.display = 'none';
    document.getElementById('activeCallControls').style.display = 'flex';
    document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„...";

    try {
        // ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
        const callDoc = await db.collection('chats').doc(chatId).collection('calls').doc('active_call').get();
        const isVideoCall = callDoc.exists && callDoc.data().isVideo === true;

        // 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
        const audioConstraints = {
            echoCancellation: true,      
            noiseSuppression: true,      
            autoGainControl: true,
            googEchoCancellation: true,
            googAutoGainControl: true,
            googNoiseSuppression: true,
            googHighpassFilter: true
        };

        const constraints = {
            audio: audioConstraints,
            video: isVideoCall ? true : false
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        if (isVideoCall) {
            const localVidEl = document.getElementById('localVideo');
            const videoContainer = document.getElementById('videoContainer');
            const bg = document.getElementById('callBg');
            
            localVideoTrack = localStream.getVideoTracks()[0];
            localVidEl.srcObject = new MediaStream([localVideoTrack]);
            
            videoContainer.style.display = 'block';
            bg.style.display = 'none';
            
            const videoBtn = document.getElementById('videoBtn');
            if(videoBtn) {
                videoBtn.classList.add('active-state');
                videoBtn.querySelector('i').className = "fa-solid fa-video";
            }
            if(document.getElementById('switchCamBtn')) {
                document.getElementById('switchCamBtn').style.display = 'flex';
            }
        } else {
             if(document.getElementById('switchCamBtn')) {
                document.getElementById('switchCamBtn').style.display = 'none';
            }
        }

        // 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
        monitorConnectionState(); 
        
        // ================= ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§ =================
        // ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† catch Ø¥Ù„Ù‰ Ù‡Ù†Ø§ Ù„ØªØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„
        listenForCallUpdates(); 
        makeVideoDraggable(); 
        // ===================================================

        listenForRemoteCandidates();
        
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        
        peerConnection.ontrack = (event) => {
    const stream = event.streams[0];
    
    // Ù„Ùˆ ØµÙˆØª
    if (event.track.kind === 'audio') {
        document.getElementById('remoteAudio').srcObject = stream;
        handleCallConnected(event);
    }

    // Ù„Ùˆ ÙÙŠØ¯ÙŠÙˆ (Ù‡Ù†Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡)
    if (event.track.kind === 'video') {
        // Ø¨Ù†ÙØ­Øµ Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        // Ù„Ùˆ Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯Ù‡ Ø£ÙƒÙŠØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
        const videoTracks = stream.getVideoTracks();
        
        /* Ù…Ù„Ø§Ø­Ø¸Ø©: WebRTC Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ø¨ÙŠØ¨Ø¹Øª Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Stream Ù…Ù†ÙØµÙ„ Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù€ Stream.
           Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø¶Ù…Ù†: Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ remoteVideoØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¯Ù‡ Ù‡Ùˆ Ø§Ù„Ø´Ø§Ø´Ø©.
        */
        const remoteVideo = document.getElementById('remoteVideo');
        const remoteScreen = document.getElementById('remoteScreenVideo');
        const container = document.getElementById('videoContainer');
        const bg = document.getElementById('callBg');

        // Ù†Ø¸Ù‡Ø± Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙˆÙ†Ø®ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        container.style.display = 'block';
        bg.style.display = 'none';

        if (!remoteVideo.srcObject) {
            // Ø¯Ù‡ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)
            remoteVideo.srcObject = stream;
        } else {
            // Ø¯Ù‡ ØªØ§Ù†ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØµÙ„ (Ø§Ù„Ø´Ø§Ø´Ø©!)
            // Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ø´ Ù†ÙØ³ Ø§Ù„ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (remoteVideo.srcObject.id !== stream.id) {
                remoteScreen.srcObject = stream;
                remoteScreen.style.display = 'block';
                
                // Ù†ÙØ¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ù€ Presentation (Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØµØºØ± ÙˆØ§Ù„Ø´Ø§Ø´Ø© ØªÙƒØ¨Ø±)
                container.classList.add('presentation-mode');

                // Ù„Ù…Ø§ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚ÙÙ„ (Track Ended)ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                event.track.onended = () => {
                    remoteScreen.style.display = 'none';
                    remoteScreen.srcObject = null;
                    container.classList.remove('presentation-mode');
                };
            }
        }
    }
};


        peerConnection.onicecandidate = (e) => {
            if (e.candidate) db.collection('chats').doc(chatId).collection('callCandidates').add(e.candidate.toJSON());
        };

        await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingOffer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
            answer: { type: answer.type, sdp: answer.sdp },
            status: 'connected'
        });

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©: " + err.message);
        endCall();
    }
}





// 4. Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
async function rejectCall() {
    stopSmartRingtone();

    // ÙˆÙ‚Ù Ø£ÙŠ ØµÙˆØª Ø´ØºØ§Ù„
['ringtoneIn', 'ringtoneOut'].forEach(id => { 
    var el = document.getElementById(id); 
    if(el) { el.pause(); el.currentTime = 0; } 
});
if (navigator.vibrate) navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø²

    // Ø¶ÙŠÙ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ù‡ ÙÙŠ Ø£ÙˆÙ„ Ø§Ù„Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¯ÙŠ
if (vibrationInterval) {
    clearInterval(vibrationInterval); // ÙˆÙ‚Ù Ø§Ù„ØªÙƒØ±Ø§Ø±
    navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
    vibrationInterval = null; // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±
}

    ringIn.pause(); ringIn.currentTime = 0;
    await endCall(true); // true ÙŠØ¹Ù†ÙŠ Ø§Ø­Ø°Ù Ø§Ù„Ø¯ÙˆÙƒ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
}

// 5. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ù…Ø´ØªØ±Ùƒ)
async function endCall(isInit = true) {
    // ÙˆÙ‚Ù Ø£ÙŠ ØµÙˆØª Ø´ØºØ§Ù„
['ringtoneIn', 'ringtoneOut'].forEach(id => { 
    var el = document.getElementById(id); 
    if(el) { el.pause(); el.currentTime = 0; } 
});
if (navigator.vibrate) navigator.vibrate(0); // ÙˆÙ‚Ù Ø§Ù„Ù‡Ø²

    if (noAnswerTimeout) clearTimeout(noAnswerTimeout);
    // 1. === Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² ÙÙˆØ±Ø§Ù‹ (Ø£ÙˆÙ„ Ø­Ø§Ø¬Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¥Ø²Ø¹Ø§Ø¬) ===
    if (typeof vibrationInterval !== 'undefined' && vibrationInterval) {
        clearInterval(vibrationInterval);
        if (navigator.vibrate) navigator.vibrate(0);
        vibrationInterval = null;
    }

    // 2. Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„ØªÙ‡Ø§ (Ù‡Ù„ ØªÙ… Ø§Ù„Ø±Ø¯ Ø£Ù… Ù„Ø§ØŸ)
    let durationText = "00:00";
    let isMissed = true;
    
    // Ù„Ùˆ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒØ§Ù† Ø´ØºØ§Ù„ (ÙˆØ§Ø®Ø¯ ÙƒÙ„Ø§Ø³ Ø§Ù„ØªØ§ÙŠÙ…Ø±)ØŒ ÙŠØ¨Ù‚Ù‰ Ø¯ÙŠ Ù…ÙƒØ§Ù„Ù…Ø© ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
    const statusText = document.getElementById('callStatusText');
    if (statusText && statusText.classList.contains('call-status-timer')) {
        durationText = statusText.innerText;
        isMissed = false;
    }

    // 3. Ø¥ÙŠÙ‚Ø§Ù Ù†ØºÙ…Ø§Øª Ø§Ù„Ø±Ù†ÙŠÙ† ÙˆØµÙˆØª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    const ringOut = document.getElementById('ringtoneOut');
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†Ø© ÙÙˆØ±Ø§Ù‹
const ringIn = document.getElementById('ringtoneIn');
if (ringIn) {
    ringIn.pause();
    ringIn.currentTime = 0;
}

    const endSound = document.getElementById('callEndSound');

    if (ringOut) { ringOut.pause(); ringOut.currentTime = 0; }
    if (ringIn) { ringIn.pause(); ringIn.currentTime = 0; }
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª "ØªÙˆØª" Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (endSound) endSound.play().catch(()=>{}); 

    // 4. Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebRTC ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ
    if (peerConnection) { 
        peerConnection.close(); 
        peerConnection = null; 
    }
    
    if (localStream) { 
        localStream.getTracks().forEach(t => t.stop()); 
        localStream = null; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØªØºÙŠØ±
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„ØµÙˆØª
    if (typeof callTimerInterval !== 'undefined' && callTimerInterval) clearInterval(callTimerInterval);
    if (typeof visualizerInterval !== 'undefined' && visualizerInterval) cancelAnimationFrame(visualizerInterval);
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØª (AudioContext) Ù„Ùˆ ÙƒØ§Ù† Ù…ÙØªÙˆØ­
    if (typeof audioContext !== 'undefined' && audioContext) { 
        audioContext.close().catch(()=>{}); 
        audioContext = null; 
    }

    // Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
    closeCallUI();

    // 5. === ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‡Ù…) ===
    // ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° ÙÙ‚Ø· Ù„Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù‚ÙÙ„Øª (isInit=true) Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (isInit) {
        try {
            // Ø£) Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ù…ØªØµÙ„ (callerId)
            const callDocRef = db.collection('chats').doc(chatId).collection('calls').doc('active_call');
            const callDoc = await callDocRef.get();
            
            // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ø§Øª Ù…Ù†Ù‡ Ø§Ù„Ù…ØªØµÙ„ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙŠØ¨Ù‚Ù‰ Ø£Ù†Ø§ (Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
            const realCallerId = callDoc.exists ? callDoc.data().callerId : currentUserId;

            // Ø¨) Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            await callDocRef.delete();
            
            // Ø¬) ØªØ­Ø¯ÙŠØ¯ Ù†Øµ Ø§Ù„ÙƒÙˆØ¯ (Ù‡Ù„ Ù‡ÙŠ ÙØ§Ø¦ØªØ© Ø£Ù… Ø§Ù†ØªÙ‡ØªØŸ)
            let logText = isMissed ? "no_answer" : "call_ended"; 
            
            // Ø¯) Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.collection("chats").doc(chatId).collection("messages").add({
                text: logText,          // ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
                uid: currentUserId,     // Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ù‚ÙÙ„
                type: 'call_log',       // Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                isMissed: isMissed,     // Ù‡Ù„ ØªÙ… Ø§Ù„Ø±Ø¯ØŸ
                callerId: realCallerId, // Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
                duration: durationText, // Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

        } catch (e) { 
            console.log("Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£", e); 
        }
    }
}


// --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ---

function setupCallUI(type, otherUserId = null) {
    const overlay = document.getElementById('callOverlay');
    const nameEl = document.getElementById('callName');
    // const bgEl = document.getElementById('callBg'); // ğŸ‘ˆ (1) Ù„Ù… Ù†Ø¹Ø¯ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŒ ØªØ¬Ø§Ù‡Ù„Ù‡
    const avatarEl = document.getElementById('callAvatar');

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let uData = otherUserId ? (userCache[otherUserId] || {name: 'Ù…Ø¬Ù‡ÙˆÙ„'}) : (userCache[cachedOtherUserId] || {name: 'Ù…Ø³ØªØ®Ø¯Ù…'});
    
    nameEl.innerText = uData.name;
    
    if(uData.profilePic) {
        // bgEl.style.backgroundImage = `url('${uData.profilePic}')`; // ğŸ‘ˆ (2) Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø£Ùˆ Ø§Ø¬Ø¹Ù„Ù‡ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ ÙƒÙ…Ø§ ÙØ¹Ù„Øª Ù‡Ù†Ø§
        // Ø§Ù„Ø³Ø¨Ø¨: Ø¹Ø´Ø§Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© (Aurora) Ù‡ÙŠ Ø§Ù„Ù„ÙŠ ØªØ¸Ù‡Ø± Ù…Ø´ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ
        
        avatarEl.style.backgroundImage = `url('${uData.profilePic}')`; // âœ… (3) Ø³ÙŠØ¨ Ø¯Ù‡ Ø´ØºØ§Ù„ (Ø¯Ù‡ Ø¨ÙŠØ­Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ÙŠØ±Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¨Ø³)
    }

    overlay.style.display = 'flex';

    if (type === 'outgoing') {
        document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
        document.getElementById('incomingCallControls').style.display = 'none';
        document.getElementById('activeCallControls').style.display = 'flex'; 
        document.querySelector('.call-btn.mute').style.display = 'none'; 
    } else {
        document.getElementById('callStatusText').innerText = "Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©...";
        document.getElementById('callStatusText').style.color = "#10b981";
        document.getElementById('incomingCallControls').style.display = 'flex';
        document.getElementById('activeCallControls').style.display = 'none';
    }
}


function handleCallConnected(event) {
    if (noAnswerTimeout) clearTimeout(noAnswerTimeout);
    document.getElementById('callAvatar').classList.remove('calling-pulse'); 
    

    const remoteAudio = document.getElementById('remoteAudio');
    
    // 1. Ø±Ø¨Ø· Ø§Ù„ØµÙˆØª ÙˆØªØ´ØºÙŠÙ„Ù‡
    remoteAudio.srcObject = event.streams[0];
    
    // === Ø¶Ø¨Ø· Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø³Ù…Ø§Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©) ===
    remoteAudio.volume = 1.0; // Ù†Ø¨Ø¯Ø£ Ø¨ØµÙˆØª ÙˆØ§Ø·ÙŠ
    
    // Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø¨ÙŠÙƒØ± Ù…Ø·ÙÙŠ (Ù„ÙˆÙ†Ù‡ Ø´ÙØ§Ù)
    const speakerBtn = document.getElementById('speakerBtn');
    if (speakerBtn) speakerBtn.classList.remove('active-state');

    // 2. Ø¶Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
    const statusText = document.getElementById('callStatusText');
    statusText.innerText = "00:00";
    statusText.style.color = "#fff";
    statusText.classList.add('call-status-timer');
    
    // 3. ÙˆÙ‚Ù Ù†ØºÙ…Ø© Ø§Ù„Ø±Ù†ÙŠÙ† (Ù„Ø£Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ Ø±Ø¯ Ø®Ù„Ø§Øµ)
    const ringOut = document.getElementById('ringtoneOut');
    if(ringOut) { 
        ringOut.pause(); 
        ringOut.currentTime = 0; 
    }
    
    // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®ÙÙŠØ© (Ø²ÙŠ Ø§Ù„Ù…ÙŠÙˆØª)
    const muteBtn = document.querySelector('.call-btn.mute');
    if (muteBtn) muteBtn.style.display = 'flex';

    // 5. === Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Smart Timer) ===
    let seconds = 0;
    
    // Ù„Ùˆ ÙÙŠÙ‡ Ø¹Ø¯Ø§Ø¯ Ù‚Ø¯ÙŠÙ… Ø´ØºØ§Ù„ Ù†ÙˆÙ‚ÙÙ‡ Ø§Ù„Ø£ÙˆÙ„
    if (typeof callTimerInterval !== 'undefined' && callTimerInterval) {
        clearInterval(callTimerInterval);
    }
    
    callTimerInterval = setInterval(() => {
        // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        // Ù„Ùˆ Ø§Ù„Ù†Øª ÙØ§ØµÙ„ Ø£Ùˆ Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠØ±Ø¬Ø¹ØŒ Ù…Ù†Ø²ÙˆØ¯Ø´ Ø§Ù„ÙˆÙ‚Øª (Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠÙ‚Ù Ù…ÙƒØ§Ù†Ù‡)
        if (peerConnection) {
            const state = peerConnection.iceConnectionState;
            if (state === 'disconnected' || state === 'failed' || state === 'checking') {
                return; // ÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹
            }
        }

        // Ù„Ùˆ Ø§Ù„Ù†Øª ØªÙ…Ø§Ù…ØŒ ÙƒÙ…Ù„ Ø¹Ø¯
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ù„ÙˆÙ† (Ù†Ø±Ø¬Ø¹Ù‡ Ø£Ø¨ÙŠØ¶ Ù„Ùˆ ÙƒØ§Ù† Ø£ØµÙØ± Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹)
        statusText.innerText = `${m}:${s}`;
        statusText.style.color = "#fff"; 
        
    }, 1000);

    // 6. === ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ===
    
    // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø´Ø¨ÙƒØ© (Ø¹Ø´Ø§Ù† ÙŠÙƒØªØ¨ "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„" Ù„Ùˆ Ø§Ù„Ù†Øª Ù‚Ø·Ø¹)
    monitorConnectionState();

    // ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„Ù„ Ø§Ù„ØµÙˆØª (Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© ØªÙ†Ø¨Ø¶ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ù…)
    startAudioVisualizer(event.streams[0]);
}



function closeCallUI() {
    const overlay = document.getElementById('callOverlay');
    document.getElementById('callAvatar').classList.remove('calling-pulse');


    const statusText = document.getElementById('callStatusText');
    const controls = document.getElementById('activeCallControls');
    
    // 1. ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ "Ø§Ù†ØªÙ‡Øª"
    statusText.innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©";
    statusText.style.color = "#ff3b30"; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø±
    
    // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹
    if(controls) controls.style.display = 'none';
    document.getElementById('incomingCallControls').style.display = 'none';

    // 3. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 1.5 Ø«Ø§Ù†ÙŠØ© Ø«Ù… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    setTimeout(() => {
        overlay.style.display = 'none';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©
        statusText.style.color = "#fff";
        statusText.classList.remove('call-status-timer');
        
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠ (Ù„Ùˆ ÙƒÙ†Ø§ Ø­Ø±ÙƒÙ†Ø§Ù‡)
        const localVid = document.getElementById('localVideo');
        localVid.style.top = ""; localVid.style.left = "";
        localVid.style.bottom = "120px"; localVid.style.right = "20px";
        
    }, 1500);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Missing Function)
function listenForAnswer() {
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
      .onSnapshot(snapshot => {
          const data = snapshot.data();
          if (data && data.answer && !peerConnection.currentRemoteDescription) {
              const rtcSessionDescription = new RTCSessionDescription(data.answer);
              peerConnection.setRemoteDescription(rtcSessionDescription);
          }
      });
}
function toggleSpeaker() {
    const remoteAudio = document.getElementById('remoteAudio');
    const speakerBtn = document.getElementById('speakerBtn');

    // Ø¨Ù†ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±Ø§Ø±: Ù‡Ù„ Ù‡Ùˆ Ù…Ù†ÙˆØ± (active-state)ØŸ
    // Ù„Ùˆ Ù…Ù†ÙˆØ± = Ø§Ù„Ø³Ø¨ÙŠÙƒØ± Ø´ØºØ§Ù„ <-- Ø§Ø­Ù†Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø·ÙÙŠÙ‡
    if (speakerBtn.classList.contains('active-state')) {
        // 1. Ù†ÙˆØ·ÙŠ Ø§Ù„ØµÙˆØª (Ù…Ø­Ø§ÙƒØ§Ø© Ø³Ù…Ø§Ø¹Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª)
        remoteAudio.volume = 1.0; 
        
        // 2. Ù†Ø´ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø¨ÙŠØ¶ Ù…Ù† Ø§Ù„Ø²Ø±Ø§Ø±
        speakerBtn.classList.remove('active-state');
    } 
    
    // Ù„Ùˆ Ù…Ø´ Ù…Ù†ÙˆØ± = Ø§Ù„Ø³Ø¨ÙŠÙƒØ± Ù…Ø·ÙÙŠ <-- Ø§Ø­Ù†Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø´ØºÙ„Ù‡
    else {
        // 1. Ù†Ø¹Ù„ÙŠ Ø§Ù„ØµÙˆØª Ù„Ø£Ù‚ØµÙ‰ Ø¯Ø±Ø¬Ø©
        remoteAudio.volume = 1.0; 
        
        // 2. Ù†Ù†ÙˆØ± Ø§Ù„Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø¹Ø´Ø§Ù† ØªØ¹Ø±Ù Ø¥Ù†Ù‡ Ø´ØºØ§Ù„
        speakerBtn.classList.add('active-state');
    }
}



// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙŠÙˆØª Ø¹Ø´Ø§Ù† ØªØºÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø²Ø±Ø§Ø± Ù„Ù„Ø£Ø¨ÙŠØ¶
function toggleMute() { 
    if(localStream) { 
        const track = localStream.getAudioTracks()[0]; 
        track.enabled = !track.enabled; 
        const btn = document.getElementById('muteBtn');
        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù„ÙˆÙ†
        if(track.enabled) {
            btn.classList.remove('active-state'); // Ù„ÙˆÙ† Ø´ÙØ§Ù (Ø´ØºØ§Ù„)
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        } else {
            btn.classList.add('active-state'); // Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ (Ù…ÙƒØªÙˆÙ…)
            btn.innerHTML = '<i class="fa-solid fa-microphone-slash" style="color:#000"></i>';
        }
    } 
}


          
        // Ø¯Ø§Ù„Ø© Ø§Ù„ÙˆÙ‚Øª (Ù…Ù‡Ù…Ø©)
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†';
            if (diff < 3600) return `Ù…Ù†Ø° ${Math.floor(diff/60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diff < 86400) return `Ù…Ù†Ø° ${Math.floor(diff/3600)} Ø³Ø§Ø¹Ø©`;
            return 'Ù…Ù†Ø° ÙØªØ±Ø©';
        }
    function linkify(text) {
    var urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    return text.replace(urlRegex, function(url) {
        // ØªÙ‚ØµÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø·ÙˆÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
        let shortUrl = url.length > 30 ? url.substring(0, 27) + "..." : url;
        return '<br><a href="' + url + '" target="_blank" class="chat-link">' + shortUrl + '</a>';
    });
}
// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
async function fetchLinkPreview(url, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    try {
        // Ø¨Ù†Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Microlink Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
        const response = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            const { title, description, image, logo } = data.data;
            
            // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø©ØŒ Ù…Ø´ Ù‡Ù†Ø¹Ù…Ù„ ÙƒØ§Ø±Øª ÙƒØ¨ÙŠØ±
            if (!image || !image.url) return;

            const domain = new URL(url).hostname.replace('www.', '');

            container.innerHTML = `
                <div class="link-preview-card" onclick="window.open('${url}', '_blank')">
                    <img src="${image.url}" class="lp-image" onerror="this.style.display='none'">
                    <div class="lp-content">
                        <div class="lp-title">${title || domain}</div>
                        <div class="lp-desc">${description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
                        <div class="lp-domain">${domain}</div>
                    </div>
                </div>
            `;
            container.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø±
        }
    } catch (e) {
        console.log("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©", e);
        // Ù„Ùˆ ÙØ´Ù„ØŒ ÙŠÙØ¶Ù„ Ù…Ø®ÙÙŠ ÙˆÙ„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Øª
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
    const headerStatus = document.getElementById('headerStatus');
    if (navigator.onLine) {
        headerStatus.innerText = "Ù…ØªØµÙ„";
        headerStatus.style.color = "#10b981";
        setTimeout(() => { 
            // Ø±Ø¬Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (Ù†Ø´Ø· Ø§Ù„Ø¢Ù† Ø£Ùˆ ØºÙŠØ±Ù‡) 
            // Ù…Ù…ÙƒÙ† ØªØ³ØªØ¯Ø¹ÙŠ updateHeader Ù…Ø±Ø© ØªØ§Ù†ÙŠØ© Ù‡Ù†Ø§
        }, 3000);
    } else {
        headerStatus.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...";
        headerStatus.style.color = "#ff3b30";
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
function getYoutubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

    // === Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø±Ø¯ (Swipe to Reply) ===
function enableSwipeToReply(rowElement, bubbleElement, msgData, msgId) {
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;
    let startY = 0; // Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ù„ÙÙˆÙ‚ ÙˆØªØ­Øª

    // 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
    bubbleElement.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        bubbleElement.classList.remove('snapping'); // Ø´ÙŠÙ„ Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø¹Ø´Ø§Ù† ØªØªØ­Ø±Ùƒ Ù…Ø¹ ØµØ¨Ø§Ø¹ÙŠ ÙÙˆØ±Ø§Ù‹
    }, { passive: true });

    // 2. Ø­Ø±ÙƒØ© Ø§Ù„ØµØ¨Ø§Ø¹
    bubbleElement.addEventListener('touchmove', (e) => {
        currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX;
        const diffY = currentY - startY;

        // Ù„Ùˆ Ø¨ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„ Ø±Ø£Ø³ÙŠ (Y)ØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£ÙÙ‚ÙŠ
        if (Math.abs(diffY) > Math.abs(diffX)) return;

        // Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† ÙÙ‚Ø· (diffX > 0) ÙˆØ¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 100 Ø¨ÙƒØ³Ù„
        if (diffX > 0 && diffX < 120) {
            isSwiping = true;
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
            bubbleElement.style.transform = `translateX(${diffX}px)`;
            
            // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…Ù…ÙƒÙ† Ù‡Ù†Ø§ Ù†Ø¸Ù‡Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¯ Ù„Ùˆ Ø¶ÙØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ù€ HTML
        }
    }, { passive: true });

    // 3. Ø±ÙØ¹ Ø§Ù„ØµØ¨Ø§Ø¹ (Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ù…Ø³)
    bubbleElement.addEventListener('touchend', (e) => {
        const diff = currentX - startX;
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯ Ø§Ù„Ù†Ø§Ø¹Ù…
        bubbleElement.classList.add('snapping');
        bubbleElement.style.transform = 'translateX(0)'; // Ø±Ø¬Ø¹Ù‡Ø§ Ù…ÙƒØ§Ù†Ù‡Ø§

        // Ù„Ùˆ Ø§Ù„Ø³Ø­Ø¨Ø© ÙƒØ§Ù†Øª Ù‚ÙˆÙŠØ© ÙƒÙØ§ÙŠØ© (Ø£ÙƒØªØ± Ù…Ù† 70 Ø¨ÙƒØ³Ù„)
        if (isSwiping && diff > 70) {

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´Ø§Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ ØªØ´ØªØºÙ„ ØµØ­
            selectedMsgId = msgId;
            selectedMsgData = msgData;
            
            // ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯
            activateReplyMode();
        }

        // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        isSwiping = false;
        startX = 0;
        currentX = 0;
    });
}
// ================= ÙƒÙˆØ¯ Ø²Ø± Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù†) =================

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„ ÙŠØ´ÙˆÙÙ‡Ø§
const chatContainerElement = document.getElementById("chatContainer");
const scrollBtnElement = document.getElementById("scrollToBottomBtn");

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø²ÙˆÙ„ (Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† global Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ onclick ÙŠØ´ÙˆÙÙ‡Ø§)
function scrollToBottom() {
    chatContainerElement.scrollTo({ top: chatContainerElement.scrollHeight, behavior: 'smooth' });
}

// Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
chatContainerElement.addEventListener("scroll", () => {
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©: Ù‡Ù„ Ø£Ù†Ø§ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† ØªØ­Øª Ø¨Ù€ 300 Ø¨ÙƒØ³Ù„ØŸ
    const distanceFromBottom = chatContainerElement.scrollHeight - chatContainerElement.scrollTop - chatContainerElement.clientHeight;
    
    if (distanceFromBottom > 300) {
        scrollBtnElement.style.display = "flex"; // Ø£Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±
    } else {
        scrollBtnElement.style.display = "none"; // Ø§Ø®ÙÙŠ Ø§Ù„Ø²Ø±
    }
});
    // Ø¯Ø§Ù„Ø© ØªÙƒØ¨ÙŠØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function autoResize(textarea) {
    textarea.style.height = 'auto'; // ØªØµÙÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
    textarea.style.height = textarea.scrollHeight + 'px'; // Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    // Ù„Ùˆ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙØ¶ÙŠØŒ Ù†Ø±Ø¬Ø¹Ù‡ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯
    if(textarea.value === '') {
        textarea.style.height = 'auto';
    }
}

// Ø¯Ø§Ù„Ø© ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ + Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙÙˆÙ‚ (Messenger Style)
function autoResize(textarea) {
    // 1. Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¹Ø´Ø§Ù† Ù†Ø­Ø³Ø¨ ØµØ­
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';

    // 2. ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§ÙØ© Ø§Ù„Ø´Ø§Øª Ù…Ù† ØªØ­Øª Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù…Ø§ ÙŠØºØ·ÙŠØ´ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„
    const footer = document.querySelector('.chat-footer');
    const chatBody = document.getElementById('chatContainer');
    
    if (footer && chatBody) {
        // Ø¨Ù†Ø´ÙˆÙ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙƒØ§Ù…ØŒ ÙˆØ¨Ù†Ø²ÙˆØ¯ Ø¹Ù„ÙŠÙ‡ Ø´ÙˆÙŠØ© (20px)
        const newPadding = footer.clientHeight + 20;
        chatBody.style.paddingBottom = newPadding + 'px';
        
        // 3. Ù†Ø²Ù„ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ø£Ø®Ø± Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
        scrollToBottom();
    }
}

// ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ: Ø£ÙˆÙ„ Ù…Ø§ ØªØ¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹ (Focus)ØŒ Ø§Ø±ÙØ¹ Ø§Ù„Ø´Ø§Øª Ù„ÙÙˆÙ‚
document.getElementById('messageInput').addEventListener('focus', () => {
    setTimeout(scrollToBottom, 300); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø­Ø¯ Ù…Ø§ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ ÙŠÙØªØ­
});
        let audioContext = null;
let analyser = null;
let visualizerInterval = null;
function startAudioVisualizer(stream) {
    // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù…Ù„Øª Mute ÙˆØ±Ø¬Ø¹Øª Ù…ÙŠØ¹Ù…Ù„Ø´ ØªØ¯Ø§Ø®Ù„)
    if (audioContext) { 
        audioContext.close().catch(e => console.log(e)); 
    }
    if (visualizerInterval) { 
        cancelAnimationFrame(visualizerInterval); 
    }

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ù„Ù„ Ø§Ù„ØµÙˆØª (Setup)
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 64; // Ø¯Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ (64 ÙƒØ§ÙÙŠØ© Ø¬Ø¯Ø§Ù‹ ÙˆØ³Ø±ÙŠØ¹Ø©)
    source.connect(analyser);

    // ØªØ¬Ù‡ÙŠØ² Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    const avatar = document.getElementById('callAvatar');
    
    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ù€ CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    avatar.classList.add('avatar-pulse');

    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Loop) - Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªÙ„Ù ÙˆØªØªÙƒØ±Ø± Ø·ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª
    function animate() {
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        analyser.getByteFrequencyData(dataArray);

        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙˆØª
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) { sum += dataArray[i]; }
        const average = sum / dataArray.length;

        // === Ù‡Ù†Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø£Ù†Øª ÙƒÙ†Øª Ø¹Ø§ÙŠØ² ØªØ¶ÙŠÙÙ‡ (Ø¬ÙˆÙ‡ Ø§Ù„Ù„ÙˆØ¨) ===
        if (average > 10) { // Ù„Ùˆ Ø§Ù„ØµÙˆØª Ù…Ø³Ù…ÙˆØ¹ (Ø£Ø¹Ù„Ù‰ Ù…Ù† 10)
            // ØªØ´ØºÙŠÙ„ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ (Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±)
            avatar.classList.add('is-speaking');
            
            // ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ Ø¨Ø°ÙƒØ§Ø¡ Ø­Ø³Ø¨ Ù‚ÙˆØ© Ø§Ù„ØµÙˆØª
            // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¯ÙŠ Ø¨ØªØ®Ù„ÙŠ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ù†Ø§Ø¹Ù… ÙˆÙ…Ø´ "Ø¨ÙŠØªØ±Ø¹Ø´"
            const scale = 1 + (average / 300); 
            const glow = average * 1.5; // Ù‚ÙˆØ© Ø§Ù„ÙˆÙ‡Ø¬
            
            avatar.style.transform = `scale(${scale})`;
            avatar.style.boxShadow = `0 0 ${glow}px rgba(0, 229, 255, ${average/100})`;
            avatar.style.borderColor = "rgba(0, 229, 255, 1)";
            
        } else {
            // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØª (Ø³ÙƒÙˆØª)
            avatar.classList.remove('is-speaking');
            avatar.style.transform = `scale(1)`; // Ø±Ø¬Ø¹ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
            
            // Ø±Ø¬Ø¹ Ø§Ù„Ø¸Ù„ ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ Ù„Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‡Ø§Ø¯ÙŠ
            avatar.style.boxShadow = `0 10px 40px rgba(0,0,0,0.5)`;
            avatar.style.borderColor = "rgba(255,255,255,0.15)";
        }

        // Ø·Ù„Ø¨ Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡ (ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„ÙˆØ¨)
        visualizerInterval = requestAnimationFrame(animate);
    }

    // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ÙˆØ¨ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    animate();
}

function monitorConnectionState() {
    if (!peerConnection) return;

    peerConnection.oniceconnectionstatechange = () => {
        const state = peerConnection.iceConnectionState;
        const statusText = document.getElementById('callStatusText');
        const overlay = document.getElementById('callOverlay');

        if (state === 'disconnected' || state === 'failed') {
            // Ø§Ù„Ù†Øª Ù‚Ø·Ø¹
            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...";
            statusText.style.color = "#f59e0b"; // Ø£ØµÙØ±
            
            // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ: ØªØ¹ØªÙŠÙ… Ø®ÙÙŠÙ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
            document.getElementById('remoteVideo').style.opacity = "0.4";
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª "ØªÙˆØª ØªÙˆØª" Ø®ÙÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            // playReconnectingSound(); 
        } 
        else if (state === 'connected' || state === 'completed') {
            // Ø§Ù„Ù†Øª Ø±Ø¬Ø¹
            statusText.style.color = "#fff";
            document.getElementById('remoteVideo').style.opacity = "1";
            
            // Ù„Ùˆ ÙƒØ§Ù† ÙÙŠÙ‡ ØªØ§ÙŠÙ…Ø±ØŒ Ø§Ù„Ù†Øµ Ù‡ÙŠØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        }
    };
}

function togglePip() {
    const overlay = document.getElementById('callOverlay');
    overlay.classList.toggle('minimized');
}

    let localVideoTrack = null;

// Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
let isRenegotiating = false;

async function toggleVideoMode() {
    const videoBtn = document.getElementById('videoBtn');
    const localVidEl = document.getElementById('localVideo');
    const videoContainer = document.getElementById('videoContainer');
    const bg = document.getElementById('callBg');

    // === Ø­Ø§Ù„Ø© 1: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ===
    if (videoBtn.classList.contains('active-state')) {
        if (localVideoTrack) {
            localVideoTrack.stop(); // ÙˆÙ‚Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ±Ø§Ùƒ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender) {
                peerConnection.removeTrack(sender);
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø¨Ø£Ù†Ù†Ø§ Ù‚ÙÙ„Ù†Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                createAndSendOffer();
            }
            localVideoTrack = null;
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        localVidEl.srcObject = null;
        videoContainer.style.display = 'none';
        bg.style.display = 'block';
        videoBtn.classList.remove('active-state');
        videoBtn.querySelector('i').className = "fa-solid fa-video-slash";
        
        if(document.getElementById('switchCamBtn')) 
            document.getElementById('switchCamBtn').style.display = 'none';
        document.getElementById('callInfoSection').style.display = 'flex'; // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø©
document.getElementById('callBg').style.display = 'block';      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
document.getElementById('callOverlay').classList.remove('video-active-mode');

    } 
    // === Ø­Ø§Ù„Ø© 2: ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ===
    else {
        try {
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            localVideoTrack = stream.getVideoTracks()[0];
            
            // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ÙŠ
            localVidEl.srcObject = stream;
            videoContainer.style.display = 'block'; 
            bg.style.display = 'none';

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø§ØªØµØ§Ù„
            if (peerConnection) {
                peerConnection.addTrack(localVideoTrack, localStream);
                // Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ§ÙˆØ¶)
                await createAndSendOffer();
            }

            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            videoBtn.classList.add('active-state');
            videoBtn.querySelector('i').className = "fa-solid fa-video";
            
            if(document.getElementById('switchCamBtn')) 
                document.getElementById('switchCamBtn').style.display = 'flex';

        } catch (e) {
            console.error(e);
            alert("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function createAndSendOffer() {
    if(!peerConnection) return;
    try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø¨Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆÙ†ÙˆØ¹ Ø®Ø§Øµ "upgrade"
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
            offer: { type: offer.type, sdp: offer.sdp },
            type: 'video_upgrade' // Ø¹Ù„Ø§Ù…Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹ ÙŠØ¹Ø±Ù Ø¥Ù†Ù‡ ØªØ­Ø¯ÙŠØ« Ù…Ø´ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
        });
    } catch(err) {
        console.error("Renegotiation failed:", err);
    }
}

// Ø¯Ø§Ù„Ø© ØªØ³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠØ±Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ÙÙŠØ¯ÙŠÙˆ)
function listenForCallUpdates() {
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
      .onSnapshot(async snapshot => {
          const data = snapshot.data();
          
          // ØªØ£Ù…ÙŠÙ†: Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§ØªÙ‚ÙÙ„ØŒ Ø§Ø®Ø±Ø¬
          if (!data || !peerConnection) return;

          // ================= 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯) =================
          if (data.screenshot_alert) {
              const alert = data.screenshot_alert;
              const now = Date.now();
              // ØªØ­ÙˆÙŠÙ„ ØªÙˆÙ‚ÙŠØª ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù„ÙˆÙ‚Øª Ø¹Ø§Ø¯ÙŠ
              const alertTime = alert.timestamp ? alert.timestamp.toMillis() : 0;

              // Ø§Ù„Ø´Ø±Ø·: Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø´ Ø¨ØªØ§Ø¹ÙŠ (uid Ù…Ø®ØªÙ„Ù) + Ø­ØµÙ„ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ
              // (Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙØªØ­Øª Ø§Ù„ØµÙØ­Ø© ÙˆÙƒØ§Ù† ÙÙŠ ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¯ÙŠÙ… Ù…Ø§ÙŠØ¸Ù‡Ø±Ø´ ØªØ§Ù†ÙŠ)
              if (alert.uid !== currentUserId && (now - alertTime) < 5000) {
                  showToast("ğŸ“¸ Ø§Ù†ØªØ¨Ù‡: Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø§Ù„ØªÙ‚Ø· Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©!");
              }
          }

          // ================= 2. Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒÙ…Ø§ Ù‡Ùˆ) =================
          // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§ÙŠØ© "ØªØ­Ø¯ÙŠØ« ÙÙŠØ¯ÙŠÙˆ" ÙˆÙ…Ø´ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø¨Ø§Ø¹ØªÙ‡Ø§
          if (data.type === 'video_upgrade' && data.offer && peerConnection.signalingState !== "closed") {
             
              // ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ù…Ø´ Ø¨Ù†Ø¹Ù…Ù„ Ù„ÙˆØ¨ (Loop)
              if(data.offer.sdp === peerConnection.localDescription?.sdp) return; 

              try {
                  // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                  
                  // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯ (Answer) Ø¬Ø¯ÙŠØ¯
                  const answer = await peerConnection.createAnswer();
                  await peerConnection.setLocalDescription(answer);
                  
                  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
                  await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
                      answer: { type: answer.type, sdp: answer.sdp },
                      type: 'video_answered' // ØªÙ… Ø§Ù„Ø±Ø¯
                  });
                  
              } catch (err) {
                  console.error("Error handling video update:", err);
              }
          }
          
          // Ù„Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¨Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ ÙˆØ¬Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¯ (Answer)
          if (data.type === 'video_answered' && data.answer) {
              if (peerConnection.signalingState === 'have-local-offer') {
                  await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
              }
          }
      });
}

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§ÙŠÙƒ ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
function monitorRemoteState() {
    db.collection('chats').doc(chatId).collection('calls').doc('active_call')
    .onSnapshot(doc => {
        const data = doc.data();
        if(!data || !data.states) return;

        // Ù‡Ø§Øª Ø£ÙŠ Ù…ÙØªØ§Ø­ Ù…Ø´ Ø¨ØªØ§Ø¹Ùƒ (ÙŠØ¹Ù†ÙŠ Ø¨ØªØ§Ø¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ)
        const otherUserKey = Object.keys(data.states).find(k => k !== currentUserId);
        
        if(otherUserKey) {
            const state = data.states[otherUserKey];
            const muteIcon = document.getElementById('remoteMuteIcon');
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØªÙ…
            if (state.muted) {
                muteIcon.style.display = 'flex';
            } else {
                muteIcon.style.display = 'none';
            }
        }
    });
}


// Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
async function initiateVideoCallUI() {
    await clearCandidates(); 
    // 1. ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ø´ØºÙˆÙ„ØŸ
    try {
        const callDoc = await db.collection('chats').doc(chatId).collection('calls').doc('active_call').get();
        if (callDoc.exists) {
            alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ØºÙˆÙ„ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© Ø£Ø®Ø±Ù‰ Ø­Ø§Ù„ÙŠØ§Ù‹");
            return; 
        }
    } catch (error) { console.error(error); }

    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setupCallUI('outgoing');
    
    try {
        // === Ù‡Ù†Ø§ Ø§Ù„ÙØ±Ù‚: Ø¨Ù†Ø·Ù„Ø¨ ÙÙŠØ¯ÙŠÙˆ + ØµÙˆØª Ù…Ù† Ø§Ù„Ø£ÙˆÙ„ ===
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        
        // === ØªØ¬Ù‡ÙŠØ² ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨ØªØ§Ø¹ÙŠ ÙÙˆØ±Ø§Ù‹ ===
        const localVidEl = document.getElementById('localVideo');
        const videoContainer = document.getElementById('videoContainer');
        const bg = document.getElementById('callBg');
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ±Ø§Ùƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø¹Ø±Ø¶Ù‡
        localVideoTrack = localStream.getVideoTracks()[0];
        localVidEl.srcObject = new MediaStream([localVideoTrack]);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ©
        videoContainer.style.display = 'block';
        bg.style.display = 'none';

        // === ØªÙ†ÙˆÙŠØ± Ø²Ø±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ÙƒÙ… ===
        const videoBtn = document.getElementById('videoBtn');
        if(videoBtn) {
            videoBtn.classList.add('active-state');
            videoBtn.querySelector('i').className = "fa-solid fa-video";
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ù†ÙŠÙ†
        const ringOut = document.getElementById('ringtoneOut');
        if (ringOut) { ringOut.currentTime = 0; ringOut.play().catch(()=>{}); }

        // Ø¥Ø¹Ø¯Ø§Ø¯ WebRTC
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
listenForRemoteCandidates();

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ (Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØµÙˆØª ÙˆØ§Ù„ØµÙˆØ±Ø©)
        peerConnection.ontrack = (event) => {
            const stream = event.streams[0];
            if (event.track.kind === 'audio') {
                document.getElementById('remoteAudio').srcObject = stream;
                handleCallConnected(event);
            }
            if (event.track.kind === 'video') {
                document.getElementById('remoteVideo').srcObject = stream;
                document.getElementById('callOverlay').classList.add('video-active-mode');
                document.getElementById('callInfoSection').style.display = 'none'; 
                document.getElementById('callBg').style.display = 'none';
            }
        };
        
        peerConnection.onicecandidate = (e) => {
            if (e.candidate) db.collection('chats').doc(chatId).collection('callCandidates').add(e.candidate.toJSON());
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø© isVideo
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').set({
            offer: { type: offer.type, sdp: offer.sdp },
            callerId: currentUserId,
            status: 'ringing',
            startTime: firebase.firestore.FieldValue.serverTimestamp(),
            isVideo: true // ğŸš© Ø¹Ù„Ø§Ù…Ø© Ø¥Ù† Ø¯ÙŠ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ
        });

        listenForAnswer();

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
        closeCallUI();
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù…Ø±Ø´Ø­Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Missing Part)
function listenForRemoteCandidates() {
    db.collection('chats').doc(chatId).collection('callCandidates')
      .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(async change => {
              if (change.type === 'added') {
                  const data = change.doc.data();
                  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø±Ø´Ø­ ØµØ§Ù„Ø­ ÙˆØ£Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙØªÙˆØ­
                  if (peerConnection && peerConnection.remoteDescription && data) {
                      try {
                          const candidate = new RTCIceCandidate(data);
                          await peerConnection.addIceCandidate(candidate);
                          console.log("New remote candidate added");
                      } catch (e) {
                          console.error("Error adding candidate:", e);
                      }
                  }
              }
          });
      });
}
async function clearCandidates() {
    const ref = db.collection('chats').doc(chatId).collection('callCandidates');
    const snapshot = await ref.get();
    const batch = db.batch();
    snapshot.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
}
let currentFacingMode = 'user'; // user = Ø£Ù…Ø§Ù…ÙŠØ©ØŒ environment = Ø®Ù„ÙÙŠØ©

async function switchCamera() {
    if (!localStream) return;
    const videoTrack = localStream.getVideoTracks()[0];
    if(!videoTrack) { showToast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ÙØ¹Ù„Ø©"); return; }

    try {
        const currentSettings = videoTrack.getSettings();
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        const nextMode = currentSettings.facingMode === 'environment' ? 'user' : 'environment';
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø§Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ù‡Ù… Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
        videoTrack.stop();
        localStream.removeTrack(videoTrack);

        const newStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: nextMode } },
            audio: false 
        });
        
        const newVideoTrack = newStream.getVideoTracks()[0];
        localVideoTrack = newVideoTrack; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„
        const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
        if(sender) sender.replaceTrack(newVideoTrack);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        document.getElementById('localVideo').srcObject = newStream;
        localStream.addTrack(newVideoTrack);

    } catch (e) {
        console.error(e);
        // Fallback: Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† exact
        try {
             const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
             // ... Ù†ÙØ³ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« ...
             document.getElementById('localVideo').srcObject = newStream;
        } catch(err2) {
            showToast("ØªØ¹Ø°Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
        }
    }
}


// ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ
function makeVideoDraggable() {
    const elmnt = document.getElementById("localVideo");
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    elmnt.onmousedown = dragMouseDown;
    elmnt.ontouchstart = dragMouseDown; // Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        if(e.type === 'touchstart') {
            pos3 = e.touches[0].clientX;
            pos4 = e.touches[0].clientY;
        } else {
            pos3 = e.clientX;
            pos4 = e.clientY;
        }
        
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
        
        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        // e.preventDefault(); // (Ù…Ù‡Ù…: Ù…ØªÙØ¹Ù„Ù‡Ø§Ø´ Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ§ØªØ´ ÙŠÙØ¶Ù„ Ø³Ù„Ø³)

        let clientX, clientY;
        if(e.type === 'touchmove') {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        pos1 = pos3 - clientX;
        pos2 = pos4 - clientY;
        pos3 = clientX;
        pos4 = clientY;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø±ÙƒØ©
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        
        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ… (bottom/right) Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø±ÙƒØ© ØªØ´ØªØºÙ„ Ø­Ø±
        elmnt.style.bottom = "auto";
        elmnt.style.right = "auto";
    }

    function closeDragElement() {
        // ÙˆÙ‚Ù Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ø£ØµØ¨Ø¹
        document.onmouseup = null;
        document.onmousemove = null;
        document.ontouchend = null;
        document.ontouchmove = null;
    }
}
async function takeSnapshot() {
    const video = document.getElementById('remoteVideo');
    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„
    if (!video || video.readyState < 2 || video.paused) { 
        showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ø§Ù„ØªÙ‚Ø§Ø·Ù‡ ğŸ“·");
        return; 
    }

    // 1. Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    // 2. ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¹Ù†Ø¯Ùƒ
    const dataURL = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `Wareed_Snap_${Date.now()}.png`;
    a.click();
    
    // 3. ØªØ£Ø«ÙŠØ± Ø§Ù„ÙÙ„Ø§Ø´
    const flash = document.createElement('div');
    flash.style.cssText = "position:fixed; inset:0; background:white; z-index:10000; opacity:0.8; transition:opacity 0.2s;";
    document.body.appendChild(flash);
    setTimeout(() => { flash.style.opacity = '0'; setTimeout(()=>flash.remove(), 200) }, 50);

    // 4. âœ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¹Ø¨Ø± Firebase
    try {
        await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
            screenshot_alert: { 
                uid: currentUserId, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            }
        });
        showToast("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ğŸ“¸");
    } catch(e) { console.error(e); }
}

    
async function toggleMute() { 
    if(localStream) { 
        const track = localStream.getAudioTracks()[0]; 
        track.enabled = !track.enabled; 
        
        const btn = document.getElementById('muteBtn');
        if(track.enabled) {
            btn.classList.remove('active-state');
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        } else {
            btn.classList.add('active-state');
            btn.innerHTML = '<i class="fa-solid fa-microphone-slash" style="color:#000"></i>';
        }

        // === Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø³ÙŠØ±ÙØ± ===
        try {
            await db.collection('chats').doc(chatId).collection('calls').doc('active_call').update({
                [`states.${currentUserId}.muted`]: !track.enabled
            });
        } catch(e) {}
    } 
}


    let screenSender = null; // Ø¹Ø´Ø§Ù† Ù†Ù…Ø³Ùƒ Ø§Ù„ØªØ±Ø§Ùƒ ÙˆÙ†Ø¹Ø±Ù Ù†Ø­Ø°ÙÙ‡ Ù„Ù…Ø§ Ù†ÙˆÙ‚Ù

// ================= Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) =================
async function toggleScreenShare() {
    const btn = document.getElementById('shareScreenBtn');

    // === Ø­Ø§Ù„Ø© 1: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§) ===
    if (btn.classList.contains('active-state')) {
        await stopScreenShare();
        return;
    }

    // === Ø­Ø§Ù„Ø© 2: Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ===
    try {
        // Ø·Ù„Ø¨ ØªØµØ±ÙŠØ­ Ø§Ù„Ø´Ø§Ø´Ø© (Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‚Ø¯ ÙŠØ·Ù„Ø¨ Ø¥Ø°Ù† Ø¥Ø¶Ø§ÙÙŠ)
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
        const screenTrack = stream.getVideoTracks()[0];

        // 1. Ø­ÙØ¸ ØªØ±Ø§Ùƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† Ù†Ø±Ø¬Ø¹Ù„Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†
        if (localVideoTrack) {
            cachedCameraTrack = localVideoTrack;
        }

        // 2. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        if (peerConnection) {
            const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
            if (sender) {
                await sender.replaceTrack(screenTrack);
            }
        }

        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ÙŠ Ø£Ù†Ø§ ÙƒÙ…Ø§Ù† Ø¨Ø¯Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ØµØºÙŠØ±Ø©
        document.getElementById('localVideo').srcObject = stream;

        // 4. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±
        btn.classList.add('active-state');
        btn.innerHTML = '<i class="fa-solid fa-rectangle-xmark" style="color:#ff3b30"></i>'; // Ø²Ø± Ø£Ø­Ù…Ø± Ù„Ù„Ø¥ØºÙ„Ø§Ù‚

        // 5. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©" Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„/Ø§Ù„Ù…ØªØµÙØ­
        screenTrack.onended = () => {
            stopScreenShare();
        };

    } catch (err) {
        console.error("Screen Share Error:", err);
        if (err.name === 'NotAllowedError') {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†
        } else {
            alert("Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function stopScreenShare() {
    const btn = document.getElementById('shareScreenBtn');
    
    // 1. Ù„Ùˆ ÙƒÙ†Ø§ Ø­Ø§ÙØ¸ÙŠÙ† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ù†Ø±Ø¬Ø¹Ù‡Ø§
    if (cachedCameraTrack && peerConnection) {
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        if (sender) {
            await sender.replaceTrack(cachedCameraTrack);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
        const camStream = new MediaStream([cachedCameraTrack]);
        document.getElementById('localVideo').srcObject = camStream;
    }

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    btn.classList.remove('active-state');
    btn.innerHTML = '<i class="fa-solid fa-desktop"></i>';
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    cachedCameraTrack = null;
    
    // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±)
    // createAndSendOffer(); 
}

// ================= Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø± (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹) =================
function toggleSendButton() {
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù„ÙŠ Ø´Ø§ÙŠÙ„ Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù‚Ù†Ø¨Ù„Ø©)
    const actionsContainer = document.querySelector('.footer-actions-left');

    if (input.value.trim().length > 0) {
        // === Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ===
        
        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø§ÙŠÙƒ
        sendBtn.style.display = 'flex';
        micBtn.style.display = 'none';
        
        // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ø´Ø§Ù† Ù†ÙˆØ³Ø¹ Ù„Ù„ÙƒØªØ§Ø¨Ø©
        if (actionsContainer) {
            actionsContainer.classList.add('hidden');
        }

    } else {
        // === Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© ===
        
        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø§ÙŠÙƒ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendBtn.style.display = 'none';
        micBtn.style.display = 'flex';
        
        // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if (actionsContainer) {
            actionsContainer.classList.remove('hidden');
        }
    }
}


    // ÙƒÙˆØ¯ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØºØµØ¨ Ø¹Ù† Ø§Ù„Ù…ØªØµÙØ­
    // ================= Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠØ© =================
function playSmartRingtone(type) {
    if (type === 'incoming' && typeof isMuted !== 'undefined' && isMuted) {
        // Ù…Ù…ÙƒÙ† ØªØ´ØºÙ„ Ù‡Ø²Ø§Ø² Ø¨Ø³ ÙƒØ¨Ø¯ÙŠÙ„
        if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        return; 
    }

    var audio;
    if (type === 'incoming') {
        audio = document.getElementById('ringtoneIn'); // Ø±Ù†Ø© Ø¬Ø§ÙŠØ©
    } else {
        audio = document.getElementById('ringtoneOut'); // Ø£Ù†Ø§ Ø¨ØªØµÙ„
    }

    if (audio) {
        audio.currentTime = 0;
        audio.volume = 1.0;
        
        var playPromise = audio.play();

        if (playPromise !== undefined) {
            playPromise.then(_ => {
                console.log("Ringtone started!");
            })
            .catch(error => {
                console.warn("Audio blocked, forcing vibration...");
                if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
            });
        }
    }
}

// ================= Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠØ© =================
function stopSmartRingtone() {
    ['ringtoneIn', 'ringtoneOut', 'callEndSound'].forEach(id => {
        var audio = document.getElementById(id);
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    });
    if (navigator.vibrate) navigator.vibrate(0);
}

// ================= Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ÙˆØ§Ù„Ù…ØµØ­Ø­Ø© =================
// ================= Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ØµÙˆØ§Øª (Ø±ÙˆØ§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø³Ø±ÙŠØ¹Ø© ÙˆÙ…Ø¶Ù…ÙˆÙ†Ø©) =================
const audioLibrary = {
    // ØµÙˆØª Ø§Ù„Ù†Ù‚Ø± (ØªÙƒØ© Ø®ÙÙŠÙØ©)
    click: new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"),
    // ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Pop)
    sent: new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"),
    // ØµÙˆØª Ø§Ù„ØªØ¯Ù…ÙŠØ±/Ø§Ù„ØªØ­Ø°ÙŠØ±
    destruct: new Audio("https://actions.google.com/sounds/v1/alarms/phone_alert.ogg"),
    // ØµÙˆØª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    record: new Audio("https://actions.google.com/sounds/v1/science_fiction/hum_short.ogg")
};
// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© (Ø¨ØªÙ…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ùˆ Ø§Ù„Ù†Øª Ø¨Ø·ÙŠØ¡)
function playUiSound(type) {
    // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù„Ùˆ Ø§Ù„ÙƒØªÙ… Ø´ØºØ§Ù„ØŒ ÙˆÙ‚Ù Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ ÙˆÙ…Ø·Ù„Ø¹Ø´ ØµÙˆØª
    if (typeof isMuted !== 'undefined' && isMuted) return;

    const sound = audioLibrary[type];
    if (sound) {
        sound.currentTime = 0; 
        sound.volume = 0.5;    
        
        var playPromise = sound.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // console.log("Ø§Ù„ØµÙˆØª Ù…Ø­ØªØ§Ø¬ ØªÙØ§Ø¹Ù„");
            });
        }
    }

}

    // 1. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¹ÙŠÙ† (Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù…Ù„Ù)
function getEyeStatusHTML(msg, isMe) {
    if (!isMe || msg.type === 'deleted') return '';

    // Ø£) Ø®Ø¶Ø±Ø§Ø¡: ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    if (msg.seen) {
        return '<i class="fa-solid fa-eye eye-green status-eye" title="ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©"></i>';
    } 
    
    // Ø¨) Ø²Ø±Ù‚Ø§Ø¡: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø· Ø§Ù„Ø¢Ù† (Ø­Ø³Ø¨ Ø§Ù„Ù‡ÙŠØ¯Ø±)
    const headerStatus = document.getElementById('headerStatus');
    if (headerStatus && (headerStatus.innerText.includes('Ù†Ø´Ø·') || headerStatus.innerText.includes('Ù…ØªØµÙ„'))) {
        return '<i class="fa-solid fa-eye eye-blue status-eye" title="ÙˆØµÙ„Øª (Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†)"></i>';
    }

    // Ø¬) Ø±Ù…Ø§Ø¯ÙŠ: ØºÙŠØ± Ù…ØªØµÙ„
    return '<i class="fa-solid fa-eye eye-dark status-eye" title="ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>';
}
// 2. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø´ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø¢Ø®Ø± Ø§Ù„Ù…Ù„Ù)
function buildMessageHTML(msg, id, u) {
    const isMe = msg.uid === currentUserId;
    let content = "";
    
    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    if (msg.type === 'deleted') content = `<span style="font-style:italic;color:#94a3b8;"><i class="fa-solid fa-ban"></i> ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>`;
    else if (msg.type === 'text') content = linkify(escapeHtml(msg.text));
    else if (msg.type === 'image') content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`;
    else if (msg.type === 'video') content = `<div class="media-container" onclick="toggleVideo(this)"><video src="${msg.text}" class="msg-video" playsinline loop></video></div>`;
    else if (msg.type === 'audio') content = generateAudioPlayer(msg.text, id);
    else if (msg.type === 'file') content = `<div class="file-card" onclick="window.open('${msg.text}')"><i class="fa-solid fa-file"></i> Ù…Ù„Ù</div>`;
    else if (msg.type === 'call_log') content = `<div class="call-card-inner">ğŸ“ ${msg.text==='no_answer'?'Ù…ÙƒØ§Ù„Ù…Ø© ÙØ§Ø¦ØªØ©':'Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª'}</div>`;
    else if (msg.type === 'story_reply') {
        let mediaTag = msg.storyType === 'video' 
            ? `<video src="${msg.storyUrl}" class="story-reply-media" muted></video>`
            : `<img src="${msg.storyUrl}" class="story-reply-media">`;
            
        content = `
        <div class="story-reply-container" onclick="window.open('${msg.storyUrl}', '_blank')">
            <div class="story-media-wrapper">${mediaTag}</div>
            <div class="story-reply-content">
                <div class="reply-label">Ø±Ø¯ Ø¹Ù„Ù‰ Ù‚ØµØªÙƒ</div>
                <div class="reply-text-body">${linkify(escapeHtml(msg.text))}</div>
            </div>
        </div>`;
    }

    // Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
    let bombHtml = "";
    if (msg.selfDestruct && msg.type !== 'deleted') {
         bombHtml = `<div id="bomb_${id}" class="bomb-info"><i class="fa-solid fa-bomb"></i></div>`;
    }

    // Ø§Ù„Ø¹ÙŠÙ† ÙˆØ§Ù„ÙˆÙ‚Øª
    const eyeHtml = getEyeStatusHTML(msg, isMe);
    const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
    const avatar = `<div class="msg-user-avatar" style="background-image:url('${u.profilePic}');">${u.char}</div>`;

    return `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'}" id="msg_${id}">
        ${!isMe ? avatar : ''}
        <div class="msg-bubble target-bubble ${msg.type==='deleted'?'deleted':''}">
            ${!isMe ? `<div style="color:${u.color};font-size:11px;font-weight:bold;">${u.name}</div>` : ''}
            <div>${content}</div>
            ${bombHtml}
            <div class="msg-meta-row" style="display:flex;justify-content:flex-end;gap:5px;">
                <span class="msg-time">${timeText}</span>
                <span id="status_${id}">${eyeHtml}</span>
            </div>
        </div>
    </div>`;
}
    // Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±
const moodDictionary = {
    // ğŸ˜„ Ø§Ù„ÙØ±Ø­ ÙˆØ§Ù„Ø¶Ø­Ùƒ ÙˆØ§Ù„Ø±ÙˆÙ‚Ø§Ù†
    happy: [
        'Ù‡Ù‡Ù‡Ù‡', 'Ø³Ø¹ÙŠØ¯', 'ÙØ±Ø­Ø§Ù†', 'lol', 'happy', 'ğŸ˜‚', 'Ø¹Ø¸ÙŠÙ…', 'Ø­Ù„Ùˆ', 'Ø¬Ù…ÙŠÙ„', 
        'Ù…Ø¨Ø±ÙˆÙƒ', 'Ø¬Ø§Ù…Ø¯', 'Ø¹Ø³Ù„', 'Ù‚Ø´Ø·Ø©', 'ØªÙ…Ø§Ù…', 'wow', 'good', 'nice', 'rofl', 
        'lmao', 'yay', 'ğŸ‰', 'ğŸ‘Œ', 'ğŸ‘', 'Ø±Ø§ÙŠÙ‚', 'Ù…Ø¨Ø³ÙˆØ·', 'Ø¶Ø­Ùƒ', 'Ù…Ø³Ø®Ø±Ø©', 
        'ÙÙ„', 'Ø¹Ø¸Ù…Ø©', 'excellent', 'amazing', 'haha', 'Ø®Ø±Ø§ÙÙŠ', 'Ø¹Ø§Ø´', 'Ø¨Ø·Ù„'
    ],

    // â¤ï¸ Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„ØºØ²Ù„ ÙˆØ§Ù„Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©
    love: [
        'Ø­Ø¨', 'Ø¨Ø­Ø¨Ùƒ', 'Ø¹Ø´Ù‚', 'love',, 'â¤ï¸', 'ğŸ˜', 'Ø­Ø¨ÙŠØ¨ÙŠ', 'Ø¹Ù…Ø±ÙŠ', 'Ù‚Ù„Ø¨ÙŠ', 
        'Ø±ÙˆØ­ÙŠ', 'ÙˆØ­Ø´ØªÙ†ÙŠ', 'miss', 'baby', 'honey', 'cute', 'Ù‚Ù…Ø±', 'Ø³ÙƒØ±', 
        'Ø¹Ø³Ù„', 'ğŸ˜˜', 'ğŸ˜»', 'ğŸ’–', 'adore', 'Ø¨Ø¹Ø´Ù‚Ùƒ', 'Ø§Ù…ÙˆØª ÙÙŠÙƒ', 'Ø­ÙŠØ§ØªÙŠ', 
        'Ø¹ÙŠÙˆÙ†ÙŠ', 'Ø¬Ù…ÙŠÙ„ØªÙŠ', 'Ø§Ù…ÙŠØ±ÙŠ', 'Ø¹Ø§Ø´Ù‚', 'Ù…ØºØ±Ù…', 'Ø¨Ù…ÙˆØª ÙÙŠÙƒ', 'ØºØ§Ù„ÙŠ', 'xoxo'
    ],

    // ğŸ˜¡ Ø§Ù„ØºØ¶Ø¨ ÙˆØ§Ù„Ø´ØªØ§Ø¦Ù… ÙˆØ§Ù„Ø±ÙØ¶
    angry: [
        'ØºØ§Ø¶Ø¨', 'Ø²ÙØª', 'ØºØ¨ÙŠ', 'angry', 'ğŸ˜¡', 'ğŸ¤¬', 'Ø§ÙƒØ±Ù‡Ùƒ', 'Ø­ÙŠÙˆØ§Ù†', 
        'Ù…ØªØ®Ù„Ù', 'Ø­Ù…Ø§Ø±', 'Ø®Ø±Ø§', 'wtf', 'hate', 'stupid', 'idiot', 'shut up', 
        'Ø§Ø®Ø±Ø³', 'ØºÙˆØ±', 'Ù‚Ø±Ù', 'Ù…Ù‚Ø±Ù', 'Ø¨ÙƒØ±Ù‡Ùƒ', 'ØªØ¨Ø§', 'damn', 'hell', 
        'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ‘', 'Ù†Ø±ÙØ²Ø©', 'Ø¹ØµØ¨ÙŠØ©', 'Ù…ØªØ¹ØµØ¨', 'ÙƒÙ„Ø¨', 'Ø­Ù‚ÙŠØ±', 'Ø§Ù…Ø´', 'Ø¨Ø·Ù„'
    ],

  
    sad: [
        'Ø­Ø²ÙŠÙ†', 'Ø²Ø¹Ù„Ø§Ù†', 'Ù…ÙƒØªØ¦Ø¨', 'sad', 'ğŸ˜¢', 'ğŸ˜­', 'ØªØ¹Ø¨Øª', 'Ù…Ø®Ù†ÙˆÙ‚', 
        'Ø¨Ù…ÙˆØª', 'ØªØ¹Ø¨Ø§Ù†', 'ÙˆØ­Ø¯ÙŠ', 'sorry', 'depressed', 'lonely', 'cry', 
        'pain', 'heartbroken', 'Ø§Ø³Ù', 'Ù†Ø¯Ù…Ø§Ù†', 'Ø®Ø³Ø§Ø±Ø©', 'ğŸ’”', 'ğŸ˜', 'ğŸ˜”', 
        'Ù…Ù„ÙŠØ´ Ù†ÙØ³', 'Ù…ÙˆØ¬ÙˆØ¹', 'ÙŠØ£Ø³', 'Ù…Ø­Ø¨Ø·', 'ÙØ±Ø§Ù‚', 'ÙˆØ¯Ø§Ø¹', 'bye', 'ØªØ¹Ø¨', 'Ù‡Ù…'
    ]
};


function detectMood(text) {
    const inputContainer = document.querySelector('.input-container');
    const sendBtn = document.querySelector('.send-btn');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    inputContainer.classList.remove('mood-happy', 'mood-love', 'mood-angry', 'mood-sad');
    if(sendBtn) sendBtn.style.background = ""; // Ø¥Ø¹Ø§Ø¯Ø© Ù„ÙˆÙ† Ø§Ù„Ø²Ø± Ù„Ù„Ø£ØµÙ„

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ
    for (const [mood, keywords] of Object.entries(moodDictionary)) {
        if (keywords.some(keyword => text.includes(keyword))) {
            inputContainer.classList.add(`mood-${mood}`);
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠØ¶Ø§Ù‹
            if(mood === 'happy') sendBtn.style.background = "linear-gradient(135deg, #f59e0b, #fbbf24)";
            if(mood === 'love') sendBtn.style.background = "linear-gradient(135deg, #db2777, #ec4899)";
            if(mood === 'angry') sendBtn.style.background = "linear-gradient(135deg, #dc2626, #ef4444)";
            if(mood === 'sad') sendBtn.style.background = "linear-gradient(135deg, #2563eb, #3b82f6)";
            break; // Ù†ÙƒØªÙÙŠ Ø¨Ø£ÙˆÙ„ Ø´Ø¹ÙˆØ± Ù†Ø¬Ø¯Ù‡
        }
    }
}


// ================= 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ =================
let isGhostMode = localStorage.getItem('wareed_ghost_mode') === 'true';

// ================= 2. ÙƒÙˆØ¯ Ø¨ÙŠØ´ØªØºÙ„ Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­ =================
document.addEventListener("DOMContentLoaded", function() {
    
    // Ø£) Ù„Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ÙƒØ§Ù† Ø´ØºØ§Ù„ØŒ Ù†ÙØ¹Ù„Ù‡ ØªØ§Ù†ÙŠ ÙˆÙ†Ù†ÙˆØ± Ø§Ù„Ø²Ø±Ø§Ø±
    if (isGhostMode) {
        document.body.classList.add('ghost-active');
        const toggleIcon = document.getElementById('ghostToggleIcon');
        if (toggleIcon) {
            toggleIcon.className = "fa-solid fa-toggle-on";
            toggleIcon.style.color = "#00e5ff";
        }
    }

    // Ø¨) Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù) Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙˆÙ‚
    const overlayIds = ['profilePage', 'deleteModal', 'callOverlay', 'contextMenuOverlay', 'lightbox', 'previewModal'];
    overlayIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.parentNode) {
            document.body.appendChild(element); // Ù†Ù‚Ù„ Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
        }
    });
});

// ================= 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ù„Ø­Ø±Ù‚) =================
async function purgeGhostMessages() {
    if (!chatId || !currentUserId) return;
    try {
        // Ù†Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ø´Ø¨Ø­ Ø¨ØªØ§Ø¹ØªÙŠ
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .where("uid", "==", currentUserId)
            .where("isGhost", "==", true)
            .get();

        if (snapshot.empty) return;

        // Ù†Ø­Ø°ÙÙ‡Ù… ÙƒÙ„Ù‡Ù…
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        showToast("ğŸ’¨ ØªÙ… Ø­Ø°Ù Ø¢Ø«Ø§Ø± Ø§Ù„Ø´Ø¨Ø­");
    } catch (e) { console.error(e); }
}
// ================= 1. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… =================
function sendGhostLog(action) {
    if (!chatId || !currentUserId) return;
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ù†Ø¸Ø§Ù…" (Ù„Ù† ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù„Ø£Ù† isGhost Ù…Ø´ true)
    db.collection("chats").doc(chatId).collection("messages").add({
        type: 'system',       // Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
        text: action,         // 'on' Ø£Ùˆ 'off'
        uid: currentUserId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        seen: false,
        isGhost: false        // ğŸ”¥ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¹Ø´Ø§Ù† Ù…ØªØªÙ…Ø³Ø­Ø´ Ù…Ø¹ Ø§Ù„Ø­Ø±Ù‚
    });
}

// ================= 2. Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„ =================
function toggleGhostMode() {
    isGhostMode = !isGhostMode;
    localStorage.setItem('wareed_ghost_mode', isGhostMode);

    const toggleIcon = document.getElementById('ghostToggleIcon');
    
    if (isGhostMode) {
        // -- ØªØ´ØºÙŠÙ„ --
        document.body.classList.add('ghost-active');
        showToast("ğŸ‘» ØªÙ… ØªØ«Ø¨ÙŠØª ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­");
        playUiSound('destruct');
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹
        sendGhostLog('ghost_on'); 
        
        if(toggleIcon) {
            toggleIcon.className = "fa-solid fa-toggle-on";
            toggleIcon.style.color = "#00e5ff"; 
        }
    } else {
        // -- Ø¥ÙŠÙ‚Ø§Ù --
        purgeGhostMessages(); // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø¬Ù…ÙŠØ¹
        sendGhostLog('ghost_off');

        document.body.classList.remove('ghost-active');
        showToast("ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„");
        
        if(toggleIcon) {
            toggleIcon.className = "fa-solid fa-toggle-off";
            toggleIcon.style.color = "#64748b";
        }
    }
}


// ============================================================
// ğŸ§¹ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ©: ØªÙ†Ø¸ÙŠÙ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø¨Ø­ Ø§Ù„Ø¹Ø§Ù„Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
// ============================================================

// 1. ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù…Ù„Øª Ø±ÙŠÙØ±Ø´ ÙˆØ§Ù„Ø±Ø³Ø§ÙŠÙ„ Ù„Ø³Ù‡ Ù…ÙˆØ¬ÙˆØ¯Ø©)
window.addEventListener('DOMContentLoaded', () => {
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (currentUserId && chatId) {
        purgeGhostMessages();
    }
});
// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù…Ù† ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
async function loadChatDetails() {
    if (!chatId || !currentUserId) return;

    try {
        const chatDoc = await db.collection("chats").doc(chatId).get();
        
        if (chatDoc.exists) {
            const data = chatDoc.data();
            let otherUserId = null;

            // Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø¸Ø§Ù…Ùƒ ÙŠØ³ØªØ®Ø¯Ù… Ù…ØµÙÙˆÙØ© users (ÙˆÙ‡Ø°Ø§ Ø§Ù„Ø£ÙØ¶Ù„)
            if (data.users && Array.isArray(data.users)) {
                otherUserId = data.users.find(id => id !== currentUserId);
            }
            // Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø¸Ø§Ù…Ùƒ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ownerId Ùˆ peerId (Ø£Ùˆ Ù…Ø³Ù…ÙŠØ§Øª Ø£Ø®Ø±Ù‰)
            // Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø¹Ù†Ø¯Ùƒ
            else if (data.participants) {
                 otherUserId = data.participants.find(id => id !== currentUserId);
            }
            // Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Ø§Ù„ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø¨Ø³ÙŠØ· Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù…Ø±Ø³Ù„ ÙˆÙ…Ø³ØªÙ‚Ø¨Ù„ (Ø£Ù‚Ù„ Ø¯Ù‚Ø©)
            else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…ØµÙÙˆÙØ© ØµØ±ÙŠØ­Ø©
                if (data.senderId && data.senderId !== currentUserId) otherUserId = data.senderId;
                else if (data.sentTo && data.sentTo !== currentUserId) otherUserId = data.sentTo;
            }

            // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±ØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙˆØ±Ø§Ù‹
            if (otherUserId) {
                cachedOtherUserId = otherUserId; // Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                updateHeader(otherUserId); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
                listenForBlockStatus();
            } else {
                console.log("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ID Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª");
            }
        }
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø§Øª:", e);
    }
}
// ================= Ø£ÙƒÙˆØ§Ø¯ ØªØ´ØºÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =================
// 1. Ø²Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« (Ø¨ÙŠØªØ­Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
// ================================================================
// ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ + Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø§Ù„Ø­Ø±Ù)
// ================================================================

// 1. Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ØªØ±Ø¨Ø·Ù‡ Ø¨Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
function toggleSearchMode() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ù…ÙØªÙˆØ­Ø©
    if(typeof closeProfile === 'function') closeProfile();
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù†ØµÙ†Ø¹Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
    ensureSearchOverlayExists();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    const overlay = document.getElementById('fullSearchOverlay');
    overlay.style.display = 'flex';
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆÙ…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const input = document.getElementById('fullSearchInput');
    input.value = '';
    input.focus();
    
    // ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('searchResultsList').innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; color:#64748b;">
            <i class="fa-solid fa-magnifying-glass" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
            <p>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« (Ø­Ø±Ù Ø¨Ø­Ø±Ù)...</p>
        </div>`;
}

// 2. Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø¹Ø´Ø§Ù† ØªØ¶Ù…Ù† Ø¥Ù†Ù‡Ø§ ØªØ¸Ù‡Ø±)
function ensureSearchOverlayExists() {
    if (document.getElementById('fullSearchOverlay')) return; // Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø®Ù„Ø§Øµ

    // Ø£) Ø­Ù‚Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… (CSS)
    const style = document.createElement('style');
    style.innerHTML = `
        .search-overlay-full {
            position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #0b1121; z-index: 999999 !important;
            display: none; flex-direction: column; animation: fadeIn 0.2s;
        }
        .search-header {
            display: flex; align-items: center; gap: 10px; padding: 15px;
            background: rgba(15, 25, 38, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .search-input-box {
            flex: 1; background: rgba(255,255,255,0.05); border-radius: 20px;
            padding: 8px 15px; display: flex; align-items: center; gap: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .search-input-field {
            background: transparent; border: none; color: #fff; width: 100%;
            font-size: 15px; font-family: inherit; outline: none;
        }
        .search-results-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .search-result-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .search-result-item:active { background: rgba(255,255,255,0.05); }
        .highlight-term { color: #00e5ff; background: rgba(0, 229, 255, 0.15); border-radius: 2px; }
    `;
    document.head.appendChild(style);

    // Ø¨) Ø­Ù‚Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ (HTML)
    const overlayHTML = `
    <div id="fullSearchOverlay" class="search-overlay-full">
        <div class="search-header">
            <i class="fa-solid fa-arrow-right" style="color:#94a3b8; font-size:20px; cursor:pointer; padding:5px;" onclick="document.getElementById('fullSearchOverlay').style.display='none'"></i>
            <div class="search-input-box">
                <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;"></i>
                <input type="text" id="fullSearchInput" class="search-input-field" placeholder="Ø§Ø¨Ø­Ø«..." oninput="performFullSearch(this.value)">
            </div>
        </div>
        <div class="search-results-list" id="searchResultsList"></div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', overlayHTML);
}

// 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ (The Core Engine)
// Ù…ØªØºÙŠØ± Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù…Ù†Ø³Ø­Ø¨Ø´ Ù†Øª ÙƒØªÙŠØ± ÙˆØ§Ù†Øª Ø¨ØªÙƒØªØ¨ Ø­Ø±Ù Ø­Ø±Ù
let searchDebounceTimer; 

async function performFullSearch(query) {
    const list = document.getElementById('searchResultsList');
    
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†Øµ Ù…ÙƒØªÙˆØ¨ØŒ ÙØ¶ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    if (!query || query.trim() === '') {
        list.innerHTML = ''; 
        return;
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù†Ø¨Ø¯Ø£ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
    clearTimeout(searchDebounceTimer);

    // Ø§Ø³ØªÙ†Ù‰ Ù†Øµ Ø«Ø§Ù†ÙŠØ© Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ®Ù„Øµ ÙƒØªØ§Ø¨Ø© Ø¹Ø´Ø§Ù† ÙŠØ¨Ø¯Ø£ ÙŠØ¨Ø­Ø« (ØªÙˆÙÙŠØ± Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±)
    searchDebounceTimer = setTimeout(async () => {
        
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#00e5ff;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ... <i class="fa-solid fa-spinner fa-spin"></i></div>';

        try {
            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ Ø§Ù„Ø´Ø§Øª ÙÙŠÙ‡ Ø¢Ù„Ø§Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙŠÙØ¶Ù„ Ø¹Ù…Ù„ limit(100) Ù…Ø«Ù„Ø§Ù‹
            const snapshot = await db.collection("chats").doc(chatId).collection("messages")
                .orderBy("createdAt", "desc") // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
                .get();

            let resultsHTML = '';
            let count = 0;
            const lowerQuery = query.toLowerCase();

            // 2. Ø§Ù„ÙÙ„ØªØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ø£Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù…Ø¹Ù†Ø¯ÙˆØ´ Ø¨Ø­Ø« Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø²Ø¦ÙŠ)
            snapshot.forEach(doc => {
                const msg = doc.data();
                
                // Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙˆØ±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…
                if (msg.type === 'deleted' || msg.type === 'system') return;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© ÙˆÙÙŠÙ‡Ø§ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                if (msg.text && msg.text.toLowerCase().includes(lowerQuery)) {
                    count++;
                    
                    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
                    const isMe = msg.uid === currentUserId;
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    const u = userCache[msg.uid] || { name: (isMe ? "Ø£Ù†Øª" : "Ù…Ø³ØªØ®Ø¯Ù…"), profilePic: null, char: "U", color: "#555" };
                    
                    const displayName = isMe ? "Ø£Ù†Øª" : u.name;
                    
                    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù„ÙŠ Ø¨Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§
                    const highlightedText = msg.text.replace(new RegExp(`(${query})`, 'gi'), 
                        `<span class="highlight-term">$1</span>`
                    );

                    // Ø±Ø³Ù… Ø§Ù„Ù†ØªÙŠØ¬Ø©
                    resultsHTML += `
                    <div class="search-result-item" onclick="handleSearchResultClick('${doc.id}')">
                        <div style="width:45px; height:45px; border-radius:50%; background:${u.color || '#333'}; background-size:cover; background-position:center; display:grid; place-items:center; color:#fff; flex-shrink:0; ${u.profilePic ? 'background-image:url('+u.profilePic+')' : ''}">
                            ${u.profilePic ? '' : u.char}
                        </div>
                        <div style="flex:1; overflow:hidden;">
                            <div style="font-size:14px; font-weight:bold; color:#fff; margin-bottom:4px;">${displayName}</div>
                            <div style="font-size:13px; color:#94a3b8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${highlightedText}</div>
                        </div>
                        <div style="font-size:10px; color:#555;">${msg.createdAt ? formatTime(msg.createdAt) : ''}</div>
                    </div>`;
                }
            });

            // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if (count === 0) {
                list.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}" ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</div>`;
            } else {
                list.innerHTML = resultsHTML;
            }

        } catch (error) {
            console.error("Search Error:", error);
            list.innerHTML = `<div style="text-align:center; padding:20px; color:#ff3b30;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«</div>`;
        }

    }, 600); // 600 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© ØªØ£Ø®ÙŠØ±
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©
async function handleSearchResultClick(msgId) {
    document.getElementById('fullSearchOverlay').style.display = 'none';
    
    // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‚Ø¯Ø§Ù…Ù†Ø§ (Ø­Ø¯ÙŠØ«Ø©)ØŒ Ù†Ø±ÙˆØ­ Ù„Ù‡Ø§ Ø¹Ù„Ø·ÙˆÙ„
    const el = document.getElementById('msg_' + msgId);
    if(el && !isArchiveMode) {
        el.scrollIntoView({behavior: "smooth", block: "center"});
        highlightBubble(el);
        return;
    }

    // Ù„Ùˆ Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ù†ÙØ¹Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    showToast("â³ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...");
    isArchiveMode = true; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ

    try {
        const container = document.getElementById("chatContainer");
        
        // 1. Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
        const targetDoc = await db.collection("chats").doc(chatId).collection("messages").doc(msgId).get();
        if (!targetDoc.exists) { showToast("âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø°ÙˆÙØ©"); return; }
        
        const targetDate = targetDoc.data().createdAt;

        // 2. Ù†Ø¬ÙŠØ¨ 15 Ø±Ø³Ø§Ù„Ø© (Ù‚Ø¨Ù„) Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ (Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        const olderSnap = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "desc")
            .startAfter(targetDate)
            .limit(15)
            .get();

        // 3. Ù†Ø¬ÙŠØ¨ 15 Ø±Ø³Ø§Ù„Ø© (Ø¨Ø¹Ø¯) Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ÙˆØ¯Ù‡ Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§ÙŠØ²Ù‡)
        const newerSnap = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "asc")
            .startAfter(targetDate)
            .limit(15)
            .get();

        // 4. Ù†Ø¯Ù…Ø¬Ù‡Ù… ÙƒÙ„Ù‡Ù… ÙÙŠ Ù…ØµÙÙˆÙØ© ÙˆØ§Ø­Ø¯Ø© Ù…Ø±ØªØ¨Ø©
        let allDocs = [];
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù…Ø¹ Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ØµØ­)
        olderSnap.docs.forEach(d => allDocs.push(d));
        allDocs.reverse(); 
        
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
        allDocs.push(targetDoc);
        
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡)
        newerSnap.docs.forEach(d => allDocs.push(d));

        // 5. Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙŠØ¹Ø±Ù ÙŠÙƒÙ…Ù„)
        oldestDoc = allDocs[0]; // Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© ÙÙˆÙ‚
        newestArchivedDoc = allDocs[allDocs.length - 1]; // Ø£Ø­Ø¯Ø« Ø±Ø³Ø§Ù„Ø© ØªØ­Øª

        // 6. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„
        container.innerHTML = `
            <div id="archiveAlert" style="position:sticky; top:10px; z-index:50; text-align:center; opacity:0.8;">
                <button onclick="exitArchiveMode()" style="background:#00e5ff; color:#000; border:none; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:12px; cursor:pointer;">
                   Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¨Ø§Ø´Ø± <i class="fa-solid fa-bolt"></i>
                </button>
            </div>
        `;

        // ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const uids = new Set();
        allDocs.forEach(d => uids.add(d.data().uid));
        await Promise.all(Array.from(uids).map(uid => getUser(uid)));

        let html = "";
        allDocs.forEach(doc => {
            const msg = doc.data();
            const isMe = msg.uid === currentUserId;
            const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };
            html += buildMessageHTML(msg, doc.id, u, isMe);
        });

        container.insertAdjacentHTML('beforeend', html);

        // 7. Ø§Ù„Ù‚ÙØ² Ù„Ù„Ø±Ø³Ø§Ù„Ø©
        setTimeout(() => {
            const targetEl = document.getElementById('msg_' + msgId);
            if (targetEl) {
                targetEl.scrollIntoView({behavior: "auto", block: "center"});
                highlightBubble(targetEl);
            }
        }, 100);

    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}
async function loadMoreNewerMessages() {
    if (isLoadingNewer || !newestArchivedDoc || !isArchiveMode) return;
    
    const container = document.getElementById("chatContainer");
    
    // Ù„Ùˆ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙˆØ§Ù„Ù‚Ø§Ø¹ ØµØºÙŠØ±Ø© (ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø²Ù„ Ù„ØªØ­Øª)
    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
        isLoadingNewer = true;

        try {
            // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ "Ø¨Ø¹Ø¯" Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ø¹Ø±ÙˆØ¶Ø© ØªØ­Øª
            const snap = await db.collection("chats").doc(chatId).collection("messages")
                .orderBy("createdAt", "asc")
                .startAfter(newestArchivedDoc)
                .limit(20)
                .get();

            if (!snap.empty) {
                newestArchivedDoc = snap.docs[snap.docs.length - 1]; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±

                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const uids = new Set();
                snap.docs.forEach(d => uids.add(d.data().uid));
                await Promise.all(Array.from(uids).map(uid => getUser(uid)));

                let html = "";
                snap.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUserId;
                    const u = userCache[msg.uid] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', color: '#555', char: 'U', profilePic: null };
                    html += buildMessageHTML(msg, doc.id, u, isMe);
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ ØªØ­Øª
                container.insertAdjacentHTML('beforeend', html);
                
            } else {
                // Ù„Ùˆ Ù…ÙÙŠØ´ Ø±Ø³Ø§ÙŠÙ„ ØªØ§Ù†ÙŠØ©ØŒ ÙŠØ¨Ù‚Ù‰ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø­Ø§Ø¶Ø±
                showToast("âœ… Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø£Ø­Ø¯Ø« Ù†Ù‚Ø·Ø©");
                exitArchiveMode(); // Ù†Ø®Ø±Ø¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
            }

        } catch (e) { console.log(e); }
        
        isLoadingNewer = false;
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ
function exitArchiveMode() {
    isArchiveMode = false;
    location.reload(); // Ø±ÙŠÙØ±Ø´ Ø³Ø±ÙŠØ¹ ÙŠØ±Ø¬Ø¹Ùƒ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
}

function buildMessageHTML(msg, id, u, isMe) {
    let content = "";
    let bubbleClass = "msg-bubble target-bubble";

    if (msg.type === 'deleted') {
        content = `<span style="font-style: italic; color: #94a3b8; font-size: 13px;">ğŸš« ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>`;
        bubbleClass += " deleted";
    }
    else if (msg.type === 'text') { content = linkify(escapeHtml(msg.text)); }
    else if (msg.type === 'image') { content = `<div class="media-container"><img src="${msg.text}" class="msg-image" onclick="openLb('${msg.text}')"></div>`; }
    else if (msg.type === 'video') { content = `<div class="media-container" onclick="toggleVideo(this)"><video src="${msg.text}" class="msg-video" playsinline loop></video></div>`; }
    else if (msg.type === 'audio') { content = generateAudioPlayer(msg.text, id); }
    else if (msg.type === 'file') { content = `<div class="file-card" onclick="window.open('${msg.text}', '_blank')"><div class="file-icon"><i class="fa-solid fa-file-lines"></i></div><div class="file-info"><span class="file-name">Ù…Ù„Ù Ù…Ø±ÙÙ‚</span><span class="file-size">ØªØ­Ù…ÙŠÙ„</span></div></div>`; }
    
    const timeText = msg.createdAt ? formatTime(msg.createdAt) : "";
    const miniAvatar = `<div class="msg-user-avatar" style="background-image: url('${u.profilePic}'); background-color:${u.color};">${u.profilePic?'':u.char}</div>`;

    return `
    <div class="msg-row ${isMe ? 'sender' : 'receiver'}" id="msg_${id}">
        ${!isMe ? miniAvatar : ''}
        <div class="${bubbleClass}">
            ${!isMe ? `<div class="sender-name" style="color:${u.color}; font-size:11px; margin-bottom:2px;">${u.name}</div>` : ''}
            <div>${content}</div>
            <div class="msg-meta-row" style="display:flex; justify-content:flex-end; gap:5px; align-items:center; margin-top:3px;">
                <span class="msg-time">${timeText}</span>
            </div>
        </div>
    </div>`;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² (Ø¹Ø´Ø§Ù† ØªÙ†ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù…Ø§ ØªØ±ÙˆØ­Ù„Ù‡Ø§)
function highlightBubble(row) {
    const bubble = row.querySelector('.msg-bubble');
    if(bubble) {
        bubble.style.transition = "0.5s";
        bubble.style.boxShadow = "0 0 40px #00e5ff"; // ØªÙˆÙ‡Ø¬ Ù‚ÙˆÙŠ
        bubble.style.border = "1px solid #00e5ff";
        setTimeout(() => { 
            bubble.style.boxShadow = "none"; 
            bubble.style.borderColor = "transparent";
        }, 2000);
    }
}


// 4. Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø±Ø³Ø§Ù„Ø© (Ø§Ù„Ù‚ÙØ² ÙˆØ§Ù„ÙˆÙ…ÙŠØ¶)
function jumpToMessage(id) {
    document.getElementById('fullSearchOverlay').style.display = 'none'; // Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«
    
    const el = document.getElementById('msg_' + id);
    if(el) {
        el.scrollIntoView({behavior: "smooth", block: "center"});
        const bubble = el.querySelector('.msg-bubble');
        if(bubble) {
            // ÙˆÙ…ÙŠØ¶ Ø£Ø²Ø±Ù‚
            bubble.style.transition = "0.3s";
            bubble.style.boxShadow = "0 0 30px #00e5ff";
            bubble.style.borderColor = "#00e5ff";
            setTimeout(() => { 
                bubble.style.boxShadow = "none"; 
                bubble.style.borderColor = "transparent";
            }, 1500);
        }
    }
}


// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙØ¹Ù„ÙŠ
function searchMessages(query) {
    if (!query) { clearSearch(); return; }
    const bubbles = document.querySelectorAll('.msg-bubble');
    let found = false;
    
    bubbles.forEach(bubble => {
        const text = bubble.innerText.toLowerCase();
        const row = bubble.closest('.msg-row');
        
        if (text.includes(query.toLowerCase())) {
            row.style.display = 'flex';
            bubble.style.boxShadow = '0 0 15px rgba(0, 229, 255, 0.5)'; // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ØªÙˆÙ‡Ø¬
            bubble.style.border = '1px solid #00e5ff';
            found = true;
        } else {
            row.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚
            bubble.style.boxShadow = 'none';
            bubble.style.border = 'none';
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø«
function closeSearchBar() {
    const bar = document.getElementById('searchBar');
    if(bar) bar.remove();
    clearSearch(); // Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
}

function clearSearch() {
    document.querySelectorAll('.msg-row').forEach(row => {
        row.style.display = 'flex';
        const bubble = row.querySelector('.msg-bubble');
        if(bubble) {
            bubble.style.boxShadow = 'none';
            bubble.style.border = 'none';
        }
    });
}
// 2. Ø²Ø± ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„)
let isMuted = false; // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©

function toggleMuteNotifications(element) {
    isMuted = !isMuted; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    
    // 1. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
    const icon = element.querySelector('.toggle-icon');
    const text = element.querySelector('.p-item-text span');
    
    // 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø¬Ø±Ø³ Ø§Ù„Ù„ÙŠ Ø¬Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…) ğŸ”¥ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ ğŸ”¥
    const headerIcon = document.getElementById('headerMuteIcon');
    
    // ØªØ£Ø«ÙŠØ± Ù‡Ø²Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(30);

    if (isMuted) {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… (ON) ---
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        icon.classList.remove('fa-toggle-off');
        icon.classList.add('fa-toggle-on');
        icon.style.color = "#8b5cf6"; // Ø¨Ù†ÙØ³Ø¬ÙŠ
        text.innerText = "ØªÙ… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø±Ø³ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        if(headerIcon) headerIcon.style.display = "inline-block"; 

        showToast("ğŸ”• ØªÙ… ÙƒØªÙ… ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
        
    } else {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (OFF) ---
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        icon.classList.remove('fa-toggle-on');
        icon.classList.add('fa-toggle-off');
        icon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ
        text.innerText = "ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø±Ø³ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
        if(headerIcon) headerIcon.style.display = "none"; 

        showToast("ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    }
}


// 3. Ø²Ø± Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Block)
// Ø¯ÙˆØ§Ù„ ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeBlockModal() {
    document.getElementById('customBlockModal').style.display = 'none';
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¯ÙŠ)
// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø¸Ø±
async function toggleBlockUser() {
    
    // ğŸ”¥ğŸ”¥ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ”¥ğŸ”¥
    // Ø¯Ù‡ Ø¨ÙŠÙ†Ù‚Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ø¢Ø®Ø± Ø§Ù„ØµÙØ­Ø© Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„
    const modalElement = document.getElementById('customBlockModal');
    if (modalElement && modalElement.parentNode !== document.body) {
        document.body.appendChild(modalElement);
    }
    // ------------------------------------

    if (!cachedOtherUserId) return;

    if (isUserBlocked) {
        // ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±ØŸ")) {
             performUnblock(cachedOtherUserId);
        }
    } else {
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± (ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©)
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©
        const cooldownDoc = await db.collection('users').doc(currentUserId).collection('block_cooldowns').doc(cachedOtherUserId).get();
        if (cooldownDoc.exists) {
            const lastUnblock = cooldownDoc.data().unblockedAt.toDate().getTime();
            const diffHours = (Date.now() - lastUnblock) / (1000 * 60 * 60);
            if (diffHours < 48) {
                showToast(`âš ï¸ Ù…ØªØ¨Ù‚ÙŠ ${Math.ceil(48 - diffHours)} Ø³Ø§Ø¹Ø©`);
                return;
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ù‚Ù„Ù†Ø§Ù‡Ø§
        document.getElementById('customBlockModal').style.display = 'flex';
    }
}


// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨ØªØªÙ†Ø¯Ù‰ Ù„Ù…Ø§ ØªØ¯ÙˆØ³ "Ù…ÙˆØ§ÙÙ‚" ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©)
async function confirmBlockAction() {
    closeBlockModal(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø©
    
    try {
        await db.collection('users').doc(currentUserId).collection('blocked').doc(cachedOtherUserId).set({
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast("ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        closeProfile(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    } catch (e) { 
        console.error(e); 
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£"); 
    }
}

// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ù‡Ù†Ø­ØªØ§Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ…Ø§Ù†)
// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¹Ø¯Ø§Ø¯)
async function performUnblock(targetId) {
    try {
        // 1. Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
        await db.collection('users').doc(currentUserId).collection('blocked').doc(targetId).delete();
        
        // 2. ğŸ”¥ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ´ØºÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©) ğŸ”¥
        await db.collection('users').doc(currentUserId).collection('block_cooldowns').doc(targetId).set({
            unblockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast("âœ… ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± (Ø¨Ø¯Ø£ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©)");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©
        const blockedPage = document.getElementById('blockedUsersPage'); // Ø£Ùˆ blockedUsersFile Ø­Ø³Ø¨ Ù…Ø§ Ø³Ù…ÙŠØªÙ‡
        if(blockedPage && blockedPage.style.display === 'flex') {
            // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ù‡Ù†Ø§
             if(typeof loadBlockedData === 'function') loadBlockedData();
             else if(typeof openBlockedUsersPage === 'function') openBlockedUsersPage();
        } else {
            closeProfile();
        }
    } catch (e) { 
        console.error(e); 
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
    }
}


// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø²Ø± Ø§Ù„Ø­Ø¸Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function updateProfileBlockButton(isBlocked) {
    const blockText = document.querySelector('.p-item-text span[style*="ef4444"]'); // Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø­Ù…Ø±
    const blockIcon = document.querySelector('.p-item-icon[style*="ef4444"]');
    
    if (blockText && blockIcon) {
        if (isBlocked) {
            blockText.innerText = "ÙÙƒ Ø§Ù„Ø­Ø¸Ø±";
            blockText.style.color = "#fff"; // Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶
            blockIcon.parentElement.style.borderColor = "rgba(255,255,255,0.2)";
        } else {
            blockText.innerText = "Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
            blockText.style.color = "#ef4444"; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø±
            blockIcon.parentElement.style.borderColor = "rgba(239, 68, 68, 0.2)";
        }
    }
}

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ (ØªÙˆØ¶Ø¹ Ø¹Ù„Ù‰ Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
// ================= ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¹Ø±Ø¶ =================

// ================= 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ ÙˆØ¬Ù„Ø¨ Ø§Ù„ØµÙˆØ± =================
// ================= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =================

// ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ù…Ù„Ø© =================
// ================= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =================

// ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø¨ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ =================
// Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ± Ù„ØºØ±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù€ Lightbox

async function openMediaGallery() {
    // 1. ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    if(document.getElementById('profilePage')) document.getElementById('profilePage').style.display = 'none';
    document.getElementById('mediaGalleryOverlay').style.display = 'flex';
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ¯Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const panels = ['panel-media', 'panel-files', 'panel-audio', 'panel-links'];
    panels.forEach(id => {
        document.getElementById(id).innerHTML = `
            <div class="empty-state">
                <i class="fa-solid fa-circle-notch fa-spin empty-icon" style="font-size:30px; color:#00e5ff;"></i>
                <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ...</span>
            </div>`;
    });

    try {
        // 3. Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙŠÙØ¶Ù„ Ø¹Ù…Ù„ limit Ù„Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ Ø¶Ø®Ù…)
        const snapshot = await db.collection("chats").doc(chatId).collection("messages")
            .orderBy("createdAt", "desc") // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
            .get();

        // 4. ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…
        panels.forEach(id => document.getElementById(id).innerHTML = '');
        galleryImagesList = []; 
        
        let hasMedia = false, hasFiles = false, hasAudio = false, hasLinks = false;

        snapshot.forEach(doc => {
            const msg = doc.data();
            if (msg.type === 'deleted') return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙ
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const dateStr = msg.createdAt ? msg.createdAt.toDate().toLocaleDateString('ar-EG') : 'Ù…Ø¤Ø®Ø±Ø§Ù‹';

            // ================== (Ø£) Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ==================
            if (msg.type === 'image') {
                hasMedia = true;
                galleryImagesList.unshift(msg.text); // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø¹ÙƒÙˆØ³Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨)
                // Ù„Ø§Ø­Ø¸ Ù‡Ù†Ø§ Ø¨Ù†Ø­Ø· index ØµØ­ÙŠØ­ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø·ÙˆÙ„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠ
                const imgIndex = 0; // Ø³ÙŠØªÙ… Ø¶Ø¨Ø·Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚

                document.getElementById('panel-media').insertAdjacentHTML('beforeend', `
                    <div class="mg-item" onclick="openGalleryViewerBySrc('${msg.text}')">
                        <img src="${msg.text}" loading="lazy">
                    </div>
                `);
            }
            else if (msg.type === 'video') {
                hasMedia = true;
                document.getElementById('panel-media').insertAdjacentHTML('beforeend', `
                    <div class="mg-item" onclick="window.open('${msg.text}', '_blank')">
                        <video src="${msg.text}#t=1.0" preload="metadata"></video>
                        <div class="vid-indicator"><i class="fa-solid fa-video"></i></div>
                        <div style="position:absolute; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.3);">
                            <i class="fa-solid fa-play" style="color:#fff; font-size:20px;"></i>
                        </div>
                    </div>
                `);
            }

            // ================== (Ø¨) Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ==================
            else if (msg.type === 'file') {
                hasFiles = true;
                let fileName = "Ù…Ù„Ù Ù…Ø±ÙÙ‚";
                try { fileName = decodeURIComponent(msg.text.split('/').pop().split('?')[0]); } catch(e){}
                
                document.getElementById('panel-files').insertAdjacentHTML('beforeend', `
                    <div class="mg-list-card" onclick="window.open('${msg.text}', '_blank')">
                        <div class="list-icon-box icon-file"><i class="fa-solid fa-file-lines"></i></div>
                        <div class="list-info">
                            <div class="list-title">${fileName}</div>
                            <div class="list-sub">${dateStr} â€¢ Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„</div>
                        </div>
                        <i class="fa-solid fa-download" style="color:#64748b;"></i>
                    </div>
                `);
            }

            // ================== (Ø¬) Ø§Ù„ØµÙˆØªÙŠØ§Øª ==================
            else if (msg.type === 'audio') {
                hasAudio = true;
                document.getElementById('panel-audio').insertAdjacentHTML('beforeend', `
                    <div class="mg-list-card">
                        <div class="list-icon-box icon-audio" onclick="new Audio('${msg.text}').play();"><i class="fa-solid fa-play"></i></div>
                        <div class="list-info">
                            <div class="list-title">Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
                            <div class="list-sub">${dateStr}</div>
                        </div>
                        <audio src="${msg.text}" controls style="height:30px; max-width:150px; opacity:0.5;"></audio>
                    </div>
                `);
            }

            // ================== (Ø¯) Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Regex) ==================
            else if (msg.type === 'text' && msg.text) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ù†Øµ
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const matches = msg.text.match(urlRegex);
                if (matches) {
                    hasLinks = true;
                    matches.forEach(url => {
                        let domain = 'Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ';
                        try { domain = new URL(url).hostname; } catch(e){}

                        document.getElementById('panel-links').insertAdjacentHTML('beforeend', `
                            <div class="mg-list-card" onclick="window.open('${url}', '_blank')">
                                <div class="list-icon-box icon-link"><i class="fa-solid fa-link"></i></div>
                                <div class="list-info">
                                    <div class="list-title" style="direction:ltr; text-align:right;">${domain}</div>
                                    <div class="list-sub" style="direction:ltr; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${url}</div>
                                </div>
                            </div>
                        `);
                    });
                }
            }
        });

        // 5. Ø¶Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± (galleryImagesList) Ù„Ù„Ø¹Ø§Ø±Ø¶
        // Ù‚Ù…Ù†Ø§ Ø¨Ù…Ù„Ø¦Ù‡Ø§ Ø¨Ø§Ù„Ø¹ÙƒØ³ (unshift)ØŒ Ù„Ø°Ø§ Ù†Ø¹ÙƒØ³Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ
        galleryImagesList.reverse();

        // 6. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© (Empty State)
        if (!hasMedia) showEmptyState('panel-media', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ', 'fa-photo-film');
        if (!hasFiles) showEmptyState('panel-files', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª', 'fa-folder-open');
        if (!hasAudio) showEmptyState('panel-audio', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØªÙŠØ§Øª', 'fa-microphone-lines');
        if (!hasLinks) showEmptyState('panel-links', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…Ø´ØªØ±ÙƒØ©', 'fa-link');

    } catch (e) { 
        console.error(e); 
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±Ø¶"); 
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ±Ø§Øº
function showEmptyState(panelId, text, iconClass) {
    document.getElementById(panelId).innerHTML = `
        <div class="empty-state">
            <i class="fa-solid ${iconClass} empty-icon"></i>
            <span>${text}</span>
        </div>`;
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (CSS Class Logic)
function switchTab(type) {
    // Ø¥Ø²Ø§Ù„Ø© Active Ù…Ù† Ø§Ù„ÙƒÙ„
    document.querySelectorAll('.mg-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.mg-panel').forEach(p => p.classList.remove('active'));

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡
    event.currentTarget.classList.add('active');

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    const panel = document.getElementById(`panel-${type}`);
    if(panel) {
        panel.classList.add('active');
        // ØªØ­ÙˆÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶ (Grid Ù„Ù„ÙˆØ³Ø§Ø¦Ø·ØŒ List Ù„Ù„Ø¨Ø§Ù‚ÙŠ)
        if(type === 'media') {
            panel.classList.remove('list-view');
            panel.classList.add('grid-view');
        } else {
            panel.classList.remove('grid-view');
            panel.classList.add('list-view');
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· (Ù„Ø£Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ù‚Ø¯ ÙŠØ®ØªÙ„Ù)
function openGalleryViewerBySrc(src) {
    const index = galleryImagesList.indexOf(src);
    if (index !== -1) {
        openGalleryViewer(index);
    }
}




// ================= 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§) =================
function openGalleryViewer(index) {
    currentImageIndex = index; // Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù„ÙŠ Ø¶ØºØ·Ù†Ø§ Ø¹Ù„ÙŠÙ‡Ø§
    updateLightboxContent();   // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ø±Ø¶
    document.getElementById('lightbox').style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø§Ø±Ø¶
}

// ================= 3. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¨ (Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚) =================
function changeGalleryImage(direction) {
    // direction: 1 Ù„Ù„ØªØ§Ù„ÙŠØŒ -1 Ù„Ù„Ø³Ø§Ø¨Ù‚
    let newIndex = currentImageIndex + direction;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ© (Ø¯ÙˆØ±Ø§Ù† Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ)
    if (newIndex >= galleryImagesList.length) {
        newIndex = 0; // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø¢Ø®Ø± Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø£ÙˆÙ„
    } else if (newIndex < 0) {
        newIndex = galleryImagesList.length - 1; // Ù„Ùˆ ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ±Ø¬Ø¹Ù†Ø§ ÙˆØ±Ø§ Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    }

    currentImageIndex = newIndex;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ø®ØªÙØ§Ø¡ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ù„ÙŠØ¨
    const imgElement = document.getElementById('lb-img');
    imgElement.style.opacity = '0.5';
    
    setTimeout(() => {
        updateLightboxContent();
        imgElement.style.opacity = '1';
    }, 150);
}

// ================= 4. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø§Ø±Ø¶ =================
function updateLightboxContent() {
    const imgElement = document.getElementById('lb-img');
    const counterElement = document.getElementById('lb-counter');
    
    // ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    imgElement.src = galleryImagesList[currentImageIndex];
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹: 5 / 20)
    if(counterElement) {
        counterElement.innerText = `${currentImageIndex + 1} / ${galleryImagesList.length}`;
    }
}

// ================= 5. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø±Ø¶ =================
function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§Øº
function showEmpty(id, text) {
    document.getElementById(id).innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;"><i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i><br>${text}</div>`;
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function switchTab(type) {
    // ØªØ¨Ø¯ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.mg-tab').forEach(t => t.classList.remove('active'));
    event.currentTarget.classList.add('active');

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    document.querySelectorAll('.mg-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(`panel-${type}`).classList.add('active');
}

// 3. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±Ø¶
function closeMediaGallery() {
    document.getElementById('mediaGalleryOverlay').style.display = 'none';
}

          // ==========================================
//      Ù†Ø¸Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© (JS)
// ==========================================

// Ù…ØªØºÙŠØ± Ù…Ø­Ù„ÙŠ Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø³Ø±Ø¹Ø©
let myPrivacySettings = {
    hideLastSeen: false,
    hideReadReceipts: false
};
async function openPrivacyPage() {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© (Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù„ÙŠ ÙØ§ØªØª)
    const page = document.getElementById('privacySettingsPage');
    if (page) {
        // Ù†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù€ body Ù„Ùˆ Ù„Ø³Ù‡ Ù…Ø´ Ù‡Ù†Ø§Ùƒ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„)
        if (page.parentNode !== document.body) document.body.appendChild(page);
        page.style.display = 'flex';
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    updatePrivacyTogglesUI();

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    if (currentUserId) {
        try {
            const doc = await db.collection('users').doc(currentUserId).get();
            if(doc.exists && doc.data().privacy) {
                myPrivacySettings = doc.data().privacy;
                updatePrivacyTogglesUI(); // ØªØ­Ø¯ÙŠØ« ØªØ§Ù†ÙŠ Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            }
        } catch(e) { console.log(e); }
    }
}


// 2. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function updatePrivacyTogglesUI() {
    setToggleState('hideLastSeen', myPrivacySettings.hideLastSeen);
    setToggleState('hideReadReceipts', myPrivacySettings.hideReadReceipts);
}

function setToggleState(id, isActive) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡
    const icon = document.getElementById(`toggle_${id}`);
    
    if (!icon) {
        console.error(`Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø§Ù„Ø§Ø³Ù… toggle_${id}`);
        return;
    }

    if(isActive) {
        icon.classList.remove('fa-toggle-off');
        icon.classList.add('fa-toggle-on');
        icon.style.color = "#00e5ff"; // Ù…ÙØ¹Ù„ (Ø³ÙŠØ§Ù†)
    } else {
        icon.classList.remove('fa-toggle-on');
        icon.classList.add('fa-toggle-off');
        icon.style.color = "#64748b"; // ØºÙŠØ± Ù…ÙØ¹Ù„ (Ø±Ù…Ø§Ø¯ÙŠ)
    }
}
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù„Ù…ÙŠ (Global) Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ HTML ÙŠØ´ÙˆÙÙ‡Ø§ 100%
window.togglePrivacyOption = function(optionKey) {
    console.log("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰:", optionKey); // Ù„Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø²Ø±Ø§Ø± Ø´ØºØ§Ù„

    // 1. ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±: Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø®Ù„ÙŠÙ‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…ÙŠØ¹Ø·Ù„Ø´
    if (typeof myPrivacySettings === 'undefined' || !myPrivacySettings) {
        myPrivacySettings = { hideLastSeen: false, hideReadReceipts: false };
    }

    // 2. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ùˆ true ØªØ¨Ù‚Ù‰ false ÙˆØ§Ù„Ø¹ÙƒØ³)
    myPrivacySettings[optionKey] = !myPrivacySettings[optionKey];

    // 3. ğŸ”¥ ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹ (Ø¹Ø´Ø§Ù† ØªØ­Ø³ Ø¨Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©) ğŸ”¥
    const icon = document.getElementById('toggle_' + optionKey);
    if (icon) {
        if (myPrivacySettings[optionKey]) {
            // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (ON)
            icon.classList.remove('fa-toggle-off');
            icon.classList.add('fa-toggle-on');
            icon.style.color = "#00e5ff"; // Ø§Ù„Ø³ÙŠØ§Ù† Ø§Ù„Ù…Ø¶ÙŠØ¡
            icon.style.textShadow = "0 0 10px rgba(0, 229, 255, 0.5)"; // Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‡Ø¬
        } else {
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (OFF)
            icon.classList.remove('fa-toggle-on');
            icon.classList.add('fa-toggle-off');
            icon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø·ÙÙŠ
            icon.style.textShadow = "none";
        }
    } else {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù€ ID:", 'toggle_' + optionKey);
    }

    // 4. ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(30);

    // 5. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† Ù…Ø§ Ù†Ø¹Ø·Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
    if (currentUserId) {
        db.collection('users').doc(currentUserId).set({
            privacy: myPrivacySettings
        }, { merge: true }).then(() => {
            console.log("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
        }).catch((e) => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", e);
        });
    }
};
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù„Ù…ÙŠ (Global) Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ HTML ÙŠØ´ÙˆÙÙ‡Ø§ 100%
window.togglePrivacyOption = function(optionKey) {
    console.log("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±:", optionKey); // Ù„Ù„ØªØ£ÙƒØ¯ ÙÙŠ Ø§Ù„Ù€ Console

    // 1. ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±: Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ù†Ø´Ø¦Ù‡
    if (typeof myPrivacySettings === 'undefined' || !myPrivacySettings) {
        myPrivacySettings = { hideLastSeen: false, hideReadReceipts: false };
    }

    // 2. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ùˆ true ØªØ¨Ù‚Ù‰ false ÙˆØ§Ù„Ø¹ÙƒØ³)
    myPrivacySettings[optionKey] = !myPrivacySettings[optionKey];

    // 3. ğŸ”¥ ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹ (Ø¹Ø´Ø§Ù† ØªØ­Ø³ Ø¨Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©) ğŸ”¥
    const icon = document.getElementById('toggle_' + optionKey);
    
    if (icon) {
        if (myPrivacySettings[optionKey]) {
            // Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (ON) - Ø§Ù„Ù…ÙØ±ÙˆØ¶ ÙŠÙ†ÙˆØ± Ø£Ø²Ø±Ù‚
            icon.classList.remove('fa-toggle-off');
            icon.classList.add('fa-toggle-on');
            icon.style.color = "#00e5ff"; // Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ù†
            icon.style.textShadow = "0 0 10px rgba(0, 229, 255, 0.5)"; // ØªÙˆÙ‡Ø¬
        } else {
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (OFF) - Ø§Ù„Ù…ÙØ±ÙˆØ¶ ÙŠØ¨Ù‚Ù‰ Ø±Ù…Ø§Ø¯ÙŠ
            icon.classList.remove('fa-toggle-on');
            icon.classList.add('fa-toggle-off');
            icon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ
            icon.style.textShadow = "none";
        }
    } else {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ±: toggle_" + optionKey);
    }

    // 4. Ø§Ù‡ØªØ²Ø§Ø² Ø®ÙÙŠÙ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù„Ù…Ø³)
    if(navigator.vibrate) navigator.vibrate(30);

    // 5. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase)
    if (typeof currentUserId !== 'undefined' && currentUserId) {
        db.collection('users').doc(currentUserId).set({
            privacy: myPrivacySettings
        }, { merge: true }).then(() => {
            console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:", optionKey);
        }).catch((e) => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", e);
        });
    }
};
// ================= Ù†Ø¸Ø§Ù… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸ (Persistent Mute) =================

// 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ (Ø¯Ù‡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ®Ù„ÙŠÙ‡Ø§ ØªØ«Ø¨Øª)
// Ø¨Ù†Ø³ØªØ®Ø¯Ù… chatId Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ ÙƒØ°Ø§ Ø´Ø§ØªØŒ ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ¨Ù‚Ù‰ Ù„Ù‡ Ù†Ø¸Ø§Ù…Ù‡

// 2. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¹Ø´Ø§Ù† ØªÙ†ÙˆØ± Ø§Ù„Ø²Ø±Ø§Ø± Ø§ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ù„Ùˆ ÙƒØ§Ù† Ù…Ø­ÙÙˆØ¸)
function updateMuteUI() {
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
    const toggleIcon = document.getElementById('muteIcon'); // Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„
    const textLabel = document.getElementById('muteText');  // Ø§Ù„Ù†Øµ
    const itemIcon = document.querySelector('.mute-icon');  // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø©

    // Ø¹Ù†ØµØ± Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø¬Ø±Ø³ Ø§Ù„ØµØºÙŠØ±)
    const headerIcon = document.getElementById('headerMuteIcon');

    if (isMuted) {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… (ON) ---
        
        // 1. ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„
        if(toggleIcon) {
            toggleIcon.classList.remove('fa-toggle-off');
            toggleIcon.classList.add('fa-toggle-on');
            toggleIcon.style.color = "#8b5cf6"; // Ø¨Ù†ÙØ³Ø¬ÙŠ
        }

        // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ
        if(textLabel) textLabel.innerText = "ØªÙ… ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        if(textLabel) textLabel.style.color = "#8b5cf6"; // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†Øµ Ù„Ù„ØªØ£ÙƒÙŠØ¯

        // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬Ø±Ø³ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙÙˆÙ‚ Ø¬Ù†Ø¨ Ø§Ù„Ø§Ø³Ù…)
        if(headerIcon) headerIcon.style.display = "inline-block"; 

    } else {
        // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (OFF) ---
        
        // 1. ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙˆØ¬Ù„
        if(toggleIcon) {
            toggleIcon.classList.remove('fa-toggle-on');
            toggleIcon.classList.add('fa-toggle-off');
            toggleIcon.style.color = "#64748b"; // Ø±Ù…Ø§Ø¯ÙŠ
        }

        // 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ
        if(textLabel) textLabel.innerText = "ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
        if(textLabel) textLabel.style.color = "#fff";

        // 3. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø±Ø³ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
        if(headerIcon) headerIcon.style.display = "none"; 
    }
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ· (Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©)
function toggleMuteNotifications() {
    isMuted = !isMuted; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    
    // ğŸ”¥ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø¯Ù‡ Ø£Ù‡Ù… Ø³Ø·Ø±) ğŸ”¥
    if(chatId) {
        localStorage.setItem('wareed_mute_' + chatId, isMuted);
    }
    
    // ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(30);

    // ØªÙˆØ³Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    if (isMuted) {
        showToast("ğŸ”• ØªÙ… ÙƒØªÙ… ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    } else {
        showToast("ğŸ”” ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ ÙÙˆØ±Ø§Ù‹
    updateMuteUI();
}

// 4. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener("DOMContentLoaded", () => {
    // Ø¨Ù†Ø³ØªÙ†Ù‰ Ù„Ø­Ø¸Ø© ØµØºÙŠØ±Ø© Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù† chatId ÙˆØµÙ„ ÙˆØ§Ù„Ù‡ÙŠØ¯Ø± Ø­Ù…Ù„
    setTimeout(() => {
        updateMuteUI();
    }, 100);
});

const messaging = firebase.messaging();

// Ø¯Ø§Ù„Ø© Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
// Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ø´ÙØ© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡)
async function requestPermission() {
    try {
        // 1. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            alert("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†! ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.");
            return;
        }

        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†
        alert("â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†... Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©");
        
        const token = await messaging.getToken({ 
    vapidKey: "BHEEGGgmiqTUiHeP1Qrkv_87xOalox0ioXw_l6qtJ_ebgOJJFXNst52U-Mvo7Mwv1h5bxqUEDXLCxvpr89HQ8yw" 
});
        if (token) {
            alert("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø§Ù„Ø¢Ù†.");
            saveTokenToFirestore(token);
        } else {
            alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙˆÙƒÙ†ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ù service worker.");
        }

    } catch (err) {
        // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ù Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message);
        console.error("Ø®Ø·Ø£ Ø§Ù„ØªÙˆÙƒÙ†:", err);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©)
function saveTokenToFirestore(token) {
    if (!currentUserId) {
        console.error("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ù„Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†");
        return;
    }

    // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ set Ø¨Ø¯Ù„ update Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙŠÙ†Ø´Ø¦Ù‡Ø§
    db.collection('users').doc(currentUserId).set({
        fcmToken: token
    }, { merge: true }) // merge: true Ø¹Ø´Ø§Ù† Ù…ÙŠØ­Ø°ÙØ´ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    .then(() => {
        console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        // alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…"); // Ø´ÙŠÙ„ Ø§Ù„Ø´Ø±Ø·ØªÙŠÙ† Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø±Ø³Ø§Ù„Ø© ØªØ¸Ù‡Ø±Ù„Ùƒ
    })
    .catch((error) => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†: ", error);
        alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ†: " + error.message);
    });
}


    </script>
    
    

    <div id="scrollToBottomBtn" onclick="scrollToBottom()" class="scroll-bottom-btn">
    <i class="fa-solid fa-arrow-down"></i>
</div>

<div id="deleteModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="confirm-title">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ</div>
        <div class="confirm-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ</div>
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel-del" onclick="closeDeleteModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm-del" onclick="performDelete()">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
        </div>
    </div>
</div>
<audio id="ringtoneIn" loop preload="none">
    <source src="./sounds/ring_in.wav" type="audio/wav">
</audio>

<audio id="ringtoneOut" loop preload="none">
    <source src="./sounds/ring_out.mp3" type="audio/mp3">
</audio>

<audio id="callEndSound" preload="none">
    <source src="./sounds/end_call.mp3" type="audio/mp3">
</audio>


<div id="profilePage" class="profile-page" style="display:none;">
    
    <div class="pp-header">
        <div class="icon-btn" onclick="closeProfile()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <div style="width: 40px;"></div> </div>

    <div class="pp-content">
        
        <div class="pp-user-info">
            <div class="pp-avatar-wrapper">
                <div id="profilePageImg" class="pp-avatar-lg"></div>
            </div>
            <div id="profilePageName" class="pp-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
            <div class="encryption-pill"><i class="fa-solid fa-lock"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø´ÙØ±Ø©</div>
        </div>

        <div class="profile-menu-list">
            
            <div class="profile-item" onclick="toggleGhostMode()">
                <div class="p-item-icon ghost-icon"><i class="fa-solid fa-ghost"></i></div>
                <div class="p-item-text">
                    <span>ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­</span>
                    <small>Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¤Ù‚ØªØ©</small>
                </div>
                <div class="p-item-arrow"><i class="fa-solid fa-toggle-off" id="ghostToggleIcon"></i></div>
            </div>

            <div class="profile-item" onclick="openMediaGallery()"> 
                <div class="p-item-icon media-icon"><i class="fa-regular fa-images"></i></div>
                <div class="p-item-text"><span>Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</span></div>
                <div class="p-item-arrow"><i class="fa-solid fa-chevron-left"></i></div>
            </div>

            <div class="profile-item" onclick="toggleSearchMode()">
                <div class="p-item-icon search-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div class="p-item-text"><span>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span></div>
            </div>

          <div class="profile-item" onclick="toggleMuteNotifications()">
    <div class="p-item-icon mute-icon"><i class="fa-regular fa-bell-slash"></i></div>
    <div class="p-item-text"><span id="muteText">ÙƒØªÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></div>
    <div class="p-item-arrow"><i id="muteIcon" class="fa-solid fa-toggle-off toggle-icon"></i></div>
</div>


            <div class="profile-item" onclick="openPrivacyPage()">
                <div class="p-item-icon privacy-icon"><i class="fa-solid fa-shield-halved"></i></div>
                <div class="p-item-text"><span>Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†</span></div>
                <div class="p-item-arrow"><i class="fa-solid fa-chevron-left"></i></div>
            </div>

            <div style="height: 20px;"></div>

            <div class="profile-item block-item" onclick="toggleBlockUser()">
                <div class="p-item-icon block-icon"><i class="fa-solid fa-ban"></i></div>
                <div class="p-item-text"><span style="color:#ff3b30;">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span></div>
            </div>

        </div>
    </div>
</div>

<div id="searchOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0b1121; z-index:9999; flex-direction:column;">
    
    <div style="display:flex; align-items:center; padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(15,25,38,0.95);">
        <i class="fa-solid fa-arrow-right" onclick="closeSearchMode()" style="color:#fff; font-size:20px; cursor:pointer; padding:10px;"></i>
        <div style="flex:1; margin-right:10px; background:rgba(255,255,255,0.05); border-radius:20px; padding:0 15px; display:flex; align-items:center;">
            <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;"></i>
            <input type="text" id="searchInputField" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©..." style="width:100%; background:transparent; border:none; color:#fff; padding:10px; font-size:15px; outline:none;" oninput="doSearch(this.value)">
        </div>
    </div>

    <div id="searchResults" style="flex:1; overflow-y:auto; padding:10px;">
        </div>
</div>

        
<div id="previewModal" class="preview-modal" style="display: none;">
    <div class="preview-content">
        <h3 style="color:#fff; margin-bottom:15px; text-align:center;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h3>
        <div id="previewContainer" style="max-height: 50vh; overflow: auto; border-radius: 10px; margin-bottom: 20px; display:flex; justify-content:center; align-items:center;">
        </div>
        <div class="preview-actions">
            <button onclick="cancelPreview()" class="btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="confirmUpload()" class="btn-send">
                <i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
            </button>
        </div>
    </div>
</div>

<<div id="mediaGalleryOverlay" class="media-gallery-overlay" style="display:none;">
    <div class="mg-header">
        <div class="mg-close-btn" onclick="closeMediaGallery()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3>Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</h3>
    </div>

    <div class="mg-tabs">
        <div class="mg-tab active" onclick="switchTab('media')">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</div>
        <div class="mg-tab" onclick="switchTab('files')">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</div>
        <div class="mg-tab" onclick="switchTab('audio')">Ø§Ù„ØµÙˆØªÙŠØ§Øª</div>
        <div class="mg-tab" onclick="switchTab('links')">Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</div>
    </div>

    <div class="mg-body">
        <div id="panel-media" class="mg-panel grid-view active"></div>

        <div id="panel-files" class="mg-panel list-view"></div>

        <div id="panel-audio" class="mg-panel list-view"></div>

        <div id="panel-links" class="mg-panel list-view"></div>
    </div>
</div>


<div id="scrollToBottomBtn" onclick="scrollToBottom()" class="scroll-bottom-btn">
    <i class="fa-solid fa-arrow-down"></i>
</div>

<div id="deleteModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="confirm-title">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ</div>
        <div class="confirm-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¯Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ</div>
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel-del" onclick="closeDeleteModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm-del" onclick="performDelete()">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
        </div>
    </div>
</div>


<audio id="ringtoneOut" loop preload="auto">
    <source src="./sounds/ring_out.mp3" type="audio/mp3">
</audio>

<audio id="ringtoneIn" loop>
    <source src="Https://firebasestorage.googleapis.com/v0/b/pools-e4381.firebasestorage.app/o/sounds%2Fmixkit-happy-bells-notification-937.wav?alt=media&token=3422aeb0-bf76-4670-83aa-5ba59fff7fe5" type="audio/wav">
</audio>


<audio id="callEndSound"><source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg"></audio>
<div id="customBlockModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="modal-icon-box">
            <i class="fa-solid fa-user-slash"></i>
        </div>
        <div class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¸Ø±ØŸ</div>
        <div class="confirm-desc">
            Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø§Ø³Ù… "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶".<br>
            Ù„Ù† ÙŠØ±Ù‰ ØµÙˆØ±ØªÙƒ Ø£Ùˆ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ.<br>
            Ù„Ù† ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø±Ø§Ø³Ù„ØªÙƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.
        </div>
        <div class="confirm-actions">
            <button class="btn-modal btn-cancel" onclick="closeBlockModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-modal btn-confirm" onclick="confirmBlockAction()">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>
    </div>
</div>
<div id="privacySettingsPage" class="profile-page" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index: 200000; background-color: #0b1121; flex-direction:column;">
    
    <div class="pp-header" style="background: rgba(15, 25, 38, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px; display: flex; align-items: center; padding: 0 15px;">
        <div class="icon-btn" onclick="document.getElementById('privacySettingsPage').style.display='none'; document.getElementById('profilePage').style.display='flex';" style="background:transparent; border:none; width:auto; cursor:pointer;">
            <i class="fa-solid fa-arrow-right" style="font-size: 20px; color: #fff;"></i>
        </div>
        <h3 style="margin:0; font-size:16px; color: #fff; flex:1; text-align:center; font-weight:bold;">
            Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
        </h3>
        <div style="width: 30px;"></div>
    </div>
    
    <div class="pp-content" style="padding: 20px; overflow-y:auto; flex:1;">
        
        <div style="color: #00e5ff; font-size: 12px; font-weight: bold; margin-bottom: 15px; margin-top: 10px;">Ø§Ù„Ø¸Ù‡ÙˆØ± ÙˆØ§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
        
        <div class="profile-item" onclick="window.togglePrivacyOption('hideLastSeen')" style="justify-content: space-between; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="p-item-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                    <i class="fa-regular fa-clock"></i>
                </div>
                <div class="p-item-text">
                    <span style="color:#fff; font-size:14px;">Ø¥Ø®ÙØ§Ø¡ "Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±"</span>
                    <small style="color:#64748b; font-size:11px;">Ù„Ù† ÙŠØ±Ù‰ Ø£Ø­Ø¯ Ù…ØªÙ‰ ÙƒÙ†Øª Ù†Ø´Ø·Ø§Ù‹</small>
                </div>
            </div>
            <i id="toggle_hideLastSeen" class="fa-solid fa-toggle-off" style="font-size: 22px; color: #64748b; transition:0.3s;"></i>
        </div>

        <div class="profile-item" onclick="window.togglePrivacyOption('hideReadReceipts')" style="justify-content: space-between;">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="p-item-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                    <i class="fa-solid fa-check-double"></i>
                </div>
                <div class="p-item-text">
                    <span style="color:#fff; font-size:14px;">Ø¥Ø®ÙØ§Ø¡ "ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"</span>
                    <small style="color:#64748b; font-size:11px;">Ù„Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</small>
                </div>
            </div>
            <i id="toggle_hideReadReceipts" class="fa-solid fa-toggle-off" style="font-size: 22px; color: #64748b; transition:0.3s;"></i>
        </div>

        <div style="width:100%; height:1px; background:rgba(255,255,255,0.05); margin: 20px 0;"></div>

        <div style="color: #00e5ff; font-size: 12px; font-weight: bold; margin-bottom: 15px;">Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ©</div>
        
        <div class="profile-item" onclick="window.location.href='blocked.html'">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="p-item-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                    <i class="fa-solid fa-ban"></i>
                </div>
                <div class="p-item-text">
                    <span style="color:#fff; font-size:14px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span>
                    <small style="color:#64748b; font-size:11px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡</small>
                </div>
            </div>
            <i class="fa-solid fa-chevron-left" style="font-size: 14px; color: #64748b;"></i>
        </div>

    </div>
</div>


</body>
</html>