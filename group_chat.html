<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wareed Group - Royal Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>

    <style>
        /* ================= Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ (Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§) ================= */
        :root {
            --bg-deep: #050505;
            --text-color: #ffffff;
            --text-secondary: #a0a0a0;
            --card-bg: rgba(30, 30, 35, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent-color: #8b5cf6; /* Ø¨Ù†ÙØ³Ø¬ÙŠ Ù…Ù„ÙƒÙŠ */
            --gold-color: #FFD700;   /* Ø°Ù‡Ø¨ÙŠ */
            --danger-color: #ef4444;
            --verify-color: #38bdf8;
            --glass-effect: blur(20px) saturate(180%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(90, 40, 250, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.05) 0%, transparent 40%);
            background-attachment: fixed;
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* ================= Ø§Ù„Ù‡ÙŠØ¯Ø± ================= */
        .chat-header {
            height: 65px; padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(20, 20, 25, 0.95); backdrop-filter: var(--glass-effect);
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .header-info { display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1; }
        .header-avatar {
            width: 42px; height: 42px; border-radius: 14px;
            background-size: cover; background-position: center;
            border: 1px solid var(--gold-color);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .header-text h3 { margin: 0; font-size: 16px; color: #fff; font-weight: 800; display: flex; align-items: center; gap: 5px; }
        .header-text span { font-size: 11px; color: var(--gold-color); font-weight: 600; }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .icon-btn { 
            font-size: 18px; color: #ccc; cursor: pointer; transition: 0.3s; 
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .icon-btn:active { background: rgba(255,255,255,0.1); color: var(--gold-color); }

        /* ================= Ø§Ù„Ø´Ø§Øª ================= */
        .chat-container {
            flex: 1; overflow-y: auto; padding: 20px 10px;
            display: flex; flex-direction: column; gap: 8px;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            background-blend-mode: overlay;
            padding-bottom: 100px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„ÙÙˆØªØ± */
        }
        
        .msg-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 5px; max-width: 85%; position: relative; transition: transform 0.2s; }
        .msg-row.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.other { align-self: flex-start; }

        .msg-avatar {
            width: 28px; height: 28px; border-radius: 10px;
            background-size: cover; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;
        }

        .msg-bubble {
            padding: 10px 14px; position: relative; font-size: 14px; 
            border-radius: 16px; line-height: 1.5; word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); min-width: 80px;
        }

        .msg-row.me .msg-bubble {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: #fff; border-radius: 16px 16px 4px 16px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .msg-row.other .msg-bubble {
            background: #1e1e24; color: #e0e0e0;
            border-radius: 16px 16px 16px 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .sender-name { font-size: 10px; color: var(--gold-color); font-weight: bold; margin-bottom: 4px; display: block; }
        .msg-time { font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }

        /* ================= Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ù…Ø¯Ù…Ø¬Ø© Ø¨Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ) ================= */
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯ */
        .reply-preview-bar {
            position: fixed; bottom: 70px; left: 0; right: 0;
            background: rgba(20, 20, 25, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--accent-color);
            padding: 10px; display: none; align-items: center; justify-content: space-between;
            z-index: 90; border-left: 4px solid var(--gold-color);
        }
        .reply-content { font-size: 12px; color: #ccc; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex: 1; margin-right: 10px; }
        .reply-title { color: var(--gold-color); font-weight: bold; font-size: 11px; margin-bottom: 2px; }

        /* Ø³ÙŠØ§Ù‚ Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .replied-msg-context {
            background: rgba(0,0,0,0.2); padding: 5px 8px; border-radius: 8px;
            margin-bottom: 5px; border-right: 3px solid var(--gold-color); font-size: 11px;
        }

        /* ÙƒØ§Ø±Øª Ø§Ù„ØªØµÙˆÙŠØª */
        .poll-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; min-width: 200px; }
        .poll-option {
            background: rgba(255,255,255,0.05); padding: 8px; margin-top: 5px;
            border-radius: 6px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between;
        }
        .poll-option:hover { background: rgba(255,255,255,0.1); border-color: var(--accent-color); }

        /* Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª */
        .custom-audio-player { display: flex; align-items: center; gap: 10px; min-width: 200px; }
        .play-btn { 
            width: 30px; height: 30px; border-radius: 50%; background: var(--gold-color); 
            color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; 
        }
        .audio-slider { flex: 1; accent-color: var(--gold-color); height: 3px; }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
        .location-card {
            background: #242f3e; border-radius: 10px; overflow: hidden; width: 220px;
            position: relative; border: 1px solid rgba(255,255,255,0.1);
        }
        .map-preview { height: 100px; background-size: cover; display: flex; align-items: center; justify-content: center; }
        .location-footer { padding: 8px; font-size: 11px; background: rgba(0,0,0,0.5); color: #fff; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        .recording-ui {
            position: absolute; inset: 0; background: #121212; z-index: 200;
            display: none; align-items: center; padding: 0 20px; justify-content: space-between;
        }
        .rec-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
        .wave-bar { width: 3px; background: var(--danger-color); height: 100%; animation: wave 0.5s infinite; }
        @keyframes wave { 0%,100%{height: 50%} 50%{height: 100%} }

        /* Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª */
        .msg-reaction {
            position: absolute; bottom: -10px; left: 10px;
            background: #1e1e24; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 2px 5px; font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* ================= Ø§Ù„ÙÙˆØªØ± ================= */
        .chat-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 10px 15px; background: #000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 10px; z-index: 100;
        }

        .footer-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--accent-color); background: rgba(139, 92, 246, 0.1);
            cursor: pointer; transition: 0.2s; font-size: 18px; flex-shrink: 0;
        }
        .input-box { flex: 1; position: relative; }
        .input-box input {
            width: 100%; padding: 12px 40px 12px 15px;
            border-radius: 25px; border: 1px solid #333;
            background: #1a1a1a; color: #fff; outline: none;
        }
        .send-btn {
            background: var(--accent-color); color: #fff; border: none;
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
        }

        /* ================= Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Modals) ================= */
        .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 500; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .bottom-sheet-overlay.active { opacity: 1; pointer-events: auto; }

        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #121212; border-radius: 25px 25px 0 0;
            padding: 20px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-top: 1px solid var(--gold-color); max-height: 70vh; overflow-y: auto;
        }
        .bottom-sheet-overlay.active .bottom-sheet { transform: translateY(0); }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .attachment-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .att-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #fff; cursor: pointer; }
        .att-icon {
            width: 50px; height: 50px; border-radius: 50%; display: grid; place-items: center; font-size: 20px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            position: fixed; top: 0; right: -280px; width: 260px; height: 100%;
            background: #0f0c15; z-index: 6000; transition: 0.4s;
            border-left: 1px solid rgba(255, 215, 0, 0.2); padding-top: 20px;
        }
        .sidebar.active { right: 0; box-shadow: -10px 0 50px rgba(0,0,0,0.8); }

        /* ØªÙˆØ³Øª */
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95); border: 1px solid var(--gold-color);
            color: #fff; padding: 10px 25px; border-radius: 30px;
            font-size: 14px; display: none; z-index: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ (Long Press) */
        .context-menu {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: #1a1a1a; border: 1px solid var(--gold-color); border-radius: 15px;
            padding: 15px; z-index: 6000; opacity: 0; pointer-events: none; transition: 0.2s;
            min-width: 250px;
        }
        .context-menu.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .ctx-item { padding: 10px; color: #fff; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .ctx-reactions { display: flex; justify-content: space-between; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 20px; }
        .ctx-emoji { font-size: 20px; cursor: pointer; transition: 0.2s; }
        .ctx-emoji:hover { transform: scale(1.2); }

/* ================= ØªØµÙ…ÙŠÙ… Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ================= */
.call-overlay {
    position: fixed; inset: 0; z-index: 9999;
    background: #0f0c15; display: flex; flex-direction: column;
    align-items: center; justify-content: space-between;
    padding: 40px 20px;
}

.call-bg {
    position: absolute; inset: 0; background: radial-gradient(circle, rgba(139,92,246,0.2) 0%, transparent 70%);
    z-index: -1; animation: pulseBg 4s infinite alternate;
}

/* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-container {
    position: absolute; inset: 0; z-index: 0; background: #000;
}
.remote-video { width: 100%; height: 100%; object-fit: cover; }
.local-video {
    position: absolute; bottom: 120px; right: 20px;
    width: 100px; height: 140px; background: #333;
    border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);
    object-fit: cover; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 10;
}

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙˆØª */
.call-info-section {
    flex: 1; display: flex; flex-direction: column; 
    align-items: center; justify-content: center; z-index: 1;
}
.call-avatar-wrapper { position: relative; margin-bottom: 20px; }
.call-avatar {
    width: 120px; height: 120px; border-radius: 50%;
    background-image: url('https://cdn-icons-png.flaticon.com/512/166/166258.png');
    background-size: cover; border: 3px solid var(--gold-color);
    box-shadow: 0 0 30px rgba(139, 92, 246, 0.4); z-index: 2; position: relative;
}
.pulse-ring {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 100%; height: 100%; border-radius: 50%;
    border: 2px solid var(--accent-color); animation: ripple 2s infinite; z-index: 1;
}

.call-name { font-size: 24px; color: #fff; margin-bottom: 5px; font-weight: bold; }
.call-status { color: #aaa; font-size: 14px; margin-bottom: 5px; }
.call-timer { color: #fff; font-family: monospace; font-size: 16px; background: rgba(255,255,255,0.1); padding: 2px 10px; border-radius: 10px; }

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… */
.call-controls-dock {
    display: flex; gap: 15px; padding: 15px 25px;
    background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
    border-radius: 40px; border: 1px solid rgba(255,255,255,0.1);
    z-index: 20; margin-bottom: 20px;
}

.call-btn {
    width: 50px; height: 50px; border-radius: 50%; border: none;
    background: rgba(255,255,255,0.1); color: #fff; font-size: 20px;
    cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center;
}
.call-btn:active { transform: scale(0.9); }
.call-btn.active { background: #fff; color: #000; }
.call-btn.end-call { background: var(--danger-color); width: 60px; border-radius: 20px; }

@keyframes ripple {
    0% { width: 100%; height: 100%; opacity: 1; }
    100% { width: 200%; height: 200%; opacity: 0; }
}
@keyframes pulseBg { 0% { opacity: 0.3; } 100% { opacity: 0.6; } }


@keyframes floatGift {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* ================= ØªØµÙ…ÙŠÙ… ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø³Ø­Ø±ÙŠ (Magic Gift Box) ================= */

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.magic-gift-container {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 10px auto;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: flex-end;
}

/* Ø§Ù„Ù‡Ø¯ÙŠØ© (Ø§Ù„Ø£ÙŠÙ…ÙˆØ¬ÙŠ) - ØªÙƒÙˆÙ† Ù…Ø®ÙÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
.gift-pop-content {
    position: absolute;
    bottom: 40px; /* Ù…ÙƒØ§Ù†Ù‡Ø§ Ø¬ÙˆÙ‡ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
    left: 50%;
    transform: translateX(-50%) scale(0.5);
    font-size: 50px;
    opacity: 0;
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 1; /* Ø®Ù„Ù Ø¬Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
}

/* Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯ÙŠØ© */
.gift-pop-name {
    position: absolute;
    bottom: -25px;
    width: 150%;
    left: -25%;
    text-align: center;
    font-size: 11px;
    color: var(--gold-color);
    font-weight: bold;
    opacity: 0;
    transition: 0.5s 0.3s; /* ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· */
}

/* Ø¬Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
.box-body {
    position: relative;
    width: 80px;
    height: 60px;
    background: linear-gradient(135deg, #ec4899, #be185d); /* ÙˆØ±Ø¯ÙŠ ØºØ§Ù…Ù‚ */
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 5; /* Ø£Ù…Ø§Ù… Ø§Ù„Ù‡Ø¯ÙŠØ© */
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø³Ù… */
.box-body::before {
    content: ''; position: absolute; left: 50%; transform: translateX(-50%);
    width: 15px; height: 100%; background: #FFD700;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
}

/* ØºØ·Ø§Ø¡ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
.box-lid {
    position: absolute;
    bottom: 55px; /* ÙÙˆÙ‚ Ø§Ù„Ø¬Ø³Ù… */
    left: 15px; /* ØªØ¸Ø¨ÙŠØ· Ø§Ù„Ù…Ù†ØªØµÙ */
    width: 90px;
    height: 25px;
    background: linear-gradient(135deg, #f472b6, #db2777); /* ÙˆØ±Ø¯ÙŠ ÙØ§ØªØ­ */
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 6; /* ÙÙˆÙ‚ ÙƒÙ„ Ø­Ø§Ø¬Ø© */
    transition: transform 0.4s ease-in;
    transform-origin: bottom left; /* Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† */
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØºØ·Ø§Ø¡ */
.box-lid::before {
    content: ''; position: absolute; left: 50%; transform: translateX(-50%);
    width: 15px; height: 100%; background: #FFD700;
}

/* Ø§Ù„ÙÙŠÙˆÙ†ÙƒØ© (Bow) */
.box-lid::after {
    content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
    width: 30px; height: 15px; border-radius: 50% 50% 0 0;
    border: 4px solid #FFD700; border-bottom: 0;
}

/* --- Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² (Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù‚ÙÙˆÙ„) --- */
.magic-gift-container:not(.opened) .box-body,
.magic-gift-container:not(.opened) .box-lid {
    animation: boxShake 3s infinite;
}

@keyframes boxShake {
    0%, 90% { transform: rotate(0); }
    91% { transform: rotate(-2deg); }
    92% { transform: rotate(2deg); }
    93% { transform: rotate(-2deg); }
    94% { transform: rotate(2deg); }
    95% { transform: rotate(0); }
}

/* --- Ø­Ø§Ù„Ø© Ø§Ù„ÙØªØ­ (Opened State) --- */
.magic-gift-container.opened .box-lid {
    transform: rotate(-120deg) translate(-20px, -30px); /* Ø§Ù„ØºØ·Ø§Ø¡ ÙŠØ·ÙŠØ± */
    opacity: 0; /* ÙŠØ®ØªÙÙŠ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ */
}

.magic-gift-container.opened .gift-pop-content {
    bottom: 70px; /* Ø§Ù„Ù‡Ø¯ÙŠØ© ØªØ·Ù„Ø¹ Ù„ÙÙˆÙ‚ */
    opacity: 1;
    transform: translateX(-50%) scale(1.2); /* ØªÙƒØ¨Ø± */
    z-index: 10; /* ØªØ·Ù„Ø¹ ÙÙˆÙ‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ */
    filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)); /* ØªÙˆÙ‡Ø¬ */
}

.magic-gift-container.opened .gift-pop-name {
    opacity: 1;
    bottom: -20px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ */
.gallery-item {
    position: relative;
    aspect-ratio: 1/1; /* Ù…Ø±Ø¨Ø¹ */
    overflow: hidden;
    cursor: pointer;
    background: #000;
    border-radius: 4px;
}

.gallery-item img, 
.gallery-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s;
}

.gallery-item:active img {
    transform: scale(1.1); /* Ø²ÙˆÙˆÙ… Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø© */
.vid-icon-overlay {
    position: absolute;
    top: 5px;
    right: 5px;
    color: #fff;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
}
/* ÙƒÙ„Ø§Ø³ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
.mic-active {
    color: #ff3b30 !important; /* Ø£Ø­Ù…Ø± */
    animation: pulseRed 1.5s infinite;
    background: rgba(255, 59, 48, 0.1) !important;
}

@keyframes pulseRed {
    0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
}

/* ================= ØªØµÙ…ÙŠÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ (Ghost Mode) ================= */

/* 1. Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø³Ù… */
body.ghost-active {
    filter: grayscale(100%) contrast(1.1) !important; /* ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø±Ù…Ø§Ø¯ÙŠ */
    background-color: #000000 !important; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ ÙƒØ­Ù„ */
}

/* 2. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ */
body.ghost-active .chat-header,
body.ghost-active .chat-footer,
body.ghost-active .msg-bubble {
    background: #000000 !important;
    border: 1px solid #333 !important;
    color: #fff !important;
    box-shadow: none !important;
}

/* 3. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø£ÙØ§ØªØ§Ø± Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© */
body.ghost-active .msg-user-avatar,
body.ghost-active .header-avatar {
    filter: brightness(0.5); /* ØªØºÙ…ÙŠÙ‚ Ø§Ù„ØµÙˆØ± */
}

/* 4. ØªØµÙ…ÙŠÙ… Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ù†Øµ Ø§Ù„Ø´Ø§Øª) */
.system-msg-row {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 15px 0;
    opacity: 0.8;
}

.system-msg-badge {
    background: rgba(255, 255, 255, 0.1);
    color: #aaa;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 11px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 5px;
}
:root {
    /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠ (Z-Index Hierarchy) --- */
    --z-background: 0;       /* Ø§Ù„Ø®Ù„ÙÙŠØ© */
    --z-content: 10;         /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ */
    --z-header: 100;         /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± (Ø«Ø§Ø¨ØªÙŠÙ†) */
    
    --z-overlay-back: 500;   /* Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø´ÙØ§ÙØ© Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… */
    --z-sidebar: 1000;       /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    
    --z-modal-base: 2000;    /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù…Ø¹Ø±Ø¶ØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø±ÙˆØ¨) */
    --z-modal-top: 3000;     /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„ÙØ±Ø¹ÙŠØ© (Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ØµØºØ±ØŒ Ø§Ù„ØªØ£ÙƒÙŠØ¯) */
    
    --z-call-screen: 4000;   /* Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Øª) */
    --z-toast: 5000;         /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    
    --z-pro-player: 9999;    /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ÙÙˆÙ‚ Ø§Ù„Ø¬Ù…ÙŠØ¹) */
}

/* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª */
.chat-header, .chat-footer { z-index: var(--z-header); }
.sidebar { z-index: var(--z-sidebar); }
.bottom-sheet-overlay { z-index: var(--z-overlay-back); }

/* Ù†ÙˆØ§ÙØ° ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ø´Ø§Ø´Ø© */
.profile-page, 
#groupInfoOverlay, 
#mediaGalleryOverlay, 
#fullSearchOverlay { 
    z-index: var(--z-modal-base) !important; 
    position: fixed !important; 
    top: 0; left: 0; right: 0; bottom: 0;
    background: #0f0c15; /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯ */
}

/* Ù†ÙˆØ§ÙØ° Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
#userPopupOverlay, #deleteModal, #contextMenuOverlay { 
    z-index: var(--z-modal-top) !important; 
}

/* Ø´Ø§Ø´Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
.call-overlay { z-index: var(--z-call-screen) !important; }

/* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
#toast { z-index: var(--z-toast) !important; }

/* Ø§Ù„Ù…Ø´ØºÙ„ */
#proViewer { z-index: var(--z-pro-player) !important; }
/* ================= ØªØµÙ…ÙŠÙ… Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ================= */
.royal-modal {
    position: fixed; inset: 0; background: #050505; z-index: 5000;
    display: none; flex-direction: column;
}

.royal-header {
    height: 70px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; background: rgba(20, 20, 20, 0.95);
    border-bottom: 1px solid rgba(255, 215, 0, 0.1);
    backdrop-filter: blur(10px);
}

.group-avatar-container {
    position: relative; width: 120px; height: 120px; margin: 30px auto 20px;
}

.group-avatar-lg {
    width: 100%; height: 100%; border-radius: 40px; /* Ø´ÙƒÙ„ Squircle Ø­Ø¯ÙŠØ« */
    background-size: cover; background-position: center; background-color: #1a1a1a;
    border: 2px solid var(--gold-color);
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
    display: grid; place-items: center; font-size: 40px; color: #555;
}

.cam-badge {
    position: absolute; bottom: -5px; right: -5px;
    width: 36px; height: 36px; background: var(--gold-color);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    border: 2px solid #000; transition: 0.2s; z-index: 10;
}
.cam-badge:active { transform: scale(0.9); }

.royal-input-group {
    width: 90%; margin: 0 auto 10px; position: relative;
}

.royal-input {
    width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
    padding: 12px; border-radius: 15px; color: #fff; text-align: center;
    font-size: 16px; transition: 0.3s;
}
.royal-input:focus { border-color: var(--gold-color); background: rgba(255,215,0,0.05); }

.section-title {
    padding: 15px 20px 5px; color: var(--gold-color); font-size: 13px; font-weight: bold;
    display: flex; justify-content: space-between; align-items: center;
}

/* ÙƒØ§Ø±Øª Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.member-card {
    display: flex; align-items: center; gap: 15px; padding: 12px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s;
}
.member-card:active { background: rgba(255,255,255,0.05); }

.member-img {
    width: 45px; height: 45px; border-radius: 14px; background: #333;
    background-size: cover; display: grid; place-items: center; color: #fff; font-weight: bold;
}

.add-member-btn {
    margin: 10px 20px; padding: 12px; background: rgba(139, 92, 246, 0.1);
    border: 1px dashed var(--accent-color); border-radius: 15px;
    color: var(--accent-color); text-align: center; font-weight: bold; cursor: pointer;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
.add-member-list {
    display: flex; flex-direction: column; gap: 10px; margin-top: 15px;
    max-height: 300px; overflow-y: auto; padding-right: 5px;
}

.add-member-card {
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
    padding: 10px; border-radius: 12px; transition: 0.2s;
}

.add-member-card:hover {
    background: rgba(255, 255, 255, 0.08); border-color: var(--accent-color);
}

.am-info { display: flex; align-items: center; gap: 10px; }
.am-img {
    width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center;
    background-color: #333; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #fff;
}

.am-btn {
    background: var(--gold-color); color: #000; border: none;
    padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold;
    cursor: pointer; display: flex; align-items: center; gap: 5px;
}
.am-btn:active { transform: scale(0.95); }

/* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
.list-section-title {
    color: var(--accent-color); font-size: 12px; font-weight: bold; 
    margin: 10px 0 5px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;
}
/* --- ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØµÙ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (ÙˆØ§ØªØ³Ø§Ø¨ Ø³ØªØ§ÙŠÙ„) --- */
.group-desc-box {
    background: rgba(255, 255, 255, 0.05);
    border-right: 3px solid var(--gold-color);
    padding: 15px;
    margin: 10px 20px;
    border-radius: 8px;
    color: #ccc;
    font-size: 13px;
    line-height: 1.6;
    text-align: right;
    position: relative;
}

.desc-label {
    font-size: 10px; 
    color: var(--accent-color); 
    font-weight: bold; 
    margin-bottom: 5px; 
    display: block;
}

/* --- Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„ (Ù„ØºÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†) --- */
.locked-input {
    pointer-events: none;
    border: none !important;
    background: transparent !important;
    text-align: right !important;
    padding: 0 !important;
}

/* --- Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡) --- */
.member-options-modal {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #1a1a1a; 
    border-radius: 20px 20px 0 0;
    padding: 20px;
    transform: translateY(100%);
    transition: 0.3s;
    z-index: 6000;
    border-top: 1px solid var(--gold-color);
}
.member-options-modal.active { transform: translateY(0); }

.admin-action-btn {
    width: 100%; padding: 15px; margin-bottom: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px; color: #fff; border: none;
    text-align: right; font-size: 14px; cursor: pointer;
    display: flex; align-items: center; gap: 10px;
}
.admin-action-btn:active { background: rgba(255,255,255,0.1); }
.text-danger { color: #ff4444; }

/* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¸Ù‡ÙˆØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
#memberOptionsModal {
    z-index: 5000 !important; /* ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ Ù…Ù† 5000 (Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª) */
}

.member-options-modal {
    z-index: 60001 !important; /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù†ÙØ³Ù‡ ÙŠÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ */
}
/* ================= ØªØµÙ…ÙŠÙ… Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================= */
.pro-video-modal {
    position: fixed !important;
    inset: 0 !important;
    background: #000 !important;
    z-index: 9999999 !important; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙƒØ¨ */
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.pro-video-element {
    width: 100%;
    max-height: 75vh; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ */
    object-fit: contain;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠ */
.pro-controls {
    position: absolute; 
    bottom: 40px; 
    width: 90%; max-width: 600px;
    background: rgba(25, 25, 25, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 15px 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; flex-direction: column; gap: 10px;
    direction: ltr; /* Ø¹Ø´Ø§Ù† Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¨Ø§Ø± ÙŠØ¸Ù‡Ø±ÙˆØ§ ØµØ­ */
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
.pro-progress-area {
    width: 100%; height: 20px;
    display: flex; align-items: center;
    cursor: pointer; position: relative;
}
.pro-progress-bg {
    width: 100%; height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px; position: relative;
}
.pro-progress-fill {
    height: 100%; width: 0%;
    background: var(--accent-color); /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ù† Ø¨ØªØ§Ø¹Ùƒ */
    border-radius: 10px;
    position: absolute; top: 0; left: 0;
    box-shadow: 0 0 10px var(--accent-color);
}
.pro-progress-knob {
    position: absolute; top: 50%; left: 0%;
    width: 14px; height: 14px;
    background: #fff; border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    pointer-events: none;
}

/* Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
.pro-time-centered {
    width: 100%; text-align: center;
    font-family: monospace; font-size: 13px; font-weight: bold;
    color: #e2e8f0;
}
.pro-buttons-row {
    display: flex; justify-content: space-between; align-items: center; width: 100%;
}
.btn-group { display: flex; gap: 15px; }

.pro-btn {
    width: 40px; height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff; border: 1px solid rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer; transition: 0.2s;
}
.pro-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

.play-btn-large {
    width: 55px; height: 55px;
    border-radius: 50%;
    background: var(--accent-color);
    color: #000; font-size: 22px;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
    border: none; margin-top: -10px;
}

/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ø´ÙØ§Ù (Ø¨Ø¯ÙˆÙ† ÙÙ‚Ø§Ø¹Ø©) ================= */

/* 1. Ø¥Ø®ÙØ§Ø¡ Ø¬Ø³Ù… Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
.msg-bubble.media-bubble {
    background: transparent !important; /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
    border: none !important;            /* Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯ Ø®Ø§Ø±Ø¬ÙŠØ© */
    box-shadow: none !important;        /* Ø¨Ø¯ÙˆÙ† Ø¸Ù„ Ù„Ù„ÙÙ‚Ø§Ø¹Ø© */
    padding: 0 !important;              /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
    width: fit-content !important;
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„ØªÙƒÙˆÙ† Ù‡ÙŠ Ø§Ù„Ø´ÙƒÙ„ */
.msg-bubble.media-bubble .media-container,
.msg-bubble.media-bubble .video-wrapper {
    border-radius: 18px !important;     /* ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø­ÙˆØ§Ù */
    border: 1px solid rgba(255, 255, 255, 0.15) !important; /* Ø¨Ø±ÙˆØ§Ø² Ø±ÙÙŠØ¹ Ø¬Ø¯Ø§Ù‹ */
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* Ø¸Ù„ Ù„Ù„ØµÙˆØ±Ø© Ù†ÙØ³Ù‡Ø§ */
    margin-bottom: 2px;
}

/* 3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ ØªÙ…Ù„Ø£ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.msg-bubble.media-bubble img,
.msg-bubble.media-bubble video {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù„ÙŠØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„ ÙÙˆÙ‚/ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */
.msg-bubble.media-bubble .msg-time {
    color: rgba(255, 255, 255, 0.8) !important;
    font-size: 10px !important;
    margin-top: 2px !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* Ø¸Ù„ Ù„Ù„Ù†Øµ Ø¹Ø´Ø§Ù† ÙŠØ¨Ø§Ù† */
    padding-right: 5px; /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© */
}
/* ================= ØªØµÙ…ÙŠÙ… Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ================= */

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
.gift-tabs-container {
    display: flex;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    padding: 5px;
    border-radius: 15px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.gift-tab {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-radius: 12px;
    color: #888;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.gift-tab.active {
    background: var(--gold-color);
    color: #000;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
.gift-content-area {
    height: 350px;
    overflow-y: auto;
    padding: 5px;
}

/* 1. Ø´Ø¨ÙƒØ© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Gifts) */
.premium-gift-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.premium-gift-card {
    background: linear-gradient(145deg, rgba(30,30,35,0.8), rgba(20,20,25,0.9));
    border: 1px solid rgba(255, 215, 0, 0.1);
    border-radius: 15px;
    padding: 15px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
    position: relative;
    overflow: hidden;
}

.premium-gift-card:hover {
    transform: translateY(-3px);
    border-color: var(--gold-color);
    background: rgba(255, 215, 0, 0.05);
}

.pg-emoji { font-size: 40px; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
.pg-name { font-size: 11px; color: #fff; margin-bottom: 3px; font-weight: bold; }
.pg-price { 
    font-size: 10px; color: var(--gold-color); 
    background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px;
}

/* 2. Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª (Stickers) */
.sticker-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
}
.sticker-item {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 35px;
    cursor: pointer;
    transition: transform 0.2s;
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
}
.sticker-item:active { transform: scale(0.8); }

/* 3. Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (GIFs) */
.gif-search-box {
    width: 100%;
    padding: 12px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    color: #fff;
    margin-bottom: 15px;
    font-family: 'Cairo', sans-serif;
}

.gif-grid {
    column-count: 2; /* Ù†Ø¸Ø§Ù… Masonry Ø¹Ù…ÙˆØ¯ÙŠÙ† */
    column-gap: 10px;
}
.gif-item {
    width: 100%;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    display: block;
    transition: opacity 0.2s;
}
.gif-item:hover { opacity: 0.8; }

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„ÙˆØ¯Ø± */
.loader-spinner {
    text-align: center;
    padding: 50px;
    color: var(--gold-color);
    font-size: 20px;
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø¨ÙƒØ© Ø§Ù„Ù€ GIF Ù„ØªØ¸Ù‡Ø± Ù…Ø«Ù„ Pinterest */
.gif-grid {
    column-count: 2; /* Ø¹Ù…ÙˆØ¯ÙŠÙ† */
    column-gap: 10px;
    padding-bottom: 20px;
}

.gif-item {
    width: 100%;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    display: block;
    background: #222; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø­ØªÙ‰ ØªØ¸Ù‡Ø± Ø§Ù„ØµÙˆØ±Ø© */
    min-height: 100px;
    object-fit: cover;
    transition: transform 0.2s, opacity 0.2s;
    border: 1px solid rgba(255,255,255,0.1);
}

.gif-item:hover {
    transform: scale(1.02);
    opacity: 0.9;
    border-color: var(--gold-color);
}

/* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ) ================= */
.chat-footer {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: #000; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
    border-top: 1px solid rgba(255, 215, 0, 0.1);
    z-index: 100;
    padding: 0; /* Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ padding Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
    transition: all 0.3s ease;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© */
.footer-content {
    display: flex; 
    align-items: flex-end; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙ…Ø¯Ø¯ */
    gap: 8px; 
    padding: 10px 15px;
    width: 100%;
    min-height: 65px;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (ÙŠØ³Ø§Ø±) */
.footer-actions {
    display: flex; 
    gap: 8px; 
    padding-bottom: 5px; /* Ø±ÙØ¹ Ø¨Ø³ÙŠØ· */
    transition: 0.3s;
}

/* Ø§Ø®ØªÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù‡Ù†Ø§ ØªØ±ÙƒØªÙ‡Ø§ Ø¸Ø§Ù‡Ø±Ø© Ù„Ø¬Ù…Ø§Ù„ Ø§Ù„Ø´ÙƒÙ„) */
.footer-content.typing .footer-actions {
    /* display: none; */ /* ÙØ¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ®ÙÙŠÙ‡Ù… Ù„Ù…Ø§ ÙŠÙƒØªØ¨ */
}

.footer-btn {
    width: 38px; height: 38px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #ccc; background: rgba(255, 255, 255, 0.05);
    cursor: pointer; transition: 0.2s; font-size: 18px; flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.05);
}
.footer-btn:active { transform: scale(0.9); border-color: var(--gold-color); color: var(--gold-color); }

/* Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ */
.smart-input-wrapper {
    flex: 1;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 20px;
    padding: 0;
    display: flex; align-items: center;
    transition: 0.3s;
    min-height: 45px;
}

.smart-input-wrapper:focus-within {
    border-color: var(--accent-color);
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.1);
}

.smart-textarea {
    width: 100%;
    max-height: 120px; /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ */
    background: transparent;
    border: none;
    color: #fff;
    padding: 12px 15px;
    font-size: 15px;
    resize: none;
    outline: none;
    height: 45px; /* Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ */
    line-height: 1.4;
    font-family: 'Cairo', sans-serif;
    scrollbar-width: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
}
.smart-textarea::-webkit-scrollbar { display: none; }

/* Ø§Ù„Ø²Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Ù…Ø§ÙŠÙƒ / Ø¥Ø±Ø³Ø§Ù„) */
.action-submit-btn {
    width: 45px; height: 45px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    flex-shrink: 0; margin-bottom: 2px;
    font-size: 18px;
    color: #fff;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§ÙŠÙƒ (Ø±Ù…Ø§Ø¯ÙŠ/Ø´ÙØ§Ù) */
.action-submit-btn.mic-mode {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø£Ø²Ø±Ù‚/Ø°Ù‡Ø¨ÙŠ) */
.action-submit-btn.send-mode {
    background: var(--accent-color); /* Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ */
    box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
    transform: scale(1.05);
}

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (ØªØ¹Ø¯ÙŠÙ„ Ù„ØªÙ…Ù„Ø£ Ø§Ù„ÙÙˆØªØ±) */
.recording-ui {
    width: 100%; height: 65px;
    background: #121212; 
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center; 
    padding: 0 20px; 
    justify-content: space-between;
    border-top: 2px solid var(--danger-color);
}

 /* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø°ÙƒÙŠ (Smart Expand System) ================= */
.chat-footer {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: #000;
    border-top: 1px solid rgba(255, 215, 0, 0.1);
    z-index: 100;
    transition: all 0.3s ease;
}

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø±Ù†Ø© */
.footer-content {
    display: flex; 
    align-items: flex-end; 
    gap: 8px; 
    padding: 10px 15px;
    width: 100%;
    min-height: 65px;
    transition: all 0.3s ease; /* Ù†Ø¹ÙˆÙ…Ø© Ø§Ù„Ø­Ø±ÙƒØ© */
}

/* 1. ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ) */
.footer-actions {
    display: flex; 
    gap: 8px; 
    padding-bottom: 5px;
    
    /* Ø®ÙˆØ§Øµ Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ù„Ø¸Ù‡ÙˆØ± */
    max-width: 150px; /* Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ */
    opacity: 1;
    transform: translateX(0);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Ø­Ø±ÙƒØ© Ù…Ø·Ø§Ø·ÙŠØ© Ù†Ø§Ø¹Ù…Ø© */
    overflow: hidden; /* Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ØªØµØºØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ®ØªÙÙŠ */
}

/* 2. ğŸ”¥ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ù„Ù…Ø§ ØªÙƒØªØ¨ (Typing Mode) ğŸ”¥ */
.footer-content.typing .footer-actions {
    max-width: 0px;       /* Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ¨Ù‚Ù‰ ØµÙØ± */
    opacity: 0;           /* ÙŠØ®ØªÙÙŠ */
    padding: 0;           /* ÙŠÙ„ØºÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª */
    margin: 0;            /* ÙŠÙ„ØºÙŠ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ */
    transform: translateX(20px); /* Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ÙŠÙ…ÙŠÙ† ÙˆÙ‡Ùˆ Ø¨ÙŠØ®ØªÙÙŠ */
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø¨Ø¹ (ÙŠØªÙ…Ø¯Ø¯ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ) */
.smart-input-wrapper {
    flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 20px;
    display: flex; align-items: center;
    transition: all 0.3s ease; /* Ù†Ø¹ÙˆÙ…Ø© Ø§Ù„ØªÙ…Ø¯Ø¯ */
    min-height: 45px;
}

/* Ø´ÙƒÙ„ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
.smart-textarea {
    width: 100%;
    max-height: 120px;
    background: transparent;
    border: none;
    color: #fff;
    padding: 12px 15px;
    font-size: 15px;
    resize: none;
    outline: none;
    height: 45px;
    line-height: 1.4;
    font-family: 'Cairo', sans-serif;
}

/* Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙƒØ´Ù† */
.action-submit-btn {
    width: 45px; height: 45px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.3s; flex-shrink: 0;
    margin-bottom: 2px; font-size: 18px; color: #fff;
}

.action-submit-btn.mic-mode { background: rgba(255, 255, 255, 0.1); }
.action-submit-btn.send-mode { background: var(--accent-color); transform: scale(1.1); box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
.recording-ui {
    width: 100%; height: 65px; background: #121212; 
    display: none; align-items: center; padding: 0 20px; 
    justify-content: space-between; border-top: 2px solid var(--danger-color);
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ - Ø¶ÙŠÙ Ø¯Ù‡ Ø¶Ø±ÙˆØ±ÙŠ */
.emoji-keyboard-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    padding: 15px 5px;
    max-height: 300px;
    overflow-y: auto;
}

.emoji-key {
    font-size: 26px;
    text-align: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%; /* Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±ÙŠ */
    transition: all 0.2s;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-key:active {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(0.8);
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„ØªØ³Ù…Ø­ Ø¨ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø²Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù†Øµ */
.smart-input-wrapper {
    flex: 1;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 20px;
    display: flex; 
    align-items: center; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© */
    transition: all 0.3s ease;
    min-height: 45px;
    padding-left: 5px; /* Ù…Ø³Ø§ÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø± */
    overflow: hidden;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ Ù„ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
.smart-textarea {
    flex: 1; /* ÙŠØ£Ø®Ø° ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
    max-height: 120px;
    background: transparent;
    border: none;
    color: #fff;
    padding: 12px 10px 12px 15px; /* ØªØ¸Ø¨ÙŠØ· Ø§Ù„Ø­ÙˆØ§Ù */
    font-size: 15px;
    resize: none;
    outline: none;
    height: 45px;
    line-height: 1.4;
    font-family: 'Cairo', sans-serif;
}

/* ğŸ”¥ ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ğŸ”¥ */
.input-emoji-btn {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #888; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù‡Ø§Ø¯ÙŠ */
    cursor: pointer;
    font-size: 20px;
    transition: 0.2s;
    border-radius: 50%;
    margin-left: 5px; /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ */
}

.input-emoji-btn:hover {
    color: var(--gold-color); /* ÙŠÙ‚Ù„Ø¨ Ø°Ù‡Ø¨ÙŠ Ù„Ù…Ø§ ØªÙ‚Ù Ø¹Ù„ÙŠÙ‡ */
    background: rgba(255, 255, 255, 0.05);
}

.input-emoji-btn:active {
    transform: scale(0.9);
}


.pinned-icon {
    width: 30px;
    height: 30px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gold-color);
    font-size: 14px;
}

.pinned-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex: 1;
}

.pinned-label {
    font-size: 10px;
    color: var(--accent-color); /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ */
    font-weight: bold;
    margin-bottom: 2px;
}

.pinned-text {
    font-size: 12px;
    color: #e0e0e0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* ÙŠØ¸Ù‡Ø± Ù†Ù‚Ø· ... Ù„Ùˆ Ø§Ù„ÙƒÙ„Ø§Ù… ÙƒØªÙŠØ± */
}

/* ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³Ø§ÙØ© Ø§Ù„Ø´Ø§Øª Ø¹Ø´Ø§Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…ØªØ³ØªØ®Ø¨Ø§Ø´ ØªØ­Øª Ø§Ù„Ø´Ø±ÙŠØ· */
.chat-container.has-pinned-desc {
    padding-top: 60px !important; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù…Ø§ Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØ¸Ù‡Ø± */
}

/* ØªØ«Ø¨ÙŠØª Ø§Ù„ØµÙØ­Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden !important; /* Ø¯Ù‡ Ø£Ù‡Ù… Ø³Ø·Ø±: Ø¨ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø­Ø±ÙƒØ© ÙŠÙ…ÙŠÙ† ÙˆØ´Ù…Ø§Ù„ */
    position: fixed; /* Ø¨ÙŠØ«Ø¨Øª Ø¬Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ø¹Ø´Ø§Ù† Ù…ÙŠØ±Ù‚ØµØ´ ÙÙŠ Ø§Ù„Ø§ÙŠÙÙˆÙ† ÙˆØ§Ù„Ø§Ù†Ø¯Ø±ÙˆÙŠØ¯ */
    overflow-y: hidden; /* Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù‡ÙŠÙƒÙˆÙ† Ø¬ÙˆÙ‡ Ø§Ù„Ø´Ø§Øª Ø¨Ø³ Ù…Ø´ Ø§Ù„ØµÙØ­Ø© ÙƒÙ„Ù‡Ø§ */
    overscroll-behavior-y: none; /* Ø¨ÙŠÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Øª (Refresh gesture) */
}

/* Ø¶Ø¨Ø· Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø´Ø§Øª */
.chat-container {
    width: 100%;
    max-width: 100vw; /* ÙŠØ¶Ù…Ù† Ø¥Ù† Ø§Ù„Ø¹Ø±Ø¶ Ù…ÙŠØ²ÙŠØ¯Ø´ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    overflow-x: hidden !important; /* ØªØ£ÙƒÙŠØ¯ Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
    overflow-y: auto; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ø±Ø£Ø³ÙŠ ÙÙ‚Ø· Ù„Ù„Ø±Ø³Ø§ÙŠÙ„ */
    -webkit-overflow-scrolling: touch; /* Ù†Ø¹ÙˆÙ…Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙÙŠ Ø§Ù„Ø§ÙŠÙÙˆÙ† */
}

/* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø± Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ù…Ø³Ø§ÙØ© ÙˆÙ‡Ù…ÙŠØ© */
.sidebar {
    /* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¯ÙŠ Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù…Ø¨ÙŠØ²Ù‚Ø´ Ø§Ù„ØµÙØ­Ø© */
    position: fixed;
    right: -280px; /* Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ */
    /* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªØ§Ø¹Ùƒ ... */
}

.skeleton {
    background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø´Ø¹Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
.star-badge {
    position: absolute;
    bottom: -8px;       /* ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† top */
    left: -8px;         /* Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
    top: auto;          /* Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ */
    
    color: #00e5ff;     /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ Ù…Ø´Ø¹ (Cyan) */
    font-size: 20px;    /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙˆÙ‡Ø¬ Ø§Ù„Ø£Ø²Ø±Ù‚ */
    filter: drop-shadow(0 0 8px rgba(0, 229, 255, 0.9)); 
    
    z-index: 10;
    animation: popStar 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ø¬Ù…Ø© ØªØ¸Ù‡Ø± Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© */
.msg-bubble {
    overflow: visible !important;
    position: relative; /* Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø¬Ù…Ø© ØªØ«Ø¨Øª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙÙ‚Ø§Ø¹Ø© */
}

/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ - Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± */
.star-badge {
    position: absolute;
    
    /* Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ¬Ø¨Ø© Ø¯ÙŠ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªØ®Ù„ÙŠÙ‡Ø§ Ø¬ÙˆÙ‡ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
    bottom: 5px;      /* Ù…Ø³Ø§ÙØ© Ù…Ù† ØªØ­Øª */
    left: 8px;        /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ */
    
    top: auto;        /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    right: auto;      /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙŠÙ…ÙŠÙ† */
    
    color: #00e5ff;     /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ù…Ø´Ø¹ */
    font-size: 14px;    /* Ø­Ø¬Ù… Ù…ØªÙˆØ³Ø· Ø¹Ø´Ø§Ù† Ù…ÙŠØºØ·ÙŠØ´ Ø§Ù„ÙƒÙ„Ø§Ù… */
    
    /* Ø§Ù„ØªÙˆÙ‡Ø¬ Ø§Ù„Ø£Ø²Ø±Ù‚ */
    filter: drop-shadow(0 0 5px rgba(0, 229, 255, 0.8)); 
    
    z-index: 10;
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ù…ØªØ¶Ø§ÙŠÙ‚Ø´ Ù„Ùˆ Ø­Ø¯ Ø¯Ø§Ø³ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„ØºÙ„Ø· */
    animation: popStar 0.3s ease;
}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¹Ø´Ø§Ù† ØªØ³ØªÙˆØ¹Ø¨ Ø§Ù„Ù†Ø¬Ù…Ø© */
.msg-bubble {
    position: relative; /* Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø¬Ù…Ø© ØªØªØ­Ø±Ùƒ Ø¬ÙˆØ§Ù‡Ø§ */
    
    /* (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…Ù…ÙƒÙ† ØªØ²ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© Ù…Ù† ØªØ­Øª Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø¬Ù…Ø© Ù…ØªØ¬ÙŠØ´ ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„Ø§Ù… */
    /* padding-bottom: 20px; */ 
}

/* ================= ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø²ÙŠ Ø§Ù„Ø§Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª) ================= */
.profile-actions-row {
    display: flex;
    justify-content: center;
    gap: 15px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    margin: 20px 0;
    padding: 0 15px;
}

.profile-action-btn {
    background: rgba(30, 30, 35, 0.6); /* Ø®Ù„ÙÙŠØ© ØºØ§Ù…Ù‚Ø© Ø´ÙØ§ÙØ© */
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 18px; /* Ø­ÙˆØ§Ù Ù†Ø§Ø¹Ù…Ø© */
    width: 75px; 
    height: 75px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.profile-action-btn:active {
    transform: scale(0.95);
    background: rgba(255, 215, 0, 0.1); /* Ù„Ù…Ø¹Ø© Ø°Ù‡Ø¨ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
    border-color: var(--gold-color);
}

.profile-action-btn i {
    font-size: 22px;
    margin-bottom: 8px;
    color: var(--accent-color); /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ */
}

/* ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
.btn-call i { color: #4ade80; }  /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø© */
.btn-video i { color: #38bdf8; } /* Ø£Ø²Ø±Ù‚ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ */
.btn-add i { color: #fff; }      /* Ø£Ø¨ÙŠØ¶ Ù„Ù„Ø¥Ø¶Ø§ÙØ© */
.btn-search i { color: var(--gold-color); } /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø¨Ø­Ø« */

.profile-action-btn span {
    font-size: 11px;
    color: #ccc;
    font-weight: bold;
}

body {
    height: 100vh; /* Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
    height: 100dvh; /* Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© - Ø³ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    /* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ... */
}

/* ÙÙŠ Ø§Ù„Ù€ CSS */
.skeleton-loader {
    width: 100%;
    height: 60px;
    background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 12px;
    margin-bottom: 10px;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

   @keyframes messagePop {
    0% { opacity: 0; transform: translateY(20px) scale(0.9); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.msg-row {
    animation: messagePop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Ø­Ø±ÙƒØ© Ù…Ø·Ø§Ø·ÙŠØ© Ø¬Ù…ÙŠÙ„Ø© */
}

.reaction-badge {
    position: absolute; 
    bottom: -12px; 
    left: 10px;
    background: #1e1e24; 
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; 
    padding: 2px 8px; 
    font-size: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex; 
    align-items: center; 
    gap: 3px;
    z-index: 5;
    transition: 0.2s;
}
.reaction-badge:active { transform: scale(0.9); background: #333; }

   /* ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ */
.reactor-row {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: background 0.2s;
    cursor: pointer;
}

.reactor-row:active {
    background: rgba(255, 255, 255, 0.05);
}

.reactor-avatar-wrapper {
    position: relative;
    margin-left: 12px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù… */
}

.reactor-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 2px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.reactor-emoji-badge {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 22px;
    height: 22px;
    background: #1e1e24; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¹Ø´Ø§Ù† ÙŠÙØµÙ„ Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø© */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
}

.reactor-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.reactor-name-row {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 4px;
}

.reactor-name {
    color: #fff;
    font-weight: 700;
    font-size: 14px;
}

.verify-icon {
    color: #38bdf8; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ Ù„Ù„ØªÙˆØ«ÙŠÙ‚ */
    font-size: 13px;
}

.reactor-stats {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 11px;
    color: #a0a0a0;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
    background: rgba(255,255,255,0.05);
    padding: 2px 8px;
    border-radius: 10px;
}

.stat-icon {
    color: var(--gold-color);
    font-size: 10px;
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… */
.quick-reaction-popup {
    position: fixed;
    z-index: 9000;
    background: rgba(20, 20, 25, 0.95); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
    backdrop-filter: blur(15px);
    border-radius: 50px; /* Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    padding: 8px 15px;
    border: 1px solid rgba(255, 215, 0, 0.2); /* Ø¨Ø±ÙˆØ§Ø² Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ */
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    animation: popUpSpring 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: none;
    transform-origin: center bottom;
}

.reaction-items {
    display: flex;
    align-items: center;
    gap: 12px;
}

.q-emoji {
    font-size: 28px; /* Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­ */
    cursor: pointer;
    transition: transform 0.2s, filter 0.2s;
    user-select: none;
}

.q-emoji:hover {
    transform: scale(1.3) translateY(-5px);
    filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
}

.q-emoji:active { transform: scale(0.9); }

/* Ø²Ø± Ø§Ù„Ø²Ø§Ø¦Ø¯ (+) */
.add-more-btn {
    width: 35px;
    height: 35px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gold-color);
    font-size: 16px;
    cursor: pointer;
    transition: 0.2s;
    border: 1px solid rgba(255,255,255,0.05);
}
.add-more-btn:active { background: rgba(255,255,255,0.2); }

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± */
@keyframes popUpSpring {
    0% { opacity: 0; transform: scale(0.5) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
.emoji-full-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr); /* 7 ÙÙŠ Ø§Ù„ØµÙ */
    gap: 10px;
    max-height: 350px;
    overflow-y: auto;
    padding: 10px;
}

.full-emoji-item {
    font-size: 30px;
    text-align: center;
    padding: 5px;
    border-radius: 8px;
    cursor: pointer;
}
.full-emoji-item:active { background: rgba(255,255,255,0.1); transform: scale(0.9); }


.quick-reaction-popup {
    position: fixed; /* ØªØ«Ø¨ÙŠØª Ù…ÙƒØ§Ù†Ù‡ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø© */
    z-index: 999999 !important; /* Ø±Ù‚Ù… Ø¹Ø§Ù„ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„ÙŠØ¸Ù‡Ø± ÙÙˆÙ‚ Ø£ÙŠ Ø´ÙŠØ¡ */
    background: rgba(30, 30, 35, 0.95);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 50px;
    padding: 8px 12px;
    border: 1px solid rgba(255, 215, 0, 0.4); /* ØªÙØªÙŠØ­ Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    transform-origin: center bottom;
    animation: popUpSpring 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap;
    pointer-events: auto; /* Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù†Ù‚Ø±Ø§Øª */
}

/* ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
.q-emoji {
    font-size: 28px;
    margin: 0 5px;
    padding: 5px;
    cursor: pointer;
    display: inline-block;
    transition: transform 0.2s;
}
.q-emoji:active { transform: scale(1.4); }


/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
.msg-bubble {
    transition: transform 0.1s ease, filter 0.1s ease; /* Ù†Ø¹ÙˆÙ…Ø© Ø§Ù„Ø­Ø±ÙƒØ© */
}

/* Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· (Active State) */
.msg-row:active .msg-bubble {
    transform: scale(0.95); /* ØªØµØºÙŠØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¹Ø·ÙŠ Ø¥ÙŠØ­Ø§Ø¡ Ø§Ù„Ø¶ØºØ· */
    filter: brightness(0.9); /* ØªØºÙ…ÙŠÙ‚ Ø¨Ø³ÙŠØ· */
}

/* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
.msg-row {
    cursor: pointer;
    -webkit-tap-highlight-color: transparent; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ */
}

/* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¸Ù‡ÙˆØ± */
.quick-reaction-popup {
    position: fixed; /* ØªØ«Ø¨ÙŠØª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø© */
    z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù… Z-Index Ù…Ù…ÙƒÙ† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ */
    background: rgba(20, 20, 25, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50px;
    padding: 8px 12px;
    border: 1px solid var(--gold-color);
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    
    /* Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¯ÙŠ Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø§Ù†Ù‡Ø§ Ù…Ø´ Ù…Ø®ÙÙŠØ© */
    display: none; 
    opacity: 0; /* ØªØ¨Ø¯Ø£ Ø´ÙØ§ÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
    transform: scale(0.8);
    pointer-events: auto;
    
    /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
    transition: opacity 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
/* --- ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù…ØµØ­Ø­) --- */
.quick-reaction-popup {
    position: fixed;
    z-index: 2147483647 !important; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    background: rgba(30, 30, 35, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50px;
    padding: 8px 12px;
    border: 1px solid var(--gold-color);
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    
    /* Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: Ù…Ø®ÙÙŠ ØªÙ…Ø§Ù…Ø§Ù‹ */
    display: none; 
    opacity: 0;
    transform: scale(0.8) translateY(10px);
    transition: opacity 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ */
.quick-reaction-popup.show {
    opacity: 1 !important;
    transform: scale(1) translateY(0) !important;
}

.reaction-items {
    display: flex;
    align-items: center;
    gap: 12px;
}

.q-emoji {
    font-size: 28px;
    cursor: pointer;
    transition: transform 0.2s;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}
.q-emoji:active { transform: scale(1.4); }

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
.setting-field { margin-bottom: 20px; }
.setting-field label { display: block; color: var(--gold-color); font-size: 12px; margin-bottom: 8px; font-weight: bold; }
.setting-input { 
    width: 100%; background: #1a1a1a; border: 1px solid #333; 
    color: #fff; padding: 12px; border-radius: 12px; outline: none; transition: 0.3s;
}
.setting-input:focus { border-color: var(--accent-color); background: #222; }

.setting-divider {
    font-size: 14px; color: #888; font-weight: bold; margin: 25px 0 10px;
    border-bottom: 1px solid #333; padding-bottom: 5px;
}

.setting-toggle-row {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 10px;
}
.st-title { color: #fff; font-weight: bold; font-size: 14px; }
.st-desc { color: #888; font-size: 11px; margin-top: 3px; }

/* Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Switch) */
.switch { position: relative; display: inline-block; width: 45px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #333; transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
  background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(21px); }

/* Ø¨Ø§Ø¯Ø¬Ø§Øª Ø§Ù„Ø±ØªØ¨ */
.role-badge { padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; margin-right: 5px; }
.role-owner { background: rgba(255, 215, 0, 0.15); color: #FFD700; border: 1px solid #FFD700; }
.role-co-owner { background: rgba(255, 140, 0, 0.15); color: #FF8C00; border: 1px solid #FF8C00; } /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
.role-admin { background: rgba(56, 189, 248, 0.15); color: #38bdf8; border: 1px solid #38bdf8; } /* Ø³Ù…Ø§ÙˆÙŠ */
.role-vip { background: rgba(236, 72, 153, 0.15); color: #ec4899; border: 1px solid #ec4899; } /* ÙˆØ±Ø¯ÙŠ */

/* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„ØµØ§Ø±Ù… (Z-Index System) --- */
:root {
    --z-base: 1;
    --z-header: 100;
    --z-overlay: 900;       /* Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ */
    --z-modal: 1000;        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
    --z-modal-top: 2000;    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (ÙÙˆÙ‚ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª) */
    --z-alert: 9999;        /* Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡) */
}

/* Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙŠØªØ© (ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ø®Ø¯Ø© Z-Index ØµØ­) */
.royal-modal {
    z-index: var(--z-modal); /* ÙƒØ§Ù† Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙ…Ø¨ÙŠØ´ØªØºÙ„Ø´ */
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
#groupSettingsOverlay {
    z-index: var(--z-modal-top) !important;
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆØ§Ù„Ø·ÙˆØ§Ø±Ø¦ */
.security-modal {
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9);
    background: #151515; 
    border: 1px solid var(--gold-color);
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
    border-radius: 20px;
    padding: 25px;
    width: 90%; max-width: 320px;
    z-index: var(--z-alert);
    display: none; opacity: 0;
    transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    flex-direction: column; gap: 15px;
}
.security-modal.active {
    display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1);
}

.sec-input {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 12px; border-radius: 10px;
    color: #fff; text-align: center; font-size: 16px;
    letter-spacing: 2px; width: 100%; outline: none;
}
.sec-input:focus { border-color: var(--gold-color); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }

.sec-btn {
    padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; border: none;
    transition: 0.2s;
}
.sec-btn.confirm { background: var(--gold-color); color: #000; }
.sec-btn.confirm:active { transform: scale(0.95); }
.sec-btn.cancel { background: transparent; color: #888; border: 1px solid #333; }

/* Ø®Ù„ÙÙŠØ© Ù…Ø¹ØªÙ…Ø© Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø£Ù…Ù†ÙŠØ© */
.security-overlay-bg {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
    z-index: var(--z-alert) - 1; /* ØªØ­Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¨Ø§Ø´Ø±Ø© */
    display: none;
}


/* ØªØµÙ…ÙŠÙ… ÙƒØ§Ø±Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø¶Ùˆ */
.select-member-card {
    display: flex; align-items: center; gap: 15px;
    padding: 12px; margin-bottom: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px; transition: 0.2s; cursor: pointer;
}
.select-member-card.selected {
    background: rgba(139, 92, 246, 0.15);
    border-color: var(--accent-color);
}
.checkbox-circle {
    width: 24px; height: 24px; border-radius: 50%;
    border: 2px solid #666; display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
}
.select-member-card.selected .checkbox-circle {
    background: var(--accent-color); border-color: var(--accent-color);
}
.select-member-card.selected .checkbox-circle i {
    display: block; font-size: 12px; color: #fff;
}
.checkbox-circle i { display: none; }


/* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø§ÙØ°Ø© */
.royal-confirm-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªØ±ÙƒÙŠØ² */
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s;
}
.royal-confirm-overlay.active { display: flex; opacity: 1; }

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
.royal-confirm-box {
    background: #151515;
    border: 1px solid var(--gold-color);
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
    width: 85%; max-width: 320px;
    border-radius: 20px;
    padding: 25px 20px;
    text-align: center;
    transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.royal-confirm-overlay.active .royal-confirm-box { transform: scale(1); }

/* Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù†Ø§Ø¨Ø¶Ø© */
.confirm-icon-pulse {
    width: 60px; height: 60px; margin: 0 auto;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: var(--accent-color); font-size: 24px;
    border: 1px solid rgba(139, 92, 246, 0.3);
    animation: pulseGold 2s infinite;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.confirm-actions-row {
    display: flex; gap: 10px; justify-content: center; margin-top: 15px;
}
.confirm-btn-ok {
    flex: 1; padding: 12px; border-radius: 12px; border: none;
    background: linear-gradient(45deg, var(--accent-color), #7c3aed);
    color: #fff; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
}
.confirm-btn-cancel {
    flex: 1; padding: 12px; border-radius: 12px;
    background: transparent; border: 1px solid #333;
    color: #888; cursor: pointer;
}

@keyframes pulseGold {
    0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
}

   </style>
</head>
<body>

<header class="chat-header">
    <div class="icon-btn" onclick="window.location.href='messages.html'">
        <i class="fa-solid fa-arrow-right"></i>
    </div>
    
    <div class="icon-btn" onclick="openNotifications()" style="position:relative;">
    <i class="fa-solid fa-bell"></i>
    <div id="notifBadge" style="position:absolute; top:0; right:0; width:10px; height:10px; background:red; border-radius:50%; display:none;"></div>
</div>

    
    <div class="header-info" onclick="openGroupInfo()">
        <div id="headerGroupImg" class="header-avatar" style="margin-right: 10px; background-image: url('https://cdn-icons-png.flaticon.com/512/166/166258.png');"></div>
        <div class="header-text">
            <h3 id="headerGroupName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <span id="headerMemberCount"><i class="fa-solid fa-users" style="font-size:10px;"></i> ... Ø£Ø¹Ø¶Ø§Ø¡</span>
        </div>
    </div>

    <div class="header-actions">
        <div class="icon-btn" onclick="startGroupCall('video')">
            <i class="fa-solid fa-video"></i>
        </div>
        <div class="icon-btn" onclick="startGroupCall('audio')">
            <i class="fa-solid fa-phone"></i>
        </div>

        <div class="icon-btn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </div>
    </div>
    
  </header>
  


    <i class="fa-solid fa-xmark" style="color:#666; padding:5px;" onclick="unpinMessage(event)"></i>
</div>

<div id="pinnedGroupDesc" class="pinned-desc-bar" style="display: none;" onclick="openGroupInfo()">
    <div class="pinned-icon">
        <i class="fa-solid fa-bullhorn"></i>
    </div>
    <div class="pinned-content">
        <span class="pinned-label">ÙˆØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
        <span id="descText" class="pinned-text">...</span>
    </div>
</div> 
<div class="sidebar" id="sidebar">
    <div style="text-align: center; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;">
        <div id="mySidebarAvatar" style="width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; border: 2px solid var(--gold-color); background-size: cover; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);"></div>
        <h3 style="color:#fff;" id="mySidebarName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
        <span style="color:var(--gold-color); font-size:12px;">Wareed Royal</span>
    </div>
    
    <div class="ctx-item" onclick="openGroupInfo()">
        <i class="fa-solid fa-circle-info"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    </div>

    <div class="ctx-item" onclick="openGroupGallery()">
        <i class="fa-regular fa-images"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
    </div>

    <div class="ctx-item" onclick="toggleSearchMode()">
        <i class="fa-solid fa-magnifying-glass"></i> Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    </div>

    <div class="ctx-item" onclick="toggleGhostMode()">
        <i class="fa-solid fa-ghost"></i> ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­
    </div>

    <div class="ctx-item" style="color:var(--danger-color);" onclick="leaveGroup()">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> Ù…ØºØ§Ø¯Ø±Ø©
    </div>
</div>


    <div class="bottom-sheet-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div id="groupDescriptionBubble" class="group-desc-bubble" onclick="openGroupInfo()">
    </div>


    <div class="chat-container" id="chatContainer"></div>

    <div class="reply-preview-bar" id="replyBar">
        <div style="display:flex; flex-direction:column; overflow:hidden;">
            <span class="reply-title" id="replySender">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰...</span>
            <span class="reply-content" id="replyText">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>
        </div>
        <i class="fa-solid fa-xmark" style="color:var(--danger-color); cursor:pointer;" onclick="cancelReply()"></i>
    </div>

<div class="chat-footer" id="mainFooter">
    
    <div class="recording-ui" id="recordingUI">
        <div class="rec-wave">
            <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 8px; height: 8px; background: red; border-radius: 50%; animation: pulseRed 1s infinite;"></div>
            <span id="recordTimer" style="color: #fff; font-family: monospace; font-size: 16px;">00:00</span>
        </div>

        <div style="display: flex; gap: 20px; align-items: center;">
            <div onclick="cancelRecording()" style="color: #aaa; font-size: 13px; cursor: pointer; font-weight: bold;">Ø¥Ù„ØºØ§Ø¡</div>
            
            <div onclick="stopAndSendRecording()" style="width: 40px; height: 40px; background: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 10px rgba(139,92,246,0.4);">
                <i class="fa-solid fa-paper-plane" style="color: #fff; font-size: 16px;"></i>
            </div>
        </div>
    </div>

    <div class="footer-content" id="normalFooterUI">
        
        <div class="footer-actions">
            <div class="footer-btn" onclick="openAttachmentSheet()">
                <i class="fa-solid fa-plus"></i>
            </div>
            <div class="footer-btn" onclick="openGiftSheet()">
                <i class="fa-solid fa-gift" style="color:#ff4081;"></i>
            </div>
        </div>
        
     <div class="smart-input-wrapper">
    <textarea id="msgInput" class="smart-textarea" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." rows="1" oninput="handleChatTyping(this)"></textarea>
    
    <div class="input-emoji-btn" onclick="openQuickEmoji()">
        <i class="fa-regular fa-face-smile"></i>
    </div>
</div>

        <div id="dynamicBtn" class="action-submit-btn mic-mode" onclick="startRecording()">
            <i class="fa-solid fa-microphone"></i>
        </div>

    </div>
</div>


    <div class="bottom-sheet-overlay" id="attSheet">
        <div class="bottom-sheet">
            <div style="width: 50px; height: 4px; background: #333; margin: 0 auto 20px; border-radius: 10px;"></div>
            <div class="attachment-grid">
                <div class="att-item" onclick="handleFile('image')">
                    <div class="att-icon" style="background:#e91e63;"><i class="fa-regular fa-image"></i></div> <span>Ù…Ø¹Ø±Ø¶</span>
                </div>
                <div class="att-item" onclick="handleFile('camera')">
                    <div class="att-icon" style="background:#9c27b0;"><i class="fa-solid fa-camera"></i></div> <span>ÙƒØ§Ù…ÙŠØ±Ø§</span>
                </div>
                <div class="att-item" onclick="handleFile('file')">
                    <div class="att-icon" style="background:#2196f3;"><i class="fa-solid fa-file-lines"></i></div> <span>Ù…Ø³ØªÙ†Ø¯</span>
                </div>
                <div class="att-item" onclick="handleFile('audio')">
                    <div class="att-icon" style="background:#ff9800;"><i class="fa-solid fa-headphones"></i></div> <span>ØµÙˆØª</span>
                </div>
                <div class="att-item" onclick="getLocation()">
                    <div class="att-icon" style="background:#4caf50;"><i class="fa-solid fa-location-dot"></i></div> <span>Ù…ÙˆÙ‚Ø¹</span>
                </div>
                <div class="att-item" onclick="openContactModal()">
                    <div class="att-icon" style="background:#00bcd4;"><i class="fa-solid fa-user"></i></div> <span>Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„</span>
                </div>
                <div class="att-item" onclick="openPollModal()">
                    <div class="att-icon" style="background:#795548;"><i class="fa-solid fa-square-poll-vertical"></i></div> <span>ØªØµÙˆÙŠØª</span>
                </div>
            </div>
        </div>
    </div>
<div class="bottom-sheet-overlay" id="giftSheet">
    <div class="bottom-sheet">
        <div style="width: 50px; height: 4px; background: #333; margin: 0 auto 20px; border-radius: 10px;"></div>
        
        <h3 style="color:var(--gold-color); text-align:center; margin-bottom:15px; font-size: 16px;">
            <i class="fa-solid fa-gem"></i> Ù…ØªØ¬Ø± Ø§Ù„Ø±ÙˆÙŠØ§Ù„
        </h3>

        <div class="gift-tabs-container">
            <div class="gift-tab active" onclick="GiftSystem.switch('gifts', this)">
                <i class="fa-solid fa-gift"></i> Ù‡Ø¯Ø§ÙŠØ§
            </div>
            <div class="gift-tab" onclick="GiftSystem.switch('emojis', this)">
                <i class="fa-regular fa-face-smile"></i> Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            </div>
            <div class="gift-tab" onclick="GiftSystem.switch('stickers', this)">
                <i class="fa-solid fa-face-laugh-beam"></i> Ù…Ù„ØµÙ‚Ø§Øª
            </div>
            <div class="gift-tab" onclick="GiftSystem.switch('gifs', this)">
                <i class="fa-solid fa-film"></i> GIF
            </div>
        </div>

        <div id="giftSystemContent" class="gift-content-area">
            <div class="loader-spinner">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
            </div>
        </div>

    </div>
</div>

    <div class="bottom-sheet-overlay" id="pollModal">
        <div class="bottom-sheet">
            <h3 style="color:#fff; text-align:center; margin-bottom:15px;">Ø¥Ù†Ø´Ø§Ø¡ ØªØµÙˆÙŠØª</h3>
            <input type="text" id="pollQuestion" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff; margin-bottom:10px; border-radius:10px;">
            <input type="text" id="pollOpt1" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff; margin-bottom:10px; border-radius:10px;">
            <input type="text" id="pollOpt2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:#fff; margin-bottom:10px; border-radius:10px;">
            <button onclick="sendPoll()" style="width:100%; background:var(--gold-color); color:#000; padding:10px; border:none; border-radius:10px; font-weight:bold;">Ù†Ø´Ø± Ø§Ù„ØªØµÙˆÙŠØª</button>
        </div>
    </div>

  <div class="bottom-sheet-overlay" id="contextOverlay" onclick="closeContextMenu()">
    <div class="context-menu" id="contextMenu" onclick="event.stopPropagation()">
        
        <div class="ctx-reactions">
            <span class="ctx-emoji" onclick="react('â¤ï¸')">â¤ï¸</span>
            <span class="ctx-emoji" onclick="react('ğŸ˜‚')">ğŸ˜‚</span>
            <span class="ctx-emoji" onclick="react('ğŸ˜®')">ğŸ˜®</span>
            <span class="ctx-emoji" onclick="react('ğŸ˜¢')">ğŸ˜¢</span>
            <span class="ctx-emoji" onclick="react('ğŸ‘')">ğŸ‘</span>
        </div>
        
<div class="ctx-item" onclick="toggleStarMessage()">
    <i class="fa-solid fa-star" style="color: #00e5ff; filter: drop-shadow(0 0 5px rgba(0,229,255,0.5));"></i> ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø©
</div>



        <div class="ctx-item" onclick="replyToMessage()"><i class="fa-solid fa-reply"></i> Ø±Ø¯</div>
        <div class="ctx-item" onclick="copyMessage()"><i class="fa-solid fa-copy"></i> Ù†Ø³Ø®</div>
        <div class="ctx-item" onclick="deleteMessage()" style="color:var(--danger-color);"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</div>
    </div>
</div>


<div id="proViewer" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:20000; display:none; flex-direction:column; justify-content:center; align-items:center;">
    
    <div onclick="closeProViewer()" style="position:absolute; top:20px; right:20px; width:40px; height:40px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:20001;">
        <i class="fa-solid fa-xmark" style="color:#fff; font-size:20px;"></i>
    </div>

    <div id="mediaContent" style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        </div>
</div>

<div class="bottom-sheet-overlay" id="menuSheet" onclick="closeMenu()">

    <div class="bottom-sheet" onclick="event.stopPropagation()">
        <div style="width: 50px; height: 4px; background: #333; margin: 0 auto 20px; border-radius: 10px;"></div>
        <h3 style="color:#fff; text-align:center; margin-bottom:20px;">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
        
        <div class="ctx-item" style="color:var(--danger-color);" onclick="leaveGroup()">
            <div class="att-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </div>
            <span>Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
        </div>
    </div>
</div>

<div id="fullSearchOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0b1121; z-index:9000; flex-direction:column;">
    
    <div style="display:flex; align-items:center; padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); background:rgba(20,20,25,0.95);">
        <div class="icon-btn" onclick="closeSearchMode()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <div style="flex:1; margin-right:10px; background:rgba(255,255,255,0.05); border-radius:20px; padding:0 15px; display:flex; align-items:center; border:1px solid rgba(255,255,255,0.1);">
            <i class="fa-solid fa-magnifying-glass" style="color:#94a3b8;"></i>
            <input type="text" id="fullSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø±Ø³Ø§Ù„Ø©..." style="width:100%; background:transparent; border:none; color:#fff; padding:12px; font-size:14px;" oninput="performGroupSearch(this.value)">
        </div>
    </div>

    <div id="searchResultsList" style="flex:1; overflow-y:auto; padding:10px;">
        <div style="text-align:center; padding:50px; color:#666;">
            <i class="fa-solid fa-comments" style="font-size:40px; margin-bottom:10px;"></i>
            <br>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        </div>
    </div>
</div>


    <div id="toast"></div>

    <input type="file" id="mediaInput" hidden accept="image/*,video/*">
    <input type="file" id="docInput" hidden accept="*/*">
    <input type="file" id="audioInput" hidden accept="audio/*">
    <input type="file" id="camInput" hidden accept="image/*" capture="environment">

    <script>
        
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        const groupId = new URLSearchParams(window.location.search).get('groupId');
        let currentUser = null;
        let isGhostMode = false;
        let selectedMsg = null; // Ù„Ù„Ø±Ø¯ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù
        let replyToData = null; // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯
        let mediaRecorder = null;
        let audioChunks = [];
        let recordInterval;
// ================= Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (WebRTC Engine) =================

let localStream = null;
let peerConnection = null;
let callTimerInterval = null;
let currentGroupPassword = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¬Ø±ÙˆØ¨
let currentGroupOwnerId = null;

// ================= Ù†Ø¸Ø§Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ =================
let selectedUsersToAdd = new Set(); // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ†
let allPotentialUsers = []; // Ù„ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†


let isChatLockedGlobal = false;
const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
// Ø¶ÙŠÙ Ø¯Ù‡ ØªØ­Øª currentUser = null;
let myRealProfile = {
    pic: null,
    verified: false,
    name: null
};

        // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
        auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        // --- ğŸŸ¢ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ---
        try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const d = userDoc.data();
                myRealProfile.pic = d.profilePic || d.avatar || d.image || user.photoURL;
                myRealProfile.verified = (d.isVerified === true || d.verified === true);
                myRealProfile.name = d.name || user.displayName;
            } else {
                // Ù„Ùˆ Ù…Ù„ÙˆØ´ Ø¯Ø§ØªØ§ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙˆØ¬Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                myRealProfile.pic = user.photoURL;
                myRealProfile.verified = false;
                myRealProfile.name = user.displayName;
            }
        } catch (e) {
            console.error("Error fetching profile:", e);
        }
        // --- ğŸ”´ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---

        initGroupChat();
        setupSidebarProfile();
    } else {
        auth.signInAnonymously();
    }
});


        // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„ØªØ®Ø²ÙŠÙ† "Ø£Ù‚Ø¯Ù…" Ø±Ø³Ø§Ù„Ø© Ø¸Ù‡Ø±Øª Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù„ÙŠ Ù‚Ø¨Ù„Ù‡Ø§ Ù„Ù…Ø§ Ù†Ø·Ù„Ø¹ Ù„ÙÙˆÙ‚)
let lastVisibleMsgDoc = null; 
let isLoadingMore = false; // Ø¹Ø´Ø§Ù† Ù†Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
let unsubscribeChat = null; // Ø¹Ø´Ø§Ù† Ù†ÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù…Ø§ Ù†Ø®Ø±Ø¬

function loadMessages() {
    if(unsubscribeChat) unsubscribeChat();

    const query = db.collection('chats').doc(groupId).collection('messages')
        .orderBy('createdAt', 'asc')
        .limitToLast(50);

    unsubscribeChat = query.onSnapshot(snapshot => {
        const container = document.getElementById('chatContainer');
        if (!lastVisibleMsgDoc && snapshot.docs.length > 0) {
            lastVisibleMsgDoc = snapshot.docs[0];
        }

        let isInitialLoad = container.children.length === 0;

        snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
                renderMessageUI(change.doc.data(), change.doc.id, 'append');
            }
            if (change.type === 'modified') {
                // ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                renderMessageUI(change.doc.data(), change.doc.id, 'replace');
            }
            if (change.type === 'removed') {
                const el = document.getElementById(`msg_${change.doc.id}`);
                if(el) el.remove();
            }
        });

        if (isInitialLoad) {
            scrollToBottom();
            container.addEventListener('scroll', handleScrollUp);
        } else {
            if (container.scrollHeight - container.scrollTop - container.clientHeight < 200) {
                scrollToBottom();
            }
        }
    });
}


        // --- Ù…Ø­Ø±Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¹ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ) ---
        // --- Ù…Ø­Ø±Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Ù…Ø¹Ø¯Ù„ Ù„Ù„ØµÙˆØ± Ø§Ù„Ø´ÙØ§ÙØ©) ---
function renderMessageUI(msg, id, method = 'append') {
    
    let starHTML = '';
    if (msg.isStarred === true) {
        starHTML = '<i class="fa-solid fa-star star-badge"></i>';
    }


    
    const container = document.getElementById('chatContainer');
    const isMe = msg.uid === currentUser.uid;
    
    let contentHTML = '';
    let bubbleExtraClass = ""; 

    // 1. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    if (msg.type === 'text') {
        contentHTML = linkify(msg.text);
    }
    
    else if (msg.type === 'image') {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
        bubbleExtraClass = "media-bubble";
        contentHTML = `
            <div class="media-container" style="max-width: 280px;">
                <img src="${msg.text}" style="width: 100%; display: block; max-height: 350px; object-fit: cover;" 
                     onclick="openProViewer('${msg.text}', 'image')">
            </div>`;
    } 
    
    else if (msg.type === 'video') {
    // 1. ØªÙØ¹ÙŠÙ„ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø´ÙØ§ÙÙŠØ© (Ø¹Ø´Ø§Ù† ÙŠÙ„ØºÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©)
    bubbleExtraClass = "media-bubble";
    
    // 2. ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¨Ø­ÙˆØ§Ù Ø¯Ø§Ø¦Ø±ÙŠØ© ÙˆØ¸Ù„ Ø®ÙÙŠÙ Ù„ÙŠÙƒÙˆÙ† Ù‡Ùˆ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©)
    contentHTML = `
        <div class="video-wrapper" style="position:relative; border-radius:18px; overflow:hidden; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.3);" 
             onclick="openProPlayer('${msg.text}')"> 
            
            <video src="${msg.text}#t=0.1" style="width:100%; display:block; max-height:350px; object-fit: cover;"></video>
            
            <div style="position:absolute; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.3);">
                <i class="fa-solid fa-play" style="font-size:35px; color:#fff; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));"></i>
            </div>
        </div>`;
}

    else if (msg.type === 'audio') {
        const rndId = Math.random().toString(36).substr(2, 9);
        contentHTML = `
            <div class="custom-audio-player">
                <div class="play-btn" onclick="toggleAudio(this, '${msg.text}')"><i class="fa-solid fa-play"></i></div>
                <input type="range" class="audio-slider" value="0" min="0" max="100" disabled>
            </div>`;
    }
    else if (msg.type === 'location') {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
        bubbleExtraClass = "media-bubble";
        
        contentHTML = `
            <div class="location-card" style="box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15);" 
                 onclick="window.open('https://maps.google.com/?q=${msg.lat},${msg.lng}', '_blank')">
                <div class="map-preview" style="background-image: url('https://static-maps.yandex.ru/1.x/?lang=en_US&ll=${msg.lng},${msg.lat}&z=15&l=map&size=220,100'); border-radius: 10px 10px 0 0;">
                    <i class="fa-solid fa-location-dot" style="color:red; font-size:25px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));"></i>
                </div>
                <div class="location-footer" style="border-radius: 0 0 10px 10px;">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ</div>
            </div>`;
    }

    else if (msg.type === 'poll') {
        let optionsHTML = '';
        msg.options.forEach((opt, idx) => {
            optionsHTML += `<div class="poll-option" onclick="votePoll('${id}', ${idx})">${opt}</div>`;
        });
        contentHTML = `
            <div class="poll-card">
                <div style="font-weight:bold; margin-bottom:8px; color:#fff;">ğŸ“Š ${msg.question}</div>
                ${optionsHTML}
            </div>`;
    }
    else if (msg.type === 'gift') {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ© (Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ¸Ù‡Ø± Ø¨Ø­ÙˆØ§ÙÙ‡ Ù‡Ùˆ Ø¨Ø³)
        bubbleExtraClass = "media-bubble";
        
        const boxId = `gift_box_${id}`;
        contentHTML = `
            <div id="${boxId}" class="magic-gift-container" onclick="openMagicGift('${boxId}')">
                <div class="gift-pop-content">${msg.text}</div>
                <div class="gift-pop-name">${msg.giftName || 'Ù‡Ø¯ÙŠØ©'}</div>
                <div class="box-lid"></div>
                <div class="box-body"></div>
            </div>`;
    }

else if (msg.type === 'contact') {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
        bubbleExtraClass = "media-bubble";
        
        contentHTML = `
            <div style="background: rgba(30, 30, 35, 0.95); padding: 15px; border-radius: 16px; min-width: 200px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div style="width: 40px; height: 40px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff;">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div style="color: #fff; font-weight: bold;">${msg.contactName || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; text-align: center; color: var(--accent-color); letter-spacing: 1px; font-family: monospace;">
                    ${msg.contactNumber || '00000000'}
                </div>
                <a href="tel:${msg.contactNumber}" style="display: block; text-align: center; margin-top: 10px; color: #fff; text-decoration: none; background: var(--accent-color); padding: 5px; border-radius: 8px; font-size: 12px; font-weight: bold;">
                    Ø§ØªØµØ§Ù„ <i class="fa-solid fa-phone"></i>
                </a>
            </div>`;
    }




    else if (msg.type === 'sticker') {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ© (Ø¹Ø´Ø§Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© ØªØ®ØªÙÙŠ)
        bubbleExtraClass = "media-bubble";
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„ØµÙ‚ (Ø­Ø¬Ù… ÙƒØ¨ÙŠØ± ÙˆØ¸Ù„ Ø®ÙÙŠÙ Ø¹Ø´Ø§Ù† ÙŠØ¨Ø±Ø²)
        contentHTML = `
            <img src="${msg.text}" style="width: 130px; height: 130px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); display: block;">
        `;
    }
    else if (msg.type === 'file') {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
        bubbleExtraClass = "media-bubble";
        
        // Ù‚Ù…Øª Ø¨ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ ÙƒØ§Ø±Øª Ø§Ù„Ù…Ù„Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙŠÙ„ÙŠÙ‚ Ø¨Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø´ÙØ§Ù
        contentHTML = `
            <div style="display:flex; align-items:center; gap:12px; background:rgba(30, 30, 35, 0.95); padding:12px 15px; border-radius:16px; cursor:pointer; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2);" 
                 onclick="window.open('${msg.text}', '_blank')">
                
                <div style="width: 40px; height: 40px; background: rgba(0, 229, 255, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-file-arrow-down" style="font-size:20px; color:var(--accent-color);"></i>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <span style="font-size:13px; font-weight: bold; color: #fff;">${msg.fileName || 'Ù…Ù„Ù Ù…Ø±ÙÙ‚'}</span>
                    <span style="font-size:10px; color: #aaa;">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„</span>
                </div>
            </div>`;
    }
    
const verifyBadge = (msg.isVerified === true) 
        ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:12px; margin-right:4px;" title="Ù…ÙˆØ«Ù‚"></i>' 
        : '';

  

    // 2. Ø§Ù„Ø±Ø¯ (Reply Context)
    let replyHTML = '';
    if (msg.replyTo) {
        replyHTML = `
            <div class="replied-msg-context">
                <div style="color:var(--gold-color); font-weight:bold;">${msg.replyTo.sender}</div>
                <div style="color:#ccc;">${msg.replyTo.text}</div>
            </div>`;
    }

    // 3. Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        // 3. Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ±)
    // ... Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© renderMessageUI ...
let reactionHTML = '';

if (msg.reactions && Object.keys(msg.reactions).length > 0) {
    const counts = {};
    Object.values(msg.reactions).forEach(emoji => {
        counts[emoji] = (counts[emoji] || 0) + 1;
    });

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ù…ØµÙÙˆÙØ© ÙˆÙØ±Ø²Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ø§Ù‹ Ù„Ù„Ø£Ù‚Ù„
    const sortedReactions = Object.entries(counts)
        .sort((a, b) => b[1] - a[1]) // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯
        .slice(0, 3); // Ø£Ø®Ø° Ø£Ø¹Ù„Ù‰ 3 Ø£Ù†ÙˆØ§Ø¹ ÙÙ‚Ø·

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶
    let emojisDisplay = sortedReactions.map(r => r[0]).join(' ');
    let totalCount = Object.keys(msg.reactions).length;

    reactionHTML = `
        <div class="msg-reaction reaction-badge" onclick="showReactionDetails('${id}', event)">
            <span>${emojisDisplay}</span>
            <span style="font-size:10px; margin-right:3px; color:#aaa;">${totalCount}</span>
        </div>
    `;
}

    // 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ HTML Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const senderPic = msg.senderPic || defaultAvatar;
    
    // ğŸ”¥ Ø§Ù„ØªØºÙŠÙŠØ± Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© bubbleExtraClass Ù„Ù„ÙƒÙ„Ø§Ø³Ø§Øª ğŸ”¥
    
        // ==========================================
    // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ)
    // ==========================================
    if (!isMe && msg.createdAt) {
        const msgTime = msg.createdAt.toDate().getTime();
        const now = Date.now();
        // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØµÙ„Øª ÙÙŠ Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ (ÙŠØ¹Ù†ÙŠ Ù„Ø§ÙŠÙ)
        if (now - msgTime < 5000) { 
            // Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ø´Ø§Ù† Ù…ÙŠØ­ØµÙ„Ø´ Ø§ÙŠØ±ÙˆØ±
            if(typeof sendBrowserNotification === 'function') {
                sendBrowserNotification(msg.senderName, msg.type === 'text' ? msg.text : 'ğŸ“ Ø£Ø±Ø³Ù„ Ù…Ø±ÙÙ‚Ø§Ù‹');
            }
        }
    }

    // ==========================================
    // 2. Ù…Ù†Ø·Ù‚ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ (Status Icon)
    // ==========================================
    let statusIcon = '';
    
    if (isMe) {
        // Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ seen Ø¨Ù€ trueØŒ Ø®Ù„ÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø²Ø±Ù‚Ø§Ø¡ (status-seen)
        // Ù„Ùˆ falseØŒ Ø®Ù„ÙŠÙ‡Ø§ Ø±Ù…Ø§Ø¯ÙŠ (status-delivered)
        if (msg.seen === true) {
            statusIcon = '<i class="fa-solid fa-check-double msg-status-icon status-seen" style="margin-right:3px;"></i>';
        } else {
            statusIcon = '<i class="fa-solid fa-check-double msg-status-icon status-delivered" style="margin-right:3px;"></i>';
        }
    }

    
    const html = `
    <div class="msg-row ${isMe ? 'me' : 'other'}" id="msg_${id}" 
         style="cursor: pointer;" 
         onclick="showQuickReactions(event, '${id}')"
         oncontextmenu="showContextMenu(event, '${id}', '${msg.type}', '${encodeURIComponent(JSON.stringify(msg))}')">
         
        ${!isMe ? `<div class="msg-avatar" style="background-image:url('${senderPic}')"></div>` : ''}
        
        <div class="msg-bubble ${bubbleExtraClass}">
            ${starHTML} ${!isMe ? `<span class="sender-name">${msg.senderName}</span>` : ''}
            ${replyHTML}
            <div>${contentHTML}</div>
            ${reactionHTML}
            <div class="msg-time">
                ${msg.createdAt ? moment(msg.createdAt.toDate()).format('h:mm A') : '...'}
                ${statusIcon} 
            </div>
        </div>
    </div>
`;

    if (method === 'replace') {
        // Ù„Ùˆ Ø¨Ù†Ø¹Ù…Ù„ ØªØ­Ø¯ÙŠØ«ØŒ Ø¨Ù†Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù†ÙØ³ Ù…ÙƒØ§Ù†Ù‡Ø§
        const oldElement = document.getElementById(`msg_${id}`);
        if (oldElement) {
            oldElement.outerHTML = html;
        }
    } else if (method === 'prepend') {
        container.insertAdjacentHTML('afterbegin', html);
    } else {
        container.insertAdjacentHTML('beforeend', html);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const newEl = document.getElementById(`msg_${id}`);
    if (newEl) addSwipeToReply(newEl, msg, id);
}

async function sendMessage(payload = null) {
    // ============================================================
    // ğŸ›‘ 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚ÙÙ„ (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù‡Ø§Ù…Ø©)
    // ============================================================
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù‚ÙÙˆÙ„Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ (isChatLockedGlobal)
    // ÙˆØ£Ù†Ø§ Ù„Ø³Øª Ù…Ø´Ø±ÙØ§Ù‹ Ø£Ùˆ Ø£Ø¹Ù„Ù‰ (myPower < 3)
    // Ù†Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆÙ†Ø¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡.
    if (typeof isChatLockedGlobal !== 'undefined' && isChatLockedGlobal) {
        // Ù†ÙØªØ±Ø¶ Ø£Ù† myPower ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙÙŠ initGroupChat (1=Ø¹Ø¶ÙˆØŒ 3=Ù…Ø´Ø±ÙØŒ 5=Ù…Ø§Ù„Ùƒ)
        // Ù„Ùˆ Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù†ÙØªØ±Ø¶ Ø§Ù†Ù‡ Ø¹Ø¶Ùˆ (1)
        const power = (typeof myPower !== 'undefined') ? myPower : 1; 
        
        if (power < 3) {
            showToast("â›” Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù‚ÙÙˆÙ„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
            return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
        }
    }

    let msgData = {};

    // ============================================================
    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†Øµ Ø£Ùˆ Ù…Ø±ÙÙ‚)
    // ============================================================
    if (payload) {
        // Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ù…Ø±ÙÙ‚ (ØµÙˆØ±Ø©ØŒ Ù‡Ø¯ÙŠØ©ØŒ Ù…ÙˆÙ‚Ø¹...)
        msgData = { ...payload };
    } else {
        // Ø­Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        
        if (!text) return; // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†ØµØŒ Ø§Ø®Ø±Ø¬
        
        msgData = { type: 'text', text: text };
        
        // ğŸ”¥ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ (UX)
        input.value = ''; 
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© "Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø°ÙƒÙŠ" Ù„Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù…
        if (typeof handleChatTyping === 'function') {
            handleChatTyping(input); 
        }
    }

    // ============================================================
    // 3. Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
    // ============================================================
    // Ù†ØªØ£ÙƒØ¯ Ø£Ù† myRealProfile Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    const profileName = (typeof myRealProfile !== 'undefined' && myRealProfile.name) ? myRealProfile.name : currentUser.displayName;
    const profilePic = (typeof myRealProfile !== 'undefined' && myRealProfile.pic) ? myRealProfile.pic : defaultAvatar;
    const isVerified = (typeof myRealProfile !== 'undefined') ? myRealProfile.verified : false;

    msgData.uid = currentUser.uid;
    msgData.senderName = profileName || "Ù…Ø³ØªØ®Ø¯Ù…";
    msgData.senderPic = profilePic; 
    msgData.isVerified = isVerified;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø±Ø¤ÙŠØ©
    msgData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    msgData.seen = false;
    
    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹)
    msgData.isGhost = (typeof isGhostMode !== 'undefined') ? isGhostMode : false;

    // ============================================================
    // 4. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ (Replies)
    // ============================================================
    if (typeof replyToData !== 'undefined' && replyToData) {
        msgData.replyTo = replyToData;
        cancelReply(); // Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¯
    }

    // ============================================================
    // 5. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù€ Firebase
    // ============================================================
    try {
        // Ø£) Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙƒÙˆÙ„ÙƒØ´Ù†
        await db.collection('chats').doc(groupId).collection('messages').add(msgData);
        
        // Ø¨) ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Last Message)
        let preview = msgData.type === 'text' ? msgData.text : `Ø£Ø±Ø³Ù„ ${msgData.type}`;
        
        // Ù„Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ØŒ Ù†Ø®ÙÙŠ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        const isGhost = msgData.isGhost;
        const lastMsgText = isGhost ? "ğŸ‘» Ø±Ø³Ø§Ù„Ø© Ø´Ø¨Ø­" : `${profileName}: ${preview}`;

        db.collection('chats').doc(groupId).update({
            lastMessage: lastMsgText,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            lastSender: currentUser.uid,
            // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†"
            typing: firebase.firestore.FieldValue.arrayRemove(currentUser.displayName)
        });

        // Ø¬) ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
        if (typeof playSound === 'function') {
            playSound('sent');
        } else {
            const sentSound = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg');
            sentSound.volume = 1.0;
            sentSound.play().catch(() => {});
        }

    } catch (e) { 
        console.error("Error sending message:", e); 
        showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
    }
}


        // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª ---
        // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø·ÙˆØ± Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù…ÙŠØ¯ÙŠØ§ ---
async function handleFile(type) {
    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    document.getElementById('attSheet').classList.remove('active');
    
    // ØªØ­Ø¯ÙŠØ¯ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
    let inputId = '';
    switch(type) {
        case 'image': inputId = 'mediaInput'; break;
        case 'camera': inputId = 'camInput'; break;
        case 'file': inputId = 'docInput'; break;
        case 'audio': inputId = 'audioInput'; break;
        default: inputId = 'docInput';
    }
    
    const input = document.getElementById(inputId);
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â³");

        try {
            // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³Ø§Ø± Ø§Ù„Ø±ÙØ¹ ÙÙŠ Firebase Storage
            // ÙŠØªÙ… ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            const storagePath = `group_chats/${groupId}/${Date.now()}_${file.name}`;
            const fileRef = storage.ref(storagePath);

            // 3. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠØ©
            const uploadTask = await fileRef.put(file);
            
            // 4. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ (URL)
            const downloadURL = await fileRef.getDownloadURL();

            // 5. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            let msgType = 'file'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if (file.type.startsWith('image/')) msgType = 'image';
            else if (file.type.startsWith('video/')) msgType = 'video';
            else if (file.type.startsWith('audio/')) msgType = 'audio';

            // 6. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Firestore
            await sendMessage({ 
                type: msgType, 
                text: downloadURL,
                fileName: file.name // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
            });

            showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");

        } catch (error) {
            console.error("Upload Error:", error);
            showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ");
        }
        
        // ØªØµÙÙŠØ± Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯Ø®Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        input.value = '';
    };

    input.click();
}

        // --- Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ---
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª
let audioCtxRecording = null;
let recordingStream = null;

async function startRecording() {
    try {
        // 1. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¨Ø¯Ø¡
        playSound('click'); 

        // 2. Ø·Ù„Ø¨ Ø§Ù„Ù…Ø§ÙŠÙƒ
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordingStream = stream; // Ù†Ø­ØªÙØ¸ Ø¨ÙŠÙ‡ Ø¹Ø´Ø§Ù† Ù†Ù‚ÙÙ„Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†

        // ==========================================
        // ğŸ”¥ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ ØªØ¶Ø®ÙŠÙ… Ø§Ù„ØµÙˆØª (Gain Booster) ğŸ”¥
        // ==========================================
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ù‚ ØµÙˆØªÙŠ
        audioCtxRecording = new (window.AudioContext || window.webkitAudioContext)();
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµØ¯Ø± Ù…Ù† Ø§Ù„Ù…Ø§ÙŠÙƒ
        const source = audioCtxRecording.createMediaStreamSource(stream);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¶Ø®Ù… (Gain Node)
        const gainNode = audioCtxRecording.createGain();
        gainNode.gain.value = 2.5; // ğŸ‘ˆ Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ø¶Ø±Ø¨Ù†Ø§ Ø§Ù„ØµÙˆØª ÙÙŠ 2.5 Ø¶Ø¹Ù (Ù…Ù…ÙƒÙ† ØªØ®Ù„ÙŠÙ‡Ø§ 3.0 Ù„Ùˆ Ø¹Ø§ÙŠØ²Ù‡ Ø£Ø¹Ù„Ù‰)
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© ØªØ¬Ù…ÙŠØ¹ Ø¹Ø´Ø§Ù† Ù†Ø³Ø¬Ù„ Ù…Ù†Ù‡Ø§
        const destination = audioCtxRecording.createMediaStreamDestination();
        
        // ØªÙˆØµÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠÙ„Ø§Øª: Ù…Ø§ÙŠÙƒ -> Ù…Ø¶Ø®Ù… -> Ù…Ø³Ø¬Ù„
        source.connect(gainNode);
        gainNode.connect(destination);

        // Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø¶Ø®Ù…
        mediaRecorder = new MediaRecorder(destination.stream);
        // ==========================================

        audioChunks = [];
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.getElementById('recordingUI').style.display = 'flex';
        document.getElementById('msgInput').style.display = 'none';
        
        // Ø§Ù„Ø¹Ø¯Ø§Ø¯
        let seconds = 0;
        clearInterval(recordInterval);
        document.getElementById('recordTimer').innerText = "00:00";
        
        recordInterval = setInterval(() => {
            seconds++;
            document.getElementById('recordTimer').innerText = `00:${seconds < 10 ? '0'+seconds : seconds}`;
        }, 1000);

        mediaRecorder.ondataavailable = e => {
            if(e.data.size > 0) audioChunks.push(e.data);
        };
        
        mediaRecorder.start();
        
        // Ù‡Ø²Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        if(navigator.vibrate) navigator.vibrate(50); 

    } catch (e) { 
        console.error(e);
        showToast("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ğŸ¤"); 
    }
}


        function stopAndSendRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
            clearInterval(recordInterval);
            document.getElementById('recordingUI').style.display = 'none';
            document.getElementById('msgInput').style.display = 'block';

            // 2. ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ù…Ø¶Ø®Ù… (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            if (audioCtxRecording) {
                audioCtxRecording.close(); // Ù‚ÙÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª
            }

            // 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„
            const blob = new Blob(audioChunks, { type: 'audio/mp4' }); // MP4 Ù…Ø¯Ø¹ÙˆÙ… Ø£ÙØ¶Ù„
            
            showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª... ğŸ¤");
            
            // Ø§Ù„Ø±ÙØ¹ Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
            const ref = storage.ref(`voice_notes/${Date.now()}.mp4`);
            try {
                await ref.put(blob);
                const url = await ref.getDownloadURL();
                sendMessage({ type: 'audio', text: url });
            } catch(e) {
                showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª âŒ");
            }
        };
    }
}

        function cancelRecording() {
    if(mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    clearInterval(recordInterval);
    document.getElementById('recordingUI').style.display = 'none';
    document.getElementById('msgInput').style.display = 'block';

    // ğŸ”¥ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¶Ø®Ù…
    if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
    }
    if (audioCtxRecording) {
        audioCtxRecording.close();
    }
}


        // --- Ø§Ù„Ù…ÙˆÙ‚Ø¹ ---
        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('attSheet').classList.remove('active');
                showToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...");
                navigator.geolocation.getCurrentPosition(pos => {
                    sendMessage({
                        type: 'location',
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    });
                });
            }
        }

        // --- Ø§Ù„ØªØµÙˆÙŠØª ---
        function openPollModal() {
            document.getElementById('attSheet').classList.remove('active');
            document.getElementById('pollModal').classList.add('active');
        }

        function sendPoll() {
            const q = document.getElementById('pollQuestion').value;
            const o1 = document.getElementById('pollOpt1').value;
            const o2 = document.getElementById('pollOpt2').value;
            
            if(q && o1 && o2) {
                document.getElementById('pollModal').classList.remove('active');
                sendMessage({
                    type: 'poll',
                    question: q,
                    options: [o1, o2]
                });
            }
        }

        // --- Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ù…Ù„ØµÙ‚Ø§Øª ---
        const giftsList = [
            { name: 'ØªØ§Ø¬', emoji: 'ğŸ‘‘', price: 500 },
            { name: 'Ø£Ù„Ù…Ø§Ø³', emoji: 'ğŸ’', price: 100 },
            { name: 'Ø³ÙŠØ§Ø±Ø©', emoji: 'ğŸï¸', price: 1000 },
            { name: 'ÙˆØ±Ø¯Ø©', emoji: 'ğŸŒ¹', price: 10 }
        ];
        
        function switchTab(type) {
            const grid = document.getElementById('giftGrid');
            grid.innerHTML = '';
            if(type === 'gifts') loadGiftsAndStickers();
            else {
                // Ù…Ù„ØµÙ‚Ø§Øª
                ['ğŸ˜€','ğŸ˜‚','ğŸ˜','ğŸ˜','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰'].forEach(s => {
                    grid.innerHTML += `<div style="font-size:35px; text-align:center; cursor:pointer;" onclick="sendMessage({type:'sticker', text:'https://ui-avatars.com/api/?name=${s}&background=random'})">${s}</div>`; // Ù…Ø­Ø§ÙƒØ§Ø© Ø³ØªÙŠÙƒØ± Ø¨ØµÙˆØ±Ø©
                });
            }
        }

        function sendGift(emoji, name) {
            document.getElementById('giftSheet').classList.remove('active');
            sendMessage({ type: 'gift', text: emoji, giftName: name });
        }

        // --- Ø§Ù„Ø±Ø¯ (Reply System) ---
        function showContextMenu(e, id, type, msgStr) {
            e.preventDefault();
            selectedMsg = { id, type, data: JSON.parse(decodeURIComponent(msgStr)) };
            
            const menu = document.getElementById('contextMenu');
            document.getElementById('contextOverlay').classList.add('active');
            menu.classList.add('active');
        }

        function replyToMessage() {
            closeContextMenu();
            const msg = selectedMsg.data;
            replyToData = {
                id: selectedMsg.id,
                sender: msg.senderName,
                text: msg.type === 'text' ? msg.text : `[${msg.type}]`
            };
            
            document.getElementById('replyBar').style.display = 'flex';
            document.getElementById('replySender').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${replyToData.sender}`;
            document.getElementById('replyText').innerText = replyToData.text;
        }

        function cancelReply() {
            replyToData = null;
            document.getElementById('replyBar').style.display = 'none';
        }

        async function react(emoji) {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    closeContextMenu();

    // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØªØ§Ø±Ø©
    if (!selectedMsg || !selectedMsg.id) {
        showToast("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
        return;
    }

    const msgId = selectedMsg.id;
    const myUid = currentUser.uid;
    const msgRef = db.collection('chats').doc(groupId).collection('messages').doc(msgId);

    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙØ§Ø¹Ù„ ÙÙˆØ±Ø§Ù‹ (ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙØ¶Ù„)
    const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
    audio.play().catch(()=>{});

    try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Transaction Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø¥Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØ­ØµÙ„ ØµØ­ Ø­ØªÙ‰ Ù„Ùˆ Ù†Ø§Ø³ ÙƒØªÙŠØ± Ø¨ØªØªÙØ§Ø¹Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(msgRef);
            if (!doc.exists) throw "Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";

            let reactions = doc.data().reactions || {};
            let actionType = ""; // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­ØµÙ„ Ø¥ÙŠÙ‡

            if (reactions[myUid] === emoji) {
                // Ù„Ùˆ Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -> Ø§Ù„ØºÙŠÙ‡ (Ø­Ø°Ù)
                delete reactions[myUid];
                actionType = "removed";
            } else {
                // Ù„Ùˆ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù…Ø®ØªÙ„Ù -> Ø¶ÙŠÙÙ‡/Ø¹Ø¯Ù„Ù‡
                reactions[myUid] = emoji;
                actionType = "added";
            }

            transaction.update(msgRef, { reactions: reactions });
            return actionType;
        }).then((actionType) => {
            // Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (actionType === "removed") {
                showToast("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ ğŸ—‘ï¸");
            } else {
                showToast(`ØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ù€ ${emoji}`);
            }
        });

    } catch (e) {
        console.error("Reaction Error:", e);
        showToast("ÙØ´Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„");
    }
}


        // --- Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø±Ø¯ (Touch Swipe) ---
        function addSwipeToReply(element, msg, id) {
            let startX = 0;
            element.addEventListener('touchstart', e => startX = e.touches[0].clientX);
            element.addEventListener('touchmove', e => {
                let diff = e.touches[0].clientX - startX;
                if(diff > 50) element.style.transform = `translateX(${Math.min(diff, 100)}px)`;
            });
            element.addEventListener('touchend', e => {
                element.style.transform = 'translateX(0)';
                if(e.changedTouches[0].clientX - startX > 80) {
                    selectedMsg = { id, data: msg };
                    replyToMessage();
                }
            });
        }

        // --- Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ---
        let currentAudio = null;
        function toggleAudio(btn, url) {
            if(currentAudio && currentAudio.src === url) {
                if(currentAudio.paused) currentAudio.play(); else currentAudio.pause();
            } else {
                if(currentAudio) currentAudio.pause();
                currentAudio = new Audio(url);
                currentAudio.play();
                currentAudio.onended = () => btn.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
            btn.innerHTML = currentAudio.paused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
        function toggleGhostMode() {
            isGhostMode = !isGhostMode;
            document.body.classList.toggle('ghost-active');
            toggleSidebar();
            showToast(isGhostMode ? "ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­");
        }

        function openSearch() {
            const term = prompt("Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:");
            if(term) showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«..."); 
        }

        // Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ
function openProViewer(url, type) {
    const viewer = document.getElementById('proViewer');
    const content = document.getElementById('mediaContent');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´ØºÙ„
    viewer.style.display = 'flex';
    
    if (type === 'image') {
        // Ø¹Ø±Ø¶ ØµÙˆØ±Ø©
        content.innerHTML = `<img src="${url}" style="max-width:100%; max-height:85vh; border-radius:10px; box-shadow:0 0 30px rgba(0,0,0,0.5);">`;
    } else {
        // Ø¹Ø±Ø¶ ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª ØªØ­ÙƒÙ…
        content.innerHTML = `
            <div style="width:100%; max-width:800px; display:flex; flex-direction:column; align-items:center; gap:15px;">
                
                <video id="mainVideoPlayer" src="${url}" style="width:100%; max-height:70vh; border-radius:10px; background:#000;" autoplay controls playsinline></video>
                
                <div style="display:flex; gap:20px; background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:30px; backdrop-filter:blur(10px);">
                    
                    <button onclick="document.getElementById('mainVideoPlayer').currentTime -= 10" style="background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer;">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                    
                    <button onclick="toggleProVideo()" style="background:#fff; border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                        <i class="fa-solid fa-pause" id="proPlayIcon" style="color:#000;"></i>
                    </button>
                    
                    <button onclick="document.getElementById('mainVideoPlayer').currentTime += 10" style="background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer;">
                        <i class="fa-solid fa-rotate-left"></i>
                    </button>

                    <div style="width:1px; height:20px; background:rgba(255,255,255,0.3);"></div>

                    <a href="${url}" target="_blank" download style="color:#fff; font-size:20px; display:flex; align-items:center;">
                        <i class="fa-solid fa-download"></i>
                    </a>
                </div>
            </div>`;
    }
}

// Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function toggleProVideo() {
    const vid = document.getElementById('mainVideoPlayer');
    const icon = document.getElementById('proPlayIcon');
    
    if (vid.paused) {
        vid.play();
        icon.className = "fa-solid fa-pause";
    } else {
        vid.pause();
        icon.className = "fa-solid fa-play";
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´ØºÙ„ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
function closeProViewer() {
    const viewer = document.getElementById('proViewer');
    const content = document.getElementById('mediaContent');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØª Ù…ÙŠØ´ØªØºÙ„Ø´ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    const vid = document.getElementById('mainVideoPlayer');
    if(vid) {
        vid.pause();
        vid.src = "";
    }
    
    content.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    viewer.style.display = 'none';
}
  function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeContextMenu() {
            document.getElementById('contextOverlay').classList.remove('active');
            document.getElementById('contextMenu').classList.remove('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function openAttachmentSheet() { document.getElementById('attSheet').classList.add('active'); }
        function openGiftSheet() { 
    document.getElementById('giftSheet').classList.add('active'); 
    
    // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ¬Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù„Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙÙˆØ± Ø§Ù„ÙØªØ­
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±ØºØ§Ù‹
    const container = document.getElementById('giftSystemContent');
    if(container.innerHTML.trim() === "" || container.innerHTML.includes('fa-spin')) {
         // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙˆÙ„ ØªØ¨ÙˆÙŠØ¨
         const firstTab = document.querySelector('.gift-tab');
         GiftSystem.switch('gifts', firstTab);
    }
}
        function openMenu() { document.getElementById('menuSheet').classList.add('active'); }
        
        document.querySelectorAll('.bottom-sheet-overlay').forEach(el => {
            el.addEventListener('click', e => { if(e.target === el) el.classList.remove('active'); });
        });

        // ØªØ´ØºÙŠÙ„ Ø²Ø± Enter
        document.getElementById('msgInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        async function setupSidebarProfile() {
    if (!currentUser) return;

    const avatarEl = document.getElementById('mySidebarAvatar');
    const nameEl = document.getElementById('mySidebarName');

    // 1. ÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ù€ Auth (Ø³Ø±ÙŠØ¹)
    let displayName = currentUser.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
    let photoURL = currentUser.photoURL;
    let isVerified = false;

    try {
        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const data = userDoc.data();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
            if (data.name) displayName = data.name;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© (Ù†Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„ Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©)
            photoURL = data.profilePic || data.avatar || data.image || data.photoURL || photoURL;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ«ÙŠÙ‚
            isVerified = (data.isVerified === true || data.verified === true);
        }
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„:", e);
    }

    // 3. Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    // Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚
    const verifyIcon = isVerified ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; margin-right:5px; font-size:14px;"></i>' : '';
    nameEl.innerHTML = `${displayName} ${verifyIcon}`;

    // Ø§Ù„ØµÙˆØ±Ø©
    if (photoURL) {
        avatarEl.style.backgroundImage = `url('${photoURL}')`;
        avatarEl.innerText = '';
        avatarEl.style.backgroundColor = 'transparent';
    } else {
        // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø©ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„
        avatarEl.style.backgroundImage = 'none';
        avatarEl.innerText = displayName.charAt(0).toUpperCase();
        avatarEl.style.display = 'grid';
        avatarEl.style.placeItems = 'center';
        avatarEl.style.fontSize = '30px';
        avatarEl.style.color = '#fff';
        avatarEl.style.backgroundColor = '#333';
    }
}

        function linkify(text) {
            var urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlRegex, function(url) {
                return '<a href="' + url + '" target="_blank" style="color:var(--verify-color); text-decoration:underline;">' + url + '</a>';
            });
        }

/* ================= Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ================= */


let callSeconds = 0;

// 1. Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (ØµÙˆØª Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ)
async function startGroupCall(type) {
    const overlay = document.getElementById('callOverlay');
    const videoContainer = document.getElementById('videoContainer');
    
    // 1. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ (ÙÙŠØ¯ÙŠÙˆ ÙˆÙ„Ø§ ØµÙˆØª)
    const constraints = {
        audio: true,
        video: type === 'video' ? { facingMode: 'user' } : false
    };

    try {
        // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ ÙÙŠØ¯ÙŠÙˆ
        if (type === 'video') {
            videoContainer.style.display = 'block';
            document.getElementById('localVideo').srcObject = localStream;
            document.getElementById('localVideo').style.display = 'block';
        } else {
            videoContainer.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ùˆ ØµÙˆØª Ø¨Ø³
        }

        overlay.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©
        document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...";

        // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ (WebRTC)
        peerConnection = new RTCPeerConnection(rtcConfig);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±Ø§ÙƒØ§Øª (ØµÙˆØª ÙˆØµÙˆØ±Ø©) Ù„Ù„Ø§ØªØµØ§Ù„
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª (Candidates) Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.collection('chats').doc(groupId).collection('call_candidates').add(event.candidate.toJSON());
            }
        };

        // 5. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        peerConnection.ontrack = (event) => {
    console.log("ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ±Ø§Ùƒ ØµÙˆØª/ÙÙŠØ¯ÙŠÙˆ", event);
    
    // 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
    const remoteVid = document.getElementById('remoteVideo');
    if (event.track.kind === 'video') {
        remoteVid.srcObject = event.streams[0];
    }

    // 2. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØµÙˆØª (Ø¯Ù‡ Ø§Ù„Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† ØªØ³Ù…Ø¹Ù‡)
    if (event.track.kind === 'audio') {
        const remoteAudio = document.getElementById('remoteAudio');
        if (remoteAudio) {
            remoteAudio.srcObject = event.streams[0];
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙˆØ±Ø§Ù‹
            remoteAudio.play().catch(e => console.log("Audio autoplay blocked:", e));
        }
    }
};
        // 6. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ (Offer)
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // 7. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„ ÙŠØ´ÙˆÙÙ‡Ø§ ÙˆÙŠØ±Ù† Ø¹Ù†Ø¯Ù‡Ù…)
        await db.collection('chats').doc(groupId).collection('calls').doc(callDocId).set({
            type: 'offer',
            sdp: offer.sdp, // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            callerId: currentUser.uid,
            callerName: currentUser.displayName,
            callerPic: currentUser.photoURL,
            callType: type, // video or audio
            status: 'ringing', // Ø§Ù„Ø­Ø§Ù„Ø©: Ø±Ù†ÙŠÙ†
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('callStatusText').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù†Ø¶Ù…Ø§Ù… Ø£Ø­Ø¯...";
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯ (Answer)
        listenForAnswer();

    } catch (err) {
        console.error("Error starting call:", err);
        showToast("ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ");
        endGroupCall();
    }
}

// 2. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
function endGroupCall() {
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ±Ø§ÙƒØ§Øª (Ù…Ø§ÙŠÙƒ ÙˆÙƒØ§Ù…ÙŠØ±Ø§)
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('callOverlay').style.display = 'none';
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯
    clearInterval(callTimerInterval);
    callSeconds = 0;
    document.getElementById('callTimer').innerText = "00:00";
}
function toggleMic() {
    if (!localStream) return;
    const audioTrack = localStream.getAudioTracks()[0];
    
    if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        const btn = document.getElementById('btnMute');
        
        // ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
        if (audioTrack.enabled) {
            btn.classList.remove('active'); // Ø±Ø¬Ø¹ Ø´ÙØ§Ù (Ø§Ù„Ù…Ø§ÙŠÙƒ Ø´ØºØ§Ù„)
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        } else {
            btn.classList.add('active'); // Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ (Ù…ÙƒØªÙˆÙ…)
            btn.innerHTML = '<i class="fa-solid fa-microphone-slash" style="color:#000"></i>';
        }
    }
}

async function toggleCam() {
    const videoContainer = document.getElementById('videoContainer');
    const audioInfo = document.getElementById('audioInfo');
    const btn = document.getElementById('btnCam');

    if (!localStream) return;
    let videoTrack = localStream.getVideoTracks()[0];

    if (videoTrack) {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        videoTrack.stop();
        localStream.removeTrack(videoTrack);
        
        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        videoContainer.style.display = 'none';
        audioInfo.style.display = 'flex';
        btn.classList.remove('active'); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„
        btn.innerHTML = '<i class="fa-solid fa-video-slash"></i>';
    } else {
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        try {
            const newStream = await navigator.mediaDevices.getUserMedia({ video: true });
            const newTrack = newStream.getVideoTracks()[0];
            localStream.addTrack(newTrack);
            
            document.getElementById('localVideo').srcObject = localStream;
            
            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            videoContainer.style.display = 'block';
            audioInfo.style.display = 'none';
            btn.classList.add('active'); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ†
            btn.innerHTML = '<i class="fa-solid fa-video"></i>';
        } catch (e) { 
            showToast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); 
        }
    }
}


// 5. ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø£Ù…Ø§Ù…ÙŠØ©/Ø®Ù„ÙÙŠØ©)
async function switchCamera() {
    if (!localStream) return;
    const currentTrack = localStream.getVideoTracks()[0];
    if (!currentTrack) return;

    const currentSettings = currentTrack.getSettings();
    const newMode = currentSettings.facingMode === 'user' ? 'environment' : 'user';

    currentTrack.stop();
    localStream.removeTrack(currentTrack);

    try {
        const newStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: { exact: newMode } } 
        });
        const newTrack = newStream.getVideoTracks()[0];
        localStream.addTrack(newTrack);
        document.getElementById('localVideo').srcObject = localStream;
    } catch (e) {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† exact Ø¥Ø°Ø§ ÙØ´Ù„
        const simpleStream = await navigator.mediaDevices.getUserMedia({ video: true });
        const simpleTrack = simpleStream.getVideoTracks()[0];
        localStream.addTrack(simpleTrack);
        document.getElementById('localVideo').srcObject = localStream;
    }
}

// 6. Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
async function shareScreen() {
    try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const screenTrack = screenStream.getVideoTracks()[0];
        
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ
        document.getElementById('localVideo').srcObject = screenStream;
        
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©" Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ØªØµÙØ­
        screenTrack.onended = () => {
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø£Ùˆ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
            toggleCam(); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        };
        
        document.getElementById('btnShare').classList.add('active');
    } catch (e) {
        console.error(e);
    }
}

// 7. Ø²Ø± Ø§Ù„Ø³Ø¨ÙŠÙƒØ± (ØªØ¨Ø¯ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙ‚Ø· Ù„Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø®Ø±Ø¬)
function toggleSpeaker() {
    const btn = document.getElementById('btnSpeaker');
    btn.classList.toggle('active');
    // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø®Ø±Ø¬ Ø§Ù„ØµÙˆØª (Output Device) ÙŠØªØ·Ù„Ø¨ setSinkId ÙˆÙ‡Ùˆ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
}

// Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª
function startCallTimer() {
    clearInterval(callTimerInterval);
    callSeconds = 0;
    callTimerInterval = setInterval(() => {
        callSeconds++;
        const m = Math.floor(callSeconds / 60).toString().padStart(2, '0');
        const s = (callSeconds % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').innerText = `${m}:${s}`;
    }, 1000);
}
/* ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù†ÙŠÙ† ÙˆØ§Ù„Ø±Ø¨Ø· Ø¨Ù€ Firebase ================= */

// 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙÙˆØ± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
// (Ø¶Ø¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ initGroupChat)
function listenForGroupCalls() {
    if (!groupId) return;

    // Ù†Ø³ØªÙ…Ø¹ Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©
    db.collection('chats').doc(groupId).collection('calls').doc('active_call')
        .onSnapshot(doc => {
            const incomingUI = document.getElementById('incomingGroupCall');
            const ringtone = document.getElementById('groupRingTone');

            // Ø£) Ø¥Ø°Ø§ ØªÙ… Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if (doc.exists) {
                const data = doc.data();

                // Ø´Ø±Ø· Ù…Ù‡Ù…: Ø§Ù„Ù…ØªØµÙ„ Ù„ÙŠØ³ Ø£Ù†Ø§ + Ø£Ù†Ø§ Ù„Ø³Øª Ù…Ù†Ø¶Ù…Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                if (data.callerId !== currentUser.uid && document.getElementById('callOverlay').style.display === 'none') {
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙ„
                    document.getElementById('incomingCallerName').innerText = data.callerName;
                    document.getElementById('incomingCallerAvatar').style.backgroundImage = `url('${data.callerPic || defaultAvatar}')`;
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ù†ÙŠÙ† ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
                    incomingUI.style.display = 'flex';
                    ringtone.play().catch(e => console.log("Ringtone blocked"));
                    
                    // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ù‡Ø§ØªÙ
                    if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
                }
            } 
            // Ø¨) Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
            else {
                // Ø¥ØºÙ„Ø§Ù‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ù†ÙŠÙ†
                incomingUI.style.display = 'none';
                ringtone.pause();
                ringtone.currentTime = 0;
                
                // Ù„Ùˆ Ø£Ù†Ø§ ÙƒÙ†Øª ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©ØŒ Ù†Ù‚ÙÙ„Ù‡Ø§
                if (document.getElementById('callOverlay').style.display === 'flex') {
                    endGroupCall(false); // false ØªØ¹Ù†ÙŠ Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø°ÙˆÙØ© Ø£ØµÙ„Ø§Ù‹
                }
            }
        });
}

// 2. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¨Ø§Ù‚ÙŠÙ†)
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© startGroupCall Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ø£Ùˆ Ø¹Ø¯Ù„Ù‡Ø§
async function startGroupCall(type) {
    // ... (Ù†ÙØ³ ÙƒÙˆØ¯ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§) ...
    // ... Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ ÙØªØ­ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ØŒ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ Firebase:

    // 1. ÙØªØ­ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    const overlay = document.getElementById('callOverlay');
    overlay.style.display = 'flex';
    // ... ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ (localStream) ...

    // 2. ğŸ”¥ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø³ÙŠØ±ÙØ± ğŸ”¥
    try {
        await db.collection('chats').doc(groupId).collection('calls').doc('active_call').set({
            callerId: currentUser.uid,
            callerName: currentUser.displayName || "Ø¹Ø¶Ùˆ Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©",
            callerPic: currentUser.photoURL || defaultAvatar,
            type: type, // audio or video
            status: 'ringing',
            startTime: firebase.firestore.FieldValue.serverTimestamp(),
            participants: [currentUser.uid] // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¶Ù…ÙŠÙ†
        });
    } catch (e) {
        console.error("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©", e);
    }
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø®Ø¶Ø±)
async function joinGroupCall() {
    // ÙˆÙ‚Ù ØµÙˆØª Ø§Ù„Ø±Ù†ÙŠÙ†
    const ringtone = document.getElementById('groupRingTone');
    ringtone.pause();
    ringtone.currentTime = 0;
    document.getElementById('incomingGroupCall').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ù†ÙŠÙ†

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ (Offer) Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    const callDoc = await db.collection('chats').doc(groupId).collection('calls').doc(callDocId).get();
    if (!callDoc.exists) return;
    const callData = callDoc.data();

    // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø¹Ù†Ø¯ÙŠ
    const constraints = {
        audio: true,
        video: callData.callType === 'video' // Ù†Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ Ù„Ùˆ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ
    };

    try {
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const overlay = document.getElementById('callOverlay');
        overlay.style.display = 'flex';
        
        if (callData.callType === 'video') {
            document.getElementById('videoContainer').style.display = 'block';
            document.getElementById('localVideo').srcObject = localStream;
        }

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
        peerConnection = new RTCPeerConnection(rtcConfig);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª (ICE Candidates)
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.collection('chats').doc(groupId).collection('call_candidates').add(event.candidate.toJSON());
            }
        };

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
        peerConnection.ontrack = (event) => {
            const remoteVid = document.getElementById('remoteVideo');
            remoteVid.srcObject = event.streams[0];
        };

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±Ø§ÙƒØ§Øª
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // 3. Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ (Offer)
        const offerDescription = new RTCSessionDescription({ type: 'offer', sdp: callData.sdp });
        await peerConnection.setRemoteDescription(offerDescription);

        // 4. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø¯ (Answer)
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // 5. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await db.collection('chats').doc(groupId).collection('calls').doc(callDocId).update({
            answer: { type: 'answer', sdp: answer.sdp },
            status: 'connected', // Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªØµÙ„
            receiverId: currentUser.uid // Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø±Ø¯
        });

        // Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        listenForRemoteCandidates();
        startCallTimer(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯

    } catch (err) {
        console.error("Error joining call:", err);
    }
}

// 1. Ø§Ù„Ù…ØªØµÙ„ Ø¨ÙŠØ³Ù…Ø¹ Ø§Ù„Ø±Ø¯ (Answer)
function listenForAnswer() {
    db.collection('chats').doc(groupId).collection('calls').doc(callDocId)
        .onSnapshot(snapshot => {
            const data = snapshot.data();
            if (data && data.answer && !peerConnection.currentRemoteDescription) {
                const answerDescription = new RTCSessionDescription(data.answer);
                peerConnection.setRemoteDescription(answerDescription);
                
                // Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¨Ø¯Ø£Øª!
                document.getElementById('callStatusText').innerText = "Ù…ØªØµÙ„";
                startCallTimer();
                listenForRemoteCandidates(); // Ù†Ø¨Ø¯Ø£ Ù†Ø³Ù…Ø¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
            }
        });
}

// 2. Ø§Ù„Ø·Ø±ÙÙŠÙ† Ø¨ÙŠØ³Ù…Ø¹ÙˆØ§ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© (ICE Candidates)
function listenForRemoteCandidates() {
    db.collection('chats').doc(groupId).collection('call_candidates')
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                if (change.type === 'added') {
                    const candidate = new RTCIceCandidate(change.doc.data());
                    if (peerConnection) {
                        try {
                            await peerConnection.addIceCandidate(candidate);
                        } catch (e) {
                            console.error("Error adding candidate", e);
                        }
                    }
                }
            });
        });
}

// 4. Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù„Ù„Ù…Ù†Ø¶Ù… (Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©)
async function startGroupCallJoinerMode() {
    const overlay = document.getElementById('callOverlay');
    overlay.style.display = 'flex';
    document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...";

    try {
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        localStream = stream;
        document.getElementById('localVideo').srcObject = stream;
        
        // Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³ÙŠ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await db.collection('chats').doc(groupId).collection('calls').doc('active_call').update({
            participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });

        startCallTimer();

    } catch (e) {
        showToast("ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…");
        document.getElementById('callOverlay').style.display = 'none';
    }
}

// 5. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø§Ù‡Ù„ (Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ù†ÙŠÙ†)
function ignoreGroupCall() {
    document.getElementById('incomingGroupCall').style.display = 'none';
    document.getElementById('groupRingTone').pause();
}

// 6. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ (End Call)
async function endGroupCall() {
    // 1. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ…Ø§ÙŠÙƒ)
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }

    // 2. Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebRTC
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }

    // 3. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯
    document.getElementById('callOverlay').style.display = 'none';
    clearInterval(callTimerInterval);
    document.getElementById('callTimer').innerText = "00:00";

    // 4. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² (Ø§Ù„Ù…ØªØµÙ„ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙ…Ø³Ø­)
    // Ø¨Ù†Ø­Ø§ÙˆÙ„ Ù†Ù…Ø³Ø­ØŒ Ù„Ùˆ Ù…Ø´ Ø¥Ø­Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø¹Ø§Ù…Ù„ÙŠÙ† Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ø´ Ù…Ø´ÙƒÙ„Ø©
    try {
        await db.collection('chats').doc(groupId).collection('calls').doc(callDocId).delete();
        
        // Ù…Ø³Ø­ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª (Candidates) Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø¬Ø§ÙŠØ© ØªØ¨Ø¯Ø£ Ù†Ø¸ÙŠÙØ©
        const candidates = await db.collection('chats').doc(groupId).collection('call_candidates').get();
        const batch = db.batch();
        candidates.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        
    } catch (e) {
        console.log("Call already ended or cleanup error");
    }
}

// Ù…ØªØºÙŠØ± Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« (Debounce)
let searchDebounceTimer;

async function performGroupSearch(query) {
    const list = document.getElementById('searchResultsList');
    
    if (!query || query.trim() === '') {
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#666;"><i class="fa-solid fa-comments" style="font-size:40px; margin-bottom:10px;"></i><br>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>';
        return;
    }

    clearTimeout(searchDebounceTimer);

    searchDebounceTimer = setTimeout(async () => {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--verify-color);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... <i class="fa-solid fa-circle-notch fa-spin"></i></div>';

        try {
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            const snapshot = await db.collection("chats").doc(groupId).collection("messages")
                .orderBy("createdAt", "desc")
                .get();

            let resultsHTML = '';
            let count = 0;
            const lowerQuery = query.toLowerCase();

            snapshot.forEach(doc => {
                const msg = doc.data();
                
                
                if (msg.type === 'text' && msg.text.toLowerCase().includes(lowerQuery)) {
                    count++;
                    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
                    const highlightedText = msg.text.replace(new RegExp(`(${query})`, 'gi'), 
                        `<span style="background:rgba(139, 92, 246, 0.3); color:#fff; padding:0 2px;">$1</span>`
                    );
                    
                    const time = msg.createdAt ? moment(msg.createdAt.toDate()).format('DD/MM - h:mm A') : '';

                    resultsHTML += `
                    <div class="msg-row" onclick="jumpToMessage('${doc.id}')" style="cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05); padding:10px; width:100%;">
                        <div style="display:flex; gap:10px; align-items:center; width:100%;">
                            <div style="width:35px; height:35px; border-radius:50%; background-image:url('${msg.senderPic || defaultAvatar}'); background-size:cover;"></div>
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="color:var(--gold-color); font-size:12px;">${msg.senderName}</span>
                                    <span style="color:#666; font-size:10px;">${time}</span>
                                </div>
                                <div style="color:#ccc; font-size:13px;">${highlightedText}</div>
                            </div>
                        </div>
                    </div>`;
                }
            });

            list.innerHTML = count > 0 ? resultsHTML : '<div style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';

        } catch (e) {
            console.error(e);
            list.innerHTML = '<div style="text-align:center; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>';
        }
    }, 600);
}

function jumpToMessage(id) {
    document.getElementById('fullSearchOverlay').style.display = 'none';
    const el = document.getElementById('msg_' + id);
    if(el) {
        el.scrollIntoView({behavior: "smooth", block: "center"});
        el.style.transition = "0.5s";
        el.style.background = "rgba(139, 92, 246, 0.2)";
        setTimeout(() => el.style.background = "transparent", 2000);
    } else {
        showToast("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØµØ¹ÙˆØ¯ Ù„Ø£Ø¹Ù„Ù‰");
    }
}

function closeSearchMode() {
    document.getElementById('fullSearchOverlay').style.display = 'none';
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Index)
async function openGroupGallery() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    toggleSidebar();
    
    const overlay = document.getElementById('mediaGalleryOverlay');
    const container = document.getElementById('galleryContent');
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ¯Ø±
    overlay.classList.add('active');
    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#fff;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px;"></i><br>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    try {
        // 3. Ø¬Ù„Ø¨ Ø¢Ø®Ø± 100 Ø±Ø³Ø§Ù„Ø© (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ÙˆØ¹ Ø¹Ø´Ø§Ù† Ù…Ù†Ø¹Ù…Ù„Ø´ Ù…Ø´Ø§ÙƒÙ„ Index)
        const snap = await db.collection("chats").doc(groupId).collection("messages")
            .orderBy("createdAt", "desc")
            .limit(100) 
            .get();

        container.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ¯Ø±
        
        let mediaFound = false;

        // 4. Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ø¥Ø­Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø®ØªØ§Ø± Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø³)
        snap.forEach(doc => {
            const d = doc.data();
            
            // Ø§Ù„Ø´Ø±Ø·: Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ
            if (d.type === 'image' || d.type === 'video') {
                mediaFound = true;
                let itemHtml = '';

                if (d.type === 'image') {
                    itemHtml = `
                        <div class="gallery-item" onclick="openProViewer('${d.text}', 'image')">
                            <img src="${d.text}" loading="lazy">
                        </div>`;
                } else {
                    itemHtml = `
                        <div class="gallery-item" onclick="openProViewer('${d.text}', 'video')">
                            <video src="${d.text}#t=0.5" preload="metadata"></video>
                            <div class="vid-icon-overlay"><i class="fa-solid fa-video"></i></div>
                        </div>`;
                }
                
                container.insertAdjacentHTML('beforeend', itemHtml);
            }
        });

        // Ù„Ùˆ Ù…ÙÙŠØ´ ÙˆÙ„Ø§ ØµÙˆØ±Ø© ÙˆÙ„Ø§ ÙÙŠØ¯ÙŠÙˆ
        if (!mediaFound) {
            container.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; color:#666; padding:50px;">
                    <i class="fa-regular fa-images" style="font-size:40px; margin-bottom:10px;"></i>
                    <br>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ø·
                </div>`;
        }

    } catch (e) {
        console.error("Gallery Error:", e);
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø§Ù„Ø³Ø¨Ø¨ Ù„Ùˆ Ø­ØµÙ„ ØªØ§Ù†ÙŠ
        container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red; padding:20px;">
            Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹<br>
            <span style="font-size:10px; color:#aaa;">${e.message}</span>
        </div>`;
    }
}

// Ø§Ø±Ø¨Ø· Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø²Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar)
function launchConfetti() {
    const colors = ['#FFD700', '#ff4081', '#00e5ff', '#ffffff'];
    for (let i = 0; i < 50; i++) {
        const div = document.createElement('div');
        div.style.position = 'fixed';
        div.style.left = '50%';
        div.style.top = '50%';
        div.style.width = '8px';
        div.style.height = '8px';
        div.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        div.style.borderRadius = '50%';
        div.style.zIndex = '9999';
        document.body.appendChild(div);

        const x = (Math.random() - 0.5) * window.innerWidth;
        const y = (Math.random() - 0.5) * window.innerHeight;

        div.animate([
            { transform: 'translate(0,0)', opacity: 1 },
            { transform: `translate(${x}px, ${y}px)`, opacity: 0 }
        ], { duration: 1000 + Math.random() * 1000 }).onfinish = () => div.remove();
    }
}

// Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ renderMessageUI ÙÙŠ Ø¬Ø²Ø¡ Ø§Ù„Ù‡Ø¯ÙŠØ© (gift) Ù„ÙŠØµØ¨Ø­:
// onclick="launchConfetti()"
function openProViewer(url, type) {
    const viewer = document.getElementById('proViewer');
    const content = document.getElementById('mediaContent');
    viewer.style.display = 'flex';
    
    if(type === 'image') {
        content.innerHTML = `<img src="${url}" style="max-width:100%; max-height:80vh; box-shadow:0 0 20px rgba(0,0,0,0.5);">`;
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± ØªØ­ÙƒÙ… Ù…Ø®ØµØµØ©
        content.innerHTML = `
            <div style="position:relative; width:100%; max-width:600px;">
                <video id="mainVideoPlayer" src="${url}" style="width:100%; max-height:80vh;" autoplay></video>
                <div style="display:flex; justify-content:center; gap:20px; margin-top:10px;">
                    <button class="icon-btn" onclick="document.getElementById('mainVideoPlayer').currentTime -= 10"><i class="fa-solid fa-rotate-right"></i> -10</button>
                    <button class="icon-btn" onclick="togglePlayVideo()"><i class="fa-solid fa-pause" id="vidPlayIcon"></i></button>
                    <button class="icon-btn" onclick="document.getElementById('mainVideoPlayer').currentTime += 10"><i class="fa-solid fa-rotate-left"></i> +10</button>
                    <button class="icon-btn" onclick="downloadMedia('${url}')"><i class="fa-solid fa-download"></i></button>
                </div>
            </div>`;
    }
}

function togglePlayVideo() {
    const v = document.getElementById('mainVideoPlayer');
    const icon = document.getElementById('vidPlayIcon');
    if(v.paused) { v.play(); icon.className = 'fa-solid fa-pause'; }
    else { v.pause(); icon.className = 'fa-solid fa-play'; }
}

function downloadMedia(url) {
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.download = 'Wareed_Media';
    a.click();
}
// Ø¶Ø¹ Ù‡Ø°Ø§ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener('beforeunload', () => {
    if(isGhostMode) {
        // Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø¨Ø­ Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ÙƒØªÙ†Ø¸ÙŠÙ Ù„Ù„Ø°Ø§ÙƒØ±Ø©)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ­ØªØ§Ø¬ Ù…Ù†Ø·Ù‚ server-side Ø£Ùˆ Ø¯Ø§Ù„Ø© cleanup
    }
});

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ÙŠ Ø§Ù„Ø´Ø¨Ø­ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø§Øª
async function purgeMyGhostMessages() {
    const snap = await db.collection("chats").doc(groupId).collection("messages")
        .where('uid', '==', currentUser.uid)
        .where('isGhost', '==', true)
        .get();
    
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    showToast("ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø£Ø«Ø± Ø§Ù„Ø´Ø¨Ø­ ğŸ’¨");
}
// Ø§Ø±Ø¨Ø· Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶
// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Index)
async function openGroupGallery() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    toggleSidebar();
    
    const overlay = document.getElementById('mediaGalleryOverlay');
    const container = document.getElementById('galleryContent');
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ¯Ø±
    overlay.classList.add('active');
    container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#fff;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px;"></i><br>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    try {
        // 3. Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù‡Ù†Ø¬ÙŠØ¨ Ø¢Ø®Ø± 100 Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· Ø§Ù„Ù†ÙˆØ¹ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Error)
        const snap = await db.collection("chats").doc(groupId).collection("messages")
            .orderBy("createdAt", "desc")
            .limit(100) 
            .get();

        container.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ¯Ø±
        
        let mediaFound = false;

        // 4. Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ø¥Ø­Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø®ØªØ§Ø± Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø³ Ù…Ù† ÙˆØ³Ø· Ø§Ù„Ø±Ø³Ø§ÙŠÙ„)
        snap.forEach(doc => {
            const d = doc.data();
            
            // Ø§Ù„Ø´Ø±Ø·: Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ
            if (d.type === 'image' || d.type === 'video') {
                mediaFound = true;
                let itemHtml = '';

                if (d.type === 'image') {
                    itemHtml = `
                        <div class="gallery-item" onclick="openProViewer('${d.text}', 'image')">
                            <img src="${d.text}" loading="lazy">
                        </div>`;
                } else {
                    itemHtml = `
                        <div class="gallery-item" onclick="openProViewer('${d.text}', 'video')">
                            <video src="${d.text}#t=0.5" preload="metadata"></video>
                            <div class="vid-icon-overlay"><i class="fa-solid fa-video"></i></div>
                        </div>`;
                }
                
                container.insertAdjacentHTML('beforeend', itemHtml);
            }
        });

        // Ù„Ùˆ Ù…ÙÙŠØ´ ÙˆÙ„Ø§ ØµÙˆØ±Ø© ÙˆÙ„Ø§ ÙÙŠØ¯ÙŠÙˆ ÙˆØ³Ø· Ø§Ù„Ù€ 100 Ø±Ø³Ø§Ù„Ø©
        if (!mediaFound) {
            container.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; color:#666; padding:50px;">
                    <i class="fa-regular fa-images" style="font-size:40px; margin-bottom:10px;"></i>
                    <br>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ø· Ø­Ø¯ÙŠØ«Ø©
                </div>`;
        }

    } catch (e) {
        console.error("Gallery Error:", e);
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø§Ù„Ø³Ø¨Ø¨ Ù„Ùˆ Ø­ØµÙ„ ØªØ§Ù†ÙŠ
        container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:red; padding:20px;">
            Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹<br>
            <span style="font-size:10px; color:#aaa;">${e.message}</span>
        </div>`;
    }
}


function launchConfetti() {
    // Ø£Ù„ÙˆØ§Ù† Ù…Ù„ÙƒÙŠØ© (Ø°Ù‡Ø¨ÙŠØŒ Ø¨Ù†ÙØ³Ø¬ÙŠØŒ Ø£Ø²Ø±Ù‚)
    const colors = ['#FFD700', '#8b5cf6', '#38bdf8', '#ffffff']; 
    
    for (let i = 0; i < 60; i++) {
        const div = document.createElement('div');
        div.style.position = 'fixed';
        div.style.left = '50%';
        div.style.top = '50%';
        div.style.width = Math.random() * 8 + 4 + 'px';
        div.style.height = Math.random() * 8 + 4 + 'px';
        div.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        div.style.borderRadius = '50%';
        div.style.zIndex = '10000';
        div.style.pointerEvents = 'none';
        document.body.appendChild(div);

        // Ø­Ø±ÙƒØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙÙŠ ÙƒÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª
        const x = (Math.random() - 0.5) * window.innerWidth;
        const y = (Math.random() - 0.5) * window.innerHeight;
        const rot = Math.random() * 360;

        div.animate([
            { transform: 'translate(0,0) rotate(0deg)', opacity: 1 },
            { transform: `translate(${x}px, ${y}px) rotate(${rot}deg)`, opacity: 0 }
        ], { 
            duration: 1500 + Math.random() * 1000, 
            easing: 'cubic-bezier(0.25, 1, 0.5, 1)' 
        }).onfinish = () => div.remove();
    }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·: Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ù„Ø© renderMessageUI
// ÙˆÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ if (msg.type === 'gift') 
// ØºÙŠØ± Ø§Ù„Ù€ div Ù„ÙŠØµØ¨Ø­: <div onclick="launchConfetti()">...</div>
const sounds = {
    sent: new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg'),
    click: new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg'),
    notification: new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3')
};

function playSound(type) {
    if(sounds[type]) {
        sounds[type].currentTime = 0;
        
        // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø®Ù„ÙŠÙ†Ø§Ù‡Ø§ 1.0 Ø¨Ø¯Ù„ 0.5 (ÙŠØ¹Ù†ÙŠ ØµÙˆØª ÙƒØ§Ù…Ù„)
        sounds[type].volume = 1.0; 
        
        sounds[type].play().catch(()=>{});
    }
}


// Ø§Ù„Ø¢Ù† Ø£Ø¶Ù playSound('sent') Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© sendMessage
// ÙˆØ£Ø¶Ù playSound('click') Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
function launchConfetti() {
    // 1. ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙØ±Ø­ (Ù„Ùˆ Ø§Ù„ØµÙˆØª Ù…ØªØ§Ø­)
    const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
    audio.volume = 0.5;
    audio.play().catch(()=>{});

    // 2. Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);

    // 3. Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ
    const colors = ['#FFD700', '#8b5cf6', '#38bdf8', '#ffffff']; 
    
    // Ø¥Ù†Ø´Ø§Ø¡ 60 Ù‚ØµØ§ØµØ© ÙˆØ±Ù‚
    for (let i = 0; i < 60; i++) {
        const div = document.createElement('div');
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©)
        div.style.position = 'fixed';
        div.style.left = '50%';
        div.style.top = '50%';
        div.style.width = Math.random() * 8 + 4 + 'px';
        div.style.height = Math.random() * 8 + 4 + 'px';
        div.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        div.style.borderRadius = '50%';
        div.style.zIndex = '10000';
        div.style.pointerEvents = 'none';
        document.body.appendChild(div);

        // Ø­Ø³Ø§Ø¨ Ù…ÙƒØ§Ù† Ø§Ù„Ù‡Ø¨ÙˆØ· Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        const x = (Math.random() - 0.5) * window.innerWidth;
        const y = (Math.random() - 0.5) * window.innerHeight;
        const rot = Math.random() * 360;

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø±ÙƒØ© (Animate)
        const animation = div.animate([
            { transform: 'translate(0,0) rotate(0deg) scale(1)', opacity: 1 },
            { transform: `translate(${x}px, ${y}px) rotate(${rot}deg) scale(0.5)`, opacity: 0 }
        ], { 
            duration: 1500 + Math.random() * 1000, 
            easing: 'cubic-bezier(0.25, 1, 0.5, 1)' 
        });

        // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©
        animation.onfinish = () => div.remove();
    }
}

function openMagicGift(elementId) {
    const box = document.getElementById(elementId);
    if (!box || box.classList.contains('opened')) return;

    box.classList.add('opened');

    const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg");
    
    // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø§Ù„ØµÙˆØª 100%
    audio.volume = 1.0; 
    
    audio.play().catch(()=>{});

    if(typeof launchConfetti === 'function') launchConfetti();
    if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
}


// ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶
// ================= Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ù†Ø³Ø®Ø© Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Index) =================
async function openGroupGallery() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ø§Ù„Ù…Ø¹Ø±Ø¶
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('sidebarOverlay').classList.remove('active');

    const overlay = document.getElementById('mediaGalleryOverlay');
    const container = document.getElementById('galleryContent');
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    overlay.classList.add('active');
    container.innerHTML = '<div style="grid-column:1/-1; height:300px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px; margin-bottom:10px;"></i><span>Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª...</span></div>';

    try {
        // 3. (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø­Ø±ÙŠ) Ù†Ø¬ÙŠØ¨ Ø¢Ø®Ø± 100 Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
        // Ø´Ù„Ù†Ø§ Ø´Ø±Ø· .where Ø¹Ø´Ø§Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù…ÙŠØ·Ù„Ø¨Ø´ Index ÙˆÙŠÙˆÙ‚Ù Ø§Ù„ÙƒÙˆØ¯
        const snap = await db.collection("chats").doc(groupId).collection("messages")
            .orderBy("createdAt", "desc")
            .limit(100) 
            .get();

        container.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ¯Ø±
        let mediaFound = false;

        // 4. Ø§Ø­Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ù†Ù‚ÙˆÙ… Ø¨Ø¯ÙˆØ± "Ø§Ù„ÙÙ‡Ø±Ø³Ø©" Ø¨Ù†ÙØ³Ù†Ø§
        // Ø¨Ù†Ø¹Ø¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ ÙˆÙ†Ù†Ù‚ÙŠ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø³
        snap.forEach(doc => {
            const d = doc.data();
            
            // Ø§Ù„Ø´Ø±Ø·: Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆØŸ
            if (d.type === 'image' || d.type === 'video') {
                mediaFound = true;
                let itemHtml = '';

                if(d.type === 'image') {
                    itemHtml = `
                        <div class="gallery-item" onclick="openProViewer('${d.text}', 'image')">
                            <img src="${d.text}" loading="lazy">
                        </div>`;
                } else {
                    itemHtml = `
                        <div class="gallery-item" onclick="openProViewer('${d.text}', 'video')">
                            <video src="${d.text}#t=0.5" preload="metadata"></video>
                            <div class="vid-icon-overlay"><i class="fa-solid fa-video"></i></div>
                        </div>`;
                }
                
                container.insertAdjacentHTML('beforeend', itemHtml);
            }
        });

        // 5. Ù„Ùˆ Ù…Ù„Ù‚ÙŠÙ†Ø§Ø´ ÙˆÙ„Ø§ ØµÙˆØ±Ø© ÙˆÙ„Ø§ ÙÙŠØ¯ÙŠÙˆ
        if (!mediaFound) {
            container.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; color:#666; padding:50px;">
                    <i class="fa-regular fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i>
                    <br>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ø· Ø­Ø¯ÙŠØ«Ø©
                </div>`;
        }

    } catch (e) {
        console.error("Gallery Error:", e);
        container.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--danger-color);">Ø­Ø¯Ø« Ø®Ø·Ø£: ${e.message}</div>`;
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø±Ø¶
function closeGallery() {
    document.getElementById('mediaGalleryOverlay').classList.remove('active');
}

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
async function deleteMessage() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    closeContextMenu();

    if (!selectedMsg || !selectedMsg.id) return;

    // 2. Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ØªØ§Ø¹ØªÙŠ (Ø£Ù†Ø§ Ø§Ù„Ù…Ø±Ø³Ù„)
    if (selectedMsg.data.uid !== currentUser.uid) {
        showToast("â›” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†");
        return;
    }

    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
        try {
            // 3. Ø§Ù„Ø­Ø°Ù Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³
            await db.collection('chats').doc(groupId).collection('messages').doc(selectedMsg.id).delete();
            
            // 4. Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ (Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙŠØ­Ø³Ø´ Ø¨Ø¨Ø·Ø¡)
            const msgRow = document.getElementById(`msg_${selectedMsg.id}`);
            if (msgRow) {
                msgRow.style.transition = "0.5s";
                msgRow.style.opacity = "0";
                msgRow.style.transform = "scale(0.8)";
                setTimeout(() => msgRow.remove(), 500);
            }
            
            showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸");
        } catch (e) {
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
        }
    }
}

// ØªØ´ØºÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©
function initTypingListener() {
    // 1. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ
    const input = document.getElementById('msgInput');
    let typingTimeout;

    input.addEventListener('input', () => {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙŠ Ø£Ù†ÙŠ Ø¨ÙƒØªØ¨
        db.collection('chats').doc(groupId).update({
            typing: firebase.firestore.FieldValue.arrayUnion(currentUser.displayName)
        });

        // Ù…Ø³Ø­ Ø­Ø§Ù„ØªÙŠ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            db.collection('chats').doc(groupId).update({
                typing: firebase.firestore.FieldValue.arrayRemove(currentUser.displayName)
            });
        }, 2000);
    });

    // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² (Ù…ÙŠÙ† Ø¨ÙŠÙƒØªØ¨ØŸ)
    db.collection('chats').doc(groupId).onSnapshot(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        const typingArr = data.typing || [];
        
        // Ø´ÙŠÙ„ Ø§Ø³Ù…ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¹Ø´Ø§Ù† Ù…Ø¸Ù‡Ø±Ø´ Ù„Ù†ÙØ³ÙŠ)
        const othersTyping = typingArr.filter(name => name !== currentUser.displayName);
        
        const subtitle = document.getElementById('headerMemberCount');
        
        if (othersTyping.length > 0) {
            // Ù„Ùˆ Ø­Ø¯ Ø¨ÙŠÙƒØªØ¨
            const text = othersTyping.length === 1 
                ? `${othersTyping[0]} ÙŠÙƒØªØ¨...` 
                : `${othersTyping.length} Ø£Ø¹Ø¶Ø§Ø¡ ÙŠÙƒØªØ¨ÙˆÙ†...`;
            
            subtitle.innerHTML = `<span style="color:#00e5ff; font-weight:bold;">${text}</span>`;
        } else {
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ø­Ø¯ Ø¨ÙŠÙƒØªØ¨ -> Ø±Ø¬Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
            const count = data.users ? data.users.length : 0;
            subtitle.innerHTML = `<i class="fa-solid fa-users" style="font-size:10px;"></i> ${count} Ø£Ø¹Ø¶Ø§Ø¡`;
        }
    });
}

// ğŸ”¥ Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø¬ÙˆÙ‡ Ø¯Ø§Ù„Ø© initGroupChat Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„ Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­
// initTypingListener();

const chatBox = document.getElementById("chatContainer");
const scrollBtn = document.getElementById("scrollToBottomBtn");

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
chatBox.addEventListener("scroll", () => {
    // Ù„Ùˆ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ†ÙŠ ÙˆØ¨ÙŠÙ† ØªØ­Øª Ø£ÙƒØªØ± Ù…Ù† 300 Ø¨ÙƒØ³Ù„ -> Ø£Ø¸Ù‡Ø± Ø§Ù„Ø²Ø±Ø§Ø±
    const distance = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight;
    
    if (distance > 300) {
        scrollBtn.style.display = "flex";
    } else {
        scrollBtn.style.display = "none";
    }
});

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø²ÙˆÙ„
function scrollToBottom() {
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
}
async function endGroupCall(shouldDeleteDoc = true) {
    // 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('callOverlay').style.display = 'none';
    clearInterval(callTimerInterval);
    callSeconds = 0;
    document.getElementById('callTimer').innerText = "00:00";
    
    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
    if (shouldDeleteDoc) {
        const docRef = db.collection('chats').doc(groupId).collection('calls').doc('active_call');
        const doc = await docRef.get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Ù„Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© -> Ø§Ø­Ø°ÙÙ‡Ø§ ÙˆØ³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø´Ø§Øª
            if (data.callerId === currentUser.uid) {
                await docRef.delete();
                
                // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© "Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª" ÙÙŠ Ø§Ù„Ø´Ø§Øª ğŸ”¥
                sendMessage({
                    type: 'text',
                    text: `ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© Ø§Ù†ØªÙ‡Øª (Ø§Ù„Ù…Ø¯Ø©: ${formatTimeSec(callSeconds)})`,
                    isSystem: true // Ø¹Ø´Ø§Ù† Ù†Ù…ÙŠØ²Ù‡Ø§ ÙÙŠ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ù„Ùˆ Ø­Ø¨ÙŠØª
                });
                
            } else {
                // Ù„Ùˆ Ø£Ù†Ø§ Ù…Ø´Ø§Ø±Ùƒ Ø¨Ø³ -> Ø§Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                await docRef.update({
                    participants: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
            }
        }
    }
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ·ÙˆØ± (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù€ prompt Ø§Ù„Ù‚Ø¯ÙŠÙ…)
function toggleSearchMode() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    toggleSidebar();
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø«
    const overlay = document.getElementById('fullSearchOverlay');
    const input = document.getElementById('fullSearchInput');
    const list = document.getElementById('searchResultsList');
    
    if (overlay) {
        overlay.style.display = 'flex';
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ…
        input.value = '';
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#666;"><i class="fa-solid fa-comments" style="font-size:40px; margin-bottom:10px;"></i><br>Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>';
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆØ±Ø§Ù‹
        setTimeout(() => input.focus(), 100);
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« (Ù„Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹)
function closeSearchMode() {
    document.getElementById('fullSearchOverlay').style.display = 'none';
}

function toggleGhostMode() {
    // 1. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    isGhostMode = !isGhostMode;
    
    // 2. ØªØºÙŠÙŠØ± ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¬Ø³Ù… (Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªØªØºÙŠØ±)
    document.body.classList.toggle('ghost-active');
    
    // 3. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„ØªØ£Ø«ÙŠØ±
    toggleSidebar();
    
    // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±
    if (isGhostMode) {
        playSound('destruct'); // ØµÙˆØª ØªØ´ÙˆÙŠÙ‚
        showToast("ğŸ‘» ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ (Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¤Ù‚ØªØ©)");
    } else {
        // Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù: Ù†Ø¸Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        purgeMyGhostMessages();
        showToast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø«Ø± ğŸ›¡ï¸");
    }
}

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ (ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ + Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡)
function toggleGhostMode() {
    // 1. Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
    isGhostMode = !isGhostMode;
    
    // 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ ÙÙˆØ±Ø§Ù‹ (Ø£Ø³ÙˆØ¯/Ø£Ø¨ÙŠØ¶)
    if (isGhostMode) {
        document.body.classList.add('ghost-active');
        showToast("ğŸ‘» ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­");
        playSound('destruct'); // ØµÙˆØª ØªØ´ÙˆÙŠÙ‚
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„"
        sendGhostSystemMessage(true);
        
    } else {
        document.body.classList.remove('ghost-active');
        showToast("ğŸ›¡ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­");
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"
        sendGhostSystemMessage(false);
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        purgeMyGhostMessages();
    }
    
    // 3. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    toggleSidebar();
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
async function sendGhostSystemMessage(isActive) {
    if (!chatId || !currentUserId) return;

    const text = isActive ? "Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ‘»" : "Ù‚Ø§Ù… Ø¨Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ ğŸ›¡ï¸";

    try {
        await db.collection("chats").doc(chatId).collection("messages").add({
            type: 'system',       // Ù†ÙˆØ¹ Ø®Ø§Øµ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù†Øµ
            text: text,
            uid: currentUserId,   // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„ ÙƒØ¯Ù‡
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            seen: false,
            isGhost: false        // Ù†Ø®Ù„ÙŠÙ‡Ø§ false Ø¹Ø´Ø§Ù† Ù…ØªØªÙ…Ø³Ø­Ø´ ÙˆØªÙØ¶Ù„ ÙƒØ¯Ù„ÙŠÙ„
        });
    } catch (e) {
        console.error("Error sending system msg:", e);
    }
}

// 1. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„Ù…ØµØ­Ø­Ø©)
function previewGroupImage(input) {
    if (input.files && input.files[0]) {
        newGroupImageFile = input.files[0]; // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ø±ÙØ¹Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Settings Overlay)
            const editImgEl = document.getElementById('gEditImg');
            if(editImgEl) {
                editImgEl.style.backgroundImage = `url('${e.target.result}')`;
                editImgEl.innerHTML = ''; // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            }

            // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙŠØ¶Ø§Ù‹
            const infoImgEl = document.getElementById('gInfoImg');
            if(infoImgEl) {
                infoImgEl.style.backgroundImage = `url('${e.target.result}')`;
                infoImgEl.innerHTML = ''; 
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}
// ================= Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµÙ„Ø­Ø©) =================
async function saveGroupSettings() {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    const nameInput = document.getElementById('editGroupName');
    const descInput = document.getElementById('editGroupDesc');
    const passInput = document.getElementById('editGroupPass');
    const lockCheck = document.getElementById('checkLockChat');
    const privateCheck = document.getElementById('checkPrivateGroup');

    const name = nameInput ? nameInput.value.trim() : "";
    const desc = descInput ? descInput.value.trim() : "";
    const pass = passInput ? passInput.value.trim() : "";
    const isLocked = lockCheck ? lockCheck.checked : false;
    const isPrivate = privateCheck ? privateCheck.checked : false;

    // Ø§Ù„ØªØ­Ù‚Ù‚
    if (!name) return showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");

    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸... â³");

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«
    let updateData = {
        name: name,
        description: desc,
        isLocked: isLocked,
        isPrivate: isPrivate
    };

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
    if (myRole === 'owner' && pass !== "") {
        updateData.groupPassword = pass;
    }

    try {
        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© (Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©)
        if (typeof newGroupImageFile !== 'undefined' && newGroupImageFile) {
            const ref = storage.ref(`group_avatars/${groupId}_${Date.now()}`);
            await ref.put(newGroupImageFile);
            const url = await ref.getDownloadURL();
            updateData.groupImage = url;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
            document.getElementById('headerGroupImg').style.backgroundImage = `url('${url}')`;
            newGroupImageFile = null; // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±
        }

        // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
        await db.collection('chats').doc(groupId).update(updateData);
        
        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
        document.getElementById('headerGroupName').innerText = name;
        if(document.getElementById('gInfoNameDisplay')) {
            document.getElementById('gInfoNameDisplay').innerText = name;
            document.getElementById('gInfoDescDisplay').innerText = desc || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
        }

        showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
        closeGroupSettings(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©

    } catch (e) {
        console.error("Save Error:", e);
        showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + e.message);
    }
}

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø±ØªØ¨ ÙˆÙ‚ÙˆØªÙ‡Ø§ (ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯ Ø§Ù„Ø±Ù‚Ù… Ø²Ø§Ø¯Øª Ø§Ù„Ù‚ÙˆØ©)
const ROLE_POWER = {
    'owner': 5,
    'co-owner': 4,
    'admin': 3,
    'vip': 2,
    'member': 1
};

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
let myRole = 'member';
let myPower = 1;

// 1. ÙØªØ­ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
// ================= 1. Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© =================
async function openGroupInfo() {
    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Toggle)
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('sidebarOverlay').classList.remove('active');

    const overlay = document.getElementById('groupInfoOverlay');
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    if(overlay.parentNode !== document.body) document.body.appendChild(overlay);
    
    overlay.style.display = 'flex';
    
    // Ù„ÙˆØ¯Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById('groupMembersList').innerHTML = '<div style="text-align:center; padding:20px; color:var(--gold-color);"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    try {
        const doc = await db.collection('chats').doc(groupId).get();
        if (!doc.exists) return;
        const data = doc.data();
        const roles = data.roles || {};
        const ownerId = data.createdBy;

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if (currentUser.uid === ownerId) myRole = 'owner';
        else myRole = roles[currentUser.uid] || 'member';
        
        myPower = ROLE_POWER[myRole] || 1;

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('gInfoNameDisplay').innerText = data.name;
        document.getElementById('gInfoDescDisplay').innerText = data.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";
        document.getElementById('gInfoCount').innerText = data.users ? data.users.length : 0;
        
        // Ø§Ù„ØµÙˆØ±Ø©
        const imgEl = document.getElementById('gInfoImg');
        if (data.groupImage) {
            imgEl.style.backgroundImage = `url('${data.groupImage}')`;
            imgEl.innerHTML = '';
        } else {
            imgEl.style.backgroundImage = 'none';
            imgEl.innerHTML = '<i class="fa-solid fa-users"></i>';
        }

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        const editIcon = document.getElementById('editGroupIcon');
        editIcon.style.display = (myPower >= 3) ? 'block' : 'none';

        // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø£Ùˆ Ù„Ùˆ Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø¹Ø§Ù…
        const addBtn = document.getElementById('btnAddMemberAction');
        const isPrivate = data.isPrivate || false;
        if (myPower >= 3 || !isPrivate) {
            addBtn.style.display = 'flex';
        } else {
            addBtn.style.display = 'none';
        }

        loadGroupMembersWithRoles(data.users || [], roles, ownerId);

    } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }
}

// 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ø±ØªØ¨
async function loadGroupMembersWithRoles(userIds, rolesMap, ownerId) {
    const list = document.getElementById('groupMembersList');
    list.innerHTML = '';

    // ÙØ±Ø² Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†...)
    // Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù…ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù†ÙØ³ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    const promises = userIds.map(async (uid) => {
        let userData = { uid, name: 'Ù…Ø³ØªØ®Ø¯Ù…', pic: null, verified: false, bio: '' };
        try {
            const snap = await db.collection('users').doc(uid).get();
            if (snap.exists) {
                const d = snap.data();
                userData.name = d.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                userData.pic = d.profilePic || d.avatar;
                userData.verified = d.isVerified;
                userData.bio = d.bio || "";
            } else if(uid === currentUser.uid) {
                userData.name = currentUser.displayName;
                userData.pic = currentUser.photoURL;
            }
        } catch(e){}
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±ØªØ¨Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ
        let role = (uid === ownerId) ? 'owner' : (rolesMap[uid] || 'member');
        let power = ROLE_POWER[role];
        
        return { ...userData, role, power };
    });

    let users = await Promise.all(promises);

    // ØªØ±ØªÙŠØ¨: Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø£ÙƒØ¨Ø± Ø£ÙˆÙ„Ø§Ù‹
    users.sort((a, b) => b.power - a.power);

    users.forEach(u => {
        const isMe = u.uid === currentUser.uid;
        
        // Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø±ØªØ¨Ø©
        let badgeHtml = '';
        if(u.role === 'owner') badgeHtml = '<span class="role-badge role-owner">Ø§Ù„Ù…Ø§Ù„Ùƒ ğŸ‘‘</span>';
        else if(u.role === 'co-owner') badgeHtml = '<span class="role-badge role-co-owner">Ù†Ø§Ø¦Ø¨ ğŸ›¡ï¸</span>';
        else if(u.role === 'admin') badgeHtml = '<span class="role-badge role-admin">Ù…Ø´Ø±Ù ğŸ‘®â€â™‚ï¸</span>';
        else if(u.role === 'vip') badgeHtml = '<span class="role-badge role-vip">Ù…Ù…ÙŠØ² ğŸŒŸ</span>';

        const imgHtml = u.pic 
            ? `<div class="member-img" style="background-image:url('${u.pic}')"></div>`
            : `<div class="member-img" style="background:#333; display:grid; place-items:center;">${u.name[0]}</div>`;

        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·: Ù†ÙØªØ­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±ØªØ¨ØªÙŠ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø±ØªØ¨ØªÙ‡
        // Ø£Ùˆ Ø£Ù†Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù‚ÙˆØªÙŠ 5)
        const canManage = (myPower > u.power) && !isMe; 
        const clickAction = canManage ? `openRoleManager('${u.uid}', '${u.name}', '${u.role}')` : '';

        list.innerHTML += `
        <div class="member-card" onclick="${clickAction}" style="${clickAction?'cursor:pointer':''}">
            ${imgHtml}
            <div style="flex:1;">
                <div style="color:#fff; font-weight:bold; font-size:14px; display:flex; align-items:center;">
                    ${isMe ? 'Ø£Ù†Øª' : u.name}
                    ${u.verified ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; margin-right:4px; font-size:12px;"></i>' : ''}
                    <span style="margin-right:auto; margin-left:10px;">${badgeHtml}</span>
                </div>
                <div style="color:#888; font-size:11px;">${u.bio || (isMe?'Ù…ØªØµÙ„':'')}</div>
            </div>
            ${canManage ? '<i class="fa-solid fa-ellipsis-vertical" style="color:#555; padding:0 10px;"></i>' : ''}
        </div>`;
    });
}


// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ù‚ÙÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function resetInfoUI() {
    document.getElementById('gInfoNameInput').classList.add('locked-input');
    document.getElementById('gInfoNameInput').setAttribute('readonly', true);
    
    document.getElementById('gInfoDescInput').classList.add('locked-input');
    document.getElementById('gInfoDescInput').setAttribute('readonly', true);
    
    document.getElementById('camBadge').style.display = 'none';
    document.getElementById('saveGroupBtn').style.display = 'none';
    document.getElementById('editGroupBtn').style.display = 'none';
}

// ================= 2. ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·) =================
function enableGroupEditing() {
    if (!amIAdmin) return;

    document.getElementById('gInfoNameInput').classList.remove('locked-input');
    document.getElementById('gInfoNameInput').removeAttribute('readonly');
    document.getElementById('gInfoNameInput').focus();

    document.getElementById('gInfoDescInput').classList.remove('locked-input');
    document.getElementById('gInfoDescInput').removeAttribute('readonly');

    document.getElementById('camBadge').style.display = 'flex';
    document.getElementById('saveGroupBtn').style.display = 'block';
    document.getElementById('editGroupBtn').style.display = 'none';
    
    showToast("âœï¸ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆØµÙ ÙˆØ§Ù„ØµÙˆØ±Ø©");
}

// ================= 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© =================
async function loadGroupMembersWithPowers(userIds, admins, ownerId) {
    const list = document.getElementById('groupMembersList');
    list.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    // ØªØ¬Ù‡ÙŠØ² Ù…ØµÙÙˆÙØ© Ø§Ù„ÙˆØ¹ÙˆØ¯ (Promises) Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³Ø±Ø¹Ø©
    const promises = userIds.map(async (uid) => {
        let userData = { 
            uid: uid, 
            name: 'Ù…Ø³ØªØ®Ø¯Ù…', 
            pic: null, 
            verified: false, 
            email: '' 
        };

        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† ÙƒÙˆÙ„ÙƒØ´Ù† users
            const doc = await db.collection('users').doc(uid).get();
            if (doc.exists) {
                const d = doc.data();
                userData.name = d.name || d.displayName || 'Ù…Ø³ØªØ®Ø¯Ù…';
                // Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø£ÙŠ Ø§Ø³Ù…
                userData.pic = d.profilePic || d.avatar || d.image || d.photoURL;
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆØ«ÙŠÙ‚
                userData.verified = (d.isVerified === true || d.verified === true);
                userData.email = d.email || '';
            } else if (uid === currentUser.uid) {
                // Ù„Ùˆ Ø§Ù„Ø¹Ø¶Ùˆ Ù‡Ùˆ Ø£Ù†Ø§ ÙˆÙ…Ù„ÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
                userData.name = currentUser.displayName;
                userData.pic = currentUser.photoURL;
            }
        } catch (e) { console.error(e); }

        return userData;
    });

    // Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù…ÙŠØ¹
    const users = await Promise.all(promises);

    // Ø±Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØª
    users.forEach(u => {
        const isMe = u.uid === currentUser.uid;
        const isTargetOwner = u.uid === ownerId;
        const isTargetAdmin = admins.includes(u.uid);

        // Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø±ØªØ¨
        let rankBadge = '';
        if (isTargetOwner) {
            rankBadge = '<span style="color:#FFD700; background:rgba(255, 215, 0, 0.1); font-size:10px; border:1px solid #FFD700; padding:2px 6px; border-radius:6px; margin-right:5px;">Ù…Ø§Ù„Ùƒ</span>';
        } else if (isTargetAdmin) {
            rankBadge = '<span style="color:#ccc; background:rgba(255, 255, 255, 0.1); font-size:10px; border:1px solid #ccc; padding:2px 6px; border-radius:6px; margin-right:5px;">Ù…Ø´Ø±Ù</span>';
        }

        // Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡)
        const verifyBadge = u.verified ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:14px; margin-right:4px;" title="Ù…ÙˆØ«Ù‚"></i>' : '';

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
        let imgHtml = '';
        if (u.pic) {
            imgHtml = `<div class="member-img" style="background-image:url('${u.pic}'); background-size:cover;"></div>`;
        } else {
            // Ø­Ø±Ù Ø£ÙˆÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø©
            const char = u.name ? u.name.charAt(0).toUpperCase() : '?';
            const color = isTargetOwner ? '#FFD700' : '#555'; // Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ù„Ù…Ø§Ù„Ùƒ
            imgHtml = `<div class="member-img" style="background:${color}; color:${isTargetOwner?'#000':'#fff'}; display:grid; place-items:center; font-weight:bold; font-size:18px;">${char}</div>`;
        }

        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ ÙŠØ­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· (ÙØªØ­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·)
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ù…Øª Ø¨Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù€ Quote Escaping Ù‡Ù†Ø§
        const safeName = u.name.replace(/'/g, "\\'"); // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ ÙÙŠÙ‡ ÙØ§ØµÙ„Ø© Ø¹Ù„ÙŠØ§
        const clickAction = (!isMe && (amIAdmin || amIOwner)) ? `openMemberOptions('${u.uid}', '${safeName}', ${isTargetAdmin}, ${isTargetOwner})` : '';

        const html = `
        <div class="member-card" onclick="${clickAction}" style="${clickAction ? 'cursor:pointer' : ''}">
            ${imgHtml}
            <div style="flex:1;">
                <div style="color:#fff; font-weight:bold; font-size:15px; display:flex; align-items:center;">
                    ${isMe ? 'Ø£Ù†Øª' : u.name} 
                    <span style="margin-right:5px;">${verifyBadge}</span>
                    <span style="margin-right:auto; margin-left:0;">${rankBadge}</span>
                </div>
                <div style="color:#888; font-size:11px; margin-top:3px;">
                    ${u.email ? u.email : (isMe ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©')}
                </div>
            </div>
            ${(clickAction) ? '<i class="fa-solid fa-ellipsis-vertical" style="color:#555; padding:0 10px;"></i>' : ''}
        </div>`;

        list.innerHTML += html;
    });
}

// ================= 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (ØªØ±Ù‚ÙŠØ©/Ø·Ø±Ø¯) =================
let selectedMemberId = null;

function openMemberOptions(uid, name, isAdmin, isTargetOwner) {
    // Ø­Ù…Ø§ÙŠØ©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ø£Ø­Ø¯ Ø§Ù„Ù…Ø³Ø§Ø³ Ø¨Ø§Ù„Ù…Ø§Ù„Ùƒ
    if (isTargetOwner) {
        showToast("ğŸ‘‘ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡ Ø¶Ø¯ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
        return;
    }

    selectedMemberId = uid;
    const modal = document.getElementById('memberOptionsModal');
    const content = document.getElementById('memberOptionsContent');
    
    modal.classList.add('active');
    content.classList.add('active');

    let actionsHtml = `<h3 style="color:var(--gold-color); margin-bottom:15px; text-align:center;">Ø¥Ø¯Ø§Ø±Ø©: ${name}</h3>`;

    // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø· (ØªØ±Ù‚ÙŠØ©/ØªÙ†Ø²ÙŠÙ„ Ù…Ø´Ø±ÙÙŠÙ†)
    // Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© openMemberOptions
// ...
    // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·
    if (amIOwner) {
        // Ø²Ø± Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ)
        actionsHtml += `
        <button class="admin-action-btn" style="color:var(--gold-color); border-color:var(--gold-color);" onclick="transferOwnership('${uid}', '${name}')">
            <i class="fa-solid fa-crown"></i> ØªØ¹ÙŠÙŠÙ† ÙƒÙ…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯
        </button>`;
        
        // Ø¨Ø§Ù‚ÙŠ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø´Ø±Ø§Ù...
        if (isAdmin) {
             // ... Ø²Ø± ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±Ù
        } else {
             // ... Ø²Ø± ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù
        }
    }
// ...


    // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (Ø§Ù„Ø·Ø±Ø¯)
    actionsHtml += `
        <button class="admin-action-btn text-danger" onclick="removeMember('${uid}', '${name}')">
            <i class="fa-solid fa-user-xmark"></i> Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        </button>
        <button class="admin-action-btn" onclick="closeMemberOptions()">
            Ø¥Ù„ØºØ§Ø¡
        </button>
    `;

    content.innerHTML = actionsHtml;
}

function closeMemberOptions() {
    document.getElementById('memberOptionsModal').classList.remove('active');
    document.getElementById('memberOptionsContent').classList.remove('active');
}

// ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ±Ù‚ÙŠØ©/Ø§Ù„ØªÙ†Ø²ÙŠÙ„
async function toggleAdminStatus(uid, makeAdmin) {
    closeMemberOptions();
    try {
        await db.collection('chats').doc(groupId).update({
            admins: makeAdmin ? firebase.firestore.FieldValue.arrayUnion(uid) : firebase.firestore.FieldValue.arrayRemove(uid)
        });
        showToast(makeAdmin ? "ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø´Ø±Ù ğŸ‘®â€â™‚ï¸" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø´Ø±Ø§Ù");
        openGroupInfo(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    } catch (e) {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ø±Ø¯
// Ø¯Ø§Ù„Ø© Ø·Ø±Ø¯ Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
async function removeMember(uid, name) {
    closeMemberOptions();

    // ğŸ”¥ Ù†Ø§ÙØ°Ø© Ø·Ø±Ø¯ Ø­Ù…Ø±Ø§Ø¡ Ø§Ø­ØªØ±Ø§ÙÙŠØ©
    const isConfirmed = await TopicAS.confirm({
        title: "Ø·Ø±Ø¯ Ø¹Ø¶Ùˆ",
        text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© <b>${name}</b> Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`,
        type: "danger", // Ù„ÙˆÙ† Ø£Ø­Ù…Ø± ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© ØªØ­Ø°ÙŠØ±
        btnText: "Ù†Ø¹Ù…ØŒ Ø·Ø±Ø¯"
    });

    if (!isConfirmed) return;

    try {
        await db.collection('chats').doc(groupId).update({
            users: firebase.firestore.FieldValue.arrayRemove(uid),
            admins: firebase.firestore.FieldValue.arrayRemove(uid)
        });
        
        sendMessage({
            type: 'system',
            text: `Ù‚Ø§Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ø·Ø±Ø¯ ${name} ğŸš«`
        });

        showToast("ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ø¹Ø¶Ùˆ ğŸ‘‹");
        playSound('destruct'); // ØµÙˆØª Ù…Ù…ÙŠØ² Ù„Ù„Ø·Ø±Ø¯
        openGroupInfo(); 
    } catch (e) {
        showToast("ÙØ´Ù„ Ø§Ù„Ø·Ø±Ø¯");
    }
}


// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeGroupInfo() {
    document.getElementById('groupInfoOverlay').style.display = 'none';
}
// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ù‡ÙŠ Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØªØ­Ø· ÙÙŠ Ø§Ù„Ù€ onclick ÙÙŠ Ø§Ù„Ù€ HTML)
function leaveGroup() {
    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ù…ÙØªÙˆØ­Ø©
    document.getElementById('sidebar').classList.remove('active');
    document.getElementById('sidebarOverlay').classList.remove('active');
    if(document.getElementById('menuSheet')) document.getElementById('menuSheet').classList.remove('active');
    if(document.getElementById('groupInfoOverlay')) document.getElementById('groupInfoOverlay').style.display = 'none';

    // ğŸ”¥ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØµØ§Ø±Ù…: Ù‡Ù„ Ø£Ù†Ø§ Ø§Ù„Ù…Ø§Ù„ÙƒØŸ
    if (currentUser.uid === currentGroupOwnerId) {
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø®Ø·Ø£
        const errorSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        errorSound.play().catch(()=>{});

        showToast("â›” Ø£Ù†Øª Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©! Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©.");
        
        // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ø§Ù„Ùƒ Ø¬Ø¯ÙŠØ¯
        setTimeout(() => {
            showToast("ğŸ‘‘ Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø¹Ø¶Ùˆ Ø¢Ø®Ø± ÙƒÙ…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡");
            openGroupInfo(); // ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹
        }, 1500);
        
        return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
    }

    // Ù„Ùˆ Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠØŒ Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
    const modal = document.getElementById('leaveConfirmModal');
    modal.classList.add('active');
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ­Ø°ÙŠØ±ÙŠ Ø®ÙÙŠÙ
    if(navigator.vibrate) navigator.vibrate(50);
}

// 2. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeLeaveModal() {
    document.getElementById('leaveConfirmModal').classList.remove('active');
}

// 3. Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ù†Ø¹Ù…")
async function confirmLeaveAction() {
    closeLeaveModal();
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©... ğŸ‘‹");

    try {
        // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…ØµÙÙˆÙØ© users Ùˆ admins
        await db.collection('chats').doc(groupId).update({
            users: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            admins: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù… Ø¨Ø£Ù† Ø§Ù„Ø¹Ø¶Ùˆ ØºØ§Ø¯Ø±
        await db.collection("chats").doc(groupId).collection("messages").add({
            type: 'system',
            text: `ØºØ§Ø¯Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ğŸ‘‹`,
            senderName: "Ø§Ù„Ù†Ø¸Ø§Ù…", // Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            uid: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            seen: false, 
            isGhost: false
        });

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª ÙˆØ¯Ø§Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const byeSound = new Audio("https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg");
        byeSound.volume = 0.3;
        byeSound.play().catch(()=>{});

        // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
        setTimeout(() => { window.location.href = "index.html"; }, 1000);

    } catch (e) {
        console.error("Leave Error:", e);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„");
    }
}


// 1. ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
async function addNewMember() {
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„
    document.getElementById('groupInfoOverlay').style.display = 'none'; 
    
    const modal = document.getElementById('addMemberModal');
    document.body.appendChild(modal); // Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± ÙÙˆÙ‚ Ø§Ù„Ø¬Ù…ÙŠØ¹
    modal.style.display = 'flex';
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    selectedUsersToAdd.clear();
    updateAddButtonState();
    document.getElementById('memberSearchInput').value = '';
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    await loadPotentialMembers();
}

// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeAddMemberModal() {
    document.getElementById('addMemberModal').style.display = 'none';
    // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    document.getElementById('groupInfoOverlay').style.display = 'flex';
}

// 3. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ÙŠØ³ØªØ«Ù†ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹)
async function loadPotentialMembers() {
    const container = document.getElementById('addMembersListContainer');
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gold-color);"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

    try {
        // Ø£) Ø¬Ù„Ø¨ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ù…
        const groupDoc = await db.collection('chats').doc(groupId).get();
        const existingUsers = groupDoc.data().users || [];

        // Ø¨) Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø«Ø§Ù„: Ø¢Ø®Ø± 50 Ù…Ø³ØªØ®Ø¯Ù…)
        // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ù„Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Friends Collection
        const usersSnap = await db.collection('users').limit(50).get();

        allPotentialUsers = [];
        usersSnap.forEach(doc => {
            if (doc.id !== currentUser.uid && !existingUsers.includes(doc.id)) {
                const d = doc.data();
                allPotentialUsers.push({
                    uid: doc.id,
                    name: d.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                    pic: d.profilePic || d.avatar,
                    isVerified: d.isVerified
                });
            }
        });

        renderSelectableMembers(allPotentialUsers);

    } catch (e) {
        container.innerHTML = '<div style="text-align: center; color: #ff4444;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>';
    }
}

// 4. Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function renderSelectableMembers(users) {
    const container = document.getElementById('addMembersListContainer');
    container.innerHTML = '';

    if (users.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø¯Ø¯ Ù„Ù„Ø¥Ø¶Ø§ÙØ©</div>`;
        return;
    }

    users.forEach(u => {
        const isSelected = selectedUsersToAdd.has(u.uid);
        const imgStyle = u.pic ? `background-image:url('${u.pic}')` : `background:#333; display:grid; place-items:center; color:#fff; font-weight:bold;`;
        const imgContent = u.pic ? '' : u.name[0];

        const html = `
        <div class="select-member-card ${isSelected ? 'selected' : ''}" onclick="toggleUserSelection('${u.uid}', this)">
            <div class="member-img" style="${imgStyle}">${imgContent}</div>
            <div style="flex:1;">
                <div style="color:#fff; font-weight:bold; font-size:14px;">
                    ${u.name} ${u.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:12px;"></i>' : ''}
                </div>
                <div style="color:#666; font-size:11px;">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
            </div>
            <div class="checkbox-circle">
                <i class="fa-solid fa-check"></i>
            </div>
        </div>`;
        container.innerHTML += html;
    });
}

// 5. ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¶Ùˆ
function toggleUserSelection(uid, element) {
    if (selectedUsersToAdd.has(uid)) {
        selectedUsersToAdd.delete(uid);
        element.classList.remove('selected');
    } else {
        selectedUsersToAdd.add(uid);
        element.classList.add('selected');
    }
    updateAddButtonState();
}

// 6. ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
function updateAddButtonState() {
    const btn = document.getElementById('btnAddSelected');
    const count = selectedUsersToAdd.size;
    btn.innerText = `Ø¥Ø¶Ø§ÙØ© (${count})`;
    
    if (count > 0) {
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
        btn.style.cursor = 'pointer';
    } else {
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
    }
}

// 7. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function filterAddMembersList(query) {
    const q = query.toLowerCase();
    const filtered = allPotentialUsers.filter(u => u.name.toLowerCase().includes(q));
    renderSelectableMembers(filtered);
}

// 8. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Bulk Add)
async function executeBulkAdd() {
    if (selectedUsersToAdd.size === 0) return;

    const count = selectedUsersToAdd.size;

    // ğŸ”¥ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const isConfirmed = await TopicAS.confirm({
        title: "ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡",
        text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© <span style="color:var(--gold-color); font-weight:bold;">${count}</span> Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø¯Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ`,
        type: "add",
        btnText: "Ù†Ø¹Ù…ØŒ Ø£Ø¶ÙÙ‡Ù…"
    });
    
    // Ø¥Ø°Ø§ Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡ØŒ ÙŠÙˆÙ‚Ù Ø§Ù„ÙƒÙˆØ¯ ÙÙˆØ±Ø§Ù‹
    if (!isConfirmed) return; 

    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¢Ù†
    closeAddMemberModal();
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©... â³");

    try {
        const batchArray = Array.from(selectedUsersToAdd);
        
        await db.collection('chats').doc(groupId).update({
            users: firebase.firestore.FieldValue.arrayUnion(...batchArray)
        });

        await sendMessage({
            type: 'system',
            text: `ØªÙ… Ø¥Ø¶Ø§ÙØ© ${count} Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø¯Ø¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ğŸ‰`
        });

        showToast("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­");
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù†Ø¬Ø§Ø­
        playSound('sent');
        
        openGroupInfo(); 

    } catch (e) {
        console.error(e);
        showToast("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }
}


// ================= Ù…Ù†Ø·Ù‚ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =================
let proUpdateInterval = null;
const proSpeedLevels = [1.0, 1.5, 2.0, 0.5];
let proCurrentSpeedIndex = 0;

// 1. ÙØªØ­ Ø§Ù„Ù…Ø´ØºÙ„
function openProPlayer(url) {
    const modal = document.getElementById('proVideoModal');
    const video = document.getElementById('proMainVideo');
    
    // Ù†Ù‚Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„ØªÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    if (modal.parentNode !== document.body) document.body.appendChild(modal);

    modal.style.display = 'flex';
    video.src = url;
    video.load();
    video.play();
    
    updateProPlayIcon(true);
    startProProgressLoop();
}

// 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´ØºÙ„
function closeProPlayer() {
    const modal = document.getElementById('proVideoModal');
    const video = document.getElementById('proMainVideo');
    
    video.pause();
    video.src = ""; // ØªÙØ±ÙŠØº Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    modal.style.display = 'none';
    
    if (proUpdateInterval) clearInterval(proUpdateInterval);
}

// 3. ØªØ´ØºÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù
function toggleProPlay() {
    const video = document.getElementById('proMainVideo');
    if (video.paused) {
        video.play();
        updateProPlayIcon(true);
    } else {
        video.pause();
        updateProPlayIcon(false);
    }
}

function updateProPlayIcon(isPlaying) {
    const icon = document.querySelector('#proPlayBtn i');
    icon.className = isPlaying ? "fa-solid fa-pause" : "fa-solid fa-play";
}

// 4. Ø­Ù„Ù‚Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· ÙˆØ§Ù„ÙˆÙ‚Øª
function startProProgressLoop() {
    if (proUpdateInterval) clearInterval(proUpdateInterval);
    
    proUpdateInterval = setInterval(() => {
        const video = document.getElementById('proMainVideo');
        if (!video.duration) return;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ·
        const pct = (video.currentTime / video.duration) * 100;
        document.getElementById('proProgressBar').style.width = pct + "%";
        document.getElementById('proProgressKnob').style.left = pct + "%";
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
        document.getElementById('proTimeDisplay').innerText = 
            formatTimeSec(video.currentTime) + " / " + formatTimeSec(video.duration);

        if (video.ended) updateProPlayIcon(false);
    }, 100);
}

// 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± (ØªÙ‚Ø¯ÙŠÙ…ØŒ ØªØ£Ø®ÙŠØ±ØŒ Ø³Ø±Ø¹Ø©ØŒ ØªØ­Ù…ÙŠÙ„)
function skipProVideo(val) {
    const video = document.getElementById('proMainVideo');
    video.currentTime += val;
}

function cycleSpeed() {
    const video = document.getElementById('proMainVideo');
    proCurrentSpeedIndex = (proCurrentSpeedIndex + 1) % proSpeedLevels.length;
    video.playbackRate = proSpeedLevels[proCurrentSpeedIndex];
    document.getElementById('speedBtn').innerText = proSpeedLevels[proCurrentSpeedIndex] + "x";
}

function downloadProVideo() {
    const video = document.getElementById('proMainVideo');
    const a = document.createElement('a');
    a.href = video.src;
    a.download = `Video_${Date.now()}.mp4`;
    a.target = "_blank";
    document.body.appendChild(a);
    a.click();
    a.remove();
}

// Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ·
function seekProVideo(e) {
    const video = document.getElementById('proMainVideo');
    const area = document.getElementById('scrubArea');
    if(!video.duration) return;

    const rect = area.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const pct = x / rect.width;
    
    video.currentTime = pct * video.duration;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª (00:00)
function formatTimeSec(s) {
    if (isNaN(s)) return "00:00";
    let m = Math.floor(s / 60);
    let sec = Math.floor(s % 60);
    return m + ":" + (sec < 10 ? "0" : "") + sec;
}
// ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø§Ù„Ù…Ø·ÙˆØ± - Real API) =================
// ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ø·ÙˆØ± =================

const GiftSystem = {
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API Ù„Ù„Ù€ GIF (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ)
    apiConfig: {
        key: "LIVDSRZULELA", 
        clientKey: "RoyalApp",
        limit: 8 
    },

    data: {
        // Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ)
        gifts: [
            { name: 'ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ', emoji: 'ğŸ‘‘', price: 1000 },
            { name: 'Ø£Ù„Ù…Ø§Ø³', emoji: 'ğŸ’', price: 500 },
            { name: 'Ø³ÙŠØ§Ø±Ø©', emoji: 'ğŸï¸', price: 2000 },
            { name: 'ÙˆØ±Ø¯Ø©', emoji: 'ğŸŒ¹', price: 50 },
            { name: 'Ù‚Ù„Ø¨', emoji: 'â¤ï¸', price: 10 },
            { name: 'Ø´Ø¹Ù„Ø©', emoji: 'ğŸ”¥', price: 100 },
            { name: 'ØµØ§Ø±ÙˆØ®', emoji: 'ğŸš€', price: 300 },
            { name: 'ÙƒÙŠÙƒØ©', emoji: 'ğŸ‚', price: 200 },
            { name: 'Ø£Ø³Ø¯', emoji: 'ğŸ¦', price: 5000 }
        ],
        // Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ)
        stickers: [
            'ğŸ˜€','ğŸ˜‚','ğŸ˜','ğŸ˜','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰','ğŸ‘€','ğŸ‘»','ğŸ’€','ğŸ™ˆ',
            'ğŸ˜¹','ğŸ’©','ğŸ¤¡','ğŸ¤','ğŸ‘‹','ğŸ’ª','ğŸ§ ','ğŸ§œâ€â™‚ï¸','ğŸ§â€â™‚ï¸','ğŸ§Ÿ','ğŸ§šâ€â™€ï¸'
        ],
        // ğŸ”¥ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ØµØºÙŠØ±Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø© ğŸ”¥
        emojis: [
            "ğŸ˜‚", "â¤ï¸", "ğŸ˜­", "ğŸŒ¹", "ğŸ˜…", "ğŸ¥°", "ğŸ˜˜", "ğŸ˜Š", "ğŸ˜", "ğŸ‘",
            "ğŸ‰", "ğŸ”¥", "ğŸ’”", "ğŸ¤”", "ğŸ˜®", "ğŸ¥±", "ğŸ˜¡", "ğŸ˜¢", "ğŸ‘‹", "ğŸ™",
            "ğŸ‘€", "âœ¨", "ğŸ‘‘", "ğŸ’", "ğŸ¤£", "ğŸ¥º", "ğŸ˜", "ğŸ˜’", "ğŸ™„", "ğŸ¤",
            "ğŸ˜œ", "ğŸ¤—", "ğŸ¤«", "ğŸ¤¥", "ğŸ˜¶", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¬", "ğŸ˜ª", "ğŸ˜¯",
            "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜ˆ", "ğŸ‘¿", "ğŸ¤¡", "ğŸ’©", "ğŸ‘»", "ğŸ’€", "ğŸ‘½", "ğŸ‘¾",
            "ğŸ’‹", "ğŸ’˜", "ğŸ’", "ğŸ’–", "ğŸ’—", "ğŸ’“", "ğŸ’", "ğŸ’•", "ğŸ’Œ", "ğŸ’¤",
            "ğŸ’¢", "ğŸ’£", "ğŸ’¥", "ğŸ’¦", "ğŸ’¨", "ğŸ’«", "ğŸ’¬", "ğŸ—¨ï¸", "ğŸ—¯ï¸", "ğŸ’­",
            "ğŸ‘‹", "ğŸ¤š", "ğŸ–ï¸", "âœ‹", "ğŸ––", "ğŸ‘Œ", "ğŸ¤", "âœŒï¸", "ğŸ¤", "ğŸ¤Ÿ",
            "ğŸ¤˜", "ğŸ¤™", "ğŸ‘ˆ", "ğŸ‘‰", "ğŸ‘†", "ğŸ–•", "ğŸ‘‡", "â˜ï¸", "ğŸ‘", "ğŸ‘"
        ]
    },

    searchTimeout: null,

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    switch: function(tabName, element) {
        document.querySelectorAll('.gift-tab').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        const container = document.getElementById('giftSystemContent');
        container.innerHTML = '<div class="loader-spinner"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

        setTimeout(() => {
            if (tabName === 'gifts') this.renderGifts(container);
            // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            else if (tabName === 'emojis') this.renderEmojis(container); 
            else if (tabName === 'stickers') this.renderStickers(container);
            else if (tabName === 'gifs') {
                this.renderGIFsUI(container);
                this.fetchGIFs('');
            }
        }, 50); // ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø´ÙˆÙŠØ©
    },

    // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
    renderGifts: function(container) {
        let html = '<div class="premium-gift-grid">';
        this.data.gifts.forEach(g => {
            html += `
                <div class="premium-gift-card" onclick="GiftSystem.sendGift('${g.emoji}', '${g.name}', ${g.price})">
                    <div class="pg-emoji">${g.emoji}</div>
                    <div class="pg-name">${g.name}</div>
                    <div class="pg-price">${g.price} ğŸ’°</div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    },

    // ğŸ”¥ 2. Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ğŸ”¥
    renderEmojis: function(container) {
        let html = '<div class="emoji-keyboard-grid">';
        this.data.emojis.forEach(char => {
            // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¨Ù†Ø³ØªØ¯Ø¹ÙŠ Ø¯Ø§Ù„Ø© addEmojiToInput
            html += `<div class="emoji-key" onclick="GiftSystem.addEmojiToInput('${char}')">${char}</div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    },

    // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© ğŸ”¥
    addEmojiToInput: function(char) {
        const input = document.getElementById('msgInput');
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ
        input.value += char;
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„ÙÙˆØªØ± (Ø¹Ø´Ø§Ù† Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙŠØ¸Ù‡Ø± Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø¶ÙŠ)
        if(typeof handleChatTyping === 'function') {
            handleChatTyping(input);
        }
        
        // Ù†Ø¹Ù…Ù„ Focus Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ø§ÙŠØ² ÙŠÙƒÙ…Ù„ ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ø·ÙˆÙ„
        // input.focus(); 
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ Ø¹Ù…Ù„Ù†Ø§ focus Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù‡ØªØ·Ù„Ø¹ ÙˆØªØºØ·ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØŒ ÙØ§Ù„Ø£ÙØ¶Ù„ Ù†Ø³ÙŠØ¨Ù‡Ø§ ÙƒØ¯Ù‡ Ø¹Ø´Ø§Ù† ÙŠØ®ØªØ§Ø± Ø¨Ø±Ø§Ø­ØªÙ‡
    },

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª
    renderStickers: function(container) {
        let html = '<div class="sticker-grid">';
        this.data.stickers.forEach(s => {
            const url = `https://ui-avatars.com/api/?name=${s}&background=random&length=1&size=128&font-size=0.6`;
            html += `
                <div class="sticker-item" onclick="sendMessage({type:'sticker', text:'${url}'})">
                    ${s}
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    },

    // 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù€ GIF
    renderGIFsUI: function(container) {
        container.innerHTML = `
            <div style="position:relative; margin-bottom:10px;">
                <input type="text" class="gif-search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† GIF..." 
                    oninput="GiftSystem.handleSearch(this.value)" style="margin:0;">
                <i class="fa-solid fa-magnifying-glass" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#666;"></i>
            </div>
            <div id="gifResults" class="gif-grid"></div>
        `;
    },

    handleSearch: function(query) {
        clearTimeout(this.searchTimeout);
        const resultsDiv = document.getElementById('gifResults');
        resultsDiv.style.opacity = '0.5';
        this.searchTimeout = setTimeout(() => {
            this.fetchGIFs(query);
        }, 600);
    },

    fetchGIFs: async function(query) {
        const resultsDiv = document.getElementById('gifResults');
        let url = "";
        if(query.trim() === "") url = `https://g.tenor.com/v1/trending?key=${this.apiConfig.key}&limit=${this.apiConfig.limit}`;
        else url = `https://g.tenor.com/v1/search?q=${query}&key=${this.apiConfig.key}&limit=${this.apiConfig.limit}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            let html = '';
            if(data.results && data.results.length > 0) {
                data.results.forEach(gif => {
                    const gifUrl = gif.media[0].nanogif.url; 
                    const fullUrl = gif.media[0].gif.url;
                    html += `<img src="${gifUrl}" class="gif-item" loading="lazy" onclick="sendMessage({type:'image', text:'${fullUrl}'})">`;
                });
            } else {
                html = '<div style="text-align:center; padding:20px; color:#666; width:100%;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ğŸ¤·â€â™‚ï¸</div>';
            }
            resultsDiv.innerHTML = html;
            resultsDiv.style.opacity = '1';
        } catch (error) {
            resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
            resultsDiv.style.opacity = '1';
        }
    },

    sendGift: function(emoji, name, price) {
        document.getElementById('giftSheet').classList.remove('active');
        sendMessage({ 
            type: 'gift', 
            text: emoji, 
            giftName: name,
            giftPrice: price
        });
        const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/clank_car_crash.ogg');
        audio.volume = 0.5;
        audio.play().catch(()=>{});
    }
};


// ================= 1. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± =================

function handleChatTyping(textarea) {
    const btn = document.getElementById('dynamicBtn');
    
    // ğŸ”¥ Ø¯Ù‡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£Ø¨ Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø­Ø· Ø¹Ù„ÙŠÙ‡ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
    const footerContainer = document.getElementById('normalFooterUI');
    
    // 1. ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù„Ù„Ø£Ø¹Ù„Ù‰ (Auto Resize)
    textarea.style.height = 'auto'; 
    let newHeight = Math.min(textarea.scrollHeight, 120); 
    textarea.style.height = newHeight + 'px';

    const text = textarea.value.trim();

    // ==========================================
    // ğŸ”¥ Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ±: Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ† ğŸ”¥
    // ==========================================
    
    if (text.length > 0) {
        // --- ÙˆØ¶Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± + Ø²Ø± Ø¥Ø±Ø³Ø§Ù„) ---
        
        // 1. ØªÙØ¹ÙŠÙ„ ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ (Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙŠÙØ±Ø´)
        footerContainer.classList.add('typing'); 

        // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ø¥Ø±Ø³Ø§Ù„
        if (btn.classList.contains('mic-mode')) {
            btn.classList.remove('mic-mode');
            btn.classList.add('send-mode');
            btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            btn.onclick = () => sendMessage(); 
            
            // Ø¥Ø´Ø¹Ø§Ø± "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†"
            if(currentUser) {
                db.collection('chats').doc(groupId).update({
                    typing: firebase.firestore.FieldValue.arrayUnion(currentUser.displayName)
                });
            }
        }
    } else {
        // --- ÙˆØ¶Ø¹ Ø§Ù„ÙØ±Ø§Øº (Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± + Ø²Ø± Ù…Ø§ÙŠÙƒ) ---
        
        // 1. Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ±Ø¬Ø¹)
        footerContainer.classList.remove('typing');

        // 2. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø²Ø± Ù„Ù…Ø§ÙŠÙƒ
        if (btn.classList.contains('send-mode')) {
            btn.classList.remove('send-mode');
            btn.classList.add('mic-mode');
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
            btn.onclick = () => startRecording();
            
            textarea.style.height = '45px'; // ØªØµØºÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹
            
            // Ø¥ÙŠÙ‚Ø§Ù "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†"
            if(currentUser) {
                db.collection('chats').doc(groupId).update({
                    typing: firebase.firestore.FieldValue.arrayRemove(currentUser.displayName)
                });
            }
        }
    }
}

// ================= 2. ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯) =================

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
async function startRecording() {
    try {
        playSound('click'); 
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordingStream = stream;

        // --- ÙƒÙˆØ¯ ØªØ¶Ø®ÙŠÙ… Ø§Ù„ØµÙˆØª (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ) ---
        audioCtxRecording = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtxRecording.createMediaStreamSource(stream);
        const gainNode = audioCtxRecording.createGain();
        gainNode.gain.value = 2.5; 
        const destination = audioCtxRecording.createMediaStreamDestination();
        source.connect(gainNode);
        gainNode.connect(destination);
        mediaRecorder = new MediaRecorder(destination.stream);
        // ------------------------------------------

        audioChunks = [];
        
        // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        document.getElementById('normalFooterUI').style.display = 'none';
        document.getElementById('recordingUI').style.display = 'flex';
        
        // Ø§Ù„Ø¹Ø¯Ø§Ø¯
        let seconds = 0;
        clearInterval(recordInterval);
        document.getElementById('recordTimer').innerText = "00:00";
        
        recordInterval = setInterval(() => {
            seconds++;
            const m = Math.floor(seconds / 60).toString().padStart(2,'0');
            const s = (seconds % 60).toString().padStart(2,'0');
            document.getElementById('recordTimer').innerText = `${m}:${s}`;
        }, 1000);

        mediaRecorder.ondataavailable = e => {
            if(e.data.size > 0) audioChunks.push(e.data);
        };
        
        mediaRecorder.start();
        if(navigator.vibrate) navigator.vibrate(50); 

    } catch (e) { 
        console.error(e);
        showToast("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ğŸ¤"); 
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
function stopAndSendRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            // ğŸ”¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            clearInterval(recordInterval);
            document.getElementById('recordingUI').style.display = 'none';
            document.getElementById('normalFooterUI').style.display = 'flex';

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ±Ø§ÙƒØ§Øª
            if (recordingStream) recordingStream.getTracks().forEach(track => track.stop());
            if (audioCtxRecording) audioCtxRecording.close();

            const blob = new Blob(audioChunks, { type: 'audio/mp4' });
            showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª... ğŸ¤");
            
            const ref = storage.ref(`voice_notes/${Date.now()}.mp4`);
            try {
                await ref.put(blob);
                const url = await ref.getDownloadURL();
                // Ù†Ø±Ø³Ù„ Ø§Ù„Ù€ Payload Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                originalSendMessage({ type: 'audio', text: url });
                playSound('sent');
            } catch(e) {
                showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª âŒ");
            }
        };
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡
function cancelRecording() {
    if(mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    
    // ğŸ”¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    clearInterval(recordInterval);
    document.getElementById('recordingUI').style.display = 'none';
    document.getElementById('normalFooterUI').style.display = 'flex';

    if (recordingStream) recordingStream.getTracks().forEach(track => track.stop());
    if (audioCtxRecording) audioCtxRecording.close();
    
    showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ—‘ï¸");
}

function openQuickEmoji() {
    // 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
    const sheet = document.getElementById('giftSheet');
    sheet.classList.add('active');

    // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
    // (Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù†Ø¯ÙŠ: 0 Ù‡Ø¯Ø§ÙŠØ§ØŒ 1 Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)
    const tabs = document.querySelectorAll('.gift-tab');
    if(tabs[1]) {
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        GiftSystem.switch('emojis', tabs[1]);
    }
}

function initGroupChat() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ID Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    if (!groupId) return showToast("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù…Ø¬Ù…ÙˆØ¹Ø©");

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ù„Ù…Ø§Ù„ÙƒØŒ Ø§Ù„ÙˆØµÙ)
    db.collection('chats').doc(groupId).onSnapshot(doc => {
        if (doc.exists) {
            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù† Ù†Ø§Ù‚Øµ Ø¹Ù†Ø¯Ùƒ)
            const data = doc.data();

            // 2. ğŸ”¥ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¹Ø´Ø§Ù† Ø²Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙŠØ´ØªØºÙ„)
            currentGroupOwnerId = data.createdBy;

            // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø©)
            document.getElementById('headerGroupName').innerText = data.name;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (data.groupImage) {
                document.getElementById('headerGroupImg').style.backgroundImage = `url('${data.groupImage}')`;
            }

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø¨Ø´Ø±Ø· Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø´Ø§Ø· ÙƒØªØ§Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ¯Ø§Ø®Ù„)
            const subtitle = document.getElementById('headerMemberCount');
            if (!subtitle.innerText.includes('ÙŠÙƒØªØ¨')) {
                const count = data.users ? data.users.length : 0;
                subtitle.innerHTML = `<i class="fa-solid fa-users" style="font-size:10px;"></i> ${count} Ø£Ø¹Ø¶Ø§Ø¡`;
            }

            // 4. ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· ÙˆØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Pinned Description)
            // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù€ HTML Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (id="pinnedGroupDesc")
            const pinBar = document.getElementById('pinnedGroupDesc');
            const descText = document.getElementById('descText');
            const container = document.getElementById('chatContainer');

            if (data.description && data.description.trim() !== "") {
                if(descText) descText.innerText = data.description;
                if(pinBar) pinBar.style.display = 'flex';
                if(container) container.classList.add('has-pinned-desc'); // Ù„Ø¶Ø¨Ø· Ù…Ø³Ø§ÙØ© Ø§Ù„Ø´Ø§Øª
            } else {
                if(pinBar) pinBar.style.display = 'none';
                if(container) container.classList.remove('has-pinned-desc');
            }
        }
    });

    // ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù…
    requestNotifyPermission(); // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    loadMessages();            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    listenForGroupCalls();     // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
    initTypingListener();      // Ù†Ø¸Ø§Ù… "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..."
}

// Ø¯Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function safePlayAudio(audioId) {
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0;
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log("Auto-play blocked. User interaction needed.");
                // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ´ØºÙ„ Ø§Ù‡ØªØ²Ø§Ø² Ø¨Ø¯Ù„ Ø§Ù„ØµÙˆØª Ù„Ùˆ Ø§Ù„ØµÙˆØª Ø§ØªÙ…Ù†Ø¹
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            });
        }
    }
}

// Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
function stopAudio(audioId) {
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.pause();
        audio.currentTime = 0;
    }
}


// 1. Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ù…ØªØµÙ„)
async function startGroupCall(type) {
    const overlay = document.getElementById('callOverlay');
    const videoContainer = document.getElementById('videoContainer');
    const audioInfo = document.getElementById('audioInfo');

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const constraints = {
        audio: true,
        video: type === 'video' ? { facingMode: 'user' } : false
    };

    try {
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        overlay.style.display = 'flex';
        if (type === 'video') {
            videoContainer.style.display = 'block';
            audioInfo.style.display = 'none'; // Ù†Ø®ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            document.getElementById('localVideo').srcObject = localStream;
        } else {
            videoContainer.style.display = 'none';
            audioInfo.style.display = 'flex';
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ (WebRTC)
        peerConnection = new RTCPeerConnection(rtcConfig);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±Ø§ÙƒØ§Øª Ù„Ù„Ø§ØªØµØ§Ù„
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        // ğŸ”¥ Ø£Ù‡Ù… Ø¬Ø²Ø¡: Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
        peerConnection.ontrack = (event) => {
            const stream = event.streams[0];
            
            // Ù„Ùˆ ØµÙˆØª -> Ø´ØºÙ„Ù‡ ÙÙŠ Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ÙÙŠ
            if (event.track.kind === 'audio') {
                const remoteAudio = document.getElementById('remoteAudio');
                remoteAudio.srcObject = stream;
                remoteAudio.play().catch(e => console.log("Audio play blocked"));
            }
            
            // Ù„Ùˆ ÙÙŠØ¯ÙŠÙˆ -> Ø´ØºÙ„Ù‡ ÙÙŠ Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            if (event.track.kind === 'video') {
                document.getElementById('remoteVideo').srcObject = stream;
            }
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù…Ø§ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ØªÙˆØµÙ„
            handleCallConnected();
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø´Ø¨ÙƒØ© (ICE Candidates)
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.collection('chats').doc(groupId).collection('call_candidates').add(event.candidate.toJSON());
            }
        };

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ (Offer)
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Ø­ÙØ¸ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
        await db.collection('chats').doc(groupId).collection('calls').doc('active_call').set({
            type: 'offer',
            sdp: offer.sdp,
            callerId: currentUser.uid,
            callerName: currentUser.displayName,
            callerPic: currentUser.photoURL,
            callType: type,
            status: 'ringing'
        });

        document.getElementById('callStatusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯
        listenForAnswer();

    } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…Ø§ÙŠÙƒ");
        endGroupCall();
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© (Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)
async function joinGroupCall() {
    document.getElementById('incomingGroupCall').style.display = 'none';
    
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
    const callDoc = await db.collection('chats').doc(groupId).collection('calls').doc('active_call').get();
    if (!callDoc.exists) return;
    const callData = callDoc.data();

    const constraints = {
        audio: true,
        video: callData.callType === 'video'
    };

    try {
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.getElementById('callOverlay').style.display = 'flex';
        if (callData.callType === 'video') {
            document.getElementById('videoContainer').style.display = 'block';
            document.getElementById('audioInfo').style.display = 'none';
            document.getElementById('localVideo').srcObject = localStream;
        }

        peerConnection = new RTCPeerConnection(rtcConfig);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.collection('chats').doc(groupId).collection('call_candidates').add(event.candidate.toJSON());
            }
        };

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
        peerConnection.ontrack = (event) => {
            const stream = event.streams[0];
            if (event.track.kind === 'audio') {
                const remoteAudio = document.getElementById('remoteAudio');
                remoteAudio.srcObject = stream;
                remoteAudio.play();
            }
            if (event.track.kind === 'video') {
                document.getElementById('remoteVideo').srcObject = stream;
            }
            handleCallConnected();
        };

        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø¯
        await peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: callData.sdp }));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
        await db.collection('chats').doc(groupId).collection('calls').doc('active_call').update({
            answer: { type: 'answer', sdp: answer.sdp },
            status: 'connected'
        });

        listenForRemoteCandidates();

    } catch (err) {
        console.error(err);
    }
}

// 3. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¨Ø· (Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙÙ‚Ø±ÙŠ)
function listenForAnswer() {
    db.collection('chats').doc(groupId).collection('calls').doc('active_call')
        .onSnapshot(snapshot => {
            const data = snapshot.data();
            if (data && data.answer && !peerConnection.currentRemoteDescription) {
                const answerDesc = new RTCSessionDescription(data.answer);
                peerConnection.setRemoteDescription(answerDesc);
                listenForRemoteCandidates();
            }
        });
}

function listenForRemoteCandidates() {
    db.collection('chats').doc(groupId).collection('call_candidates')
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                if (change.type === 'added') {
                    const candidate = new RTCIceCandidate(change.doc.data());
                    if (peerConnection) {
                        peerConnection.addIceCandidate(candidate).catch(e => {});
                    }
                }
            });
        });
}

// 4. Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ù†ÙŠÙ† (Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø±Ù„Ùƒ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù…Ø§ Ø­Ø¯ ÙŠØªØµÙ„)
function listenForGroupCalls() {
    db.collection('chats').doc(groupId).collection('calls').doc('active_call')
        .onSnapshot(doc => {
            const incomingUI = document.getElementById('incomingGroupCall');
            
            if (doc.exists) {
                const data = doc.data();
                // Ù„Ùˆ ÙÙŠÙ‡ Ù…ÙƒØ§Ù„Ù…Ø© ÙˆÙ…Ø´ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…ØªØµÙ„
                if (data.status === 'ringing' && data.callerId !== currentUser.uid && !peerConnection) {
                    document.getElementById('incomingCallerName').innerText = data.callerName;
                    incomingUI.style.display = 'flex';
                    // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ´ØºÙ„ ØµÙˆØª Ø±Ù†ÙŠÙ† Ù„Ùˆ Ø¹Ø§ÙŠØ²
                }
            } else {
                // Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù†ØªÙ‡Øª
                incomingUI.style.display = 'none';
                if (document.getElementById('callOverlay').style.display === 'flex') {
                    endGroupCall();
                }
            }
        });
}

// 5. Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
async function endGroupCall() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }

    document.getElementById('callOverlay').style.display = 'none';
    document.getElementById('incomingGroupCall').style.display = 'none';
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯
    clearInterval(callTimerInterval);
    document.getElementById('callTimer').innerText = "00:00";

    // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³
    try {
        await db.collection('chats').doc(groupId).collection('calls').doc('active_call').delete();
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¨Ø³ Ù…Ø³ØªØ­Ø³Ù†)
    } catch(e) {}
}

// 6. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„
function handleCallConnected() {
    document.getElementById('callStatusText').innerText = "Ù…ØªØµÙ„";
    document.getElementById('callStatusText').style.color = "#10b981";
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯
    let seconds = 0;
    if(callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').innerText = `${m}:${s}`;
    }, 1000);
}

// 7. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø§Ù‡Ù„ (Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± ÙÙŠ Ø§Ù„Ø±Ù†ÙŠÙ†)
function ignoreGroupCall() {
    document.getElementById('incomingGroupCall').style.display = 'none';
}

    function escapeHtml(text) {
    if (!text) return text;
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø©:
// contentHTML = linkify(escapeHtml(msg.text));

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function requestNotifyPermission() {
    if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
function sendBrowserNotification(title, body, icon) {
    if (document.hidden && Notification.permission === "granted") {
        new Notification(title, {
            body: body,
            icon: icon || 'https://cdn-icons-png.flaticon.com/512/166/166258.png',
            vibrate: [200, 100, 200]
        });
    }
}
// Ø¯Ø§Ù„Ø© ØªÙ…ÙŠÙŠØ²/Ø¥Ù„ØºØ§Ø¡ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø©
async function toggleStarMessage() {
    closeContextMenu(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    if (!selectedMsg || !selectedMsg.id) return;

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø¨Ø³ Ù‡Ù…Ø§ Ø§Ù„Ù„ÙŠ ÙŠÙ…ÙŠØ²ÙˆØ§ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙØ¹Ù„ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡:
    // if (!amIAdmin) return showToast("Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø· ğŸ‘®â€â™‚ï¸");

    try {
        // ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const currentStatus = selectedMsg.data.isStarred || false;
        
        // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ùˆ Ù…Ù…ÙŠØ²Ø© Ø´ÙŠÙ„Ù‡Ø§ØŒ Ù„Ùˆ Ù…Ø´ Ù…Ù…ÙŠØ²Ø© Ø­Ø·Ù‡Ø§)
        await db.collection('chats').doc(groupId).collection('messages').doc(selectedMsg.id).update({
            isStarred: !currentStatus
        });

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª ÙˆÙ…Ø¤Ø«Ø±Ø§Øª
        if (!currentStatus) {
            const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg");
            audio.play().catch(()=>{});
            showToast("ØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸŒŸ");
        } else {
            showToast("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ²");
        }

    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ…ÙŠÙŠØ²");
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®Ø¨ÙŠØ«Ø©
function escapeHtml(text) {
    if (!text) return text;
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØµÙŠØ©:
if (msg.type === 'text') {
    // Ù†Ø¸Ù Ø§Ù„Ù†Øµ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø­ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    contentHTML = linkify(escapeHtml(msg.text));
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
function handleScrollUp() {
    const container = document.getElementById('chatContainer');
    
    // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù„Ø£ÙˆÙ„ Ø§Ù„Ø´Ø§Øª (scrollTop = 0) ÙˆÙ„Ø³Ù‡ Ù…Ø§Ø¨Ù†Ø­Ù…Ù„Ø´
    if (container.scrollTop === 0 && !isLoadingMore && lastVisibleMsgDoc) {
        loadMoreMessages();
    }
}
async function loadMoreMessages() {
    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ùˆ Ø¨ÙŠØ­Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹
    if (isLoadingMore) return;
    isLoadingMore = true;
    
    const container = document.getElementById('chatContainer');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ¯Ø±
    const loader = document.createElement('div');
    loader.id = 'topLoader';
    loader.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    loader.style.cssText = 'text-align:center; padding:10px; color:#aaa; font-size:12px; width:100%;';
    container.prepend(loader);

    try {
        const oldHeight = container.scrollHeight;

        const snap = await db.collection('chats').doc(groupId).collection('messages')
            .orderBy('createdAt', 'asc')
            .endBefore(lastVisibleMsgDoc)
            .limitToLast(20)
            .get();

        if (!snap.empty) {
            lastVisibleMsgDoc = snap.docs[0];
            
            // ğŸ”¥ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ø¹ÙƒØ³ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠØ¨Ù‚Ù‰ ØµØ­ Ù…Ø¹ Prepend
            let messages = snap.docs.reverse(); 

            messages.forEach(doc => {
                // ğŸ›‘ Ø£Ù‡Ù… Ø³Ø·Ø±: Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£ØµÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„ØµÙØ­Ø©ØŒ Ù…Ø§ ØªØ±Ø³Ù…Ù‡Ø§Ø´ ØªØ§Ù†ÙŠ!
                if (document.getElementById(`msg_${doc.id}`)) {
                    return; 
                }
                renderMessageUI(doc.data(), doc.id, 'prepend');
            });

            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹ÙŠÙ† Ù…Ø§ ØªØªÙˆÙ‡Ø´
            const newHeight = container.scrollHeight;
            container.scrollTop = newHeight - oldHeight;

        } else {
            loader.innerHTML = "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©";
        }

    } catch (error) {
        console.error("Error loading more:", error);
    } finally {
        isLoadingMore = false;
        setTimeout(() => {
            const l = document.getElementById('topLoader');
            if(l) l.remove();
        }, 1000);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ù…Ø«Ù„Ø§ 1500 ØªØ¨Ù‚Ù‰ 1.5k)
function formatNumber(num) {
    if (!num) return '0';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num;
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ù…Ø­Ø¯Ø«Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ø³Ø§Ø¨ ÙƒÙˆÙ„ÙŠÙƒØ´Ù†)
async function showReactionDetails(msgId, event) {
    if(event) event.stopPropagation();

    const modal = document.getElementById('reactionsModal');
    const list = document.getElementById('reactorsList');
    modal.classList.add('active');
    
    // Ù„ÙˆØ¯Ø±
    list.innerHTML = `
        <div style="height:200px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#aaa;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:25px; color:var(--gold-color); margin-bottom:10px;"></i>
            <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª...</span>
        </div>`;

    try {
        const msgDoc = await db.collection('chats').doc(groupId).collection('messages').doc(msgId).get();
        if (!msgDoc.exists) return;
        
        const reactions = msgDoc.data().reactions || {};
        const entries = Object.entries(reactions);

        document.getElementById('reactTotalCount').innerHTML = `<span style="background:var(--gold-color); color:#000; padding:2px 8px; border-radius:10px; font-size:12px;">${entries.length}</span>`;

        if (entries.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§Ø¹Ù„Ø§Øª Ø¨Ø¹Ø¯ ğŸ¤·â€â™‚ï¸</div>';
            return;
        }

        const promises = entries.map(async ([uid, emoji]) => {
            let userData = {
                name: "Ù…Ø³ØªØ®Ø¯Ù…",
                pic: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
                isVerified: false,
                followersCount: 0
            };

            if (uid === currentUser.uid) {
                userData.name = "Ø£Ù†Øª";
                userData.pic = currentUser.photoURL || userData.pic;
                userData.isVerified = (myRealProfile && myRealProfile.verified) || false; 
            } 
            
            try {
                // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                const userRef = db.collection('users').doc(uid);
                const userSnap = await userRef.get();
                
                if (userSnap.exists) {
                    const d = userSnap.data();
                    userData.name = (uid === currentUser.uid) ? "Ø£Ù†Øª" : (d.name || d.displayName || "Ù…Ø³ØªØ®Ø¯Ù…");
                    userData.pic = d.profilePic || d.avatar || d.image || userData.pic;
                    userData.isVerified = (d.isVerified === true || d.verified === true);
                    
                    // ğŸ”¥ğŸ”¥ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© Ø§Ù„Ù…Ø£Ø®ÙˆØ°Ø© Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (ØªØµØ­ÙŠØ­ Ø§Ù„Ø¹Ø¯Ø¯) ğŸ”¥ğŸ”¥
                    
                    // Ø£) Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙˆÙ‡Ù…ÙŠ Ø§Ù„Ù…Ø®Ø²Ù†
                    const fakeCount = d.fakeFollowersCount || 0;

                    // Ø¨) Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¹Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Subcollection)
                    // Ù†Ø³ØªØ®Ø¯Ù… get().size Ø¹Ø´Ø§Ù† Ù†Ø¹Ø¯Ù‡Ù… Ø²ÙŠ Ù…Ø§ Ø¨ÙŠØ­ØµÙ„ ÙÙŠ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                    const subColSnap = await userRef.collection('followers').get();
                    const realCount = subColSnap.size;

                    // Ø¬) Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    userData.followersCount = realCount + fakeCount;
                }
            } catch (err) {
                console.log("Error fetching user data", err);
            }

            return { ...userData, emoji, uid }; 
        });

        const renderData = await Promise.all(promises);

        let fullHtml = '';
        renderData.forEach(user => {
            const verifyHtml = user.isVerified ? `<i class="fa-solid fa-circle-check verify-icon" title="Ù…ÙˆØ«Ù‚"></i>` : '';

            fullHtml += `
            <div class="reactor-row" onclick="location.href='profile.html?uid=${user.uid}'">
                <div class="reactor-avatar-wrapper">
                    <div class="reactor-avatar" style="background-image: url('${user.pic}');"></div>
                    <div class="reactor-emoji-badge">${user.emoji}</div>
                </div>
                
                <div class="reactor-info">
                    <div class="reactor-name-row">
                        <span class="reactor-name">${user.name}</span>
                        ${verifyHtml}
                    </div>
                    
                    <div class="reactor-stats">
                        <div class="stat-item">
                            <i class="fa-solid fa-users stat-icon"></i>
                            <span>${formatNumber(user.followersCount)} Ù…ØªØ§Ø¨Ø¹</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        list.innerHTML = fullHtml;

    } catch (e) {
        console.error(e);
        list.innerHTML = '<div style="text-align:center; color:var(--danger-color); padding:20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    }
}

// Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø´Ø§Øª)
function formatNumber(num) {
    if (!num) return '0';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num;
}

function closeReactionDetails() {
    document.getElementById('reactionsModal').classList.remove('active');
}

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹
let currentReactMsgId = null;

// Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯)
const extendedEmojis = [
    "ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜…","ğŸ˜‚","ğŸ¤£","ğŸ¥²","ğŸ¥¹","â˜ºï¸","ğŸ˜Š","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜","ğŸ¥°","ğŸ˜˜",
    "ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤¨","ğŸ§","ğŸ¤“","ğŸ˜","ğŸ¥¸","ğŸ¤©","ğŸ¥³","ğŸ˜","ğŸ˜’","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ",
    "ğŸ˜•","ğŸ™","â˜¹ï¸","ğŸ˜£","ğŸ˜–","ğŸ˜«","ğŸ˜©","ğŸ¥º","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ¥µ","ğŸ¥¶","ğŸ˜±","ğŸ˜¨",
    "ğŸ˜°","ğŸ˜¥","ğŸ˜“","ğŸ¤—","ğŸ¤”","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ˜¶","ğŸ˜","ğŸ˜‘","ğŸ˜¬","ğŸ™„","ğŸ˜¯","ğŸ˜¦","ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¥±","ğŸ˜´",
    "ğŸ¤¤","ğŸ˜ª","ğŸ˜µ","ğŸ¤","ğŸ¥´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¿","ğŸ‘¹","ğŸ‘º","ğŸ¤¡","ğŸ‘»","ğŸ’€",
    "ğŸ‘½","ğŸ‘¾","ğŸ¤–","ğŸƒ","ğŸ˜º","ğŸ˜¸","ğŸ˜¹","ğŸ˜»","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾","ğŸ«¶","ğŸ‘","ğŸ™Œ","ğŸ‘","ğŸ¤","ğŸ‘","ğŸ‘",
    "ğŸ‘Š","âœŠ","ğŸ¤›","ğŸ¤œ","ğŸ¤","âœŒï¸","ğŸ«°","ğŸ¤Ÿ","ğŸ¤˜","ğŸ‘Œ","ğŸ¤Œ","ğŸ¤","ğŸ‘ˆ","ğŸ‘‰","ğŸ‘†","ğŸ‘‡","â˜ï¸","âœ‹","ğŸ¤š","ğŸ–ï¸",
    "ğŸ––","ğŸ‘‹","ğŸ¤™","ğŸ’ª","ğŸ™","ğŸ’„","ğŸ’‹","ğŸ‘„","ğŸ¦·","ğŸ‘…","ğŸ‘‚","ğŸ¦»","ğŸ‘ƒ","ğŸ‘£","ğŸ‘ï¸","ğŸ‘€","ğŸ§ ","ğŸ«€","ğŸ«","ğŸ¦´",
    "ğŸ‘¶","ğŸ‘§","ğŸ§’","ğŸ‘¦","ğŸ‘©","ğŸ§‘","ğŸ‘¨","ğŸ‘©â€ğŸ¦±","ğŸ§‘â€ğŸ¦±","ğŸ‘¨â€ğŸ¦±","ğŸ‘©â€ğŸ¦°","ğŸ§‘â€ğŸ¦°","ğŸ‘¨â€ğŸ¦°","ğŸ‘±â€â™€ï¸","ğŸ‘±","ğŸ‘±â€â™‚ï¸","ğŸ‘©â€ğŸ¦³","ğŸ§‘â€ğŸ¦³","ğŸ‘¨â€ğŸ¦³",
    "ğŸ”¥","ğŸŒˆ","â˜€ï¸","â­","ğŸŒŸ","âœ¨","âš¡","â˜ï¸","â„ï¸","â›„","ğŸŒªï¸","ğŸŒŠ","â˜‚ï¸","â˜”"
];

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (ØªØ´ØªØºÙ„ Ø¨Ø§Ù„Ù„Ù…Ø³Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©)
// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ø§Ù„Ù…Ø·ÙˆØ±Ø©)
// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©)
// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ø§Ù„Ù…Ø­Ø³Ù†Ø© ÙˆØ§Ù„Ù…Ø¶Ù…ÙˆÙ†Ø©)
    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© ÙˆØ§Ù„Ù…Ø¶Ù…ÙˆÙ†Ø©)
function showQuickReactions(event, msgId) {
    // 1. Ù…Ù†Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø¨ (Ø¹Ø´Ø§Ù† Ø§Ù„Ø´Ø§Øª Ù†ÙØ³Ù‡ Ù…ÙŠØªØ­Ø±ÙƒØ´)
    if (event) {
        event.stopPropagation();
        event.preventDefault(); // Ù…Ù†Ø¹ Ø£ÙŠ Ø³Ù„ÙˆÙƒ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…ØªØµÙØ­
    }

    currentReactMsgId = msgId;
    const popup = document.getElementById('quickReactionPop');
    const msgElement = document.getElementById('msg_' + msgId);

    if (!msgElement || !popup) return;

    // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ù…ÙƒØ§Ù† ØªØ§Ù†ÙŠ Ø¹Ø´Ø§Ù† Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§Ù†
    popup.style.display = 'none';
    popup.classList.remove('show');

    // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§Ù† (Positioning)
    let targetElement = msgElement.querySelector('.msg-bubble') || msgElement;
    const rect = targetElement.getBoundingClientRect();
    
    const menuWidth = 280; // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    const menuHeight = 60;
    
    // ØªÙˆØ³ÙŠØ· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let leftPos = rect.left + (rect.width / 2) - (menuWidth / 2);
    let topPos = rect.top - menuHeight - 10; 

    // ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ÙƒØ§Ù† Ù„Ùˆ Ø®Ø±Ø¬ Ø¨Ø±Ù‡ Ø§Ù„Ø´Ø§Ø´Ø©
    if (topPos < 50) topPos = rect.bottom + 10; // Ù„Ùˆ ÙÙˆÙ‚ Ø£ÙˆÙŠ Ù†Ø²Ù„Ù‡Ø§ ØªØ­Øª
    if (leftPos < 10) leftPos = 10; // Ù„Ùˆ Ø®Ø±Ø¬Øª Ø´Ù…Ø§Ù„
    if (leftPos + menuWidth > window.innerWidth) leftPos = window.innerWidth - menuWidth - 10; // Ù„Ùˆ Ø®Ø±Ø¬Øª ÙŠÙ…ÙŠÙ†

    // 4. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Apply)
    popup.style.top = `${topPos}px`;
    popup.style.left = `${leftPos}px`;
    
    // ğŸ”¥ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø­Ø±ÙŠØ©: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙˆÙ„ (Block) Ø«Ù… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Show)
    popup.style.display = 'block';

    // Ù†Ø³ØªØ®Ø¯Ù… setTimeout ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø§Ù† Ø§Ù„Ù…ØªØµÙØ­ Ø§Ø³ØªÙˆØ¹Ø¨ display: block
    requestAnimationFrame(() => {
        popup.classList.add('show');
    });

    // 5. Ù‡Ø²Ø§Ø² Ø®ÙÙŠÙ (Feedback)
    if (navigator.vibrate) navigator.vibrate(25);

    // 6. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ (Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ)
    // Ø¨Ù†Ù„ØºÙŠ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ù‚Ø¯ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ù…ÙŠØªÙƒØ±Ø±Ø´
    if (window.closeReactionFn) {
        document.removeEventListener('click', window.closeReactionFn);
        document.removeEventListener('touchstart', window.closeReactionFn);
    }

    // ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    window.closeReactionFn = (e) => {
        if (!popup.contains(e.target)) {
            popup.classList.remove('show'); // Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
            setTimeout(() => {
                popup.style.display = 'none'; // Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
            }, 200);
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            document.removeEventListener('click', window.closeReactionFn);
            document.removeEventListener('touchstart', window.closeReactionFn);
            window.closeReactionFn = null;
        }
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø¨Ø¹Ø¯ 100 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø§Ù† Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø®Ù„ØµØª)
    setTimeout(() => {
        document.addEventListener('click', window.closeReactionFn);
        document.addEventListener('touchstart', window.closeReactionFn);
    }, 100);
}

function closeQuickReactions() {
    document.getElementById('quickReactionPop').style.display = 'none';
}

// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØ§Ø¹Ù„
// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
function confirmReaction(emoji) {
    if (!currentReactMsgId) return;
    
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.getElementById('quickReactionPop').style.display = 'none';
    closeFullEmojiPicker();

    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ selectedMsg ÙŠØ¯ÙˆÙŠØ§Ù‹
    // Ù„Ø£Ù† Ø¯Ø§Ù„Ø© react Ø§Ù„Ø£ØµÙ„ÙŠØ© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡
    selectedMsg = { id: currentReactMsgId }; 
    
    // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØªÙ†ÙÙŠØ° Ø§Ù„ØªÙØ§Ø¹Ù„
    const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");
    audio.play().catch(()=>{});
    
    react(emoji); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ©
}


// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function openFullEmojiPicker() {
    closeQuickReactions(); // Ø§ØºÙ„Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    const sheet = document.getElementById('fullEmojiPicker');
    const grid = document.getElementById('fullEmojiGrid');
    
    // Ù…Ù„Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
    if (grid.innerHTML === "") {
        extendedEmojis.forEach(em => {
            const span = document.createElement('div');
            span.className = 'full-emoji-item';
            span.innerText = em;
            span.onclick = () => confirmReaction(em);
            grid.appendChild(span);
        });
    }
    
    sheet.classList.add('active');
}

function closeFullEmojiPicker() {
    document.getElementById('fullEmojiPicker').classList.remove('active');
}

// Ø¯Ø§Ù„Ø© Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
async function transferOwnership(newOwnerUid, newOwnerName) {
    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨ÙˆØ¶ÙˆØ­
    closeMemberOptions(); 

    // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… TopicAS Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† confirm Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
    const isConfirmed = await TopicAS.confirm({
        title: "Ù†Ù‚Ù„ Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©",
        text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹ÙŠÙŠÙ† <b>${newOwnerName}</b> Ù…Ø§Ù„ÙƒØ§Ù‹ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ<br><br><span style="color:#FFD700; font-size:11px; background:rgba(255, 215, 0, 0.1); padding:5px; border-radius:5px;">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø³ØªÙÙ‚Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØªØµØ¨Ø­ Ù…Ø´Ø±ÙØ§Ù‹ ÙÙ‚Ø·.</span>`,
        type: "warning", // Ø¯Ù‡ Ù‡ÙŠØ®Ù„ÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªØ§Ø¬ ÙˆØ§Ù„Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ
        btnText: "Ù†Ø¹Ù…ØŒ ØªÙ†Ø§Ø²Ù„ Ø¹Ù† Ø§Ù„Ù…Ù„ÙƒÙŠØ©"
    });

    if (!isConfirmed) return; // Ù„Ùˆ Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡

    // ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„
    try {
        await db.collection('chats').doc(groupId).update({
            createdBy: newOwnerUid,   
            admins: firebase.firestore.FieldValue.arrayUnion(newOwnerUid) 
        });

        currentGroupOwnerId = newOwnerUid;
        
        // Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
        sendMessage({
            type: 'system',
            text: `ğŸ‘‘ ØªÙ… Ù†Ù‚Ù„ Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¥Ù„Ù‰ ${newOwnerName}`
        });

        showToast("ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        playSound('sent'); // ØµÙˆØª Ù†Ø¬Ø§Ø­
        openGroupInfo(); 

    } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©");
    }
}


async function deleteGroupSecurely() {
    if (!amIOwner) return showToast("Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·");

    // 1. Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨Ø§Ø³ÙˆØ±Ø¯ØŒ Ø§Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø¹Ø§Ø¯ÙŠ
    if (!currentGroupPassword) {
        if(!confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    } else {
        // 2. Ù„Ùˆ ÙÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯ØŒ Ø§Ø·Ù„Ø¨Ù‡
        const inputPass = prompt("âš ï¸ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
        if (inputPass !== currentGroupPassword) {
            return showToast("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        }
    }

    showToast("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©... ğŸ—‘ï¸");

    try {
        // Ø­Ø°Ù Ø§Ù„Ø¬Ø±ÙˆØ¨
        await db.collection('chats').doc(groupId).delete();
        // ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        window.location.href = "index.html";
    } catch (e) {
        showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
    }
}

// 3. ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ¹Ø¨Ø¦ØªÙ‡Ø§
async function openGroupSettings() {
    closeGroupInfo(); // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    const overlay = document.getElementById('groupSettingsOverlay');
    document.body.appendChild(overlay);
    overlay.style.display = 'flex';

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const doc = await db.collection('chats').doc(groupId).get();
    const data = doc.data();

    // Ø§Ù„ØµÙˆØ±Ø©
    const imgDiv = document.getElementById('gEditImg');
    if(data.groupImage) imgDiv.style.backgroundImage = `url('${data.groupImage}')`;
    else imgDiv.innerHTML = '<i class="fa-solid fa-camera"></i>';

    // Ø§Ù„Ù†ØµÙˆØµ
    document.getElementById('editGroupName').value = data.name;
    document.getElementById('editGroupDesc').value = data.description || "";
    document.getElementById('editGroupPass').value = data.groupPassword || "";

    // Ø§Ù„Ø³ÙˆÙŠØªØ´Ø§Øª
    document.getElementById('checkLockChat').checked = data.isLocked || false;
    document.getElementById('checkPrivateGroup').checked = data.isPrivate || false;

    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ
    if (myRole === 'owner') {
        document.getElementById('ownerSettingsArea').style.display = 'block';
    } else {
        document.getElementById('ownerSettingsArea').style.display = 'none';
    }
}

function closeGroupSettings() {
    document.getElementById('groupSettingsOverlay').style.display = 'none';
    openGroupInfo(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
}


// 5. Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¶Ùˆ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨)
function openRoleManager(uid, name, currentRole) {
    const modal = document.getElementById('memberOptionsModal');
    const content = document.getElementById('memberOptionsContent');
    modal.classList.add('active');
    content.classList.add('active');

    let html = `<h3 style="color:var(--gold-color); text-align:center; margin-bottom:15px;">Ø¥Ø¯Ø§Ø±Ø©: ${name}</h3>`;
    
    // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙˆØªÙŠ)
    // Ø§Ù„Ù…Ø§Ù„Ùƒ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹ÙŠÙŠÙ† Ø£ÙŠ Ø´ÙŠØ¡ Ø£Ù‚Ù„ Ù…Ù†Ù‡
    // Ø§Ù„Ù†Ø§Ø¦Ø¨ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹ÙŠÙŠÙ† Ù…Ø´Ø±ÙÙŠÙ† ÙˆÙ…Ù…ÙŠØ²ÙŠÙ†

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø²Ø± Ø§Ù„Ø±ØªØ¨Ø©
    const btn = (roleKey, label, icon, color) => `
        <button class="admin-action-btn" onclick="assignRole('${uid}', '${roleKey}', '${name}')" style="color:${color}; border-color:${color}33;">
            <i class="${icon}"></i> ${label}
        </button>`;

    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ø£Ù†Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ
    if (myRole === 'owner') {
        html += btn('co-owner', 'ØªØ¹ÙŠÙŠÙ† Ù†Ø§Ø¦Ø¨ Ù„Ù„Ù…Ø§Ù„Ùƒ', 'fa-solid fa-shield-halved', '#FF8C00');
    }
    
    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ù†Ø§Ø¦Ø¨
    if (myPower >= 4) {
        if(currentRole !== 'admin') html += btn('admin', 'ØªØ¹ÙŠÙŠÙ† Ù…Ø´Ø±Ù', 'fa-solid fa-user-shield', '#38bdf8');
        else html += btn('member', 'ØªÙ†Ø²ÙŠÙ„ Ù„Ø±ØªØ¨Ø© Ø¹Ø¶Ùˆ', 'fa-solid fa-user', '#fff');
    }

    // Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø´Ø±Ù ÙˆÙ…Ø§ ÙÙˆÙ‚
    if (myPower >= 3) {
        if(currentRole !== 'vip') html += btn('vip', 'ØªØ¹ÙŠÙŠÙ† Ø¹Ø¶Ùˆ Ù…Ù…ÙŠØ²', 'fa-solid fa-star', '#ec4899');
        else html += btn('member', 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠØ²', 'fa-solid fa-star-half-stroke', '#ccc');
        
        // Ø§Ù„Ø·Ø±Ø¯
        html += `
        <button class="admin-action-btn text-danger" onclick="removeMember('${uid}', '${name}')">
            <i class="fa-solid fa-user-xmark"></i> Ø·Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        </button>`;
    }

    // Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)
    if (myRole === 'owner') {
        html += `
        <button class="admin-action-btn" style="color:#FFD700; border:1px solid #FFD700;" onclick="transferOwnership('${uid}', '${name}')">
            <i class="fa-solid fa-crown"></i> Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ØªÙ†Ø§Ø²Ù„)
        </button>`;
    }

    html += `<button class="admin-action-btn" onclick="closeMemberOptions()">Ø¥Ù„ØºØ§Ø¡</button>`;
    
    content.innerHTML = html;
}
async function assignRole(uid, newRole, name) {
    closeMemberOptions();
    
    // ğŸ”¥ ØªØ±Ø¬Ù…Ø© Ø§Ø³Ù… Ø§Ù„Ø±ØªØ¨Ø© Ù„Ù„Ø¹Ø±Ø¶
    let roleNameAr = "Ø¹Ø¶Ùˆ";
    let roleType = "normal";
    if(newRole === 'admin') { roleNameAr = "Ù…Ø´Ø±Ù (Admin)"; roleType = "add"; }
    if(newRole === 'co-owner') { roleNameAr = "Ù†Ø§Ø¦Ø¨ Ù…Ø§Ù„Ùƒ"; roleType = "warning"; }
    if(newRole === 'vip') { roleNameAr = "Ø¹Ø¶Ùˆ Ù…Ù…ÙŠØ²"; roleType = "normal"; }

    // ğŸ”¥ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
    const isConfirmed = await TopicAS.confirm({
        title: "ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ø¶Ùˆ",
        text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø±ØªØ¨Ø© <b>${name}</b> Ø¥Ù„Ù‰ <span style="color:var(--gold-color);">${roleNameAr}</span>ØŸ`,
        type: roleType,
        btnText: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±"
    });

    if(!isConfirmed) return;

    const updateField = {};
    updateField[`roles.${uid}`] = newRole;

    try {
        await db.collection('chats').doc(groupId).update(updateField);
        showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
        
        sendMessage({
            type: 'system',
            text: `Ù‚Ø§Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø¨ØªØ¹ÙŠÙŠÙ† ${name} Ø¨Ø±ØªØ¨Ø© ${roleNameAr}`
        });

        openGroupInfo();
    } catch(e) {
        console.error(e);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
    }
}

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙˆØ¹Ø¯ (Promise)
let confirmResolver = null;

function showRoyalConfirm(count) {
    const modal = document.getElementById('royalConfirmModal');
    const textEl = document.getElementById('royalConfirmText');
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ
    textEl.innerHTML = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© <span style="color:var(--gold-color); font-weight:bold; font-size:16px;">${count}</span> Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø¯Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ`;
    
    modal.classList.add('active'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©

    // Ø¥Ø±Ø¬Ø§Ø¹ Promise ÙŠÙ†ØªØ¸Ø± Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    return new Promise((resolve) => {
        confirmResolver = resolve;
    });
}

function resolveRoyalConfirm(result) {
    const modal = document.getElementById('royalConfirmModal');
    modal.classList.remove('active'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    
    if (confirmResolver) {
        confirmResolver(result); // Ø¥Ø±Ø¬Ø§Ø¹ true Ø£Ùˆ false
        confirmResolver = null;
    }
}
const TopicAS = {
    resolver: null,

    confirm: function(options) {
        const modal = document.getElementById('universalConfirmModal');
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('uniConfirmTitle').innerText = options.title || "ØªØ£ÙƒÙŠØ¯";
        document.getElementById('uniConfirmText').innerHTML = options.text || "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ";
        
        const okBtn = document.getElementById('uniConfirmOkBtn');
        const iconBox = document.getElementById('uniConfirmIconBox');
        const icon = document.getElementById('uniConfirmIcon');

        // ØªØ®ØµÙŠØµ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        const type = options.type || 'normal';
        let color = '#8b5cf6'; 
        let iconClass = 'fa-solid fa-check';

        if (type === 'danger') {
            color = '#ef4444'; iconClass = 'fa-solid fa-triangle-exclamation';
        } else if (type === 'warning') {
            color = '#FFD700'; iconClass = 'fa-solid fa-crown';
        } else if (type === 'add') {
            color = '#38bdf8'; iconClass = 'fa-solid fa-user-plus';
        }

        icon.className = iconClass;
        iconBox.style.background = `${color}20`;
        iconBox.style.borderColor = `${color}50`;
        iconBox.style.color = color;
        
        okBtn.style.background = type === 'danger' 
            ? `linear-gradient(45deg, #ef4444, #b91c1c)` 
            : `linear-gradient(45deg, ${color}, #555)`;
            
        okBtn.innerText = options.btnText || "Ù†Ø¹Ù…";

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
        modal.classList.add('active');
        if(navigator.vibrate) navigator.vibrate(30);

        return new Promise((resolve) => {
            this.resolver = resolve;
        });
    },

    resolve: function(result) {
        const modal = document.getElementById('universalConfirmModal');
        modal.classList.remove('active');
        
        if (this.resolver) {
            this.resolver(result);
            this.resolver = null;
        }
    }
};

    </script>
    
    <div id="callOverlay" class="call-overlay" style="display: none;">
    
    <audio id="remoteAudio" autoplay></audio>

    <div class="call-bg"></div>
    
    <div id="videoContainer" class="video-container" style="display: none;">
        <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
        <video id="localVideo" autoplay playsinline muted class="local-video"></video>
    </div>

    <div id="audioInfo" class="call-info-section">
        <div class="call-avatar-wrapper">
            <div id="callAvatar" class="call-avatar"></div>
            <div class="pulse-ring"></div>
        </div>
        <h2 id="callTargetName" class="call-name">Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</h2>
        <span id="callStatusText" class="call-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        <span id="callTimer" class="call-timer">00:00</span>
    </div>

    <div class="call-controls-dock">
        <button class="call-btn" id="btnMute" onclick="toggleMic()">
            <i class="fa-solid fa-microphone"></i>
        </button>
        
        <button class="call-btn" id="btnCam" onclick="toggleCam()">
            <i class="fa-solid fa-video"></i>
        </button>
        
        <button class="call-btn" id="btnSpeaker" onclick="toggleSpeaker()">
            <i class="fa-solid fa-volume-high"></i>
        </button>

        <button class="call-btn" id="btnShare" onclick="shareScreen()">
            <i class="fa-solid fa-desktop"></i>
        </button>

        <button class="call-btn" id="btnSwitch" onclick="switchCamera()" style="display:none;">
            <i class="fa-solid fa-camera-rotate"></i>
        </button>

        <button class="call-btn end-call" onclick="endGroupCall()">
            <i class="fa-solid fa-phone-slash"></i>
        </button>
    </div>
</div>
<div id="incomingGroupCall" class="call-overlay" style="display: none; z-index: 20000;">
    <div class="call-bg"></div>
    
    <div class="call-info-section">
        <div class="call-avatar-wrapper">
            <div id="incomingCallerAvatar" class="call-avatar" style="border-color: #38bdf8;"></div>
            <div class="pulse-ring" style="border-color: #38bdf8;"></div>
        </div>
        <h2 id="incomingCallerName" class="call-name">Ø§Ø³Ù… Ø§Ù„Ù…ØªØµÙ„</h2>
        <span class="call-status" style="color: #38bdf8;">ğŸ“ Ø¨Ø¯Ø£ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©...</span>
        
        <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
            <i class="fa-solid fa-users"></i> Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†
        </div>
    </div>

    <div class="call-controls-dock" style="background: transparent; border: none; box-shadow: none;">
        <button class="call-btn" style="background: #ef4444; width: 65px; height: 65px; font-size: 24px;" onclick="ignoreGroupCall()">
            <i class="fa-solid fa-xmark"></i>
        </button>
        
        <button class="call-btn" style="background: #10b981; width: 65px; height: 65px; font-size: 24px; animation: pulse 1.5s infinite;" onclick="joinGroupCall()">
            <i class="fa-solid fa-phone"></i>
        </button>
    </div>
</div>

<audio id="groupRingTone" loop src="./sounds/ring_in.wav"></audio>

 <div id="mediaGalleryOverlay" class="bottom-sheet-overlay" style="z-index:9500;" onclick="if(event.target === this) closeGallery()">
    
    <div class="bottom-sheet" style="height:85vh; display:flex; flex-direction:column; background:#0f0c15; border-top: 1px solid var(--gold-color);">
        
        <div style="width: 50px; height: 4px; background: #333; margin: 10px auto 20px; border-radius: 10px;"></div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 15px 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-regular fa-images" style="color:var(--gold-color);"></i>
                <h3 style="color:#fff; margin:0; font-size:16px;">ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
            </div>
            
            <div onclick="closeGallery()" style="background:rgba(255,255,255,0.1); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                <i class="fa-solid fa-xmark" style="color:#fff;"></i>
            </div>
        </div>

        <div id="galleryContent" style="flex:1; overflow-y:auto; padding:10px; display:grid; grid-template-columns: repeat(3, 1fr); gap:3px;">
            </div>
    </div>
</div>
<div id="scrollToBottomBtn" onclick="scrollToBottom()" class="scroll-bottom-btn" style="position:fixed; bottom:90px; right:20px; width:40px; height:40px; background:rgba(30,41,59,0.9); border:1px solid var(--accent-color); border-radius:50%; display:none; align-items:center; justify-content:center; cursor:pointer; z-index:1500; box-shadow:0 4px 10px rgba(0,0,0,0.3); color:var(--accent-color);">
    <i class="fa-solid fa-arrow-down"></i>
</div>

<div id="groupInfoOverlay" class="royal-modal">
    <div class="royal-header">
        <div class="icon-btn" onclick="closeGroupInfo()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3 style="color:#fff;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
        <div id="editGroupIcon" onclick="openGroupSettings()" style="color:var(--gold-color); display:none; cursor:pointer; font-size:18px;">
            <i class="fa-solid fa-gear"></i>
        </div>
    </div>

    <div style="flex:1; overflow-y:auto; padding-bottom:30px;">
        
        <div class="group-avatar-container">
            <div id="gInfoImg" class="group-avatar-lg"></div>
        </div>

        <div style="text-align:center; margin-bottom:20px;">
            <h2 id="gInfoNameDisplay" style="color:#fff; margin:0;">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h2>
            <div style="color:#888; font-size:12px; margin-top:5px;">
                Ø§Ù„Ù…Ø§Ù„Ùƒ: <span id="creatorName" style="color:var(--gold-color);">...</span>
            </div>
            <p id="gInfoDescDisplay" style="color:#ccc; font-size:13px; margin:10px 20px; line-height:1.5; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;">
                Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ
            </p>
        </div>

        <div class="profile-actions-row">
            <div class="profile-action-btn btn-search" onclick="toggleSearchMode(); closeGroupInfo();">
                <i class="fa-solid fa-magnifying-glass"></i>
                <span>Ø¨Ø­Ø«</span>
            </div>

            <div class="profile-action-btn btn-add" id="btnAddMemberAction" style="display:none;" onclick="addNewMember()">
                <i class="fa-solid fa-user-plus"></i>
                <span>Ø¥Ø¶Ø§ÙØ©</span>
            </div>

            <div class="profile-action-btn btn-video" onclick="startGroupCall('video'); closeGroupInfo();">
                <i class="fa-solid fa-video"></i>
                <span>ÙÙŠØ¯ÙŠÙˆ</span>
            </div>

            <div class="profile-action-btn btn-call" onclick="startGroupCall('audio'); closeGroupInfo();">
                <i class="fa-solid fa-phone"></i>
                <span>Ù…ÙƒØ§Ù„Ù…Ø©</span>
            </div>
        </div>

        <div class="section-title">
            <span>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (<span id="gInfoCount">0</span>)</span>
        </div>
        
        <div id="groupMembersList"></div>

        <div class="member-card" onclick="leaveGroup()" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.05); color:#ff4444; cursor:pointer;">
            <div class="member-img" style="background:rgba(255,68,68,0.1); color:#ff4444;">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </div>
            <div style="font-weight:bold;">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
        </div>
    </div>
</div>

<div id="groupSettingsOverlay" class="royal-modal" style="background: #000;">
    <div class="royal-header">
        <div class="icon-btn" onclick="closeGroupSettings()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3 style="color:#fff;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
        <div onclick="saveGroupSettings()" style="color:var(--verify-color); cursor:pointer; font-weight:bold;">
            Ø­ÙØ¸
        </div>
    </div>

    <div style="flex:1; overflow-y:auto; padding:20px;">
        
        <div style="text-align:center; margin-bottom:20px;">
            <div id="gEditImg" class="group-avatar-lg" style="width:100px; height:100px; margin:0 auto;"></div>
            <div onclick="document.getElementById('groupImgInput').click()" style="color:var(--accent-color); margin-top:10px; cursor:pointer; font-size:14px;">
                <i class="fa-solid fa-camera"></i> ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
            </div>
        </div>

        <div class="setting-field">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <input type="text" id="editGroupName" class="setting-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">
        </div>

        <div class="setting-field">
            <label>ÙˆØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <textarea id="editGroupDesc" class="setting-input" rows="3" placeholder="Ø§Ù„ÙˆØµÙ..."></textarea>
        </div>
        
        <div class="setting-divider">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>

        <div class="setting-toggle-row">
            <div>
                <div class="st-title">Ù‚ÙÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
                <div class="st-desc">Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø· Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="checkLockChat">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="setting-toggle-row">
            <div>
                <div class="st-title">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ©</div>
                <div class="st-desc">Ù…Ù†Ø¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø£ØµØ¯Ù‚Ø§Ø¦Ù‡Ù…</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="checkPrivateGroup">
                <span class="slider round"></span>
            </label>
        </div>

        <div id="ownerSettingsArea" style="display:none;">
            <div class="setting-divider" style="color:var(--danger-color); border-color:var(--danger-color);">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</div>
            
            <div class="setting-field">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„Ø­Ø°Ù)</label>
                <input type="text" id="editGroupPass" class="setting-input" placeholder="ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±...">
            </div>

            <div onclick="deleteGroupSecurely()" style="background:rgba(255,0,0,0.1); color:red; text-align:center; padding:15px; border-radius:12px; margin-top:15px; cursor:pointer; border:1px solid red;">
                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
            </div>
        </div>

    </div>
</div>


<div id="memberOptionsModal" class="bottom-sheet-overlay">
    <div class="member-options-modal" id="memberOptionsContent">
        </div>
</div>

<div id="proVideoModal" class="pro-video-modal" style="display: none;">
    <div onclick="closeProPlayer()" style="position: absolute; top: 30px; right: 20px; width: 45px; height: 45px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 200;">
        <i class="fa-solid fa-xmark" style="color: #fff; font-size: 22px;"></i>
    </div>

    <video id="proMainVideo" class="pro-video-element" playsinline webkit-playsinline preload="auto" onclick="toggleProPlay()"></video>

    <div class="pro-controls" onclick="event.stopPropagation()">
        
        <div class="pro-progress-area" id="scrubArea" onclick="seekProVideo(event)">
            <div class="pro-progress-bg">
                <div class="pro-progress-fill" id="proProgressBar"></div>
            </div>
            <div class="pro-progress-knob" id="proProgressKnob"></div>
        </div>

        <div id="proTimeDisplay" class="pro-time-centered">00:00 / 00:00</div>

        <div class="pro-buttons-row">
            
            <div class="btn-group">
                <button class="pro-btn" onclick="downloadProVideo()"><i class="fa-solid fa-download"></i></button>
                <button class="pro-btn" id="speedBtn" onclick="cycleSpeed()" style="font-size:12px; font-weight:bold;">1.0x</button>
            </div>

            <button class="pro-btn play-btn-large" id="proPlayBtn" onclick="toggleProPlay()">
                <i class="fa-solid fa-play"></i>
            </button>

            <div class="btn-group">
                <button class="pro-btn" onclick="skipProVideo(-10)"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="pro-btn" onclick="skipProVideo(10)"><i class="fa-solid fa-rotate-right"></i></button>
            </div>

        </div>
    </div>
</div>

<div id="callOverlay" class="call-overlay" style="display: none;">
    <div class="call-bg"></div>
    
    <div id="videoContainer" class="video-container" style="display: none;">
        <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
        <video id="localVideo" autoplay playsinline muted class="local-video"></video>
    </div>

    <div id="audioInfo" class="call-info-section">
        <div class="call-avatar-wrapper">
            <div id="callAvatar" class="call-avatar"></div>
            <div class="pulse-ring"></div>
        </div>
        <h2 id="callTargetName" class="call-name">Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø§Ø±ÙŠØ©...</h2>
        <span id="callStatusText" class="call-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        <span id="callTimer" class="call-timer">00:00</span>
    </div>

    <div class="call-controls-dock">
        <button class="call-btn" id="btnMute" onclick="toggleMic()">
            <i class="fa-solid fa-microphone"></i>
        </button>
        
        <button class="call-btn" id="btnCam" onclick="toggleCam()">
            <i class="fa-solid fa-video"></i>
        </button>
        
        <button class="call-btn" id="btnSpeaker" onclick="toggleSpeaker()">
            <i class="fa-solid fa-volume-high"></i>
        </button>

        <button class="call-btn end-call" onclick="endGroupCall()">
            <i class="fa-solid fa-phone-slash"></i>
        </button>
    </div>
</div>

<div id="incomingGroupCall" class="call-overlay" style="display: none; z-index: 20000;">
    <div class="call-bg"></div>
    
    <div class="call-info-section">
        <div class="call-avatar-wrapper">
            <div id="incomingCallerAvatar" class="call-avatar" style="border-color: #38bdf8;"></div>
            <div class="pulse-ring" style="border-color: #38bdf8;"></div>
        </div>
        <h2 id="incomingCallerName" class="call-name">Ø§Ø³Ù… Ø§Ù„Ù…ØªØµÙ„</h2>
        <span class="call-status" style="color: #38bdf8;">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ§Ø±Ø¯Ø©...</span>
    </div>

    <div class="call-controls-dock" style="background: transparent; border: none; box-shadow: none;">
        <button class="call-btn" style="background: #ef4444; width: 65px; height: 65px; font-size: 24px;" onclick="ignoreGroupCall()">
            <i class="fa-solid fa-xmark"></i>
        </button>
        
        <button class="call-btn" style="background: #10b981; width: 65px; height: 65px; font-size: 24px; animation: pulse 1.5s infinite;" onclick="joinGroupCall()">
            <i class="fa-solid fa-phone"></i>
        </button>
    </div>
</div>

<audio id="groupRingTone" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
</audio>

<audio id="ringtoneOut" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<div class="bottom-sheet-overlay" id="reactionsModal" onclick="closeReactionDetails()">
    <div class="bottom-sheet" onclick="event.stopPropagation()">
        <div style="width: 50px; height: 4px; background: #333; margin: 0 auto 20px; border-radius: 10px;"></div>
        <h3 style="color:#fff; text-align:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª <span id="reactTotalCount" style="color:var(--gold-color); font-size:14px;"></span>
        </h3>
        
        <div id="reactorsList" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
</div>


<div id="quickReactionPop" class="quick-reaction-popup">
    <div class="reaction-items">
        <span class="q-emoji" onclick="confirmReaction('ğŸ‘')">ğŸ‘</span>
        <span class="q-emoji" onclick="confirmReaction('â¤ï¸')">â¤ï¸</span>
        <span class="q-emoji" onclick="confirmReaction('ğŸ˜‚')">ğŸ˜‚</span>
        <span class="q-emoji" onclick="confirmReaction('ğŸ˜®')">ğŸ˜®</span>
        <span class="q-emoji" onclick="confirmReaction('ğŸ˜¢')">ğŸ˜¢</span>
        <span class="q-emoji" onclick="confirmReaction('ğŸ˜¡')">ğŸ˜¡</span>
        
        <div class="add-more-btn" onclick="openFullEmojiPicker()">
            <i class="fa-solid fa-plus"></i>
        </div>
    </div>
</div>

<div id="fullEmojiPicker" class="bottom-sheet-overlay" style="z-index: 10000;" onclick="closeFullEmojiPicker()">
    <div class="bottom-sheet emoji-board" onclick="event.stopPropagation()">
        <div class="sheet-handle"></div>
        <h4 style="text-align:center; color:var(--gold-color); margin-bottom:15px; font-size:14px;">Ø§Ø®ØªØ± ØªÙØ§Ø¹Ù„Ø§Ù‹</h4>
        
        <div id="fullEmojiGrid" class="emoji-full-grid"></div>
    </div>
</div>


<div id="roleSelectorModal" class="bottom-sheet-overlay" style="z-index: 7000;">
    <div class="bottom-sheet">
        <h3 style="color:#fff; text-align:center; margin-bottom:20px;">ØªØ¹ÙŠÙŠÙ† Ø±ØªØ¨Ø© Ø§Ù„Ø¹Ø¶Ùˆ</h3>
        <div class="role-option" onclick="setRole('co-owner')">
            <i class="fa-solid fa-crown" style="color:#FFD700;"></i> Ù†Ø§Ø¦Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ
        </div>
        <div class="role-option" onclick="setRole('admin')">
            <i class="fa-solid fa-user-shield" style="color:#c0c0c0;"></i> Ù…Ø´Ø±Ù (Admin)
        </div>
        <div class="role-option" onclick="setRole('vip')">
            <i class="fa-solid fa-star" style="color:#00e5ff;"></i> Ø¹Ø¶Ùˆ Ù…Ù…ÙŠØ² (VIP)
        </div>
        <div class="role-option" onclick="setRole('member')">
            <i class="fa-solid fa-user" style="color:#888;"></i> Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠ
        </div>
    </div>
</div>


<div id="addMemberModal" class="royal-modal" style="z-index: 6000;">
    <div class="royal-header">
        <div class="icon-btn" onclick="closeAddMemberModal()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h3 style="color:#fff;">Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ø¶Ø§Ø¡</h3>
        <div id="btnAddSelected" onclick="executeBulkAdd()" style="color:var(--gold-color); font-weight:bold; font-size:14px; opacity: 0.5; pointer-events: none;">
            Ø¥Ø¶Ø§ÙØ© (0)
        </div>
    </div>

    <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <div style="background:rgba(255,255,255,0.05); border-radius:15px; padding:0 15px; display:flex; align-items:center; border:1px solid rgba(255,255,255,0.1);">
            <i class="fa-solid fa-magnifying-glass" style="color:#888;"></i>
            <input type="text" id="memberSearchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù..." 
                   style="width:100%; background:transparent; border:none; color:#fff; padding:12px; font-size:14px;"
                   oninput="filterAddMembersList(this.value)">
        </div>
    </div>

    <div id="addMembersListContainer" style="flex:1; overflow-y:auto; padding:10px;">
        </div>
</div>



<input type="file" id="groupImgInput" hidden accept="image/*" onchange="previewGroupImage(this)">
<div id="leaveConfirmModal" class="royal-confirm-overlay" style="z-index: 99999;">
    <div class="royal-confirm-box" style="border-color: #ef4444; box-shadow: 0 0 30px rgba(239, 68, 68, 0.2);">
        <div class="confirm-icon-pulse" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
            <i class="fa-solid fa-person-walking-arrow-right"></i>
        </div>
        <h3 style="color:#fff; margin: 15px 0 5px;">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
        <p style="color:#ccc; font-size:14px; margin-bottom:20px; line-height:1.6;">
            Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ <br>
            <span style="color:#ef4444; font-size:12px;">Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø±Ø¤ÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ù„Ø§ Ø¨Ø¯Ø¹ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©.</span>
        </p>
        <div class="confirm-actions-row">
            <button class="confirm-btn-cancel" onclick="closeLeaveModal()">ØªØ±Ø§Ø¬Ø¹</button>
            <button class="confirm-btn-ok" onclick="confirmLeaveAction()" 
                    style="background: linear-gradient(45deg, #ef4444, #b91c1c); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">
                Ù†Ø¹Ù…ØŒ ØºØ§Ø¯Ø±
            </button>
        </div>
    </div>
</div>

<div id="universalConfirmModal" class="royal-confirm-overlay" style="z-index: 2147483647 !important;">
    <div class="royal-confirm-box" id="universalConfirmBox">
        
        <div class="confirm-icon-pulse" id="uniConfirmIconBox">
            <i id="uniConfirmIcon" class="fa-solid fa-question"></i>
        </div>

        <h3 id="uniConfirmTitle" style="color:#fff; margin: 15px 0 5px; font-family: 'Cairo', sans-serif;">ØªØ£ÙƒÙŠØ¯</h3>
        <p id="uniConfirmText" style="color:#ccc; font-size:14px; margin-bottom:20px; line-height:1.6;">
            ...
        </p>

        <div class="confirm-actions-row">
            <button class="confirm-btn-cancel" onclick="TopicAS.resolve(false)">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="uniConfirmOkBtn" class="confirm-btn-ok" onclick="TopicAS.resolve(true)">Ù†Ø¹Ù…ØŒ Ù…ÙˆØ§ÙÙ‚</button>
        </div>
    </div>
</div>

<div id="universalConfirmModal" class="royal-confirm-overlay" style="z-index: 9999999 !important;">

</body>
</html>