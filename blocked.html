<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>قائمة الحظر | Blocked List</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        /* ================= تصميم الخيال (Professional Style) ================= */
       :root { 
    --bg-dark: #000000;  /* أسود ملكي */
    --bg-card: rgba(28, 28, 30, 0.7); /* رمادي غامق جداً */
    --primary: #d4af37;  /* ذهبي */
    --primary-glow: rgba(212, 175, 55, 0.4);
    --text-main: #fcfcfc;
    --text-sub: #8e8e93;
    --danger: #ff3b30;
    --success: #34c759;
    --glass-border: rgba(212, 175, 55, 0.2); /* حدود ذهبية خافتة */
}



        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(239, 68, 68, 0.08) 0%, transparent 40%);
            color: var(--text-main);
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        /* --- Header --- */
        .header {
            height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 50;
        }

        .header h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        
        .back-btn {
            width: 40px; height: 40px;
            display: grid; place-items: center;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .back-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.1); }

        /* --- Stats & Search Bar --- */
        .controls-area {
            padding: 20px 20px 10px 20px;
            display: flex; flex-direction: column; gap: 15px;
        }

        .stats-badge {
            display: inline-flex; align-items: center; gap: 8px;
            font-size: 14px; color: var(--text-sub);
            background: rgba(255,255,255,0.03); padding: 8px 15px;
            border-radius: 20px; border: 1px solid var(--glass-border);
            width: fit-content;
        }
        .count-number { color: var(--primary); font-weight: 800; font-size: 16px; }

        .search-container {
            position: relative;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 14px 45px 14px 20px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            background: var(--bg-card);
            color: #fff; font-family: inherit; font-size: 14px;
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon {
            position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%); color: var(--text-sub);
        }

        /* --- Content List --- */
        .content {
            flex: 1; padding: 10px 20px 80px 20px; /* Padding bottom for scrolling */
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* User Card */
        .blocked-user-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        
        /* تأثير عند الظهور */
        .card-enter { animation: slideUp 0.4s ease forwards; opacity: 0; transform: translateY(20px); }

        .user-info { display: flex; align-items: center; gap: 15px; flex: 1; }

        .avatar-wrapper { position: relative; }
        .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background-color: #2a3546; background-size: cover; background-position: center;
            border: 2px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .block-icon-overlay {
            position: absolute; bottom: -2px; right: -2px;
            background: var(--bg-dark); color: var(--danger);
            width: 20px; height: 20px; border-radius: 50%;
            display: grid; place-items: center; font-size: 10px;
            border: 2px solid var(--bg-dark);
        }

        .name-box { display: flex; flex-direction: column; gap: 4px; }
        .name { font-size: 15px; font-weight: 700; color: #fff; }
        .status { font-size: 11px; color: var(--danger); background: rgba(239, 68, 68, 0.1); padding: 2px 8px; border-radius: 6px; width: fit-content; }

        .unblock-btn {
            background: transparent;
            color: var(--text-sub);
            border: 1px solid var(--glass-border);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 12px; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .unblock-btn:hover { background: rgba(255,255,255,0.05); color: #fff; border-color: rgba(255,255,255,0.2); }
        .unblock-btn i { font-size: 10px; }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #283547 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 16px; margin-bottom: 12px; height: 82px; width: 100%;
        }

        /* Empty State */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; color: var(--text-sub); text-align: center;
        }
        .empty-icon {
            font-size: 60px; margin-bottom: 20px;
            color: rgba(255,255,255,0.05);
            filter: drop-shadow(0 0 10px rgba(59,130,246,0.1));
        }

        /* --- Custom Modal --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-box {
            background: #1e293b; border: 1px solid var(--glass-border);
            width: 85%; max-width: 320px;
            border-radius: 20px; padding: 25px;
            text-align: center; transform: scale(0.9); transition: 0.3s;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        .modal-icon {
            width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1);
            color: var(--danger); border-radius: 50%;
            display: grid; place-items: center; font-size: 24px;
            margin: 0 auto 15px;
        }
        .modal-btn-group {
            display: flex; gap: 10px; margin-top: 25px;
        }
        .btn-modal {
            flex: 1; padding: 12px; border-radius: 12px;
            border: none; font-family: inherit; font-weight: 700; cursor: pointer;
        }
        .btn-cancel { background: rgba(255,255,255,0.05); color: #fff; }
        .btn-confirm { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(59,130,246,0.3); }

        /* --- Toast Notification --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px);
            background: #10b981; color: #fff;
            padding: 12px 25px; border-radius: 50px;
            font-size: 13px; font-weight: 600;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200; display: flex; align-items: center; gap: 8px;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="back-btn" onclick="goBack()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <h1>إدارة المحظورين</h1>
        <div style="width: 40px;"></div> </div>

    <div class="controls-area">
        <div class="stats-badge">
            <i class="fa-solid fa-user-shield"></i>
            <span>عدد المحظورين: <span class="count-number" id="blockedCount">0</span></span>
        </div>
        
        <div class="search-container">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="بحث عن شخص محظور..." onkeyup="filterList()">
        </div>
    </div>

    <div class="content" id="listContainer">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <div class="modal-icon">
                <i class="fa-solid fa-unlock-keyhole"></i>
            </div>
            <h3 style="margin: 0 0 10px; color: #fff;">رفع الحظر؟</h3>
            <p style="margin: 0; font-size: 13px; color: var(--text-sub); line-height: 1.6;">
                سيتمكن <span id="modalUserName" style="color: var(--primary); font-weight: bold;"></span> من مراسلتك ورؤية ملفك الشخصي مرة أخرى.
            </p>
            <div class="modal-btn-group">
                <button class="btn-modal btn-cancel" onclick="closeModal()">تراجع</button>
                <button class="btn-modal btn-confirm" id="confirmUnblockBtn">نعم، رفع الحظر</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toastMsg">
        <i class="fa-solid fa-circle-check"></i>
        <span>تم إلغاء الحظر بنجاح</span>
    </div>

    <script>
        // 1. إعدادات فايربيس (كما هي)
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUserId = null;
        let blockedUsersList = []; // لتخزين البيانات للبحث
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

        // متغيرات المودال
        let targetChatId = null;
        let targetUserName = null;

        // 2. التحقق من المستخدم
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loadBlockedUsers();
            } else {
                window.location.href = 'index.html'; 
            }
        });

        function goBack() {
            history.back();
        }

        // 3. جلب المحظورين
        async function loadBlockedUsers() {
            const container = document.getElementById('listContainer');
            
            try {
                const snapshot = await db.collection('chats')
                    .where('users', 'array-contains', currentUserId)
                    .get();

                if (snapshot.empty) {
                    renderEmptyState();
                    return;
                }

                const promises = snapshot.docs.map(async (doc) => {
                    const chatData = doc.data();
                    
                    // التحقق من الحظر
                    if (!chatData.blockedBy || !chatData.blockedBy.includes(currentUserId)) {
                        return null;
                    }

                    const otherUid = chatData.users.find(u => u !== currentUserId);
                    let userData = { name: "مستخدم غير معروف", avatar: defaultAvatar };
                    
                    if(otherUid) {
                        try {
                            const userDoc = await db.collection('users').doc(otherUid).get();
                            if(userDoc.exists) {
                                const d = userDoc.data();
                                userData = {
                                    name: d.name || "مستخدم",
                                    avatar: d.profilePic || d.avatarUrl || defaultAvatar
                                };
                            }
                        } catch(e) { console.log("User fetch error", e); }
                    }

                    return { chatId: doc.id, ...userData };
                });

                const results = await Promise.all(promises);
                blockedUsersList = results.filter(user => user !== null);

                updateCount(blockedUsersList.length);

                if (blockedUsersList.length === 0) {
                    renderEmptyState();
                } else {
                    renderList(blockedUsersList);
                }

            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div style="text-align:center; color:#ef4444; margin-top:50px;">حدث خطأ في الاتصال</div>';
            }
        }

        // دالة رسم القائمة (لإعادة الاستخدام عند البحث)
        function renderList(list) {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            
            list.forEach((user, index) => {
                // Delay animation based on index
                const delay = index * 0.05; 
                const html = `
                <div class="blocked-user-card card-enter" id="card_${user.chatId}" style="animation-delay: ${delay}s">
                    <div class="user-info">
                        <div class="avatar-wrapper">
                            <div class="avatar" style="background-image: url('${user.avatar}')"></div>
                            <div class="block-icon-overlay"><i class="fa-solid fa-ban"></i></div>
                        </div>
                        <div class="name-box">
                            <div class="name">${user.name}</div>
                            <div class="status">محظور</div>
                        </div>
                    </div>
                    <button class="unblock-btn" onclick="openUnblockModal('${user.chatId}', '${user.name}')">
                        <span>إلغاء</span>
                        <i class="fa-solid fa-unlock"></i>
                    </button>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // دالة الحالة الفارغة
        function renderEmptyState() {
            const container = document.getElementById('listContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fa-solid fa-shield-cat empty-icon"></i>
                    <h3 style="margin:0; color:#fff;">نظيف تماماً!</h3>
                    <p>لا يوجد أي أشخاص في قائمة الحظر حالياً.</p>
                </div>`;
            updateCount(0);
        }

        // 4. نظام المودال والـ Unblock
        function openUnblockModal(chatId, name) {
            targetChatId = chatId;
            targetUserName = name;
            document.getElementById('modalUserName').innerText = name;
            
            const modal = document.getElementById('confirmModal');
            modal.classList.add('active');
            
            // ربط زر التأكيد بالدالة
            const confirmBtn = document.getElementById('confirmUnblockBtn');
            confirmBtn.onclick = executeUnblock;
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            targetChatId = null;
        }

        async function executeUnblock() {
            if(!targetChatId) return;

            const btn = document.getElementById('confirmUnblockBtn');
            btn.innerText = "جاري التنفيذ...";
            
            try {
                await db.collection('chats').doc(targetChatId).update({
                    blockedBy: firebase.firestore.FieldValue.arrayRemove(currentUserId)
                });

                // إزالة العنصر من القائمة محلياً
                const card = document.getElementById(`card_${targetChatId}`);
                if(card) {
                    card.style.transform = "translateX(20px)";
                    card.style.opacity = "0";
                    setTimeout(() => card.remove(), 300);
                }

                // تحديث المصفوفة المحلية
                blockedUsersList = blockedUsersList.filter(u => u.chatId !== targetChatId);
                updateCount(blockedUsersList.length);

                if(blockedUsersList.length === 0) {
                    setTimeout(renderEmptyState, 300);
                }

                closeModal();
                showToast();
                btn.innerText = "نعم، رفع الحظر"; // إعادة النص للأصل

            } catch (e) {
                alert("حدث خطأ أثناء العملية");
                console.error(e);
                closeModal();
            }
        }

        // 5. الوظائف المساعدة
        function updateCount(num) {
            document.getElementById('blockedCount').innerText = num;
        }

        function showToast() {
            const toast = document.getElementById('toastMsg');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 6. البحث
        function filterList() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = blockedUsersList.filter(user => user.name.toLowerCase().includes(query));
            
            if(filtered.length === 0 && query !== "") {
                document.getElementById('listContainer').innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--text-sub);">
                        لا توجد نتائج مطابقة
                    </div>`;
            } else {
                renderList(filtered);
            }
        }
    </script>
</body>
</html>
