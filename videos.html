<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD Pro - Watch & Gifts (Optimized)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>

    <style>
/* =========================================
   1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
   ========================================= */
:root {
    --primary: #F72585; 
    --secondary: #4CC9F0;
    --text-light: #ffffff;
    --overlay-dark: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.9) 100%);
    --bg-color: #0d0d0f;
    --card-color: #161616;
    --primary-solid: #5D5FEF;
    --text-color: #eee;
    --secondary-text: #aaa;
    --border-color: #2a2a2a;
    --danger-color: #ff3b30;
    --success-color: #34c759;
    --input-bg: #1f1f1f;
    --sheet-bg: #1e1e1e;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Cairo', sans-serif; }

body { background: #000; color: #fff; height: 100vh; width: 100vw; overflow: hidden; }

/* ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
body.no-scroll { overflow: hidden !important; }
body.no-scroll .app-container {
    overflow: hidden !important;
    pointer-events: none;
    touch-action: none;
}

/* =========================================
   2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Feed & Video Slide)
   ========================================= */
.app-container {
    height: 100%; width: 100%; overflow-y: scroll;
    scroll-snap-type: y mandatory; scroll-behavior: smooth;
    -ms-overflow-style: none; scrollbar-width: none;
}
.app-container::-webkit-scrollbar { display: none; }

.video-slide {
    height: 100dvh; width: 100%; position: relative;
    scroll-snap-align: start; scroll-snap-stop: always;
    background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden;
}

video { width: 100%; height: 100%; object-fit: cover; display: block; }
.interaction-layer { position: absolute; inset: 0; z-index: 2; }

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø³ÙÙ„ÙŠØ© */
.video-info {
    position: absolute; bottom: 0; left: 0; right: 0;
    padding: 20px 20px 30px 20px; background: var(--overlay-dark);
    z-index: 10; pointer-events: none;
}
.info-inner { pointer-events: auto; max-width: 80%; }
.author-name { font-weight: 800; font-size: 1.1rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.video-desc { font-size: 0.9rem; color: #eee; line-height: 1.4; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù„Ø£Ø²Ø±Ø§Ø±) */
.side-bar {
    position: absolute; left: 10px; bottom: 100px;
    z-index: 20; display: flex; flex-direction: column;
    gap: 25px; align-items: center;
}
.action-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.2s; }
.action-btn:active { transform: scale(0.9); }

.icon-circle {
    width: 45px; height: 45px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
    border-radius: 50%; display: grid; place-items: center; font-size: 22px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.action-text { font-size: 12px; font-weight: 600; text-shadow: 0 1px 2px #000; }

/* ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© */
.avatar-wrapper { position: relative; margin-bottom: 10px; }
.user-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
.follow-plus { 
    position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
    background: var(--primary); width: 22px; height: 22px; border-radius: 50%;
    display: grid; place-items: center; font-size: 12px; color: #fff;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„ÙÙŠØ¯ÙŠÙˆ */
.progress-container {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 3px;
    background: rgba(255,255,255,0.2); z-index: 50; cursor: pointer;
}
.progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ± */
.big-heart {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
    font-size: 120px; color: rgba(255, 40, 80, 0.9); z-index: 15; pointer-events: none;
    filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));
}
.big-heart.animate { animation: heartPop 0.8s cubic-bezier(0.17, 0.89, 0.32, 1.49) forwards; }

/* Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ø´ÙØ§Ù */
.mute-indicator {
    position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 10px 20px; border-radius: 50px;
    color: rgba(255, 255, 255, 0.9); font-size: 18px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    opacity: 0; transition: all 0.3s ease; z-index: 15; pointer-events: none;
}
.video-slide.muted-state .mute-indicator { opacity: 1; animation: floatIndicator 3s ease-in-out infinite; }

/* Ø§Ù„Ù„ÙˆØ¯Ø± Ø§Ù„Ø´Ø¨Ø­ (Brand Loader) */
.brand-loader {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: #000; z-index: 20; transition: opacity 0.4s ease-out;
}
.brand-pulse-icon {
    margin: 0; padding: 0; font-size: 100px; color: transparent; 
    -webkit-text-stroke: 1px rgba(255, 255, 255, 0.4);
    filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.1));
    animation: ghostPulse 2s infinite ease-in-out;
}

/* =========================================
   3. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Bottom Sheets)
   ========================================= */
.sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; backdrop-filter: blur(4px); }

.bottom-sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; background: var(--sheet-bg); 
    z-index: 201; border-radius: 24px 24px 0 0; transform: translateY(100%); 
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
    border-top: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 85vh;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5); color: #fff;
}
.bottom-sheet.active { transform: translateY(0); }
.sheet-handle { width: 40px; height: 5px; background: var(--border-color); border-radius: 10px; margin: 12px auto; }

.cm-header { 
    padding: 15px 20px; border-bottom: 1px solid var(--border-color); 
    display: flex; justify-content: space-between; align-items: center; 
    font-weight: 800; font-size: 16px; background: var(--sheet-bg); 
    z-index: 10; border-radius: 24px 24px 0 0; 
}
.cm-header i { position: relative; z-index: 100; padding: 10px !important; cursor: pointer; }
.cm-body { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; background: var(--sheet-bg); }

/* =========================================
   4. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„ÙÙˆØªØ± Ø§Ù„Ù…Ø·ÙˆØ± (Input Area)
   ========================================= */
.cm-footer {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: #0d0d0f; border-top: 1px solid #222;
    display: flex; flex-direction: column; z-index: 202;
    transition: all 0.3s ease;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­ */
.suggested-emojis {
    display: none; gap: 15px; padding: 10px 15px;
    background: #0d0d0f; border-bottom: 1px solid #1a1a1a;
    overflow-x: auto; scrollbar-width: none;
}
.cm-footer.expanded .suggested-emojis { display: flex; animation: slideUp 0.3s; }
.suggested-emojis span { font-size: 24px; cursor: pointer; transition: 0.2s; }
.suggested-emojis span:active { transform: scale(1.2); }

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
.input-area-container {
    display: flex; align-items: flex-end; padding: 10px 15px; gap: 10px;
    background: #0d0d0f; position: relative;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (ØµÙˆØ± ÙˆÙ‡Ø¯Ø§ÙŠØ§) */
.external-actions {
    display: flex; gap: 5px; align-items: center; margin-bottom: 2px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 100px; opacity: 1; overflow: hidden;
}
.input-area-container.focused .external-actions { max-width: 0px; opacity: 0; margin: 0; padding: 0; }

.ext-btn {
    width: 38px; height: 38px; border-radius: 50%;
    background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer; flex-shrink: 0; color: #fff; transition: 0.2s;
}
.ext-btn:active { transform: scale(0.95); }

/* Ø­Ù‚Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ */
.smart-input-wrapper {
    flex: 1; background: #1f1f1f; border-radius: 20px;
    border: 1px solid #333; min-height: 45px;
    display: flex; align-items: center; transition: 0.3s;
}
.smart-textarea {
    width: 100%; background: transparent; border: none; outline: none; color: #fff;
    font-size: 15px; resize: none; max-height: 100px; padding: 12px 5px 12px 15px; 
    line-height: 1.5; height: 45px;
}

/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ / Ø§Ù„Ù…Ø§ÙŠÙƒ */
.action-submit-btn {
    width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.1); color: #fff; flex-shrink: 0; transition: 0.2s; cursor: pointer;
}
.action-submit-btn.send-mode { background: var(--primary); transform: scale(1.1); }

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
.recording-overlay {
    display: flex; align-items: center; justify-content: space-between;
    background: #1f1f1f; padding: 0 10px; border-radius: 20px; border: 1px solid rgba(255, 59, 48, 0.3);
    position: absolute; top: 10px; left: 15px; right: 15px; height: 50px; z-index: 100;
}
.rec-info { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; color: #fff; font-weight: bold; }
.rec-dot { width: 10px; height: 10px; background-color: #ff3b30; border-radius: 50%; animation: blink-rec 1s infinite; }

/* =========================================
   5. Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯ (Comments System)
   ========================================= */
.comment-item { display: flex; gap: 10px; margin-bottom: 18px; position: relative; }

/* Ø§Ù„Ø£ÙØ§ØªØ§Ø± ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† */
.cm-avatar { 
    width: 38px; height: 38px; border-radius: 50%; background: #333; 
    flex-shrink: 0; background-size: cover; border: 1px solid var(--border-color); 
    display: grid; place-items: center; position: relative; overflow: visible !important;
}
.cm-avatar.online::after {
    content: ''; position: absolute; bottom: -2px; right: -2px;
    width: 12px; height: 12px; background-color: #4cd964;
    border: 2px solid #1a1a1a; border-radius: 50%; z-index: 10;
    box-shadow: 0 0 5px rgba(76, 217, 100, 0.5);
}

.cm-content { flex: 1; max-width: 85%; }

/* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ */
.cm-bubble {
    background: #262626; border: 1px solid #333; padding: 10px 14px;
    border-radius: 18px; border-top-right-radius: 2px; color: #eee;
    min-width: 120px; position: relative;
}
.cm-bubble.owner-bubble { 
    background: rgba(247, 37, 133, 0.25); border: 1px solid var(--primary); 
    box-shadow: 0 0 10px rgba(247, 37, 133, 0.1); 
}
.cm-username { font-weight: 800; font-size: 13px; color: #ffffff !important; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
.owner-badge { font-size: 10px; background: var(--primary); color: #fff; padding: 1px 6px; border-radius: 8px; }

.cm-text { font-size: 15px; line-height: 1.6; color: #e0e0e0; white-space: pre-wrap; word-break: break-word; }
.cm-text.collapsed { max-height: 60px; overflow: hidden; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
.read-more-btn { color: var(--primary); font-size: 11px; font-weight: bold; cursor: pointer; margin-top: 2px; display: inline-block; }

.cm-meta-row { display: flex; gap: 15px; margin-top: 5px; margin-right: 12px; font-size: 11px; color: var(--secondary-text); font-weight: 600; }
.cm-action { cursor: pointer; transition: 0.2s; }

/* Ø§Ù„Ø±Ø¯ÙˆØ¯ (Tree Style) */
.cm-bubble.colored-reply, .cm-bubble.colored-comment {
    position: relative; transition: 0.2s; background: #1a1a1a;
    border: 1px solid var(--user-color); border-right-width: 4px;
    box-shadow: inset 0 0 10px -5px var(--user-color), 0 5px 15px -8px var(--user-color);
}
.cm-bubble.colored-reply .cm-username { color: var(--user-color) !important; filter: brightness(1.3); }

.tree-connector { position: absolute; right: -24px; top: -20px; bottom: 0; width: 2px; background: #333; z-index: 0; }
.reply-curve { position: absolute; right: -24px; top: 20px; width: 15px; height: 2px; background: #333; }
.reply-mention-link { color: #2979ff; font-weight: 800; cursor: pointer; text-decoration: none; margin-left: 4px; }

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */
.color-0 { --user-color: #5D5FEF; } .color-1 { --user-color: #34c759; }
.color-2 { --user-color: #ff3b30; } .color-3 { --user-color: #ffb533; }
.color-4 { --user-color: #bf5af2; } .color-5 { --user-color: #64d2ff; }
.color-6 { --user-color: #ff9f0a; } .color-7 { --user-color: #ff375f; }
.color-8 { --user-color: #ac8e68; } .color-9 { --user-color: #808080; }

/* =========================================
   6. Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (ØµÙˆØ± - ÙÙŠØ¯ÙŠÙˆ - ØµÙˆØª)
   ========================================= */
/* Ø§Ù„ØµÙˆØ± */
.cm-media-wrapper {
    position: relative; width: 100%; max-width: 260px; margin-top: 8px;
    border-radius: 12px; overflow: hidden; background-color: #000;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.cm-media-img { width: 100%; height: auto; max-height: 350px; object-fit: cover; display: block; cursor: pointer; }

/* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØµØºØ± */
.custom-video-container {
    position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000;
}
.custom-video-element { width: 100%; max-height: 350px; object-fit: contain; }
.vid-center-play {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 45px; height: 45px; background: rgba(0,0,0,0.6); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: #fff; pointer-events: none;
    border: 1px solid rgba(255,255,255,0.2);
}
.vid-controls {
    position: absolute; bottom: 10px; right: 10px; left: 10px;
    display: flex; justify-content: space-between; opacity: 0; transition: 0.3s;
}
.custom-video-container.playing .vid-controls, .custom-video-container:hover .vid-controls { opacity: 1; }
.vid-btn {
    width: 32px; height: 32px; background: rgba(0,0,0,0.6); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; backdrop-filter: blur(4px);
}
.vid-speed-btn { width: 35px !important; border-radius: 12px !important; font-size: 11px !important; font-weight: 900 !important; }

/* Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Voice Note) */
.custom-audio-player {
    display: flex; align-items: center; gap: 10px; background: #2a2a2a;
    padding: 8px 12px; border-radius: 25px; width: 100%; max-width: 260px;
    margin-top: 5px; border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.3s;
}
.custom-audio-player.playing { border-color: var(--primary); background: #333; }
.play-btn {
    width: 35px; height: 35px; border-radius: 50%; background: var(--primary);
    border: none; color: #fff; display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 10px rgba(247, 37, 133, 0.3);
}
.audio-slider {
    flex: 1; -webkit-appearance: none; height: 4px; background: rgba(255, 255, 255, 0.2);
    border-radius: 2px; outline: none; cursor: pointer;
}
.audio-slider::-webkit-slider-thumb {
    -webkit-appearance: none; width: 12px; height: 12px; background: #fff;
    border-radius: 50%; cursor: pointer; margin-top: -4px;
}
.audio-time { font-size: 11px; color: #aaa; font-weight: 600; min-width: 35px; text-align: right; font-family: monospace; }

/* =========================================
   7. Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Pro Gift Style)
   ========================================= */
/* ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
.gift-tabs-container {
    display: flex; justify-content: space-between; background: rgba(255, 255, 255, 0.05);
    padding: 5px; border-radius: 15px; margin: 10px 15px; border: 1px solid rgba(255, 255, 255, 0.1);
}
.gift-tab {
    flex: 1; text-align: center; padding: 10px; border-radius: 12px; color: #888;
    cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.3s;
}
.gift-tab.active { background: var(--primary); color: #fff; box-shadow: 0 0 15px rgba(247, 37, 133, 0.3); }

.premium-gift-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 10px; }
.premium-gift-card {
    background: linear-gradient(145deg, rgba(30,30,35,0.8), rgba(20,20,25,0.9));
    border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 15px 5px;
    display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s;
}
.premium-gift-card:active { transform: scale(0.95); border-color: var(--primary); }
.pg-emoji { font-size: 35px; margin-bottom: 5px; }
.pg-name { font-size: 11px; color: #fff; font-weight: bold; }
.pg-price { font-size: 10px; color: #FFD700; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; margin-top: 3px; }

/* Ø´ÙƒÙ„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (New Gift Style) */
.gift-wrapper-pro {
    display: flex; align-items: flex-end; gap: 12px; width: 100%; margin-bottom: 15px; position: relative;
}
.gift-body {
    display: flex; flex-direction: column; align-items: center; position: relative; padding-bottom: 10px;
}
.gift-hero-icon {
    font-size: 85px; line-height: 1; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
    animation: giftFloat 3s ease-in-out infinite; z-index: 2;
}
.gift-gold-badge {
    background: linear-gradient(90deg, #FFD700 0%, #FDB931 50%, #FFD700 100%);
    background-size: 200% auto; color: #000; padding: 4px 18px;
    border-radius: 20px; font-size: 11px; font-weight: 900; margin-top: -10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 2px solid #fff; z-index: 3;
    animation: badgeShine 3s linear infinite; white-space: nowrap;
}
.gift-meta { font-size: 10px; color: #777; margin-top: 5px; font-weight: bold; }
/* Ù‡Ø¯ÙŠØ© Ù…ØµØºØ±Ø© Ù„Ù„Ø±Ø¯ÙˆØ¯ */
.reply-gift-container { transform: scale(0.85); transform-origin: right top; margin-right: -10px; margin-bottom: -10px; }

.header-gift-preview {
    display: flex; align-items: center; gap: 10px;
    background: linear-gradient(90deg, #1a1a1a, #2a2a2a);
    padding: 5px 10px; border-radius: 12px; border: 1px solid #FFD700;
}

/* Ø·Ø¨Ù‚Ø© Ø´ÙØ§ÙØ© Ù„ØºÙ„Ù‚ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
.gift-backdrop-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 299; display: none; background: rgba(0,0,0,0);
}
.gift-backdrop-layer.active { display: block; }

/* Ø§Ù„Ø§Ø³ØªÙŠÙƒØ±Ø§Øª */
.stickers-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px; max-height: 350px; overflow-y: auto; }
.sticker-option { font-size: 40px; text-align: center; cursor: pointer; transition: transform 0.1s; }
.sticker-option:active { transform: scale(0.8); }

/* =========================================
   8. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Modals & Menus)
   ========================================= */
/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (Glass Menu) */
.floating-options-sheet {
    position: fixed; bottom: 20px; left: 15px; right: 15px;
    background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    z-index: 10005; transform: translateY(150%); opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    padding: 8px; display: flex; flex-direction: column; gap: 5px;
}
.floating-options-sheet.active { transform: translateY(0); opacity: 1; }

.compact-option {
    display: flex; align-items: center; gap: 12px; padding: 12px 15px;
    border-radius: 16px; color: #fff; font-weight: 700; cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.compact-option:last-child { border-bottom: none; }
.compact-option:active { background: rgba(255, 255, 255, 0.1); transform: scale(0.98); }
.compact-option i { width: 25px; text-align: center; color: var(--primary); }
.compact-option.danger-opt { color: #ff3b30; }
.compact-option.danger-opt i { color: #ff3b30; }

.cancel-btn-compact {
    text-align: center; padding: 12px; background: rgba(255, 255, 255, 0.05);
    border-radius: 16px; font-weight: 800; color: #aaa; margin-top: 5px;
}
.popup-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); z-index: 10004; display: none;
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
.custom-modal { position: fixed; inset: 0; z-index: 3000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
.modal-box { background: var(--card-color); width: 85%; max-width: 380px; border-radius: 24px; padding: 30px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

/* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Toast) */
#toast { 
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); 
    background: #222; color: #fff; padding: 12px 24px; border-radius: 50px; 
    opacity: 0; pointer-events: none; transition: 0.4s; z-index: 6000; 
    display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´Ù† */
.mention-dropdown { 
    position: absolute; bottom: 60px; left: 15px; right: 15px; 
    background: var(--sheet-bg); border: 1px solid var(--border-color); border-radius: 12px; 
    max-height: 200px; overflow-y: auto; display: none; z-index: 205; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
}
.mention-dropdown.active { display: block; }
.mention-suggest-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid #333; }

/* =========================================
   9. ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ ÙˆØ¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± (Lightbox)
   ========================================= */
/* Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± */
.lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95); z-index: 10000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(10px); opacity: 0; transition: opacity 0.3s ease;
}
.lightbox.active { display: flex; opacity: 1; }
.lb-img {
    max-width: 95%; max-height: 85%; border-radius: 12px;
    box-shadow: 0 0 30px rgba(0,0,0,0.5); transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.lightbox.active .lb-img { transform: scale(1); }
.lb-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 40px; cursor: pointer; z-index: 10002; }
.lb-save-btn {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--primary); color: #fff; padding: 10px 25px;
    border-radius: 30px; font-weight: bold; display: flex; align-items: center;
    gap: 8px; cursor: pointer; box-shadow: 0 0 20px rgba(247, 37, 133, 0.4); z-index: 10001;
}

/* ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ (Fullscreen Video) */
.fs-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 20000; display: none; flex-direction: column; 
    justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease;
}
.fs-overlay.active { display: flex; opacity: 1; }
.fs-video-element { width: 100%; height: 100%; object-fit: contain; }

.fs-center-btn {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 70px; height: 70px; background: rgba(0,0,0,0.5); border-radius: 50%;
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-size: 30px; border: 1px solid rgba(255,255,255,0.3); cursor: pointer;
}
.fs-control-bar {
    position: absolute; bottom: 40px; left: 20px; right: 20px;
    display: flex; align-items: center; background: rgba(20, 20, 20, 0.85);
    padding: 10px 15px; border-radius: 50px; backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

/* =========================================
   10. Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Keyframes)
   ========================================= */
@keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink-rec { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes ghostPulse { 0%, 100% { transform: scale(0.95); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.6; filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.3)); } }
@keyframes floatIndicator { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
@keyframes giftFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-8px) rotate(2deg); } }
@keyframes badgeShine { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }

/* --- 1. Ø¥ØµÙ„Ø§Ø­ Ù…Ø³Ø§ÙØ© Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Ø§Ù„Ø±ÙŠÙƒÙˆØ±Ø¯) --- */
.custom-audio-player {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #2a2a2a;
    padding: 8px 12px;
    border-radius: 25px;
    width: 100%;
    max-width: 260px;
    
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¶ÙÙ†Ø§ Ù…Ø³Ø§ÙØ© Ù…Ù† ÙÙˆÙ‚ ÙˆÙ…Ù† ØªØ­Øª */
    margin-top: 8px;      
    margin-bottom: 12px;  /* Ø¯ÙŠ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ© Ø¹Ø´Ø§Ù† ØªÙØµÙ„ Ø¹Ù† Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡ */
    
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: 0.3s;
}

/* --- 2. Ø¥ØµÙ„Ø§Ø­ Ù…Ø³Ø§ÙØ© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ --- */
.cm-media-wrapper {
    position: relative;
    width: 100%;
    max-width: 260px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #000;
    border: 1px solid rgba(255, 255, 255, 0.1);

    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¶ÙÙ†Ø§ Ù…Ø³Ø§ÙØ© Ù…Ù† ØªØ­Øª */
    margin-top: 8px;
    margin-bottom: 12px; /* Ø¯ÙŠ Ø¨ØªØ¹Ù…Ù„ ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ù„ÙŠ ØªØ­ØªÙ‡ */
}

/* =========================================
   ØªØ­Ø¯ÙŠØ«: ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Style Update)
   ========================================= */

/* ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© */
.video-info {
    position: absolute; 
    bottom: 0; 
    left: 0; 
    right: 0;
    padding: 20px 15px 40px 15px; /* Ù…Ø³Ø§Ø­Ø© Ù…Ù† ØªØ­Øª Ø¹Ø´Ø§Ù† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0.95) 100%);
    z-index: 10; 
    pointer-events: none;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
}

.info-inner { 
    pointer-events: auto; 
    width: 100%; 
    max-width: 80%; /* Ø¹Ø´Ø§Ù† Ù…ÙŠÙƒØ³ÙŠØ´ Ø¹Ù„Ù‰ Ø²Ø±Ø§ÙŠØ± Ø§Ù„Ø¬Ù†Ø¨ */
}
/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù… */
.user-header-row {
    display: flex;
    align-items: center;
    gap: 10px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
    margin-bottom: 6px;
    width: 100%; /* ÙˆØ§Ø®Ø¯ Ø§Ù„Ø¹Ø±Ø¶ ÙƒÙ„Ù‡ */
    overflow: hidden; /* Ø¹Ø´Ø§Ù† Ù…ÙÙŠØ´ Ø­Ø§Ø¬Ø© ØªØ®Ø±Ø¬ Ø¨Ø±Ù‡ */
}

/* Ø§Ù„ØµÙˆØ±Ø© */
.header-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.9);
    object-fit: cover;
    flex-shrink: 0; /* Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙˆØ±Ø© Ù…ØªÙØ¹ØµØ´ Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ */
}

/* Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„ÙŠ Ø´Ø§ÙŠÙ„Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ */
.header-name-block {
    display: flex;
    align-items: center;
    gap: 5px;
    flex: 1; /* ÙŠØ§Ø®Ø¯ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
    min-width: 0; /* Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Truncate ÙŠØ´ØªØºÙ„ */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ù†ÙØ³Ù‡ */
.header-username {
    font-weight: 700; 
    font-size: 15px; 
    color: #fff; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    
    /* Ø§Ù„Ø®Ù„Ø·Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ù„Ø§Ø³Ù… Ø§Ù„Ø·ÙˆÙŠÙ„ */
    white-space: nowrap;       /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
    overflow: hidden;          /* ÙŠØ®ÙÙŠ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© */
    text-overflow: ellipsis;   /* ÙŠØ­Ø· Ø«Ù„Ø§Ø« Ù†Ù‚Ø· ... ÙÙŠ Ø§Ù„Ø¢Ø®Ø± */
    max-width: 100%;
}

/* Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ */
.verified-badge {
    color: #20D5EC; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ */
    font-size: 14px;
    flex-shrink: 0; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù…ØªØ®ØªÙÙŠØ´ */
    margin-top: 2px;
}
/* --- ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Header Fix) --- */

/* 1. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ */
.header-name-block {
    display: flex;
    align-items: center;
    gap: 5px;
    flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
    min-width: 0; /* Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ */
    justify-content: flex-start; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Øµ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ù†ÙØ³Ù‡ */
.header-username {
    display: block; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ truncating ÙŠØ´ØªØºÙ„ */
    font-weight: 700; 
    font-size: 15px; 
    color: #fff; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    
    /* Ø§Ù„Ø®Ù„Ø·Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ø±Ø¬Ù† Ø§Ù„Ù…Ø³Ø¨Ø¨ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©) */
.follow-btn-inline {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    font-size: 11px; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ø²Ø± Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
    
    /* ğŸ”¥ ØªÙ… Ø­Ø°Ù margin-right: auto Ù„Ø£Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®Ø¯ flex: 1 ÙˆÙ‡ÙŠØ²Ù‚ Ø§Ù„Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø¯Ù‡ */
    margin-left: 0; 
}


.follow-btn-inline:active {
    transform: scale(0.95);
    background: rgba(255, 255, 255, 0.3);
}

.video-desc { 
    font-size: 13px; 
    color: #eee; 
    line-height: 1.4; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    margin-right: 5px; /* Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ ØªØ­Øª Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¸Ø¨Ø· */
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø´ÙŠÙ„Ù†Ø§ Ù…Ù†Ù‡ Ø§Ù„ØµÙˆØ±Ø©) */
.side-bar {
    position: absolute; 
    left: 10px; /* Ø®Ù„ÙŠÙ†Ø§Ù‡Ø§ Ø´Ù…Ø§Ù„ Ø£Ùˆ ÙŠÙ…ÙŠÙ† Ø­Ø³Ø¨ Ù„ØºØªÙƒØŒ Ù‡Ù†Ø§ Ù‡ÙŠ Ø´Ù…Ø§Ù„ Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙŠÙƒ ØªÙˆÙƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ */
    bottom: 120px; /* Ø±ÙØ¹Ù†Ø§Ù‡ Ø´ÙˆÙŠØ© */
    z-index: 20; 
    display: flex; 
    flex-direction: column;
    gap: 20px; 
    align-items: center;
}

/* ØªØµØºÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¬Ù†Ø¨ Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† ØªØ¨Ù‚Ù‰ Ø´ÙŠÙƒ */
.icon-circle {
    width: 40px; 
    height: 40px; 
    font-size: 20px;
}

/* --- Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø·ÙˆØ± (Ù†Ø¨Ø¶ + Ù„Ù…Ø¹Ø§Ù†) --- */
.nabd-badge {
    display: inline-block;
    vertical-align: middle;
    margin-right: 4px;
    font-size: 13px;
    
    /* 1. ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ */
    /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ ÙˆÙÙŠ Ø§Ù„Ù†Øµ Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ (Ø§Ù„Ù„Ù…Ø¹Ø©) */
    background: linear-gradient(
        120deg, 
        #1da1f2 30%, 
        #ffffff 50%, 
        #1da1f2 70%
    );
    
    /* 2. ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø´Ø§Ù† Ù†Ø­Ø±ÙƒÙ‡Ø§ */
    background-size: 200% auto;
    
    /* 3. Ù‚Øµ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙ‚Ø· */
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    /* 4. Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‡Ø¬ Ø®Ø§Ø±Ø¬ÙŠ (Glow) */
    filter: drop-shadow(0 0 5px rgba(29, 161, 242, 0.6));
    
    /* 5. Ø¯Ù…Ø¬ Ø§Ù„Ø­Ø±ÙƒØªÙŠÙ†: Ø§Ù„Ù„Ù…Ø¹Ø§Ù† ÙˆØ§Ù„Ù†Ø¨Ø¶ */
    animation: 
        shineMove 3s linear infinite,      /* Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ù…Ø¹Ø§Ù† */
        heartbeat 1.5s infinite ease-in-out; /* Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ø¨Ø¶ */
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ù…Ø¹Ø§Ù† (Ù…Ø±ÙˆØ± Ø§Ù„Ø¶ÙˆØ¡) */
@keyframes shineMove {
    0% {
        background-position: 0% 50%;
    }
    100% {
        background-position: 200% 50%;
    }
}

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù†Ø¨Ø¶ (Ø§Ù„Ø¯Ù‚Ø§Øª) */
@keyframes heartbeat {
    0% { transform: scale(1); }
    15% { transform: scale(1.2); }
    30% { transform: scale(1); }
    45% { transform: scale(1.2); }
    60% { transform: scale(1); }
    100% { transform: scale(1); }
}

/* --- ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Header Fix) --- */

/* 1. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ */
.header-name-block {
    display: flex;
    align-items: center;
    gap: 5px;
    flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
    min-width: 0; /* Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ */
    justify-content: flex-start; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Øµ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ù†ÙØ³Ù‡ */
.header-username {
    display: block; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ truncating ÙŠØ´ØªØºÙ„ */
    font-weight: 700; 
    font-size: 15px; 
    color: #fff; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    
    /* Ø§Ù„Ø®Ù„Ø·Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* 3. ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ø±Ø¬Ù† Ø§Ù„Ù…Ø³Ø¨Ø¨ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©) */
.follow-btn-inline {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    font-size: 11px; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ø²Ø± Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
    
    /* ğŸ”¥ ØªÙ… Ø­Ø°Ù margin-right: auto Ù„Ø£Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®Ø¯ flex: 1 ÙˆÙ‡ÙŠØ²Ù‚ Ø§Ù„Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø¯Ù‡ */
    margin-left: 0; 
}


    </style>
</head>
<body>

    <div class="app-container" id="feed">
        </div>

  <div class="sheet-overlay" id="overlay" onclick="handleSmartOverlayClick()"></div>

    <div class="bottom-sheet" id="cmSheet" style="height: 75vh;">
        <div class="sheet-handle"></div>
        <div class="cm-header">
            <span id="cmCount">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
            <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px"></i>
        </div>
        <div class="cm-body" id="cmList"></div>
        
        <div class="mention-dropdown" id="mentionDropdown"></div>
<div class="cm-footer" id="commentFooter">
    <div class="suggested-emojis" id="suggestedEmojis">
        <span onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
        <span onclick="insertEmoji('ğŸ¥°')">ğŸ¥°</span>
        <span onclick="insertEmoji('ğŸ˜­')">ğŸ˜­</span>
        <span onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
        <span onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
        <span onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
    </div>

    <div class="input-area-container">
        
        <div id="normalModeUI" style="display: flex; width: 100%; align-items: flex-end; gap: 8px;">
            
            <div class="external-actions">
                <label class="ext-btn" style="color: #4cd964;">
                    <i class="fa-solid fa-image"></i>
                    <input type="file" hidden accept="image/*,video/*" onchange="uploadCommentMedia(this)">
                </label>

                <div class="ext-btn" onclick="GiftSystem.open()" style="color: #bf5af2; border-color: #bf5af2;">
                    <i class="fa-solid fa-gift"></i>
                </div>
            </div>

            <div class="smart-input-wrapper">
                <textarea id="cmInput" 
                          class="smart-textarea" 
                          placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." 
                          rows="1" 
                          onfocus="expandInputArea()" 
                          oninput="handleInputTyping(this)"></textarea>
            </div>

            <div id="dynamicActionBtn" class="action-submit-btn mic-mode" onclick="toggleRecording()">
                <i class="fa-solid fa-microphone" id="mainMicIcon"></i>
                <i class="fa-solid fa-paper-plane" id="mainSendIcon" style="display: none;"></i>
            </div>
        </div>

        <div id="recordingModeUI" class="recording-overlay" style="display: none;">
            <div class="action-submit-btn" style="color:#ff3b30; background:rgba(255,59,48,0.1)" onclick="cancelRecording()">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <div class="rec-info">
                <div class="rec-dot"></div> <span id="recordTimer">00:00</span>
            </div>
            <div class="action-submit-btn" style="background:var(--primary)" onclick="stopAndSendRecording()">
                <i class="fa-solid fa-paper-plane" style="transform: rotate(180deg) scaleX(-1);"></i> 
            </div>
        </div>

    </div>
</div>

    </div>

<div class="bottom-sheet" id="repliesSheet" style="height: 75vh; border-radius: 24px 24px 0 0;">
    <div class="sheet-handle"></div>
    
    <div class="cm-header">
        <i class="fa-solid fa-arrow-right" onclick="closeRepliesSheet()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
        <span style="flex:1; text-align:center;">Ø§Ù„Ø±Ø¯ÙˆØ¯</span>
        <i class="fa-solid fa-xmark" onclick="closeRepliesSheet()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
    </div>

    <div class="cm-body" id="repliesList" style="padding-bottom: 90px;"></div>

    <div class="cm-footer" id="replyFooter">
        <div class="input-area-container">
            
            <div id="replyNormalModeUI" style="display: flex; width: 100%; align-items: flex-end; gap: 8px;">
                
                <div class="external-actions" id="replyExternalActions">
                    <label class="ext-btn" style="color: #4cd964;">
                        <i class="fa-solid fa-image"></i>
                        <input type="file" hidden accept="image/*,video/*" onchange="uploadReplyMedia(this)">
                    </label>

                    <div class="ext-btn" onclick="GiftSystem.openForReply()" style="color: #bf5af2; border-color: #bf5af2;">
                        <i class="fa-solid fa-gift"></i>
                    </div>
                </div>

                <div class="smart-input-wrapper">
                    <textarea id="replyInput" 
                              class="smart-textarea" 
                              placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ø§Ù‹..." 
                              rows="1" 
                              onfocus="expandReplyInputArea()" 
                              oninput="handleReplyTyping(this)"></textarea>
                </div>

                <div id="replyDynamicActionBtn" class="action-submit-btn mic-mode" onclick="toggleReplyRecording()">
                    <i class="fa-solid fa-microphone" id="replyMicIcon"></i>
                    <i class="fa-solid fa-paper-plane" id="replySendIcon" style="display: none;"></i>
                </div>
            </div>

            <div id="replyRecordingModeUI" class="recording-overlay" style="display: none;">
                <div class="action-submit-btn" style="color:#ff3b30; background:rgba(255,59,48,0.1)" onclick="cancelReplyRecording()">
                    <i class="fa-solid fa-trash-can"></i>
                </div>
                
                <div class="rec-info">
                    <div class="rec-dot"></div> <span id="replyRecordTimer">00:00</span>
                </div>
                
                <div class="action-submit-btn" style="background:var(--primary)" onclick="stopAndSendReplyRecording()">
                    <i class="fa-solid fa-paper-plane" style="transform: rotate(180deg) scaleX(-1);"></i> 
                </div>
            </div>

        </div>
    </div>
</div>


    <div class="bottom-sheet" id="giftSheet" style="height: 60vh;">
        <div class="sheet-handle"></div>
        <h3 style="color:var(--text-color); text-align:center; margin-bottom:10px; font-size: 16px;">
            <i class="fa-solid fa-gift" style="color:var(--primary)"></i> Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        </h3>
        <div class="gift-tabs-container">
            <div class="gift-tab active" onclick="GiftSystem.switch('gifts', this)">Ù‡Ø¯Ø§ÙŠØ§</div>
            <div class="gift-tab" onclick="GiftSystem.switch('stickers', this)">Ù…Ù„ØµÙ‚Ø§Øª</div>
        </div>
        <div id="giftSystemContent" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div class="bottom-sheet" id="stickerSheet" style="height: auto; max-height: 60vh; z-index: 250;">
        <div class="sheet-handle"></div>
        <div style="padding: 15px; text-align: center; font-weight: 800; border-bottom: 1px solid var(--border-color); color:var(--text-color)">
            Ø§Ø³ØªÙŠÙƒØ±Ø§Øª
        </div>
        <div class="stickers-grid" id="stickersGrid"></div>
    </div>

    <div class="bottom-sheet" id="commentOptionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div id="cmOwnerOptions">
            <div class="c-option-item" onclick="triggerEditComment()"><i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</div>
            <div class="c-option-item" onclick="triggerReplyComment()"><i class="fa-solid fa-reply"></i> Ø±Ø¯</div>
            <div class="c-option-item" onclick="triggerCopyComment()"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø®</div>
            <div class="c-option-item danger" onclick="triggerDeleteComment()"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</div>
        </div>
        <div id="cmViewerOptions" style="display:none">
            <div class="c-option-item" onclick="triggerReplyComment()"><i class="fa-solid fa-reply"></i> Ø±Ø¯</div>
            <div class="c-option-item" onclick="triggerCopyComment()"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø®</div>
            <div id="ownerDeleteBtn" class="c-option-item danger" style="display:none" onclick="triggerDeleteComment()"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</div>
            <div class="c-option-item danger" onclick="reportComment()"><i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº</div>
        </div>
    </div>


    <div class="custom-modal" id="chicConfirmModal" style="z-index: 9999;">
        <div class="modal-box">
            <div style="font-size: 40px; margin-bottom: 15px;" id="chicIcon"></div>
            <h3 id="chicTitle" style="margin-bottom: 10px; color: var(--text-color);">ØªØ£ÙƒÙŠØ¯</h3>
            <p id="chicMessage" style="color: var(--secondary-text); font-size: 14px; margin-bottom: 25px; line-height: 1.5;"></p>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="closeChicModal()" style="flex: 1; padding: 10px; background: #333; color: #fff; border-radius: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn" id="chicConfirmBtn" style="flex: 1; padding: 10px; background: var(--danger-color); color: #fff; border-radius: 10px;">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-check-circle" style="color:var(--success-color)"></i> <span id="toastMsg"></span></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app", 
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        moment.locale('ar');

        // --- 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let currentUser = null;
        let currentUserData = null;
        let lastDoc = null; 
        let isLoading = false;

        let currentOpenVideoId = null;
        let currentPostOwnerUid = null;
        let selectedComment = null; 
        let selectedReply = null;
        let isEditingComment = false;
        let isEditingReply = false;
        let pressTimer;
        let currentParentComment = null;
        let currentSubReplyTarget = null;
        let isGhost = false;
        let commentsUnsub = null;
        let replyListener = null;

        let mediaRecorder = null;
        let audioChunks = [];
        let recordInterval;
        let isRecording = false;
let isGlobalMuted = true; 

        const stickerCollection = ["ğŸ¤£", "ğŸ˜‚", "ğŸ˜…", "ğŸ¥¹", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ¤ª", "ğŸ˜", "ğŸ˜­", "ğŸ˜¢", "ğŸ˜¤", "ğŸ˜¡", "ğŸ¤¬", "ğŸ¤¯", "ğŸ˜³", "ğŸ˜±", "ğŸ˜´", "ğŸ¤®", "ğŸ¤¡", "ğŸ’€", "ğŸ‘»", "ğŸ‘½", "ğŸ’©", "ğŸ‘", "ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "â¤ï¸", "ğŸ’”", "ğŸ”¥", "âœ¨"];
        const ghostColors = ["#ff0000", "#00ff00", "#0099ff", "#ffff00", "#ff00ff", "#00ffff", "#ff9900", "#9900ff", "#ffffff", "#00ff99"];

        // --- 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        auth.onAuthStateChanged(async user => {
            if(user) {
                currentUser = user;
                const uDoc = await db.collection('users').doc(user.uid).get();
                if(uDoc.exists) {
                    currentUserData = uDoc.data();
                    if(currentUserData.isGhost) isGhost = true;
                }
                loadVideos(true);
            } else {
                console.log("User not logged in");
            }
        });

        // --- 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Feed Logic) ---
        async function loadVideos(isInitial = false) {
    if (isLoading) return;
    isLoading = true;

    const feed = document.getElementById('feed');
    let query = db.collection('posts').orderBy('createdAt', 'desc').limit(5);

    if (!isInitial && lastDoc) {
        query = query.startAfter(lastDoc);
    }

    try {
        const snapshot = await query.get();
        if (snapshot.empty) {
            isLoading = false;
            return;
        }

        lastDoc = snapshot.docs[snapshot.docs.length - 1];

        for (const doc of snapshot.docs) {
            const data = doc.data();
            const videoMedia = data.media ? data.media.find(m => m.type === 'video') : null;

            if (videoMedia) {
                // 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚)
                let uName = "Unknown";
                let uPic = "";
                let isVerified = false; // Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯

                try {
                    const uSnap = await db.collection('users').doc(data.uid).get();
                    if (uSnap.exists) {
                        const uData = uSnap.data();
                        
                        uName = uData.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                        uPic = uData.profilePic || "";
                        
                        // 2. Ø¬Ù„Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
                        isVerified = uData.isVerified || false; 
                    }
                } catch (e) {
                    console.error("Error fetching user data:", e);
                }

                // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (isVerified) Ù…Ø¯Ù…Ø¬Ø§Ù‹ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                const cardHTML = createVideoCard(
                    doc.id, 
                    { ...data, isVerified: isVerified }, // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
                    videoMedia.url, 
                    uName, 
                    uPic, 
                    data.uid
                );
                
                feed.insertAdjacentHTML('beforeend', cardHTML);

                const newCard = document.getElementById(`slide-${doc.id}`);
                if (newCard) observer.observe(newCard);
            }
        }
    } catch (e) {
        console.error("Error loading videos:", e);
    }
    isLoading = false;
}

        function createVideoCard(id, data, url, uName, uPic, ownerUid) {
    const isLiked = data.likes && data.likes[currentUser.uid];
    const mutedClass = isGlobalMuted ? 'muted-state' : '';
    
    // 1. Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ø¨ÙŠÙ‚Ø±Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙŠ Ø¬Ø§ÙŠØ©)
    const isVerified = data.isVerified || false;
    const verifiedBadgeHTML = getBadge(isVerified, false); 

    // 2. ğŸ”¥ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³Ù… (Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…ÙŠÙ† Ø¨Ø³)
    const displayName = formatSmartName(uName);

    return `
    <div class="video-slide ${mutedClass}" id="slide-${id}" data-id="${id}">
    
        <div class="brand-loader" id="loader-${id}">
            <i class="fa-solid fa-heart-pulse brand-pulse-icon"></i>
        </div>
        
        <div class="mute-indicator">
            <i class="fa-solid fa-volume-xmark"></i> 
        </div>

        <video id="vid-${id}" loop playsinline muted preload="none" poster="${data.thumbnail || ''}">
            <source src="${url}" type="video/mp4">
        </video>
        
        <i class="fa-solid fa-heart big-heart" id="heart-anim-${id}"></i>
        
        <div class="interaction-layer" 
             onclick="handleSingleClick('${id}')" 
             ondblclick="handleDoubleClick('${id}')"></div>

        <div class="side-bar">
            <div class="action-btn" onclick="toggleLike('${id}')">
                <div class="icon-circle">
                    <i class="fa-solid fa-heart" id="like-icon-${id}" style="color: ${isLiked ? '#F72585' : '#fff'}"></i>
                </div>
                <span class="action-text" id="like-count-${id}">${data.likes ? Object.keys(data.likes).length : 0}</span>
            </div>

            <div class="action-btn" onclick="openComments('${id}', '${ownerUid}')">
                <div class="icon-circle"><i class="fa-solid fa-comment-dots"></i></div>
                <span class="action-text" id="comment-count-${id}">${data.commentsCount || 0}</span>
            </div>

            <div class="action-btn" onclick="shareVideo('${id}', '${data.text}')">
                <div class="icon-circle"><i class="fa-solid fa-share"></i></div>
                <span class="action-text">Ù…Ø´Ø§Ø±ÙƒØ©</span>
            </div>
            
             <div class="action-btn">
                <div class="icon-circle" style="background:none; border:none; box-shadow:none;"><i class="fa-solid fa-ellipsis" style="font-size:25px;"></i></div>
            </div>
        </div>

        <div class="video-info">
            <div class="info-inner">
                
                <div class="user-header-row">
                    <img src="${uPic || 'https://via.placeholder.com/50'}" class="header-avatar" onclick="location.href='profile.html?uid=${ownerUid}'">
                    
                    <div class="header-name-block" onclick="location.href='profile.html?uid=${ownerUid}'">
                        <span class="header-username" dir="auto">${displayName}</span> ${verifiedBadgeHTML}
                    </div>

                    <div class="follow-btn-inline" onclick="toggleFollow('${ownerUid}', this)">Ù…ØªØ§Ø¨Ø¹Ø©</div>
                </div>

                <div class="video-desc">${data.text || ''}</div>
                
                <div style="font-size:12px; color:#fff; display:flex; align-items:center; gap:5px; margin-top:5px; opacity:0.8;">
                    <i class="fa-solid fa-music"></i> 
                    <marquee scrollamount="4" style="width:150px;">Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ - ${displayName}</marquee>
                </div>

            </div>
        </div>

        <div class="progress-container" onclick="seekVideo(event, '${id}')">
            <div class="progress-bar" id="prog-${id}"></div>
        </div>
    </div>`;
}


        const observerOptions = { root: document.getElementById('feed'), threshold: 0.6 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const slide = entry.target;
                const vid = slide.querySelector('video');
                const id = slide.dataset.id;
                if (entry.isIntersecting) {
                    playVideo(vid, id);
                    if(slide.nextElementSibling === null) loadVideos();
                } else {
                    pauseVideo(vid);
                }
            });
        }, observerOptions);

        // --- 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø§Ù„Ø°ÙƒÙŠØ©) ---
function playVideo(vid, id) {
    const loader = document.getElementById(`loader-${id}`);
    const slide = document.getElementById(`slide-${id}`); 

    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    vid.ontimeupdate = () => {
        const pct = (vid.currentTime / vid.duration) * 100;
        const prog = document.getElementById(`prog-${id}`);
        if(prog) prog.style.width = `${pct}%`;
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ÙˆØ¯Ø±
    vid.onwaiting = () => { if(loader) loader.style.display = 'block'; };
    vid.onplaying = () => { if(loader) loader.style.display = 'none'; };

    // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    if (isGlobalMuted) {
        vid.muted = true;
        if(slide) slide.classList.add('muted-state');
    } else {
        vid.muted = false;
        if(slide) slide.classList.remove('muted-state');
    }

    // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„Ø°ÙƒÙŠØ©)
    var playPromise = vid.play();

    if (playPromise !== undefined) {
        playPromise
        .then(_ => {
            // Ù†Ø¬Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„! (Ø³ÙˆØ§Ø¡ Ø¨ØµÙˆØª Ø£Ùˆ Ø¨Ø¯ÙˆÙ†)
            // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†
            if(loader) loader.style.display = 'none';
        })
        .catch(error => {
            // ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ (ØºØ§Ù„Ø¨Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ù†Ø¹ Ø§Ù„ØµÙˆØª)
            console.log("Autoplay blocked, switching to muted...");

            // ğŸ”¥ Ø§Ù„Ø­Ù„: Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ§Ù…Øª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ÙÙˆØ±Ø§Ù‹
            vid.muted = true;
            if(slide) slide.classList.add('muted-state'); // Ø£Ø¸Ù‡Ø± Ø²Ø± "Ø§Ø¶ØºØ· Ù„Ù„ØµÙˆØª"
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ø¤ÙƒØ¯Ø©
            vid.play().then(() => {
                 if(loader) loader.style.display = 'none';
                 
            });
        });
    }
}


// --- 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø¨ØªÙ†Ø¶Ù Ø§Ù„Ù„ÙˆØ¯Ø±) ---
function pauseVideo(vid) { 
    vid.pause(); 
    
    // ğŸ”¥ Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ù†Ø®ÙÙŠ Ø§Ù„Ù„ÙˆØ¯Ø± Ù„Ù…Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙ‚Ù
    // Ø¹Ø´Ø§Ù† Ù„Ùˆ Ù‚Ù„Ø¨Øª Ø¨Ø³Ø±Ø¹Ø© Ù…ÙŠÙØ¶Ù„Ø´ ÙŠÙ„Ù ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ ÙØ§Øª
    const id = vid.id.split('-')[1]; // Ø¨Ù†Ø¬ÙŠØ¨ Ø±Ù‚Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ù€ ID Ø¨ØªØ§Ø¹Ù‡
    const loader = document.getElementById(`loader-${id}`);
    if(loader) loader.style.display = 'none';
}

        function pauseVideo(vid) { vid.pause(); }
        
        function seekVideo(e, id) {
            e.stopPropagation();
            const vid = document.getElementById(`vid-${id}`);
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            vid.currentTime = pct * vid.duration;
        }

        // --- ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¶ØºØ· ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ… ---
let lastClickTime = 0;

function handleSingleClick(id) {
    const slide = document.getElementById(`slide-${id}`); // Ø§Ù„ÙƒØ§Ø±Øª Ù†ÙØ³Ù‡
    const vid = document.getElementById(`vid-${id}`);     // Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const now = new Date().getTime();

    if (now - lastClickTime < 250) { 
        handleDoubleClick(id); 
        lastClickTime = now;
        return;
    }
    lastClickTime = now;

    setTimeout(() => {
        if (new Date().getTime() - lastClickTime < 250) return;

        // Ø§Ù„Ø­Ø§Ù„Ø© 1: Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ… (Ø£ÙˆÙ„ Ù…Ø±Ø© ØªØ¶ØºØ·)
        if (isGlobalMuted) {
            isGlobalMuted = false;
            vid.muted = false;
            
            // ğŸ‘‡ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ø´ÙØ§Ù Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¯Ù‡ ÙˆÙ…Ù† ÙƒÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
            slide.classList.remove('muted-state');
            document.querySelectorAll('.video-slide').forEach(s => s.classList.remove('muted-state'));
            document.querySelectorAll('video').forEach(v => v.muted = false);
            
            return;
        }

        // Ø§Ù„Ø­Ø§Ù„Ø© 2: Ø§Ù„ØµÙˆØª Ø´ØºØ§Ù„ (ØªÙˆÙ‚Ù Ø£Ùˆ ØªØ´ØºÙ„)
        if (vid.paused) {
            vid.play();
        } else {
            vid.pause();
        }

    }, 250);
}


        function handleDoubleClick(id) {
            const heart = document.getElementById(`heart-anim-${id}`);
            heart.classList.add('animate'); setTimeout(() => heart.classList.remove('animate'), 1000);
            const icon = document.getElementById(`like-icon-${id}`);
            if(icon.style.color !== 'rgb(247, 37, 133)') toggleLike(id);
        }

        function toggleLike(id) {
            const icon = document.getElementById(`like-icon-${id}`);
            const countSpan = document.getElementById(`like-count-${id}`);
            let count = parseInt(countSpan.innerText);
            const isLiked = icon.style.color === 'rgb(247, 37, 133)';
            
            if(isLiked) {
                icon.style.color = '#fff'; countSpan.innerText = count - 1;
                db.collection('posts').doc(id).update({ [`likes.${currentUser.uid}`]: firebase.firestore.FieldValue.delete() });
            } else {
                icon.style.color = '#F72585'; countSpan.innerText = count + 1;
                db.collection('posts').doc(id).update({ [`likes.${currentUser.uid}`]: true });
            }
        }

        // =========================================================================
        // ==================== Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Ø§Ù„Ù…ÙØ­Ø³Ù†) =========================
        // =========================================================================

        function getGhostIdentity(uid) {
            if (!uid) return { id: '0000', color: '#ff0000' };
            let hash = 0;
            for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            hash = Math.abs(hash);
            const ghostID = (hash % 9000) + 1000;
            const colorIndex = hash % ghostColors.length;
            return { id: ghostID, color: ghostColors[colorIndex] };
        }

        function generateColor(uid) {
            const c=["#5D5FEF","#34c759","#ff3b30","#ffb533","#2AF598","#009EFD"];
            let h=0; for(let i=0;i<uid.length;i++) h=uid.charCodeAt(i)+((h<<5)-h);
            return c[Math.abs(h)%c.length];
        }

        // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ø´ØºÙ„Ù†Ø§ Ø§Ù„Ù…Ù†Ø´Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³
let isMentionSetup = false; 

function openComments(pid, ownerUid) {
    currentOpenVideoId = pid;
    currentPostOwnerUid = ownerUid;
    
    // 1. ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.classList.add('no-scroll'); 
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('cmSheet').classList.add('active');

    // 3. ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const list = document.getElementById('cmList');
    list.innerHTML = '<div id="loading-spinner" style="text-align:center; padding:20px; color:#aaa"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    // 4. ØªÙØ±ÙŠØº Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§
    resetCommentInput();
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ø´Ø§Ù† Ù…ÙŠØªÙƒØ±Ø±Ø´
    if (!isMentionSetup) {
        setupMentionListener('cmInput', 'mentionDropdown');
        isMentionSetup = true;
    }

    // 5. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¹Ø´Ø§Ù† Ù…Ù†Ø¬Ø¨Ø´ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ ÙØ§Øª)
    if(commentsUnsub) commentsUnsub(); 

    // 6. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    commentsUnsub = db.collection("posts").doc(pid).collection("comments")
    .orderBy('createdAt', 'asc')
    .onSnapshot(snap => {
        // Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØµÙ„ØŒ Ø´ÙŠÙ„ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const spinner = document.getElementById('loading-spinner');
        if(spinner) spinner.remove();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        document.getElementById('cmCount').innerText = `Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${snap.size})`;
        const uiCount = document.getElementById(`comment-count-${pid}`);
        if(uiCount) uiCount.innerText = snap.size;

        if(snap.empty) {
            list.innerHTML = '<div class="empty-msg" style="text-align:center; color:#777; margin-top:20px">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚!</div>';
            return;
        } else {
            // Ù„Ùˆ ÙÙŠÙ‡ ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ ØªØ£ÙƒØ¯ Ø¥Ù† Ø±Ø³Ø§Ù„Ø© "ÙØ§Ø±Øº" Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
            const emptyMsg = list.querySelector('.empty-msg');
            if(emptyMsg) emptyMsg.remove();
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù)
        snap.docChanges().forEach(change => {
            const data = change.doc.data();
            data.id = change.doc.id;

            if (change.type === "added") {
                const el = createCommentElement(data);
                list.appendChild(el);
                // Ø§Ù†Ø²Ù„ Ù„ØªØ­Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø£Ø¬Ø¯Ø¯ ØªØ¹Ù„ÙŠÙ‚
                if(list.scrollHeight - list.scrollTop < 600) { // Ø´Ø±Ø· Ø°ÙƒÙŠ: Ø§Ù†Ø²Ù„ Ø¨Ø³ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ Ø·Ø§Ù„Ø¹ ÙÙˆÙ‚
                     list.scrollTop = list.scrollHeight;
                }
            }
            if (change.type === "modified") {
                const oldEl = document.getElementById(`comment-${data.id}`);
                if(oldEl) {
                    const newEl = createCommentElement(data);
                    list.replaceChild(newEl, oldEl);
                }
            }
            if (change.type === "removed") {
                const el = document.getElementById(`comment-${data.id}`);
                if(el) el.remove();
            }
        });
    });
}
        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (Ù…ÙØµÙˆÙ„Ø© Ù„ØªØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„)
        function createCommentElement(c) {
    // ---------------------------------------------------------
    // 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ---------------------------------------------------------
    let displayName = c.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
    let displayPic = c.pic;
    let verifiedDisplay = c.isVerified;
    let uidSafe = c.uid || 'user';
    let clickAction = `location.href='profile.html?uid=${uidSafe}'`;
    let avatarContent = displayPic ? '' : (displayName[0]);
    let avatarStyle = "";
    let nameColorStyle = "";


    // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ (Ghost Mode)
    if (c.isGhost) {
        const ghostIdentity = getGhostIdentity(uidSafe);
        displayName = `Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶ #${ghostIdentity.id}`;
        displayPic = "";
        verifiedDisplay = false;
        avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:18px;"></i>`;
        avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 5px ${ghostIdentity.color}40;`;
        nameColorStyle = `color: ${ghostIdentity.color} !important; text-shadow: 0 0 5px ${ghostIdentity.color}40;`;
        clickAction = "showToast('â›” Ù‡ÙˆÙŠØ© Ù…Ø­Ù…ÙŠØ©')";
    } else {
        avatarStyle = displayPic ? 
            `background: url('${displayPic}') center/cover no-repeat; border: 1px solid var(--border-color);` : 
            `background: ${generateColor(uidSafe)}; border: 1px solid var(--border-color); display:grid; place-items:center;`;
    }

    let timeString = c.createdAt ? moment(c.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†';
   
   const verifiedIcon = getBadge(c.isVerified, c.isGhost);

   
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠ
    const el = document.createElement('div');
    el.className = 'comment-item';
    el.id = `comment-${c.id}`;

    // ---------------------------------------------------------
    // 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events) - Ù…Ø´ØªØ±Ùƒ Ù„Ù„ÙƒÙ„
    // ---------------------------------------------------------
    
    // Ø£) Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø© (Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©)
    el.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openCommentOptions(c), 600); });
    el.addEventListener('touchend', () => clearTimeout(pressTimer));
    el.addEventListener('touchmove', () => clearTimeout(pressTimer));

    // Ø¨) Ø¶ØºØ·Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© (Ù„Ù„Ø§ÙŠÙƒ)
    let lastTap = 0;
    el.addEventListener('touchend', function(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0 && !e.target.closest('.cm-action') && !e.target.closest('.play-btn')) {
            e.preventDefault();
            toggleCommentLike(c.id);
            // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚Ù„Ø¨
            const heartContainer = c.isGift ? el.querySelector('.gift-body') : el.querySelector('.cm-bubble');
            if(heartContainer) {
                const heart = document.createElement('i');
                heart.className = 'fa-solid fa-heart';
                heart.style.cssText = `position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0); font-size: 40px; color: #ff3b30; pointer-events: none; z-index: 100; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); transition: transform 0.3s;`;
                heartContainer.appendChild(heart);
                setTimeout(() => heart.style.transform = 'translate(-50%, -50%) scale(1.5)', 50);
                setTimeout(() => { heart.style.opacity = '0'; setTimeout(() => heart.remove(), 300); }, 600);
            }
            if(navigator.vibrate) navigator.vibrate(50);
        }
        lastTap = currentTime;
    });

    // Ø¬) Ø¶ØºØ·Ø© Ø¹Ø§Ø¯ÙŠØ© (Ù„Ù„Ø±Ø¯ÙˆØ¯)
    el.onclick = (e) => { 
        if (!e.target.classList.contains('cm-action') && 
            !e.target.closest('.play-btn') && 
            !e.target.closest('.vid-btn') && 
            !e.target.closest('.cm-media-img') &&
            !e.target.closest('.read-more-btn') && 
            !e.target.closest('.custom-video-container')) {
            
            openRepliesSheet(
                c.id, c.uid, c.name, c.pic, c.isVerified, 
                c.text, c.isGhost, c.isAudio, c.duration
            ); 
        }
    };

    // ---------------------------------------------------------
    // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ HTML Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (Ù‡Ø¯ÙŠØ© VS Ø¹Ø§Ø¯ÙŠ)
    // ---------------------------------------------------------

    // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù‡Ø¯ÙŠØ© (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯) ğŸ”¥ğŸ”¥ğŸ”¥
    if (c.isGift) {
        // Ù†ØºÙŠØ± ÙƒÙ„Ø§Ø³ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ù†Ø¸Ø¨Ø· Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        el.className = 'comment-item gift-wrapper-pro';

        el.innerHTML = `
            <div class="cm-avatar" style="${avatarStyle}; width:35px; height:35px; border: 2px solid #FFD700; box-shadow:0 0 10px rgba(255,215,0,0.3);" onclick="${clickAction}">${avatarContent}</div>
            
            <div class="gift-body">
                <div class="gift-hero-icon">${c.giftEmoji || 'ğŸ'}</div>
                
                <div class="gift-gold-badge">
                     Ø£Ø±Ø³Ù„ ${c.giftName || 'Ù‡Ø¯ÙŠØ©'}
                </div>

                <div class="gift-meta">
                    <span style="color:#FFD700">${displayName}</span> â€¢ ${timeString} â€¢ 
              <span class="cm-action" style="color:#fff; cursor:pointer;" onclick="event.stopPropagation(); openRepliesSheet({
    id: '${c.id}', 
    uid: '${c.uid}', 
    name: '${displayName}', 
    pic: '${displayPic}', 
    isVerified: ${c.isVerified||false}, 
    text: '${(c.text||"").replace(/'/g, "\\'")}', 
    isGift: true,
    giftEmoji: '${c.giftEmoji}',
    giftName: '${c.giftName}'
})">Ø±Ø¯</span>

                </div>
            </div>
        `;
    } 
    
    // ğŸ”µğŸ”µğŸ”µ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ØªØ¹Ù„ÙŠÙ‚ Ø¹Ø§Ø¯ÙŠ (Ù†ØµØŒ ØµÙˆØªØŒ ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆ) ğŸ”µğŸ”µğŸ”µ
    else {
        // ØªØ¬Ù‡ÙŠØ² ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
        let hash = 0; 
        if(c.uid) { for (let i = 0; i < c.uid.length; i++) hash = c.uid.charCodeAt(i) + ((hash << 5) - hash); }
        const colorClass = `color-${Math.abs(hash) % 10}`;
        const isPostOwner = (c.uid === currentPostOwnerUid);
        
        let bubbleClass = `cm-bubble colored-comment ${colorClass}`;
        if (isPostOwner) bubbleClass += ' owner-bubble';
        if (c.isSticker) bubbleClass += " sticker-comment"; 

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
        let contentHtml = "";

        if (c.isAudio) {
            contentHtml = `
            <div class="custom-audio-player" id="player_${c.id}" onclick="event.stopPropagation()">
                <button class="play-btn" id="btn_${c.id}" onclick="toggleAudio('${c.id}', event)"><i class="fa-solid fa-play"></i></button>
                <input type="range" class="audio-slider" id="range_${c.id}" value="0" oninput="seekAudio('${c.id}', event)">
                <span id="dur_${c.id}" class="audio-time">${c.duration || '00:00'}</span>
                <audio id="audio_${c.id}" src="${c.text}" preload="metadata" ontimeupdate="updateAudioProgress('${c.id}')" onended="resetAudio('${c.id}')"></audio>
            </div>`;
        } 
        else if (c.isImage) {
            contentHtml = `<div class="cm-media-wrapper"><img src="${c.text}" class="cm-media-img" loading="lazy" onclick="viewImageWithSave('${c.text}')"></div>`;
        } 
        else if (c.isVideo) {
            contentHtml = `
            <div class="cm-media-wrapper">
                <div class="custom-video-container" id="vid_cont_${c.id}" onclick="toggleCommentVideo('${c.id}')">
                    <video src="${c.text}" id="vid_${c.id}" class="custom-video-element" loop playsinline preload="metadata"></video>
                    <div class="vid-center-play" id="play_icon_${c.id}"><i class="fa-solid fa-play"></i></div>
                    <div class="vid-controls">
                        <div class="vid-btn" onclick="toggleCommentMute('${c.id}', event)"><i class="fa-solid fa-volume-xmark" id="mute_icon_${c.id}"></i></div>
                        <div class="vid-btn vid-speed-btn" id="speed_btn_${c.id}" onclick="changeVideoSpeed('${c.id}', event)">1x</div>
                        <div class="vid-btn" onclick="toggleCommentFullscreen('${c.id}', event)"><i class="fa-solid fa-expand"></i></div>
                    </div>
                </div>
            </div>`;
        } 
        else {
            // Ù†Øµ Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ Ø³ØªÙŠÙƒØ±
            let displayText = c.text || "";
            if (!c.isSticker && c.replyToUid && c.replyToName && displayText.startsWith(c.replyToName)) {
                const cleanText = displayText.substring(c.replyToName.length);
                displayText = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${c.replyToUid}'">${c.replyToName}</span> <span style="color:inherit">${cleanText}</span>`;
            }
            
            let extraClass = ""; let btnHtml = "";
            if (!c.isSticker && (c.text || "").length > 150) {
                extraClass = "collapsed";
                btnHtml = `<span class="read-more-btn" onclick="toggleReadMore(this)">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯... ğŸ‘‡</span>`;
            }
            contentHtml = `<div class="cm-text ${extraClass}" style="${c.isSticker ? 'font-size:45px' : ''}">${displayText}</div>${btnHtml}`;
        }

        // Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        el.innerHTML = `
            <div class="cm-avatar" style="${avatarStyle}" onclick="${clickAction}">${avatarContent}</div>
            <div class="cm-content">
                <div class="${bubbleClass}"> 
                    <div class="cm-username" style="${nameColorStyle}">
                        ${displayName} ${verifiedIcon}
                        ${isPostOwner && !c.isGhost ? '<span class="owner-badge">Ù…Ø¤Ù„Ù</span>' : ''} 
                    </div>
                    ${contentHtml}
                </div>
                <div class="cm-meta-row">
                    <span>${timeString}</span>
                    <span class="cm-action" onclick="event.stopPropagation(); openRepliesSheet({
    id: '${c.id}', 
    uid: '${c.uid}', 
    name: '${displayName}', 
    pic: '${displayPic}', 
    isVerified: ${c.isVerified||false}, 
    text: '${(c.text || "").replace(/'/g, "\\'")}', 
    isGhost: ${c.isGhost||false}, 
    isAudio: ${c.isAudio||false}, 
    duration: '${c.duration||"00:00"}',
    isImage: ${c.isImage||false},
    isVideo: ${c.isVideo||false}
})">Ø±Ø¯</span>
                </div>
            </div>
        `;
    }

    // ØªØ´ØºÙŠÙ„ Ù„Ù…Ø¨Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ù…Ø´ØªØ±Ùƒ)
    setTimeout(() => {
        if(!c.isGhost && typeof checkAndColorAvatar === 'function') checkAndColorAvatar(c.uid, el.querySelector('.cm-avatar'));
    }, 0);

    return el;
}


        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¯ÙˆÙ† Ø­Ø°Ù...
        function handleInputTyping(textarea) {
            const actionBtn = document.getElementById('dynamicActionBtn');
            const micIcon = document.getElementById('mainMicIcon');
            const sendIcon = document.getElementById('mainSendIcon');
            
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';

            if (textarea.value.trim().length > 0) {
                micIcon.style.display = 'none';
                sendIcon.style.display = 'block';
                actionBtn.classList.remove('mic-mode');
                actionBtn.classList.add('send-mode');
                actionBtn.onclick = function() { handleCommentAction(); };
            } else {
                micIcon.style.display = 'block';
                sendIcon.style.display = 'none';
                actionBtn.classList.add('mic-mode');
                actionBtn.classList.remove('send-mode');
                actionBtn.onclick = function() { toggleRecording(); };
                textarea.style.height = '45px';
            }
        }

        function resetCommentInput() {
            const inp = document.getElementById('cmInput');
            if(inp) {
                inp.value = ""; 
                handleInputTyping(inp);
            }
            isEditingComment = false;
        }

        async function toggleRecording() {
            if(isRecording) { stopAndSendRecording(); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                document.getElementById("normalModeUI").style.display = "none";
                document.getElementById("recordingModeUI").style.display = "flex";
                let seconds = 0;
                document.getElementById("recordTimer").innerText = "00:00";
                recordInterval = setInterval(() => {
                    seconds++;
                    const m = Math.floor(seconds/60).toString().padStart(2,'0');
                    const s = (seconds%60).toString().padStart(2,'0');
                    document.getElementById("recordTimer").innerText = `${m}:${s}`;
                }, 1000);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
                isRecording = true;
                if(navigator.vibrate) navigator.vibrate(50);
            } catch(e) {
                showToast("âš ï¸ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­");
                console.error(e);
            }
        }

        function cancelRecording() {
            if(mediaRecorder) mediaRecorder.stop();
            clearInterval(recordInterval);
            isRecording = false;
            audioChunks = [];
            resetUI();
        }

 async function stopAndSendRecording() {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        resetUI();
        return;
    }

    mediaRecorder.stop(); // ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„

    mediaRecorder.onstop = async () => {
        resetUI(); // Ø±Ø¬Ø¹ Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± Ø·Ø¨ÙŠØ¹ÙŠ

        if (audioChunks.length === 0) {
            showToast("âš ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙØ§Ø±Øº");
            return;
        }

        // 1. ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù Ø§Ù„ØµÙˆØª
        let mimeType = 'audio/webm';
        if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
        
        const audioBlob = new Blob(audioChunks, { type: mimeType });
        const ext = mimeType.includes('mp4') ? 'm4a' : 'webm';
        
        // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… currentOpenVideoId Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† currentPostId
        const voicePath = `comments_media_v2/${currentOpenVideoId}/voices/${Date.now()}_${currentUser.uid}.${ext}`; 
        const ref = storage.ref().child(voicePath);

        showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØµÙˆØªÙŠ... ğŸ™ï¸");

        try {
            // 3. Ø§Ù„Ø±ÙØ¹
            const snapshot = await ref.put(audioBlob);
            const url = await snapshot.ref.getDownloadURL();
            
            // 4. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const uDoc = await db.collection('users').doc(currentUser.uid).get();
            const uData = uDoc.data();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¹Ø±Ø¶)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø£Ù† Ù…ØªØºÙŠØ± recordSeconds Ù…Ø¹Ø±Ù Ù„Ø¯ÙŠÙƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø£Ø®Ø±Ù‰
            // Ù‡Ù†Ø§ Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø±
            const durationTxt = document.getElementById("recordTimer").innerText; 

            // 5. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… currentOpenVideoId
            await db.collection('posts').doc(currentOpenVideoId).collection('comments').add({
                uid: currentUser.uid,
                name: uData.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                pic: uData.profilePic || "",
                isVerified: uData.isVerified || false,
                text: url,          
                isAudio: true,      
                duration: durationTxt, 
                isGhost: (typeof isGhost !== 'undefined' ? isGhost : false),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            await db.collection('posts').doc(currentOpenVideoId).update({
                commentsCount: firebase.firestore.FieldValue.increment(1)
            });

            // Ø¥Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            if (typeof currentPostOwnerUid !== 'undefined' && currentPostOwnerUid !== currentUser.uid) {
                // ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© pushNotification Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø¯ÙŠÙƒ
                // pushNotification(currentPostOwnerUid, 'comment', 'Ø£Ø±Ø³Ù„ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ ØµÙˆØªÙŠØ§Ù‹ ğŸ™ï¸', null, currentOpenVideoId);
            }

            showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
            // playSound('sent'); // ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ù…ÙˆØ¬ÙˆØ¯Ø©

        } catch(e) {
            console.error(e);
            showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + e.message);
        }
    };
}

        function resetUI() {
            document.getElementById("recordingModeUI").style.display = "none";
            document.getElementById("normalModeUI").style.display = "flex";
            isRecording = false;
        }

        async function handleCommentAction(stickerContent = null, isSticker = false, giftData = null) {
    const inp = document.getElementById('cmInput');
    const txt = stickerContent || inp.value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰
    if(!txt && !isSticker && !giftData) return;

    // 1. ØªÙØ±ÙŠØº Ø§Ù„Ø®Ø§Ù†Ø© (Ù…Ø³Ø­ Ø§Ù„Ù†Øµ)
    inp.value = "";
    
    // ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ Ù‡Ù†Ø§ ğŸ”¥ğŸ”¥
    // Ø¨Ù†Ø³ØªØ¯Ø¹ÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ØªØ§Ù†ÙŠ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø¥Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø¶ÙŠ ÙØªÙ‚ÙˆÙ… Ù…ØµØºØ±Ø§Ù‡ ÙˆÙ…Ø±Ø¬Ø¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    handleInputTyping(inp); 
    
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ´ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù…Ù† Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (ÙŠÙ†Ø²Ù„ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
    // inp.blur(); 

    if(typeof playSound === 'function') playSound('sent'); 

    try {
        const uDoc = await db.collection('users').doc(currentUser.uid).get();
        const uData = uDoc.data();

        const commentData = {
            uid: currentUser.uid,
            name: uData.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            pic: uData.profilePic || "",
            isVerified: uData.isVerified || false,
            text: txt,
            isSticker: isSticker,
            isGift: !!giftData, 
            giftEmoji: giftData ? giftData.emoji : null,
            giftName: giftData ? giftData.name : null,
            giftEffect: giftData ? giftData.effect : null,
            isGhost: (typeof isGhost !== 'undefined' ? isGhost : false),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('posts').doc(currentOpenVideoId).collection('comments').add(commentData);

        await db.collection('posts').doc(currentOpenVideoId).update({
            commentsCount: firebase.firestore.FieldValue.increment(1)
        });

    } catch (e) {
        console.error("Error sending comment:", e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.message);
    }
}

const GiftSystem = {
    // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    data: {
        gifts: [
            { name: 'ØªØ§Ø¬', emoji: 'ğŸ‘‘', price: 1000, effect: 'rain' },
            { name: 'Ø£Ù„Ù…Ø§Ø³', emoji: 'ğŸ’', price: 500, effect: 'sparkle' },
            { name: 'Ø³ÙŠØ§Ø±Ø©', emoji: 'ğŸï¸', price: 2000, effect: 'slide' },
            { name: 'ÙˆØ±Ø¯Ø©', emoji: 'ğŸŒ¹', price: 50, effect: 'float' },
            { name: 'Ù‚Ù„Ø¨', emoji: 'â¤ï¸', price: 10, effect: 'pulse' },
            { name: 'Ø´Ø¹Ù„Ø©', emoji: 'ğŸ”¥', price: 100, effect: 'burn' }
        ],
        stickers: ['ğŸ˜€','ğŸ˜‚','ğŸ˜','ğŸ˜','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰','ğŸ‘€','ğŸ‘»']
    },

    targetType: 'comment', 

    // 2. Ø§Ù„ÙØªØ­ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    open: function() {
        this.targetType = 'comment';
        this._showSheet();
    },

    // 3. Ø§Ù„ÙØªØ­ Ù„Ù„Ø±Ø¯ÙˆØ¯
    openForReply: function() {
        this.targetType = 'reply';
        this._showSheet();
    },

    // ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ©) ğŸ”¥ğŸ”¥
    _showSheet: function() {
        const giftSheet = document.getElementById('giftSheet');
        const backdrop = document.getElementById('giftBackdrop'); // Ø¯Ù‡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        
        // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        giftSheet.classList.add('active');
        
        // Ø±ÙØ¹ Ø§Ù„Ø·Ø¨Ù‚Ø© ÙÙˆÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        giftSheet.style.zIndex = '300'; 

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© (Ø¹Ø´Ø§Ù† Ù†Ù‚ÙÙ„ Ù„Ù…Ø§ Ù†Ø¶ØºØ· Ø¨Ø±Ù‡)
        if(backdrop) backdrop.classList.add('active');

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        this.switch('gifts', document.querySelector('.gift-tab'));
    },

    switch: function(type, el) {
        document.querySelectorAll('.gift-tab').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');
        
        const container = document.getElementById('giftSystemContent');
        
        if(type === 'gifts') {
            let html = '<div class="premium-gift-grid">';
            this.data.gifts.forEach(g => {
                html += `
                <div class="premium-gift-card" onclick="GiftSystem.send('${g.emoji}', '${g.name}', '${g.effect}')">
                    <div class="pg-emoji">${g.emoji}</div>
                    <div class="pg-name">${g.name}</div>
                    <div class="pg-price">${g.price}</div>
                </div>`;
            });
            container.innerHTML = html + '</div>';
        } 
        else {
            let html = '<div class="stickers-grid">';
            this.data.stickers.forEach(s => {
                html += `<div class="sticker-option" onclick="GiftSystem.sendSticker('${s}')">${s}</div>`;
            });
            container.innerHTML = html + '</div>';
        }
    },

    send: function(emoji, name, effect) {
        const giftData = { emoji: emoji, name: name, effect: effect };
        
        if (this.targetType === 'reply') {
            sendReplyToComment(`Ø£Ø±Ø³Ù„ ${name} ${emoji}`, false, giftData);
        } else {
            handleCommentAction(`Ø£Ø±Ø³Ù„ ${name} ${emoji}`, false, giftData);
        }
        
        this.playEffect(emoji, effect);
        showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${name} Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰`);
        
        // Ù‡Ù†Ø§ Ù…Ø´ Ø¨Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ÙŠÙˆØ²Ø± ÙŠØ¨Ø¹Øª Ø¨Ø±Ø§Ø­ØªÙ‡
    },

    sendSticker: function(stickerEmoji) {
        if (this.targetType === 'reply') {
            sendReplyToComment(stickerEmoji, true); 
        } else {
            handleCommentAction(stickerEmoji, true);
        }
        // Ù‡Ù†Ø§ Ø¨Ù†Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ØªÙŠÙƒØ±
        this.closeGiftOnly(); 
    },

    playEffect: function(emoji, type) {
        const overlay = document.body;
        if(!overlay) return;
        const count = 30;
        for(let i=0; i<count; i++) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'fixed';
            el.style.left = Math.random() * 100 + '%';
            el.style.top = -50 + 'px';
            el.style.fontSize = (Math.random() * 30 + 20) + 'px';
            el.style.transition = `top ${Math.random() * 2 + 1.5}s ease-in, opacity 1s`;
            el.style.zIndex = "99999";
            el.style.pointerEvents = "none";
            overlay.appendChild(el);
            setTimeout(() => {
                el.style.top = (window.innerHeight + 100) + 'px';
                el.style.opacity = 0;
            }, 50);
            setTimeout(() => el.remove(), 4000);
        }
    },

    // ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ©) ğŸ”¥ğŸ”¥
    closeGiftOnly: function() {
        document.getElementById('giftSheet').classList.remove('active');
        
        // Ù†Ø®ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© ÙƒÙ…Ø§Ù†
        const backdrop = document.getElementById('giftBackdrop');
        if(backdrop) backdrop.classList.remove('active');
    }
};




        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ---
        function openCommentOptions(commentData) {
    if(navigator.vibrate) navigator.vibrate(50);
    selectedComment = commentData;
    
    // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    document.querySelectorAll('.cm-bubble').forEach(b => b.classList.remove('highlight'));
    const bubble = document.getElementById(`comment-${commentData.id}`).querySelector('.cm-bubble');
    if(bubble) bubble.classList.add('highlight');

    const isMyComment = (commentData.uid === currentUser.uid);
    const isPostOwner = (currentPostOwnerUid === currentUser.uid); // ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const ownerMenu = document.getElementById('cmOwnerOptionsNew');
    const viewerMenu = document.getElementById('cmViewerOptionsNew');

    if (isMyComment) {
        ownerMenu.style.display = 'flex';
        viewerMenu.style.display = 'none';
    } else {
        ownerMenu.style.display = 'none';
        viewerMenu.style.display = 'flex';
        
        // Ù„Ùˆ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙˆØ³ØªØŒ Ø£Ù‚Ø¯Ø± Ø£Ù…Ø³Ø­ Ø£ÙŠ ÙƒÙˆÙ…Ù†Øª (Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
        // Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ùˆ Ø­Ø§Ø¨Ø¨
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©
    document.getElementById('commentOptionsSheetNew').classList.add('active');
    document.getElementById('optionsBackdrop').style.display = 'block';
}

function closeFloatingMenu() {
    document.getElementById('commentOptionsSheetNew').classList.remove('active');
    document.getElementById('optionsBackdrop').style.display = 'none';
}


        /* --- ØªØµØ­ÙŠØ­ Ø£Ø²Ø±Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø¹Ø´Ø§Ù† ØªÙ‚ÙÙ„ Ù„Ù…Ø§ ØªØ¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§) --- */

// 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ­Ø­Ø©
function triggerEditComment() {
    // Ø£ÙˆÙ„ Ø­Ø§Ø¬Ø©: Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ÙŠ ÙÙŠ ÙˆØ´Ùƒ
    closeFloatingMenu(); 

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯: Ø­Ø· Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØ¬Ù‡Ø²Ù‡ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    const inp = document.getElementById('cmInput');
    if(inp && selectedComment) {
        inp.value = selectedComment.text; 
        inp.focus();
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±Ø§Ø± (Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
        handleInputTyping(inp); 
        
        isEditingComment = true;
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØµØ­Ø­Ø©
function triggerCopyComment() {
    // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
    closeFloatingMenu();

    if(selectedComment) {
        navigator.clipboard.writeText(selectedComment.text);
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ ğŸ“‹");
    }
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØµØ­Ø­Ø©
function triggerDeleteComment() {
    // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
    closeFloatingMenu();

    if(selectedComment) {
        showChicConfirm(
            "Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ", 
            "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.", 
            '<i class="fa-solid fa-trash-can" style="color:var(--danger-color)"></i>', 
            async function() {
                try {
                    await db.collection("posts").doc(currentOpenVideoId)
                        .collection("comments").doc(selectedComment.id).delete();
                        
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    await db.collection("posts").doc(currentOpenVideoId).update({ 
                        commentsCount: firebase.firestore.FieldValue.increment(-1) 
                    });
                    
                    showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸");
                } catch(e) {
                    console.error(e);
                    showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
                }
            }
        );
    }
}

// 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…ØµØ­Ø­Ø© (Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯)
function triggerReplyComment() {
    closeFloatingMenu();
    if(selectedComment) {
        openRepliesSheet(
            selectedComment.id, selectedComment.uid, selectedComment.name, 
            selectedComment.pic, selectedComment.isVerified, selectedComment.text, 
            selectedComment.isGhost, selectedComment.isAudio, selectedComment.duration
        );
    }
}


  function openRepliesSheet(idOrObj, uid, name, pic, isVerified, text, isGhostUser, isAudio, duration, isImage, isVideo, isGift, giftEmoji, giftName) {
    // Ø¯Ø¹Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ØªÙŠÙ† (Object Ø£Ùˆ Parameters)
    let commentData = {};
    if (typeof idOrObj === 'object') {
        commentData = idOrObj;
    } else {
        // ğŸ”¥ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯ÙŠØ© Ù‡Ù†Ø§
        commentData = { id: idOrObj, uid, name, pic, isVerified, text, isGhost: isGhostUser, isAudio, duration, isImage, isVideo, isGift, giftEmoji, giftName };
    }

    currentParentComment = commentData;
    
    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('repliesSheet').classList.add('active');
    
    // ØªØ¬Ù‡ÙŠØ² Ø¹Ø±Ø¶ "Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£Ø¨" ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    let parentContentHtml = "";
    
    // 1. Ù„Ùˆ Ø§Ù„Ø£Ø¨ Ù‡Ø¯ÙŠØ© ğŸ
    if (commentData.isGift) {
        parentContentHtml = `
        <div class="header-gift-preview">
            <span style="font-size:25px;">${commentData.giftEmoji || 'ğŸ'}</span>
            <span style="color:#FFD700; font-weight:bold; font-size:12px;">Ø£Ø±Ø³Ù„ ${commentData.giftName || 'Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©'}</span>
        </div>`;
    }
    // 2. Ù„Ùˆ ØµÙˆØª
    else if (commentData.isAudio || (typeof commentData.text === 'string' && (commentData.text.includes('.m4a') || commentData.text.includes('.webm')))) {
        parentContentHtml = `
        <div class="custom-audio-player" id="player_parent_${commentData.id}" onclick="event.stopPropagation()" style="width: 100%; margin-top: 5px; transform: scale(0.9); transform-origin: right;">
            <button class="play-btn" id="btn_parent_${commentData.id}" onclick="toggleAudio('parent_${commentData.id}', event)">
                <i class="fa-solid fa-play"></i>
            </button>
            <input type="range" class="audio-slider" id="range_parent_${commentData.id}" value="0" oninput="seekAudio('parent_${commentData.id}', event)">
            <span id="dur_parent_${commentData.id}" class="audio-time">${commentData.duration || '00:00'}</span>
            <audio id="audio_parent_${commentData.id}" src="${commentData.text}" preload="metadata" ontimeupdate="updateAudioProgress('parent_${commentData.id}')" onended="resetAudio('parent_${commentData.id}')"></audio>
        </div>`;
    } 
    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø±ÙˆØ· (ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆØŒ Ù†Øµ) ÙƒÙ…Ø§ Ù‡ÙŠ ...
    else if (commentData.isImage) {
        parentContentHtml = `<div class="cm-media-wrapper" style="max-height: 100px;"><img src="${commentData.text}" class="cm-media-img" onclick="viewImageWithSave('${commentData.text}')"></div>`;
    }
    else if (commentData.isVideo) {
         parentContentHtml = `<div style="font-size:12px; color:#aaa;"><i class="fa-solid fa-video"></i> ÙÙŠØ¯ÙŠÙˆ</div>`;
    }
    else {
        parentContentHtml = `<div style="font-size:14px; color:#ddd; margin-top:5px;">${commentData.text || ''}</div>`;
    }

    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø§Ø±Ø©
    const parentBadge = getBadge(commentData.isVerified, commentData.isGhost);
    
    
    // Ø±Ø³Ù… Ø§Ù„Ù‡ÙŠØ¯Ø±
    const list = document.getElementById('repliesList');
    list.innerHTML = `
        <div style="padding:15px; border-bottom:1px solid #333; background:rgba(255,255,255,0.02)">
            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰:</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="cm-avatar" style="width:35px; height:35px; background-image:url('${commentData.pic||''}'); background-size:cover;"></div>
                
  <div style="font-weight:bold; font-size:13px; color:#fff;">
        ${commentData.name} ${parentBadge}
    </div>

            </div>
        </div>
        <div id="actualReplies"></div>`;
        
    loadRealtimeReplies(commentData.id);
}

        function loadRealtimeReplies(commentId) {
    const container = document.getElementById('actualReplies');
    if(replyListener) replyListener();

    replyListener = db.collection("posts").doc(currentOpenVideoId)
    .collection("comments").doc(commentId)
    .collection("replies").orderBy("createdAt", "asc")
    .onSnapshot(snap => {
        container.innerHTML = "";
        
        let participants = [currentParentComment.uid];

        snap.forEach((doc, index) => {
            const r = {id: doc.id, ...doc.data()};
            
            // 1. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let displayName = r.name, displayPic = r.pic;
            let avatarStyle = "";
            let nameStyle = "";

            if(r.isGhost) {
                const g = getGhostIdentity(r.uid);
                displayName = `Ù…Ø³ØªØ®Ø¯Ù… #${g.id}`; displayPic = "";
                avatarStyle = `background:#000; border:1px solid ${g.color}; display:grid; place-items:center;`;
                nameStyle = `color:${g.color} !important;`;
            } else {
                avatarStyle = displayPic ? `background-image:url('${displayPic}')` : `background:${generateColor(r.uid)}`;
            }

            // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶) - ØªØ¹Ø±ÙŠÙ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù‡Ù†Ø§
            const badgeHTML = getBadge(r.isVerified, r.isGhost);

            // 3. ØªØ¬Ù‡ÙŠØ² Ø´Ø¬Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯
            let userIndex = participants.indexOf(r.uid);
            if (userIndex === -1) { participants.push(r.uid); userIndex = participants.length - 1; }
            const colorClass = `color-${userIndex % 10}`;
            
            const isLast = index === snap.size - 1;
            const treeLineStyle = isLast ? "height: 25px;" : "bottom: -15px;";

            // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù‡Ø¯ÙŠØ© / ØµÙˆØª / ØµÙˆØ±Ø© / ÙÙŠØ¯ÙŠÙˆ / Ù†Øµ)
            let contentHtml = "";

            if (r.isGift) {
                contentHtml = `
                <div class="reply-gift-container">
                    <div class="gift-body" style="align-items: flex-start;">
                        <div class="gift-hero-icon" style="font-size: 60px;">${r.giftEmoji || 'ğŸ'}</div>
                        <div class="gift-gold-badge" style="margin-top: -5px; font-size: 9px; padding: 2px 10px;">
                             Ø£Ø±Ø³Ù„ ${r.giftName || 'Ù‡Ø¯ÙŠØ©'}
                        </div>
                    </div>
                </div>`;
            }
            else if (r.isAudio || (typeof r.text === 'string' && (r.text.includes('.m4a') || r.text.includes('.webm') || r.text.includes('.mp3')))) {
                contentHtml = `
                <div class="custom-audio-player" id="player_${r.id}" onclick="event.stopPropagation()" style="width: 200px !important; margin-top:5px;">
                    <button class="play-btn" id="btn_${r.id}" onclick="toggleAudio('${r.id}', event)"><i class="fa-solid fa-play"></i></button>
                    <input type="range" class="audio-slider" id="range_${r.id}" value="0" oninput="seekAudio('${r.id}', event)">
                    <span id="dur_${r.id}" class="audio-time">${r.duration || '00:00'}</span>
                    <audio id="audio_${r.id}" src="${r.text}" preload="metadata" ontimeupdate="updateAudioProgress('${r.id}')" onended="resetAudio('${r.id}')"></audio>
                </div>`;
            }
            else if (r.isImage) {
                contentHtml = `<div class="cm-media-wrapper" style="max-width: 180px;"><img src="${r.text}" class="cm-media-img" onclick="viewImageWithSave('${r.text}')"></div>`;
            }
            else if (r.isVideo) {
                contentHtml = `
                <div class="cm-media-wrapper" style="max-width: 200px;">
                    <div class="custom-video-container" id="vid_cont_${r.id}" onclick="toggleCommentVideo('${r.id}')">
                        <video src="${r.text}" id="vid_${r.id}" class="custom-video-element"></video>
                        <div class="vid-center-play" id="play_icon_${r.id}"><i class="fa-solid fa-play"></i></div>
                        <div class="vid-controls">
                            <div class="vid-btn" onclick="toggleCommentMute('${r.id}', event)"><i class="fa-solid fa-volume-xmark" id="mute_icon_${r.id}"></i></div>
                            <div class="vid-btn" onclick="toggleCommentFullscreen('${r.id}', event)"><i class="fa-solid fa-expand"></i></div>
                        </div>
                    </div>
                </div>`;
            }
            else {
                let displayText = r.text;
                if (!r.isSticker && r.replyToUid && r.replyToName && displayText.startsWith(r.replyToName)) {
                    const cleanText = displayText.substring(r.replyToName.length);
                    displayText = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${r.replyToUid}'">${r.replyToName}</span> ${cleanText}`;
                }
                contentHtml = `<div class="${r.isSticker ? '' : 'cm-text'}" style="${r.isSticker?'font-size:40px':''}">${displayText}</div>`;
            }

            // 5. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
            let bubbleWrapperStart = "";
            let bubbleWrapperEnd = `</div>`;

            if (r.isGift) {
                bubbleWrapperStart = `<div class="" style="margin-top:5px;">`; 
            } else {
                let bubbleClasses = `cm-bubble colored-reply ${colorClass}`;
                if (r.isSticker) bubbleClasses += " sticker-comment";
                bubbleWrapperStart = `<div class="${bubbleClasses}">`;
            }

            // 6. Ø±Ø³Ù… Ø§Ù„Ø±Ø¯
            const replyWrapper = document.createElement('div');
            replyWrapper.style.cssText = "position:relative; margin-right:25px; margin-bottom:15px; margin-top:10px;";
            
            replyWrapper.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openReplyOptions(r), 600); });
            replyWrapper.addEventListener('touchend', () => clearTimeout(pressTimer));

            replyWrapper.innerHTML = `
                <div class="tree-connector" style="${treeLineStyle}"></div>
                <div class="reply-curve"></div>
                <div style="display:flex; gap:10px; align-items: flex-start;">
                    <div class="cm-avatar" style="width:30px; height:30px; ${avatarStyle}; background-size:cover;">
                        ${r.isGhost ? '<i class="fa-solid fa-user-secret"></i>' : ''}
                    </div>
                    <div class="cm-content">
                        ${bubbleWrapperStart}
                            <div class="cm-username" style="font-size:12px; ${nameStyle}">
                                ${displayName} ${badgeHTML} 
                            </div>
                            ${contentHtml}
                        ${bubbleWrapperEnd}
                        
                        <div class="cm-meta-row" style="margin-right:5px; font-size:10px;">
                            ${!r.isGhost ? `<span class="cm-action" onclick="prepareSubReply('${r.uid}', '${displayName}')">Ø±Ø¯</span>` : ''}
                        </div>
                    </div>
                </div>`;
            container.appendChild(replyWrapper);
        });
    });
}

        function prepareReply(cid, uid, name) {
            openRepliesSheet({id: cid, uid: uid, name: name, text: "..."});
        }

        function prepareSubReply(uid, name) {
            currentSubReplyTarget = { uid: uid, name: name };
            const inp = document.getElementById('replyInput');
            inp.value = name + " "; inp.focus();
        }

 async function sendReplyToComment(stickerContent = null, isSticker = false, giftData = null) {
    const inp = document.getElementById('replyInput');
    let txt = stickerContent || inp.value.trim();
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ùˆ ÙÙŠÙ‡ Ù†ØµØŒ Ø£Ùˆ Ø³ØªÙŠÙƒØ±ØŒ Ø£Ùˆ Ù‡Ø¯ÙŠØ©
    if((!txt && !isSticker && !giftData) || !currentParentComment) return;
    
    if(!isSticker) txt = txt.replace(/^@/, '');

    let replyToUid = null, replyToName = null;
    if (!isSticker && !giftData && currentSubReplyTarget && txt.startsWith(currentSubReplyTarget.name)) {
        replyToUid = currentSubReplyTarget.uid; replyToName = currentSubReplyTarget.name;
    }

    try {
        await db.collection("posts").doc(currentOpenVideoId).collection("comments").doc(currentParentComment.id).collection("replies").add({
            uid: currentUser.uid,
            name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            pic: currentUserData?.profilePic || "", 
            isVerified: currentUserData?.isVerified || false,
            
            text: txt, // Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ "Ø£Ø±Ø³Ù„ ØªØ§Ø¬" Ù…Ø«Ù„Ø§Ù‹
            
            isSticker: isSticker,
            
            // ğŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯ÙŠØ© (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
            isGift: !!giftData,
            giftEmoji: giftData ? giftData.emoji : null,
            giftName: giftData ? giftData.name : null,
            giftEffect: giftData ? giftData.effect : null,

            isGhost: isGhost,
            replyToUid: replyToUid, replyToName: replyToName,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        inp.value = ""; 
        currentSubReplyTarget = null;
        if(typeof playSound === 'function') playSound('sent');

    } catch(e) { console.error(e); }
}


        function openReplyOptions(r) {
            selectedReply = r;
            const isMyReply = (r.uid === currentUser.uid);
            document.getElementById('replyOwnerOptions').style.display = isMyReply ? 'block' : 'none';
            document.getElementById('replyViewerOptions').style.display = isMyReply ? 'none' : 'block';
            if (!isMyReply) document.getElementById('replyToUserBtn').innerHTML = `<i class="fa-solid fa-reply"></i> Ø±Ø¯ Ø¹Ù„Ù‰ ${r.name}`;
            document.getElementById('replyOptionsSheet').classList.add('active');
        }

        function triggerEditReplyAction() { /* ... ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ... */ }
        function triggerDeleteReply() { /* ... ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù ... */ }
        function triggerReplyToUser() { /* ... */ }

        function setupMentionListener(inputId, dropdownId) {
            const inp = document.getElementById(inputId);
            const drop = document.getElementById(dropdownId);
            inp.addEventListener('keyup', async () => {
                const val = inp.value;
                const lastWord = val.split(" ").pop();
                if (lastWord.startsWith('@')) {
                    drop.classList.add('active');
                    drop.innerHTML = '<div style="padding:10px;">Ø¨Ø­Ø«...</div>';
                    const q = lastWord.substring(1);
                    const snap = await db.collection('users').orderBy('name').startAt(q).endAt(q+'\uf8ff').limit(5).get();
                    drop.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const item = document.createElement('div');
                        item.className = 'mention-suggest-item';
                        item.innerText = d.name;
                        item.onclick = () => {
                            inp.value = val.replace(lastWord, d.name + " ");
                            drop.classList.remove('active');
                        };
                        drop.appendChild(item);
                    });
                } else {
                    drop.classList.remove('active');
                }
            });
        }

        function closeAllSheets() {
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            document.getElementById('overlay').style.display = 'none';
            
            document.body.classList.remove('no-scroll'); 

            document.body.classList.remove('no-scroll');
            isEditingComment = false; isEditingReply = false;
            resetCommentInput();
        }

        function showChicConfirm(title, message, iconHTML, callback) {
            document.getElementById('chicTitle').innerText = title;
            document.getElementById('chicMessage').innerText = message;
            document.getElementById('chicIcon').innerHTML = iconHTML;
            document.getElementById('chicConfirmModal').style.display = 'flex';
            document.getElementById('chicConfirmBtn').onclick = () => {
                callback();
                closeChicModal();
            };
        }
        function closeChicModal() { document.getElementById('chicConfirmModal').style.display = 'none'; }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function reportComment() {
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            showToast("ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©");
        }
        
        // --- 1. Ø¯Ø§Ù„Ø© ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ---
function expandInputArea() {
    document.querySelector('.input-area-container').classList.add('focused');
    document.getElementById('commentFooter').classList.add('expanded');
}

// --- 2. Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ---
function insertEmoji(emoji) {
    const input = document.getElementById('cmInput');
    input.value += emoji;
    input.focus();
    handleInputTyping(input); // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
}

// --- 3. Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø£Ù‡Ù…) ---
async function uploadCommentMedia(input) {
    const file = input.files[0];
    if (!file) return;

    input.value = ''; // ØªØµÙÙŠØ± Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØ±ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù ØªØ§Ù†ÙŠ

    let fileType = '';
    let folder = '';

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
    if (file.type.startsWith('image/')) {
        fileType = 'image';
        folder = 'images';
        if (file.size > 10 * 1024 * 1024) { showToast("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±"); return; }
    } else if (file.type.startsWith('video/')) {
        fileType = 'video';
        folder = 'videos';
        if (file.size > 50 * 1024 * 1024) { showToast("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨ÙŠØ±"); return; }
    } else {
        showToast("âš ï¸ Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ø¨Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª"); return;
    }

    showToast(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${fileType === 'image' ? 'Ø§Ù„ØµÙˆØ±Ø©' : 'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'}... â³`);

    const safeName = Date.now() + '_' + Math.floor(Math.random() * 10000);
    const extension = file.name.split('.').pop();
    const storagePath = `comments_media_v2/${currentOpenVideoId}/${folder}/${safeName}.${extension}`;
    const storageRef = storage.ref().child(storagePath);
    
    try {
        const snapshot = await storageRef.put(file);
        const url = await snapshot.ref.getDownloadURL();

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await db.collection('posts').doc(currentOpenVideoId).collection('comments').add({
            uid: currentUser.uid,
            name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            pic: currentUserData?.profilePic || "",
            isVerified: currentUserData?.isVerified || false,
            text: url, 
            isImage: (fileType === 'image'), // Ø¹Ù„Ø§Ù…Ø© Ù„Ù„ØµÙˆØ±Ø©
            isVideo: (fileType === 'video'), // Ø¹Ù„Ø§Ù…Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
            isAudio: false,
            isSticker: false,
            isGhost: isGhost,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
        await db.collection('posts').doc(currentOpenVideoId).update({
            commentsCount: firebase.firestore.FieldValue.increment(1)
        });
        
        showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");

    } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
    }
}

// --- 4. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¹Ø´Ø§Ù† ØªØ®ÙÙŠ Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØ± Ù„Ù…Ø§ ØªÙƒØªØ¨) ---
// (Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© handleInputTyping Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡)
function handleInputTyping(textarea) {
    const actionBtn = document.getElementById('dynamicActionBtn');
    const micIcon = document.getElementById('mainMicIcon');
    const sendIcon = document.getElementById('mainSendIcon');
    const extActions = document.querySelector('.external-actions');
    const footer = document.getElementById('commentFooter'); // Ø§Ù„Ø´Ø±ÙŠØ· ÙƒÙ„Ù‡
    const container = document.querySelector('.input-area-container'); // Ø§Ù„Ø­Ø§ÙˆÙŠØ©

    // Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';

    if (textarea.value.trim().length > 0) {
        // --- ÙˆØ¶Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Expand) ---
        micIcon.style.display = 'none';
        sendIcon.style.display = 'block';
        
        actionBtn.classList.remove('mic-mode');
        actionBtn.classList.add('send-mode');
        actionBtn.onclick = function() { handleCommentAction(); };
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        if(extActions) extActions.style.display = 'none'; 
        
    } else {
        // --- ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆÙ† (Reset / Nature) ---
        micIcon.style.display = 'block';
        sendIcon.style.display = 'none';
        
        actionBtn.classList.add('mic-mode');
        actionBtn.classList.remove('send-mode');
        actionBtn.onclick = function() { toggleRecording(); };
        
        // ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if(extActions) extActions.style.display = 'flex';
        
        // ğŸ”¥ ØªØµØºÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù„Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
        textarea.style.height = '45px';

        // Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ØªÙˆØ³ÙŠØ¹
        if(footer) footer.classList.remove('expanded');
        if(container) container.classList.remove('focused');
    }
}


// --- Ø¯ÙˆØ§Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ---

// 1. ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function toggleCommentVideo(id) {
    const vid = document.getElementById(`vid_${id}`);
    const container = document.getElementById(`vid_cont_${id}`);
    const playIcon = document.getElementById(`play_icon_${id}`);

    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø± Ø´ØºØ§Ù„
    document.querySelectorAll('video').forEach(v => { if(v !== vid) v.pause(); });

    if (vid.paused) {
        vid.play();
        container.classList.add('playing');
        playIcon.style.opacity = '0';
    } else {
        vid.pause();
        container.classList.remove('playing');
        playIcon.style.opacity = '1';
    }
}

// 2. ÙƒØªÙ… Ø§Ù„ØµÙˆØª
function toggleCommentMute(id, e) {
    e.stopPropagation();
    const vid = document.getElementById(`vid_${id}`);
    const icon = document.getElementById(`mute_icon_${id}`);
    vid.muted = !vid.muted;
    icon.className = vid.muted ? "fa-solid fa-volume-xmark" : "fa-solid fa-volume-high";
}

// 3. ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©
/* --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Cinema Mode) --- */

// 1. ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
function toggleCommentFullscreen(id, e) {
    if(e) e.stopPropagation();
    
    const smallVideo = document.getElementById(`vid_${id}`);
    const overlay = document.getElementById('cinemaOverlay');
    const bigVideo = document.getElementById('fsVideoPlayer');
    const bigPlayIcon = document.getElementById('fsPlayIcon');
    const bigSpeedBtn = document.getElementById('fsSpeedBtn');
    
    // Ù†Ù‚Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØµØºÙŠØ± Ù„Ù„ÙƒØ¨ÙŠØ±
    bigVideo.src = smallVideo.src;
    bigVideo.currentTime = smallVideo.currentTime;
    bigVideo.muted = smallVideo.muted;
    bigVideo.playbackRate = smallVideo.playbackRate;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    if(bigSpeedBtn) bigSpeedBtn.innerText = smallVideo.playbackRate + 'x';
    updateFsMuteIcon(bigVideo.muted);

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµØºÙŠØ± ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±
    smallVideo.pause();
    overlay.classList.add('active');
    
    const playPromise = bigVideo.play();
    if (playPromise !== undefined) {
        playPromise.then(() => { bigPlayIcon.style.opacity = '0'; })
                   .catch(() => { bigPlayIcon.style.opacity = '1'; });
    }

    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª (Seeker)
    bigVideo.ontimeupdate = () => {
        const percent = (bigVideo.currentTime / bigVideo.duration) * 100;
        document.getElementById('fsSeeker').value = percent || 0;
    };
}

// 2. Ø¥ØºÙ„Ø§Ù‚ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
function closeCinemaMode() {
    const overlay = document.getElementById('cinemaOverlay');
    const bigVideo = document.getElementById('fsVideoPlayer');
    overlay.classList.remove('active');
    bigVideo.pause();
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù…Ù…ÙƒÙ† ØªØ±Ø¬Ø¹ ØªØ´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØµØºÙŠØ± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù„Ùˆ Ø­Ø§Ø¨Ø¨)
}

// 3. ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ù…Ù† Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ¨ÙŠØ±
function toggleFsPlay() {
    const v = document.getElementById('fsVideoPlayer');
    const icon = document.getElementById('fsPlayIcon');
    if(v.paused) { v.play(); icon.style.opacity = '0'; }
    else { v.pause(); icon.style.opacity = '1'; }
}

// 4. ÙƒØªÙ… Ø§Ù„ØµÙˆØª
function toggleFsMute() {
    const v = document.getElementById('fsVideoPlayer');
    v.muted = !v.muted;
    updateFsMuteIcon(v.muted);
}

function updateFsMuteIcon(isMuted) {
    const icon = document.getElementById('fsMuteIcon');
    icon.className = isMuted ? "fa-solid fa-volume-xmark" : "fa-solid fa-volume-high";
}

// 5. ØªÙ‚Ø¯ÙŠÙ… ÙˆØªØ£Ø®ÙŠØ±
function seekFsVideo(input) {
    const v = document.getElementById('fsVideoPlayer');
    if(v.duration) v.currentTime = (input.value / 100) * v.duration;
}

// 6. ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ±
function changeFsSpeed(btnElement) {
    const video = document.getElementById('fsVideoPlayer');
    let r = video.playbackRate;
    let newRate = (r === 1.0) ? 1.5 : (r === 1.5) ? 2.0 : 1.0;
    video.playbackRate = newRate;
    btnElement.innerText = newRate + 'x';
}

// 4. ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© (Ø¨Ø³ÙŠØ·)
function viewImageWithSave(url) {
    window.open(url, '_blank');
}

/* --- Ø¯ÙˆØ§Ù„ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙˆØ­ÙØ¸Ù‡Ø§ --- */
function viewImageWithSave(url) {
    const lb = document.getElementById('imgLightbox');
    const img = document.getElementById('lbImage');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
    const oldBtn = document.getElementById('lbSaveBtn');
    if(oldBtn) oldBtn.remove();

    // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ø­ÙØ¸
    const saveBtn = document.createElement('div');
    saveBtn.id = 'lbSaveBtn';
    saveBtn.className = 'lb-save-btn';
    saveBtn.innerHTML = `<i class="fa-solid fa-download"></i> Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©`;
    saveBtn.onclick = (e) => { e.stopPropagation(); saveImageAction(url); };
    
    lb.appendChild(saveBtn);
    img.src = url;
    lb.style.display = 'flex';
    setTimeout(() => lb.classList.add('active'), 10);
}

function closeLightbox() {
    const lb = document.getElementById('imgLightbox');
    lb.classList.remove('active');
    setTimeout(() => { lb.style.display = 'none'; document.getElementById('lbImage').src = ''; }, 300);
}

function saveImageAction(url) {
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸... ğŸ–¼ï¸");
    const link = document.createElement('a');
    link.href = url;
    link.download = `Wareed_IMG_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/* --- Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø³Ø±Ø¹Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ --- */
function changeVideoSpeed(id, e) {
    e.stopPropagation();
    const video = document.getElementById(`vid_${id}`);
    const btn = document.getElementById(`speed_btn_${id}`);
    
    let current = video.playbackRate;
    let newRate = (current === 1.0) ? 1.5 : (current === 1.5) ? 2.0 : 1.0;
    
    video.playbackRate = newRate;
    btn.innerText = newRate + 'x';
}

function toggleReadMore(btn) {
    const textDiv = btn.previousElementSibling; // Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø²Ø±Ø§Ø±
    if (textDiv.classList.contains('collapsed')) {
        textDiv.classList.remove('collapsed'); // ØªÙˆØ³ÙŠØ¹
        textDiv.style.maskImage = 'none';
        textDiv.style.webkitMaskImage = 'none';
        btn.innerText = 'Ø¹Ø±Ø¶ Ø£Ù‚Ù„';
    } else {
        textDiv.classList.add('collapsed'); // Ø·ÙŠ
        textDiv.style.maskImage = ''; // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ„Ø§Ø´ÙŠ
        textDiv.style.webkitMaskImage = '';
        btn.innerText = 'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯... ğŸ‘‡';
    }
}

/* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Presence System) --- */

// 1. Ø¯Ø§Ù„Ø© Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ§ØªØ­
function checkAndColorAvatar(uid, avatarElement) {
    if (!uid || !avatarElement) return;

    // Ø¨Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    db.collection('users').doc(uid).get().then(doc => {
        if (doc.exists) {
            const data = doc.data();
            if (data.lastSeen) {
                const lastSeen = data.lastSeen.toDate();
                const now = new Date();
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                const diff = (now - lastSeen) / 1000 / 60;
                
                // Ù„Ùˆ ÙƒØ§Ù† ÙØ§ØªØ­ ÙÙŠ Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§ÙŠÙ‚ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                if (diff < 5) {
                    avatarElement.classList.add('online');
                }
            }
        }
    });
}

// 2. ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø¬Ø¯Ùƒ Ø£Ù†Øª (Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„Ù„Ù†Ø§Ø³)
function startPresenceSystem() {
    if (!currentUser) return;

    const updateStatus = () => {
        db.collection('users').doc(currentUser.uid).update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(e => console.log("Presence update ignored")); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµØ§Ù…ØªØ©
    };

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    updateStatus();

    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ø·ÙˆÙ„ Ù…Ø§ Ø£Ù†Øª ÙØ§ØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    setInterval(updateStatus, 2 * 60 * 1000);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø¬ÙˆÙ‡ auth observer Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯)
// Ø£Ùˆ Ø®Ù„ÙŠÙ‡ Ù‡Ù†Ø§ ÙˆÙ‡Ùˆ Ù‡ÙŠØ´ØªØºÙ„ Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„
auth.onAuthStateChanged(user => {
    if (user) startPresenceSystem();
});

/* ==========================================
   ğŸ‘† Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ (Swipe to Dismiss)
   ========================================== */
/* ==========================================
   ğŸ‘† Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø·ÙˆØ± (Smart Swipe)
   ========================================== */
/* ==========================================
   ğŸ‘† Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø·ÙˆØ± (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±)
   ========================================== */
function initSwipeToClose() {
    const sheets = document.querySelectorAll('.bottom-sheet');
    
    sheets.forEach(sheet => {
        const handle = sheet.querySelector('.sheet-handle');
        // Ù‡Ù†Ø§ Ø¨Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const header = sheet.querySelector('.cm-header') || sheet.querySelector('h3'); 
        
        const attachDrag = (element) => {
            if(!element) return;
            
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            
            element.addEventListener('touchstart', (e) => {
                // ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù‡Ù†Ø§ ğŸ”¥ğŸ”¥
                // Ù„Ùˆ Ø§Ù„Ø¶ØºØ·Ø© Ø¬Øª Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© (i) Ø£Ùˆ Ø²Ø±Ø§Ø±ØŒ Ù†Ø®Ø±Ø¬ Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ ÙÙˆØ±Ø§Ù‹
                if (e.target.tagName === 'I' || e.target.classList.contains('fa-xmark') || e.target.classList.contains('fa-arrow-right')) {
                    return; 
                }

                startY = e.touches[0].clientY;
                isDragging = true;
                sheet.style.transition = 'none';
            }, {passive: false}); // passive: false Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†ØªØ­ÙƒÙ…
            
            element.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const touchY = e.touches[0].clientY;
                const diff = touchY - startY;
                
                // Ø¨Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ù„Ù„Ø£Ø³ÙÙ„
                if (diff > 0) { 
                    if(e.cancelable) e.preventDefault(); // Ù…Ù†Ø¹ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    currentY = diff;
                    sheet.style.transform = `translateY(${currentY}px)`;
                }
            }, {passive: false});
            
            element.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                sheet.style.transition = 'transform 0.3s cubic-bezier(0.19, 1, 0.22, 1)';
                
                if (currentY > 100) { 
                    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
                    if (sheet.id === 'giftSheet') {
                        if(typeof GiftSystem !== 'undefined') GiftSystem.closeGiftOnly();
                        else sheet.classList.remove('active');
                    } 
                    else if (sheet.id === 'repliesSheet') {
                        closeRepliesSheet(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµØ­ÙŠØ­Ø©
                    } 
                    else {
                        closeAllSheets();
                    }

                    setTimeout(() => { sheet.style.transform = ''; }, 300);
                } else {
                    sheet.style.transform = ''; 
                }
                currentY = 0;
            });
        };

        attachDrag(handle);
        attachDrag(header);
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', initSwipeToClose);
// ÙˆØªØ´ØºÙŠÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ£ÙƒÙŠØ¯ (ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª)
initSwipeToClose();

function handleOverlayClick() {
    const repliesSheet = document.getElementById('repliesSheet');
    
    // ÙØ­Øµ: Ù‡Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†ØŸ
    if (repliesSheet.classList.contains('active')) {
        // Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¨Ø³ (ÙˆØ±Ø¬Ø¹Ù†ÙŠ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª)
        closeRepliesSheet();
    } else {
        // Ù„Ùˆ Ù…Ø´ Ù…ÙØªÙˆØ­Ø©ØŒ ÙŠØ¨Ù‚Ù‰ Ø£ÙƒÙŠØ¯ Ø§Ø­Ù†Ø§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ Ø§Ù‚ÙÙ„ ÙƒÙ„Ù‡
        closeAllSheets();
    }
}

/* ==========================================
   ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Repliles Pro Features)
   ========================================== */

// 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø´ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
function handleReplyTyping(textarea) {
    const actionBtn = document.getElementById('replyDynamicActionBtn');
    const micIcon = document.getElementById('replyMicIcon');
    const sendIcon = document.getElementById('replySendIcon');
    const extActions = document.getElementById('replyExternalActions');

    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';

    if (textarea.value.trim().length > 0) {
        // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        micIcon.style.display = 'none';
        sendIcon.style.display = 'block';
        actionBtn.classList.remove('mic-mode');
        actionBtn.classList.add('send-mode');
        // ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØµÙŠ
        actionBtn.onclick = function() { sendReplyToComment(); };
        
        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§
        if(extActions) {
            extActions.style.maxWidth = '0px';
            extActions.style.opacity = '0';
            extActions.style.margin = '0';
            extActions.style.padding = '0';
        }
    } else {
        // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§ÙŠÙƒ
        micIcon.style.display = 'block';
        sendIcon.style.display = 'none';
        actionBtn.classList.add('mic-mode');
        actionBtn.classList.remove('send-mode');
        // ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ù„Ù„ØªØ³Ø¬ÙŠÙ„
        actionBtn.onclick = function() { toggleReplyRecording(); };
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if(extActions) {
            extActions.style.maxWidth = '100px'; // Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
            extActions.style.opacity = '1';
            extActions.style.margin = '';
            extActions.style.padding = '';
        }
        textarea.style.height = '45px';
    }
}

function expandReplyInputArea() {
    // Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ Ù‡Ù†Ø§ Ù„Ùˆ Ø¹Ø§ÙŠØ²ÙŠÙ† ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    document.getElementById('replyFooter').classList.add('expanded');
}

// 2. Ø±ÙØ¹ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ (ØµÙˆØ± ÙˆÙÙŠØ¯ÙŠÙˆ)
async function uploadReplyMedia(input) {
    const file = input.files[0];
    if (!file || !currentParentComment) return;

    input.value = ''; // ØªØµÙÙŠØ±

    let fileType = '';
    let isImg = false;
    let isVid = false;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
    if (file.type.startsWith('image/')) {
        fileType = 'image';
        isImg = true;
    } else if (file.type.startsWith('video/')) {
        fileType = 'video';
        isVid = true;
        if (file.size > 50 * 1024 * 1024) { showToast("âš ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹"); return; }
    } else { 
        showToast("âš ï¸ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"); return; 
    }
    
    showToast(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${fileType === 'image' ? 'Ø§Ù„ØµÙˆØ±Ø©' : 'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'} ÙÙŠ Ø§Ù„Ø±Ø¯... â³`);

    const safeName = Date.now() + '_' + Math.floor(Math.random() * 10000);
    const extension = file.name.split('.').pop();
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentOpenVideoId Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ NABD Pro
    const storagePath = `replies_media/${currentOpenVideoId}/${currentParentComment.id}/${safeName}.${extension}`;
    
    try {
        const snapshot = await storage.ref().child(storagePath).put(file);
        const url = await snapshot.ref.getDownloadURL();

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await db.collection("posts").doc(currentOpenVideoId)
            .collection("comments").doc(currentParentComment.id)
            .collection("replies").add({
                uid: currentUser.uid,
                name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                pic: currentUserData?.profilePic || "",
                isVerified: currentUserData?.isVerified || false,
                text: url,
                isImage: isImg, // ğŸŸ¢ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
                isVideo: isVid, // ğŸŸ¢ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
                isAudio: false,
                isSticker: false,
                isGhost: isGhost,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ âœ…");

    } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
    }
}

// 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ (Voice Note)
let replyMediaRecorder = null;
let replyAudioChunks = [];
let replyRecordInterval;

async function toggleReplyRecording() {
    if (!currentParentComment) return;
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        replyMediaRecorder = new MediaRecorder(stream);
        replyAudioChunks = [];
        
        document.getElementById("replyNormalModeUI").style.display = "none";
        document.getElementById("replyRecordingModeUI").style.display = "flex";
        
        let seconds = 0;
        document.getElementById("replyRecordTimer").innerText = "00:00";
        
        replyRecordInterval = setInterval(() => {
            seconds++;
            const m = Math.floor(seconds/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            document.getElementById("replyRecordTimer").innerText = `${m}:${s}`;
        }, 1000);
        
        replyMediaRecorder.ondataavailable = e => replyAudioChunks.push(e.data);
        replyMediaRecorder.start();
        if(navigator.vibrate) navigator.vibrate(50);
        
    } catch(e) {
        showToast("âš ï¸ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­");
    }
}

function cancelReplyRecording() {
    if(replyMediaRecorder) replyMediaRecorder.stop();
    clearInterval(replyRecordInterval);
    document.getElementById("replyRecordingModeUI").style.display = "none";
    document.getElementById("replyNormalModeUI").style.display = "flex";
}

function stopAndSendReplyRecording() {
    if(!replyMediaRecorder) return;
    replyMediaRecorder.stop();
    
    replyMediaRecorder.onstop = async () => {
        clearInterval(replyRecordInterval);
        document.getElementById("replyRecordingModeUI").style.display = "none";
        document.getElementById("replyNormalModeUI").style.display = "flex";
        
        if(replyAudioChunks.length === 0) return;
        
        const blob = new Blob(replyAudioChunks, { type: 'audio/webm' });
        const voicePath = `replies_voice/${currentParentComment.id}/${Date.now()}.webm`;
        
        showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª... â³");
        
        try {
            const snapshot = await storage.ref().child(voicePath).put(blob);
            const url = await snapshot.ref.getDownloadURL();
            
            await db.collection("posts").doc(currentOpenVideoId)
                .collection("comments").doc(currentParentComment.id)
                .collection("replies").add({
                    uid: currentUser.uid,
                    name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                    pic: currentUserData?.profilePic || "",
                    text: url,
                    isAudio: true,
                    duration: document.getElementById("replyRecordTimer").innerText,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª âœ…");
            
        } catch(e) {
            showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
        }
    };
}


function handleSmartOverlayClick() {
    const giftSheet = document.getElementById('giftSheet');
    const repliesSheet = document.getElementById('repliesSheet');
    const commentsSheet = document.getElementById('cmSheet');

    // 1. Ù„Ùˆ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§ Ù‡ÙŠ Ø¨Ø³
    if (giftSheet.classList.contains('active')) {
        giftSheet.classList.remove('active');
        return; // ÙˆØ§Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ø´Ø§Ù† Ù…ÙŠÙ‚ÙÙ„Ø´ Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡Ø§
    }

    // 2. Ù„Ùˆ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§ ÙˆØ§Ø±Ø¬Ø¹ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    if (repliesSheet.classList.contains('active')) {
        repliesSheet.classList.remove('active');
        return;
    }

    // 3. Ù„Ùˆ Ù…ÙÙŠØ´ ØºÙŠØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ Ø§Ù‚ÙÙ„ ÙƒÙ„Ù‡
    closeAllSheets();
}

// --- Ù…Ù†Ø·Ù‚ Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Voice Note Logic) ---

let currentlyPlayingAudio = null; // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù…ÙŠÙ† Ø´ØºØ§Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠ ÙˆÙ†ÙˆÙ‚ÙÙ‡ Ù„Ùˆ Ø´ØºÙ„Ù†Ø§ ØºÙŠØ±Ù‡
let currentPlayButtonId = null;   // Ø¹Ø´Ø§Ù† Ù†Ø±Ø¬Ø¹ Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ø´ÙƒÙ„Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ

function toggleAudio(id, event) {
    if(event) event.stopPropagation(); // Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ù„Ø§ÙŠÙƒ Ø£Ùˆ ÙŠÙØªØ­ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¨Ø§Ù„ØºÙ„Ø·

    const audio = document.getElementById(`audio_${id}`);
    const btnIcon = document.getElementById(`btn_${id}`).querySelector('i');
    const playerContainer = document.getElementById(`player_${id}`);

    // 1. Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØª ØªØ§Ù†ÙŠ Ø´ØºØ§Ù„ØŒ ÙˆÙ‚ÙÙ‡ Ø§Ù„Ø£ÙˆÙ„
    if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        if(currentPlayButtonId) {
            // Ø±Ø¬Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù„ÙŠ ÙØ§Øª Ù„Ù€ "ØªØ´ØºÙŠÙ„"
            const oldBtn = document.getElementById(currentPlayButtonId);
            if(oldBtn) oldBtn.querySelector('i').className = "fa-solid fa-play";
            // Ø´ÙŠÙ„ Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
            const oldContainerId = currentPlayButtonId.replace('btn_', 'player_');
            const oldCont = document.getElementById(oldContainerId);
            if(oldCont) oldCont.classList.remove('playing');
        }
    }

    // 2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (audio.paused) {
        audio.play().then(() => {
            currentlyPlayingAudio = audio;
            currentPlayButtonId = `btn_${id}`;
            btnIcon.className = "fa-solid fa-pause"; // ØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù
            playerContainer.classList.add('playing'); // Ø¶ÙŠÙ ØªØ£Ø«ÙŠØ± Ù„Ù„ØªØµÙ…ÙŠÙ…
        }).catch(err => console.error("Audio Play Error:", err));
    } else {
        audio.pause();
        btnIcon.className = "fa-solid fa-play"; // Ø±Ø¬Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„ØªØ´ØºÙŠÙ„
        playerContainer.classList.remove('playing');
        currentlyPlayingAudio = null;
    }
}

function updateAudioProgress(id) {
    const audio = document.getElementById(`audio_${id}`);
    const slider = document.getElementById(`range_${id}`);
    const timer = document.getElementById(`dur_${id}`);
    
    // ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø³Ù„ÙŠÙ…Ø© (Ù…Ø´ NaN)
    if (isNaN(audio.duration)) return;

    // 1. ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„Ø´Ø±ÙŠØ·
    const percentage = (audio.currentTime / audio.duration) * 100;
    slider.value = percentage;
    
    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø´Ø±ÙŠØ· (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ Ø§ØªØ³Ù…Ø¹ Ø¨Ù„ÙˆÙ†ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ù„ÙˆÙ† ØªØ§Ù†ÙŠ)
    slider.style.background = `linear-gradient(to right, var(--primary) ${percentage}%, rgba(255,255,255,0.2) ${percentage}%)`;

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª (ØªÙ†Ø§Ø²Ù„ÙŠ Ø£Ùˆ ØªØµØ§Ø¹Ø¯ÙŠ - Ù‡Ù†Ø§ Ù‡Ù†Ø¹Ù…Ù„Ù‡: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)
    // Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù„ÙŠ Ù…Ø±: currentTime
    // Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: duration - currentTime
    const timeLeft = audio.duration - audio.currentTime;
    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const s = Math.floor(timeLeft % 60).toString().padStart(2, '0');
    timer.innerText = `${m}:${s}`;
}

function seekAudio(id, event) {
    if(event) event.stopPropagation();
    
    const audio = document.getElementById(`audio_${id}`);
    const slider = document.getElementById(`range_${id}`);
    
    if (audio.duration) {
        const seekTime = (slider.value / 100) * audio.duration;
        audio.currentTime = seekTime;
        updateAudioProgress(id); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø´ÙƒÙ„
    }
}

function resetAudio(id) {
    // Ù„Ù…Ø§ Ø§Ù„ØµÙˆØª ÙŠØ®Ù„Øµ
    const btnIcon = document.getElementById(`btn_${id}`).querySelector('i');
    const slider = document.getElementById(`range_${id}`);
    const playerContainer = document.getElementById(`player_${id}`);
    
    btnIcon.className = "fa-solid fa-play";
    slider.value = 0;
    slider.style.background = `rgba(255,255,255,0.2)`; // ØªØµÙÙŠØ± Ø§Ù„Ù„ÙˆÙ†
    playerContainer.classList.remove('playing');
    
    currentlyPlayingAudio = null;
}

function closeRepliesSheet() {
    // 1. Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯
    const sheet = document.getElementById('repliesSheet');
    if(sheet) sheet.classList.remove('active');
    
    // 2. ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£Ø¨
    currentParentComment = null;

    // 3. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØª Ø´ØºØ§Ù„ ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ØŒ Ù†ÙˆÙ‚ÙÙ‡
    if(typeof currentlyPlayingAudio !== 'undefined' && currentlyPlayingAudio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio = null;
    }

    // Ù…Ù„Ø­ÙˆØ¸Ø©: Ù…Ø´ Ù‡Ù†Ø´ÙŠÙ„ no-scroll Ù„Ø£Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø³Ù‡ Ù…ÙØªÙˆØ­Ø© ØªØ­ØªÙ‡Ø§
}

function toggleCommentLike(commentId) {
    // Ø¨Ù…Ø§ Ø¥Ù†Ù†Ø§ Ù„Ø³Ù‡ Ù…Ø¹Ù…Ù„Ù†Ø§Ø´ Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²ØŒ Ù‡Ù†Ø¹Ù…Ù„ ØªØ£Ø«ÙŠØ± Ø´ÙƒÙ„ÙŠ Ø¨Ø³ Ø­Ø§Ù„ÙŠØ§Ù‹
    const heartIcon = document.querySelector(`#comment-${commentId} .fa-heart`); // Ø§ÙØªØ±Ø§Ø¶ Ù…ÙƒØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    if(heartIcon) {
        if(heartIcon.style.color === 'rgb(255, 59, 48)') {
            heartIcon.style.color = '#fff'; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„Ø§ÙŠÙƒ
        } else {
            heartIcon.style.color = '#ff3b30'; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø§ÙŠÙƒ
            // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
        }
    }
    // Ù‡Ø²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(50);
}

async function shareVideo(id, text) {
    const shareData = {
        title: 'NABD Pro',
        text: text || 'Ø´Ø§Ù‡Ø¯ Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø±Ø§Ø¦Ø¹ Ø¹Ù„Ù‰ Ù†Ø¨Ø¶!',
        url: window.location.href // Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    };

    if (navigator.share) {
        try {
            await navigator.share(shareData);
        } catch (err) {
            console.log('Error sharing:', err);
        }
    } else {
        // Fallback: Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
        navigator.clipboard.writeText(shareData.url);
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø­Ø§ÙØ¸Ø© ğŸ“‹");
    }
}

function toggleFollow(uid, btn) {
    // Ù‡Ù†Ø§ Ù‡ØªØ¹Ù…Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø¨ØªØ§Ø¹Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    // Ø¯Ù‡ ÙƒÙˆØ¯ Ø´ÙƒÙ„ÙŠ Ø¨Ø³:
    if (btn.innerText === "Ù…ØªØ§Ø¨Ø¹Ø©") {
        btn.innerText = "Ù…ØªØ§Ø¨Ø¹";
        btn.style.background = "transparent";
        btn.style.border = "1px solid rgba(255,255,255,0.2)";
        btn.style.color = "#ccc";
    } else {
        btn.innerText = "Ù…ØªØ§Ø¨Ø¹Ø©";
        btn.style.background = "rgba(255, 255, 255, 0.15)";
        btn.style.border = "1px solid rgba(255, 255, 255, 0.4)";
        btn.style.color = "#fff";
    }
}

// Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚
function getBadge(isVerified, isGhost) {
    // Ù„Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ Ù…ÙØ¹Ù„ØŒ Ù…ÙÙŠØ´ ØªÙˆØ«ÙŠÙ‚ Ø¨ÙŠØ¸Ù‡Ø±
    if (isGhost) return '';
    
    // Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ«Ù‚ØŒ Ø±Ø¬Ø¹ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶
    // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ fa-heart-circle-check Ø¹Ø´Ø§Ù† ØªØ¯ÙŠ Ø´ÙƒÙ„ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…ÙˆØ«Ù‚
    return isVerified ? `<i class="fa-solid fa-heart-circle-check nabd-badge"></i>` : '';
}

// Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø§Ø³Ù…
// Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø§Ø³Ù…
function formatSmartName(name) {
    if (!name) return "Ù…Ø³ØªØ®Ø¯Ù…"; // Ø­Ù…Ø§ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù…
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù…
    const cleanName = name.trim();
    
    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù…
    const words = cleanName.split(/\s+/);

    // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ù†Ø±Ø¬Ø¹ Ø£ÙˆÙ„ Ø§Ø³Ù…ÙŠÙ† ÙÙ‚Ø· Ø¹Ø´Ø§Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…ÙŠØ¨ÙˆØ¸Ø´
    if (words.length > 2) {
        return words.slice(0, 2).join(' ');
    }
    
    return cleanName;
}


    </script>
    
    <div class="lightbox" id="imgLightbox" onclick="closeLightbox()">
    <span class="lb-close">&times;</span>
    <img class="lb-img" id="lbImage">
    </div>

    <div id="cinemaOverlay" class="fs-overlay">
    <video id="fsVideoPlayer" class="fs-video-element" loop playsinline></video>
    
    <div class="fs-center-btn" id="fsPlayIcon" onclick="toggleFsPlay()">
        <i class="fa-solid fa-play"></i>
    </div>

    <div class="fs-control-bar" onclick="event.stopPropagation()">
        <div class="vid-btn" onclick="toggleFsMute()">
            <i class="fa-solid fa-volume-high" id="fsMuteIcon"></i>
        </div>
        
        <div class="vid-btn vid-speed-btn" id="fsSpeedBtn" onclick="changeFsSpeed(this)" style="margin: 0 10px;">1x</div>
        
        <input type="range" class="audio-slider" id="fsSeeker" value="0" min="0" max="100" step="0.1" oninput="seekFsVideo(this)" style="flex:1; margin: 0 10px;">
        
        <div class="vid-btn" onclick="closeCinemaMode()">
            <i class="fa-solid fa-compress"></i>
        </div>
    </div>
</div>

   <div class="floating-options-sheet" id="commentOptionsSheetNew">
    <div id="cmOwnerOptionsNew" style="display:none; flex-direction:column;">
        <div class="compact-option" onclick="triggerEditComment()">
            <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„
        </div>
        <div class="compact-option" onclick="triggerCopyComment()">
            <i class="fa-regular fa-copy"></i> Ù†Ø³Ø®
        </div>
        <div class="compact-option danger-opt" onclick="triggerDeleteComment()">
            <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
        </div>
    </div>

    <div id="cmViewerOptionsNew" style="display:none; flex-direction:column;">
        <div class="compact-option" onclick="triggerReplyComment()">
            <i class="fa-solid fa-reply"></i> Ø±Ø¯
        </div>
        <div class="compact-option" onclick="triggerCopyComment()">
            <i class="fa-regular fa-copy"></i> Ù†Ø³Ø®
        </div>
        <div class="compact-option danger-opt" onclick="reportComment()">
            <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº
        </div>
    </div>

    <div class="cancel-btn-compact" onclick="closeFloatingMenu()">
        Ø¥Ù„ØºØ§Ø¡
    </div>
</div>

<div id="optionsBackdrop" class="popup-backdrop" onclick="closeFloatingMenu()"></div>
 
 <div class="sheet-overlay" id="overlay" onclick="handleSmartOverlayClick()"></div>
<div class="gift-backdrop-layer" id="giftBackdrop" onclick="GiftSystem.closeGiftOnly()"></div>

</body>
</html>

