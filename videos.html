<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD Pro - Watch & Gifts (Optimized)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>

    <style>
/* =========================================
   1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
   ========================================= */
:root {
    --primary: #F72585; 
    --secondary: #4CC9F0;
    --text-light: #ffffff;
    --overlay-dark: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.9) 100%);
    --bg-color: #0d0d0f;
    --card-color: #161616;
    --primary-solid: #5D5FEF;
    --text-color: #eee;
    --secondary-text: #aaa;
    --border-color: #2a2a2a;
    --danger-color: #ff3b30;
    --success-color: #34c759;
    --input-bg: #1f1f1f;
    --sheet-bg: #1e1e1e;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Cairo', sans-serif; }

body { background: #000; color: #fff; height: 100vh; width: 100vw; overflow: hidden; }

/* ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
body.no-scroll { overflow: hidden !important; }
body.no-scroll .app-container {
    overflow: hidden !important;
    pointer-events: none;
    touch-action: none;
}

/* =========================================
   2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Feed & Player)
   ========================================= */
.app-container {
    height: 100%; width: 100%; overflow-y: scroll;
    scroll-snap-type: y mandatory; scroll-behavior: smooth;
    -ms-overflow-style: none; scrollbar-width: none;
}
.app-container::-webkit-scrollbar { display: none; }

.video-slide {
    height: 100dvh; width: 100%; position: relative;
    scroll-snap-align: start; scroll-snap-stop: always;
    background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden;
}

video { width: 100%; height: 100%; object-fit: cover; display: block; }
.interaction-layer { position: absolute; inset: 0; z-index: 2; }

/* Ø§Ù„Ù„ÙˆØ¯Ø± Ø§Ù„Ø´Ø¨Ø­ (Brand Loader) */
.brand-loader {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: #000; z-index: 20; transition: opacity 0.4s ease-out;
}
.brand-pulse-icon {
    margin: 0; padding: 0; font-size: 100px; color: transparent; 
    -webkit-text-stroke: 1px rgba(255, 255, 255, 0.4);
    filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.1));
    animation: ghostPulse 2s infinite ease-in-out;
}

/* Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ø´ÙØ§Ù */
/* Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ø´ÙØ§Ù - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠØ±ØªÙØ¹ Ù„Ù„Ø£Ø¹Ù„Ù‰ */
.mute-indicator {
    position: absolute; 
    bottom: 40%; /* ğŸ”¥ ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ù…Ù† 25% Ø¥Ù„Ù‰ 40% Ù„Ø±ÙØ¹Ù‡ ÙÙˆÙ‚ Ø§Ù„Ù…Ù†ØªØµÙ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    left: 50%; 
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.25); 
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 10px 20px; 
    border-radius: 50px;
    color: rgba(255, 255, 255, 0.9); 
    font-size: 18px;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px;
    opacity: 0; 
    transition: all 0.3s ease; 
    z-index: 15; 
    pointer-events: none;
}

.video-slide.muted-state .mute-indicator { opacity: 1; animation: floatIndicator 3s ease-in-out infinite; }

/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ± */
.big-heart {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
    font-size: 120px; color: rgba(255, 40, 80, 0.9); z-index: 15; pointer-events: none;
    filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));
}
.big-heart.animate { animation: heartPop 0.8s cubic-bezier(0.17, 0.89, 0.32, 1.49) forwards; }

/* Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
.center-play-button {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 80px; height: 80px; background: rgba(0, 0, 0, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 35px; z-index: 5; opacity: 0; visibility: hidden;
    transition: all 0.2s ease-in-out; pointer-events: none;
}
.video-slide.is-paused .center-play-button { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
.video-slide:active .center-play-button { transform: translate(-50%, -50%) scale(0.95); }

/* =========================================
   3. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØ§Ù„Ø¨Ø­Ø« (Top Nav & Search)
   ========================================= */
.top-nav-bar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 20px; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
}
.nav-tabs { display: flex; gap: 20px; font-size: 16px; font-weight: 700; color: rgba(255, 255, 255, 0.6); }
.nav-tab { cursor: pointer; position: relative; transition: 0.3s; }
.nav-tab.active { color: #fff; font-size: 17px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
.nav-tab.active::after {
    content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
    width: 20px; height: 3px; background: #fff; border-radius: 2px;
}
.nav-icon-btn {
    font-size: 22px; color: #fff; cursor: pointer; width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s;
}
.nav-icon-btn:active { background: rgba(255,255,255,0.1); transform: scale(0.9); }

/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø­Ø« */
.search-overlay {
    position: fixed; inset: 0; background: #000; z-index: 5000;
    display: none; flex-direction: column; animation: fadeIn 0.3s ease;
}
.search-overlay.active { display: flex; }
.search-header { padding: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #222; }
.search-input-box {
    flex: 1; background: #1f1f1f; border-radius: 10px; padding: 8px 12px;
    display: flex; align-items: center; gap: 10px;
}
.search-input-box input { background: transparent; border: none; color: #fff; width: 100%; outline: none; font-size: 14px; }
.search-tabs { display: flex; border-bottom: 1px solid #222; }
.s-tab { flex: 1; text-align: center; padding: 15px; color: #777; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; }
.s-tab.active { color: #fff; border-bottom-color: var(--primary); }
.search-results { flex: 1; overflow-y: auto; padding: 10px; }
.user-result-card { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #222; }
.user-result-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }

/* =========================================
   4. Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Side Bar & Info)
   ========================================= */
/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù„Ø£Ø²Ø±Ø§Ø±) */
.side-bar {
    position: absolute; 
    left: 10px; 
    bottom: 100px; /* ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙƒØ§Ù†Øª 220px ÙˆØ®Ù„ÙŠÙ†Ø§Ù‡Ø§ 100px Ø¹Ø´Ø§Ù† ØªÙ†Ø²Ù„ ØªØ­Øª Ø®Ø§Ù„Øµ */
    z-index: 20; 
    display: flex; 
    flex-direction: column;
    gap: 20px; 
    align-items: center;
}

.action-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.2s; }
.action-btn:active { transform: scale(0.9); }
.icon-circle {
    width: 40px; height: 40px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
    border-radius: 50%; display: grid; place-items: center; font-size: 20px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.action-text { font-size: 12px; font-weight: 600; text-shadow: 0 1px 2px #000; }

/* Ù…Ù†Ø·Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ÙŠÙˆØ²Ø± */
.video-info {
    position: absolute; bottom: 0; left: 0; right: 0;
    padding: 20px 20px 80px 20px; /* Ù…Ø³Ø§Ø­Ø© Ù…Ù† ØªØ­Øª Ø¹Ø´Ø§Ù† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0.95) 100%);
    z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end;
}
.info-inner { pointer-events: auto; width: 100%; max-width: 80%; }

.user-header-row {
    display: flex; align-items: center; gap: 10px; margin-bottom: 6px;
    width: 100%; overflow: hidden;
}
.header-avatar {
    width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.9);
    object-fit: cover; flex-shrink: 0;
}
.header-name-block {
    display: flex; align-items: center; gap: 5px; flex: 1; min-width: 0; justify-content: flex-start;
}
.header-username {
    display: block; font-weight: 700; font-size: 15px; color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; max-width: 100%;
}
.verified-badge { color: #20D5EC; font-size: 14px; flex-shrink: 0; margin-top: 2px; }
.follow-btn-inline {
    background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff; font-size: 11px; font-weight: bold; padding: 6px 12px;
    border-radius: 6px; cursor: pointer; white-space: nowrap; flex-shrink: 0; margin-left: 0;
}
.video-desc { font-size: 13px; color: #eee; line-height: 1.4; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-right: 5px; }

/* Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ù†Ø¨Ø¶) */
.nabd-badge {
    display: inline-block; vertical-align: middle; margin-right: 4px; font-size: 13px;
    background: linear-gradient(120deg, #1da1f2 30%, #ffffff 50%, #1da1f2 70%);
    background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 5px rgba(29, 161, 242, 0.6));
    animation: shineMove 3s linear infinite, heartbeat 1.5s infinite ease-in-out;
}

/* =========================================
   5. Ø´Ø±ÙŠØ· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø§Ø¦Ù… (Floating Seeker)
   ========================================= */
.floating-seeker-container {
    position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: 80%; height: 20px; z-index: 60;
    display: flex; align-items: center; justify-content: center;
    direction: ltr !important; /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
}
.seeker-track {
    width: 100%; height: 5px; background: rgba(255, 255, 255, 0.3);
    border-radius: 10px; position: relative; overflow: visible; backdrop-filter: blur(2px);
}
.seeker-fill {
    height: 100%; background: #F72585; width: 0%; border-radius: 10px;
    position: relative; box-shadow: 0 0 10px rgba(247, 37, 133, 0.8);
}
.seeker-thumb {
    position: absolute; right: -6px; top: 50%; transform: translateY(-50%) scale(0);
    width: 14px; height: 14px; background: #fff; border-radius: 50%;
    box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: transform 0.2s;
}
.floating-seeker-container:active .seeker-thumb, .video-slide.is-paused .seeker-thumb { transform: translateY(-50%) scale(1.2); }
.seeker-time-bubble {
    position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); color: #fff; padding: 4px 8px; border-radius: 6px;
    font-size: 11px; font-weight: 800; font-family: monospace; opacity: 0;
    transition: opacity 0.2s; pointer-events: none; white-space: nowrap;
}
.floating-seeker-container:active .seeker-time-bubble, .video-slide.is-paused .seeker-time-bubble { opacity: 1; }

/* =========================================
   6. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Bottom Sheets)
   ========================================= */
.sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; backdrop-filter: blur(4px); }

.bottom-sheet { 
    position: fixed; bottom: 0; left: 0; right: 0; background: var(--sheet-bg); 
    z-index: 201; border-radius: 24px 24px 0 0; transform: translateY(100%); 
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
    border-top: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 85vh;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5); color: #fff;
}
.bottom-sheet.active { transform: translateY(0); }
.sheet-handle { width: 40px; height: 5px; background: var(--border-color); border-radius: 10px; margin: 12px auto; }

.cm-header { 
    padding: 15px 20px; border-bottom: 1px solid var(--border-color); 
    display: flex; justify-content: space-between; align-items: center; 
    font-weight: 800; font-size: 16px; background: var(--sheet-bg); 
    z-index: 10; border-radius: 24px 24px 0 0; 
}
.cm-body { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; background: var(--sheet-bg); }

/* =========================================
   7. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯
   ========================================= */
.comment-item { display: flex; gap: 10px; margin-bottom: 18px; position: relative; }

.cm-avatar { 
    width: 38px; height: 38px; border-radius: 50%; background: #333; 
    flex-shrink: 0; background-size: cover; border: 1px solid var(--border-color); 
    display: grid; place-items: center; position: relative; overflow: visible !important;
}
.cm-avatar.online::after {
    content: ''; position: absolute; bottom: -2px; right: -2px;
    width: 12px; height: 12px; background-color: #4cd964;
    border: 2px solid #1a1a1a; border-radius: 50%; z-index: 10;
    box-shadow: 0 0 5px rgba(76, 217, 100, 0.5);
}

.cm-content { flex: 1; max-width: 85%; }

/* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ */
.cm-bubble {
    background: #262626; border: 1px solid #333; padding: 10px 14px;
    border-radius: 18px; border-top-right-radius: 2px; color: #eee;
    min-width: 120px; position: relative;
}
.cm-bubble.owner-bubble { 
    background: rgba(247, 37, 133, 0.25); border: 1px solid var(--primary); 
    box-shadow: 0 0 10px rgba(247, 37, 133, 0.1); 
}
.cm-username { font-weight: 800; font-size: 13px; color: #ffffff !important; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
.owner-badge { font-size: 10px; background: var(--primary); color: #fff; padding: 1px 6px; border-radius: 8px; }

.cm-text { font-size: 15px; line-height: 1.6; color: #e0e0e0; white-space: pre-wrap; word-break: break-word; }
.cm-text.collapsed { max-height: 60px; overflow: hidden; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
.read-more-btn { color: var(--primary); font-size: 11px; font-weight: bold; cursor: pointer; margin-top: 2px; display: inline-block; }
.cm-meta-row { display: flex; gap: 15px; margin-top: 5px; margin-right: 12px; font-size: 11px; color: var(--secondary-text); font-weight: 600; }
.cm-action { cursor: pointer; transition: 0.2s; }

/* Ø§Ù„Ø±Ø¯ÙˆØ¯ (Tree Style) */
.cm-bubble.colored-reply, .cm-bubble.colored-comment {
    position: relative; transition: 0.2s; background: #1a1a1a;
    border: 1px solid var(--user-color); border-right-width: 4px;
    box-shadow: inset 0 0 10px -5px var(--user-color), 0 5px 15px -8px var(--user-color);
}
.cm-bubble.colored-reply .cm-username { color: var(--user-color) !important; filter: brightness(1.3); }
.tree-connector { position: absolute; right: -24px; top: -20px; bottom: 0; width: 2px; background: #333; z-index: 0; }
.reply-curve { position: absolute; right: -24px; top: 20px; width: 15px; height: 2px; background: #333; }
.reply-mention-link { color: #2979ff; font-weight: 800; cursor: pointer; text-decoration: none; margin-left: 4px; }

/* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */
.color-0 { --user-color: #5D5FEF; } .color-1 { --user-color: #34c759; }
.color-2 { --user-color: #ff3b30; } .color-3 { --user-color: #ffb533; }
.color-4 { --user-color: #bf5af2; } .color-5 { --user-color: #64d2ff; }
.color-6 { --user-color: #ff9f0a; } .color-7 { --user-color: #ff375f; }
.color-8 { --user-color: #ac8e68; } .color-9 { --user-color: #808080; }

/* Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (ØµÙˆØ± - ÙÙŠØ¯ÙŠÙˆ - ØµÙˆØª) */
.cm-media-wrapper {
    position: relative; width: 100%; max-width: 260px; margin-top: 8px; margin-bottom: 12px;
    border-radius: 12px; overflow: hidden; background-color: #000;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.cm-media-img { width: 100%; height: auto; max-height: 350px; object-fit: cover; display: block; cursor: pointer; }

/* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØµØºØ± */
.custom-video-container {
    position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000;
}
.custom-video-element { width: 100%; max-height: 350px; object-fit: contain; }
.vid-center-play {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 45px; height: 45px; background: rgba(0,0,0,0.6); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: #fff; pointer-events: none;
    border: 1px solid rgba(255,255,255,0.2);
}
.vid-controls {
    position: absolute; bottom: 10px; right: 10px; left: 10px;
    display: flex; justify-content: space-between; opacity: 0; transition: 0.3s;
}
.custom-video-container.playing .vid-controls, .custom-video-container:hover .vid-controls { opacity: 1; }
.vid-btn {
    width: 32px; height: 32px; background: rgba(0,0,0,0.6); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; backdrop-filter: blur(4px);
}
.vid-speed-btn { width: 35px !important; border-radius: 12px !important; font-size: 11px !important; font-weight: 900 !important; }

/* Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Voice Note) */
.custom-audio-player {
    display: flex; align-items: center; gap: 10px; background: #2a2a2a;
    padding: 8px 12px; border-radius: 25px; width: 100%; max-width: 260px;
    margin-top: 8px; margin-bottom: 12px; border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.3s;
}
.custom-audio-player.playing { border-color: var(--primary); background: #333; }
.play-btn {
    width: 35px; height: 35px; border-radius: 50%; background: var(--primary);
    border: none; color: #fff; display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 10px rgba(247, 37, 133, 0.3);
}
.audio-slider {
    flex: 1; -webkit-appearance: none; height: 4px; background: rgba(255, 255, 255, 0.2);
    border-radius: 2px; outline: none; cursor: pointer;
}
.audio-slider::-webkit-slider-thumb {
    -webkit-appearance: none; width: 12px; height: 12px; background: #fff;
    border-radius: 50%; cursor: pointer; margin-top: -4px;
}
.audio-time { font-size: 11px; color: #aaa; font-weight: 600; min-width: 35px; text-align: right; font-family: monospace; }

/* =========================================
   8. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„ÙÙˆØªØ± (Input Area)
   ========================================= */
.cm-footer {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: #0d0d0f; border-top: 1px solid #222;
    display: flex; flex-direction: column; z-index: 202; transition: all 0.3s ease;
}
.suggested-emojis {
    display: none; gap: 15px; padding: 10px 15px;
    background: #0d0d0f; border-bottom: 1px solid #1a1a1a;
    overflow-x: auto; scrollbar-width: none;
}
.cm-footer.expanded .suggested-emojis { display: flex; animation: slideUp 0.3s; }
.suggested-emojis span { font-size: 24px; cursor: pointer; transition: 0.2s; }
.input-area-container {
    display: flex; align-items: flex-end; padding: 10px 15px; gap: 10px;
    background: #0d0d0f; position: relative;
}
.external-actions {
    display: flex; gap: 5px; align-items: center; margin-bottom: 2px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 100px; opacity: 1; overflow: hidden;
}
.input-area-container.focused .external-actions { max-width: 0px; opacity: 0; margin: 0; padding: 0; }
.ext-btn {
    width: 38px; height: 38px; border-radius: 50%;
    background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer; flex-shrink: 0; color: #fff; transition: 0.2s;
}
.smart-input-wrapper {
    flex: 1; background: #1f1f1f; border-radius: 20px;
    border: 1px solid #333; min-height: 45px;
    display: flex; align-items: center; transition: 0.3s;
}
.smart-textarea {
    width: 100%; background: transparent; border: none; outline: none; color: #fff;
    font-size: 15px; resize: none; max-height: 100px; padding: 12px 5px 12px 15px; 
    line-height: 1.5; height: 45px;
}
.action-submit-btn {
    width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.1); color: #fff; flex-shrink: 0; transition: 0.2s; cursor: pointer;
}
.action-submit-btn.send-mode { background: var(--primary); transform: scale(1.1); }
.recording-overlay {
    display: flex; align-items: center; justify-content: space-between;
    background: #1f1f1f; padding: 0 10px; border-radius: 20px; border: 1px solid rgba(255, 59, 48, 0.3);
    position: absolute; top: 10px; left: 15px; right: 15px; height: 50px; z-index: 100;
}
.rec-info { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; color: #fff; font-weight: bold; }
.rec-dot { width: 10px; height: 10px; background-color: #ff3b30; border-radius: 50%; animation: blink-rec 1s infinite; }
.mention-dropdown { 
    position: absolute; bottom: 60px; left: 15px; right: 15px; 
    background: var(--sheet-bg); border: 1px solid var(--border-color); border-radius: 12px; 
    max-height: 200px; overflow-y: auto; display: none; z-index: 205; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
}
.mention-dropdown.active { display: block; }
.mention-suggest-item { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid #333; }

/* =========================================
   9. Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Pro Gift Style)
   ========================================= */
.gift-tabs-container {
    display: flex; justify-content: space-between; background: rgba(255, 255, 255, 0.05);
    padding: 5px; border-radius: 15px; margin: 10px 15px; border: 1px solid rgba(255, 255, 255, 0.1);
}
.gift-tab {
    flex: 1; text-align: center; padding: 10px; border-radius: 12px; color: #888;
    cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.3s;
}
.gift-tab.active { background: var(--primary); color: #fff; box-shadow: 0 0 15px rgba(247, 37, 133, 0.3); }
.premium-gift-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 10px; }
.premium-gift-card {
    background: linear-gradient(145deg, rgba(30,30,35,0.8), rgba(20,20,25,0.9));
    border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 15px 5px;
    display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s;
}
.premium-gift-card:active { transform: scale(0.95); border-color: var(--primary); }
.pg-emoji { font-size: 35px; margin-bottom: 5px; }
.pg-name { font-size: 11px; color: #fff; font-weight: bold; }
.pg-price { font-size: 10px; color: #FFD700; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 10px; margin-top: 3px; }

/* Ø´ÙƒÙ„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
.gift-wrapper-pro { display: flex; align-items: flex-end; gap: 12px; width: 100%; margin-bottom: 15px; position: relative; }
.gift-body { display: flex; flex-direction: column; align-items: center; position: relative; padding-bottom: 10px; }
.gift-hero-icon {
    font-size: 85px; line-height: 1; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
    animation: giftFloat 3s ease-in-out infinite; z-index: 2;
}
.gift-gold-badge {
    background: linear-gradient(90deg, #FFD700 0%, #FDB931 50%, #FFD700 100%);
    background-size: 200% auto; color: #000; padding: 4px 18px;
    border-radius: 20px; font-size: 11px; font-weight: 900; margin-top: -10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 2px solid #fff; z-index: 3;
    animation: badgeShine 3s linear infinite; white-space: nowrap;
}
.gift-meta { font-size: 10px; color: #777; margin-top: 5px; font-weight: bold; }
.reply-gift-container { transform: scale(0.85); transform-origin: right top; margin-right: -10px; margin-bottom: -10px; }
.header-gift-preview {
    display: flex; align-items: center; gap: 10px;
    background: linear-gradient(90deg, #1a1a1a, #2a2a2a);
    padding: 5px 10px; border-radius: 12px; border: 1px solid #FFD700;
}
.gift-backdrop-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 299; display: none; background: rgba(0,0,0,0);
}
.gift-backdrop-layer.active { display: block; }
.stickers-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px; max-height: 350px; overflow-y: auto; }
.sticker-option { font-size: 40px; text-align: center; cursor: pointer; transition: transform 0.1s; }
.sticker-option:active { transform: scale(0.8); }

/* =========================================
   10. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Modals & Menus)
   ========================================= */
.floating-options-sheet {
    position: fixed; bottom: 20px; left: 15px; right: 15px;
    background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    z-index: 10005; transform: translateY(150%); opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    padding: 8px; display: flex; flex-direction: column; gap: 5px;
}
.floating-options-sheet.active { transform: translateY(0); opacity: 1; }
.compact-option {
    display: flex; align-items: center; gap: 12px; padding: 12px 15px;
    border-radius: 16px; color: #fff; font-weight: 700; cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.compact-option:last-child { border-bottom: none; }
.compact-option:active { background: rgba(255, 255, 255, 0.1); transform: scale(0.98); }
.compact-option i { width: 25px; text-align: center; color: var(--primary); }
.compact-option.danger-opt { color: #ff3b30; }
.compact-option.danger-opt i { color: #ff3b30; }
.cancel-btn-compact {
    text-align: center; padding: 12px; background: rgba(255, 255, 255, 0.05);
    border-radius: 16px; font-weight: 800; color: #aaa; margin-top: 5px;
}
.popup-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); z-index: 10004; display: none;
}

/* Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Video Menu) */
.interest-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.interest-btn {
    background: #222; padding: 12px; border-radius: 12px;
    display: flex; flex-direction: column; align-items: center;
    text-align: center; gap: 8px; cursor: pointer; transition: 0.2s;
}
.interest-btn:active { transform: scale(0.96); background: #333; }
.interest-btn i { font-size: 20px; margin-bottom: 5px; }
.interest-btn .main-text { font-weight: bold; font-size: 14px; color: #fff; }
.interest-btn .sub-text { font-size: 10px; color: #aaa; }
.menu-divider { height: 1px; background: #333; margin: 10px 0; width: 100%; }
.menu-list { display: flex; flex-direction: column; gap: 5px; }
.menu-item {
    display: flex; align-items: center; gap: 15px; padding: 12px 10px;
    border-radius: 10px; cursor: pointer; transition: 0.2s; color: #eee;
}
.menu-item:active { background: rgba(255,255,255,0.1); }
.menu-item i { width: 25px; text-align: center; font-size: 18px; color: #fff; }
.menu-item .menu-text { flex: 1; font-size: 15px; font-weight: 600; }
.menu-item .menu-value { font-size: 12px; color: #aaa; background: #333; padding: 2px 8px; border-radius: 4px; }
.menu-item.danger { color: #ff3b30; }
.menu-item.danger i { color: #ff3b30; }
.menu-toggle i { font-size: 22px; color: #555; }
.menu-toggle i.active, .menu-toggle i.fa-toggle-on { color: var(--primary); }

/* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
.custom-modal { position: fixed; inset: 0; z-index: 3000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
.modal-box { background: var(--card-color); width: 85%; max-width: 380px; border-radius: 24px; padding: 30px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
#toast { 
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); 
    background: #222; color: #fff; padding: 12px 24px; border-radius: 50px; 
    opacity: 0; pointer-events: none; transition: 0.4s; z-index: 6000; 
    display: flex; align-items: center; gap: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* =========================================
   11. ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ ÙˆØ¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± (Media Viewers)
   ========================================= */
.lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95); z-index: 10000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(10px); opacity: 0; transition: opacity 0.3s ease;
}
.lightbox.active { display: flex; opacity: 1; }
.lb-img {
    max-width: 95%; max-height: 85%; border-radius: 12px;
    box-shadow: 0 0 30px rgba(0,0,0,0.5); transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.lightbox.active .lb-img { transform: scale(1); }
.lb-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 40px; cursor: pointer; z-index: 10002; }
.lb-save-btn {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--primary); color: #fff; padding: 10px 25px;
    border-radius: 30px; font-weight: bold; display: flex; align-items: center;
    gap: 8px; cursor: pointer; box-shadow: 0 0 20px rgba(247, 37, 133, 0.4); z-index: 10001;
}

.fs-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 20000; display: none; flex-direction: column; 
    justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease;
}
.fs-overlay.active { display: flex; opacity: 1; }
.fs-video-element { width: 100%; height: 100%; object-fit: contain; }
.fs-center-btn {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 70px; height: 70px; background: rgba(0,0,0,0.5); border-radius: 50%;
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-size: 30px; border: 1px solid rgba(255,255,255,0.3); cursor: pointer;
}
.fs-control-bar {
    position: absolute; bottom: 40px; left: 20px; right: 20px;
    display: flex; align-items: center; background: rgba(20, 20, 20, 0.85);
    padding: 10px 15px; border-radius: 50px; backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

/* =========================================
   12. Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Keyframes)
   ========================================= */
@keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes blink-rec { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes ghostPulse { 0%, 100% { transform: scale(0.95); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.6; filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.3)); } }
@keyframes floatIndicator { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
@keyframes giftFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-8px) rotate(2deg); } }
@keyframes badgeShine { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
@keyframes shineMove { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
@keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.2); } 30% { transform: scale(1); } 45% { transform: scale(1.2); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Ø§Ù„Ù‚Ø±Øµ Ø§Ù„Ø¯ÙˆØ§Ø± */
.music-disc-container {
    position: absolute;
    bottom: 30px; /* Ù…ÙƒØ§Ù† Ø§Ù„Ù‚Ø±Øµ */
    left: 15px;   /* Ø¹ÙƒØ³ Ù…ÙƒØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    width: 50px;
    height: 50px;
    z-index: 15;
}

.music-disc-bg {
    width: 100%;
    height: 100%;
    background: #000; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ù…Ø«Ù„ Ø§Ù„Ø§Ø³Ø·ÙˆØ§Ù†Ø© */
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #222;
    animation: discSpin 5s linear infinite; /* Ø¯ÙˆØ±Ø§Ù† Ù…Ø³ØªÙ…Ø± */
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}

.music-disc-bg img {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    object-fit: cover;
}

/* Ø­Ø±ÙƒØ© Ø§Ù„Ù†ÙˆØªØ§Øª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© */
.music-notes i {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 15px;
    color: rgba(255, 255, 255, 0.8);
    opacity: 0;
    animation: noteFloat 3s linear infinite;
}
.music-notes i:nth-child(2) { animation-delay: 1.5s; font-size: 10px; left: 20px; }

/* Ø§Ù„Ø§Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes discSpin { 100% { transform: rotate(360deg); } }
@keyframes noteFloat {
    0% { transform: translateY(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { transform: translateY(-50px) rotate(20deg); opacity: 0; }
}

/* Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-slide.is-paused .music-disc-bg { animation-play-state: paused; }

.saved-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ø§Ù„ØµÙ */
    gap: 2px;
    padding: 2px;
    overflow-y: auto;
    height: 100%;
}

.saved-item {
    position: relative;
    aspect-ratio: 9/16; /* Ù†Ø³Ø¨Ø© Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø·ÙˆÙ„ÙŠ */
    background: #222;
    cursor: pointer;
}

.saved-item img, .saved-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.saved-overlay {
    position: absolute;
    bottom: 5px;
    left: 5px;
    color: #fff;
    font-size: 12px;
    font-weight: bold;
    text-shadow: 0 1px 3px #000;
}

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
.full-screen-page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #121212; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ† Ø§Ø­ØªØ±Ø§ÙÙŠ */
    z-index: 2000; /* ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    flex-direction: column;
    overflow-y: auto;
}

.full-screen-page.active {
    display: flex;
    animation: slideInRight 0.3s ease; /* Ø­Ø±ÙƒØ© Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¹Ù…Ø© */
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.fs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #121212;
    border-bottom: 1px solid #333;
    position: sticky;
    top: 0;
    z-index: 10;
}

.fs-title {
    font-weight: 800;
    font-size: 16px;
}

.fs-back-btn {
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}

/* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„ØªØ§Ø¨Ø§Øª) */
.fs-tabs {
    display: flex;
    background: #121212;
    border-bottom: 1px solid #222;
}

.fs-tab {
    flex: 1;
    text-align: center;
    padding: 15px;
    font-size: 14px;
    font-weight: 600;
    color: #777;
    cursor: pointer;
    position: relative;
    transition: 0.3s;
}

.fs-tab.active {
    color: #fff;
}

/* Ø§Ù„Ø®Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ ØªØ­Øª Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù†Ø´Ø· */
.fs-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20%;
    right: 20%;
    height: 2px;
    background: #fff; /* Ø£Ùˆ Ù„ÙˆÙ†Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ var(--primary) */
}

/* Ø´Ø¨ÙƒØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Ù…Ø«Ù„ ØªÙŠÙƒ ØªÙˆÙƒ) */
.fs-content-area {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 Ø£Ø¹Ù…Ø¯Ø© */
    gap: 1px; /* Ù…Ø³Ø§ÙØ© 1 Ø¨ÙƒØ³Ù„ ÙÙ‚Ø· */
    padding-bottom: 50px;
}

.grid-item {
    position: relative;
    aspect-ratio: 3/4; /* Ù†Ø³Ø¨Ø© Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ø³ØªØ·ÙŠÙ„Ø© */
    background: #222;
    cursor: pointer;
    overflow: hidden;
}

.grid-item img, .grid-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.grid-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 5px;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: #fff;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: bold;
}

/* Ø­Ø±ÙƒØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.loading-state {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    padding: 50px;
    font-size: 20px;
    color: #fff;
}

/* --- ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ÙˆØ§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬ --- */
.music-row {
    display: flex;
    align-items: center;
    justify-content: space-between; /* ÙŠÙØµÙ„ Ø§Ù„Ù†Øµ Ø¹Ù† Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© */
    margin-top: 8px;
    width: 100%;
}

.music-marquee-container {
    flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #fff;
    font-size: 13px;
    opacity: 0.9;
}

/* Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© Ø§Ù„Ø¯ÙˆØ§Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
.vinyl-wrapper {
    width: 45px;
    height: 45px;
    position: relative;
    flex-shrink: 0; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
    margin-right: 10px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ†Ù‡ ÙˆØ¨ÙŠÙ† Ø§Ù„Ù†Øµ */
    display: flex;
    align-items: center;
    justify-content: center;
}

.vinyl-disc {
    width: 100%;
    height: 100%;
    background: #111; /* Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© Ø§Ù„Ø£Ø³ÙˆØ¯ */
    border-radius: 50%;
    border: 2px solid #222;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: spinDisc 5s linear infinite;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
}

/* ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© */
.vinyl-img {
    width: 28px; /* Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ØµØºØ± Ù…Ù† Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© */
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
}

/* Ø§Ù„Ù†ÙˆØªØ§Øª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© */
.floating-notes {
    position: absolute;
    bottom: 0;
    left: -10px; /* ØªØ®Ø±Ø¬ Ù…Ù† ÙŠØ³Ø§Ø± Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø© */
    width: 20px;
    height: 100%;
    pointer-events: none;
}

.floating-notes i {
    position: absolute;
    bottom: 0;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
    opacity: 0;
    animation: floatNote 3s linear infinite;
}

.floating-notes i:nth-child(1) { animation-delay: 0s; left: 5px; }
.floating-notes i:nth-child(2) { animation-delay: 1.5s; left: 15px; font-size: 10px; }

/* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
@keyframes spinDisc { 100% { transform: rotate(360deg); } }
@keyframes floatNote {
    0% { transform: translateY(0) rotate(0deg); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translateY(-40px) rotate(-20deg); opacity: 0; }
}

/* ÙˆÙ‚Ù Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
.video-slide.is-paused .vinyl-disc { animation-play-state: paused; }

/* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
.menu-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 20px;
}

.menu-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    cursor: pointer;
    transition: 0.2s;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.menu-item:active {
    transform: scale(0.98);
    background: rgba(255, 255, 255, 0.1);
}

.menu-item i {
    font-size: 20px;
    width: 30px;
    text-align: center;
}

.menu-text {
    flex: 1;
    font-size: 14px;
    font-weight: bold;
    color: #fff;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ© */
.privacy-option {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer; position: relative;
}
.p-info { display: flex; flex-direction: column; gap: 5px; }
.p-title { font-weight: bold; font-size: 14px; color: #fff; display: flex; align-items: center; gap: 8px; }
.p-desc { font-size: 11px; color: #aaa; }

/* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ¹Ù…Ù„ ÙˆØ§Ø­Ø¯ Ù…Ø®ØµØµ */
.privacy-option input { display: none; }
.radio-mark {
    width: 20px; height: 20px; border: 2px solid #555; border-radius: 50%;
    display: grid; place-items: center; transition: 0.2s;
}
.radio-mark::after {
    content: ''; width: 10px; height: 10px; background: var(--primary);
    border-radius: 50%; transform: scale(0); transition: 0.2s;
}
/* Ù„Ù…Ø§ Ù†Ø®ØªØ§Ø± ÙˆØ§Ø­Ø¯ */
.privacy-option input:checked + .radio-mark { border-color: var(--primary); }
.privacy-option input:checked + .radio-mark::after { transform: scale(1); }

/* 1. ØªØ­Ø¯ÙŠØ¯ Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†ÙØ³Ù‡Ø§ Ø¹Ø´Ø§Ù† Ù…ØªØ®Ø±Ø¬Ø´ Ø¨Ø±Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© */
#videoOptionsSheet {
    max-height: 75vh; /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ 75% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
    display: flex;
    flex-direction: column; /* Ø¹Ø´Ø§Ù† Ù†Ø±ØªØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙˆÙ‚ Ø¨Ø¹Ø¶ */
    overflow: hidden; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„Ù…Ø¯ÙˆØ±Ø© ØªÙØ¶Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø© */
}

/* 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ù„Ø²Ø±Ø§ÙŠØ± (menu-list) */
#videoOptionsSheet .menu-list {
    overflow-y: auto; /* Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ø£Ø³ÙŠ */
    flex: 1; /* Ø®Ø¯ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙƒÙ„Ù‡Ø§ */
    padding-bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ø£Ù…Ø§Ù† ØªØ­Øª Ø¹Ø´Ø§Ù† Ø¢Ø®Ø± Ø²Ø±Ø§Ø± ÙŠØ¨Ø§Ù† */
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± (Scrollbar) Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ ÙŠØ¨Ù‚Ù‰ Ø§Ø­ØªØ±Ø§ÙÙŠ */
    scrollbar-width: none; /* Ù„Ù…ØªØµÙØ­Ø§Øª ÙØ§ÙŠØ±ÙÙˆÙƒØ³ */
    -ms-overflow-style: none; /* Ù„Ù…ØªØµÙØ­Ø§Øª Ø¥ÙŠØ¯Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
}

/* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù…ØªØµÙØ­Ø§Øª ÙƒØ±ÙˆÙ… ÙˆØ³ÙØ§Ø±ÙŠ */
#videoOptionsSheet .menu-list::-webkit-scrollbar {
    display: none;
}

.speed-overlay {
    position: absolute;
    top: 20%; /* ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    z-index: 10;
    backdrop-filter: blur(4px);
    font-size: 14px;
}
/* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¨Ø³ÙŠØ· Ù„Ù„Ø¸Ù‡ÙˆØ± */
.speed-overlay.active {
    display: flex;
    align-items: center;
    gap: 8px;
    animation: fadeIn 0.2s ease;
}

.meta-badge {
    background: rgba(255, 255, 255, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    color: #ccc;
    font-family: monospace; /* Ø®Ø· Ø±Ù‚Ù…ÙŠ */
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 5px;
    direction: ltr; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª ØªØ¸Ù‡Ø± ØµØ­ */
}

.seeker-timer {
    position: absolute;
    right: 5px;   /* Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
    bottom: 12px; /* ÙÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø¨Ø´ÙˆÙŠØ© */
    color: #fff;
    font-size: 11px;
    font-weight: bold;
    font-family: monospace; /* Ø®Ø· Ø±Ù‚Ù…ÙŠ Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…ØªÙ‡Ø²Ø´ */
    text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* Ø¸Ù„ Ø¹Ø´Ø§Ù† ÙŠØ¨Ø§Ù† Ù„Ùˆ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© */
    pointer-events: none; /* Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ø·Ù„Ø´ Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù†Øª Ø¨ØªØ³Ø­Ø¨ Ø§Ù„Ø´Ø±ÙŠØ· */
    opacity: 0.9;
}

.nav-tabs {
    /* 1. Ø§Ù„ØªÙˆØ³ÙŠØ· ÙÙŠ Ù†Øµ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    
    /* 2. Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ (Ø®Ù„ÙŠÙ†Ø§Ù‡Ø§ 65px Ø¨Ø¯Ù„ 45px) */
    margin-top: 65px; 
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø´ÙƒÙ„ */
    display: flex;
    gap: 20px;
    font-size: 16px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.6);
    z-index: 10; 
}
/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©) */
.speed-control-group {
    display: flex;
    background: rgba(255, 255, 255, 0.1); /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ù…Ù‚ */
    border-radius: 8px;
    padding: 4px;
    gap: 2px;
    direction: ltr; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªØªØ±ØªØ¨ ØµØ­ Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ Ù„Ù„ÙŠÙ…ÙŠÙ† */
}

/* Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ÙˆØ§Ø­Ø¯ */
.sp-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    color: #888; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ ØºÙŠØ± Ø§Ù„Ù†Ø´Ø· */
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: sans-serif; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªÙƒÙˆÙ† ÙˆØ§Ø¶Ø­Ø© */
}

/* Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø· (Ø§Ù„Ù…Ø®ØªØ§Ø±) */
.sp-btn.active {
    background: rgba(255, 255, 255, 0.25); /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù„Ù„Ù†Ø´Ø· */
    color: #fff; /* Ù†Øµ Ø£Ø¨ÙŠØ¶ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.sp-btn:active {
    transform: scale(0.95);
}

/* ØªØµÙ…ÙŠÙ… ØµÙØ­Ø© Ø§Ù„ØµÙˆØª */
.sound-header-banner {
    padding: 80px 20px 20px 20px;
    background: linear-gradient(to bottom, #2a2a2a, #121212);
    display: flex;
    align-items: center;
    gap: 20px;
}

.sound-disc-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #000;
    border: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 25px;
    color: #fff;
    position: relative;
    background-size: cover;
    background-position: center;
}

.sound-info-block h2 {
    font-size: 18px;
    margin-bottom: 5px;
    color: #fff;
}

.sound-author {
    font-size: 14px;
    color: #aaa;
    font-weight: bold;
}

.sound-stats {
    font-size: 12px;
    color: #777;
    margin-top: 5px;
}

.sound-actions-bar {
    padding: 0 20px 20px 20px;
    background: #121212;
    border-bottom: 1px solid #222;
}

.add-fav-btn {
    width: 100%;
    padding: 10px;
    background: #222;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: 0.2s;
}

.add-fav-btn.active {
    background: rgba(255, 215, 0, 0.15);
    color: #FFD700;
    border-color: #FFD700;
}

/* Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
.use-sound-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 15px;
    background: #121212;
    border-top: 1px solid #222;
    display: flex;
    justify-content: center;
    z-index: 2501;
}

.use-sound-btn {
    background: #F72585; /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±/Ø§Ù„Ø¨ÙŠÙ†Ùƒ Ø¨ØªØ§Ø¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    color: #fff;
    border: none;
    padding: 12px 40px;
    border-radius: 30px;
    font-size: 16px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4);
    cursor: pointer;
}

/* Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ù…ÙŠØ² */
.nav-create-btn {
    width: 45px;
    height: 32px; /* Ø´ÙƒÙ„ Ù…Ø³ØªØ·ÙŠÙ„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙŠÙƒÙˆÙ† Ù…Ù…ÙŠØ²Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© */
    background: linear-gradient(90deg, #F72585 0%, #7209b7 100%); /* ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ */
    border-radius: 8px; /* Ø­ÙˆØ§Ù Ù†Ø§Ø¹Ù…Ø© */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    margin-left: 5px; /* Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¨ÙŠÙ†Ù‡ ÙˆØ¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ */
    box-shadow: 0 0 15px rgba(247, 37, 133, 0.4); /* ØªÙˆÙ‡Ø¬ Ø®ÙÙŠÙ */
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.2s;
}

.nav-create-btn:active {
    transform: scale(0.95);
}

.nav-create-btn i {
    color: #fff;
    font-size: 16px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Shine Effect) */
.nav-create-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -150%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    transform: skewX(-20deg);
    animation: btnShine 4s infinite; /* ØªØªÙƒØ±Ø± ÙƒÙ„ 4 Ø«ÙˆØ§Ù†ÙŠ */
}

@keyframes btnShine {
    0% { left: -150%; }
    20% { left: 150%; } /* ØªØªØ­Ø±Ùƒ Ø§Ù„Ù„Ù…Ø¹Ø© Ø¨Ø³Ø±Ø¹Ø© */
    100% { left: 150%; } /* ÙˆØªØ®ØªÙÙŠ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆÙ‚Øª */
}


    </style>
</head>
<body>

    <div class="app-container" id="feed">
        </div>

  <div class="sheet-overlay" id="overlay" onclick="handleSmartOverlayClick()"></div>

    <div class="bottom-sheet" id="cmSheet" style="height: 75vh;">
        <div class="sheet-handle"></div>
        <div class="cm-header">
            <span id="cmCount">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
            <i class="fa-solid fa-xmark" onclick="closeAllSheets()" style="cursor:pointer; padding:5px"></i>
        </div>
        <div class="cm-body" id="cmList"></div>
        
        <div class="mention-dropdown" id="mentionDropdown"></div>
<div class="cm-footer" id="commentFooter">
    <div class="suggested-emojis" id="suggestedEmojis">
        <span onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
        <span onclick="insertEmoji('ğŸ¥°')">ğŸ¥°</span>
        <span onclick="insertEmoji('ğŸ˜­')">ğŸ˜­</span>
        <span onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
        <span onclick="insertEmoji('ğŸ”¥')">ğŸ”¥</span>
        <span onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
    </div>

    <div class="input-area-container">
        
        <div id="normalModeUI" style="display: flex; width: 100%; align-items: flex-end; gap: 8px;">
            
            <div class="external-actions">
                <label class="ext-btn" style="color: #4cd964;">
                    <i class="fa-solid fa-image"></i>
                    <input type="file" hidden accept="image/*,video/*" onchange="uploadCommentMedia(this)">
                </label>

                <div class="ext-btn" onclick="GiftSystem.open()" style="color: #bf5af2; border-color: #bf5af2;">
                    <i class="fa-solid fa-gift"></i>
                </div>
            </div>

            <div class="smart-input-wrapper">
                <textarea id="cmInput" 
                          class="smart-textarea" 
                          placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." 
                          rows="1" 
                          onfocus="expandInputArea()" 
                          oninput="handleInputTyping(this)"></textarea>
            </div>

            <div id="dynamicActionBtn" class="action-submit-btn mic-mode" onclick="toggleRecording()">
                <i class="fa-solid fa-microphone" id="mainMicIcon"></i>
                <i class="fa-solid fa-paper-plane" id="mainSendIcon" style="display: none;"></i>
            </div>
        </div>

        <div id="recordingModeUI" class="recording-overlay" style="display: none;">
            <div class="action-submit-btn" style="color:#ff3b30; background:rgba(255,59,48,0.1)" onclick="cancelRecording()">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <div class="rec-info">
                <div class="rec-dot"></div> <span id="recordTimer">00:00</span>
            </div>
            <div class="action-submit-btn" style="background:var(--primary)" onclick="stopAndSendRecording()">
                <i class="fa-solid fa-paper-plane" style="transform: rotate(180deg) scaleX(-1);"></i> 
            </div>
        </div>

    </div>
</div>

    </div>

<div class="bottom-sheet" id="repliesSheet" style="height: 75vh; border-radius: 24px 24px 0 0;">
    <div class="sheet-handle"></div>
    
    <div class="cm-header">
        <i class="fa-solid fa-arrow-right" onclick="closeRepliesSheet()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
        <span style="flex:1; text-align:center;">Ø§Ù„Ø±Ø¯ÙˆØ¯</span>
        <i class="fa-solid fa-xmark" onclick="closeRepliesSheet()" style="cursor:pointer; padding:5px; font-size:18px;"></i>
    </div>

    <div class="cm-body" id="repliesList" style="padding-bottom: 90px;"></div>

    <div class="cm-footer" id="replyFooter">
        <div class="input-area-container">
            
            <div id="replyNormalModeUI" style="display: flex; width: 100%; align-items: flex-end; gap: 8px;">
                
                <div class="external-actions" id="replyExternalActions">
                    <label class="ext-btn" style="color: #4cd964;">
                        <i class="fa-solid fa-image"></i>
                        <input type="file" hidden accept="image/*,video/*" onchange="uploadReplyMedia(this)">
                    </label>

                    <div class="ext-btn" onclick="GiftSystem.openForReply()" style="color: #bf5af2; border-color: #bf5af2;">
                        <i class="fa-solid fa-gift"></i>
                    </div>
                </div>

                <div class="smart-input-wrapper">
                    <textarea id="replyInput" 
                              class="smart-textarea" 
                              placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ø§Ù‹..." 
                              rows="1" 
                              onfocus="expandReplyInputArea()" 
                              oninput="handleReplyTyping(this)"></textarea>
                </div>

                <div id="replyDynamicActionBtn" class="action-submit-btn mic-mode" onclick="toggleReplyRecording()">
                    <i class="fa-solid fa-microphone" id="replyMicIcon"></i>
                    <i class="fa-solid fa-paper-plane" id="replySendIcon" style="display: none;"></i>
                </div>
            </div>

            <div id="replyRecordingModeUI" class="recording-overlay" style="display: none;">
                <div class="action-submit-btn" style="color:#ff3b30; background:rgba(255,59,48,0.1)" onclick="cancelReplyRecording()">
                    <i class="fa-solid fa-trash-can"></i>
                </div>
                
                <div class="rec-info">
                    <div class="rec-dot"></div> <span id="replyRecordTimer">00:00</span>
                </div>
                
                <div class="action-submit-btn" style="background:var(--primary)" onclick="stopAndSendReplyRecording()">
                    <i class="fa-solid fa-paper-plane" style="transform: rotate(180deg) scaleX(-1);"></i> 
                </div>
            </div>

        </div>
    </div>
</div>


    <div class="bottom-sheet" id="giftSheet" style="height: 60vh;">
        <div class="sheet-handle"></div>
        <h3 style="color:var(--text-color); text-align:center; margin-bottom:10px; font-size: 16px;">
            <i class="fa-solid fa-gift" style="color:var(--primary)"></i> Ù…ØªØ¬Ø± Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§
        </h3>
        <div class="gift-tabs-container">
            <div class="gift-tab active" onclick="GiftSystem.switch('gifts', this)">Ù‡Ø¯Ø§ÙŠØ§</div>
            <div class="gift-tab" onclick="GiftSystem.switch('stickers', this)">Ù…Ù„ØµÙ‚Ø§Øª</div>
        </div>
        <div id="giftSystemContent" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div class="bottom-sheet" id="stickerSheet" style="height: auto; max-height: 60vh; z-index: 250;">
        <div class="sheet-handle"></div>
        <div style="padding: 15px; text-align: center; font-weight: 800; border-bottom: 1px solid var(--border-color); color:var(--text-color)">
            Ø§Ø³ØªÙŠÙƒØ±Ø§Øª
        </div>
        <div class="stickers-grid" id="stickersGrid"></div>
    </div>

    <div class="bottom-sheet" id="commentOptionsSheet" style="height: auto;">
        <div class="sheet-handle"></div>
        <div id="cmOwnerOptions">
            <div class="c-option-item" onclick="triggerEditComment()"><i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</div>
            <div class="c-option-item" onclick="triggerReplyComment()"><i class="fa-solid fa-reply"></i> Ø±Ø¯</div>
            <div class="c-option-item" onclick="triggerCopyComment()"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø®</div>
            <div class="c-option-item danger" onclick="triggerDeleteComment()"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</div>
        </div>
        <div id="cmViewerOptions" style="display:none">
            <div class="c-option-item" onclick="triggerReplyComment()"><i class="fa-solid fa-reply"></i> Ø±Ø¯</div>
            <div class="c-option-item" onclick="triggerCopyComment()"><i class="fa-regular fa-copy"></i> Ù†Ø³Ø®</div>
            <div id="ownerDeleteBtn" class="c-option-item danger" style="display:none" onclick="triggerDeleteComment()"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</div>
            <div class="c-option-item danger" onclick="reportComment()"><i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº</div>
        </div>
    </div>


    <div class="custom-modal" id="chicConfirmModal" style="z-index: 9999;">
        <div class="modal-box">
            <div style="font-size: 40px; margin-bottom: 15px;" id="chicIcon"></div>
            <h3 id="chicTitle" style="margin-bottom: 10px; color: var(--text-color);">ØªØ£ÙƒÙŠØ¯</h3>
            <p id="chicMessage" style="color: var(--secondary-text); font-size: 14px; margin-bottom: 25px; line-height: 1.5;"></p>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="closeChicModal()" style="flex: 1; padding: 10px; background: #333; color: #fff; border-radius: 10px;">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn" id="chicConfirmBtn" style="flex: 1; padding: 10px; background: var(--danger-color); color: #fff; border-radius: 10px;">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-check-circle" style="color:var(--success-color)"></i> <span id="toastMsg"></span></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app", 
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        moment.locale('ar');

        // --- 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let currentUser = null;
        let currentUserData = null;
        let lastDoc = null; 
        let isLoading = false;

        let currentOpenVideoId = null;
        let currentPostOwnerUid = null;
        let selectedComment = null; 
        let selectedReply = null;
        let isEditingComment = false;
        let isEditingReply = false;
        let pressTimer;
        let currentParentComment = null;
        let currentSubReplyTarget = null;
        let isGhost = false;
        let commentsUnsub = null;
        let replyListener = null;

        let mediaRecorder = null;
        let audioChunks = [];
        let recordInterval;
        let isRecording = false;
let isGlobalMuted = true; 
let currentFeedTab = 'world'; // world | friends | popular
let currentSearchType = 'users'; // users | videos
// Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØªØ¬Ø§Ù‡Ù„Ù‡Ù…
let blockedUsersSet = new Set(); 

// Ø¯ÙŠ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù„ÙŠ Ø¬Ø¨Ù†Ø§Ù‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªØ§Ø¹Ùƒ
const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø£ÙŠ ÙƒÙˆØ¯ Ø®Ø¨ÙŠØ«
function escapeHTML(str) {
    if (!str) return "";
    return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

        const stickerCollection = ["ğŸ¤£", "ğŸ˜‚", "ğŸ˜…", "ğŸ¥¹", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ¤ª", "ğŸ˜", "ğŸ˜­", "ğŸ˜¢", "ğŸ˜¤", "ğŸ˜¡", "ğŸ¤¬", "ğŸ¤¯", "ğŸ˜³", "ğŸ˜±", "ğŸ˜´", "ğŸ¤®", "ğŸ¤¡", "ğŸ’€", "ğŸ‘»", "ğŸ‘½", "ğŸ’©", "ğŸ‘", "ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "â¤ï¸", "ğŸ’”", "ğŸ”¥", "âœ¨"];
        const ghostColors = ["#ff0000", "#00ff00", "#0099ff", "#ffff00", "#ff00ff", "#00ffff", "#ff9900", "#9900ff", "#ffffff", "#00ff99"];

        // --- 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        // Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ auth Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ±ØªÙŠØ¨
auth.onAuthStateChanged(async user => {
    if(user) {
        currentUser = user;
        
        // 1. Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const uDoc = await db.collection('users').doc(user.uid).get();
        if(uDoc.exists) {
            currentUserData = uDoc.data();
            if(currentUserData.isGhost) isGhost = true;
        }
        
        // 2. ğŸ”¥ Ù†Ø¬ÙŠØ¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
        await fetchBlockedUsersList();
listenToUnreadNotifications();

        // 3. Ø¨Ø¹Ø¯Ù‡Ø§ Ù†Ø­Ù…Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        loadVideos(true);
        startPresenceSystem();
    } else {
        console.log("User not logged in");
        // Ù„Ùˆ Ù…Ø´ Ù…Ø³Ø¬Ù„ØŒ Ø­Ù…Ù„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¹Ø§Ø¯ÙŠ (Ù…ÙÙŠØ´ Ø­Ø¸Ø± Ù„Ø³Ù‡)
        
        loadVideos(true);
    }
});


        // --- 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Feed Logic) ---
      async function loadVideos(isInitial = false) {
    if (isLoading) return;
    isLoading = true;

    const feed = document.getElementById('feed');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ¯Ø± ØµØºÙŠØ± Ù„Ùˆ Ø¨Ù†Ø­Ù…Ù„
    if(isInitial) feed.innerHTML = '<div style="color:#fff; text-align:center; padding:50px; font-size:20px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    let query = db.collection('posts');

    // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… ---
    if (currentFeedTab === 'popular') {
        query = query.orderBy('commentsCount', 'desc');
    } 
    else if (currentFeedTab === 'friends') {
        if (!currentUser) {
            feed.innerHTML = '<div style="text-align:center; margin-top:50%; color:#aaa;">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</div>';
            isLoading = false; return;
        }
        query = query.orderBy('createdAt', 'desc'); 
    } 
    else {
        query = query.orderBy('createdAt', 'desc');
    }

    // Paging
    query = query.limit(5);
    if (!isInitial && lastDoc) {
        query = query.startAfter(lastDoc);
    }

    try {
        const snapshot = await query.get();
        if(isInitial) feed.innerHTML = '';

        if (snapshot.empty) {
            if(isInitial) feed.innerHTML = '<div style="text-align:center; margin-top:50%; color:#aaa;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>';
            isLoading = false;
            return;
        }

        lastDoc = snapshot.docs[snapshot.docs.length - 1];

        for (const doc of snapshot.docs) {
            const data = doc.data();
            const videoMedia = data.media ? data.media.find(m => m.type === 'video') : null;
            
            if (blockedUsersSet.has(data.uid)) {
        console.log("ØªÙ… Ø¥Ø®ÙØ§Ø¡ ÙÙŠØ¯ÙŠÙˆ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±:", data.uid);
        continue; // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹ ÙˆÙ„Ø§ ØªØ±Ø³Ù… Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    }

             // Ø¶Ø¹Ù‡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø¯Ø§Ù„Ø© loadVideos Ù‚Ø¨Ù„ Ù‚ÙÙ„ Ø§Ù„Ù‚ÙˆØ³ }
if (currentUser) {
    // ÙØ­Øµ Ø§Ù„Ù…ÙØ¶Ù„Ø©
    db.collection('users').doc(currentUser.uid).collection('favorites').get().then(snap => {
        snap.forEach(doc => {
            const icon = document.getElementById(`fav-star-${doc.id}`);
            const text = document.getElementById(`fav-text-${doc.id}`);
            if (icon) {
                icon.style.color = "#FFD700";
                if(text) text.innerText = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
            }
        });
    });
}

            if (videoMedia) {
                 // --- ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ---
                 let uName = "Ù…Ø³ØªØ®Ø¯Ù…";
                 let uPic = defaultAvatar; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙƒØ¨Ø¯Ø§ÙŠØ©
                 let isVerified = false;

                 try {
                     const uSnap = await db.collection('users').doc(data.uid).get();
                     if(uSnap.exists) { 
                         const uData = uSnap.data(); 
                         uName = uData.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                         // Ø§Ù„ØªØµØ­ÙŠØ­: Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ù„Ù…ØªØºÙŠØ± uPic
                         uPic = uData.profilePic || uData.avatarUrl || defaultAvatar;
                         isVerified = uData.isVerified || false; 
                     }
                 } catch(e) {
                     console.error("Error fetching user data:", e);
                 }
                 
                 const cardHTML = createVideoCard(doc.id, {...data, isVerified}, videoMedia.url, uName, uPic, data.uid);
                 feed.insertAdjacentHTML('beforeend', cardHTML);
                 
                 const newCard = document.getElementById(`slide-${doc.id}`);
                 if (newCard) observer.observe(newCard);
             }
        }
    } catch (e) {
        console.error("Error loading videos:", e);
    }
    isLoading = false;
}

        function createVideoCard(id, data, url, uName, uPic, ownerUid) {
    const isLiked = data.likes && data.likes[currentUser.uid];
    
    // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø¬Ø¯Ø§Ù‹
    let hasSound = false;
    let soundUrl = '';
    
    // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
    if (data.hasSound === true && data.soundInfo && data.soundInfo.url && data.soundInfo.url.length > 5) {
        hasSound = true;
        soundUrl = data.soundInfo.url;
    }

    const muteOriginal = (hasSound && data.soundSettings) ? data.soundSettings.muteOriginal : false;
    const mutedClass = isGlobalMuted ? 'muted-state' : '';

    const isVerified = data.isVerified || false;
    const verifiedBadgeHTML = getBadge(isVerified, false); 
    const displayName = formatSmartName(uName);
    const userImage = uPic || "https://cdn-icons-png.flaticon.com/512/847/847969.png";

    // 2. Ø¥ØµÙ„Ø§Ø­ ØµÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø©
    let displayMusicName = `Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ - ${displayName}`;
    let vinylImage = userImage; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    if (hasSound) {
        if (data.soundInfo.name) displayMusicName = data.soundInfo.name;
        // Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹
        if (data.soundInfo.img && data.soundInfo.img.startsWith('http')) {
            vinylImage = data.soundInfo.img;
        }
    }

    const safeMusicName = displayMusicName.replace(/'/g, "\\'");
    const safeAuthorName = displayName.replace(/'/g, "\\'");
    const safeVinylImage = vinylImage.replace(/'/g, "\\'");
    // Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØª Ù…Ø±ÙÙ‚ØŒ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© ÙŠØ±ÙˆØ­ Ù„Ù„ØµÙˆØªØŒ Ù„Ùˆ Ù…ÙÙŠØ´ ÙŠØ±ÙˆØ­ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
    const finalSoundUrl = hasSound ? soundUrl : url; 

    // Ù„Ù† Ù†Ø¶Ø¹ Ø¹Ù†ØµØ± <audio> Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ØŒ Ø³Ù†Ù†Ø´Ø¦Ù‡ ÙÙŠ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª
    return `
    <div class="video-slide ${mutedClass}" id="slide-${id}" data-id="${id}" 
         data-has-sound="${hasSound}" 
         data-sound-url="${soundUrl}"
         data-mute-original="${muteOriginal}">
    
        <div class="speed-overlay" id="speedOverlay-${id}"><i class="fa-solid fa-forward"></i> 2x Ø³Ø±Ø¹Ø©</div>
        <div class="brand-loader" id="loader-${id}"><i class="fa-solid fa-heart-pulse brand-pulse-icon"></i></div>
        
        <div class="mute-indicator" id="mute-indicator-${id}" style="opacity: ${isGlobalMuted ? 1 : 0}"><i class="fa-solid fa-volume-xmark"></i></div>

        <video id="vid-${id}" loop playsinline muted preload="auto" poster="${data.thumbnail || ''}" 
               onpause="updatePlayButtonState(this, '${id}')" 
               onplay="updatePlayButtonState(this, '${id}')"
               ontimeupdate="updateFloatingSeeker(this, '${id}')"> 
               <source src="${url}" type="video/mp4">
        </video>

        <div class="center-play-button" id="center-btn-${id}"><i class="fa-solid fa-play"></i></div>
        <i class="fa-solid fa-heart big-heart" id="heart-anim-${id}"></i>
        
        <div class="interaction-layer" 
             onclick="handleSingleClick('${id}')" 
             ontouchstart="startTurboMode('${id}')" 
             ontouchend="stopTurboMode('${id}')" 
             ontouchcancel="stopTurboMode('${id}')">
        </div>

        <div class="side-bar">
            <div class="action-btn" onclick="toggleLike('${id}')">
                <div class="icon-circle"><i class="fa-solid fa-heart" id="like-icon-${id}" style="color: ${isLiked ? '#F72585' : '#fff'}"></i></div>
                <span class="action-text" id="like-count-${id}">${data.likes ? Object.keys(data.likes).length : 0}</span>
            </div>
            <div class="action-btn" onclick="openComments('${id}', '${ownerUid}')">
                <div class="icon-circle"><i class="fa-solid fa-comment-dots"></i></div>
                <span class="action-text" id="comment-count-${id}">${data.commentsCount || 0}</span>
            </div>
            <div class="action-btn" onclick="toggleSave('${id}')">
                <div class="icon-circle"><i class="fa-solid fa-bookmark" id="save-icon-${id}"></i></div>
                <span class="action-text" id="save-text-${id}">Ø­ÙØ¸</span>
            </div>
            <div class="action-btn" onclick="shareVideo('${id}', '${data.text}')">
                <div class="icon-circle"><i class="fa-solid fa-share"></i></div>
                <span class="action-text">Ù…Ø´Ø§Ø±ÙƒØ©</span>
            </div>
            <div class="action-btn" onclick="openVideoOptions('${id}', '${ownerUid}')">
                 <div class="icon-circle" style="background:none; border:none; box-shadow:none;">
                    <i class="fa-solid fa-ellipsis" style="font-size:25px;"></i>
                 </div>
            </div>
        </div>

        <div class="video-info">
            <div class="info-inner">
                <div class="user-header-row">
                    <img src="${userImage}" class="header-avatar" onclick="location.href='profile.html?uid=${ownerUid}'">
                    <div class="header-name-block" onclick="location.href='profile.html?uid=${ownerUid}'">
                        <span class="header-username" dir="auto">${displayName}</span> ${verifiedBadgeHTML}
                    </div>
                    <div class="follow-btn-inline" onclick="toggleFollow('${ownerUid}', this)">Ù…ØªØ§Ø¨Ø¹Ø©</div>
                </div>
                
                <div class="video-desc">${data.text || ''}</div>
                
                <div class="music-row" onclick="event.stopPropagation(); openSoundPage('${safeMusicName}', '${safeAuthorName}', '${safeVinylImage}', '${finalSoundUrl}')">
                    <div class="music-marquee-container">
                        <i class="fa-solid fa-music"></i> 
                        <marquee scrollamount="4" style="width:150px;">${displayMusicName}</marquee>
                    </div>
                    <div class="vinyl-wrapper">
                        <div class="floating-notes"><i class="fa-solid fa-music"></i><i class="fa-solid fa-music"></i></div>
                        <div class="vinyl-disc">
                            <img src="${vinylImage}" class="vinyl-img">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="floating-seeker-container" ontouchstart="startSeeking(event, '${id}')" ontouchmove="moveSeeking(event, '${id}')" ontouchend="endSeeking(event, '${id}')">
            <div class="seeker-track" id="track-${id}"><div class="seeker-fill" id="fill-${id}"></div></div>
        </div>
    </div>`;
}


        const observerOptions = { root: document.getElementById('feed'), threshold: 0.6 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const slide = entry.target;
                const vid = slide.querySelector('video');
                const id = slide.dataset.id;
                if (entry.isIntersecting) {
                    playVideo(vid, id);
                    if(slide.nextElementSibling === null) loadVideos();
                } else {
                    pauseVideo(vid);
                }
            });
        }, observerOptions);

        // --- 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø§Ù„Ø°ÙƒÙŠØ©) ---
// --- 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø§Ù„Ù…ØµØ­Ø­Ø©) ---
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØª Ø§Ù„Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø¹Ø´Ø§Ù† Ù†ÙˆÙ‚ÙÙ‡ Ù„Ù…Ø§ Ù†Ù‚Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
let activeAudioObject = null;

function playVideo(vid, id) {
    const loader = document.getElementById(`loader-${id}`);
    const slide = document.getElementById(`slide-${id}`); 
    const audio = document.getElementById(`audio-${id}`); // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ÙÙ‚
    
    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const muteOriginal = slide.getAttribute('data-mute-original') === 'true';
    const hasSound = slide.getAttribute('data-has-sound') === 'true';

    applyAutoScrollLogic(vid, id);

    vid.onwaiting = () => { if(loader) loader.style.display = 'block'; };
    vid.onplaying = () => { if(loader) loader.style.display = 'none'; };

    // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙˆØ§Øª ===
    if (isGlobalMuted) {
        // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ§Ù…Øª Ù„Ù„ÙƒÙ„
        vid.muted = true;
        if(audio) audio.muted = true;
        slide.classList.add('muted-state');
        document.getElementById(`mute-indicator-${id}`).style.opacity = '1';
    } else {
        // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙØªÙˆØ­
        slide.classList.remove('muted-state');
        document.getElementById(`mute-indicator-${id}`).style.opacity = '0';
        
        // Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ
        if (hasSound && muteOriginal) {
            vid.muted = true; // ÙƒØªÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ
        } else {
            vid.muted = false; // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ
        }

        // Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if(hasSound && audio) {
            audio.muted = false;
            audio.volume = 1.0;
        }
    }

    // Ø§Ù„ØªØ´ØºÙŠÙ„
    var playPromise = vid.play();

    if (playPromise !== undefined) {
        playPromise.then(_ => {
            if(loader) loader.style.display = 'none';
            addToWatchHistory(id);
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
            if (hasSound && audio && !isGlobalMuted) {
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª
                if(Math.abs(audio.currentTime - vid.currentTime) > 0.3) {
                    audio.currentTime = vid.currentTime;
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                const audioPromise = audio.play();
                if (audioPromise !== undefined) {
                    audioPromise.catch(e => {
                        console.log("Audio autoplay blocked by browser");
                        // Ù„Ø§ Ù†Ø¸Ù‡Ø± Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø³Ù†Ù†ØªØ¸Ø± Ø¶ØºØ·ØªÙ‡ ÙÙŠ handleSingleClick
                    });
                }
            }
        })
        .catch(error => {
            // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†ÙØ³Ù‡ Ø§ØªÙ…Ù†Ø¹
            console.log("Video autoplay blocked");
            vid.muted = true;
            slide.classList.add('muted-state');
            isGlobalMuted = true;
            vid.play();
            // Ø­Ø§ÙˆÙ„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØµØ§Ù…ØªØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„Ù‡
            if(audio) { audio.muted = true; audio.play(); }
        });
    }
}

function pauseVideo(vid) { 
    vid.pause(); 
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if(activeAudioObject) {
        activeAudioObject.pause();
    }
    const id = vid.id.split('-')[1];
    const loader = document.getElementById(`loader-${id}`);
    if(loader) loader.style.display = 'none';
}


// --- Ø¯ÙˆØ§Ù„ Ø´Ø±ÙŠØ· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø§Ø¦Ù… (Seeker Logic) ---

// 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
// --- Ø¯ÙˆØ§Ù„ Ø´Ø±ÙŠØ· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø§Ø¦Ù… (Seeker Logic) ---

let isDraggingSeeker = false;

// 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ (Fix Movement)
// --- Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ---
function updateFloatingSeeker(vid, id) {
    if (isDraggingSeeker) return; 

    if (vid.duration && !isNaN(vid.duration)) {
        // 1. ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´Ø±ÙŠØ· (Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ)
        const percent = (vid.currentTime / vid.duration) * 100;
        const fill = document.getElementById(`fill-${id}`);
        if (fill) fill.style.width = `${percent}%`;

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ğŸ”¥
        const timerEl = document.getElementById(`timer-${id}`);
        if (timerEl) {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            const remaining = vid.duration - vid.currentTime;
            
            const m = Math.floor(remaining / 60).toString().padStart(2, '0');
            const s = Math.floor(remaining % 60).toString().padStart(2, '0');
            
            // Ù†Ø¹Ø±Ø¶Ù‡ Ø¨Ø§Ù„Ø³Ø§Ù„Ø¨ Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
            timerEl.innerText = `-${m}:${s}`;
        }
    }
}


// 2. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø­Ø¨
function startSeeking(e, id) {
    isDraggingSeeker = true;
    const vid = document.getElementById(`vid-${id}`);
    if(vid) vid.pause(); // Ù†ÙˆÙ‚Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø­Ø¸ÙŠØ§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø­Ø¨ ÙŠÙƒÙˆÙ† Ù†Ø§Ø¹Ù…
    moveSeeking(e, id); // Ù†Ø­Ø±Ùƒ ÙÙˆØ±Ø§Ù‹ Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù„Ù…Ø³Ø©
}

// 3. Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨
function moveSeeking(e, id) {
    const track = document.getElementById(`track-${id}`);
    const fill = document.getElementById(`fill-${id}`);
    const bubble = document.getElementById(`time-bubble-${id}`);
    const vid = document.getElementById(`vid-${id}`);

    if (!track || !fill || !vid) return;

    const rect = track.getBoundingClientRect();
    const touchX = e.touches[0].clientX;
    
    // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¯Ù‡ Ø¯Ù„ÙˆÙ‚ØªÙ‰ Ù‡ÙŠØ´ØªØºÙ„ ØµØ­ Ù„Ø£Ù†Ù†Ø§ Ø¹Ù…Ù„Ù†Ø§ direction: ltr ÙÙŠ Ø§Ù„Ù€ CSS
    let percent = ((touchX - rect.left) / rect.width) * 100;
    
    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù†
    if (percent < 0) percent = 0;
    if (percent > 100) percent = 100;

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø±ÙƒØ©
    fill.style.width = `${percent}%`;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
    if (vid.duration) {
        const newTime = (percent / 100) * vid.duration;
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ø­Ø¸ÙŠØ§Ù‹
        vid.currentTime = newTime;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
        if(bubble) {
            const m = Math.floor(newTime / 60).toString().padStart(2, '0');
            const s = Math.floor(newTime % 60).toString().padStart(2, '0');
            bubble.innerText = `${m}:${s}`;
        }
    }
}

// 4. Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø­Ø¨
function endSeeking(e, id) {
    isDraggingSeeker = false;
    const vid = document.getElementById(`vid-${id}`);
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØªØ§Ù†ÙŠ
    if(vid) {
        playVideo(vid, id);
    }
}


// --- 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø¨ØªÙ†Ø¶Ù Ø§Ù„Ù„ÙˆØ¯Ø±) ---
function pauseVideo(vid) { 
    vid.pause(); 
    
    // ğŸ”¥ Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ù†Ø®ÙÙŠ Ø§Ù„Ù„ÙˆØ¯Ø± Ù„Ù…Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙ‚Ù
    // Ø¹Ø´Ø§Ù† Ù„Ùˆ Ù‚Ù„Ø¨Øª Ø¨Ø³Ø±Ø¹Ø© Ù…ÙŠÙØ¶Ù„Ø´ ÙŠÙ„Ù ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ ÙØ§Øª
    const id = vid.id.split('-')[1]; // Ø¨Ù†Ø¬ÙŠØ¨ Ø±Ù‚Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ù€ ID Ø¨ØªØ§Ø¹Ù‡
    const loader = document.getElementById(`loader-${id}`);
    if(loader) loader.style.display = 'none';
}

        function pauseVideo(vid) { vid.pause(); }
        
        function seekVideo(e, id) {
            e.stopPropagation();
            const vid = document.getElementById(`vid-${id}`);
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            vid.currentTime = pct * vid.duration;
        }

        // --- ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¶ØºØ· ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ… ---
let lastClickTime = 0;

function handleSingleClick(id) {
    const slide = document.getElementById(`slide-${id}`); 
    const vid = document.getElementById(`vid-${id}`);     
    const audio = document.getElementById(`audio-${id}`);
    
    const muteOriginal = slide.getAttribute('data-mute-original') === 'true';
    const hasSound = slide.getAttribute('data-has-sound') === 'true';

    const now = new Date().getTime();
    if (now - lastClickTime < 250) { handleDoubleClick(id); lastClickTime = now; return; }
    lastClickTime = now;

    setTimeout(() => {
        if (new Date().getTime() - lastClickTime < 250) return;

        // === Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ… (Unmute) ===
        if (isGlobalMuted) {
            isGlobalMuted = false;
            
            document.querySelectorAll('.video-slide').forEach(s => s.classList.remove('muted-state'));
            document.querySelectorAll('.mute-indicator').forEach(e => e.style.opacity = '0');

            // Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ
            if (hasSound && muteOriginal) {
                vid.muted = true;
            } else {
                vid.muted = false;
            }

            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø±ÙÙ‚ (Ø§Ù„Ø­Ù„ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©)
            if (hasSound && audio) {
                audio.muted = false;
                audio.currentTime = vid.currentTime;
                
                // ØªØ´ØºÙŠÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
                audio.play().catch(e => console.log("Force play failed:", e));
            }
            return;
        }

        // === Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: Ø¥ÙŠÙ‚Ø§Ù / ØªØ´ØºÙŠÙ„ ===
        if (vid.paused) {
            vid.play();
            if (hasSound && audio && !isGlobalMuted) audio.play();
        } else {
            vid.pause();
            if (audio) audio.pause();
        }

    }, 250);
}



        function handleDoubleClick(id) {
            const heart = document.getElementById(`heart-anim-${id}`);
            heart.classList.add('animate'); setTimeout(() => heart.classList.remove('animate'), 1000);
            const icon = document.getElementById(`like-icon-${id}`);
            if(icon.style.color !== 'rgb(247, 37, 133)') toggleLike(id);
        }

        function toggleLike(id) {
            const icon = document.getElementById(`like-icon-${id}`);
            const countSpan = document.getElementById(`like-count-${id}`);
            let count = parseInt(countSpan.innerText);
            const isLiked = icon.style.color === 'rgb(247, 37, 133)';
            
            if(isLiked) {
                icon.style.color = '#fff'; countSpan.innerText = count - 1;
                db.collection('posts').doc(id).update({ [`likes.${currentUser.uid}`]: firebase.firestore.FieldValue.delete() });
            } else {
                icon.style.color = '#F72585'; countSpan.innerText = count + 1;
                db.collection('posts').doc(id).update({ [`likes.${currentUser.uid}`]: true });
                sendNotification(ownerUid, 'like', 'Ø£Ø¹Ø¬Ø¨ Ø¨ÙÙŠØ¯ÙŠÙˆ Ù‚Ù…Øª Ø¨Ù†Ø´Ø±Ù‡ â¤ï¸', id);

            }
        }

        // =========================================================================
        // ==================== Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Ø§Ù„Ù…ÙØ­Ø³Ù†) =========================
        // =========================================================================

        function getGhostIdentity(uid) {
            if (!uid) return { id: '0000', color: '#ff0000' };
            let hash = 0;
            for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            hash = Math.abs(hash);
            const ghostID = (hash % 9000) + 1000;
            const colorIndex = hash % ghostColors.length;
            return { id: ghostID, color: ghostColors[colorIndex] };
        }

        function generateColor(uid) {
            const c=["#5D5FEF","#34c759","#ff3b30","#ffb533","#2AF598","#009EFD"];
            let h=0; for(let i=0;i<uid.length;i++) h=uid.charCodeAt(i)+((h<<5)-h);
            return c[Math.abs(h)%c.length];
        }

        // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ø´ØºÙ„Ù†Ø§ Ø§Ù„Ù…Ù†Ø´Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³
let isMentionSetup = false; 

// ØªÙ… Ø¥Ø¶Ø§ÙØ© async Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ø³ØªØ®Ø¯Ù… await Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
async function openComments(pid, ownerUid) {
    currentOpenVideoId = pid;
    currentPostOwnerUid = ownerUid;
    
    // 1. ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.body.classList.add('no-scroll'); 
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('cmSheet').classList.add('active');

    // 3. ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const list = document.getElementById('cmList');
    list.innerHTML = '<div id="loading-spinner" style="text-align:center; padding:20px; color:#aaa"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    // 4. ØªÙØ±ÙŠØº Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§
    resetCommentInput();
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ù† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ø´Ø§Ù† Ù…ÙŠØªÙƒØ±Ø±Ø´
    if (!isMentionSetup) {
        setupMentionListener('cmInput', 'mentionDropdown');
        isMentionSetup = true;
    }

    // 5. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø¹Ø´Ø§Ù† Ù…Ù†Ø¬Ø¨Ø´ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ ÙØ§Øª)
    if(commentsUnsub) commentsUnsub(); 

    // 6. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    commentsUnsub = db.collection("posts").doc(pid).collection("comments")
    .orderBy('createdAt', 'asc')
    .onSnapshot(snap => {
        // Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØµÙ„ØŒ Ø´ÙŠÙ„ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const spinner = document.getElementById('loading-spinner');
        if(spinner) spinner.remove();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        document.getElementById('cmCount').innerText = `Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${snap.size})`;
        const uiCount = document.getElementById(`comment-count-${pid}`);
        if(uiCount) uiCount.innerText = snap.size;

        if(snap.empty) {
            list.innerHTML = '<div class="empty-msg" style="text-align:center; color:#777; margin-top:20px">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚!</div>';
            // *ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·*: Ù„Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ø¨Ø³ ÙÙŠÙ‡ Ø±Ø³Ø§Ù„Ø© Ø­Ø¸Ø±ØŒ Ù…ØªØ¸Ù‡Ø±Ø´ "ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚"
            if(document.getElementById('blockedMsgDiv')) {
                 list.innerHTML = ''; 
                 list.appendChild(document.getElementById('blockedMsgDiv'));
            }
        } else {
            // Ù„Ùˆ ÙÙŠÙ‡ ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ ØªØ£ÙƒØ¯ Ø¥Ù† Ø±Ø³Ø§Ù„Ø© "ÙØ§Ø±Øº" Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
            const emptyMsg = list.querySelector('.empty-msg');
            if(emptyMsg) emptyMsg.remove();
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù)
        snap.docChanges().forEach(change => {
            const data = change.doc.data();
            data.id = change.doc.id;

            if (change.type === "added") {
                const el = createCommentElement(data);
                list.appendChild(el);
                // Ø§Ù†Ø²Ù„ Ù„ØªØ­Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø£Ø¬Ø¯Ø¯ ØªØ¹Ù„ÙŠÙ‚
                if(list.scrollHeight - list.scrollTop < 600) { // Ø´Ø±Ø· Ø°ÙƒÙŠ: Ø§Ù†Ø²Ù„ Ø¨Ø³ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ Ø·Ø§Ù„Ø¹ ÙÙˆÙ‚
                     list.scrollTop = list.scrollHeight;
                }
            }
            if (change.type === "modified") {
                const oldEl = document.getElementById(`comment-${data.id}`);
                if(oldEl) {
                    const newEl = createCommentElement(data);
                    list.replaceChild(newEl, oldEl);
                }
            }
            if (change.type === "removed") {
                const el = document.getElementById(`comment-${data.id}`);
                if(el) el.remove();
            }
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© ÙˆØ¶Ø¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…ØªÙ…Ø³Ø­Ù‡Ø§Ø´)
        const blockedMsg = document.getElementById('blockedMsgDiv');
        if(blockedMsg) list.appendChild(blockedMsg);
    });

    // ============================================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ÙØ­Øµ Ø§Ù„Ø®ØµÙˆØµÙŠØ©) ğŸ”¥ğŸ”¥ğŸ”¥
    // ============================================================
    
    const footer = document.getElementById('commentFooter');
    
    // 1. ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø­Ø¸Ø± Ù‚Ø¯ÙŠÙ…Ø©
    const existingMsg = document.getElementById('blockedMsgDiv');
    if(existingMsg) existingMsg.remove();
    
    // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØªØ± Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­Ø¯ Ù…Ø§ Ù†ÙØ­Øµ
    footer.style.display = 'none';

    try {
        // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØ³Øª
        const postDoc = await db.collection('posts').doc(pid).get();
        const postData = postDoc.data();
        const privacy = postData.commentPrivacy || 'public'; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ø§Ù…

        // Ù‡Ù„ Ø£Ù†Ø§ Ø§Ù„Ù…Ø§Ù„ÙƒØŸ
        const isOwner = (currentUser && currentUser.uid === ownerUid);
        
        let isAllowed = false;
        let blockText = "";

        if (isOwner) {
            isAllowed = true; 
        } else if (privacy === 'public') {
            isAllowed = true;
        } else if (privacy === 'disabled') {
            isAllowed = false;
            blockText = "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ğŸ”’";
        } else {
            // Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙˆØ³Øª Ø¹Ø´Ø§Ù† Ù†ÙØ­Øµ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            const ownerUserDoc = await db.collection('users').doc(ownerUid).get();
            const ownerData = ownerUserDoc.data();

            if (privacy === 'followers') {
                // Ù„Ø§Ø²Ù… Ø£ÙƒÙˆÙ† Ø¨ØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ (ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù€ uid Ø¨ØªØ§Ø¹ÙŠ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© followers Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„Ùƒ)
                const followers = ownerData.followers || [];
                if (followers.includes(currentUser.uid)) {
                    isAllowed = true;
                } else {
                    blockText = "Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ğŸ‘¥";
                }
            } 
            else if (privacy === 'following') {
                // Ù„Ø§Ø²Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø¨Ø¹Ù†ÙŠ (ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù€ uid Ø¨ØªØ§Ø¹ÙŠ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© following Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„Ùƒ)
                const following = ownerData.following || [];
                if (following.includes(currentUser.uid)) {
                    isAllowed = true;
                } else {
                    blockText = "ÙŠÙ…ÙƒÙ† Ù„Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† ÙŠØªØ§Ø¨Ø¹Ù‡Ù… Ø§Ù„Ù…Ø¤Ù„Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙ‚Ø· @";
                }
            }
        }

        // 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (isAllowed) {
            footer.style.display = 'flex';
        } else {
            footer.style.display = 'none';
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
            const msgDiv = document.createElement('div');
            msgDiv.id = 'blockedMsgDiv';
            msgDiv.style.cssText = "padding: 20px; text-align: center; color: #aaa; background: rgba(255,255,255,0.05); margin: 20px 10px; border-radius: 10px; font-size: 13px; border: 1px dashed #333;";
            msgDiv.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> ${blockText}`;
            list.appendChild(msgDiv);
        }

    } catch (err) {
        console.error("Privacy check error:", err);
        footer.style.display = 'flex'; // Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­ØµØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹
    }
    // ============================================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ğŸ”¥ğŸ”¥ğŸ”¥
    // ============================================================
}

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (Ù…ÙØµÙˆÙ„Ø© Ù„ØªØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„)
        function createCommentElement(c) {
    // ---------------------------------------------------------
    // 1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ---------------------------------------------------------
    let displayName = c.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
    let displayPic = c.pic;
    let verifiedDisplay = c.isVerified;
    let uidSafe = c.uid || 'user';
    let clickAction = `location.href='profile.html?uid=${uidSafe}'`;
    let avatarContent = displayPic ? '' : (displayName[0]);
    let avatarStyle = "";
    let nameColorStyle = "";


    // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ (Ghost Mode)
    if (c.isGhost) {
        const ghostIdentity = getGhostIdentity(uidSafe);
        displayName = `Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶ #${ghostIdentity.id}`;
        displayPic = "";
        verifiedDisplay = false;
        avatarContent = `<i class="fa-solid fa-user-secret" style="color:${ghostIdentity.color}; font-size:18px;"></i>`;
        avatarStyle = `background: #000; border: 1px solid ${ghostIdentity.color}; display:grid; place-items:center; box-shadow: 0 0 5px ${ghostIdentity.color}40;`;
        nameColorStyle = `color: ${ghostIdentity.color} !important; text-shadow: 0 0 5px ${ghostIdentity.color}40;`;
        clickAction = "showToast('â›” Ù‡ÙˆÙŠØ© Ù…Ø­Ù…ÙŠØ©')";
    } else {
        avatarStyle = displayPic ? 
            `background: url('${displayPic}') center/cover no-repeat; border: 1px solid var(--border-color);` : 
            `background: ${generateColor(uidSafe)}; border: 1px solid var(--border-color); display:grid; place-items:center;`;
    }

    let timeString = c.createdAt ? moment(c.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†';
   
   const verifiedIcon = getBadge(c.isVerified, c.isGhost);

   
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠ
    const el = document.createElement('div');
    el.className = 'comment-item';
    el.id = `comment-${c.id}`;

    // ---------------------------------------------------------
    // 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events) - Ù…Ø´ØªØ±Ùƒ Ù„Ù„ÙƒÙ„
    // ---------------------------------------------------------
    
    // Ø£) Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø© (Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©)
    el.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openCommentOptions(c), 600); });
    el.addEventListener('touchend', () => clearTimeout(pressTimer));
    el.addEventListener('touchmove', () => clearTimeout(pressTimer));

    // Ø¨) Ø¶ØºØ·Ø© Ù…Ø²Ø¯ÙˆØ¬Ø© (Ù„Ù„Ø§ÙŠÙƒ)
    let lastTap = 0;
    el.addEventListener('touchend', function(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0 && !e.target.closest('.cm-action') && !e.target.closest('.play-btn')) {
            e.preventDefault();
            toggleCommentLike(c.id);
            // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚Ù„Ø¨
            const heartContainer = c.isGift ? el.querySelector('.gift-body') : el.querySelector('.cm-bubble');
            if(heartContainer) {
                const heart = document.createElement('i');
                heart.className = 'fa-solid fa-heart';
                heart.style.cssText = `position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0); font-size: 40px; color: #ff3b30; pointer-events: none; z-index: 100; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); transition: transform 0.3s;`;
                heartContainer.appendChild(heart);
                setTimeout(() => heart.style.transform = 'translate(-50%, -50%) scale(1.5)', 50);
                setTimeout(() => { heart.style.opacity = '0'; setTimeout(() => heart.remove(), 300); }, 600);
            }
            if(navigator.vibrate) navigator.vibrate(50);
        }
        lastTap = currentTime;
    });

    // Ø¬) Ø¶ØºØ·Ø© Ø¹Ø§Ø¯ÙŠØ© (Ù„Ù„Ø±Ø¯ÙˆØ¯)
    el.onclick = (e) => { 
        if (!e.target.classList.contains('cm-action') && 
            !e.target.closest('.play-btn') && 
            !e.target.closest('.vid-btn') && 
            !e.target.closest('.cm-media-img') &&
            !e.target.closest('.read-more-btn') && 
            !e.target.closest('.custom-video-container')) {
            
            openRepliesSheet(
                c.id, c.uid, c.name, c.pic, c.isVerified, 
                c.text, c.isGhost, c.isAudio, c.duration
            ); 
        }
    };

    // ---------------------------------------------------------
    // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ HTML Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (Ù‡Ø¯ÙŠØ© VS Ø¹Ø§Ø¯ÙŠ)
    // ---------------------------------------------------------

    // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ù‡Ø¯ÙŠØ© (Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯) ğŸ”¥ğŸ”¥ğŸ”¥
    if (c.isGift) {
        // Ù†ØºÙŠØ± ÙƒÙ„Ø§Ø³ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ù†Ø¸Ø¨Ø· Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        el.className = 'comment-item gift-wrapper-pro';

        el.innerHTML = `
            <div class="cm-avatar" style="${avatarStyle}; width:35px; height:35px; border: 2px solid #FFD700; box-shadow:0 0 10px rgba(255,215,0,0.3);" onclick="${clickAction}">${avatarContent}</div>
            
            <div class="gift-body">
                <div class="gift-hero-icon">${c.giftEmoji || 'ğŸ'}</div>
                
                <div class="gift-gold-badge">
                     Ø£Ø±Ø³Ù„ ${c.giftName || 'Ù‡Ø¯ÙŠØ©'}
                </div>

                <div class="gift-meta">
                    <span style="color:#FFD700">${displayName}</span> â€¢ ${timeString} â€¢ 
              <span class="cm-action" style="color:#fff; cursor:pointer;" onclick="event.stopPropagation(); openRepliesSheet({
    id: '${c.id}', 
    uid: '${c.uid}', 
    name: '${displayName}', 
    pic: '${displayPic}', 
    isVerified: ${c.isVerified||false}, 
    text: '${(c.text||"").replace(/'/g, "\\'")}', 
    isGift: true,
    giftEmoji: '${c.giftEmoji}',
    giftName: '${c.giftName}'
})">Ø±Ø¯</span>

                </div>
            </div>
        `;
    } 
    
    // ğŸ”µğŸ”µğŸ”µ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ØªØ¹Ù„ÙŠÙ‚ Ø¹Ø§Ø¯ÙŠ (Ù†ØµØŒ ØµÙˆØªØŒ ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆ) ğŸ”µğŸ”µğŸ”µ
    else {
        // ØªØ¬Ù‡ÙŠØ² ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
        let hash = 0; 
        if(c.uid) { for (let i = 0; i < c.uid.length; i++) hash = c.uid.charCodeAt(i) + ((hash << 5) - hash); }
        const colorClass = `color-${Math.abs(hash) % 10}`;
        const isPostOwner = (c.uid === currentPostOwnerUid);
        
        let bubbleClass = `cm-bubble colored-comment ${colorClass}`;
        if (isPostOwner) bubbleClass += ' owner-bubble';
        if (c.isSticker) bubbleClass += " sticker-comment"; 

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
        let contentHtml = "";

        if (c.isAudio) {
            contentHtml = `
            <div class="custom-audio-player" id="player_${c.id}" onclick="event.stopPropagation()">
                <button class="play-btn" id="btn_${c.id}" onclick="toggleAudio('${c.id}', event)"><i class="fa-solid fa-play"></i></button>
                <input type="range" class="audio-slider" id="range_${c.id}" value="0" oninput="seekAudio('${c.id}', event)">
                <span id="dur_${c.id}" class="audio-time">${c.duration || '00:00'}</span>
                <audio id="audio_${c.id}" src="${c.text}" preload="metadata" ontimeupdate="updateAudioProgress('${c.id}')" onended="resetAudio('${c.id}')"></audio>
            </div>`;
        } 
        else if (c.isImage) {
            contentHtml = `<div class="cm-media-wrapper"><img src="${c.text}" class="cm-media-img" loading="lazy" onclick="viewImageWithSave('${c.text}')"></div>`;
        } 
        else if (c.isVideo) {
            contentHtml = `
            <div class="cm-media-wrapper">
                <div class="custom-video-container" id="vid_cont_${c.id}" onclick="toggleCommentVideo('${c.id}')">
                    <video src="${c.text}" id="vid_${c.id}" class="custom-video-element" loop playsinline preload="metadata"></video>
                    <div class="vid-center-play" id="play_icon_${c.id}"><i class="fa-solid fa-play"></i></div>
                    <div class="vid-controls">
                        <div class="vid-btn" onclick="toggleCommentMute('${c.id}', event)"><i class="fa-solid fa-volume-xmark" id="mute_icon_${c.id}"></i></div>
                        <div class="vid-btn vid-speed-btn" id="speed_btn_${c.id}" onclick="changeVideoSpeed('${c.id}', event)">1x</div>
                        <div class="vid-btn" onclick="toggleCommentFullscreen('${c.id}', event)"><i class="fa-solid fa-expand"></i></div>
                    </div>
                </div>
            </div>`;
        } 
        else {
            // Ù†Øµ Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ Ø³ØªÙŠÙƒØ±
            let displayText = c.text || "";
            if (!c.isSticker && c.replyToUid && c.replyToName && displayText.startsWith(c.replyToName)) {
                const cleanText = displayText.substring(c.replyToName.length);
                displayText = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${c.replyToUid}'">${c.replyToName}</span> <span style="color:inherit">${cleanText}</span>`;
            }
            
            let extraClass = ""; let btnHtml = "";
            if (!c.isSticker && (c.text || "").length > 150) {
                extraClass = "collapsed";
                btnHtml = `<span class="read-more-btn" onclick="toggleReadMore(this)">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯... ğŸ‘‡</span>`;
            }
            contentHtml = `<div class="cm-text ${extraClass}" style="${c.isSticker ? 'font-size:45px' : ''}">${displayText}</div>${btnHtml}`;
        }

        // Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        el.innerHTML = `
            <div class="cm-avatar" style="${avatarStyle}" onclick="${clickAction}">${avatarContent}</div>
            <div class="cm-content">
                <div class="${bubbleClass}"> 
                    <div class="cm-username" style="${nameColorStyle}">
                        ${displayName} ${verifiedIcon}
                        ${isPostOwner && !c.isGhost ? '<span class="owner-badge">Ù…Ø¤Ù„Ù</span>' : ''} 
                    </div>
                    ${contentHtml}
                </div>
                <div class="cm-meta-row">
                    <span>${timeString}</span>
                    <span class="cm-action" onclick="event.stopPropagation(); openRepliesSheet({
    id: '${c.id}', 
    uid: '${c.uid}', 
    name: '${displayName}', 
    pic: '${displayPic}', 
    isVerified: ${c.isVerified||false}, 
    text: '${(c.text || "").replace(/'/g, "\\'")}', 
    isGhost: ${c.isGhost||false}, 
    isAudio: ${c.isAudio||false}, 
    duration: '${c.duration||"00:00"}',
    isImage: ${c.isImage||false},
    isVideo: ${c.isVideo||false}
})">Ø±Ø¯</span>
                </div>
            </div>
        `;
    }

    // ØªØ´ØºÙŠÙ„ Ù„Ù…Ø¨Ø© Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ù…Ø´ØªØ±Ùƒ)
    setTimeout(() => {
        if(!c.isGhost && typeof checkAndColorAvatar === 'function') checkAndColorAvatar(c.uid, el.querySelector('.cm-avatar'));
    }, 0);

    return el;
}


        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¯ÙˆÙ† Ø­Ø°Ù...
        function handleInputTyping(textarea) {
            const actionBtn = document.getElementById('dynamicActionBtn');
            const micIcon = document.getElementById('mainMicIcon');
            const sendIcon = document.getElementById('mainSendIcon');
            
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';

            if (textarea.value.trim().length > 0) {
                micIcon.style.display = 'none';
                sendIcon.style.display = 'block';
                actionBtn.classList.remove('mic-mode');
                actionBtn.classList.add('send-mode');
                actionBtn.onclick = function() { handleCommentAction(); };
            } else {
                micIcon.style.display = 'block';
                sendIcon.style.display = 'none';
                actionBtn.classList.add('mic-mode');
                actionBtn.classList.remove('send-mode');
                actionBtn.onclick = function() { toggleRecording(); };
                textarea.style.height = '45px';
            }
        }

        function resetCommentInput() {
            const inp = document.getElementById('cmInput');
            if(inp) {
                inp.value = ""; 
                handleInputTyping(inp);
            }
            isEditingComment = false;
        }

        async function toggleRecording() {
            if(isRecording) { stopAndSendRecording(); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                document.getElementById("normalModeUI").style.display = "none";
                document.getElementById("recordingModeUI").style.display = "flex";
                let seconds = 0;
                document.getElementById("recordTimer").innerText = "00:00";
                recordInterval = setInterval(() => {
                    seconds++;
                    const m = Math.floor(seconds/60).toString().padStart(2,'0');
                    const s = (seconds%60).toString().padStart(2,'0');
                    document.getElementById("recordTimer").innerText = `${m}:${s}`;
                }, 1000);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
                isRecording = true;
                if(navigator.vibrate) navigator.vibrate(50);
            } catch(e) {
                showToast("âš ï¸ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­");
                console.error(e);
            }
        }

        function cancelRecording() {
            if(mediaRecorder) mediaRecorder.stop();
            clearInterval(recordInterval);
            isRecording = false;
            audioChunks = [];
            resetUI();
        }

 async function stopAndSendRecording() {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        resetUI();
        return;
    }

    mediaRecorder.stop(); // ÙˆÙ‚Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„

    mediaRecorder.onstop = async () => {
        resetUI(); // Ø±Ø¬Ø¹ Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± Ø·Ø¨ÙŠØ¹ÙŠ

        if (audioChunks.length === 0) {
            showToast("âš ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙØ§Ø±Øº");
            return;
        }

        // 1. ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù Ø§Ù„ØµÙˆØª
        let mimeType = 'audio/webm';
        if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
        
        const audioBlob = new Blob(audioChunks, { type: mimeType });
        const ext = mimeType.includes('mp4') ? 'm4a' : 'webm';
        
        // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… currentOpenVideoId Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† currentPostId
        const voicePath = `comments_media_v2/${currentOpenVideoId}/voices/${Date.now()}_${currentUser.uid}.${ext}`; 
        const ref = storage.ref().child(voicePath);

        showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØµÙˆØªÙŠ... ğŸ™ï¸");

        try {
            // 3. Ø§Ù„Ø±ÙØ¹
            const snapshot = await ref.put(audioBlob);
            const url = await snapshot.ref.getDownloadURL();
            
            // 4. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const uDoc = await db.collection('users').doc(currentUser.uid).get();
            const uData = uDoc.data();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¹Ø±Ø¶)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø£Ù† Ù…ØªØºÙŠØ± recordSeconds Ù…Ø¹Ø±Ù Ù„Ø¯ÙŠÙƒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø£Ø®Ø±Ù‰
            // Ù‡Ù†Ø§ Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø±
            const durationTxt = document.getElementById("recordTimer").innerText; 

            // 5. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… currentOpenVideoId
            await db.collection('posts').doc(currentOpenVideoId).collection('comments').add({
                uid: currentUser.uid,
                name: uData.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                pic: uData.profilePic || "",
                isVerified: uData.isVerified || false,
                text: url,          
                isAudio: true,      
                duration: durationTxt, 
                isGhost: (typeof isGhost !== 'undefined' ? isGhost : false),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            await db.collection('posts').doc(currentOpenVideoId).update({
                commentsCount: firebase.firestore.FieldValue.increment(1)
            });

            // Ø¥Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            if (typeof currentPostOwnerUid !== 'undefined' && currentPostOwnerUid !== currentUser.uid) {
                // ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© pushNotification Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ø¯ÙŠÙƒ
                // pushNotification(currentPostOwnerUid, 'comment', 'Ø£Ø±Ø³Ù„ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹ ØµÙˆØªÙŠØ§Ù‹ ğŸ™ï¸', null, currentOpenVideoId);
            }

            showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
            // playSound('sent'); // ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ù…ÙˆØ¬ÙˆØ¯Ø©

        } catch(e) {
            console.error(e);
            showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + e.message);
        }
    };
}

        function resetUI() {
            document.getElementById("recordingModeUI").style.display = "none";
            document.getElementById("normalModeUI").style.display = "flex";
            isRecording = false;
        }

        async function handleCommentAction(stickerContent = null, isSticker = false, giftData = null) {
    const inp = document.getElementById('cmInput');
    const txt = stickerContent || inp.value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰
    if(!txt && !isSticker && !giftData) return;

    // 1. ØªÙØ±ÙŠØº Ø§Ù„Ø®Ø§Ù†Ø© (Ù…Ø³Ø­ Ø§Ù„Ù†Øµ)
    inp.value = "";
    
    // ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ Ù‡Ù†Ø§ ğŸ”¥ğŸ”¥
    // Ø¨Ù†Ø³ØªØ¯Ø¹ÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ØªØ§Ù†ÙŠ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø¥Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙØ§Ø¶ÙŠ ÙØªÙ‚ÙˆÙ… Ù…ØµØºØ±Ø§Ù‡ ÙˆÙ…Ø±Ø¬Ø¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    handleInputTyping(inp); 
    
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ´ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù…Ù† Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (ÙŠÙ†Ø²Ù„ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
    // inp.blur(); 

    if(typeof playSound === 'function') playSound('sent'); 

    try {
        const uDoc = await db.collection('users').doc(currentUser.uid).get();
        const uData = uDoc.data();

        const commentData = {
            uid: currentUser.uid,
            name: uData.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            pic: uData.profilePic || "",
            isVerified: uData.isVerified || false,
            text: txt,
            isSticker: isSticker,
            isGift: !!giftData, 
            giftEmoji: giftData ? giftData.emoji : null,
            giftName: giftData ? giftData.name : null,
            giftEffect: giftData ? giftData.effect : null,
            isGhost: (typeof isGhost !== 'undefined' ? isGhost : false),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('posts').doc(currentOpenVideoId).collection('comments').add(commentData);

        await db.collection('posts').doc(currentOpenVideoId).update({
            commentsCount: firebase.firestore.FieldValue.increment(1)
        });

    } catch (e) {
        console.error("Error sending comment:", e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.message);
    }
}

const GiftSystem = {
    // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    data: {
        gifts: [
            { name: 'ØªØ§Ø¬', emoji: 'ğŸ‘‘', price: 1000, effect: 'rain' },
            { name: 'Ø£Ù„Ù…Ø§Ø³', emoji: 'ğŸ’', price: 500, effect: 'sparkle' },
            { name: 'Ø³ÙŠØ§Ø±Ø©', emoji: 'ğŸï¸', price: 2000, effect: 'slide' },
            { name: 'ÙˆØ±Ø¯Ø©', emoji: 'ğŸŒ¹', price: 50, effect: 'float' },
            { name: 'Ù‚Ù„Ø¨', emoji: 'â¤ï¸', price: 10, effect: 'pulse' },
            { name: 'Ø´Ø¹Ù„Ø©', emoji: 'ğŸ”¥', price: 100, effect: 'burn' }
        ],
        stickers: ['ğŸ˜€','ğŸ˜‚','ğŸ˜','ğŸ˜','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰','ğŸ‘€','ğŸ‘»']
    },

    targetType: 'comment', 

    // 2. Ø§Ù„ÙØªØ­ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    open: function() {
        this.targetType = 'comment';
        this._showSheet();
    },

    // 3. Ø§Ù„ÙØªØ­ Ù„Ù„Ø±Ø¯ÙˆØ¯
    openForReply: function() {
        this.targetType = 'reply';
        this._showSheet();
    },

    // ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ©) ğŸ”¥ğŸ”¥
    _showSheet: function() {
        const giftSheet = document.getElementById('giftSheet');
        const backdrop = document.getElementById('giftBackdrop'); // Ø¯Ù‡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        
        // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        giftSheet.classList.add('active');
        
        // Ø±ÙØ¹ Ø§Ù„Ø·Ø¨Ù‚Ø© ÙÙˆÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        giftSheet.style.zIndex = '300'; 

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© (Ø¹Ø´Ø§Ù† Ù†Ù‚ÙÙ„ Ù„Ù…Ø§ Ù†Ø¶ØºØ· Ø¨Ø±Ù‡)
        if(backdrop) backdrop.classList.add('active');

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        this.switch('gifts', document.querySelector('.gift-tab'));
    },

    switch: function(type, el) {
        document.querySelectorAll('.gift-tab').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');
        
        const container = document.getElementById('giftSystemContent');
        
        if(type === 'gifts') {
            let html = '<div class="premium-gift-grid">';
            this.data.gifts.forEach(g => {
                html += `
                <div class="premium-gift-card" onclick="GiftSystem.send('${g.emoji}', '${g.name}', '${g.effect}')">
                    <div class="pg-emoji">${g.emoji}</div>
                    <div class="pg-name">${g.name}</div>
                    <div class="pg-price">${g.price}</div>
                </div>`;
            });
            container.innerHTML = html + '</div>';
        } 
        else {
            let html = '<div class="stickers-grid">';
            this.data.stickers.forEach(s => {
                html += `<div class="sticker-option" onclick="GiftSystem.sendSticker('${s}')">${s}</div>`;
            });
            container.innerHTML = html + '</div>';
            sendNotification(currentPostOwnerUid, 'gift', `Ø£Ø±Ø³Ù„ Ù„Ùƒ Ù‡Ø¯ÙŠØ© (${name}) ğŸ`, currentOpenVideoId);

        }
    },

    send: function(emoji, name, effect) {
        const giftData = { emoji: emoji, name: name, effect: effect };
        
        if (this.targetType === 'reply') {
            sendReplyToComment(`Ø£Ø±Ø³Ù„ ${name} ${emoji}`, false, giftData);
        } else {
            handleCommentAction(`Ø£Ø±Ø³Ù„ ${name} ${emoji}`, false, giftData);
        }
        
        this.playEffect(emoji, effect);
        showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${name} Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰`);
        
        // Ù‡Ù†Ø§ Ù…Ø´ Ø¨Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ÙŠÙˆØ²Ø± ÙŠØ¨Ø¹Øª Ø¨Ø±Ø§Ø­ØªÙ‡
    },

    sendSticker: function(stickerEmoji) {
        if (this.targetType === 'reply') {
            sendReplyToComment(stickerEmoji, true); 
        } else {
            handleCommentAction(stickerEmoji, true);
        }
        // Ù‡Ù†Ø§ Ø¨Ù†Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ØªÙŠÙƒØ±
        this.closeGiftOnly(); 
    },

    playEffect: function(emoji, type) {
        const overlay = document.body;
        if(!overlay) return;
        const count = 30;
        for(let i=0; i<count; i++) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'fixed';
            el.style.left = Math.random() * 100 + '%';
            el.style.top = -50 + 'px';
            el.style.fontSize = (Math.random() * 30 + 20) + 'px';
            el.style.transition = `top ${Math.random() * 2 + 1.5}s ease-in, opacity 1s`;
            el.style.zIndex = "99999";
            el.style.pointerEvents = "none";
            overlay.appendChild(el);
            setTimeout(() => {
                el.style.top = (window.innerHeight + 100) + 'px';
                el.style.opacity = 0;
            }, 50);
            setTimeout(() => el.remove(), 4000);
        }
    },

    // ğŸ”¥ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ù„ÙÙŠØ©) ğŸ”¥ğŸ”¥
    closeGiftOnly: function() {
        document.getElementById('giftSheet').classList.remove('active');
        
        // Ù†Ø®ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ÙØ§ÙØ© ÙƒÙ…Ø§Ù†
        const backdrop = document.getElementById('giftBackdrop');
        if(backdrop) backdrop.classList.remove('active');
        // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²:
sendNotification(currentPostOwnerUid, 'comment', 'Ø¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ùƒ: ' + txt.substring(0, 20) + '...', currentOpenVideoId);

    }
};




        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ---
        function openCommentOptions(commentData) {
    if(navigator.vibrate) navigator.vibrate(50);
    selectedComment = commentData;
    
    // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    document.querySelectorAll('.cm-bubble').forEach(b => b.classList.remove('highlight'));
    const bubble = document.getElementById(`comment-${commentData.id}`).querySelector('.cm-bubble');
    if(bubble) bubble.classList.add('highlight');

    const isMyComment = (commentData.uid === currentUser.uid);
    const isPostOwner = (currentPostOwnerUid === currentUser.uid); // ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const ownerMenu = document.getElementById('cmOwnerOptionsNew');
    const viewerMenu = document.getElementById('cmViewerOptionsNew');

    if (isMyComment) {
        ownerMenu.style.display = 'flex';
        viewerMenu.style.display = 'none';
    } else {
        ownerMenu.style.display = 'none';
        viewerMenu.style.display = 'flex';
        
        // Ù„Ùˆ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ø¨ÙˆØ³ØªØŒ Ø£Ù‚Ø¯Ø± Ø£Ù…Ø³Ø­ Ø£ÙŠ ÙƒÙˆÙ…Ù†Øª (Ù…ÙŠØ²Ø© Ø¥Ø¶Ø§ÙÙŠØ©)
        // Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ùˆ Ø­Ø§Ø¨Ø¨
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©
    document.getElementById('commentOptionsSheetNew').classList.add('active');
    document.getElementById('optionsBackdrop').style.display = 'block';
}

function closeFloatingMenu() {
    document.getElementById('commentOptionsSheetNew').classList.remove('active');
    document.getElementById('optionsBackdrop').style.display = 'none';
}


        /* --- ØªØµØ­ÙŠØ­ Ø£Ø²Ø±Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø¹Ø´Ø§Ù† ØªÙ‚ÙÙ„ Ù„Ù…Ø§ ØªØ¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§) --- */

// 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ­Ø­Ø©
function triggerEditComment() {
    // Ø£ÙˆÙ„ Ø­Ø§Ø¬Ø©: Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ÙŠ ÙÙŠ ÙˆØ´Ùƒ
    closeFloatingMenu(); 

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯: Ø­Ø· Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØ¬Ù‡Ø²Ù‡ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    const inp = document.getElementById('cmInput');
    if(inp && selectedComment) {
        inp.value = selectedComment.text; 
        inp.focus();
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±Ø§Ø± (Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
        handleInputTyping(inp); 
        
        isEditingComment = true;
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØµØ­Ø­Ø©
function triggerCopyComment() {
    // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
    closeFloatingMenu();

    if(selectedComment) {
        navigator.clipboard.writeText(selectedComment.text);
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ ğŸ“‹");
    }
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØµØ­Ø­Ø©
function triggerDeleteComment() {
    // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
    closeFloatingMenu();

    if(selectedComment) {
        showChicConfirm(
            "Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ", 
            "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.", 
            '<i class="fa-solid fa-trash-can" style="color:var(--danger-color)"></i>', 
            async function() {
                try {
                    await db.collection("posts").doc(currentOpenVideoId)
                        .collection("comments").doc(selectedComment.id).delete();
                        
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    await db.collection("posts").doc(currentOpenVideoId).update({ 
                        commentsCount: firebase.firestore.FieldValue.increment(-1) 
                    });
                    
                    showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸");
                } catch(e) {
                    console.error(e);
                    showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
                }
            }
        );
    }
}

// 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…ØµØ­Ø­Ø© (Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯)
function triggerReplyComment() {
    closeFloatingMenu();
    if(selectedComment) {
        openRepliesSheet(
            selectedComment.id, selectedComment.uid, selectedComment.name, 
            selectedComment.pic, selectedComment.isVerified, selectedComment.text, 
            selectedComment.isGhost, selectedComment.isAudio, selectedComment.duration
        );
    }
}


  function openRepliesSheet(idOrObj, uid, name, pic, isVerified, text, isGhostUser, isAudio, duration, isImage, isVideo, isGift, giftEmoji, giftName) {
    // Ø¯Ø¹Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚ØªÙŠÙ† (Object Ø£Ùˆ Parameters)
    let commentData = {};
    if (typeof idOrObj === 'object') {
        commentData = idOrObj;
    } else {
        // ğŸ”¥ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯ÙŠØ© Ù‡Ù†Ø§
        commentData = { id: idOrObj, uid, name, pic, isVerified, text, isGhost: isGhostUser, isAudio, duration, isImage, isVideo, isGift, giftEmoji, giftName };
    }

    currentParentComment = commentData;
    
    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('repliesSheet').classList.add('active');
    
    // ØªØ¬Ù‡ÙŠØ² Ø¹Ø±Ø¶ "Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£Ø¨" ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    let parentContentHtml = "";
    
    // 1. Ù„Ùˆ Ø§Ù„Ø£Ø¨ Ù‡Ø¯ÙŠØ© ğŸ
    if (commentData.isGift) {
        parentContentHtml = `
        <div class="header-gift-preview">
            <span style="font-size:25px;">${commentData.giftEmoji || 'ğŸ'}</span>
            <span style="color:#FFD700; font-weight:bold; font-size:12px;">Ø£Ø±Ø³Ù„ ${commentData.giftName || 'Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©'}</span>
        </div>`;
    }
    // 2. Ù„Ùˆ ØµÙˆØª
    else if (commentData.isAudio || (typeof commentData.text === 'string' && (commentData.text.includes('.m4a') || commentData.text.includes('.webm')))) {
        parentContentHtml = `
        <div class="custom-audio-player" id="player_parent_${commentData.id}" onclick="event.stopPropagation()" style="width: 100%; margin-top: 5px; transform: scale(0.9); transform-origin: right;">
            <button class="play-btn" id="btn_parent_${commentData.id}" onclick="toggleAudio('parent_${commentData.id}', event)">
                <i class="fa-solid fa-play"></i>
            </button>
            <input type="range" class="audio-slider" id="range_parent_${commentData.id}" value="0" oninput="seekAudio('parent_${commentData.id}', event)">
            <span id="dur_parent_${commentData.id}" class="audio-time">${commentData.duration || '00:00'}</span>
            <audio id="audio_parent_${commentData.id}" src="${commentData.text}" preload="metadata" ontimeupdate="updateAudioProgress('parent_${commentData.id}')" onended="resetAudio('parent_${commentData.id}')"></audio>
        </div>`;
    } 
    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø±ÙˆØ· (ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆØŒ Ù†Øµ) ÙƒÙ…Ø§ Ù‡ÙŠ ...
    else if (commentData.isImage) {
        parentContentHtml = `<div class="cm-media-wrapper" style="max-height: 100px;"><img src="${commentData.text}" class="cm-media-img" onclick="viewImageWithSave('${commentData.text}')"></div>`;
    }
    else if (commentData.isVideo) {
         parentContentHtml = `<div style="font-size:12px; color:#aaa;"><i class="fa-solid fa-video"></i> ÙÙŠØ¯ÙŠÙˆ</div>`;
    }
    else {
        parentContentHtml = `<div style="font-size:14px; color:#ddd; margin-top:5px;">${commentData.text || ''}</div>`;
    }

    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø§Ø±Ø©
    const parentBadge = getBadge(commentData.isVerified, commentData.isGhost);
    
    
    // Ø±Ø³Ù… Ø§Ù„Ù‡ÙŠØ¯Ø±
    const list = document.getElementById('repliesList');
    list.innerHTML = `
        <div style="padding:15px; border-bottom:1px solid #333; background:rgba(255,255,255,0.02)">
            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰:</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="cm-avatar" style="width:35px; height:35px; background-image:url('${commentData.pic||''}'); background-size:cover;"></div>
                
  <div style="font-weight:bold; font-size:13px; color:#fff;">
        ${commentData.name} ${parentBadge}
    </div>

            </div>
        </div>
        <div id="actualReplies"></div>`;
        
    loadRealtimeReplies(commentData.id);
}

        function loadRealtimeReplies(commentId) {
    const container = document.getElementById('actualReplies');
    if(replyListener) replyListener();

    replyListener = db.collection("posts").doc(currentOpenVideoId)
    .collection("comments").doc(commentId)
    .collection("replies").orderBy("createdAt", "asc")
    .onSnapshot(snap => {
        container.innerHTML = "";
        
        let participants = [currentParentComment.uid];

        snap.forEach((doc, index) => {
            if (blockedUsersSet.has(data.uid)) {
        return; 
    }

            const r = {id: doc.id, ...doc.data()};
            
            // 1. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let displayName = r.name, displayPic = r.pic;
            let avatarStyle = "";
            let nameStyle = "";

            if(r.isGhost) {
                const g = getGhostIdentity(r.uid);
                displayName = `Ù…Ø³ØªØ®Ø¯Ù… #${g.id}`; displayPic = "";
                avatarStyle = `background:#000; border:1px solid ${g.color}; display:grid; place-items:center;`;
                nameStyle = `color:${g.color} !important;`;
            } else {
                avatarStyle = displayPic ? `background-image:url('${displayPic}')` : `background:${generateColor(r.uid)}`;
            }

            // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶) - ØªØ¹Ø±ÙŠÙ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù‡Ù†Ø§
            const badgeHTML = getBadge(r.isVerified, r.isGhost);

            // 3. ØªØ¬Ù‡ÙŠØ² Ø´Ø¬Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯
            let userIndex = participants.indexOf(r.uid);
            if (userIndex === -1) { participants.push(r.uid); userIndex = participants.length - 1; }
            const colorClass = `color-${userIndex % 10}`;
            
            const isLast = index === snap.size - 1;
            const treeLineStyle = isLast ? "height: 25px;" : "bottom: -15px;";

            // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù‡Ø¯ÙŠØ© / ØµÙˆØª / ØµÙˆØ±Ø© / ÙÙŠØ¯ÙŠÙˆ / Ù†Øµ)
            let contentHtml = "";

            if (r.isGift) {
                contentHtml = `
                <div class="reply-gift-container">
                    <div class="gift-body" style="align-items: flex-start;">
                        <div class="gift-hero-icon" style="font-size: 60px;">${r.giftEmoji || 'ğŸ'}</div>
                        <div class="gift-gold-badge" style="margin-top: -5px; font-size: 9px; padding: 2px 10px;">
                             Ø£Ø±Ø³Ù„ ${r.giftName || 'Ù‡Ø¯ÙŠØ©'}
                        </div>
                    </div>
                </div>`;
            }
            else if (r.isAudio || (typeof r.text === 'string' && (r.text.includes('.m4a') || r.text.includes('.webm') || r.text.includes('.mp3')))) {
                contentHtml = `
                <div class="custom-audio-player" id="player_${r.id}" onclick="event.stopPropagation()" style="width: 200px !important; margin-top:5px;">
                    <button class="play-btn" id="btn_${r.id}" onclick="toggleAudio('${r.id}', event)"><i class="fa-solid fa-play"></i></button>
                    <input type="range" class="audio-slider" id="range_${r.id}" value="0" oninput="seekAudio('${r.id}', event)">
                    <span id="dur_${r.id}" class="audio-time">${r.duration || '00:00'}</span>
                    <audio id="audio_${r.id}" src="${r.text}" preload="metadata" ontimeupdate="updateAudioProgress('${r.id}')" onended="resetAudio('${r.id}')"></audio>
                </div>`;
            }
            else if (r.isImage) {
                contentHtml = `<div class="cm-media-wrapper" style="max-width: 180px;"><img src="${r.text}" class="cm-media-img" onclick="viewImageWithSave('${r.text}')"></div>`;
            }
            else if (r.isVideo) {
                contentHtml = `
                <div class="cm-media-wrapper" style="max-width: 200px;">
                    <div class="custom-video-container" id="vid_cont_${r.id}" onclick="toggleCommentVideo('${r.id}')">
                        <video src="${r.text}" id="vid_${r.id}" class="custom-video-element"></video>
                        <div class="vid-center-play" id="play_icon_${r.id}"><i class="fa-solid fa-play"></i></div>
                        <div class="vid-controls">
                            <div class="vid-btn" onclick="toggleCommentMute('${r.id}', event)"><i class="fa-solid fa-volume-xmark" id="mute_icon_${r.id}"></i></div>
                            <div class="vid-btn" onclick="toggleCommentFullscreen('${r.id}', event)"><i class="fa-solid fa-expand"></i></div>
                        </div>
                    </div>
                </div>`;
            }
            else {
                let displayText = r.text;
                if (!r.isSticker && r.replyToUid && r.replyToName && displayText.startsWith(r.replyToName)) {
                    const cleanText = displayText.substring(r.replyToName.length);
                    displayText = `<span class="reply-mention-link" onclick="event.stopPropagation(); location.href='profile.html?uid=${r.replyToUid}'">${r.replyToName}</span> ${cleanText}`;
                }
                contentHtml = `<div class="${r.isSticker ? '' : 'cm-text'}" style="${r.isSticker?'font-size:40px':''}">${displayText}</div>`;
            }

            // 5. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
            let bubbleWrapperStart = "";
            let bubbleWrapperEnd = `</div>`;

            if (r.isGift) {
                bubbleWrapperStart = `<div class="" style="margin-top:5px;">`; 
            } else {
                let bubbleClasses = `cm-bubble colored-reply ${colorClass}`;
                if (r.isSticker) bubbleClasses += " sticker-comment";
                bubbleWrapperStart = `<div class="${bubbleClasses}">`;
            }

            // 6. Ø±Ø³Ù… Ø§Ù„Ø±Ø¯
            const replyWrapper = document.createElement('div');
            replyWrapper.style.cssText = "position:relative; margin-right:25px; margin-bottom:15px; margin-top:10px;";
            
            replyWrapper.addEventListener('touchstart', () => { pressTimer = setTimeout(() => openReplyOptions(r), 600); });
            replyWrapper.addEventListener('touchend', () => clearTimeout(pressTimer));

            replyWrapper.innerHTML = `
                <div class="tree-connector" style="${treeLineStyle}"></div>
                <div class="reply-curve"></div>
                <div style="display:flex; gap:10px; align-items: flex-start;">
                    <div class="cm-avatar" style="width:30px; height:30px; ${avatarStyle}; background-size:cover;">
                        ${r.isGhost ? '<i class="fa-solid fa-user-secret"></i>' : ''}
                    </div>
                    <div class="cm-content">
                        ${bubbleWrapperStart}
                            <div class="cm-username" style="font-size:12px; ${nameStyle}">
                                ${displayName} ${badgeHTML} 
                            </div>
                            ${contentHtml}
                        ${bubbleWrapperEnd}
                        
                        <div class="cm-meta-row" style="margin-right:5px; font-size:10px;">
                            ${!r.isGhost ? `<span class="cm-action" onclick="prepareSubReply('${r.uid}', '${displayName}')">Ø±Ø¯</span>` : ''}
                        </div>
                    </div>
                </div>`;
            container.appendChild(replyWrapper);
        });
    });
}

        function prepareReply(cid, uid, name) {
            openRepliesSheet({id: cid, uid: uid, name: name, text: "..."});
        }

        function prepareSubReply(uid, name) {
            currentSubReplyTarget = { uid: uid, name: name };
            const inp = document.getElementById('replyInput');
            inp.value = name + " "; inp.focus();
        }

 async function sendReplyToComment(stickerContent = null, isSticker = false, giftData = null) {
    const inp = document.getElementById('replyInput');
    let txt = stickerContent || inp.value.trim();
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ùˆ ÙÙŠÙ‡ Ù†ØµØŒ Ø£Ùˆ Ø³ØªÙŠÙƒØ±ØŒ Ø£Ùˆ Ù‡Ø¯ÙŠØ©
    if((!txt && !isSticker && !giftData) || !currentParentComment) return;
    
    if(!isSticker) txt = txt.replace(/^@/, '');

    let replyToUid = null, replyToName = null;
    if (!isSticker && !giftData && currentSubReplyTarget && txt.startsWith(currentSubReplyTarget.name)) {
        replyToUid = currentSubReplyTarget.uid; replyToName = currentSubReplyTarget.name;
    }

    try {
        await db.collection("posts").doc(currentOpenVideoId).collection("comments").doc(currentParentComment.id).collection("replies").add({
            uid: currentUser.uid,
            name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            pic: currentUserData?.profilePic || "", 
            isVerified: currentUserData?.isVerified || false,
            
            text: txt, // Ø³ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ "Ø£Ø±Ø³Ù„ ØªØ§Ø¬" Ù…Ø«Ù„Ø§Ù‹
            
            isSticker: isSticker,
            
            // ğŸ”¥ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø¯ÙŠØ© (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
            isGift: !!giftData,
            giftEmoji: giftData ? giftData.emoji : null,
            giftName: giftData ? giftData.name : null,
            giftEffect: giftData ? giftData.effect : null,

            isGhost: isGhost,
            replyToUid: replyToUid, replyToName: replyToName,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        inp.value = ""; 
        currentSubReplyTarget = null;
        if(typeof playSound === 'function') playSound('sent');

    } catch(e) { console.error(e); }
}


        function openReplyOptions(r) {
            selectedReply = r;
            const isMyReply = (r.uid === currentUser.uid);
            document.getElementById('replyOwnerOptions').style.display = isMyReply ? 'block' : 'none';
            document.getElementById('replyViewerOptions').style.display = isMyReply ? 'none' : 'block';
            if (!isMyReply) document.getElementById('replyToUserBtn').innerHTML = `<i class="fa-solid fa-reply"></i> Ø±Ø¯ Ø¹Ù„Ù‰ ${r.name}`;
            document.getElementById('replyOptionsSheet').classList.add('active');
        }

        function triggerEditReplyAction() { /* ... ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ... */ }
        function triggerDeleteReply() { /* ... ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù ... */ }
        function triggerReplyToUser() { /* ... */ }

        function setupMentionListener(inputId, dropdownId) {
            const inp = document.getElementById(inputId);
            const drop = document.getElementById(dropdownId);
            inp.addEventListener('keyup', async () => {
                const val = inp.value;
                const lastWord = val.split(" ").pop();
                if (lastWord.startsWith('@')) {
                    drop.classList.add('active');
                    drop.innerHTML = '<div style="padding:10px;">Ø¨Ø­Ø«...</div>';
                    const q = lastWord.substring(1);
                    const snap = await db.collection('users').orderBy('name').startAt(q).endAt(q+'\uf8ff').limit(5).get();
                    drop.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const item = document.createElement('div');
                        item.className = 'mention-suggest-item';
                        item.innerText = d.name;
                        item.onclick = () => {
                            inp.value = val.replace(lastWord, d.name + " ");
                            drop.classList.remove('active');
                        };
                        drop.appendChild(item);
                    });
                } else {
                    drop.classList.remove('active');
                }
            });
        }

        function closeAllSheets() {
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            document.getElementById('overlay').style.display = 'none';
            
            document.body.classList.remove('no-scroll'); 

            document.body.classList.remove('no-scroll');
            isEditingComment = false; isEditingReply = false;
            resetCommentInput();
        }

        function showChicConfirm(title, message, iconHTML, callback) {
            document.getElementById('chicTitle').innerText = title;
            document.getElementById('chicMessage').innerText = message;
            document.getElementById('chicIcon').innerHTML = iconHTML;
            document.getElementById('chicConfirmModal').style.display = 'flex';
            document.getElementById('chicConfirmBtn').onclick = () => {
                callback();
                closeChicModal();
            };
        }
        function closeChicModal() { document.getElementById('chicConfirmModal').style.display = 'none'; }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function reportComment() {
    if(!selectedComment) return;
    
    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    openReportMenu(
        'comment', 
        selectedComment.id, 
        selectedComment.uid, 
        selectedComment.text // Ø¯Ù‡ Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¸Ù‡Ø±Ù„Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    );
}

        
        // --- 1. Ø¯Ø§Ù„Ø© ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ---
function expandInputArea() {
    document.querySelector('.input-area-container').classList.add('focused');
    document.getElementById('commentFooter').classList.add('expanded');
}

// --- 2. Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ---
function insertEmoji(emoji) {
    const input = document.getElementById('cmInput');
    input.value += emoji;
    input.focus();
    handleInputTyping(input); // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
}

// --- 3. Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø£Ù‡Ù…) ---
async function uploadCommentMedia(input) {
    const file = input.files[0];
    if (!file) return;

    input.value = ''; // ØªØµÙÙŠØ± Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØ±ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù ØªØ§Ù†ÙŠ

    let fileType = '';
    let folder = '';

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
    if (file.type.startsWith('image/')) {
        fileType = 'image';
        folder = 'images';
        if (file.size > 10 * 1024 * 1024) { showToast("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±"); return; }
    } else if (file.type.startsWith('video/')) {
        fileType = 'video';
        folder = 'videos';
        if (file.size > 50 * 1024 * 1024) { showToast("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨ÙŠØ±"); return; }
    } else {
        showToast("âš ï¸ Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ø¨Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª"); return;
    }

    showToast(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${fileType === 'image' ? 'Ø§Ù„ØµÙˆØ±Ø©' : 'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'}... â³`);

    const safeName = Date.now() + '_' + Math.floor(Math.random() * 10000);
    const extension = file.name.split('.').pop();
    const storagePath = `comments_media_v2/${currentOpenVideoId}/${folder}/${safeName}.${extension}`;
    const storageRef = storage.ref().child(storagePath);
    
    try {
        const snapshot = await storageRef.put(file);
        const url = await snapshot.ref.getDownloadURL();

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await db.collection('posts').doc(currentOpenVideoId).collection('comments').add({
            uid: currentUser.uid,
            name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
            pic: currentUserData?.profilePic || "",
            isVerified: currentUserData?.isVerified || false,
            text: url, 
            isImage: (fileType === 'image'), // Ø¹Ù„Ø§Ù…Ø© Ù„Ù„ØµÙˆØ±Ø©
            isVideo: (fileType === 'video'), // Ø¹Ù„Ø§Ù…Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
            isAudio: false,
            isSticker: false,
            isGhost: isGhost,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
        await db.collection('posts').doc(currentOpenVideoId).update({
            commentsCount: firebase.firestore.FieldValue.increment(1)
        });
        
        showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");

    } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
    }
}

// --- 4. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¹Ø´Ø§Ù† ØªØ®ÙÙŠ Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØ± Ù„Ù…Ø§ ØªÙƒØªØ¨) ---
// (Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© handleInputTyping Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡)
function handleInputTyping(textarea) {
    const actionBtn = document.getElementById('dynamicActionBtn');
    const micIcon = document.getElementById('mainMicIcon');
    const sendIcon = document.getElementById('mainSendIcon');
    const extActions = document.querySelector('.external-actions');
    const footer = document.getElementById('commentFooter'); // Ø§Ù„Ø´Ø±ÙŠØ· ÙƒÙ„Ù‡
    const container = document.querySelector('.input-area-container'); // Ø§Ù„Ø­Ø§ÙˆÙŠØ©

    // Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';

    if (textarea.value.trim().length > 0) {
        // --- ÙˆØ¶Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Expand) ---
        micIcon.style.display = 'none';
        sendIcon.style.display = 'block';
        
        actionBtn.classList.remove('mic-mode');
        actionBtn.classList.add('send-mode');
        actionBtn.onclick = function() { handleCommentAction(); };
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        if(extActions) extActions.style.display = 'none'; 
        
    } else {
        // --- ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙƒÙˆÙ† (Reset / Nature) ---
        micIcon.style.display = 'block';
        sendIcon.style.display = 'none';
        
        actionBtn.classList.add('mic-mode');
        actionBtn.classList.remove('send-mode');
        actionBtn.onclick = function() { toggleRecording(); };
        
        // ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if(extActions) extActions.style.display = 'flex';
        
        // ğŸ”¥ ØªØµØºÙŠØ± Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù„Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
        textarea.style.height = '45px';

        // Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„ØªÙˆØ³ÙŠØ¹
        if(footer) footer.classList.remove('expanded');
        if(container) container.classList.remove('focused');
    }
}


// --- Ø¯ÙˆØ§Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ---

// 1. ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function toggleCommentVideo(id) {
    const vid = document.getElementById(`vid_${id}`);
    const container = document.getElementById(`vid_cont_${id}`);
    const playIcon = document.getElementById(`play_icon_${id}`);

    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø± Ø´ØºØ§Ù„
    document.querySelectorAll('video').forEach(v => { if(v !== vid) v.pause(); });

    if (vid.paused) {
        vid.play();
        container.classList.add('playing');
        playIcon.style.opacity = '0';
    } else {
        vid.pause();
        container.classList.remove('playing');
        playIcon.style.opacity = '1';
    }
}

// 2. ÙƒØªÙ… Ø§Ù„ØµÙˆØª
function toggleCommentMute(id, e) {
    e.stopPropagation();
    const vid = document.getElementById(`vid_${id}`);
    const icon = document.getElementById(`mute_icon_${id}`);
    vid.muted = !vid.muted;
    icon.className = vid.muted ? "fa-solid fa-volume-xmark" : "fa-solid fa-volume-high";
}

// 3. ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©
/* --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Cinema Mode) --- */

// 1. ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
function toggleCommentFullscreen(id, e) {
    if(e) e.stopPropagation();
    
    const smallVideo = document.getElementById(`vid_${id}`);
    const overlay = document.getElementById('cinemaOverlay');
    const bigVideo = document.getElementById('fsVideoPlayer');
    const bigPlayIcon = document.getElementById('fsPlayIcon');
    const bigSpeedBtn = document.getElementById('fsSpeedBtn');
    
    // Ù†Ù‚Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØµØºÙŠØ± Ù„Ù„ÙƒØ¨ÙŠØ±
    bigVideo.src = smallVideo.src;
    bigVideo.currentTime = smallVideo.currentTime;
    bigVideo.muted = smallVideo.muted;
    bigVideo.playbackRate = smallVideo.playbackRate;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    if(bigSpeedBtn) bigSpeedBtn.innerText = smallVideo.playbackRate + 'x';
    updateFsMuteIcon(bigVideo.muted);

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµØºÙŠØ± ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±
    smallVideo.pause();
    overlay.classList.add('active');
    
    const playPromise = bigVideo.play();
    if (playPromise !== undefined) {
        playPromise.then(() => { bigPlayIcon.style.opacity = '0'; })
                   .catch(() => { bigPlayIcon.style.opacity = '1'; });
    }

    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª (Seeker)
    bigVideo.ontimeupdate = () => {
        const percent = (bigVideo.currentTime / bigVideo.duration) * 100;
        document.getElementById('fsSeeker').value = percent || 0;
    };
}

// 2. Ø¥ØºÙ„Ø§Ù‚ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
function closeCinemaMode() {
    const overlay = document.getElementById('cinemaOverlay');
    const bigVideo = document.getElementById('fsVideoPlayer');
    overlay.classList.remove('active');
    bigVideo.pause();
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù…Ù…ÙƒÙ† ØªØ±Ø¬Ø¹ ØªØ´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØµØºÙŠØ± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù„Ùˆ Ø­Ø§Ø¨Ø¨)
}

// 3. ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ù…Ù† Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„ÙƒØ¨ÙŠØ±
function toggleFsPlay() {
    const v = document.getElementById('fsVideoPlayer');
    const icon = document.getElementById('fsPlayIcon');
    if(v.paused) { v.play(); icon.style.opacity = '0'; }
    else { v.pause(); icon.style.opacity = '1'; }
}

// 4. ÙƒØªÙ… Ø§Ù„ØµÙˆØª
function toggleFsMute() {
    const v = document.getElementById('fsVideoPlayer');
    v.muted = !v.muted;
    updateFsMuteIcon(v.muted);
}

function updateFsMuteIcon(isMuted) {
    const icon = document.getElementById('fsMuteIcon');
    icon.className = isMuted ? "fa-solid fa-volume-xmark" : "fa-solid fa-volume-high";
}

// 5. ØªÙ‚Ø¯ÙŠÙ… ÙˆØªØ£Ø®ÙŠØ±
function seekFsVideo(input) {
    const v = document.getElementById('fsVideoPlayer');
    if(v.duration) v.currentTime = (input.value / 100) * v.duration;
}

// 6. ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ±
function changeFsSpeed(btnElement) {
    const video = document.getElementById('fsVideoPlayer');
    let r = video.playbackRate;
    let newRate = (r === 1.0) ? 1.5 : (r === 1.5) ? 2.0 : 1.0;
    video.playbackRate = newRate;
    btnElement.innerText = newRate + 'x';
}

// 4. ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© (Ø¨Ø³ÙŠØ·)
function viewImageWithSave(url) {
    window.open(url, '_blank');
}

/* --- Ø¯ÙˆØ§Ù„ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙˆØ­ÙØ¸Ù‡Ø§ --- */
function viewImageWithSave(url) {
    const lb = document.getElementById('imgLightbox');
    const img = document.getElementById('lbImage');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø²Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
    const oldBtn = document.getElementById('lbSaveBtn');
    if(oldBtn) oldBtn.remove();

    // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø§Ù„Ø­ÙØ¸
    const saveBtn = document.createElement('div');
    saveBtn.id = 'lbSaveBtn';
    saveBtn.className = 'lb-save-btn';
    saveBtn.innerHTML = `<i class="fa-solid fa-download"></i> Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©`;
    saveBtn.onclick = (e) => { e.stopPropagation(); saveImageAction(url); };
    
    lb.appendChild(saveBtn);
    img.src = url;
    lb.style.display = 'flex';
    setTimeout(() => lb.classList.add('active'), 10);
}

function closeLightbox() {
    const lb = document.getElementById('imgLightbox');
    lb.classList.remove('active');
    setTimeout(() => { lb.style.display = 'none'; document.getElementById('lbImage').src = ''; }, 300);
}

function saveImageAction(url) {
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸... ğŸ–¼ï¸");
    const link = document.createElement('a');
    link.href = url;
    link.download = `Wareed_IMG_${Date.now()}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/* --- Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø³Ø±Ø¹Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ --- */
function changeVideoSpeed(id, e) {
    e.stopPropagation();
    const video = document.getElementById(`vid_${id}`);
    const btn = document.getElementById(`speed_btn_${id}`);
    
    let current = video.playbackRate;
    let newRate = (current === 1.0) ? 1.5 : (current === 1.5) ? 2.0 : 1.0;
    
    video.playbackRate = newRate;
    btn.innerText = newRate + 'x';
}

function toggleReadMore(btn) {
    const textDiv = btn.previousElementSibling; // Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø²Ø±Ø§Ø±
    if (textDiv.classList.contains('collapsed')) {
        textDiv.classList.remove('collapsed'); // ØªÙˆØ³ÙŠØ¹
        textDiv.style.maskImage = 'none';
        textDiv.style.webkitMaskImage = 'none';
        btn.innerText = 'Ø¹Ø±Ø¶ Ø£Ù‚Ù„';
    } else {
        textDiv.classList.add('collapsed'); // Ø·ÙŠ
        textDiv.style.maskImage = ''; // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªÙ„Ø§Ø´ÙŠ
        textDiv.style.webkitMaskImage = '';
        btn.innerText = 'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯... ğŸ‘‡';
    }
}

/* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Presence System) --- */

// 1. Ø¯Ø§Ù„Ø© Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ§ØªØ­
function checkAndColorAvatar(uid, avatarElement) {
    if (!uid || !avatarElement) return;

    // Ø¨Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    db.collection('users').doc(uid).get().then(doc => {
        if (doc.exists) {
            const data = doc.data();
            if (data.lastSeen) {
                const lastSeen = data.lastSeen.toDate();
                const now = new Date();
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                const diff = (now - lastSeen) / 1000 / 60;
                
                // Ù„Ùˆ ÙƒØ§Ù† ÙØ§ØªØ­ ÙÙŠ Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§ÙŠÙ‚ØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                if (diff < 5) {
                    avatarElement.classList.add('online');
                }
            }
        }
    });
}

// 2. ØªØ­Ø¯ÙŠØ« ØªÙˆØ§Ø¬Ø¯Ùƒ Ø£Ù†Øª (Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„Ù„Ù†Ø§Ø³)
function startPresenceSystem() {
    if (!currentUser) return;

    const updateStatus = () => {
        db.collection('users').doc(currentUser.uid).update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(e => console.log("Presence update ignored")); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµØ§Ù…ØªØ©
    };

    // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    updateStatus();

    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ø·ÙˆÙ„ Ù…Ø§ Ø£Ù†Øª ÙØ§ØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    setInterval(updateStatus, 2 * 60 * 1000);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ø¬ÙˆÙ‡ auth observer Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯)
// Ø£Ùˆ Ø®Ù„ÙŠÙ‡ Ù‡Ù†Ø§ ÙˆÙ‡Ùˆ Ù‡ÙŠØ´ØªØºÙ„ Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„
auth.onAuthStateChanged(user => {
    if (user) startPresenceSystem();
});

/* ==========================================
   ğŸ‘† Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ù„Ù„Ø¥ØºÙ„Ø§Ù‚ (Swipe to Dismiss)
   ========================================== */
/* ==========================================
   ğŸ‘† Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø·ÙˆØ± (Smart Swipe)
   ========================================== */
/* ==========================================
   ğŸ‘† Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø·ÙˆØ± (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±)
   ========================================== */
function initSwipeToClose() {
    const sheets = document.querySelectorAll('.bottom-sheet');
    
    sheets.forEach(sheet => {
        const handle = sheet.querySelector('.sheet-handle');
        // Ù‡Ù†Ø§ Ø¨Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const header = sheet.querySelector('.cm-header') || sheet.querySelector('h3'); 
        
        const attachDrag = (element) => {
            if(!element) return;
            
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            
            element.addEventListener('touchstart', (e) => {
                // ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù‡Ù†Ø§ ğŸ”¥ğŸ”¥
                // Ù„Ùˆ Ø§Ù„Ø¶ØºØ·Ø© Ø¬Øª Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© (i) Ø£Ùˆ Ø²Ø±Ø§Ø±ØŒ Ù†Ø®Ø±Ø¬ Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ ÙÙˆØ±Ø§Ù‹
                if (e.target.tagName === 'I' || e.target.classList.contains('fa-xmark') || e.target.classList.contains('fa-arrow-right')) {
                    return; 
                }

                startY = e.touches[0].clientY;
                isDragging = true;
                sheet.style.transition = 'none';
            }, {passive: false}); // passive: false Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†ØªØ­ÙƒÙ…
            
            element.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const touchY = e.touches[0].clientY;
                const diff = touchY - startY;
                
                // Ø¨Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ù„Ù„Ø£Ø³ÙÙ„
                if (diff > 0) { 
                    if(e.cancelable) e.preventDefault(); // Ù…Ù†Ø¹ Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    currentY = diff;
                    sheet.style.transform = `translateY(${currentY}px)`;
                }
            }, {passive: false});
            
            element.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                sheet.style.transition = 'transform 0.3s cubic-bezier(0.19, 1, 0.22, 1)';
                
                if (currentY > 100) { 
                    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
                    if (sheet.id === 'giftSheet') {
                        if(typeof GiftSystem !== 'undefined') GiftSystem.closeGiftOnly();
                        else sheet.classList.remove('active');
                    } 
                    else if (sheet.id === 'repliesSheet') {
                        closeRepliesSheet(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµØ­ÙŠØ­Ø©
                    } 
                    else {
                        closeAllSheets();
                    }

                    setTimeout(() => { sheet.style.transform = ''; }, 300);
                } else {
                    sheet.style.transform = ''; 
                }
                currentY = 0;
            });
        };

        attachDrag(handle);
        attachDrag(header);
    });
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', initSwipeToClose);
// ÙˆØªØ´ØºÙŠÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ£ÙƒÙŠØ¯ (ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª)
initSwipeToClose();

function handleOverlayClick() {
    const repliesSheet = document.getElementById('repliesSheet');
    
    // ÙØ­Øµ: Ù‡Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†ØŸ
    if (repliesSheet.classList.contains('active')) {
        // Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¨Ø³ (ÙˆØ±Ø¬Ø¹Ù†ÙŠ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª)
        closeRepliesSheet();
    } else {
        // Ù„Ùˆ Ù…Ø´ Ù…ÙØªÙˆØ­Ø©ØŒ ÙŠØ¨Ù‚Ù‰ Ø£ÙƒÙŠØ¯ Ø§Ø­Ù†Ø§ ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ Ø§Ù‚ÙÙ„ ÙƒÙ„Ù‡
        closeAllSheets();
    }
}

/* ==========================================
   ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Repliles Pro Features)
   ========================================== */

// 1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø´ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
function handleReplyTyping(textarea) {
    const actionBtn = document.getElementById('replyDynamicActionBtn');
    const micIcon = document.getElementById('replyMicIcon');
    const sendIcon = document.getElementById('replySendIcon');
    const extActions = document.getElementById('replyExternalActions');

    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';

    if (textarea.value.trim().length > 0) {
        // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        micIcon.style.display = 'none';
        sendIcon.style.display = 'block';
        actionBtn.classList.remove('mic-mode');
        actionBtn.classList.add('send-mode');
        // ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØµÙŠ
        actionBtn.onclick = function() { sendReplyToComment(); };
        
        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§
        if(extActions) {
            extActions.style.maxWidth = '0px';
            extActions.style.opacity = '0';
            extActions.style.margin = '0';
            extActions.style.padding = '0';
        }
    } else {
        // ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§ÙŠÙƒ
        micIcon.style.display = 'block';
        sendIcon.style.display = 'none';
        actionBtn.classList.add('mic-mode');
        actionBtn.classList.remove('send-mode');
        // ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ù„Ù„ØªØ³Ø¬ÙŠÙ„
        actionBtn.onclick = function() { toggleReplyRecording(); };
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if(extActions) {
            extActions.style.maxWidth = '100px'; // Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
            extActions.style.opacity = '1';
            extActions.style.margin = '';
            extActions.style.padding = '';
        }
        textarea.style.height = '45px';
    }
}

function expandReplyInputArea() {
    // Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ Ù‡Ù†Ø§ Ù„Ùˆ Ø¹Ø§ÙŠØ²ÙŠÙ† ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    document.getElementById('replyFooter').classList.add('expanded');
}

// 2. Ø±ÙØ¹ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ (ØµÙˆØ± ÙˆÙÙŠØ¯ÙŠÙˆ)
async function uploadReplyMedia(input) {
    const file = input.files[0];
    if (!file || !currentParentComment) return;

    input.value = ''; // ØªØµÙÙŠØ±

    let fileType = '';
    let isImg = false;
    let isVid = false;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
    if (file.type.startsWith('image/')) {
        fileType = 'image';
        isImg = true;
    } else if (file.type.startsWith('video/')) {
        fileType = 'video';
        isVid = true;
        if (file.size > 50 * 1024 * 1024) { showToast("âš ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹"); return; }
    } else { 
        showToast("âš ï¸ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"); return; 
    }
    
    showToast(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${fileType === 'image' ? 'Ø§Ù„ØµÙˆØ±Ø©' : 'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'} ÙÙŠ Ø§Ù„Ø±Ø¯... â³`);

    const safeName = Date.now() + '_' + Math.floor(Math.random() * 10000);
    const extension = file.name.split('.').pop();
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… currentOpenVideoId Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ NABD Pro
    const storagePath = `replies_media/${currentOpenVideoId}/${currentParentComment.id}/${safeName}.${extension}`;
    
    try {
        const snapshot = await storage.ref().child(storagePath).put(file);
        const url = await snapshot.ref.getDownloadURL();

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await db.collection("posts").doc(currentOpenVideoId)
            .collection("comments").doc(currentParentComment.id)
            .collection("replies").add({
                uid: currentUser.uid,
                name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                pic: currentUserData?.profilePic || "",
                isVerified: currentUserData?.isVerified || false,
                text: url,
                isImage: isImg, // ğŸŸ¢ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
                isVideo: isVid, // ğŸŸ¢ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
                isAudio: false,
                isSticker: false,
                isGhost: isGhost,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ âœ…");

    } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
    }
}

// 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ (Voice Note)
let replyMediaRecorder = null;
let replyAudioChunks = [];
let replyRecordInterval;

async function toggleReplyRecording() {
    if (!currentParentComment) return;
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        replyMediaRecorder = new MediaRecorder(stream);
        replyAudioChunks = [];
        
        document.getElementById("replyNormalModeUI").style.display = "none";
        document.getElementById("replyRecordingModeUI").style.display = "flex";
        
        let seconds = 0;
        document.getElementById("replyRecordTimer").innerText = "00:00";
        
        replyRecordInterval = setInterval(() => {
            seconds++;
            const m = Math.floor(seconds/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            document.getElementById("replyRecordTimer").innerText = `${m}:${s}`;
        }, 1000);
        
        replyMediaRecorder.ondataavailable = e => replyAudioChunks.push(e.data);
        replyMediaRecorder.start();
        if(navigator.vibrate) navigator.vibrate(50);
        
    } catch(e) {
        showToast("âš ï¸ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­");
    }
}

function cancelReplyRecording() {
    if(replyMediaRecorder) replyMediaRecorder.stop();
    clearInterval(replyRecordInterval);
    document.getElementById("replyRecordingModeUI").style.display = "none";
    document.getElementById("replyNormalModeUI").style.display = "flex";
}

function stopAndSendReplyRecording() {
    if(!replyMediaRecorder) return;
    replyMediaRecorder.stop();
    
    replyMediaRecorder.onstop = async () => {
        clearInterval(replyRecordInterval);
        document.getElementById("replyRecordingModeUI").style.display = "none";
        document.getElementById("replyNormalModeUI").style.display = "flex";
        
        if(replyAudioChunks.length === 0) return;
        
        const blob = new Blob(replyAudioChunks, { type: 'audio/webm' });
        const voicePath = `replies_voice/${currentParentComment.id}/${Date.now()}.webm`;
        
        showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª... â³");
        
        try {
            const snapshot = await storage.ref().child(voicePath).put(blob);
            const url = await snapshot.ref.getDownloadURL();
            
            await db.collection("posts").doc(currentOpenVideoId)
                .collection("comments").doc(currentParentComment.id)
                .collection("replies").add({
                    uid: currentUser.uid,
                    name: currentUserData?.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                    pic: currentUserData?.profilePic || "",
                    text: url,
                    isAudio: true,
                    duration: document.getElementById("replyRecordTimer").innerText,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØª âœ…");
            
        } catch(e) {
            showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
        }
    };
}


function handleSmartOverlayClick() {
    const giftSheet = document.getElementById('giftSheet');
    const repliesSheet = document.getElementById('repliesSheet');
    const commentsSheet = document.getElementById('cmSheet');

    // 1. Ù„Ùˆ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§ Ù‡ÙŠ Ø¨Ø³
    if (giftSheet.classList.contains('active')) {
        giftSheet.classList.remove('active');
        return; // ÙˆØ§Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ø´Ø§Ù† Ù…ÙŠÙ‚ÙÙ„Ø´ Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡Ø§
    }

    // 2. Ù„Ùˆ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§Ù‚ÙÙ„Ù‡Ø§ ÙˆØ§Ø±Ø¬Ø¹ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    if (repliesSheet.classList.contains('active')) {
        repliesSheet.classList.remove('active');
        return;
    }

    // 3. Ù„Ùˆ Ù…ÙÙŠØ´ ØºÙŠØ± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ Ø§Ù‚ÙÙ„ ÙƒÙ„Ù‡
    closeAllSheets();
}

// --- Ù…Ù†Ø·Ù‚ Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª (Voice Note Logic) ---

let currentlyPlayingAudio = null; // Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù…ÙŠÙ† Ø´ØºØ§Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠ ÙˆÙ†ÙˆÙ‚ÙÙ‡ Ù„Ùˆ Ø´ØºÙ„Ù†Ø§ ØºÙŠØ±Ù‡
let currentPlayButtonId = null;   // Ø¹Ø´Ø§Ù† Ù†Ø±Ø¬Ø¹ Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ø´ÙƒÙ„Ù‡ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ

function toggleAudio(id, event) {
    if(event) event.stopPropagation(); // Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ù„Ø§ÙŠÙƒ Ø£Ùˆ ÙŠÙØªØ­ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¨Ø§Ù„ØºÙ„Ø·

    const audio = document.getElementById(`audio_${id}`);
    const btnIcon = document.getElementById(`btn_${id}`).querySelector('i');
    const playerContainer = document.getElementById(`player_${id}`);

    // 1. Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØª ØªØ§Ù†ÙŠ Ø´ØºØ§Ù„ØŒ ÙˆÙ‚ÙÙ‡ Ø§Ù„Ø£ÙˆÙ„
    if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
        currentlyPlayingAudio.pause();
        if(currentPlayButtonId) {
            // Ø±Ø¬Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù„ÙŠ ÙØ§Øª Ù„Ù€ "ØªØ´ØºÙŠÙ„"
            const oldBtn = document.getElementById(currentPlayButtonId);
            if(oldBtn) oldBtn.querySelector('i').className = "fa-solid fa-play";
            // Ø´ÙŠÙ„ Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
            const oldContainerId = currentPlayButtonId.replace('btn_', 'player_');
            const oldCont = document.getElementById(oldContainerId);
            if(oldCont) oldCont.classList.remove('playing');
        }
    }

    // 2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (audio.paused) {
        audio.play().then(() => {
            currentlyPlayingAudio = audio;
            currentPlayButtonId = `btn_${id}`;
            btnIcon.className = "fa-solid fa-pause"; // ØºÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù
            playerContainer.classList.add('playing'); // Ø¶ÙŠÙ ØªØ£Ø«ÙŠØ± Ù„Ù„ØªØµÙ…ÙŠÙ…
        }).catch(err => console.error("Audio Play Error:", err));
    } else {
        audio.pause();
        btnIcon.className = "fa-solid fa-play"; // Ø±Ø¬Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„ØªØ´ØºÙŠÙ„
        playerContainer.classList.remove('playing');
        currentlyPlayingAudio = null;
    }
}

function updateAudioProgress(id) {
    const audio = document.getElementById(`audio_${id}`);
    const slider = document.getElementById(`range_${id}`);
    const timer = document.getElementById(`dur_${id}`);
    
    // ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø³Ù„ÙŠÙ…Ø© (Ù…Ø´ NaN)
    if (isNaN(audio.duration)) return;

    // 1. ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„Ø´Ø±ÙŠØ·
    const percentage = (audio.currentTime / audio.duration) * 100;
    slider.value = percentage;
    
    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø´Ø±ÙŠØ· (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ Ø§ØªØ³Ù…Ø¹ Ø¨Ù„ÙˆÙ†ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ù„ÙˆÙ† ØªØ§Ù†ÙŠ)
    slider.style.background = `linear-gradient(to right, var(--primary) ${percentage}%, rgba(255,255,255,0.2) ${percentage}%)`;

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª (ØªÙ†Ø§Ø²Ù„ÙŠ Ø£Ùˆ ØªØµØ§Ø¹Ø¯ÙŠ - Ù‡Ù†Ø§ Ù‡Ù†Ø¹Ù…Ù„Ù‡: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ)
    // Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù„ÙŠ Ù…Ø±: currentTime
    // Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: duration - currentTime
    const timeLeft = audio.duration - audio.currentTime;
    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const s = Math.floor(timeLeft % 60).toString().padStart(2, '0');
    timer.innerText = `${m}:${s}`;
}

function seekAudio(id, event) {
    if(event) event.stopPropagation();
    
    const audio = document.getElementById(`audio_${id}`);
    const slider = document.getElementById(`range_${id}`);
    
    if (audio.duration) {
        const seekTime = (slider.value / 100) * audio.duration;
        audio.currentTime = seekTime;
        updateAudioProgress(id); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø´ÙƒÙ„
    }
}

function resetAudio(id) {
    // Ù„Ù…Ø§ Ø§Ù„ØµÙˆØª ÙŠØ®Ù„Øµ
    const btnIcon = document.getElementById(`btn_${id}`).querySelector('i');
    const slider = document.getElementById(`range_${id}`);
    const playerContainer = document.getElementById(`player_${id}`);
    
    btnIcon.className = "fa-solid fa-play";
    slider.value = 0;
    slider.style.background = `rgba(255,255,255,0.2)`; // ØªØµÙÙŠØ± Ø§Ù„Ù„ÙˆÙ†
    playerContainer.classList.remove('playing');
    
    currentlyPlayingAudio = null;
}

function closeRepliesSheet() {
    // 1. Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯
    const sheet = document.getElementById('repliesSheet');
    if(sheet) sheet.classList.remove('active');
    
    // 2. ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø£Ø¨
    currentParentComment = null;

    // 3. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ ÙÙŠÙ‡ ØµÙˆØª Ø´ØºØ§Ù„ ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ØŒ Ù†ÙˆÙ‚ÙÙ‡
    if(typeof currentlyPlayingAudio !== 'undefined' && currentlyPlayingAudio) {
        currentlyPlayingAudio.pause();
        currentlyPlayingAudio = null;
    }

    // Ù…Ù„Ø­ÙˆØ¸Ø©: Ù…Ø´ Ù‡Ù†Ø´ÙŠÙ„ no-scroll Ù„Ø£Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø³Ù‡ Ù…ÙØªÙˆØ­Ø© ØªØ­ØªÙ‡Ø§
}

function toggleCommentLike(commentId) {
    // Ø¨Ù…Ø§ Ø¥Ù†Ù†Ø§ Ù„Ø³Ù‡ Ù…Ø¹Ù…Ù„Ù†Ø§Ø´ Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø§ÙŠÙƒØ§Øª ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²ØŒ Ù‡Ù†Ø¹Ù…Ù„ ØªØ£Ø«ÙŠØ± Ø´ÙƒÙ„ÙŠ Ø¨Ø³ Ø­Ø§Ù„ÙŠØ§Ù‹
    const heartIcon = document.querySelector(`#comment-${commentId} .fa-heart`); // Ø§ÙØªØ±Ø§Ø¶ Ù…ÙƒØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    if(heartIcon) {
        if(heartIcon.style.color === 'rgb(255, 59, 48)') {
            heartIcon.style.color = '#fff'; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù„Ø§ÙŠÙƒ
        } else {
            heartIcon.style.color = '#ff3b30'; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø§ÙŠÙƒ
            // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
        }
    }
    // Ù‡Ø²Ø§Ø² Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    if(navigator.vibrate) navigator.vibrate(50);
}

async function shareVideo(id, text) {
    const shareData = {
        title: 'NABD Pro',
        text: text || 'Ø´Ø§Ù‡Ø¯ Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø±Ø§Ø¦Ø¹ Ø¹Ù„Ù‰ Ù†Ø¨Ø¶!',
        url: window.location.href // Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    };

    if (navigator.share) {
        try {
            await navigator.share(shareData);
        } catch (err) {
            console.log('Error sharing:', err);
        }
    } else {
        // Fallback: Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
        navigator.clipboard.writeText(shareData.url);
        showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø­Ø§ÙØ¸Ø© ğŸ“‹");
    }
}

function toggleFollow(uid, btn) {
    // Ù‡Ù†Ø§ Ù‡ØªØ¹Ù…Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø¨ØªØ§Ø¹Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    // Ø¯Ù‡ ÙƒÙˆØ¯ Ø´ÙƒÙ„ÙŠ Ø¨Ø³:
    if (btn.innerText === "Ù…ØªØ§Ø¨Ø¹Ø©") {
        btn.innerText = "Ù…ØªØ§Ø¨Ø¹";
        btn.style.background = "transparent";
        btn.style.border = "1px solid rgba(255,255,255,0.2)";
        btn.style.color = "#ccc";
    } else {
        btn.innerText = "Ù…ØªØ§Ø¨Ø¹Ø©";
        btn.style.background = "rgba(255, 255, 255, 0.15)";
        btn.style.border = "1px solid rgba(255, 255, 255, 0.4)";
        btn.style.color = "#fff";
    }
}

// Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚
function getBadge(isVerified, isGhost) {
    // Ù„Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ Ù…ÙØ¹Ù„ØŒ Ù…ÙÙŠØ´ ØªÙˆØ«ÙŠÙ‚ Ø¨ÙŠØ¸Ù‡Ø±
    if (isGhost) return '';
    
    // Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ«Ù‚ØŒ Ø±Ø¬Ø¹ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶
    // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ fa-heart-circle-check Ø¹Ø´Ø§Ù† ØªØ¯ÙŠ Ø´ÙƒÙ„ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù…ÙˆØ«Ù‚
    return isVerified ? `<i class="fa-solid fa-heart-circle-check nabd-badge"></i>` : '';
}

// Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø§Ø³Ù…
// Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø§Ø³Ù…
function formatSmartName(name) {
    if (!name) return "Ù…Ø³ØªØ®Ø¯Ù…"; // Ø­Ù…Ø§ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù…
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù…
    const cleanName = name.trim();
    
    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù…
    const words = cleanName.split(/\s+/);

    // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ù†Ø±Ø¬Ø¹ Ø£ÙˆÙ„ Ø§Ø³Ù…ÙŠÙ† ÙÙ‚Ø· Ø¹Ø´Ø§Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…ÙŠØ¨ÙˆØ¸Ø´
    if (words.length > 2) {
        return words.slice(0, 2).join(' ');
    }
    
    return cleanName;
}

function createSafeCommentElement(c) {
    const container = document.createElement('div');
    container.className = 'comment-item';
    container.id = `comment-${c.id}`;

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø£Ù…Ø§Ù†
    const avatar = document.createElement('div');
    avatar.className = 'cm-avatar';
    // ... Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© ...

    const contentDiv = document.createElement('div');
    contentDiv.className = 'cm-content';

    const username = document.createElement('div');
    username.className = 'cm-username';
    username.textContent = c.name; // Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ø§Ù‹ Ø¶Ø¯ XSS

    if(c.isVerified) {
        const badge = document.createElement('i');
        badge.className = 'fa-solid fa-heart-circle-check nabd-badge';
        username.appendChild(badge);
    }

    const textDiv = document.createElement('div');
    textDiv.className = 'cm-text';
    textDiv.textContent = c.text; // Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ø§Ù‹

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    contentDiv.appendChild(username);
    contentDiv.appendChild(textDiv);
    container.appendChild(avatar);
    container.appendChild(contentDiv);

    return container;
}

function switchFeedTab(tabName) {
    if (isLoading || currentFeedTab === tabName) return;

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„ (UI)
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    currentFeedTab = tabName;
    lastDoc = null; // ØªØµÙÙŠØ± Ø¹Ø´Ø§Ù† Ù†Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£ÙˆÙ„
    document.getElementById('feed').innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

    // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    loadVideos(true);
}
// Ù…ØªØºÙŠØ± Ù„ØªØ°ÙƒØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡
let videoPausedBySearch = null;

function openSearchScreen() {
    // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø­Ø«
    document.getElementById('searchScreen').classList.add('active');
    document.getElementById('searchInput').focus();

    // 2. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ Ø´ØºØ§Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    const videos = document.querySelectorAll('video');
    videos.forEach(vid => {
        // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„ ÙˆÙ…Ø´ ÙˆØ§Ù‚Ù ÙˆÙ…Ø´ Ù…Ø®Ù„Øµ
        if (!vid.paused && !vid.ended) {
            vid.pause();
            videoPausedBySearch = vid; // Ù†Ø­ÙØ¸Ù‡ Ø¹Ø´Ø§Ù† Ù†Ø´ØºÙ„Ù‡ ØªØ§Ù†ÙŠ
        }
    });
}

function closeSearchScreen() {
    // 1. Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø­Ø«
    document.getElementById('searchScreen').classList.remove('active');

    // 2. Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ ÙˆÙ‚ÙÙ†Ø§Ù‡ (Ù„Ùˆ ÙƒØ§Ù† ÙÙŠÙ‡ ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„)
    if (videoPausedBySearch) {
        // Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ù„Ø³Ù‡ Ø¸Ø§Ù‡Ø± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
        videoPausedBySearch.play().catch(e => console.log("Auto-resume prevented"));
        videoPausedBySearch = null; // Ù†Ù†Ø³Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø®Ù„Ø§Øµ
    }
}


function switchSearchFilter(type, el) {
    document.querySelectorAll('.s-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    currentSearchType = type;
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const val = document.getElementById('searchInput').value;
    if(val) doSearch(val);
}

function handleSearch(input) {
    const val = input.value.trim();
    const clearBtn = document.getElementById('clearSearch');
    
    if (val.length > 0) clearBtn.style.display = 'block';
    else clearBtn.style.display = 'none';

    // Debounce (Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù…Ù„Ø´ Ø¨Ø­Ø« Ù…Ø¹ ÙƒÙ„ Ø­Ø±ÙØŒ ÙŠØ³ØªÙ†Ù‰ Ø´ÙˆÙŠØ©)
    clearTimeout(window.searchTimer);
    window.searchTimer = setTimeout(() => {
        if (val.length > 1) doSearch(val);
    }, 500); 
}

function clearSearchInput() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResultsArea').innerHTML = '';
    document.getElementById('clearSearch').style.display = 'none';
}

// --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØµØ­Ø­Ø© (ØµÙˆØ± + ØªÙˆØ«ÙŠÙ‚) ---
async function doSearch(queryText) {
    const container = document.getElementById('searchResultsArea');
    container.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

    try {
        let html = '';
        
        if (currentSearchType === 'users') {
            // Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const snapshot = await db.collection('users')
                .where('name', '>=', queryText)
                .where('name', '<=', queryText + '\uf8ff')
                .limit(10)
                .get();

            if (snapshot.empty) {
                container.innerHTML = '<div style="text-align:center; color:#777;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</div>';
                return;
            }

            snapshot.forEach(doc => {
                  if (blockedUsersSet.has(doc.id)) {
        return; 
    }

                const d = doc.data();
                
                
                // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ boolean)
                const isVerified = d.isVerified === true; 
                const badge = getBadge(isVerified, false); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚

                // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø©)
                const userImg = d.profilePic || d.avatarUrl || "https://cdn-icons-png.flaticon.com/512/847/847969.png";

                html += `
                <div class="user-result-card" onclick="location.href='profile.html?uid=${doc.id}'">
                    <img src="${userImg}" class="user-result-img">
                    <div>
                        <div style="font-weight:bold; color:#fff; display:flex; align-items:center; gap:5px;">
                            ${d.name} ${badge}
                        </div>
                        <div style="font-size:12px; color:#aaa;">@${doc.id.substring(0,8)}...</div>
                    </div>
                </div>`;
            });

        } else {
            // Ø¨Ø­Ø« Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ)
            const snapshot = await db.collection('posts')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();
            
            const filtered = snapshot.docs.filter(doc => {
                const txt = doc.data().text || '';
                return txt.includes(queryText);
            });

            if (filtered.length === 0) {
                html = '<div style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            } else {
                html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">';
                filtered.forEach(doc => {
                    const d = doc.data();
                    const vid = d.media.find(m => m.type === 'video');
                    if(vid) {
                        html += `
                        <div onclick="openSingleVideo('${doc.id}')" style="position:relative; aspect-ratio: 9/16; background:#333; border-radius:10px; overflow:hidden;">
                            <video src="${vid.url}" style="width:100%; height:100%; object-fit:cover;"></video>
                            <div style="position:absolute; bottom:5px; right:5px; font-size:10px; font-weight:bold;">
                                <i class="fa-solid fa-play"></i> ${d.views || 0}
                            </div>
                        </div>`;
                    }
                });
                html += '</div>';
            }
        }
        addToSearchHistory(queryText);

        container.innerHTML = html;

    } catch (e) {
        console.error(e);
        container.innerHTML = '<div style="text-align:center; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>';
    }
}

// --- Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯) ---
function getBadge(isVerified, isGhost) {
    if (isGhost) return '';
    // Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠ Ù‡ØªØ¸Ù‡Ø± Ø¨Ø³ Ù„Ùˆ isVerified = true
    return isVerified ? `<i class="fa-solid fa-heart-circle-check nabd-badge" style="color:#20D5EC; margin-right:3px; font-size:14px;"></i>` : '';
}
async function openSingleVideo(pid) {
    // 1. Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù€ Feed ÙˆØªÙØ±ÙŠØºÙ‡
    const feed = document.getElementById('feed');
    // Ø¨Ù†Ø®Ù„ÙŠ Ø§Ù„ØµÙØ­Ø© ØªØ·Ù„Ø¹ Ù„ÙÙˆÙ‚ Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙØªØ­
    feed.scrollTop = 0;
    
    try {
        // 2. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØ³Øª
        const doc = await db.collection('posts').doc(pid).get();
        
        if (!doc.exists) {
            showToast("âš ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡");
            loadVideos(true); // Ù†Ø±Ø¬Ø¹ Ù†Ø­Ù…Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            return;
        }

        const data = doc.data();
        const videoMedia = data.media ? data.media.find(m => m.type === 'video') : null;

        if (videoMedia) {
            // 3. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚)
            let uName = "Ù…Ø³ØªØ®Ø¯Ù…";
            let uPic = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            let isVerified = false;

            try {
                const uSnap = await db.collection('users').doc(data.uid).get();
                if(uSnap.exists) {
                    const uData = uSnap.data();
                    uName = uData.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                    uPic = uData.profilePic || uData.avatarUrl || uPic;
                    isVerified = uData.isVerified || false;
                }
            } catch(e) { console.error("Error fetching user:", e); }

            // 4. Ù…Ø³Ø­ Ø§Ù„Ù€ Feed ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
            feed.innerHTML = ''; // ÙØ¶ÙŠ Ø§Ù„Ù…ÙƒØ§Ù†
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© createVideoCard Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ Ø£ØµÙ„Ø§Ù‹
            const cardHTML = createVideoCard(doc.id, { ...data, isVerified }, videoMedia.url, uName, uPic, data.uid);
            
            feed.innerHTML = cardHTML; 

            // 5. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            const newCard = document.getElementById(`slide-${doc.id}`);
            if (newCard) {
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ´ØªØºÙ„
                observer.observe(newCard);
                
                const vid = newCard.querySelector('video');
                
                // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„Ùˆ Ø¹Ø§ÙŠØ²Ù‡ ÙŠØ´ØªØºÙ„ Ø¨ØµÙˆØª Ø¹Ù„Ø·ÙˆÙ„)
                isGlobalMuted = false; 
                vid.muted = false;
                
                playVideo(vid, doc.id);
            }
        }
    } catch (e) {
        console.error("Error opening single video:", e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
        loadVideos(true); // Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£ Ø±Ø¬Ø¹Ù‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    }
}


// --- Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ ---
function updatePlayButtonState(vid, id) {
    const slide = document.getElementById(`slide-${id}`);
    if (!slide) return;

    // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù‚ÙØŒ Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ 'is-paused' Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø±Ø§Ø± ÙŠØ¸Ù‡Ø±
    if (vid.paused) {
        slide.classList.add('is-paused');
    } else {
        // Ù„Ùˆ Ø´ØºØ§Ù„ØŒ Ø´ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø¹Ø´Ø§Ù† ÙŠØ®ØªÙÙŠ
        slide.classList.remove('is-paused');
    }
}

async function toggleSave(id) {
    if (!currentUser) {
        showToast("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ÙØ¸ ğŸ”’");
        return;
    }

    const icon = document.getElementById(`save-icon-${id}`);
    const text = document.getElementById(`save-text-${id}`);
    const isSaved = icon.classList.contains('active-save');
    
    // Ø§Ù„Ù…Ø±Ø¬Ø¹ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²: users -> uid -> saved_posts -> videoId
    const savedRef = db.collection('users').doc(currentUser.uid).collection('saved_posts').doc(id);

    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ ÙÙˆØ±ÙŠ (Optimistic UI)
    if (isSaved) {
        icon.classList.remove('active-save');
        icon.style.color = "#fff";
        text.innerText = "Ø­ÙØ¸";
        showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª ğŸ—‘ï¸");
        
        // Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        savedRef.delete().catch(err => console.error(err));
    } else {
        icon.classList.add('active-save');
        icon.style.color = "#FFD700";
        text.innerText = "Ù…Ø­ÙÙˆØ¸";
        showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© âœ…");
        
        // Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² (Ù†Ø®Ø²Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸ Ø¹Ø´Ø§Ù† Ù†Ø±ØªØ¨Ù‡Ù…)
        savedRef.set({
            savedAt: firebase.firestore.FieldValue.serverTimestamp(),
            postId: id // Ù†Ø®Ø²Ù† Ø§Ù„Ù€ ID Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        }).catch(err => console.error(err));
    }
    
    if(navigator.vibrate) navigator.vibrate(50);
}

// ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
// ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function openSavedVideos() {
    if (!currentUser) {
        showToast("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ ğŸ”’");
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø©
    const page = document.getElementById('savedPage');
    page.classList.add('active');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙƒØ¨Ø¯Ø§ÙŠØ©)
    switchSavedTab('posts');
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
function closeSavedPage() {
    const page = document.getElementById('savedPage');
    page.classList.remove('active');
}

// Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
function switchSavedTab(type) {
    // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª
    document.querySelectorAll('.fs-tab').forEach(t => t.classList.remove('active'));
    // (Ù‡Ù†Ø§ Ø¨Ù†Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù†Ø´Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµØŒ Ù…Ù…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ø¨Ù€ ID)
    event.target.classList.add('active');

    const container = document.getElementById('savedPostsGrid');
    
    if (type === 'posts') {
        loadSavedPostsGrid();
    } else {
        container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ${type === 'sounds' ? 'Ø£ØµÙˆØ§Øª' : 'ØªØ£Ø«ÙŠØ±Ø§Øª'} Ù…Ø­ÙÙˆØ¸Ø©</div>`;
    }
}
async function loadSavedPostsGrid() {
    const container = document.getElementById('savedPostsGrid');
    container.innerHTML = '<div class="loading-state"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

    try {
        const savedSnaps = await db.collection('users').doc(currentUser.uid)
            .collection('saved_posts')
            .orderBy('savedAt', 'desc')
            .get();

        if (savedSnaps.empty) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#777;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø­ÙØ¸ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¹Ø¯</div>';
            return;
        }

        container.innerHTML = ''; 

        for (const doc of savedSnaps.docs) {
            // Ø¨Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØ³Øª Ø§Ù„Ø£ØµÙ„ÙŠ
            const postDoc = await db.collection('posts').doc(doc.id).get();
            
            if (postDoc.exists) {
                const data = postDoc.data();
                const videoMedia = data.media ? data.media.find(m => m.type === 'video') : null;

                if (videoMedia) {
                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    
                    // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù… Ù‡Ù†Ø§ ğŸ”¥ğŸ”¥ğŸ”¥
                    item.onclick = async () => {
                        // 1. Ø£ÙˆÙ„ Ø­Ø§Ø¬Ø© Ù†Ù‚ÙÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
                        closeSavedPage(); 
                        
                        // 2. Ù†Ø¸Ù‡Ø± Ù„ÙˆØ¯Ø± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¹Ø±Ù Ø¥Ù† ÙÙŠÙ‡ Ø­Ø§Ø¬Ø© Ø¨ØªØ­ØµÙ„
                        document.getElementById('feed').innerHTML = '<div style="height:100vh; display:flex; align-items:center; justify-content:center; color:#fff;"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i></div>';
                        
                        // 3. Ù†ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                        await openSingleVideo(postDoc.id);
                    };

                    item.innerHTML = `
                        <video src="${videoMedia.url}#t=1.0" preload="metadata" muted style="pointer-events:none;"></video>
                        <div class="grid-overlay">
                            <i class="fa-solid fa-play"></i> ${data.views || 0}
                        </div>
                    `;
                    container.appendChild(item);
                }
            }
        }

    } catch (e) {
        console.error("Error loading saved:", e);
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
    }
}

/* =========================================
   Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© (Library System)
   ========================================= */

// 1. ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©
function openLibraryMenu() {
    document.getElementById('libraryMenuSheet').classList.add('active');
    document.getElementById('overlay').style.display = 'block';
}

function closeLibraryMenu() {
    document.getElementById('libraryMenuSheet').classList.remove('active');
    document.getElementById('overlay').style.display = 'none';
}

// 2. ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†
function openLibraryPage(tabName) {
    closeLibraryMenu(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµØºÙŠØ±Ø©
    const page = document.getElementById('libraryPage');
    page.classList.add('active');
    switchLibraryTab(tabName);
}

function closeLibraryPage() {
    document.getElementById('libraryPage').classList.remove('active');
}

// 3. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ø¨Ø§Øª
let currentLibraryTab = '';

function switchLibraryTab(type) {
    currentLibraryTab = type;
    
    document.querySelectorAll('.fs-tab').forEach(t => t.classList.remove('active'));
    
    const activeTab = document.getElementById(`tab-${type}`);
    if(activeTab) activeTab.classList.add('active');

    const titles = {
        'saved': 'Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©',
        'favorites': 'Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©',
        'sounds': 'Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©', // ğŸµ ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        'history': 'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©',
        'search_history': 'Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø­Ø«'
    };
    
    const titleEl = document.getElementById('libraryTitle');
    if(titleEl) titleEl.innerText = titles[type] || 'Ø§Ù„Ù…ÙƒØªØ¨Ø©';

    loadLibraryGrid(type);
}


// 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ© (The Master Loader)
// --- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø© ---
async function loadLibraryGrid(type) {
    const container = document.getElementById('libraryGrid');
    
    // 1. Ø­Ù…Ø§ÙŠØ©: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!currentUser) {
        container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#777;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</div>';
        return;
    }

    container.innerHTML = '<div class="loading-state"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
    
    let collectionName = '';
    let orderByField = '';
    
    // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆÙ„ÙƒØ´Ù† (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙˆØ§Øª Ù‡Ù†Ø§)
    if (type === 'saved') { collectionName = 'saved_posts'; orderByField = 'savedAt'; }
    else if (type === 'favorites') { collectionName = 'favorites'; orderByField = 'createdAt'; }
    else if (type === 'history') { collectionName = 'watch_history'; orderByField = 'viewedAt'; }
    else if (type === 'search_history') { collectionName = 'search_history'; orderByField = 'searchedAt'; }
    else if (type === 'sounds') { collectionName = 'favorite_sounds'; orderByField = 'savedAt'; } // ğŸµ Ø¬Ø¯ÙŠØ¯

    try {
        let query = db.collection('users').doc(currentUser.uid).collection(collectionName).orderBy(orderByField, 'desc');

        // Ø´Ø±Ø· Ø§Ù„Ù€ 30 ÙŠÙˆÙ… Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        if (type === 'history') {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            query = query.where('viewedAt', '>', thirtyDaysAgo); 
        }

        const snapshot = await query.get();

        if (snapshot.empty) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#777;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</div>';
            return;
        }

        container.innerHTML = ''; 

        // =========================================================
        // ğŸ”¥ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø¶Ø§Ù: Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙˆØ§Øª (Sounds)
        // =========================================================
        if (type === 'sounds') {
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            
            snapshot.forEach(doc => {
                const d = doc.data();
                const item = document.createElement('div');
                item.style.cssText = "padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:space-between; cursor:pointer;";
                
                // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ù†ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØµÙˆØª
                // Ù„Ø§Ø­Ø¸: Ø¨Ù†Ø¨Ø¹Øª null Ù„Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ù…Ø´ Ù…Ø­ÙÙˆØ¸Ø©
                const clickAction = `openSoundPage('${d.name}', '${d.author}', null); closeLibraryPage();`;

                item.innerHTML = `
                    <div onclick="${clickAction}" style="display:flex; align-items:center; gap:15px; flex:1;">
                        <div style="width:40px; height:40px; background:linear-gradient(45deg, #1db954, #191414); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 2px 10px rgba(29,185,84,0.3);">
                            <i class="fa-solid fa-music"></i>
                        </div>
                        <div>
                            <div style="font-weight:bold; color:#fff; font-size:14px;">${d.name}</div>
                            <div style="font-size:11px; color:#aaa;">${d.author || 'Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶'}</div>
                        </div>
                    </div>
                    <div onclick="deleteHistoryItem('${collectionName}', '${doc.id}')" style="padding:10px;">
                        <i class="fa-solid fa-trash" style="color:#ff3b30; font-size:14px;"></i>
                    </div>
                `;
                container.appendChild(item);
            });
            return; // Ø®Ø±ÙˆØ¬ Ù…Ù‡Ù…
        }

        // =========================================================
        // Ø§Ù„Ù‚Ø³Ù…: Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø­Ø« (Ù†ØµÙˆØµ)
        // =========================================================
        if (type === 'search_history') {
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.style.cssText = "padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; color:#fff;";
                div.innerHTML = `
                    <div onclick="doSearch('${data.term}'); closeLibraryPage(); closeSearchScreen();" style="flex:1; cursor:pointer;">
                        <i class="fa-solid fa-clock-rotate-left" style="color:#777; margin-left:10px;"></i> ${data.term}
                    </div>
                    <i class="fa-solid fa-xmark" style="color:#555; padding:10px; cursor:pointer;" onclick="deleteHistoryItem('${collectionName}', '${doc.id}')"></i>
                `;
                container.appendChild(div);
            });
            return;
        }

        // =========================================================
        // Ø§Ù„Ù‚Ø³Ù…: Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Grid)
        // =========================================================
        container.style.display = 'grid'; 
        container.style.gridTemplateColumns = 'repeat(3, 1fr)';
        container.style.gap = '2px';
        
        for (const doc of snapshot.docs) {
            let postId = doc.id;
            if (doc.data().postId) postId = doc.data().postId;

            const postDoc = await db.collection('posts').doc(postId).get();
            
            if (postDoc.exists) {
                const data = postDoc.data();
                const videoMedia = data.media ? data.media.find(m => m.type === 'video') : null;

                if (videoMedia) {
                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    item.style.position = 'relative';
                    item.style.aspectRatio = '3/4';
                    item.style.background = '#222';
                    item.style.cursor = 'pointer';

                    item.onclick = async () => {
                        closeLibraryPage();
                        document.getElementById('feed').innerHTML = '<div style="height:100vh; display:flex; align-items:center; justify-content:center; color:#fff;"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i></div>';
                        await openSingleVideo(postId);
                    };

                    item.innerHTML = `
                        <video src="${videoMedia.url}#t=1.0" preload="metadata" muted style="pointer-events:none; width:100%; height:100%; object-fit:cover;"></video>
                        <div class="grid-overlay" style="position:absolute; bottom:0; left:0; width:100%; padding:5px; background:linear-gradient(transparent, rgba(0,0,0,0.7)); color:#fff; font-size:10px; font-weight:bold;">
                            <i class="fa-solid fa-play"></i> ${data.views || 0}
                        </div>
                    `;
                    container.appendChild(item);
                }
            }
        }

    } catch (e) {
        console.error("Library Error:", e);
        if (e.message.includes("The query requires an index")) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#ffb533; font-size:12px;">Ù…Ø·Ù„ÙˆØ¨ ØªÙØ¹ÙŠÙ„ Index (Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„)</div>';
        } else {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
        }
    }
}

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
async function deleteHistoryItem(collection, docId) {
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) return;
    try {
        await db.collection('users').doc(currentUser.uid).collection(collection).doc(docId).delete();
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        loadLibraryGrid(currentLibraryTab);
    } catch(e) { console.error(e); }
}

/* ------------------------------------------------
   5. ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Watch History Logic)
   ------------------------------------------------ */
// Ø¶Ø¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ playVideo
async function addToWatchHistory(postId) {
    if (!currentUser) return;
    
    // Ù†Ø³ØªØ®Ø¯Ù… set Ø¹Ø´Ø§Ù† Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙŠØ­Ø¯Ø« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø³ ÙˆÙ…ÙŠÙƒØ±Ø±Ø´ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    try {
        await db.collection('users').doc(currentUser.uid).collection('watch_history').doc(postId).set({
            postId: postId,
            viewedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch(e) { console.log("History Error", e); }
}

/* ------------------------------------------------
   6. ØªÙØ¹ÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« (Search History Logic)
   ------------------------------------------------ */
// Ø¶Ø¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ doSearch
async function addToSearchHistory(term) {
    if (!currentUser || !term) return;
    
    try {
        // Ù†Ø³ØªØ®Ø¯Ù… add Ø¹Ø´Ø§Ù† Ù…Ù…ÙƒÙ† ÙŠØ¨Ø­Ø« Ø¹Ù† Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ°Ø§ Ù…Ø±Ø©ØŒ Ø£Ùˆ set Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒÙ€ ID Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        // Ù‡Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒÙ€ ID Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
        await db.collection('users').doc(currentUser.uid).collection('search_history').doc(term).set({
            term: term,
            searchedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch(e) { console.log("Search History Error", e); }
}

/* ------------------------------------------------
   7. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© (Favorites Logic)
   ------------------------------------------------ */
// Ø¯ÙŠ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø²Ø±Ø§Ø± "Ù…ÙØ¶Ù„Ø©" ØºÙŠØ± Ø§Ù„Ù„Ø§ÙŠÙƒ ÙˆØ§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
// Ø£Ùˆ Ù…Ù…ÙƒÙ† Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ù„Ø§ÙŠÙƒ Ù‡Ùˆ Ø§Ù„Ù…ÙØ¶Ù„Ø©. Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù†ÙØµÙ„Ø©
async function toggleFavorite(id) {
    // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ toggleSave Ø¨Ø³ Ø¹Ù„Ù‰ ÙƒÙˆÙ„ÙƒØ´Ù† favorites
    if (!currentUser) return;
    const ref = db.collection('users').doc(currentUser.uid).collection('favorites').doc(id);
    // ... (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„) ...
}

/* --- Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø© --- */
async function toggleAddFavorite(id) {
    if (!currentUser) {
        showToast("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”’");
        return;
    }

    // Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ ID Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const icon = document.getElementById('menuFavIcon');
    const text = document.getElementById('menuFavText');
    
    // Ø­Ù…Ø§ÙŠØ©: Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø£ÙŠ Ø³Ø¨Ø¨ Ù…Ù†Ø®Ø±Ø¬Ø´ Ø®Ø·Ø£ ÙŠÙˆÙ‚Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    if (!icon || !text) return; 

    const isActive = icon.style.color === 'rgb(255, 215, 0)'; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø°Ù‡Ø¨ÙŠ

    const favRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(id);

    if (isActive) {
        // Ø¥Ø²Ø§Ù„Ø©
        icon.style.color = "#fff";
        text.innerText = "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©";
        showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø© âŒ");
        favRef.delete().catch(console.error);
    } else {
        // Ø¥Ø¶Ø§ÙØ©
        icon.style.color = "#FFD700"; // Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ
        text.innerText = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
        showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø© â­");
        favRef.set({
            postId: id,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(console.error);
    }
    
    if(navigator.vibrate) navigator.vibrate(50);
}

async function openVideoOptions(pid, ownerUid) {
    currentOpenVideoId = pid;
    currentPostOwnerUid = ownerUid;
    updateVideoMeta(pid);

    const ownerSection = document.getElementById('ownerVideoActions');
    const viewerSection = document.getElementById('viewerVideoActions');

    // --- ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ù„ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ---
    if (currentUser) {
        const icon = document.getElementById('menuFavIcon');
        const text = document.getElementById('menuFavText');
        if(icon && text) {
            // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø£Ùˆ Ø§Ù„Ù„ÙˆÙƒØ§Ù„
            const doc = await db.collection('users').doc(currentUser.uid).collection('favorites').doc(pid).get();
            if(doc.exists) {
                icon.style.color = "#FFD700";
                text.innerText = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
            } else {
                icon.style.color = "#fff";
                text.innerText = "Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©";
            }
        }
    }
    // ------------------------------------------------

    if (currentUser && currentUser.uid === ownerUid) {
        ownerSection.style.display = 'flex';
        viewerSection.style.display = 'none';
    } else {
        ownerSection.style.display = 'none';
        viewerSection.style.display = 'block';
    }

    document.getElementById('videoOptionsSheet').classList.add('active');
    document.getElementById('overlay').style.display = 'block';
}

function deleteVideoAction() {
    closeAllSheets(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ùƒ Ù„Ù„ØªØ£ÙƒÙŠØ¯
    showChicConfirm(
        "Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŸ", 
        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ù„Ø§ÙŠÙƒØ§Øª.", 
        '<i class="fa-solid fa-trash-can" style="color:#ff3b30; font-size: 40px;"></i>', 
        async function() {
            try {
                showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù... ğŸ—‘ï¸");

                // 1. Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØ³Øª Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¹Ø´Ø§Ù† Ù†Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†)
                const docSnap = await db.collection('posts').doc(currentOpenVideoId).get();
                if (!docSnap.exists) return;

                const data = docSnap.data();
                const videoMedia = data.media ? data.media.find(m => m.type === 'video') : null;

                // 2. Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Firebase Storage (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¨Ø³ Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø¸Ø§ÙØ©)
                if (videoMedia && videoMedia.url) {
                    try {
                        const storageRef = firebase.storage().refFromURL(videoMedia.url);
                        await storageRef.delete();
                    } catch (err) {
                        console.log("File delete error (might use diff bucket):", err);
                    }
                }

                // 3. Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…Ù† Firestore
                await db.collection('posts').doc(currentOpenVideoId).delete();

                // 4. Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ (UX)
                const slideElement = document.getElementById(`slide-${currentOpenVideoId}`);
                if (slideElement) {
                    slideElement.remove();
                }

                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                
                // Ù„Ùˆ Ù…ÙÙŠØ´ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ØªØ§Ù†ÙŠØ©ØŒ Ù…Ù…ÙƒÙ† ØªØ¹Ù…Ù„ reload
                // loadVideos(true); 

            } catch(e) {
                console.error(e);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
            }
        }
    );
}

// Ø¯Ø§Ù„Ø© ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø¤Ù‚ØªØ§Ù‹)
function downloadVideoAction() {
    closeAllSheets();
    // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¬ÙŠØ¨ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØªØ¹Ù…Ù„Ù‡ download
    const vid = document.getElementById(`vid-${currentOpenVideoId}`);
    if(vid) {
        const a = document.createElement('a');
        a.href = vid.querySelector('source').src;
        a.download = `NABD_Video_${currentOpenVideoId}.mp4`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„... â¬‡ï¸");
    }
}

// Ø¯Ø§Ù„Ø© Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
async function blockUserAction() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    closeAllSheets();

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!currentUser || !currentPostOwnerUid) {
        showToast("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡");
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø¸Ø±
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ù† ØªØ¸Ù‡Ø± ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªÙ‡ Ù„Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.")) {
        return;
    }

    showToast("Ø¬Ø§Ø±ÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…... ğŸš«");

    try {
        // 3. ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø§Øª (Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±)
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¨Ø¬Ø¯ÙŠ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ù‡Ùˆ Ù†ÙØ³Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø®ØµÙŠÙ† (uid1_uid2)
        const ids = [currentUser.uid, currentPostOwnerUid].sort();
        const chatId = ids.join("_");

        const chatRef = db.collection('chats').doc(chatId);
        
        // 4. ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ø´Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹ØŸ
        const chatDoc = await chatRef.get();

        if (chatDoc.exists) {
            // Ø£) Ø§Ù„Ø´Ø§Øª Ù…ÙˆØ¬ÙˆØ¯: Ù†Ø­Ø¯Ø«Ù‡ ÙˆÙ†Ø¶ÙŠÙÙƒ Ù„Ù‚Ø§Ø¦Ù…Ø© blockedBy
            await chatRef.update({
                blockedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
        } else {
            // Ø¨) Ø§Ù„Ø´Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: Ù†Ù†Ø´Ø¦Ù‡ ÙˆÙ†Ø¶ÙŠÙ Ø§Ù„Ø­Ø¸Ø± ÙÙˆØ±Ø§Ù‹
            // Ù‡Ø°Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ø­ØªÙ‰ Ù„Ùˆ Ù…ÙÙŠØ´ Ø´Ø§Øª Ø³Ø§Ø¨Ù‚ Ø¨ÙŠÙ†Ù‡Ù…
            await chatRef.set({
                users: ids,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: { text: "ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©", type: "system" },
                blockedBy: [currentUser.uid] // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¸Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
            });
        }

        // 5. (Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©) Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹
        const currentSlide = document.getElementById(`slide-${currentOpenVideoId}`);
        if(currentSlide) {
            currentSlide.remove(); // Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø£Ù…Ø§Ù…Ùƒ
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            // const nextSlide = document.querySelector('.video-slide');
            // if(nextSlide) nextSlide.scrollIntoView();
        }

        showToast("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…");

    } catch (e) {
        console.error("Block Error:", e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¸Ø±");
    }
}


/* =========================================
   ÙˆØ¸Ø§Ø¦Ù ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ (Cinema Mode Logic)
   ========================================= */

function openCinemaMode() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ù…ÙØªÙˆØ­Ø©
    closeAllSheets();

    // 2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙÙŠØ¯ÙŠÙˆ Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹
    if (!currentOpenVideoId) return;

    const smallVid = document.getElementById(`vid-${currentOpenVideoId}`);
    const overlay = document.getElementById('cinemaOverlay');
    const bigVid = document.getElementById('fsVideoPlayer');
    const bigPlayIcon = document.getElementById('fsPlayIcon');
    const speedBtn = document.getElementById('fsSpeedBtn');
    const seeker = document.getElementById('fsSeeker');

    if (!smallVid || !overlay || !bigVid) return;

    // 3. Ù†Ù‚Ù„ Ù…ØµØ¯Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Source)
    // Ø¨Ù†Ø´ÙˆÙ Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨ÙŠØ³ØªØ®Ø¯Ù… ØªØ§Ø¬ source Ø£Ùˆ src Ù…Ø¨Ø§Ø´Ø±Ø©
    const videoSrc = smallVid.querySelector('source') ? smallVid.querySelector('source').src : smallVid.src;
    bigVid.src = videoSrc;

    // 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© (Ø¹Ø´Ø§Ù† ÙŠÙƒÙ…Ù„ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
    bigVid.currentTime = smallVid.currentTime;
    bigVid.muted = smallVid.muted;
    bigVid.playbackRate = smallVid.playbackRate;

    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø³Ø±Ø¹Ø© ÙÙŠ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
    updateFsMuteIcon(bigVid.muted);
    if(speedBtn) speedBtn.innerText = smallVid.playbackRate + 'x';

    // 5. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµØºÙŠØ± ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±
    smallVid.pause(); // Ù†ÙˆÙ‚Ù Ø§Ù„Ù„ÙŠ ÙˆØ±Ø§
    overlay.classList.add('active'); // Ù†Ø¸Ù‡Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø©
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ¨ÙŠØ±
    var playPromise = bigVid.play();
    if (playPromise !== undefined) {
        playPromise.then(() => {
            if(bigPlayIcon) bigPlayIcon.style.opacity = '0';
        }).catch(error => {
            if(bigPlayIcon) bigPlayIcon.style.opacity = '1';
        });
    }

    // 6. Ø±Ø¨Ø· Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª (Seeker)
    bigVid.ontimeupdate = () => {
        if(seeker) {
            const percent = (bigVid.currentTime / bigVid.duration) * 100;
            seeker.value = percent || 0;
            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø´Ø±ÙŠØ·
            seeker.style.background = `linear-gradient(to right, var(--primary) ${percent}%, rgba(255,255,255,0.2) ${percent}%)`;
        }
    };
    
    // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ù†Ø¹ÙŠØ¯Ù‡ Ù…Ù† Ø§Ù„Ø£ÙˆÙ„ (Loop)
    bigVid.onended = () => {
        bigVid.currentTime = 0;
        bigVid.play();
    };
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§ (Ù…Ø­Ø¯Ø«Ø©)
function closeCinemaMode() {
    const overlay = document.getElementById('cinemaOverlay');
    const bigVid = document.getElementById('fsVideoPlayer');
    const smallVid = document.getElementById(`vid-${currentOpenVideoId}`);

    // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    overlay.classList.remove('active');

    // 2. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Sync Back)
    if (smallVid && bigVid) {
        smallVid.currentTime = bigVid.currentTime;
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ
        playVideo(smallVid, currentOpenVideoId);
    }

    // 3. Ø¥ÙŠÙ‚Ø§Ù ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ¨ÙŠØ±
    bigVid.pause();
    bigVid.src = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØµØ¯Ø± Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
function toggleFsPlay() {
    const v = document.getElementById('fsVideoPlayer');
    const icon = document.getElementById('fsPlayIcon');
    
    if (v.paused) {
        v.play();
        icon.style.opacity = '0';
    } else {
        v.pause();
        icon.style.opacity = '1';
    }
}

// Ø¯Ø§Ù„Ø© ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§
function toggleFsMute() {
    const v = document.getElementById('fsVideoPlayer');
    v.muted = !v.muted;
    updateFsMuteIcon(v.muted);
}

// ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµÙˆØª
function updateFsMuteIcon(isMuted) {
    const icon = document.getElementById('fsMuteIcon');
    if(icon) {
        icon.className = isMuted ? "fa-solid fa-volume-xmark" : "fa-solid fa-volume-high";
    }
}

// Ø¯Ø§Ù„Ø© ØªÙ‚Ø¯ÙŠÙ… ÙˆØªØ£Ø®ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function seekFsVideo(input) {
    const v = document.getElementById('fsVideoPlayer');
    if (v.duration) {
        const time = (input.value / 100) * v.duration;
        v.currentTime = time;
    }
}

// Ø¯Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø©
function changeFsSpeed(btn) {
    const v = document.getElementById('fsVideoPlayer');
    let r = v.playbackRate;
    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø§Øª: 1 -> 1.5 -> 2 -> 1
    let newRate = (r === 1.0) ? 1.5 : (r === 1.5) ? 2.0 : 1.0;
    
    v.playbackRate = newRate;
    btn.innerText = newRate + 'x';
}

/* =========================================
   Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Report System)
   ========================================= */

let pendingReportData = null;

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº (ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ®Ø²Ù†Ù‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹)
function openReportMenu(type, targetId, offenderUid, contentText) {
    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø£Ø®Ø±Ù‰
    closeAllSheets();
    
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­ÙŠÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø¨Ø¨
    pendingReportData = {
        type: type,             // 'post' (video), 'comment', 'reply'
        targetId: targetId,     // ID of video or comment
        offenderUid: offenderUid,
        text: contentText || "Ù…ÙŠØ¯ÙŠØ§ (ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ/ØµÙˆØª)",
        postId: currentOpenVideoId // Ø¨Ù†Ø­ØªØ§Ø¬Ù‡ Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ¹Ø±Ù ÙŠØ±Ø¬Ø¹ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
    };

    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('reportSheet').classList.add('active');
    document.getElementById('overlay').style.display = 'block';
}

// 2. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
function closeReportSheet() {
    document.getElementById('reportSheet').classList.remove('active');
    document.getElementById('overlay').style.display = 'none';
    pendingReportData = null;
}

// 3. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
async function submitReport(reason) {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!currentUser) {
        showToast("âš ï¸ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¨Ù„Ø§Øº");
        return;
    }
    if (!pendingReportData) {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù„Ø§Øº Ù…ÙÙ‚ÙˆØ¯Ø©");
        return;
    }

    // 2. ğŸ”¥ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…ØªØºÙŠØ± Ù…Ø­Ù„ÙŠ (Ù‚Ø¨Ù„ Ù…Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ø£ØµÙ„)
    const reportData = {
        reporterUid: currentUser.uid,
        offenderUid: pendingReportData.offenderUid || "unknown",
        type: pendingReportData.type || "unknown",
        targetId: pendingReportData.targetId || "unknown",
        postId: pendingReportData.postId || "unknown",
        reportedText: pendingReportData.text || "Ù…Ø­ØªÙˆÙ‰",
        reason: reason,
        status: "pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // 3. Ø§Ù„Ø¢Ù† Ù†ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù„Ø£Ù†Ù†Ø§ Ø£Ø®Ø°Ù†Ø§ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ù„Ø§Øµ)
    closeReportSheet(); 
    showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº... ğŸ›¡ï¸");

    try {
        // 4. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (reportData)
        await db.collection("reports").add(reportData);

        showToast("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§ØºØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ âœ…");

    } catch (e) {
        console.error("Report Error:", e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.message);
    }
}


function reportVideo() {
    // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù†Øµ Ø¨ØªØ§Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ù„Ù„Ø£Ø¯Ù…Ù†
    const currentSlide = document.getElementById(`slide-${currentOpenVideoId}`);
    let videoCaption = "";
    if(currentSlide) {
        const descEl = currentSlide.querySelector('.video-desc');
        if(descEl) videoCaption = descEl.innerText;
    }

    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    openReportMenu('post', currentOpenVideoId, currentPostOwnerUid, videoCaption);
}

async function fetchBlockedUsersList() {
    if (!currentUser) return;
    
    blockedUsersSet.clear(); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    try {
        // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø¨Ù†Ø¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù„ÙŠ Ø£Ù†Øª Ø·Ø±Ù ÙÙŠÙ‡Ø§
        const snapshot = await db.collection('chats')
            .where('users', 'array-contains', currentUser.uid)
            .get();

        snapshot.forEach(doc => {
            const data = doc.data();
            
            // Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø³Ø­Ø±ÙŠ: Ù‡Ù„ Ø§Ù„Ø´Ø§Øª Ø¯Ù‡ ÙÙŠÙ‡ Ø£ÙŠ Ø­Ø¸Ø±ØŸ (Ø³ÙˆØ§Ø¡ Ù…Ù†Ùƒ Ø£Ùˆ Ù…Ù†Ù‡)
            // if (data.blockedBy && data.blockedBy.length > 0)
            // Ù…Ø¹Ù†Ø§Ù‡: Ù„Ùˆ Ø§Ù„Ù…ØµÙÙˆÙØ© ÙÙŠÙ‡Ø§ Ø£ÙŠ Ø¨Ù†ÙŠ Ø¢Ø¯Ù…ØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¯ÙŠ Ù…Ù‚Ø·ÙˆØ¹Ø©
            if (data.blockedBy && data.blockedBy.length > 0) {
                
                // Ø¨Ù†Ø¬ÙŠØ¨ Ø±Ù‚Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„ØªØ§Ù†ÙŠ (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙŠ Ø§Ù„Ù…ØµÙŠØ¨Ø©)
                const otherUid = data.users.find(u => u !== currentUser.uid);
                
                if (otherUid) {
                    // Ø¨Ù†Ø¶ÙŠÙÙ‡ Ù„Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨ÙŠÙ†" Ø¹Ù†Ø¯Ùƒ
                    // ÙˆØ¨ÙƒØ¯Ù‡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡ÙŠØ¹Ø§Ù…Ù„Ù‡ ÙƒØ£Ù†Ù‡ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙˆÙ‡Ùˆ ØªØ·ÙŠÙ‚Ù‡ Ù‡ÙŠØ¹Ø§Ù…Ù„Ùƒ ÙƒØ£Ù†Ùƒ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
                    blockedUsersSet.add(otherUid);
                }
            }
        });
        
        console.log("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„ØŒ Ø§Ù„Ø¹Ø¯Ø¯:", blockedUsersSet.size);
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¸Ø±:", e);
    }
}


// 1. ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© (Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© toggleCommentsStatus Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡)
async function openPrivacySettings() {
    closeAllSheets(); // Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ§Ù†ÙŠØ©
    
    // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø¹Ø´Ø§Ù† Ù†Ø¹Ù„Ù… Ø¹Ù„ÙŠÙ‡
    const doc = await db.collection('posts').doc(currentOpenVideoId).get();
    const currentPrivacy = doc.data().commentPrivacy || 'public'; // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¥Ø¹Ø¯Ø§Ø¯ ÙŠØ¨Ù‚Ù‰ Ø¹Ø§Ù…

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø§Ù„Ù…Ø®ØªØ§Ø±
    document.querySelectorAll('input[name="c_privacy"]').forEach(el => el.checked = false);
    const selectedRadio = document.getElementById(`p_${currentPrivacy}`);
    if(selectedRadio) selectedRadio.checked = true;

    // ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.getElementById('commentPrivacySheet').classList.add('active');
    document.getElementById('overlay').style.display = 'block';
}

function closePrivacySheet() {
    document.getElementById('commentPrivacySheet').classList.remove('active');
    document.getElementById('overlay').style.display = 'none';
}

// 2. Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
async function setPrivacy(level) {
    // level Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ†: 'public', 'followers', 'following', 'disabled'
    
    closePrivacySheet();
    showToast("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª... âš™ï¸");

    try {
        await db.collection('posts').doc(currentOpenVideoId).update({
            commentPrivacy: level
        });
        showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø®ØµÙˆØµÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª âœ…");
    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}

async function togglePiP() {
    const video = document.getElementById(`vid-${currentOpenVideoId}`);
    if (!video) return;

    try {
        if (document.pictureInPictureElement) {
            await document.exitPictureInPicture();
        } else if (document.pictureInPictureEnabled) {
            await video.requestPictureInPicture();
        } else {
            showToast("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©");
        }
    } catch (err) {
        console.error(err);
        showToast("ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ PiP");
    }
}

async function markNotInterested() {
    closeAllSheets();
    if (!currentUser) return;

    // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UX Ø³Ø±ÙŠØ¹)
    const slide = document.getElementById(`slide-${currentOpenVideoId}`);
    if (slide) {
        slide.style.transition = "transform 0.3s, opacity 0.3s";
        slide.style.transform = "translateX(-100%)";
        slide.style.opacity = "0";
        setTimeout(() => slide.remove(), 300);
    }

    showToast("Ø³Ù†Ø­Ø§ÙˆÙ„ Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø£Ù‚Ù„ Ù…Ø«Ù„ Ù‡Ø°Ø§ ğŸ‘");

    // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±ØºØ¨Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    try {
        await db.collection('users').doc(currentUser.uid).collection('not_interested').doc(currentOpenVideoId).set({
            postId: currentOpenVideoId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (e) { console.error(e); }
}

function openSleepTimerSettings() {
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ù…Ù„ Ù‚Ø§Ø¦Ù…Ø© ÙØ±Ø¹ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù‡Ù†Ø§ØŒ Ø³Ø£Ø¶Ø¹ Ù…Ø«Ø§Ù„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù€ 15 Ø¯Ù‚ÙŠÙ‚Ø©
    const minutes = prompt("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", "15");
    if (minutes && !isNaN(minutes)) {
        closeAllSheets();
        const ms = parseInt(minutes) * 60 * 1000;
        showToast(`Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ğŸ˜´`);
        
        setTimeout(() => {
            const currentVideo = document.querySelector('video:not([paused])');
            if (currentVideo) currentVideo.pause();
            alert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ù…Ø¤Ù‚Øª! ØªØµØ¨Ø­ Ø¹Ù„Ù‰ Ø®ÙŠØ± ğŸŒ™");
        }, ms);
    }
}

function copyLinkAtTime() {
    const video = document.getElementById(`vid-${currentOpenVideoId}`);
    if (!video) return;

    const time = Math.floor(video.currentTime);
    const url = `${window.location.origin}${window.location.pathname}?video=${currentOpenVideoId}&t=${time}`;
    
    navigator.clipboard.writeText(url);
    showToast(`ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${time} Ø«Ø§Ù†ÙŠØ© â±ï¸`);
}

function showVideoStats() {
    const video = document.getElementById(`vid-${currentOpenVideoId}`);
    const width = video.videoWidth;
    const height = video.videoHeight;
    const type = video.src.split('.').pop();
    
    alert(`ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:\n- Ø§Ù„Ø¯Ù‚Ø©: ${width}x${height}\n- Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯: ${type}\n- Ø§Ù„Ù…Ø¯Ø©: ${Math.floor(video.duration)} Ø«Ø§Ù†ÙŠØ©`);
}
// Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù…Ø§Ø³Ùƒ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ±
let isAutoScrollEnabled = false;

function toggleAutoScroll() {
    isAutoScrollEnabled = !isAutoScrollEnabled;
    
    // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const status = document.getElementById('autoScrollStatus');
    const icon = document.getElementById('autoScrollIcon');
    if(status && icon) {
        if (isAutoScrollEnabled) {
            status.innerText = "Ù…ÙØ¹Ù„";
            status.style.color = "#4cd964";
            icon.style.color = "#4cd964";
            showToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ğŸ”„");
        } else {
            status.innerText = "Ù…Ø¹Ø·Ù„";
            status.style.color = "#555";
            icon.style.color = "#aaa";
            showToast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ");
        }
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠ Ø´ØºØ§Ù„
    // Ø¹Ø´Ø§Ù† Ù„Ùˆ ÙØ¹Ù„ØªÙ‡ ÙˆØ§Ù†Øª Ø¨ØªØªÙØ±Ø¬ØŒ ÙŠÙ‚Ù„Ø¨ Ù„ÙˆØ­Ø¯Ù‡ Ù„Ù…Ø§ ÙŠØ®Ù„Øµ Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªÙ‚Ù„Ø¨ ÙˆØªÙŠØ¬ÙŠ ØªØ§Ù†ÙŠ
    if (currentOpenVideoId) {
        const currentVid = document.getElementById(`vid-${currentOpenVideoId}`);
        applyAutoScrollLogic(currentVid, currentOpenVideoId);
    }
}

function applyAutoScrollLogic(vid, id) {
    if (!vid) return;

    if (isAutoScrollEnabled) {
        // Ù„Ùˆ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…ÙØ¹Ù„: Ø§Ù„ØºÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø´Ø§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ®Ù„Øµ
        vid.loop = false;
        
        // Ù„Ù…Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ®Ù„ØµØŒ Ù†ÙØ° Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
        vid.onended = function() {
            const currentSlide = document.getElementById(`slide-${id}`);
            const nextSlide = currentSlide ? currentSlide.nextElementSibling : null;
            
            if (nextSlide) {
                // Ø±ÙˆØ­ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡ Ø¨Ù†Ø¹ÙˆÙ…Ø©
                nextSlide.scrollIntoView({ behavior: "smooth" });
            } else {
                // Ù„Ùˆ Ù…ÙÙŠØ´ ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¹Ø¯Ù‡ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ù…Ù„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                loadVideos(); 
            }
        };
    } else {
        // Ù„Ùˆ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø·Ù„: Ø±Ø¬Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± (Loop) ÙˆØ´ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        vid.loop = true;
        vid.onended = null;
    }
}


// Ø¯Ø§Ù„Ø© ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ
function checkAutoScroll(id) {
    if (!isAutoScrollEnabled) return;
    
    const vid = document.getElementById(`vid-${id}`);
    if (vid) {
        vid.loop = false; // Ù†Ù„ØºÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ÙŠØ®Ù„Øµ ÙŠÙ†Ù‚Ù„
        vid.onended = () => {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ§Ù„ÙŠ
            const currentSlide = document.getElementById(`slide-${id}`);
            const nextSlide = currentSlide.nextElementSibling;
            if (nextSlide) {
                nextSlide.scrollIntoView({ behavior: "smooth" });
            } else {
                // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù„Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆØŒ Ù†Ø­Ù…Ù„ Ø§Ù„Ù…Ø²ÙŠØ¯
                loadVideos(); 
            }
        };
    }
}

function showQRCode() {
    // Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const url = `${window.location.origin}${window.location.pathname}?video=${currentOpenVideoId}`;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ù…Ø¬Ø§Ù†ÙŠ Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ QR
    const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
    
    document.getElementById('qrImage').src = qrApi;
    document.getElementById('qrModal').style.display = 'flex';
}

function copyCaption() {
    const slide = document.getElementById(`slide-${currentOpenVideoId}`);
    if (slide) {
        const descElement = slide.querySelector('.video-desc');
        if (descElement) {
            const text = descElement.innerText;
            navigator.clipboard.writeText(text);
            showToast("ØªÙ… Ù†Ø³Ø® ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ğŸ“‹");
        } else {
            showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù„Ù†Ø³Ø®");
        }
    }
}

// Ø¯Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Loop)
// Ø¯Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Loop)
// Ø¯Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Loop)
function toggleVideoLoop() {
    if (!currentOpenVideoId) return;

    const vid = document.getElementById(`vid-${currentOpenVideoId}`);
    const icon = document.getElementById('loopIcon');
    const status = document.getElementById('loopStatus');

    if (vid) {
        if (vid.loop) {
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙƒØ±Ø§Ø±
            vid.loop = false;
            if(icon) icon.style.color = "#555";
            if(status) {
                status.innerText = "Ù…Ø¹Ø·Ù„";
                status.style.color = "#555";
            }
            showToast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙƒØ±Ø§Ø± ğŸ›‘");
        } else {
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
            vid.loop = true;
            if(icon) icon.style.color = "#4cd964";
            if(status) {
                status.innerText = "Ù…ÙØ¹Ù„";
                status.style.color = "#4cd964";
            }
            showToast("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø± ğŸ”");
        }
    }
}

let turboTimer;

function startTurboMode(id) {
    // Ù†Ù†ØªØ¸Ø± 300ms Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡Ø§ Ù…Ø´ Ø¶ØºØ·Ø© Ø¹Ø§Ø¯ÙŠØ© (Click)
    turboTimer = setTimeout(() => {
        const vid = document.getElementById(`vid-${id}`);
        const overlay = document.getElementById(`speedOverlay-${id}`);

        if (vid && !vid.paused) { // Ù†Ø´ØªØºÙ„ Ø¨Ø³ Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„
            vid.playbackRate = 2.0; // Ø§Ù„Ø³Ø±Ø¹Ø© Ã—2
            if (overlay) overlay.classList.add('active');
            if (navigator.vibrate) navigator.vibrate(30); // Ù‡Ø²Ø© Ø¨Ø³ÙŠØ·Ø©
        }
    }, 400); // Ø²Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø©
}

function stopTurboMode(id) {
    // Ù„Ùˆ Ø´Ø§Ù„ ØµØ¨Ø§Ø¹Ù‡ Ù‚Ø¨Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ØŒ Ù†Ù„ØºÙŠ Ø§Ù„Ø£Ù…Ø± (Ø¹Ø´Ø§Ù† Ø§Ù„Ø¶ØºØ·Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ØªØ´ØªØºÙ„)
    clearTimeout(turboTimer);

    const vid = document.getElementById(`vid-${id}`);
    const overlay = document.getElementById(`speedOverlay-${id}`);

    if (vid) {
        vid.playbackRate = 1.0; // Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
        if (overlay) overlay.classList.remove('active');
    }
}

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… ÙˆÙˆÙ‚Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function updateVideoMeta(id) {
    const vid = document.getElementById(`vid-${id}`);
    const sizeSpan = document.getElementById('vSize');
    const timeSpan = document.getElementById('vTime');

    if (vid && !isNaN(vid.duration)) {
        // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª (Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚:Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)
        const m = Math.floor(vid.duration / 60).toString().padStart(2, '0');
        const s = Math.floor(vid.duration % 60).toString().padStart(2, '0');
        timeSpan.innerText = `${m}:${s}`;

        // 2. ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø­Ø¬Ù… (Size Estimation)
        // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ù…Ù„Ùƒ Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø± (Blob) Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªÙ‚Ø¯ÙŠØ± Ø°ÙƒÙŠ
        // Ù…Ø¹Ø§Ø¯Ù„Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: Ù…ØªÙˆØ³Ø· ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¬ÙŠØ¯ = 0.2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª Ù„ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        // Ø£Ùˆ Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ Ø·Ù„Ø¨ HEAD Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ÙŠØ³Ù…Ø­ (Ù„ÙƒÙ† Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø£Ø³Ø±Ø¹ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©)
        
        let estimatedSize = (vid.duration * 0.25).toFixed(1); // 0.25 MB per second avg
        sizeSpan.innerText = `${estimatedSize} MB`;
        
        // Ù„Ùˆ Ø¹Ø§ÙŠØ² Ø¯Ù‚Ø© 100% Ù…Ù…ÙƒÙ† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        // fetchFileSize(vid.src); 
    } else {
        timeSpan.innerText = "00:00";
        sizeSpan.innerText = "0 MB";
    }
}

function setSpeed(rate, btnElement) {
    // 1. ØªØºÙŠÙŠØ± Ø³Ø±Ø¹Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    const vid = document.getElementById(`vid-${currentOpenVideoId}`);
    if (vid) {
        vid.playbackRate = rate;
        showToast(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø© Ø¥Ù„Ù‰ ${rate}x ğŸš€`);
    }

    // 2. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§ÙŠØ± (UI)
    // Ø£ÙˆÙ„Ø§Ù‹: Ù†Ø´ÙŠÙ„ ÙƒÙ„Ø§Ø³ 'active' Ù…Ù† ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§ÙŠØ±
    document.querySelectorAll('.sp-btn').forEach(b => b.classList.remove('active'));
    
    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù†Ø¶ÙŠÙ ÙƒÙ„Ø§Ø³ 'active' Ù„Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ù„ÙŠ Ø¯Ø§Ø³ Ø¹Ù„ÙŠÙ‡
    if(btnElement) {
        btnElement.classList.add('active');
    }
}

let currentSoundData = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹

// 1. ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØµÙˆØª
let previewAudio = new Audio();
let isPreviewPlaying = false;
// Ù…ØªØºÙŠØ± Ù„ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
let isSoundLoading = false;

async function openSoundPage(soundName, authorName, soundImg, directUrl = null) {
    const page = document.getElementById('soundPage');
    const useBtn = document.querySelector('.use-sound-btn');
    
    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('soundPageTitle').innerText = soundName || "Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ";
    document.getElementById('soundPageAuthor').innerText = authorName || "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶";
    
    // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ù„ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if(useBtn) {
        useBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØª...';
        useBtn.style.opacity = "0.7";
        useBtn.style.pointerEvents = "none"; // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ù…Ø¤Ù‚ØªØ§Ù‹
    }

    const disc = document.getElementById('soundPageDisc');
    // Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ Event Listeners Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    const newDisc = disc.cloneNode(true);
    disc.parentNode.replaceChild(newDisc, disc);
    
    newDisc.style.backgroundImage = soundImg ? `url('${soundImg}')` : 'none';

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©
    currentSoundData = {
        name: soundName,
        author: authorName,
        img: soundImg,
        url: directUrl 
    };

    // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ØªÙˆÙØ±Ø§Ù‹
    if (!currentSoundData.url) {
        try {
            // Ù†Ø¨Ø­Ø« Ø¹Ù† ÙÙŠØ¯ÙŠÙˆ ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª
            const snap = await db.collection('posts')
                .where('musicName', '==', soundName)
                .limit(1)
                .get();

            if (!snap.empty) {
                const vid = snap.docs[0].data().media.find(m => m.type === 'video');
                if (vid) {
                    currentSoundData.url = vid.url; // Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø³ÙŠØ³ØªØ®Ø¯Ù… ÙƒØµÙˆØª
                }
            }
        } catch (e) {
            console.error("Error fetching sound source:", e);
        }
    }

    // 4. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø£Ùˆ Ø§Ù„ÙØ´Ù„)
    if(useBtn) {
        if(currentSoundData.url) {
            useBtn.innerHTML = '<i class="fa-solid fa-video"></i> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØª';
            useBtn.style.opacity = "1";
            useBtn.style.pointerEvents = "auto";
        } else {
            useBtn.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­';
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø©
    newDisc.onclick = () => {
        if (!currentSoundData.url) {
            showToast("âš ï¸ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„ØªØ´ØºÙŠÙ„");
            return;
        }
        togglePreviewSound(currentSoundData.url, newDisc);
    };

    checkSoundFavorite(soundName);
    page.classList.add('active');
    loadVideosBySound(soundName);
}


function closeSoundPage() {
    document.getElementById('soundPage').classList.remove('active');
}

// 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ØµÙˆØª
async function loadVideosBySound(soundName) {
    const grid = document.getElementById('soundVideosGrid');
    grid.innerHTML = '<div class="loading-state"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

    try {
        // Ø¨Ù†Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª Ø¹Ù† Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ù… Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙØ¶Ù„ ØªØ¹Ù…Ù„ Index ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù„Ù„Ø­Ù‚Ù„ Ø¯Ù‡
        const snapshot = await db.collection('posts')
            .where('musicName', '==', soundName)
            .limit(20)
            .get();

        document.getElementById('soundPageCount').innerText = `${snapshot.size} ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª`;
        grid.innerHTML = '';

        if (snapshot.empty) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#555;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø£Ø®Ø±Ù‰ Ø¨Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª</div>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const vid = data.media.find(m => m.type === 'video');
            if(vid) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØµØºØ±
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.onclick = () => { openSingleVideo(doc.id); }; // ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                item.innerHTML = `
                    <video src="${vid.url}#t=1.0" muted preload="metadata" style="pointer-events:none;"></video>
                    <div class="grid-overlay"><i class="fa-solid fa-play"></i> ${data.views || 0}</div>
                `;
                grid.appendChild(item);
            }
        });

    } catch (e) {
        console.error(e);
        grid.innerHTML = '<div style="text-align:center; padding:20px; color:red">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
    }
}

// 3. Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©
async function toggleSoundFavorite() {
    if(!currentUser || !currentSoundData) return;

    const btn = document.getElementById('soundFavBtn');
    const soundId = currentSoundData.name; // Ù‡Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… ÙƒÙ€ ID Ù…Ø¤Ù‚ØªØ§Ù‹
    const ref = db.collection('users').doc(currentUser.uid).collection('favorite_sounds').doc(soundId);

    if (btn.classList.contains('active')) {
        // Ø¥Ø²Ø§Ù„Ø©
        await ref.delete();
        btn.classList.remove('active');
        btn.innerHTML = `<i class="fa-regular fa-bookmark"></i> Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©`;
        showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©");
    } else {
        // Ø¥Ø¶Ø§ÙØ©
        await ref.set({
            name: currentSoundData.name,
            author: currentSoundData.author,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        btn.classList.add('active');
        btn.innerHTML = `<i class="fa-solid fa-bookmark"></i> ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©`;
        showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØª âœ…");
    }
}

// ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
async function checkSoundFavorite(soundId) {
    if(!currentUser) return;
    const btn = document.getElementById('soundFavBtn');
    const doc = await db.collection('users').doc(currentUser.uid).collection('favorite_sounds').doc(soundId).get();
    
    if(doc.exists) {
        btn.classList.add('active');
        btn.innerHTML = `<i class="fa-solid fa-bookmark"></i> ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©`;
    } else {
        btn.classList.remove('active');
        btn.innerHTML = `<i class="fa-regular fa-bookmark"></i> Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©`;
    }
}

// 4. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª (ÙˆÙ‡Ù…ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹)
function useThisSound() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·
    if (!currentSoundData || !currentSoundData.url) {
        showToast("â³ Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª...");
        return;
    }

    // ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ…Ø±ÙŠØ±Ù‡Ø§ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø£Ù…Ø§Ù†
    const params = new URLSearchParams({
        soundName: currentSoundData.name,
        soundAuthor: currentSoundData.author || 'Ù…Ø³ØªØ®Ø¯Ù…',
        soundUrl: currentSoundData.url,
        soundImg: currentSoundData.img || ''
    }).toString();

    // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ø´Ø± (Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯Ùƒ)
    // Ø§ÙØªØ±Ø¶Ù†Ø§ Ø£Ù† Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù†Ø´Ø± Ù‡Ùˆ create_media.html ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
    window.location.href = `create_media.html?${params}`;
}


function togglePreviewSound(url, discElement) {
    const icon = discElement.querySelector('i');

    if (isPreviewPlaying) {
        // Ø¥ÙŠÙ‚Ø§Ù
        previewAudio.pause();
        isPreviewPlaying = false;
        icon.className = "fa-solid fa-play";
        discElement.style.animation = "none"; // ÙˆÙ‚Ù Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
    } else {
        // ØªØ´ØºÙŠÙ„
        // Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§ØªØºÙŠØ±ØŒ Ù†Ø­Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (previewAudio.src !== url) {
            previewAudio.src = url;
        }
        
        previewAudio.play().then(() => {
            isPreviewPlaying = true;
            icon.className = "fa-solid fa-pause";
            discElement.style.animation = "spinDisc 4s linear infinite"; // Ø´ØºÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
        }).catch(e => {
            console.error(e);
            showToast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª âŒ");
        });
    }
    
    // Ù„Ù…Ø§ Ø§Ù„ØµÙˆØª ÙŠØ®Ù„Øµ Ù„ÙˆØ­Ø¯Ù‡
    previewAudio.onended = () => {
        isPreviewPlaying = false;
        icon.className = "fa-solid fa-play";
        discElement.style.animation = "none";
    };
}

function syncAudio(vid, id) {
    const audio = document.getElementById(`audio-${id}`);
    if (!audio) return; // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØªØŒ Ø§Ø®Ø±Ø¬

    // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„ ÙˆØ§Ù„ØµÙˆØª ÙˆØ§Ù‚ÙØŒ Ø´ØºÙ„Ù‡
    if (!vid.paused && audio.paused && !isGlobalMuted) {
        audio.play().catch(e => {});
    }

    // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ‚ÙØŒ ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª
    if (vid.paused && !audio.paused) {
        audio.pause();
    }

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙˆÙ‚Øª
    if (Math.abs(vid.currentTime - audio.currentTime) > 0.5) {
        audio.currentTime = vid.currentTime;
    }

    // Ø§Ù„ØªÙƒØ±Ø§Ø± (Loop)
    if (vid.ended || vid.currentTime < 0.2) {
        if (audio.currentTime > 1) {
             audio.currentTime = 0;
             if(!vid.paused && !isGlobalMuted) audio.play();
        }
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©
async function sendNotification(recipientUid, type, text, postId = null) {
    if (!currentUser || currentUser.uid === recipientUid) return; // Ù„Ø§ ØªØ±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù†ÙØ³Ùƒ

    try {
        await db.collection('notifications').add({
            recipientId: recipientUid,     // Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ³ØªÙ„Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            senderUid: currentUser.uid,    // Ø£Ù†Øª (Ø§Ù„Ù…Ø±Ø³Ù„)
            senderName: currentUserData.name || "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶",
            senderPic: currentUserData.profilePic || "",
            isVerified: currentUserData.isVerified || false,
            type: type,                    // 'like', 'comment', 'gift', etc.
            text: text,                    // Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹: "Ø£Ø¹Ø¬Ø¨ Ø¨ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Øµ Ø¨Ùƒ")
            postId: postId,                // Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
            opened: false,                 // Ù„Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            read: false,                   // Ù„Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
            isGhost: isGhost,              // Ù‡Ù„ Ø£Ù†Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø¨Ø­ØŸ
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", e);
    }
}

function listenToUnreadNotifications() {
    if(!currentUser) return;
    db.collection('notifications')
      .where('recipientId', '==', currentUser.uid)
      .where('read', '==', false)
      .onSnapshot(snap => {
          const dot = document.getElementById('notif-dot');
          if(snap.size > 0) {
              dot.style.display = 'block'; // Ø£Ø¸Ù‡Ø± Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡
          } else {
              dot.style.display = 'none';
          }
      });
}


    </script>
    
    <div class="lightbox" id="imgLightbox" onclick="closeLightbox()">
    <span class="lb-close">&times;</span>
    <img class="lb-img" id="lbImage">
    </div>

    <div id="cinemaOverlay" class="fs-overlay">
    <video id="fsVideoPlayer" class="fs-video-element" loop playsinline></video>
    
    <div class="fs-center-btn" id="fsPlayIcon" onclick="toggleFsPlay()">
        <i class="fa-solid fa-play"></i>
    </div>

    <div class="fs-control-bar" onclick="event.stopPropagation()">
        <div class="vid-btn" onclick="toggleFsMute()">
            <i class="fa-solid fa-volume-high" id="fsMuteIcon"></i>
        </div>
        
        <div class="vid-btn vid-speed-btn" id="fsSpeedBtn" onclick="changeFsSpeed(this)" style="margin: 0 10px;">1x</div>
        
        <input type="range" class="audio-slider" id="fsSeeker" value="0" min="0" max="100" step="0.1" oninput="seekFsVideo(this)" style="flex:1; margin: 0 10px;">
        
        <div class="vid-btn" onclick="closeCinemaMode()">
            <i class="fa-solid fa-compress"></i>
        </div>
    </div>
</div>

   <div class="floating-options-sheet" id="commentOptionsSheetNew">
    <div id="cmOwnerOptionsNew" style="display:none; flex-direction:column;">
        <div class="compact-option" onclick="triggerEditComment()">
            <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„
        </div>
        <div class="compact-option" onclick="triggerCopyComment()">
            <i class="fa-regular fa-copy"></i> Ù†Ø³Ø®
        </div>
        <div class="compact-option danger-opt" onclick="triggerDeleteComment()">
            <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
        </div>
    </div>

    <div id="cmViewerOptionsNew" style="display:none; flex-direction:column;">
        <div class="compact-option" onclick="triggerReplyComment()">
            <i class="fa-solid fa-reply"></i> Ø±Ø¯
        </div>
        <div class="compact-option" onclick="triggerCopyComment()">
            <i class="fa-regular fa-copy"></i> Ù†Ø³Ø®
        </div>
        <div class="compact-option danger-opt" onclick="reportComment()">
            <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº
        </div>
    </div>

    <div class="cancel-btn-compact" onclick="closeFloatingMenu()">
        Ø¥Ù„ØºØ§Ø¡
    </div>
</div>

<div id="optionsBackdrop" class="popup-backdrop" onclick="closeFloatingMenu()"></div>
 
 <div class="sheet-overlay" id="overlay" onclick="handleSmartOverlayClick()"></div>
<div class="gift-backdrop-layer" id="giftBackdrop" onclick="GiftSystem.closeGiftOnly()"></div>

<div class="top-nav-bar">
    <div class="nav-icon-btn" onclick="window.location.href='home.html'">
        <i class="fa-solid fa-house"></i>
    </div>
<div class="nav-icon-btn" onclick="window.location.href='notifications.html'" style="position: relative;">
    <i class="fa-solid fa-bell"></i>
    <span id="notif-dot" style="
        display: none;
        position: absolute;
        top: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background-color: #ff3b30;
        border: 2px solid #000;
        border-radius: 50%;
        z-index: 10;
    "></span>
</div>

    <div class="nav-tabs">
        <span class="nav-tab" onclick="switchFeedTab('friends')" id="tab-friends">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
        <span class="nav-tab" onclick="switchFeedTab('popular')" id="tab-popular">Ø´Ø§Ø¦Ø¹</span>
        <span class="nav-tab active" onclick="switchFeedTab('world')" id="tab-world">Ø§Ù„Ø¹Ø§Ù„Ù…</span>
    </div>

    <div class="nav-create-btn center-btn" onclick="window.location.href='create_media.html'">
        <i class="fa-solid fa-plus"></i>
    </div>
    
    <div style="display: flex; align-items: center; gap: 10px;">
        <div class="nav-icon-btn" onclick="openSearchScreen()">
            <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <div class="nav-icon-btn" onclick="openLibraryMenu()">
            <i class="fa-solid fa-bars-staggered"></i>
        </div>
    </div>
</div>


<div class="search-overlay" id="searchScreen">
    <div class="search-header">
        <div class="search-input-box">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª..." onkeyup="handleSearch(this)">
            <i class="fa-solid fa-xmark" id="clearSearch" style="display:none" onclick="clearSearchInput()"></i>
        </div>
        <span style="font-weight:bold; font-size:14px; margin-right:10px;" onclick="closeSearchScreen()">Ø¥Ù„ØºØ§Ø¡</span>
    </div>
    
    <div class="search-tabs">
        <div class="s-tab active" onclick="switchSearchFilter('users', this)">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
        <div class="s-tab" onclick="switchSearchFilter('videos', this)">ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</div>
    </div>

    <div class="search-results" id="searchResultsArea">
        <div style="text-align:center; margin-top:50px; color:#777;">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø§ ØªØ±ÙŠØ¯...</div>
    </div>
</div>


<div class="bottom-sheet" id="shareSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <h3 style="text-align:center; padding:15px; color:#fff;">Ù…Ø´Ø§Ø±ÙƒØ© Ø¥Ù„Ù‰</h3>
    
    <div class="share-grid">
        <div class="share-item" onclick="shareTo('whatsapp')">
            <div class="share-icon" style="background:#25D366"><i class="fa-brands fa-whatsapp"></i></div>
            <span>ÙˆØ§ØªØ³Ø§Ø¨</span>
        </div>
        <div class="share-item" onclick="shareTo('facebook')">
            <div class="share-icon" style="background:#1877F2"><i class="fa-brands fa-facebook-f"></i></div>
            <span>ÙÙŠØ³Ø¨ÙˆÙƒ</span>
        </div>
        <div class="share-item" onclick="shareTo('copy')">
            <div class="share-icon" style="background:#ffb533"><i class="fa-solid fa-link"></i></div>
            <span>Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</span>
        </div>
        <div class="share-item" onclick="saveVideoLocally()">
            <div class="share-icon" style="background:#333"><i class="fa-solid fa-download"></i></div>
            <span>Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
        </div>
    </div>
</div>

<div class="bottom-sheet" id="libraryMenuSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <div class="cm-header">
        <span style="flex:1; text-align:center;">Ù…ÙƒØªØ¨ØªÙŠ</span>
        <i class="fa-solid fa-xmark" onclick="closeLibraryMenu()" style="cursor:pointer; padding:5px"></i>
    </div>
    
    <div class="menu-list">
        <div class="menu-item" onclick="openLibraryPage('saved')">
            <i class="fa-solid fa-bookmark" style="color:#FFD700"></i>
            <span class="menu-text">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span>
            <i class="fa-solid fa-chevron-left" style="font-size:12px; color:#555"></i>
        </div>

<div class="menu-item" onclick="toggleAddFavorite(currentOpenVideoId); closeAllSheets();">
    <i class="fa-solid fa-star" id="menuFavIcon" style="color:#fff"></i>
    <span class="menu-text" id="menuFavText">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©</span>
</div>

        <div class="menu-item" onclick="openLibraryPage('history')">
            <i class="fa-solid fa-clock-rotate-left" style="color:#4CC9F0"></i>
            <span class="menu-text">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (30 ÙŠÙˆÙ…)</span>
            <i class="fa-solid fa-chevron-left" style="font-size:12px; color:#555"></i>
        </div>

        <div class="menu-item" onclick="openLibraryPage('search_history')">
            <i class="fa-solid fa-magnifying-glass" style="color:#bf5af2"></i>
            <span class="menu-text">Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø­Ø«</span>
            <i class="fa-solid fa-chevron-left" style="font-size:12px; color:#555"></i>
        </div>
        <div class="menu-item" onclick="window.location.href='blocked.html'">
    <i class="fa-solid fa-user-slash" style="color:#ff3b30"></i>
    <span class="menu-text">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</span>
    <i class="fa-solid fa-chevron-left" style="font-size:12px; color:#555"></i>
</div>

    </div>
</div>

<div class="full-screen-page" id="libraryPage">
    <div class="fs-header">
        <div class="fs-back-btn" onclick="closeLibraryPage()">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <div class="fs-title" id="libraryTitle">Ù…ÙƒØªØ¨ØªÙŠ</div>
        <div style="width: 40px;"></div> 
    </div>

 <div class="fs-tabs">
    <div class="fs-tab" id="tab-saved" onclick="switchLibraryTab('saved')"><i class="fa-solid fa-bookmark"></i></div>
    <div class="fs-tab" id="tab-favorites" onclick="switchLibraryTab('favorites')"><i class="fa-solid fa-heart"></i></div>
    <div class="fs-tab" id="tab-sounds" onclick="switchLibraryTab('sounds')"><i class="fa-solid fa-music"></i></div>
    <div class="fs-tab" id="tab-history" onclick="switchLibraryTab('history')"><i class="fa-solid fa-clock"></i></div>
    <div class="fs-tab" id="tab-search_history" onclick="switchLibraryTab('search_history')"><i class="fa-solid fa-magnifying-glass"></i></div>
</div>


    <div class="fs-content-area" id="libraryGrid">
        <div class="loading-state">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </div>
    </div>
</div>


<div class="bottom-sheet" id="videoOptionsSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <div class="menu-list">
        
        <div class="menu-item" onclick="markNotInterested();">
            <i class="fa-solid fa-face-frown" style="color:#aaa"></i>
            <span class="menu-text">ØºÙŠØ± Ù…Ù‡ØªÙ…</span>
            <span class="menu-value" style="background:none; color:#555; font-size:10px;">Ø¥Ø®ÙØ§Ø¡</span>
        </div>

        <div class="menu-item" onclick="openCinemaMode(); closeAllSheets();">
            <i class="fa-solid fa-expand" style="color:#4CC9F0"></i>
            <span class="menu-text">ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠÙ†Ù…Ø§</span>
        </div>

        <div class="menu-item" onclick="toggleAddFavorite(currentOpenVideoId); closeAllSheets();">
            <i class="fa-solid fa-star" style="color:#FFD700"></i>
            <span class="menu-text">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©</span>
        </div>
        
        <div class="menu-item" onclick="toggleAutoScroll(); closeAllSheets();">
            <i class="fa-solid fa-arrows-rotate" id="autoScrollIcon" style="color:#aaa"></i>
            <span class="menu-text">Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
            <span class="menu-value" id="autoScrollStatus">Ù…Ø¹Ø·Ù„</span>
        </div>
        
        <div class="menu-item" onclick="toggleVideoLoop();">
            <i class="fa-solid fa-repeat" id="loopIcon" style="color:#4cd964"></i>
            <span class="menu-text">ØªÙƒØ±Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
            <span class="menu-value" id="loopStatus" style="color:#4cd964">Ù…ÙØ¹Ù„</span>
        </div>

<div class="menu-item" onclick="downloadVideoAction();">
    <i class="fa-solid fa-download" style="color:#34c759"></i>
    <span class="menu-text">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
    <div id="videoMetaInfo" class="meta-badge">
        <span id="vSize">-- MB</span> â€¢ <span id="vTime">--:--</span>
    </div>
</div>
<div class="menu-item" style="justify-content: space-between; cursor: default;">
    
    <div class="speed-control-group">
        <div class="sp-btn" onclick="setSpeed(2.0, this)">2.0x</div>
        <div class="sp-btn" onclick="setSpeed(1.5, this)">1.5x</div>
        <div class="sp-btn active" onclick="setSpeed(1.0, this)" id="defaultSpeedBtn">1.0x</div>
        <div class="sp-btn" onclick="setSpeed(0.5, this)">0.5x</div>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
        <span class="menu-text">Ø§Ù„Ø³Ø±Ø¹Ø©</span>
        <i class="fa-solid fa-gauge-high" style="color:#fff"></i>
    </div>

</div>

        
        <div class="menu-item" onclick="togglePiP(); closeAllSheets();">
            <i class="fa-solid fa-clone" style="color:#ffffff"></i>
            <span class="menu-text">ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø© (PiP)</span>
        </div>

        <div class="menu-item" onclick="openPrivacySettings()">
            <i class="fa-solid fa-comment-slash" style="color:#aaa"></i>
            <span class="menu-text">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
        </div>

        <div class="menu-item" onclick="openSleepTimerSettings();">
            <i class="fa-solid fa-stopwatch" style="color:#FF9F0A"></i>
            <span class="menu-text">Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ…</span>
        </div>

        <div class="menu-item" onclick="copyLinkAtTime(); closeAllSheets();">
            <i class="fa-solid fa-link" style="color:#4CC9F0"></i>
            <span class="menu-text">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· (Ø¹Ù†Ø¯ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª)</span>
        </div>

        <div class="menu-item" onclick="closeAllSheets(); setTimeout(showQRCode, 300);">
            <i class="fa-solid fa-qrcode" style="color:#fff"></i>
            <span class="menu-text">Ø±Ù…Ø² QR Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©</span>
        </div>

        <div class="menu-item" onclick="copyCaption(); closeAllSheets();">
            <i class="fa-regular fa-copy" style="color:#4CC9F0"></i>
            <span class="menu-text">Ù†Ø³Ø® Ø§Ù„ÙˆØµÙ</span>
        </div>

        <div class="menu-item" onclick="showVideoStats(); closeAllSheets();">
            <i class="fa-solid fa-chart-simple" style="color:#34c759"></i>
            <span class="menu-text">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
        </div>

        <div id="viewerVideoActions">
            <div class="menu-divider"></div>
            <div class="menu-item danger" onclick="reportVideo();">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span class="menu-text">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span>
            </div>
            <div class="menu-item danger" onclick="blockUserAction();">
                <i class="fa-solid fa-user-xmark"></i>
                <span class="menu-text">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
            </div>
        </div>

        <div id="ownerVideoActions" style="display: none; flex-direction: column;">
            <div class="menu-divider"></div>
            <div class="menu-item danger" onclick="deleteVideoAction()">
                <i class="fa-solid fa-trash-can"></i>
                <span class="menu-text">Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</span>
            </div>
        </div>

    </div>
</div>

<div class="bottom-sheet" id="reportSheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <div class="cm-header">
        <span style="flex:1; text-align:center; color:var(--danger-color)">
            <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø­ØªÙˆÙ‰
        </span>
        <i class="fa-solid fa-xmark" onclick="closeReportSheet()" style="cursor:pointer; padding:5px"></i>
    </div>
    
    <div class="menu-list">
        <p style="padding:10px 15px; color:#aaa; font-size:12px;">Ø³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ ÙÙ‡Ù… Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ù…Ø§Ø°Ø§ ÙŠØ­Ø¯Ø«ØŸ</p>
        
        <div class="menu-item" onclick="submitReport('Ù…Ø­ØªÙˆÙ‰ Ø¥Ø¨Ø§Ø­ÙŠ Ø£Ùˆ Ø¬Ù†Ø³ÙŠ')">
            <span class="menu-text">Ù…Ø­ØªÙˆÙ‰ Ø¥Ø¨Ø§Ø­ÙŠ Ø£Ùˆ Ø¬Ù†Ø³ÙŠ</span>
        </div>
        <div class="menu-item" onclick="submitReport('Ø¹Ù†Ù Ø£Ùˆ Ø¥ÙŠØ°Ø§Ø¡ Ù„Ù„Ù†ÙØ³')">
            <span class="menu-text">Ø¹Ù†Ù Ø£Ùˆ Ø¥ÙŠØ°Ø§Ø¡ Ù„Ù„Ù†ÙØ³</span>
        </div>
        <div class="menu-item" onclick="submitReport('ØªÙ†Ù…Ø± Ø£Ùˆ Ù…Ø¶Ø§ÙŠÙ‚Ø©')">
            <span class="menu-text">ØªÙ†Ù…Ø± Ø£Ùˆ Ù…Ø¶Ø§ÙŠÙ‚Ø©</span>
        </div>
        <div class="menu-item" onclick="submitReport('Ø®Ø·Ø§Ø¨ ÙƒØ±Ø§Ù‡ÙŠØ©')">
            <span class="menu-text">Ø®Ø·Ø§Ø¨ ÙƒØ±Ø§Ù‡ÙŠØ©</span>
        </div>
        <div class="menu-item" onclick="submitReport('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø²Ø§Ø¦ÙØ© Ø£Ùˆ Ø§Ø­ØªÙŠØ§Ù„')">
            <span class="menu-text">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø²Ø§Ø¦ÙØ© Ø£Ùˆ Ø§Ø­ØªÙŠØ§Ù„</span>
        </div>
        <div class="menu-item" onclick="submitReport('Ø³Ø¨Ø§Ù… Ø£Ùˆ Ù…Ø­ØªÙˆÙ‰ Ù…ÙƒØ±Ø±')">
            <span class="menu-text">Ø³Ø¨Ø§Ù… (Spam)</span>
        </div>
    </div>
</div>

<div class="bottom-sheet" id="commentPrivacySheet" style="height: auto;">
    <div class="sheet-handle"></div>
    <div class="cm-header">
        <span style="flex:1; text-align:center;">Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ</span>
        <i class="fa-solid fa-xmark" onclick="closePrivacySheet()" style="cursor:pointer; padding:5px"></i>
    </div>
    
    <div class="menu-list" style="padding: 10px;">
        
        <label class="privacy-option" onclick="setPrivacy('public')">
            <div class="p-info">
                <span class="p-title"><i class="fa-solid fa-earth-americas"></i> Ø§Ù„Ø¹Ø§Ù…Ø©</span>
                <span class="p-desc">ÙŠÙ…ÙƒÙ† Ù„Ø£ÙŠ Ø´Ø®Øµ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span>
            </div>
            <input type="radio" name="c_privacy" id="p_public" checked>
            <span class="radio-mark"></span>
        </label>

        <label class="privacy-option" onclick="setPrivacy('followers')">
            <div class="p-info">
                <span class="p-title"><i class="fa-solid fa-users"></i> Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙˆÙ†</span>
                <span class="p-desc">Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† ÙŠØªØ§Ø¨Ø¹ÙˆÙ†Ùƒ ÙÙ‚Ø·</span>
            </div>
            <input type="radio" name="c_privacy" id="p_followers">
            <span class="radio-mark"></span>
        </label>

        <label class="privacy-option" onclick="setPrivacy('following')">
            <div class="p-info">
                <span class="p-title"><i class="fa-solid fa-user-check"></i> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ§Ø¨Ø¹Ù‡Ø§</span>
                <span class="p-desc">Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† ØªØªØ§Ø¨Ø¹Ù‡Ù… Ø£Ù†Øª ÙÙ‚Ø·</span>
            </div>
            <input type="radio" name="c_privacy" id="p_following">
            <span class="radio-mark"></span>
        </label>

        <label class="privacy-option" onclick="setPrivacy('disabled')">
            <div class="p-info">
                <span class="p-title"><i class="fa-solid fa-lock"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
                <span class="p-desc">Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ø£Ø­Ø¯ Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</span>
            </div>
            <input type="radio" name="c_privacy" id="p_disabled">
            <span class="radio-mark"></span>
        </label>

    </div>
</div>

<script src="block-manager.js"></script>

<script>
    // Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨ØªØ§Ø¹ ØµÙØ­ØªÙƒ
    auth.onAuthStateChanged(user => {
        if(user) {
            // ... Ø£ÙƒÙˆØ§Ø¯Ùƒ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ...
            
            // ğŸ”¥ Ø´ØºÙ‘Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¸Ø± Ù‡Ù†Ø§
            initBlockSystem(user); 
        }
    });
</script>


<div id="qrModal" class="custom-modal" onclick="this.style.display='none'">
    <div class="modal-box" style="background:#fff; color:#000;">
        <h3 style="color:#000; margin-bottom:15px;">Ø§Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h3>
        <img id="qrImage" src="" style="width:200px; height:200px;">
        <p style="margin-top:10px; font-size:12px; color:#555;">Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
    </div>
</div>

<div class="full-screen-page" id="soundPage" style="z-index: 2500; background: #121212;">
    
    <div class="fs-header" style="background: transparent; position: absolute; top: 0; width: 100%; border: none;">
        <div class="fs-back-btn" onclick="closeSoundPage()" style="background: rgba(0,0,0,0.5); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-arrow-right" style="color: #fff;"></i>
        </div>
        <div style="flex: 1;"></div>
        <div class="fs-back-btn" onclick="shareSound()" style="background: rgba(0,0,0,0.5); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
            <i class="fa-solid fa-share" style="color: #fff;"></i>
        </div>
    </div>

    <div class="sound-header-banner">
        <div class="sound-disc-large" id="soundPageDisc">
            <i class="fa-solid fa-play" id="soundPagePlayIcon"></i>
        </div>
        <div class="sound-info-block">
            <h2 id="soundPageTitle">Ø§Ù„ØµÙˆØª Ø§Ù„Ø£ØµÙ„ÙŠ</h2>
            <div class="sound-author" id="soundPageAuthor">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
            <div class="sound-stats" id="soundPageCount">0 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</div>
        </div>
    </div>

    <div class="sound-actions-bar">
        <button class="add-fav-btn" id="soundFavBtn" onclick="toggleSoundFavorite()">
            <i class="fa-regular fa-bookmark"></i> Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©
        </button>
    </div>

    <div class="fs-content-area" id="soundVideosGrid" style="padding-top: 10px; padding-bottom: 80px;">
        </div>

    <div class="use-sound-footer">
        <button class="use-sound-btn" onclick="useThisSound()">
            <i class="fa-solid fa-video"></i> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØª
        </button>
    </div>
</div>


</body>
</html>
