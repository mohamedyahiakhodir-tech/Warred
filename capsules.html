<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD - Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: rgba(30, 30, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-sec: #aaaaaa;
            --accent-color: #ffd700; 
            --accent-glow: rgba(255, 215, 0, 0.3);
            --input-bg: #151515;
            --danger: #ff3b30;
            --sidebar-bg: #101010;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Cairo", sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg-color); color: var(--text-main); padding-bottom: 100px; min-height: 100vh; overflow-x: hidden; transition: 0.5s; }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            position: sticky; top: 0; z-index: 50;
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--glass-border);
        }
        .header h2 { font-size: 18px; font-weight: 800; margin: 0; }
        .header-icon { font-size: 22px; cursor: pointer; padding: 5px; color: #fff; }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (ØªØ¸Ù‡Ø± Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„Ø¹Ø±Ø¨ÙŠ) --- */
        .side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; backdrop-filter: blur(5px); }
        .side-menu {
            position: fixed; top: 0; right: 0; height: 100%; width: 260px; background: var(--sidebar-bg); z-index: 201;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid var(--glass-border); display: flex; flex-direction: column;
        }
        .side-menu.open { transform: translateX(0); }

        .menu-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--glass-border); background: rgba(255,255,255,0.02); }
        .menu-avatar { width: 60px; height: 60px; border-radius: 50%; background: #333; margin: 0 auto 10px; border: 2px solid var(--accent-color); background-size: cover; background-position: center; }
        
        .menu-items { padding: 10px; overflow-y: auto; flex: 1; }
        .menu-item { 
            padding: 12px 15px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; 
            display: flex; align-items: center; gap: 15px; color: var(--text-sec); font-weight: 600; transition: 0.2s; 
        }
        .menu-item:hover, .menu-item.active { background: var(--accent-color); color: #000; }
        .menu-item i { width: 20px; text-align: center; }

        .menu-section-title { font-size: 11px; color: #555; margin: 15px 15px 5px; font-weight: bold; }

        /* --- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ --- */
        .current-section-title {
            text-align: center; padding: 20px 0 10px; font-size: 20px; font-weight: 900; color: var(--accent-color);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* --- Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø§Øª --- */
        .capsules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 0 20px; }
        .capsule-card {
            background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px;
            text-align: center; position: relative; min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px); transition: 0.3s;
        }
        
        /* ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø²Ù…Ù† (Ù…Ù‚ÙÙˆÙ„Ø© Ø¨ÙˆÙ‚Øª) */
        .capsule-card.time-locked { 
            background: repeating-linear-gradient(45deg, #1a1a1a, #1a1a1a 10px, #222 10px, #222 20px); 
            border-color: #444; opacity: 0.8;
        }
        
        /* ÙƒØ§Ø±Øª Ø¹Ø§Ø¯ÙŠ (Ù…Ù‚ÙÙˆÙ„ Ø¨Ø¨Ø§Ø³ÙˆØ±Ø¯) */
        .capsule-card.pass-locked { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        /* ÙƒØ§Ø±Øª Ù…ÙØªÙˆØ­ */
        .capsule-card.open { border: 1px solid rgba(255,255,255,0.2); }

        /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: #111; width: 100%; max-width: 400px; border-radius: 24px; padding: 25px; border: 1px solid var(--glass-border); }

        .input-group { margin-bottom: 15px; }
        .lbl { display: block; font-size: 12px; color: var(--text-sec); margin-bottom: 8px; font-weight: bold; }
        .inp { width: 100%; background: var(--input-bg); border: 1px solid var(--glass-border); padding: 14px; border-radius: 12px; color: #fff; }
        textarea.inp { height: 100px; resize: none; }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .cat-select { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .cat-opt { 
            padding: 12px; border-radius: 10px; background: var(--input-bg); text-align: center; 
            cursor: pointer; border: 1px solid transparent; opacity: 0.6; display: flex; align-items: center; gap: 8px; justify-content: center;
        }
        .cat-opt.active { border-color: var(--accent-color); opacity: 1; background: rgba(255, 215, 0, 0.1); }
        .cat-opt i { font-size: 16px; }

        .fab { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color); color: #000; display: grid; place-items: center; font-size: 24px; box-shadow: 0 10px 20px rgba(0,0,0,0.4); cursor: pointer; z-index: 100; }
        .btn-full { width: 100%; padding: 14px; border-radius: 12px; background: var(--accent-color); color: #000; font-weight: 800; border: none; cursor: pointer; margin-top: 10px; }
        .btn-text { background: none; color: var(--text-sec); padding: 10px; width: 100%; border: none; cursor: pointer; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #222; color: #fff; padding: 10px 20px; border-radius: 50px; border: 1px solid var(--accent-color); z-index: 9999; transition: 0.4s; font-weight: bold; }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="side-menu-overlay" id="sideOverlay" onclick="closeSideMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-avatar" id="menuAvatar"></div>
            <div id="menuName" style="color:#fff; font-weight:bold;">Ù…Ø³ØªØ®Ø¯Ù…</div>
        </div>
        
        <div class="menu-items">
            <div class="menu-section-title">Ø§Ù„ØªÙ†Ù‚Ù„</div>
            <div class="menu-item" onclick="location.href='home.html'"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            
            <div class="menu-section-title">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
            <div class="menu-item active" onclick="filterCapsules('all', this)"><i class="fa-solid fa-layer-group"></i> Ø§Ù„ÙƒÙ„</div>
            <div class="menu-item" onclick="filterCapsules('capsule', this)"><i class="fa-solid fa-hourglass-half"></i> Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div>
            <div class="menu-item" onclick="filterCapsules('secrets', this)"><i class="fa-solid fa-user-secret"></i> Ø£Ø³Ø±Ø§Ø±ÙŠ</div>
            <div class="menu-item" onclick="filterCapsules('friends', this)"><i class="fa-solid fa-users"></i> Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</div>
            <div class="menu-item" onclick="filterCapsules('love', this)"><i class="fa-solid fa-heart"></i> Ø§Ù„Ø­Ø¨ÙŠØ¨</div>
        </div>
    </div>

    <div class="header">
        <i class="fa-solid fa-bars header-icon" onclick="openSideMenu()" style="order: -1;"></i>
        <h2>Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</h2>
        <i class="fa-solid fa-arrow-right header-icon" onclick="history.back()"></i>
    </div>

    <div class="current-section-title" id="sectionTitle">
        <i class="fa-solid fa-layer-group"></i> ÙƒÙ„ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª
    </div>

    <div class="capsules-grid" id="capsulesContainer"></div>
    <div id="emptyState" style="text-align:center; margin-top:80px; display:none; color:#555;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>

    <div class="fab" onclick="openCreateModal()"><i class="fa-solid fa-plus"></i></div>

    <div class="modal-overlay" id="createModal">
        <div class="modal-card">
            <h3 style="margin-bottom: 20px;">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            
            <div class="input-group">
                <label class="lbl">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</label>
                <div class="cat-select">
                    <div class="cat-opt" onclick="selectCat('capsule', this)"><i class="fa-solid fa-hourglass"></i> ÙƒØ¨Ø³ÙˆÙ„Ø©</div>
                    <div class="cat-opt" onclick="selectCat('secrets', this)"><i class="fa-solid fa-mask"></i> Ø£Ø³Ø±Ø§Ø±</div>
                    <div class="cat-opt" onclick="selectCat('friends', this)"><i class="fa-solid fa-users"></i> Ø£ØµØ¯Ù‚Ø§Ø¡</div>
                    <div class="cat-opt" onclick="selectCat('love', this)"><i class="fa-solid fa-heart"></i> Ø­Ø¨ÙŠØ¨</div>
                </div>
                <input type="hidden" id="selectedCategory">
            </div>

            <div class="input-group">
                <label class="lbl">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                <textarea id="newContent" class="inp" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..."></textarea>
            </div>

            <div class="input-group" id="dateSection" style="display:none;">
                <label class="lbl" style="color:var(--accent-color)">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØªØ­ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©)</label>
                <input type="date" id="newDate" class="inp">
            </div>

            <div class="input-group">
                <label style="display:flex; justify-content:space-between; cursor:pointer;">
                    <span class="lbl"><i class="fa-solid fa-lock"></i> Ø­Ù…Ø§ÙŠØ© Ø¨Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                    <input type="checkbox" id="hasPassword" onchange="document.getElementById('newPin').style.display = this.checked ? 'block' : 'none'">
                </label>
                <input type="number" id="newPin" class="inp" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" style="display:none; margin-top:5px;">
            </div>

            <button class="btn-full" onclick="saveMemory()">Ø­ÙØ¸</button>
            <button class="btn-text" onclick="closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal-overlay" id="unlockModal">
        <div class="modal-card" style="text-align:center">
            <i class="fa-solid fa-shield-halved" style="font-size: 40px; color: var(--accent-color); margin-bottom: 15px;"></i>
            <h3>Ù…Ø­Ù…ÙŠØ© Ø¨Ø±Ù…Ø²</h3>
            <input type="tel" id="unlockPinInput" class="inp" style="text-align:center; font-size:24px; letter-spacing:5px; margin:20px 0;" placeholder="****">
            <button class="btn-full" onclick="verifyPin()">ÙØªØ­</button>
            <button class="btn-text" onclick="closeModals()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div class="modal-overlay" id="viewModal">
        <div class="modal-card">
            <div style="text-align:center; color:var(--accent-color); margin-bottom:10px;"><i class="fa-solid fa-quote-left"></i></div>
            <div id="viewContent" style="white-space: pre-wrap; line-height: 1.6; max-height: 300px; overflow-y: auto;"></div>
            <div id="viewDate" style="font-size:11px; color:#555; margin-top:15px; border-top:1px solid #333; padding-top:10px;"></div>
            <button class="btn-full" onclick="closeModals()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-check"></i> <span id="toastMsg">ØªÙ…</span></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.appspot.com",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();
        let currentUser = null;
        let allMemories = []; // Ù‡Ù†Ø§ Ù‡Ù†Ø®Ø²Ù† ÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§ ÙˆÙ†Ø¹Ù…Ù„ ÙÙ„ØªØ± ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        let currentFilter = 'all';
        let pendingItem = null; // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù„ÙŠ Ø¨Ù†Ø­Ø§ÙˆÙ„ Ù†ÙØªØ­Ù‡

        // Auth
        auth.onAuthStateChanged(user => {
            if (user) { 
                currentUser = user;
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‡ÙŠØ¯Ø±
                db.collection('users').doc(user.uid).get().then(d => {
                    if(d.exists) {
                        document.getElementById('menuName').innerText = d.data().name;
                        if(d.data().profilePic) document.getElementById('menuAvatar').style.backgroundImage = `url('${d.data().profilePic}')`;
                    }
                });
                loadMemories();
            } else { location.href = 'index.html'; }
        });

        // --- 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§ØªØ§ ---
        function loadMemories() {
            db.collection("time_capsules")
                .where("uid", "==", currentUser.uid)
                .onSnapshot(snap => {
                    allMemories = [];
                    snap.forEach(doc => allMemories.push({id: doc.id, ...doc.data()}));
                    // ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
                    allMemories.sort((a,b) => b.createdAt - a.createdAt);
                    
                    renderMemories(); // Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                });
        }

        // --- 2. Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ„ØªØ± (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©) ---
        function filterCapsules(category, el) {
            currentFilter = category;
            
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ±)
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const titles = {
                'all': '<i class="fa-solid fa-layer-group"></i> ÙƒÙ„ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª',
                'capsule': '<i class="fa-solid fa-hourglass-half"></i> Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©',
                'secrets': '<i class="fa-solid fa-user-secret"></i> Ø£Ø³Ø±Ø§Ø±ÙŠ',
                'friends': '<i class="fa-solid fa-users"></i> Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ',
                'love': '<i class="fa-solid fa-heart"></i> Ø°ÙƒØ±ÙŠØ§Øª Ø§Ù„Ø­Ø¨ÙŠØ¨'
            };
            document.getElementById('sectionTitle').innerHTML = titles[category];

            closeSideMenu();
            renderMemories();
        }

        // --- 3. Ø§Ù„Ø¹Ø±Ø¶ (Rendering) ---
        function renderMemories() {
            const container = document.getElementById('capsulesContainer');
            container.innerHTML = '';
            
            // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
            const filtered = currentFilter === 'all' 
                ? allMemories 
                : allMemories.filter(m => m.category === currentFilter);

            if(filtered.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            } else {
                document.getElementById('emptyState').style.display = 'none';
            }

            filtered.forEach(m => {
                const div = document.createElement('div');
                const isCapsule = m.category === 'capsule'; // Ø¯ÙŠ Ø¨Ø³ Ø§Ù„Ù„ÙŠ Ù„ÙŠÙ‡Ø§ ÙˆÙ‚Øª
                const now = new Date();
                let isTimeLocked = false;
                let timeLeftText = "";

                // Ù„Ùˆ Ù‡ÙŠ ÙƒØ¨Ø³ÙˆÙ„Ø©ØŒ Ù†Ø´ÙŠÙƒ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª
                if(isCapsule && m.unlockDate) {
                    const unlock = m.unlockDate.toDate();
                    if(now < unlock) {
                        isTimeLocked = true;
                        timeLeftText = moment(unlock).fromNow();
                    }
                }

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                if(isTimeLocked) {
                    div.className = 'capsule-card time-locked';
                    div.innerHTML = `
                        <i class="fa-solid fa-lock" style="font-size:40px; margin-bottom:15px; color:#555;"></i>
                        <div style="font-weight:bold; color:#777;">ÙƒØ¨Ø³ÙˆÙ„Ø© Ù…ØºÙ„Ù‚Ø©</div>
                        <div style="font-size:11px; color:#555;">ØªÙØªØ­ ${timeLeftText}</div>
                    `;
                } else {
                    // Ù…ÙØªÙˆØ­Ø© Ø²Ù…Ù†ÙŠØ§Ù‹ (Ø¨Ø³ Ù…Ù…ÙƒÙ† Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ø³ÙˆØ±Ø¯)
                    div.className = m.lockCode ? 'capsule-card pass-locked' : 'capsule-card open';
                    
                    let icon = 'fa-file-lines';
                    if(m.category === 'friends') icon = 'fa-users';
                    if(m.category === 'love') icon = 'fa-heart';
                    if(m.category === 'secrets') icon = 'fa-mask';
                    if(m.category === 'capsule') icon = 'fa-box-open'; // ÙƒØ¨Ø³ÙˆÙ„Ø© ÙØªØ­Øª

                    div.innerHTML = `
                        <i class="fa-solid ${icon}" style="font-size:40px; margin-bottom:15px; color:${m.lockCode?'var(--accent-color)':'#fff'}"></i>
                        <div style="font-weight:bold;">${m.lockCode ? 'Ù…Ø­Ù…ÙŠØ© Ø¨Ø±Ù…Ø²' : 'Ø°ÙƒØ±Ù‰'}</div>
                        <div style="font-size:11px; color:#aaa;">${moment(m.createdAt.toDate()).format('D MMM')}</div>
                        ${m.lockCode ? '<i class="fa-solid fa-key" style="position:absolute; top:10px; right:10px; font-size:12px; color:var(--accent-color)"></i>' : ''}
                    `;
                }

                // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                div.onclick = () => {
                    // 1. Ù„Ùˆ Ù…Ù‚ÙÙˆÙ„Ø© Ø¨Ø§Ù„ÙˆÙ‚Øª (ÙƒØ¨Ø³ÙˆÙ„Ø©) -> Ù…Ø³ØªØ­ÙŠÙ„ ØªÙØªØ­
                    if(isTimeLocked) {
                        div.style.animation = "shake 0.4s"; setTimeout(()=>div.style.animation="", 400);
                        showToast("â›” ØªÙØªØ­ " + timeLeftText);
                        return;
                    }

                    // 2. Ù„Ùˆ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ø£ÙŠ Ù‚Ø³Ù…) -> Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
                    if(m.lockCode) {
                        pendingItem = m;
                        document.getElementById('unlockPinInput').value = '';
                        document.getElementById('unlockModal').style.display = 'flex';
                    } else {
                        // 3. Ù…ÙÙ‡Ø§Ø´ Ø­Ø§Ø¬Ø© -> Ø§ÙØªØ­ Ø¹Ù„Ø·ÙˆÙ„
                        showContent(m);
                    }
                };

                container.appendChild(div);
            });
        }

        // --- 4. Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Create Logic) ---
        function openCreateModal() {
            // Ù†ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆÙ†Ø­Ø¯Ø¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            const defaultCat = currentFilter === 'all' ? 'capsule' : currentFilter;
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…
            const opts = document.querySelectorAll('.cat-opt');
            opts.forEach(o => {
                if(o.innerText.includes(getCatName(defaultCat))) selectCat(defaultCat, o);
            });
            document.getElementById('createModal').style.display = 'flex';
        }

        function getCatName(val) {
            if(val=='capsule') return 'ÙƒØ¨Ø³ÙˆÙ„Ø©';
            if(val=='secrets') return 'Ø£Ø³Ø±Ø§Ø±';
            if(val=='friends') return 'Ø£ØµØ¯Ù‚Ø§Ø¡';
            if(val=='love') return 'Ø­Ø¨ÙŠØ¨';
            return '';
        }

        function selectCat(val, el) {
            document.querySelectorAll('.cat-opt').forEach(o => o.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('selectedCategory').value = val;

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ "ÙƒØ¨Ø³ÙˆÙ„Ø©"
            if(val === 'capsule') {
                document.getElementById('dateSection').style.display = 'block';
                // ØªØ¹ÙŠÙŠÙ† Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ§Ø±ÙŠØ® (Ø¨ÙƒØ±Ø©)
                const tmr = new Date(); tmr.setDate(tmr.getDate() + 1);
                document.getElementById('newDate').min = tmr.toISOString().split('T')[0];
            } else {
                document.getElementById('dateSection').style.display = 'none';
            }
        }

        async function saveMemory() {
            const cat = document.getElementById('selectedCategory').value;
            const content = document.getElementById('newContent').value;
            const hasPass = document.getElementById('hasPassword').checked;
            const pin = document.getElementById('newPin').value;

            if(!content) return showToast("âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰");
            
            // Ù„Ùˆ ÙƒØ¨Ø³ÙˆÙ„Ø© -> Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
            let unlockDate = null;
            if(cat === 'capsule') {
                const d = document.getElementById('newDate').value;
                if(!d) return showToast("âš ï¸ Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØªØ­ Ù„Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©");
                unlockDate = firebase.firestore.Timestamp.fromDate(new Date(d));
            }

            // Ù„Ùˆ ÙÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯
            if(hasPass && !pin) return showToast("âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯");

            try {
                await db.collection("time_capsules").add({
                    uid: currentUser.uid,
                    content: content,
                    category: cat,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    unlockDate: unlockDate, // Ù‡ÙŠÙƒÙˆÙ† null Ù„ØºÙŠØ± Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø©
                    lockCode: hasPass ? pin : null,
                    isLocked: hasPass
                });
                showToast("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
                closeModals();
                // Reset
                document.getElementById('newContent').value = "";
                document.getElementById('newPin').value = "";
                document.getElementById('hasPassword').checked = false;
            } catch(e) { console.error(e); showToast("âŒ Ø®Ø·Ø£"); }
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function verifyPin() {
            if(document.getElementById('unlockPinInput').value == pendingItem.lockCode) {
                document.getElementById('unlockModal').style.display = 'none';
                showContent(pendingItem);
            } else {
                showToast("ğŸš« Ø±Ù…Ø² Ø®Ø§Ø·Ø¦");
            }
        }

        function showContent(m) {
            document.getElementById('viewContent').innerText = m.content;
            document.getElementById('viewDate').innerText = moment(m.createdAt.toDate()).format('YYYY/MM/DD');
            document.getElementById('viewModal').style.display = 'flex';
        }

        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function openSideMenu() { document.getElementById('sideMenu').classList.add('open'); document.getElementById('sideOverlay').style.display='block'; }
        function closeSideMenu() { document.getElementById('sideMenu').classList.remove('open'); document.getElementById('sideOverlay').style.display='none'; }
        function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        
        // CSS Shake Animation
        const style = document.createElement('style');
        style.innerHTML = `@keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
