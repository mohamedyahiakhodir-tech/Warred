<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NABD - Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0d0d0f;
            --card-color: #161616;
            --primary-solid: #5D5FEF;
            --text-color: #eee;
            --secondary-text: #aaa;
            --border-color: #2a2a2a;
            --unread-bg: rgba(93, 95, 239, 0.15);
            --uranium: #3fff00;
            --vip-gold: #f59e0b; /* Ù„ÙˆÙ† Ø°Ù‡Ø¨ÙŠ Ù„Ù„ØªÙˆØ«ÙŠÙ‚ */
        }
        body { background: var(--bg-color); color: var(--text-color); margin: 0; font-family: "Cairo", sans-serif; padding-bottom: 80px; }
        
        .header { display: flex; align-items: center; padding: 15px 20px; background: rgba(22, 22, 22, 0.95); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        
        .mark-all-btn {
            background: transparent;
            border: 1px solid var(--primary-solid);
            color: var(--primary-solid);
            padding: 5px 12px;
            border-radius: 20px;
            font-family: "Cairo", sans-serif;
            font-size: 12px;
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; gap: 5px;
        }
        .mark-all-btn:hover { background: var(--primary-solid); color: #fff; }

        .header h2 { margin: 0; font-size: 20px; flex: 1; text-align: center; }
        .back-btn { font-size: 20px; cursor: pointer; color: var(--uranium); }

        .notif-list { padding: 10px; }
        
        .notif-item { display: flex; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; position: relative; border-radius: 12px; margin-bottom: 8px; background: var(--card-color); border: 1px solid transparent; }
        
        .notif-item.unopened { 
            background: var(--unread-bg); 
            border-color: rgba(93, 95, 239, 0.3); 
            border-right: 4px solid var(--primary-solid); 
        }
        
        /* Ø³ØªØ§ÙŠÙ„ Ø®Ø§Øµ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… */
        .notif-item.system-msg {
            background: rgba(245, 158, 11, 0.1) !important;
            border-right: 4px solid var(--vip-gold) !important;
            border-color: rgba(245, 158, 11, 0.2);
        }
        
        .notif-item.opened { opacity: 0.7; background: transparent; }

        .notif-avatar { width: 50px; height: 50px; border-radius: 50%; background: #333; background-size: cover; background-position: center; display: grid; place-items: center; font-weight: bold; font-size: 18px; flex-shrink: 0; position: relative; border: 1px solid var(--border-color); }
        .notif-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .notif-text { font-size: 14px; line-height: 1.4; color: var(--text-color); }
        .notif-text b { color: #fff; margin-left: 3px; }
        .notif-time { font-size: 11px; color: var(--secondary-text); margin-top: 5px; }
        .notif-icon { width: 30px; height: 30px; display: grid; place-items: center; font-size: 18px; }
        
        .verified-badge { 
            color: #3897f0; 
            margin-right: 4px; 
            font-size: 13px; 
            vertical-align: -2px;
            display: inline-block;
        }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-color); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border-color); z-index: 99; }
        .nav-item { font-size: 22px; color: var(--secondary-text); cursor: pointer; }
        .nav-item.active { color: var(--primary-solid); }

        .empty-state { text-align: center; padding: 50px 20px; color: var(--secondary-text); }
        .empty-state i { font-size: 50px; margin-bottom: 15px; opacity: 0.5; }
        /* Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù‡Ø¯ÙŠØ© ÙŠÙƒÙˆÙ† Ù„Ù‡ Ù„Ù…Ø¹Ø© Ø¨Ø³ÙŠØ·Ø© */
/* --- Ø³ØªØ§ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„ÙØ§Ø®Ø± (Premium Gift) --- */
.notif-item.gift-premium {
    background: linear-gradient(135deg, #2b2000 0%, #1a1a1a 100%) !important; /* Ø®Ù„ÙÙŠØ© Ø°Ù‡Ø¨ÙŠØ© Ù…Ø³ÙˆØ¯Ø© */
    border: 1px solid rgba(255, 215, 0, 0.5) !important; /* Ø­Ø¯ÙˆØ¯ Ø°Ù‡Ø¨ÙŠØ© */
    border-right: 5px solid #FFD700 !important; /* Ø®Ø· Ø³Ù…ÙŠÙƒ ÙŠÙ…ÙŠÙ† */
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.15) !important;
    position: relative;
    overflow: hidden;
    padding: 15px;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„Ù…Ø¹Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Shine Effect) */
.notif-item.gift-premium::before {
    content: '';
    position: absolute;
    top: 0; left: -150%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
    transform: skewX(-20deg);
    animation: goldShine 3s infinite linear;
    pointer-events: none;
}

@keyframes goldShine {
    0% { left: -150%; }
    100% { left: 150%; }
}

/* Ø§Ù„Ù†Øµ Ø§Ù„Ø°Ù‡Ø¨ÙŠ */
.gold-text {
    color: #FFD700 !important;
    font-weight: 800;
    font-size: 14px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    display: block;
    margin-top: 4px;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡Ø¯ÙŠØ© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
.gift-big-icon {
    font-size: 35px;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
    animation: bounceGift 2s infinite ease-in-out;
}

@keyframes bounceGift {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

/* Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø§Ø³Ù„ */
.gift-avatar-border {
    border: 2px solid #FFD700 !important;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
}


    </style>
</head>
<body>

    <div class="header">
        <i class="fa-solid fa-arrow-right back-btn" onclick="history.back()"></i>
        <h2>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
        <button class="mark-all-btn" onclick="markAllAsOpened()">
            <i class="fa-solid fa-check-double"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
        </button>
    </div>

    <div class="notif-list" id="notifList">
        <div style="text-align: center; padding: 20px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="location.href='home.html'"><i class="fa-solid fa-house"></i></div>
        <div class="nav-item" onclick="location.href='friends.html'"><i class="fa-solid fa-users"></i></div>
        <div class="nav-item" onclick="location.href='create_post.html'"><i class="fa-solid fa-plus-circle"></i></div>
        <div class="nav-item active"><i class="fa-solid fa-bell"></i></div>
        <div class="nav-item" onclick="location.href='profile.html'"><i class="fa-regular fa-user"></i></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.appspot.com",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();

        const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
        const ghostColors = ["#ff0000", "#00ff00", "#0099ff", "#ffff00", "#ff00ff", "#00ffff", "#ff9900", "#9900ff", "#ffffff", "#00ff99"];

        function getGhostIdentity(uid) {
            if (!uid) return { id: '0000', color: '#ff0000' };
            let hash = 0;
            for (let i = 0; i < uid.length; i++) { hash = uid.charCodeAt(i) + ((hash << 5) - hash); }
            hash = Math.abs(hash);
            const ghostID = (hash % 9000) + 1000; 
            const colorIndex = hash % ghostColors.length;
            return { id: ghostID, color: ghostColors[colorIndex] };
        }

        auth.onAuthStateChanged(user => {
            if (user) { 
                loadNotifications(user.uid);
                clearHomeBadgeOnly();
            } else { 
                window.location.href = "index.html"; 
            }
        });

        // === ØªÙØ¹ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ===
        async function clearHomeBadgeOnly() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
            const snapshot = await db.collection('notifications')
                .where('recipientId', '==', user.uid)
                .where('read', '==', false)
                .get();

            if (snapshot.empty) return;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ read ÙÙ‚Ø· Ù„ÙŠØ®ØªÙÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø®Ø§Ø±Ø¬
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { read: true }); 
            });
            
            await batch.commit();
        }

        let unsubscribeNotifications = null; 

function loadNotifications(uid) {
    // 1. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (unsubscribeNotifications) {
        unsubscribeNotifications();
        unsubscribeNotifications = null;
    }

    let isFirstLoad = true;
    const list = document.getElementById('notifList');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    list.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

    // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±
    unsubscribeNotifications = db.collection('notifications')
        .where('recipientId', '==', uid)
        .orderBy('createdAt', 'desc')
        .limit(50)
        .onSnapshot(snapshot => {
            // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒÙ…Ø§ Ù‡Ùˆ ØªÙ…Ø§Ù…Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) ...
            // ÙÙ‚Ø· ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ù…Ø³Ø­Øª Ø§Ù„Ø³Ø·Ø±ÙŠÙ†: const list = ... Ùˆ list.innerHTML = ... Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ onSnapshot
            // Ù„Ø£Ù†Ù†Ø§ Ø¹Ø±ÙÙ†Ø§Ù‡Ù… Ø¨Ø±Ù‡ Ø®Ù„Ø§ØµØŒ Ø¨Ø³ Ù…Ø´ Ù…Ø´ÙƒÙ„Ø© Ù„Ùˆ Ø³Ø¨ØªÙ‡Ù…
            
            // Ù‡Ø§Ù…: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            list.innerHTML = ""; 
            
            if (snapshot.empty) {
                list.innerHTML = `<div class="empty-state"><i class="fa-regular fa-bell-slash"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p></div>`;
                return;
            }

            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            snapshot.docChanges().forEach(change => {
                if (change.type === "added" && !isFirstLoad) {
                    if (change.doc.data().read === false) { notificationSound.play().catch(()=>{}); }
                }
            });

            list.innerHTML = "";
            
            snapshot.forEach(doc => {
                const notif = doc.data();
                const id = doc.id;
                const isOpened = notif.opened === true;
                
                // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                let senderName = notif.senderName || 'Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶';
                let senderPic = notif.senderPic || "";
                let isVerified = notif.isVerified === true;
                let timeAgo = notif.createdAt ? moment(notif.createdAt.toDate()).fromNow() : 'Ø§Ù„Ø¢Ù†';

                // ============================================================
                // ğŸ”¥ğŸ”¥ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ø¯ÙŠØ© (GIFT) ğŸ”¥ğŸ”¥ğŸ”¥
                // ============================================================
                if (notif.type === 'gift') {
                    const div = document.createElement('div');
                    div.className = `notif-item gift-premium ${isOpened ? 'opened' : 'unopened'}`;
                    div.onclick = () => handleNotificationClick(id, notif);

                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯ÙŠØ©
                    let giftName = "Ù‡Ø¯ÙŠØ© Ù…Ù…ÙŠØ²Ø©";
                    if (notif.text && notif.text.includes('Ù‡Ø¯ÙŠØ©')) {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯ÙŠØ© ÙÙ‚Ø·
                        giftName = notif.text; 
                    }

                    div.innerHTML = `
                        <div class="notif-avatar gift-avatar-border" 
                             style="${senderPic ? `background-image: url('${senderPic}')` : `background-color: #333; color:#FFD700`}">
                             ${!senderPic ? '<i class="fa-solid fa-user"></i>' : ''}
                        </div>

                        <div class="notif-content">
                            <div class="notif-text">
                                <span style="color:#fff; font-weight:bold; font-size:15px;">${senderName}</span>
                                ${isVerified ? '<i class="fa-solid fa-circle-check verified-badge" style="color:#FFD700"></i>' : ''}
                                
                                <span class="gold-text">
                                    <i class="fa-solid fa-gem"></i> ${giftName}
                                </span>
                            </div>
                            <div class="notif-time" style="color:#FFD700; opacity:0.7; font-size:11px; margin-top:5px;">${timeAgo}</div>
                        </div>

                        <div class="notif-icon">
                            <div class="gift-big-icon">ğŸ</div>
                        </div>
                    `;
                    list.appendChild(div);
                    return; // ğŸ›‘ ØªÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆØ§Ù†ØªÙ‚Ù„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ (Ø¹Ø´Ø§Ù† Ù„Ø§ ÙŠØ±Ø³Ù… Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
                }

                // ============================================================
                // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (ØªØ¹Ù„ÙŠÙ‚ØŒ Ù„Ø§ÙŠÙƒØŒ Ø§Ù„Ø®)
                // ============================================================
                
                let avatarHtml = '';
                let verifiedHtml = isVerified ? '<i class="fa-solid fa-circle-check verified-badge"></i>' : '';
                let iconHtml = '<i class="fa-solid fa-bell" style="color:var(--primary-solid)"></i>';
                let displayText = notif.text;
                let customClass = '';

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ
                if (displayText && (displayText.includes('firebasestorage') || displayText.includes('http'))) {
                    if (displayText.includes('.m4a') || displayText.includes('.webm')) displayText = "Ø£Ø±Ø³Ù„ ØªØ³Ø¬ÙŠÙ„Ø§Ù‹ ØµÙˆØªÙŠØ§Ù‹ ğŸ™ï¸";
                    else if (displayText.includes('.jpg') || displayText.includes('.png')) displayText = "Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© ğŸ“·";
                    else if (displayText.includes('.mp4')) displayText = "Ø£Ø±Ø³Ù„ ÙÙŠØ¯ÙŠÙˆ ğŸ¥";
                }

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
                if (notif.type === 'system_msg') {
                    customClass = 'system-msg';
                    verifiedHtml = '<i class="fa-solid fa-circle-check verified-badge" style="color:#f59e0b"></i>';
                    avatarHtml = `<div class="notif-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706); border:none;"><i class="fa-solid fa-crown" style="color:white;"></i></div>`;
                    iconHtml = '<i class="fa-solid fa-envelope-open-text" style="color:#f59e0b"></i>';
                } 
                else if (notif.isGhost) {
                    const ghost = getGhostIdentity(notif.senderUid);
                    senderName = `Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶ #${ghost.id}`;
                    avatarHtml = `<div class="notif-avatar" style="background: #000; border: 1px solid ${ghost.color};"><i class="fa-solid fa-user-secret" style="color: ${ghost.color};"></i></div>`;
                } 
                else {
                    if (senderPic) avatarHtml = `<div class="notif-avatar" style="background-image: url('${senderPic}')"></div>`;
                    else avatarHtml = `<div class="notif-avatar" style="background-color: #444">${senderName[0]}</div>`;

                    switch (notif.type) {
                        case 'like': iconHtml = '<i class="fa-solid fa-heart" style="color:#ff3b30"></i>'; break;
                        case 'star': iconHtml = '<i class="fa-solid fa-star" style="color:#FFD700"></i>'; break;
                        case 'comment': iconHtml = '<i class="fa-solid fa-comment" style="color:#009EFD"></i>'; break;
                        case 'reply': iconHtml = '<i class="fa-solid fa-reply" style="color:#F093FB"></i>'; break;
                        case 'share': iconHtml = '<i class="fa-solid fa-share" style="color:#2AF598"></i>'; break;
                    }
                }

                const div = document.createElement('div');
                div.className = `notif-item ${isOpened ? 'opened' : 'unopened'} ${customClass}`;
                div.onclick = () => handleNotificationClick(id, notif);
                
                div.innerHTML = `
                    ${avatarHtml}
                    <div class="notif-content">
                        <div class="notif-text">
                            <b>${senderName}</b>${verifiedHtml} 
                            <div style="font-size:13px; margin-top:3px; opacity:0.9; color:${isOpened ? '#888' : '#eee'}">${displayText}</div>
                        </div>
                        <div class="notif-time">${timeAgo}</div>
                    </div>
                    <div class="notif-icon">${iconHtml}</div>
                `;
                list.appendChild(div);
            });
            isFirstLoad = false;
        });
}


        async function handleNotificationClick(docId, notif) {
            await db.collection('notifications').doc(docId).update({ opened: true, read: true });
            
            // Ù„Ùˆ Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¸Ø§Ù…
            if (notif.type === 'system_msg') {
                if (notif.title && notif.title.includes('ØªÙˆØ«ÙŠÙ‚')) {
                    window.location.href = 'profile.html'; 
                }
                return;
            }

            if (notif.link) { 
                let targetLink = notif.link;
                if(targetLink.includes('#post-')) {
                    targetLink = targetLink.replace('#post-', '&post=');
                }
                window.location.href = targetLink; 
            } else if (notif.postId) {
                let url = `profile.html?uid=${notif.recipientId}&post=${notif.postId}`;
                if (notif.commentId) { url += `&comment=${notif.commentId}`; }
                window.location.href = url;
            }
        }

        async function markAllAsOpened() {
            const user = auth.currentUser;
            if (!user) return;
            const btn = document.querySelector('.mark-all-btn');
            try {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...';
                const snapshot = await db.collection('notifications').where('recipientId', '==', user.uid).get();
                if (snapshot.empty) { btn.innerHTML = '<i class="fa-solid fa-check-double"></i> ØªÙ…'; return; }
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { opened: true, read: true });
                });
                await batch.commit();
                btn.innerHTML = '<i class="fa-solid fa-check-double"></i> ØªÙ…';
            } catch (error) { btn.innerHTML = 'Ø®Ø·Ø£'; }
        }
    </script>
            <script src="global-call.js"></script>

</body>
</html>
