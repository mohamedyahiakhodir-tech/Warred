<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إنشاء مجموعة متطورة - Wareed</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        :root { 
            --bg-primary: #050b14;
            --accent-color: #00e5ff;
            --accent-gradient: linear-gradient(135deg, #00e5ff, #2979ff);
            --glass-bg: rgba(20, 30, 48, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --error-color: #ff3b3b;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background-color: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 229, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 90%, rgba(41, 121, 255, 0.1) 0%, transparent 50%);
            display: flex; flex-direction: column; color: #fff;
        }

        /* الهيدر */
        .header {
            padding: 15px; display: flex; align-items: center; gap: 15px;
            background: rgba(15, 25, 38, 0.9); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        .header h2 { margin: 0; font-size: 18px; }
        .back-btn { font-size: 20px; cursor: pointer; color: #ccc; }

        /* المحتوى */
        .container {
            flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center;
            overflow-y: auto;
        }

        /* رفع الصورة */
        .img-upload-wrapper {
            position: relative; width: 120px; height: 120px; margin-bottom: 30px;
        }
        .group-img-preview {
            width: 100%; height: 100%; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 2px dashed var(--accent-color);
            display: grid; place-items: center; cursor: pointer; background-size: cover; background-position: center;
            transition: 0.3s;
        }
        .camera-icon { font-size: 30px; color: var(--accent-color); pointer-events: none; }
        
        /* الحقول */
        .form-group { width: 100%; margin-bottom: 20px; }
        .input-label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
        
        .custom-input {
            width: 100%; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            color: #fff; font-size: 16px; outline: none; transition: 0.3s;
        }
        .custom-input:focus { border-color: var(--accent-color); box-shadow: 0 0 15px rgba(0, 229, 255, 0.1); }

        /* خيارات الخصوصية الجديدة (3 خيارات) */
        .privacy-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .p-option {
            padding: 12px 5px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            border-radius: 12px; cursor: pointer; text-align: center; transition: 0.3s; opacity: 0.6;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .p-option i { font-size: 18px; margin-bottom: 5px; }
        .p-option span { font-size: 12px; font-weight: bold; }
        
        .p-option.selected {
            background: rgba(0, 229, 255, 0.15); border-color: var(--accent-color); opacity: 1; transform: translateY(-2px);
        }

        /* حقل الباسورد المخفي */
        .password-section {
            overflow: hidden; max-height: 0; transition: max-height 0.4s ease-in-out, opacity 0.4s;
            opacity: 0; margin-top: 0;
        }
        .password-section.active {
            max-height: 100px; opacity: 1; margin-top: 15px;
        }

        /* زر الإنشاء */
        .create-btn {
            margin-top: auto; width: 100%; padding: 15px; border-radius: 15px; border: none;
            background: var(--accent-gradient); color: #fff; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 20px rgba(0, 229, 255, 0.3); transition: 0.2s;
        }
        .create-btn:active { transform: scale(0.98); }
        .create-btn:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }

        /* اللودر */
        .loader-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px;">جاري تجهيز المجموعة...</p>
    </div>

    <div class="header">
        <i class="fa-solid fa-arrow-right back-btn" onclick="history.back()"></i>
        <h2>إنشاء مجموعة</h2>
    </div>

    <div class="container">
        
        <div class="img-upload-wrapper" onclick="document.getElementById('groupImgInput').click()">
            <div class="group-img-preview" id="imgPreview">
                <i class="fa-solid fa-camera camera-icon"></i>
            </div>
            <input type="file" id="groupImgInput" hidden accept="image/*" onchange="previewImage(this)">
        </div>

        <div class="form-group">
            <label class="input-label">اسم المجموعة</label>
            <input type="text" id="groupName" class="custom-input" placeholder="مثال: عشاق البرمجة" oninput="checkForm()">
        </div>

        <div class="form-group">
            <label class="input-label">نوع المجموعة</label>
            <div class="privacy-options">
                
                <div class="p-option selected" id="optPublic" onclick="selectPrivacy('public')">
                    <i class="fa-solid fa-earth-americas"></i>
                    <span>عامة</span>
                </div>

                <div class="p-option" id="optProtected" onclick="selectPrivacy('protected')">
                    <i class="fa-solid fa-key"></i>
                    <span>محمية</span>
                </div>

                <div class="p-option" id="optPrivate" onclick="selectPrivacy('private')">
                    <i class="fa-solid fa-lock"></i>
                    <span>خاصة</span>
                </div>

            </div>

            <div class="password-section" id="passwordSection">
                <label class="input-label" style="color: var(--accent-color)">كلمة المرور المطلوبة للدخول</label>
                <input type="password" id="groupPassword" class="custom-input" placeholder="اكتب كلمة مرور قوية" oninput="checkForm()">
            </div>
        </div>

        <button id="createBtn" class="create-btn" onclick="createGroup()" disabled>إنشاء المجموعة</button>

    </div>

    <script>
        // === تهيئة Firebase (تأكد من وضع بياناتك الصحيحة هنا) ===
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        let selectedPrivacy = 'public';
        let currentUserId = null;
        let selectedImageFile = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
            } else {
                window.location.href = 'login.html';
            }
        });

        // 1. معاينة الصورة
        function previewImage(input) {
            if (input.files && input.files[0]) {
                selectedImageFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imgPreview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.innerHTML = ''; 
                    preview.style.border = '2px solid #fff';
                }
                reader.readAsDataURL(input.files[0]);
                checkForm();
            }
        }

        // 2. التحكم في خيارات الخصوصية
        function selectPrivacy(type) {
            selectedPrivacy = type;
            
            // إزالة التحديد من الكل
            document.querySelectorAll('.p-option').forEach(el => el.classList.remove('selected'));

            // تحديد العنصر المختار
            if (type === 'public') document.getElementById('optPublic').classList.add('selected');
            else if (type === 'protected') document.getElementById('optProtected').classList.add('selected');
            else if (type === 'private') document.getElementById('optPrivate').classList.add('selected');

            // إظهار/إخفاء حقل الباسورد
            const passSection = document.getElementById('passwordSection');
            if (type === 'protected') {
                passSection.classList.add('active');
            } else {
                passSection.classList.remove('active');
                document.getElementById('groupPassword').value = ''; // مسح الباسورد عند تغيير النوع
            }
            
            checkForm(); // إعادة فحص الزر
        }

        // 3. التحقق من صحة النموذج لتفعيل الزر
        function checkForm() {
            const name = document.getElementById('groupName').value.trim();
            const password = document.getElementById('groupPassword').value.trim();
            const btn = document.getElementById('createBtn');
            
            let isValid = false;

            if (name.length > 0) {
                if (selectedPrivacy === 'protected') {
                    // في حالة المحمي، يجب وجود باسورد
                    if (password.length >= 3) isValid = true;
                } else {
                    // في الحالات الأخرى، الاسم يكفي
                    isValid = true;
                }
            }

            btn.disabled = !isValid;
        }

        // 4. إنشاء المجموعة (Professional Logic)
        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const password = document.getElementById('groupPassword').value.trim();

            if (!name) return;
            if (selectedPrivacy === 'protected' && !password) return alert("الرجاء تحديد كلمة مرور للمجموعة");

            document.getElementById('loader').style.display = 'flex';

            try {
                let imageUrl = null;

                // أ) رفع الصورة
                if (selectedImageFile) {
                    const ref = storage.ref(`groups_avatars/${Date.now()}_${currentUserId}`);
                    await ref.put(selectedImageFile);
                    imageUrl = await ref.getDownloadURL();
                }

                // ب) تجهيز البيانات
                // لاحظ هنا كيف نضيف حقل 'privacy' وحقل 'password'
                const newGroupRef = db.collection('chats').doc();
                
                const groupData = {
                    type: 'GROUP',
                    name: name,
                    groupImage: imageUrl || 'default_group.png', // صورة افتراضية
                    
                    // بيانات الأمان
                    privacy: selectedPrivacy, // 'public', 'private', 'protected'
                    password: (selectedPrivacy === 'protected') ? password : null, // نحفظ الباسورد فقط لو النوع محمي
                    
                    createdBy: currentUserId,
                    admins: [currentUserId],
                    users: [currentUserId], // المالك ينضم تلقائياً
                    
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: "تم إنشاء المجموعة ✨",
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    unreadCount: 0
                };

                // ج) الحفظ
                await newGroupRef.set(groupData);

                // د) التوجيه
                // الآن الجروب أصبح جاهزاً ومعه بيانات الحماية الخاصة به
                window.location.href = `group_chat.html?groupId=${newGroupRef.id}`;

            } catch (error) {
                console.error(error);
                alert("حدث خطأ: " + error.message);
                document.getElementById('loader').style.display = 'none';
            }
        }
    </script>
</body>
</html>
