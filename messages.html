<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title> Warred - Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>

    <style>
/* ================= 1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª (Royal Theme) ================= */
:root {
    --bg-deep: #050505;
    --text-color: #ffffff;
    --text-secondary: #a0a0a0;
    --card-bg: rgba(30, 30, 35, 0.6);
    --card-border: rgba(255, 255, 255, 0.08);
    --accent-color: #8b5cf6;
    --accent-glow: rgba(139, 92, 246, 0.4);
    --verify-color: #38bdf8;
    --danger-color: #ef4444;
    --seen-blue: #38bdf8;
    --gold-primary: #FFD700;
    --gold-dim: #BF953F;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }

body {
    background-color: var(--bg-deep);
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(90, 40, 250, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(40, 150, 250, 0.1) 0%, transparent 40%);
    background-attachment: fixed;
    color: var(--text-color);
    padding-bottom: 100px;
    min-height: 100vh;
    overflow-x: hidden;
    user-select: none;
}

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
.blur-content { filter: blur(20px); }

/* ================= 2. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… (Compact Royal Header) ================= */
.main-header {
    position: sticky;
    top: 8px;
    z-index: 1000;
    width: 94%;
    height: 55px;
    margin: 0 auto 15px auto;
    padding: 0 15px;
    border-radius: 20px;
    background: rgba(20, 20, 25, 0.85);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 215, 0, 0.1);
    border-bottom: 2px solid rgba(139, 92, 246, 0.3);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    display: flex; align-items: center; justify-content: space-between;
}

/* Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø§Ù„Ø­ÙŠ */
.luxury-logo-container {
    display: flex; align-items: center; justify-content: center; gap: 12px;
    font-size: 26px; font-weight: 900;
}

.gold-text {
    background: linear-gradient(120deg, #3a2c0f 0%, #997f3d 20%, #ffecb3 40%, #ffffff 50%, #ffecb3 60%, #997f3d 80%, #3a2c0f 100%);
    background-size: 200% auto;
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    -webkit-text-stroke: 1.5px #4c1d95;
    filter: drop-shadow(0 2px 0 rgba(76, 29, 149, 0.5));
    text-transform: uppercase; letter-spacing: 1px;
    animation: shineMove 5s linear infinite;
}
@keyframes shineMove { 0% { background-position: 0% center; } 100% { background-position: -200% center; } }

.miracle-heart {
    font-size: 32px; color: #d60000;
    -webkit-text-stroke: 1.5px #FFD700;
    filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 10px rgba(200, 0, 0, 0.5));
    animation: veinPulse 1.5s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
@keyframes veinPulse {
    0%, 100% { transform: scale(1); color: #d60000; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.8)); }
    15% { transform: scale(1.25); color: #ff0000; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1)) drop-shadow(0 0 25px rgba(255, 0, 0, 0.8)); }
    30% { transform: scale(1.1); color: #e60000; }
    45% { transform: scale(1.3); color: #ff1a1a; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1)) drop-shadow(0 0 30px rgba(255, 0, 0, 1)); }
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± */
.icon-btn {
    width: 42px; height: 42px; border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s;
    background: linear-gradient(145deg, rgba(30, 30, 35, 0.8), rgba(10, 10, 12, 0.95));
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 215, 0, 0.1);
    color: #c5a059; font-size: 18px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
}
.icon-btn:active, .icon-btn:hover {
    color: #fff; border-color: #FFD700;
    background: linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(0, 0, 0, 0.9));
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); transform: scale(0.95);
}
#menuBtn { animation: idleBreathing 3s infinite alternate; }
@keyframes idleBreathing { 0% { border-color: rgba(255, 215, 0, 0.1); } 100% { border-color: rgba(255, 215, 0, 0.3); box-shadow: 0 0 8px rgba(255, 215, 0, 0.15); } }

/* ================= 3. Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°Ù‡Ø¨ÙŠ ================= */
.search-wrapper { padding: 0 20px 5px 20px; background: transparent; }
.search-input-box { position: relative; width: 88%; margin: 0 auto; }
.search-input-box input {
    width: 100%; padding: 12px 45px 12px 15px; border-radius: 20px;
    background: rgba(30, 30, 35, 0.6); border: 1px solid #6d28d9;
    color: #fceecb; outline: none; transition: all 0.3s ease;
}
.search-input-box input:focus {
    border-color: #BF953F;
    box-shadow: 0 0 20px rgba(191, 149, 63, 0.15), inset 0 2px 5px rgba(0,0,0,0.5);
    background: linear-gradient(145deg, rgba(25, 25, 30, 0.95), rgba(50, 45, 30, 0.9));
}
.search-input-box input::placeholder { color: #8a7d5b; transition: 0.3s; }
.search-icon-inside {
    position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
    color: #D4AF37; font-size: 18px; pointer-events: none; transition: 0.3s;
    text-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
}
.search-input-box:focus-within .search-icon-inside { color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); transform: translateY(-50%) scale(1.1); }

/* ================= 4. Ø§Ù„Ù‚ØµØµ (Compact Gold Style) ================= */
.stories-section {
    padding: 8px 0 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); margin-bottom: 0; position: relative; z-index: 1;
}
.stories-title { padding: 0 15px 5px; font-weight: 700; font-size: 12px; color: var(--text-secondary); margin-bottom: 0; }
.stories-scroll { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding: 0 12px; }

/* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ù…ØµØºØ± ÙˆØ§Ù„Ø°Ù‡Ø¨ÙŠ */
.story-card {
    position: relative; width: 75px; height: 115px;
    border-radius: 10px; overflow: visible !important; flex-shrink: 0; cursor: pointer;
    background-color: #2a2a2a; margin-bottom: 5px; z-index: 1;
}
/* Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø§Ù„Ù…Ø´Ø¹ */
.story-card::before {
    content: ''; position: absolute; inset: -3px; border-radius: 14px;
    background: linear-gradient(135deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
    z-index: -1; box-shadow: 0 0 10px rgba(191, 149, 63, 0.5);
}
.story-card:active { transform: scale(0.97); }
.story-card-bg, .story-card video {
    width: 100%; height: 100%; object-fit: cover; border-radius: 10px; transition: 0.3s;
}
.story-card:hover .story-card-bg { transform: scale(1.05); }

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚ØµØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
.story-card-avatar {
    position: absolute; top: 4px; left: 4px; width: 24px; height: 24px;
    border-radius: 50%; border: 2px solid var(--accent-color);
    background-size: cover; background-position: center; z-index: 2;
}
.story-card-name {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 15px 4px 4px 4px; border-radius: 0 0 10px 10px;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
    color: #fff; font-size: 9px; font-weight: bold;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; z-index: 2;
}

/* ÙƒØ§Ø±Øª Ø¥Ø¶Ø§ÙØªÙŠ */
.my-story-card { background: #1e1e1e; display: flex; flex-direction: column; overflow: hidden !important; }
.my-story-card::before { display: none; } /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ù„Ù‚ØµØªÙŠ Ø§Ù„ÙØ§Ø±ØºØ© */
.my-story-top-img { width: 100%; height: 70%; background-size: cover; background-position: center; filter: brightness(0.8); }
.my-story-bottom { height: 30%; width: 100%; position: relative; background: #1e1e1e; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 6px; }
.add-story-btn-circle {
    position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
    width: 24px; height: 24px; background: var(--accent-color);
    border: 2px solid #1e1e1e; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 12px; z-index: 5;
}

/* ================= 5. Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø³Ø±ÙŠØ¹ ================= */
.quick-users-section { padding: 5px 0; margin-bottom: 2px; border-bottom: 1px solid var(--card-border); background: transparent; }
.quick-users-title { padding: 0 15px 5px; font-weight: 700; font-size: 12px; color: var(--text-secondary); margin-bottom: 0; }
.quick-users-scroll { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding: 0 12px; align-items: flex-start; }
.quick-user-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 50px; min-width: 50px; flex-shrink: 0; }
.quick-user-item:active { transform: scale(0.95); transition: 0.2s; }
.quick-avatar-wrapper { position: relative; width: 44px; height: 44px; margin-bottom: 2px; }
.quick-avatar-img {
    width: 100%; height: 100%; border-radius: 50%; background-size: cover; background-position: center;
    border: 2px solid rgba(255, 215, 0, 0.3); background-color: #2a2a2a;
}
.quick-online-dot {
    position: absolute; bottom: 1px; right: 1px; width: 11px; height: 11px;
    background-color: #4ade80; border: 1.5px solid #000; border-radius: 50%;
    z-index: 5; box-shadow: 0 0 5px rgba(74, 222, 128, 0.8);
}
.quick-user-name { font-size: 9px; color: #e0e0e0; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-weight: 600; margin-top: 0; }

/* ================= 6. ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Royal Dark Gold) ================= */
.chat-wrapper { margin: 0 10px 6px 10px; border-radius: 12px; position: relative; overflow: hidden; }
.chat {
    position: relative; z-index: 2; display: flex; gap: 12px; padding: 12px 14px;
    cursor: pointer; align-items: center; width: 100%; border-radius: 16px; overflow: hidden;
    background: linear-gradient(135deg, #09090b 0%, #1c1917 100%);
    border: 1px solid rgba(245, 158, 11, 0.3); border-right: 3px solid #d97706;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); user-select: none;
}
.chat:active { border-color: #fbbf24; box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }

/* Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø«Ø¨Øª */
.chat.pinned-chat {
    background: linear-gradient(135deg, rgba(191, 149, 63, 0.15), rgba(10, 10, 12, 0.95));
    border: 1px solid rgba(191, 149, 63, 0.6); border-right: 4px solid #FFD700;
    box-shadow: 0 0 25px rgba(191, 149, 63, 0.1);
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø§Øª */
.avatar-container { position: relative; flex-shrink: 0; width: 48px; height: 48px; }
.avatar {
    width: 100%; height: 100%; border-radius: 14px; background-size: cover; background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3); background-color: #2a2a2a; border: 1px solid rgba(255,255,255,0.1);
}
.active-dot { position: absolute; bottom: -1px; right: -1px; width: 11px; height: 11px; background: #22c55e; border: 2px solid var(--bg-deep); border-radius: 50%; }

.info { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
.top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
.name { font-weight: 700; font-size: 15px; color: #fceecb; display: flex; align-items: center; gap: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
.verify-badge { color: var(--verify-color); font-size: 14px; }
.time { font-size: 10px; color: #888; font-weight: 600; }
.bottom-row { display: flex; justify-content: space-between; align-items: center; margin-top: 2px; }
.last { color: #a8a29e; font-size: 13px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px; }
.unread-badge {
    background: linear-gradient(45deg, var(--accent-color), #6d28d9);
    color: white; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 12px;
    font-size: 10px; font-weight: 800; display: flex; align-items: center; justify-content: center;
}
.read-blue-dot { width: 8px; height: 8px; background-color: var(--seen-blue); border-radius: 50%; display: inline-block; margin-left: 5px; box-shadow: 0 0 5px var(--seen-blue); flex-shrink: 0; }
.typing-indicator { color: var(--accent-color); font-style: italic; font-size: 13px; animation: pulse 1.5s infinite; }
.seen-avatar-icon { width: 15px; height: 15px; border-radius: 50%; background-size: cover; background-position: center; border: 1px solid #000; display: inline-block; margin-left: 5px; }

/* ================= 7. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Royal Blend) ================= */
.sidebar {
    position: fixed; top: 0; right: -320px; width: 280px; height: 100%;
    z-index: 10001; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex; flex-direction: column; padding-top: 0;
    box-shadow: -10px 0 50px rgba(0,0,0,0.8); border-left: 1px solid rgba(255, 215, 0, 0.2);
    background-color: #0f0c15; overflow: hidden;
}
.sidebar.active { right: 0; }
.sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
.sidebar-overlay.active { opacity: 1; pointer-events: auto; }

.sidebar-profile-header {
    position: relative; flex-shrink: 0; padding: 60px 20px 40px; text-align: center;
    display: flex; flex-direction: column; align-items: center;
    background: linear-gradient(180deg, #2e1065 0%, #0f0c15 100%);
    border-bottom: 1px solid rgba(255, 215, 0, 0.1);
}
.sidebar-profile-header::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-image: repeating-linear-gradient(45deg, rgba(255, 215, 0, 0.05) 0px, rgba(255, 215, 0, 0.05) 1px, transparent 1px, transparent 10px);
    mask-image: linear-gradient(to bottom, black 40%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%); z-index: 0;
}
.sidebar-avatar-container {
    width: 90px; height: 90px; border-radius: 50%; border: 3px solid #FFD700;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); margin-bottom: 15px;
    background-size: cover; background-position: center; background-color: #222; position: relative; z-index: 1;
}
.sidebar-my-name { font-size: 22px; font-weight: 700; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; text-align: center; width: 100%; position: relative; z-index: 1; }

.sidebar-scroll-area { flex-grow: 1; overflow-y: auto; padding-bottom: 20px; background: linear-gradient(180deg, rgba(15, 12, 21, 0) 0%, rgba(139, 92, 246, 0.05) 100%); scrollbar-width: none; }
.sidebar-item {
    position: relative; padding: 16px 20px; display: flex; align-items: center; gap: 15px;
    font-size: 15px; font-weight: 700; color: #e0e0e0; cursor: pointer;
    transition: all 0.3s ease; margin: 5px 15px; border-radius: 10px; overflow: hidden;
}
.sidebar-item i { width: 30px; text-align: center; font-size: 20px; color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); transition: 0.3s; }
.sidebar-item::after {
    content: ''; position: absolute; bottom: 0; left: 15%; width: 70%; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), rgba(255, 215, 0, 0.5), rgba(139, 92, 246, 0.5), transparent); opacity: 0.4;
}
.sidebar-item:last-child::after { display: none; }
.sidebar-item:hover { background: linear-gradient(90deg, rgba(255, 215, 0, 0.05), transparent); transform: translateX(-5px); color: #fff; }
.sidebar-item:hover i { transform: scale(1.1); text-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }

/* ================= 8. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Bottom Sheets) ================= */
.bottom-sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 20000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; justify-content: center; }
.bottom-sheet-overlay.active { opacity: 1; pointer-events: auto; }
.bottom-sheet {
    width: 100%; max-width: 500px; background: rgba(20, 20, 25, 0.95); backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255,255,255,0.1); border-radius: 25px 25px 0 0;
    transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    padding: 15px 15px 40px 15px; box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
    max-height: 80vh; overflow-y: auto; z-index: 10001;
}
.bottom-sheet-overlay.active .bottom-sheet { transform: translateY(0); }
.sheet-handle { width: 50px; height: 5px; background: #555; border-radius: 10px; margin: 0 auto 25px auto; }
.sheet-action {
    display: flex; align-items: center; gap: 15px; padding: 16px 20px;
    font-size: 16px; color: #fff; border-radius: 16px; margin-bottom: 8px;
    cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.03);
}
.sheet-action:active { background: rgba(255,255,255,0.08); transform: scale(0.98); }
.sheet-action i { width: 30px; text-align: center; font-size: 18px; color: #ddd; }
.sheet-action.danger { color: #ff5555; background: rgba(255, 85, 85, 0.05); }

/* ================= 9. Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… (Royal FAB) ================= */
.floating-fab {
    position: fixed; bottom: 30px; left: 25px; z-index: 9000;
    width: 60px; height: 60px; border-radius: 50%;
    background: linear-gradient(135deg, #FFD700 0%, #d4af37 100%);
    box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 0 15px rgba(255, 215, 0, 0.3), inset 0 2px 0 rgba(255,255,255,0.3);
    border: 1px solid rgba(255, 215, 0, 0.5);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s; animation: floatBreathing 3s ease-in-out infinite;
}
.floating-fab i { font-size: 24px; color: #1a1a1a; transition: 0.3s; }
.floating-fab:active { transform: scale(0.9); }
.floating-fab:active i { transform: rotate(-15deg); }
@keyframes floatBreathing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

/* ================= 10. Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù‚ØµØµ (Royal Mauve Theme) ================= */
#storyArchiveModal .modal-box {
    background: linear-gradient(160deg, #181020, #000000) !important;
    backdrop-filter: blur(35px); border: 1px solid rgba(126, 34, 206, 0.3);
    border-top: 2px solid #7e22ce; border-bottom: 1px solid #581c87;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.95), 0 0 30px rgba(126, 34, 206, 0.15);
    border-radius: 24px; width: 95%; max-width: 450px; height: 80vh;
    display: flex; flex-direction: column; overflow: hidden; animation: slideUpFade 0.4s ease;
}
.archive-item {
    position: relative; width: 100%; aspect-ratio: 9/16;
    background: rgba(126, 34, 206, 0.03); border-radius: 12px; overflow: hidden; cursor: pointer;
    border: 1px solid rgba(126, 34, 206, 0.15); transition: transform 0.2s, border-color 0.2s;
}
.archive-item:active { transform: scale(0.96); border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.25); }
.archive-media { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }

/* ================= 11. Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (Story Viewer) ================= */
#storyViewer {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 25000; flex-direction: column;
}
.story-blur-bg {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center; filter: blur(30px) brightness(0.6);
    opacity: 0.8; z-index: 1; transition: background 0.5s ease;
}
.story-media-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center; z-index: 2;
    perspective: 1000px; transform-style: preserve-3d;
}
.story-media-container img, .story-media-container video {
    max-width: 100%; max-height: 100%; object-fit: contain; width: 100%;
}
.progress-bars-wrapper {
    position: absolute; top: 10px; left: 10px; right: 10px; display: flex; gap: 4px; z-index: 30;
}
.progress-segment { height: 3px; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
.progress-fill { height: 100%; width: 0%; background: #fff; }

.story-footer {
    position: absolute; bottom: 20px; left: 0; width: 100%; padding: 0 15px;
    display: flex; align-items: center; gap: 10px; z-index: 30;
}
.story-reply-input { flex: 1; position: relative; margin-left: 10px; }
.story-reply-input input {
    width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
    border-radius: 25px; padding: 12px 15px 12px 45px; color: #fff; outline: none; backdrop-filter: blur(5px);
}
.send-btn-inside {
    position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
    color: var(--accent-color); font-size: 18px; cursor: pointer; z-index: 10;
}
.story-reaction-btn { font-size: 24px; cursor: pointer; transition: 0.2s; padding: 5px; }
.story-header-info {
    position:absolute; top:20px; left:20px; right:20px; display:flex; justify-content:space-between; align-items:center; z-index:30;
}
.story-user-avatar-small { width: 32px; height: 32px; border-radius: 50%; background-size: cover; border: 1px solid #fff; }
.story-views-count {
    color: #fff; font-size: 14px; background: rgba(0,0,0,0.6); padding: 6px 14px;
    border-radius: 20px; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(5px);
}
.story-options-sheet {
    position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a;
    border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s;
    z-index: 30000; padding: 20px 0; border-top: 1px solid rgba(255,255,255,0.1);
}
.story-options-sheet.active { transform: translateY(0); }
.story-opt-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; color: #fff; cursor: pointer; }
.story-sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 29000; opacity: 0; pointer-events: none; transition: 0.3s; }
.story-sheet-overlay.active { opacity: 1; pointer-events: auto; }
#floatingHearts { position: fixed; bottom: 0; right: 20px; width: 100px; height: 100vh; pointer-events: none; z-index: 99999; overflow: visible; }
@keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 10% { opacity: 1; transform: translateY(-50px) scale(1.2); } 100% { transform: translateY(-80vh) scale(1); opacity: 0; } }

/* ================= 12. Ù†ÙˆØ§ÙØ° Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Popups) ================= */
.custom-modal {
    position: fixed; inset: 0; z-index: 200000; display: none; align-items: flex-start; justify-content: center;
    background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); padding-top: 80px;
}
.modal-box {
    background: #161616; width: 90%; max-width: 380px; border-radius: 24px; padding: 20px;
    border: 1px solid #2a2a2a; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}
.search-results-popup {
    position: fixed; top: 130px; left: 50%; transform: translateX(-50%); width: 94%; max-width: 500px; max-height: 50vh;
    background: #111; border: 1px solid #FFD700; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.9);
    z-index: 9999999; overflow-y: auto; display: none;
}
.search-results-popup.active { display: block !important; animation: slideDown 0.3s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
.search-result-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
.highlight-text { color: #FFD700; font-weight: bold; background: rgba(255, 215, 0, 0.15); padding: 0 2px; border-radius: 4px; }

#toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    background: #222; border: 1px solid #444; color: #fff; padding: 12px 25px; border-radius: 30px;
    font-size: 14px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 10000;
}
#toast.show { opacity: 1; bottom: 110px; }

.input-error { border-color: #ff3b30 !important; color: #ff3b30 !important; box-shadow: 0 0 10px rgba(255, 59, 48, 0.4) !important; animation: shakeInput 0.4s ease-in-out; }
@keyframes shakeInput { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-10px); } 40% { transform: translateX(10px); } 60% { transform: translateX(-10px); } 80% { transform: translateX(10px); } }

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…ØµØºØ±Ø© */
.profile-preview-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 25000;
    display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
}
.profile-preview-card {
    width: 280px; background: #1e1e1e; border-radius: 20px; overflow: hidden;
    position: relative; animation: zoomIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
@keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.pp-image-container { width: 100%; height: 280px; position: relative; background: #000; }
.pp-image-container img { width: 100%; height: 100%; object-fit: cover; }
.pp-name-overlay {
    position: absolute; top: 10px; left: 0; width: 100%; padding: 5px 15px;
    color: #fff; font-size: 18px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent); pointer-events: none;
}
.pp-actions { display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); }
.pp-actions div { color: var(--accent-color); font-size: 22px; padding: 10px; cursor: pointer; width: 100%; text-align: center; }

/* ØµÙØ­Ø© Ø§Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ† */
#restrictedPage { z-index: 200000 !important; }

/* Ø£Ø²Ø±Ø§Ø± ÙˆÙ…Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.pro-input { width: 100%; background: #0d0d0f; border: 1px solid #333; border-radius: 12px; padding: 14px; color: #fff; outline: none; transition: 0.3s; }
.pro-input:focus { border-color: #8b5cf6; box-shadow: 0 0 15px rgba(139, 92, 246, 0.15); }
.btn-purple { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; border: none; padding: 14px; border-radius: 16px; font-weight: bold; cursor: pointer; width: 100%; }
.btn-dark { background: #1f1f1f; color: #aaa; border: 1px solid #333; padding: 12px; border-radius: 16px; font-weight: bold; cursor: pointer; width: 100%; }
.input-group { position: relative; margin-bottom: 15px; width: 100%; }
.new-chat-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
.nc-avatar { width: 45px; height: 45px; border-radius: 14px; background-size: cover; background-position: center; border: 1px solid rgba(255,255,255,0.1); }
.nc-name { font-size: 15px; font-weight: bold; color: #fff; }
/* --- Ø³ØªØ§ÙŠÙ„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ --- */
#accountSwitcherModal .modal-box {
    background: #161616;
    width: 90%;
    max-width: 380px;
    border-radius: 24px;
    padding: 25px;
    border: 1px solid #2a2a2a;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.account-list {
    text-align: right;
    max-height: 250px;
    overflow-y: auto;
    background: #0d0d0f;
    border-radius: 16px;
    padding: 10px;
    margin-bottom: 20px;
    border: 1px solid #1f1f1f;
}

.acc-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.3s;
    background: rgba(255,255,255,0.02);
    border: 1px solid transparent;
}
.acc-item:hover { background: #1f1f1f; border-color: #333; }

/* Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.input-group {
    position: relative;
    margin-bottom: 15px;
    width: 100%;
}

.input-icon {
    position: absolute;
    top: 50%;
    right: 15px; /* Ù…ÙƒØ§Ù†Ù‡Ø§ ÙŠÙ…ÙŠÙ† Ø¹Ø´Ø§Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠ */
    transform: translateY(-50%);
    color: #555;
    font-size: 16px;
    z-index: 2;
}

.pro-input {
    width: 100%;
    background: #0d0d0f;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 14px 45px 14px 15px; /* Ù…Ø³Ø§ÙØ© ÙŠÙ…ÙŠÙ† Ø¹Ø´Ø§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
    color: #fff;
    font-size: 14px;
    outline: none;
    transition: 0.3s;
}

.pro-input:focus {
    border-color: #8b5cf6;
    background: #111;
    box-shadow: 0 0 15px rgba(139, 92, 246, 0.15);
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠØ© ÙˆØ§Ù„Ø¯Ø§ÙƒÙ†Ø© */
.modal-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.btn-purple {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 16px;
    font-weight: 800;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.btn-dark {
    background: #1f1f1f;
    color: #aaa;
    border: 1px solid #333;
    padding: 12px;
    border-radius: 16px;
    font-weight: 700;
    cursor: pointer;
}


    </style>
</head>

<body>

    <header class="main-header">
        <div id="menuBtn" class="icon-btn" onclick="vibrate(); toggleSidebar()">
            <i class="fa-solid fa-bars-staggered"></i>
        </div>
        <div id="backBtn" class="icon-btn" onclick="vibrate(); showSection('inbox')" style="display: none;">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
<div id="headerTitle" class="header-title luxury-logo-container">
    <span class="gold-text">Wareed</span>
    <i class="fa-solid fa-heart-pulse miracle-heart"></i>
    <span class="gold-text">chat</span>
</div>

        <div id="headerIcons" class="header-icons">
            <div class="icon-btn" onclick="vibrate(); location.href='home.html'">
                <i class="fa-solid fa-house"></i>
            </div>
        </div>
    </header>
<div id="searchContainer" class="search-wrapper">
    <div class="search-input-box">
        <i class="fa-solid fa-magnifying-glass search-icon-inside"></i>
        <input type="text" id="globalSearchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø´Ø®Øµ..." oninput="handleGlobalSearch(this.value)">
        <i id="closeSearchBtn" class="fa-solid fa-xmark" style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:#777; cursor:pointer; display:none;" onclick="closeSearchPopup()"></i>
    </div>
</div>

<div id="storiesContainer" class="stories-section" style="display:none;">
    <div class="stories-title">Ø§Ù„Ù‚ØµØµ</div>
    <div class="stories-scroll" id="storiesList">
        </div>
</div>

<div id="quickUsersContainer" class="quick-users-section" style="display:none;">
    <div class="quick-users-title">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</div>
    <div class="quick-users-scroll" id="quickUsersList">
        </div>
</div>


   
    <div id="storyViewer">
        <div class="story-blur-bg" id="storyBlurBg"></div>
        
        <div class="progress-bars-wrapper" id="storyBarsContainer"></div>

        <div class="story-header-info">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-xmark" onclick="closeStory()" style="color:#fff; font-size:24px; cursor:pointer; text-shadow:0 2px 5px #000; padding:10px; z-index:50;"></i>
                
                                      <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;" onclick="viewUserProfileFromStory()">
                <div id="storyUserAvatarSmall" class="story-user-avatar-small"></div>
                <div class="story-user-details">
                    <div id="storyViewerName" style="color:#fff; font-weight:bold; text-shadow:0 2px 5px #000; font-size: 14px; display:flex; align-items:center;">User</div>
                    <div id="storyTimeAgo" style="color:#ddd; font-size:11px; text-shadow:0 1px 3px #000;">Ù…Ù†Ø° Ø¯Ù‚ÙŠÙ‚Ø©</div>
                </div>
            </div>

            </div>
            
            <div style="display:flex; align-items:center; gap: 5px;">
                <div id="storyViewsCount" class="story-views-count" style="display:none; margin-left: 10px;"></div>
                
                <i id="storyMuteBtn" class="fa-solid fa-volume-high" onclick="toggleStoryMute(this)" style="color:#fff; font-size:18px; cursor:pointer; text-shadow:0 2px 5px #000; padding:10px; display:none; z-index:50;"></i>
                
                <div class="story-more-btn" onclick="openStoryOptions(event)">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </div>
            </div>
        </div>

        <div class="story-media-container" id="storyContent"></div>

               <div id="storyFooter" class="story-footer" onclick="event.stopPropagation()">
            <div class="story-reply-input">
                <input type="text" id="storyReplyInput" placeholder="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©..." enterkeyhint="send" onfocus="pauseForInput()" onblur="resumeFromInput()">
                
                <i class="fa-solid fa-paper-plane send-btn-inside" onclick="sendStoryReply()"></i>
            </div>
            
            <div class="story-reaction-btn" onclick="sendQuickReaction('â¤ï¸')">â¤ï¸</div>
            <div class="story-reaction-btn" onclick="sendQuickReaction('ğŸ”¥')">ğŸ”¥</div>
            <div class="story-reaction-btn" onclick="sendQuickReaction('ğŸ˜‚')">ğŸ˜‚</div>
        </div>


        <div id="floatingHearts" style="position: absolute; bottom: 0; right: 20px; width: 50px; height: 100%; pointer-events: none; z-index: 25; overflow: hidden;"></div>
    </div>

    
    <div class="story-sheet-overlay" id="storyOptionsOverlay" onclick="closeStoryOptions()"></div>
    <div class="story-options-sheet" id="storyOptionsSheet">
        <div class="sheet-handle" style="margin-bottom:15px;"></div>
        <div id="storyDynamicOptions"></div>
        <div class="story-opt-item" onclick="downloadStoryMedia()">
            <i class="fa-solid fa-download"></i> Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø²
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
   <div class="sidebar" id="sidebar">
    <div class="sidebar-profile-header">
        <div id="profileAvatarContainer" class="sidebar-avatar-container"></div>
        <div id="myNameTxt" class="sidebar-my-name">...</div>
        <div class="sidebar-my-status" style="color:#aaa; font-size:12px; margin-top:5px;">NAPD Messenger Pro</div>
    </div>
    
    <div class="sidebar-scroll-area">
        
        
        <div class="sidebar-item" onclick="vibrate(); toggleMyActivity()">
            <i class="fa-solid fa-ghost"></i> 
            <span id="activityText">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·: Ø¸Ø§Ù‡Ø±</span>
            <div id="activityDot" style="width:12px; height:12px; border-radius:50%; background:#4ade80; margin-right:auto;"></div>
        </div>
        
          <div class="sidebar-item" onclick="vibrate(); showSection('inbox')">
            <i class="fa-solid fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª
        </div>
        
<div class="sidebar-item" onclick="window.location.href='create_group.html'">
    <i class="fa-solid fa-users-rectangle"></i> Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
</div>


<div class="sidebar-item" onclick="toggleAppSounds()">
    <i id="soundIcon" class="fa-solid fa-volume-high"></i> 
    <span id="soundText">Ø£ØµÙˆØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
    <div id="soundToggle" class="toggle-switch active" style="margin-right:auto;">
        <div class="toggle-knob"></div>
    </div>
</div>
<div class="sidebar-item" onclick="openStoryArchive()">
    <i class="fa-solid fa-clock-rotate-left" style="color: #f59e0b;"></i> Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù‚ØµØµ
</div>

      
        
        <div class="sidebar-item" onclick="vibrate(); showSection('archive')">
            <i class="fa-solid fa-box-archive"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        </div>
        
        <div class="sidebar-item" onclick="vibrate(); showSection('requests')">
            <i class="fa-solid fa-envelope-open-text"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </div>
        
        <div class="sidebar-item" onclick="vibrate(); showSection('friends')">
            <i class="fa-solid fa-user-group"></i> Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        </div>
        <div class="sidebar-item" onclick="openRestrictedPage()">
    <i class="fa-solid fa-user-shield" style="color: #f59e0b;"></i> 
    <span>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚ÙŠØ¯Ø©</span>
</div>

        <div class="sidebar-item" onclick="vibrate(); location.href='blocked.html'" style="color: #ff7777;">
            <i class="fa-solid fa-ban" style="color: #ff7777;"></i> Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
        </div>
<div class="sidebar-item" onclick="openSecretChatsFlow()">
    <i class="fa-solid fa-user-secret" style="color: #ff3b30;"></i> 
    <span>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©</span>
    <i class="fa-solid fa-lock" style="font-size:12px; color:#555; margin-right:auto;"></i>
</div>

        <div style="height: 1px; background: rgba(255,255,255,0.05); margin: 10px 20px;"></div>

        <div class="sidebar-item" onclick="vibrate(); openAccountSwitcher()">
            <i class="fa-solid fa-users-gear" style="color: var(--verify-color);"></i> 
            ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
        </div>

    </div>
</div>
    
    

    <div class="bottom-sheet-overlay" id="optionsModal" onclick="closeOptions()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <div style="text-align:center; margin-bottom:20px;">
                <div id="sheetAvatar" style="width:70px; height:70px; border-radius:50%; margin:0 auto 10px auto; background-size:cover; border:2px solid var(--accent-color);"></div>
                <h3 id="sheetName" style="color:#fff;">User</h3>
            </div>
            
            
            <div class="sheet-action group-create" onclick="vibrate(); createGroupAction()">
                <i class="fa-solid fa-users"></i> <span>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
            </div>
            <div class="sheet-action" onclick="vibrate(); togglePinAction()">
                <i class="fa-solid fa-thumbtack"></i> <span id="pinText">ØªØ«Ø¨ÙŠØª</span>
            </div>
            <div class="sheet-action" onclick="vibrate(); toggleReadAction()">
                <i class="fa-solid fa-circle-check"></i> <span id="markReadText">Ù‚Ø±Ø§Ø¡Ø©</span>
            </div>
<div class="sheet-action" id="lockOptionBtn" onclick="vibrate(); openSetChatPassModal()">
    <i class="fa-solid fa-lock" id="lockOptionIcon"></i> <span id="lockOptionText">Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
</div>


<div class="sheet-action" onclick="vibrate(); initAddToSecret(selectedChatId)">
    <i class="fa-solid fa-mask" style="color: #ff3b30;"></i> 
    <span style="color: #ff3b30;">Ù†Ù‚Ù„ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©</span>
</div>

            <div class="sheet-action" onclick="vibrate(); toggleMuteAction()">
                <i class="fa-solid fa-bell-slash"></i> <span id="muteText">ÙƒØªÙ…</span>
            </div>
            <div class="sheet-action" onclick="vibrate(); archiveChatAction()">
                <i class="fa-solid fa-box-archive"></i> <span id="archiveText">Ø£Ø±Ø´ÙØ©</span>
            </div>
            <div class="sheet-action danger" onclick="vibrate(); deleteChatAction()">
                <i class="fa-solid fa-trash"></i> <span>Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
            </div>
            <div id="dynamicBlockBtnContainer"></div>
        </div>
    </div>

    <div id="toast"><i class="fa-solid fa-info-circle"></i> <span>ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!</span></div>
<div id="listTitleContainer" style="padding: 10px 25px; display:flex; align-items:center;">
    <span id="listTitleText" style="font-size: 18px; font-weight: 800; color: #fff;">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</span>
</div>


    <div id="list" style="padding-bottom: 20px;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        moment.locale('ar');
        
        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c", 
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.firebasestorage.app"
        };

        // 2. Initialize App
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

        // 3. Define Services
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 4. Global Variables
        window.isOnlineFeatureEnabled = localStorage.getItem('nabd_online_status') !== 'false';
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        
        let currentUser = null;
        let usersCache = {}; 
        let friendUids = new Set();
        let allChats = [];
        let currentView = 'inbox'; 
        let myActivityVisible = true; 
        let selectedChatId = null;
        let selectedChatData = null;
        
        // --- Story System Global Variables ---
        let isStoryMuted = false;
        let storyGroups = []; 
        let currentGroupIndex = 0; 
        let currentStoryIndex = 0; 
        let storyTimer = null;
        let isStoryPaused = false;
        let storyDuration = 5000;
let areGesturesSetup = false; 
let searchDebounceTimer;
let pendingChatId = null; // Ù„ØªØ®Ø²ÙŠÙ† ID Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØªÙŠ Ù†Ø­Ø§ÙˆÙ„ ÙØªØ­Ù‡Ø§
let pendingChatName = null;
let pendingChatUid = null;
let pendingChatRequest = null;

let secretOperation = null; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ù… Ø¥Ø¶Ø§ÙØ© Ø´Ø§Øª)
let targetChatForSecret = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø®ÙØ§Ø¤Ù‡ Ù…Ø¤Ù‚ØªØ§Ù‹
let hiddenActiveUsersSet = new Set();


        const notificationAudio = document.getElementById('notificationSound');

        // --- Helper Functions ---
        function vibrate() { if(navigator.vibrate) navigator.vibrate(10); }

        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            t.querySelector('span').innerText = msg; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 2000); 
        }

function initApp() {
    // 1. Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙˆØ±Ø§Ù‹
    const cachedChats = sessionStorage.getItem('cached_allChats');
    const savedScroll = sessionStorage.getItem('scrollPos');

    if (cachedChats) {
        try { 
            // Ù„Ùˆ ÙÙŠÙ‡ ÙƒØ§Ø´ØŒ Ø§Ø¹Ø±Ø¶Ù‡ ÙÙˆØ±Ø§Ù‹
            allChats = JSON.parse(cachedChats); 
            renderList(); 
            
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ (Ø¹Ø´Ø§Ù† ÙŠØ±Ø¬Ø¹Ùƒ Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù„ÙŠ ÙƒÙ†Øª ÙÙŠÙ‡)
            if(savedScroll) {
                setTimeout(() => window.scrollTo(0, parseInt(savedScroll)), 0);
            }
        } catch(e) {
            console.error("Cache Error", e);
        }
    } else {
        // Ù„Ùˆ Ù…ÙÙŠØ´ ÙƒØ§Ø´ Ø¨Ø³ (Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠÙØªØ­)ØŒ Ø§Ø¸Ù‡Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        showSkeletonLoading(); 
    }
    
    // 2. Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ØµØµ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    const cachedStories = sessionStorage.getItem('cached_stories_data');
    if (cachedStories) {
        try {
            const storiesData = JSON.parse(cachedStories);
            // Ø¨Ù†Ù†Ø§Ø¯ÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø´
            buildStoriesDOM(storiesData); 
        } catch(e) {}
    }

    // 3. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø¹Ø´Ø§Ù† ÙŠØ¬ÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
    auth.onAuthStateChanged(user => {
        if(!user){ location.href = "index.html"; return; }
        currentUser = user;
        
        db.collection('users').doc(user.uid).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                myActivityVisible = d.showActivity !== false;
                updateSidebarProfile(d);
                updateActivityUI();
            }
            loadFriendsList(user.uid);
            monitorIncomingMessages(user.uid); 
            loadChats(user.uid); 
            startPresenceSystem(); 
            // Ø´ØºÙ„Ù†Ø§ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù‚ØµØµ Ù‡Ù†Ø§
            renderStories(); 
            
        });
    });
}

        
        function showSkeletonLoading() {
            const list = document.getElementById("list");
            let html = "";
            for(let i=0; i<5; i++) html += `
                <div class="chat" style="pointer-events:none; margin:10px 10px;">
                    <div class="skeleton" style="width:58px; height:58px; border-radius:18px;"></div>
                    <div style="width:100%; display:flex; flex-direction:column; gap:8px;">
                        <div class="skeleton" style="width:40%; height:15px;"></div>
                        <div class="skeleton" style="width:70%; height:12px;"></div>
                    </div>
                </div>`;
            list.innerHTML = html;
        }

        function updateSidebarProfile(data) {
    // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
    const userAuthPhoto = currentUser.photoURL;
    const dbPhoto = data.profilePic || data.avatarUrl || data.image; 
    const finalAvatar = dbPhoto || userAuthPhoto || defaultAvatar;

    document.getElementById('profileAvatarContainer').style.backgroundImage = `url('${finalAvatar}')`;
    
    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ­Ø¬Ù… Ø§Ù„Ø®Ø· (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    let nameText = data.name || currentUser.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
    const nameEl = document.getElementById('myNameTxt');

    // Ù…Ø¹Ø§Ø¯Ù„Ø© ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·ÙˆÙ„ Ø§Ù„Ø§Ø³Ù…
    if (nameText.length > 25) {
        nameEl.style.fontSize = "15px"; // Ø®Ø· ØµØºÙŠØ± Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹
    } else if (nameText.length > 15) {
        nameEl.style.fontSize = "18px"; // Ø®Ø· Ù…ØªÙˆØ³Ø·
    } else {
        nameEl.style.fontSize = "22px"; // Ø®Ø· ÙƒØ¨ÙŠØ± Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚ØµÙŠØ±Ø©
    }

    // 3. Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¥Ù† ÙˆØ¬Ø¯Øª
    let finalHTML = nameText;
    if(data.isVerified) {
        // Ø¬Ø¹Ù„Ù†Ø§ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø£ØµØºØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ù…
        finalHTML += ` <i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size: 0.9em;"></i>`;
    }
    
    nameEl.innerHTML = finalHTML;
}

// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù‚ØµØµ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© (Ù…Ù†ÙØµÙ„Ø© Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ ÙˆØ§Ù„Ù†Øª)
function drawStoriesUI(groups) {
    const list = document.getElementById('storiesList');
    list.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    // 1. ÙƒØ§Ø±Øª "Ù‚ØµØªÙƒ" (Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©) - Ø¯Ø§ÙŠÙ…Ø§Ù‹ Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£ÙˆÙ„
    // Ø¨Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    const myAvatar = currentUser.photoURL || defaultAvatar;
    
    const myCard = document.createElement('div');
    myCard.className = 'story-card my-story-card';
    myCard.innerHTML = `
        <div class="my-story-top-img" style="background-image: url('${myAvatar}');"></div>
        <div class="my-story-bottom">
            <div class="add-story-btn-circle"><i class="fa-solid fa-plus"></i></div>
            <div style="font-size:12px; font-weight:bold; color:#fff;">Ø¥Ù†Ø´Ø§Ø¡ Ù‚ØµØ©</div>
        </div>
    `;
    myCard.onclick = () => { window.location.href = 'add_story.html'; };
    list.appendChild(myCard);

    // 2. Ø±Ø³Ù… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù‚ØµØµ (Ø³ÙˆØ§Ø¡ Ø¨ØªØ§Ø¹ØªÙŠ Ø£Ùˆ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡)
    groups.forEach((group, index) => {
        // Ù„Ùˆ Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø¯Ù‡ Ù‡Ùˆ "Ù‚ØµØªÙƒ" (Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ) ÙˆÙ„Ù‡Ø§ Ø´ÙƒÙ„ Ù…Ù…ÙŠØ²
        const isMe = group.user.uid === currentUser.uid;
        
        // Ø¢Ø®Ø± Ù‚ØµØ© ÙÙŠ Ø§Ù„Ø¬Ø±ÙˆØ¨ (Ø¹Ø´Ø§Ù† Ø§Ù„ØºÙ„Ø§Ù)
        const lastStory = group.stories[group.stories.length - 1];
        
        // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± (Ø£Ø²Ø±Ù‚ Ù„Ùˆ Ø´ÙˆÙØªÙ‡Ø§ØŒ Ù…Ù„ÙˆÙ† Ù„Ùˆ Ù„Ø³Ù‡)
        // Ø¨Ù†Ø´ÙŠÙƒ Ù„Ùˆ ÙÙŠÙ‡ Ù‚ØµØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ø§Ù„Ø£Ù‚Ù„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
        const hasUnseen = group.stories.some(s => !s.viewers || !s.viewers.includes(currentUser.uid));
        const borderCol = (isMe) ? '#ddd' : (hasUnseen ? 'var(--accent-color)' : '#555');

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØ±Ø©)
        // Ø¨Ù†Ø­Ø· poster Ù„Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø¨Ù†Ø®ÙÙŠ Ø§Ù„ØµÙˆØª Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
        let contentHTML = lastStory.type === 'video' 
            ? `<video src="${lastStory.url}#t=0.1" class="story-card-bg" style="object-fit:cover;" muted preload="metadata"></video>`
            : `<div class="story-card-bg" style="background-image:url('${lastStory.url}'); background-size:cover; background-position:center;"></div>`;

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚
        let displayNameHTML = isMe ? "Ù‚ØµØªÙƒ" : group.user.name;
        if (!isMe && group.user.isVerified) displayNameHTML += ` <i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:10px; vertical-align: middle;"></i>`;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ø±Øª
        const item = document.createElement('div');
        item.className = 'story-card';
        item.onclick = () => openStoryViewer(index); // Ø§Ù„Ø§Ù†Ø¯ÙƒØ³ Ù‡Ù†Ø§ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©

        item.innerHTML = `
            <div class="story-card-avatar" style="background-image:url('${group.user.avatar}'); border-color:${borderCol}"></div>
            ${contentHTML}
            <div class="story-card-name">${displayNameHTML}</div>`;
        
        list.appendChild(item);
    });
}


        // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (Ù†Ø¸Ø§Ù… ÙƒØ±ÙˆØª ÙÙŠØ³Ø¨ÙˆÙƒ)
                // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØµÙˆØ± ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ«ÙŠÙ‚)
        function renderStories() {
    const list = document.getElementById('storiesList');
    const container = document.getElementById('storiesContainer');
    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

    if(currentView === 'inbox') container.style.display = 'block';

    db.collection('stories')
    .where('timestamp', '>', twentyFourHoursAgo)
    .orderBy('timestamp', 'asc')
    .onSnapshot(async snapshot => {
        const storiesMap = {};

        snapshot.docs.forEach(doc => {
            
            const d = doc.data();
            if (d.isArchived === true) return; 

            if(!storiesMap[d.uid]) storiesMap[d.uid] = [];
            storiesMap[d.uid].push({ id: doc.id, ...d });
    
        });

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹ Ù…ÙƒØ§Ù†Ùƒ ÙÙŠ Ø§Ù„Ù‚ØµØ©
        const isViewerOpen = document.getElementById('storyViewer').style.display === 'flex';

        list.innerHTML = ''; 
        storyGroups = [];
    // Ø¶ÙŠÙ Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙˆØ±Ø§Ù‹
    const cachedStories = sessionStorage.getItem('my_cached_stories');
    if (cachedStories) {
        // Ù‡Ù†Ø§ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ ÙƒÙˆØ¯ Ø§Ù„Ø±Ø³Ù… Ø£Ùˆ ØªÙ†Ø§Ø¯ÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ù„Ùˆ Ø¹Ø§Ù…Ù„Ù‡Ø§
        // Ù„Ùˆ Ù…Ø´ Ø¹Ø§Ù…Ù„ Ø¯Ø§Ù„Ø© Ø±Ø³Ù…ØŒ Ø­Ø· ÙƒÙˆØ¯ Ø§Ù„Ù€ innerHTML ÙˆØ§Ù„Ù„ÙˆØ¨ Ù‡Ù†Ø§
    }

        // ==========================================
        // 1. ÙƒØ§Ø±Øª "Ù‚ØµØªÙƒ" (Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ)
        // ==========================================
                const myStories = storiesMap[currentUser.uid] || [];
        
        let myData = usersCache[currentUser.uid];
        if(!myData) myData = await fetchAndCacheUser(currentUser.uid);

        const myUserObj = { 
            uid: currentUser.uid, 
            name: 'Ù‚ØµØªÙƒ', 
            avatar: myData.avatar || currentUser.photoURL || defaultAvatar,
            isVerified: myData.isVerified 
        };
        
        // Ø¯ÙŠ Ù…Ù‡Ù…Ø© Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù‚ØµØµ ØªÙ‚Ø¯Ø± ØªÙØªØ­Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¹Ø§Ø±Ø¶
        if (myStories.length > 0) {
            storyGroups.push({ user: myUserObj, stories: myStories });
        }

        // ==========================================
        // ÙƒØ§Ø±Øª "Ø¥Ù†Ø´Ø§Ø¡ Ù‚ØµØ©" (Ø§Ù„Ø²Ø±Ø§Ø±)
        // ==========================================
        const myCard = document.createElement('div');
        myCard.className = 'story-card my-story-card';
        
        let myProfilePic = myUserObj.avatar;
        
        // ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§: Ø´ÙŠÙ„Ù†Ø§ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        myCard.innerHTML = `
            <div class="my-story-top-img" style="background-image: url('${myProfilePic}');"></div>
            <div class="my-story-bottom">
                <div class="add-story-btn-circle"><i class="fa-solid fa-plus"></i></div>
                <div style="font-size:12px; font-weight:bold; color:#fff;">Ø¥Ù†Ø´Ø§Ø¡ Ù‚ØµØ©</div>
            </div>
        `;
        
        // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ”¥
        myCard.onclick = () => { 
            window.location.href = 'add_story.html'; 
        };
        
        list.appendChild(myCard);

        // ==========================================
        // ÙƒØ§Ø±Øª "Ù…Ø´Ø§Ù‡Ø¯Ø© Ù‚ØµØªÙƒ" (Ù„Ùˆ Ù†Ø´Ø±Øª Ø­Ø§Ø¬Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
        // ==========================================
        if (myStories.length > 0) {
            const myViewCard = document.createElement('div');
            myViewCard.className = 'story-card';
            const lastStory = myStories[myStories.length - 1];
            
            let bgContent = lastStory.type === 'video' 
                ? `<video src="${lastStory.url}" class="story-card-bg" style="object-fit:cover;" muted></video>`
                : `<div class="story-card-bg" style="background-image:url('${lastStory.url}'); background-size:cover; background-position:center;"></div>`;

            let myDisplayName = "Ù‚ØµØªÙƒ";
            myViewCard.innerHTML = `
                <div class="story-card-avatar" style="background-image:url('${myProfilePic}'); border-color: #ddd;"></div>
                ${bgContent}
                <div class="story-card-name">${myDisplayName}</div>
            `;
            
            // Ù†Ø³ØªØ®Ø¯Ù… 0 Ù„Ø£Ù† Ù‚ØµØªÙŠ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©) Ø¯Ø§ÙŠÙ…Ø§Ù‹ Ø¨ØªÙƒÙˆÙ† Ø£ÙˆÙ„ Ø¬Ø±ÙˆØ¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            myViewCard.onclick = () => openStoryViewer(0); 
            list.appendChild(myViewCard);
        }

        // ==========================================
        // 2. Ù‚ØµØµ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        // ==========================================
        const otherUids = Object.keys(storiesMap).filter(uid => uid !== currentUser.uid);
        
        for (const uid of otherUids) {
                        // Ù„Ùˆ Ø§Ù„Ø´Ø§Øª Ø¯Ù‡ Ù…Ø­Ø¸ÙˆØ±ØŒ Ø¹Ø¯ÙŠ Ø§Ù„Ø¯ÙˆØ± ÙˆÙ…ØªØ±Ø³Ù…Ø´ Ù‚ØµØªÙ‡
            const chatCheck = allChats.find(c => c.otherUid === uid);
            if (chatCheck && chatCheck.isBlocked) continue;

            let u = usersCache[uid];
            if(!u) u = await fetchAndCacheUser(uid);
            
            storyGroups.push({ user: u, stories: storiesMap[uid] });
            // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø¥Ù†Ø¯ÙƒØ³
            const thisGroupIndex = storyGroups.length - 1;
            
            const userStories = storiesMap[uid];
            const lastStory = userStories[userStories.length - 1]; 
            const hasUnseen = userStories.some(s => !s.viewers || !s.viewers.includes(currentUser.uid));
            const borderCol = hasUnseen ? 'var(--accent-color)' : '#555';

            const item = document.createElement('div');
            item.className = 'story-card';
            item.onclick = () => openStoryViewer(thisGroupIndex);
            
            // Ù„Ø§Ø­Ø¸ Ø¥Ø¶Ø§ÙØ© #t=0.1 ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¥Ø¶Ø§ÙØ© preload="metadata"
let contentHTML = lastStory.type === 'video' 
    ? `<video src="${lastStory.url}#t=0.1" class="story-card-bg" style="object-fit:cover;" muted preload="metadata"></video>`
    : `<div class="story-card-bg" style="background-image:url('${lastStory.url}'); background-size:cover; background-position:center;"></div>`;


            let displayNameHTML = u.name;
            if (u.isVerified) displayNameHTML += ` <i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:10px; vertical-align: middle;"></i>`;

            item.innerHTML = `
                <div class="story-card-avatar" style="background-image:url('${u.avatar}'); border-color:${borderCol}"></div>
                ${contentHTML}
                <div class="story-card-name">${displayNameHTML}</div>`;
            
            list.appendChild(item);
        }

        // ğŸ”¥ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø³Ø­Ø±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ğŸ”¥
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù…ÙØªÙˆØ­Ø§Ù‹ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ù„ÙƒÙŠ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (isViewerOpen) {
            updateStoryUI();
            
        }
    });
}

        function openStoryViewer(groupIndex) {
    currentGroupIndex = groupIndex;
    currentStoryIndex = 0;
    isStoryPaused = false;

    const group = storyGroups[currentGroupIndex];
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ØµØµ ØºÙŠØ± Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù†Ù‡Ø§
    const firstUnseen = group.stories.findIndex(s => !s.viewers || !s.viewers.includes(currentUser.uid));
    if(firstUnseen > 0) currentStoryIndex = firstUnseen;

    const viewer = document.getElementById('storyViewer');
    viewer.style.display = 'flex';
    
    updateStoryUI();
    loadStory();

    // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ ---
    if (!areGesturesSetup) {
        setupStoryGestures(viewer);
        areGesturesSetup = true; // Ù†ØºÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    }
}


        // ======================= UI Updates & Options =======================

               
        // --- Options Menu Functions ---
        function openStoryOptions(e) {
            if(e) e.stopPropagation();
            isStoryPaused = true; 
            const vid = document.querySelector('video');
            if(vid) vid.pause();

            const group = storyGroups[currentGroupIndex];
            const user = group.user;
            const isMe = user.uid === currentUser.uid;
            
            const container = document.getElementById('storyDynamicOptions');
            container.innerHTML = '';

            // Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© openStoryOptions ÙÙŠ Ø­Ø§Ù„Ø© (isMe)
if (isMe) {
    container.innerHTML = `
        <div class="story-opt-item" onclick="archiveCurrentStoryManual()">
            <i class="fa-solid fa-box-archive" style="color: #f59e0b;"></i> 
            <span>Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¢Ù† (Ø¥Ø®ÙØ§Ø¡)</span>
        </div>

        <div style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>

        <div class="story-opt-item danger" onclick="confirmDeleteStory()">
            <i class="fa-solid fa-trash-can"></i> <span>Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</span>
        </div>
    `;
}
else {
                container.innerHTML += `
                    <div class="story-opt-item" onclick="muteUserStories('${user.uid}')">
                        <i class="fa-solid fa-bell-slash"></i> ÙƒØªÙ… Ù‚ØµØµ ${user.name}
                    </div>
                    <div class="story-opt-item danger" onclick="reportStory()">
                        <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    </div>`;
            }

            document.getElementById('storyOptionsOverlay').classList.add('active');
            document.getElementById('storyOptionsSheet').classList.add('active');
        }

        function closeStoryOptions() {
            document.getElementById('storyOptionsOverlay').classList.remove('active');
            document.getElementById('storyOptionsSheet').classList.remove('active');
            resumeFromInput(); 
        }

        function downloadStoryMedia() {
            const group = storyGroups[currentGroupIndex];
            const story = group.stories[currentStoryIndex];
            
            const a = document.createElement('a');
            a.href = story.url;
            a.target = '_blank';
            a.download = `story_${Date.now()}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„...");
            closeStoryOptions();
        }

        function confirmDeleteStory() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚ØµØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) {
                const group = storyGroups[currentGroupIndex];
                const story = group.stories[currentStoryIndex];
                deleteCurrentStory(story);
                closeStoryOptions();
            }
        }

        function muteUserStories(uid) {
            showToast("ØªÙ… ÙƒØªÙ… Ø§Ù„Ù‚ØµØµ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
            closeStoryOptions();
        }

        function reportStory() {
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©");
            closeStoryOptions();
        }

        // ======================= Story Playback & Navigation =======================

        function loadStory() {
    clearTimeout(storyTimer);
    const group = storyGroups[currentGroupIndex];
    const story = group.stories[currentStoryIndex];
    const contentDiv = document.getElementById('storyContent');
    const blurBg = document.getElementById('storyBlurBg');
    const timeAgoDiv = document.getElementById('storyTimeAgo');

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.querySelector('.story-header-info').style.opacity = '1';
    document.getElementById('storyFooter').style.opacity = '1';
    document.getElementById('storyBarsContainer').style.opacity = '1';

    if(story.timestamp) timeAgoDiv.innerText = moment(story.timestamp.toDate()).fromNow();

    let newElement;
    const mediaType = story.type || 'image';

    // ==========================================
    // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø¬Ø²Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ğŸ”¥
    // ==========================================
    if (mediaType === 'video') {
        // 1. Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ø­ØªÙ‰ ÙŠØ¬Ù‡Ø² Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        contentDiv.innerHTML = '<div style="color:#fff; font-size:30px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

        newElement = document.createElement('video');
        newElement.src = story.url;
        newElement.playsInline = true; // Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø¢ÙŠÙÙˆÙ†
        newElement.preload = "auto";   // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        
        // Ù†Ø¨Ø¯Ø£ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ÙƒØªÙˆÙ… Ø§Ù„ØµÙˆØª Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ØªØµÙØ­Ø§Øª)
        // Ø«Ù… Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
        newElement.muted = true; 

        // 2. Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ù…Ø¯Ø©)
        newElement.onloadedmetadata = () => {
            storyDuration = newElement.duration * 1000;
            if(!isFinite(storyDuration)) storyDuration = 15000; // Ø­Ù…Ø§ÙŠØ© Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¯ØªÙ‡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©
        };

        // 3. Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù„Ù„ØªØ´ØºÙŠÙ„
        newElement.oncanplay = () => {
            // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            contentDiv.innerHTML = ''; 
            contentDiv.appendChild(newElement);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            newElement.muted = isStoryMuted;

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù€ Promise Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            const playPromise = newElement.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    // Ù†Ø¬Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„
                    startProgress(storyDuration);
                    blurBg.style.background = '#000';
                }).catch(error => {
                    console.warn("Autoplay blocked, muting and retrying:", error);
                    // Ù„Ùˆ ÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØµÙˆØªØŒ Ù†ÙƒØªÙ…Ù‡ ÙˆÙ†Ø´ØºÙ„ ØªØ§Ù†ÙŠ
                    newElement.muted = true;
                    isStoryMuted = true; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                    updateMuteBtnState(); // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±
                    newElement.play();
                    startProgress(storyDuration);
                });
            }
        };

        newElement.onended = nextStory;
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        newElement.onerror = () => {
            console.error("Video Error");
            showToast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù‚ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
            setTimeout(nextStory, 2000); 
        };

    } else {
        // ==========================================
        // Ø¬Ø²Ø¡ Ø§Ù„ØµÙˆØ± (ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø¨Ø³ÙŠØ·)
        // ==========================================
        contentDiv.innerHTML = '<div style="color:#fff; font-size:30px;"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
        
        const img = new Image();
        img.src = story.url;
        
        const capturedStoryIndex = currentStoryIndex;
        const capturedGroupIndex = currentGroupIndex;

        img.onload = () => {
            if (currentStoryIndex !== capturedStoryIndex || currentGroupIndex !== capturedGroupIndex) return;

            contentDiv.innerHTML = '';
            contentDiv.appendChild(img);
            
            storyDuration = 5000;
            startProgress(5000);
            
            clearTimeout(storyTimer);
            storyTimer = setTimeout(nextStory, 5000);
            
            blurBg.style.backgroundImage = `url('${story.url}')`;
        };
        
        // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        img.onerror = () => {
            showToast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©");
            setTimeout(nextStory, 2000);
        }
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
    if (group.user.uid !== currentUser.uid) {
        if(!story.viewers || !story.viewers.includes(currentUser.uid)) {
            db.collection('stories').doc(story.id).update({
                viewers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
        }
    }
    
    preloadNextStory();
}

        function preloadNextStory() {
            const group = storyGroups[currentGroupIndex];
            // 1. Ø§Ù„Ù‚ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (currentStoryIndex + 1 < group.stories.length) {
                const next = group.stories[currentStoryIndex + 1];
                if(next.type === 'video') {
                    const v = document.createElement('video'); v.src = next.url; v.preload = 'auto';
                } else {
                    const i = new Image(); i.src = next.url;
                }
            }
            // 2. Ø£ÙˆÙ„ Ù‚ØµØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ù„ÙŠ
            else if (currentGroupIndex + 1 < storyGroups.length) {
                const nextUserStory = storyGroups[currentGroupIndex + 1].stories[0];
                if(nextUserStory.type === 'video') {
                    const v = document.createElement('video'); v.src = nextUserStory.url; v.preload = 'auto';
                } else {
                    const i = new Image(); i.src = nextUserStory.url;
                }
            }
        }

        function startProgress(duration) {
            const bar = document.getElementById(`prog-${currentStoryIndex}`);
            if(bar) {
                bar.style.transition = 'none';
                bar.style.width = '0%';
                void bar.offsetWidth;
                bar.style.transition = `width ${duration}ms linear`;
                bar.style.width = '100%';
            }
        }

        function nextStory() {
            if(isStoryPaused) return;
            const group = storyGroups[currentGroupIndex];
            
            const bar = document.getElementById(`prog-${currentStoryIndex}`);
            if(bar) { bar.style.transition = 'none'; bar.style.width = '100%'; }

            if (currentStoryIndex < group.stories.length - 1) {
                currentStoryIndex++;
                updateMuteBtnState();
                loadStory();
            } else {
                if (currentGroupIndex < storyGroups.length - 1) {
                    currentGroupIndex++;
                    currentStoryIndex = 0;
                    updateStoryUI();
                    loadStory();
                } else {
                    closeStory();
                }
            }
        }

        function prevStory() {
            const bar = document.getElementById(`prog-${currentStoryIndex}`);
            if(bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }

            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                const prevBar = document.getElementById(`prog-${currentStoryIndex}`);
                if(prevBar) { prevBar.style.transition = 'none'; prevBar.style.width = '0%'; }
                
                updateMuteBtnState();
                loadStory();
            } else {
                if (currentGroupIndex > 0) {
                    currentGroupIndex--;
                    currentStoryIndex = storyGroups[currentGroupIndex].stories.length - 1;
                    updateStoryUI();
                    loadStory();
                } else {
                    loadStory();
                }
            }
        }
        
        function updateMuteBtnState() {
             const group = storyGroups[currentGroupIndex];
             const story = group.stories[currentStoryIndex];
             const muteBtn = document.getElementById('storyMuteBtn');
             if(story.type === 'video') {
                 muteBtn.style.display = 'block';
                 muteBtn.className = isStoryMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
             } else {
                 muteBtn.style.display = 'none';
             }
        }

        function toggleStoryMute(btn) {
            isStoryMuted = !isStoryMuted;
            btn.className = isStoryMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
            const video = document.querySelector('#storyContent video');
            if(video) video.muted = isStoryMuted;
            event.stopPropagation();
        }

        // ================== GESTURE LOGIC ==================
        function setupStoryGestures(element) {
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            let longPressTimer = null;
            let isLongPressActive = false;
            let isDragging = false;

            // 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
            element.addEventListener('touchstart', (e) => {
                if(e.target.closest('#storyFooter') || e.target.closest('.story-header-info') || e.target.closest('.story-options-sheet')) return;

                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                touchStartTime = Date.now();
                isLongPressActive = false;
                isDragging = false;

                longPressTimer = setTimeout(() => {
                    if (!isDragging) {
                        isLongPressActive = true;
                        pauseStoryInteraction();
                    }
                }, 250);
            }, {passive: true});

            // 2. Ø­Ø±ÙƒØ© Ø§Ù„Ø¥ØµØ¨Ø¹
            element.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const moveX = touch.clientX - touchStartX;
                const moveY = touch.clientY - touchStartY;

                if (Math.abs(moveX) > 10 || Math.abs(moveY) > 10) {
                    isDragging = true;
                    clearTimeout(longPressTimer);
                    
                    if (isLongPressActive) {
                        resumeStoryInteraction();
                        isLongPressActive = false;
                    }
                }
            }, {passive: true});

            // 3. Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ù…Ø³
            element.addEventListener('touchend', (e) => {
                if(e.target.closest('#storyFooter') || e.target.closest('.story-header-info') || e.target.closest('.story-options-sheet')) return;
                
                clearTimeout(longPressTimer);
                const touchEndTime = Date.now();
                const timeDiff = touchEndTime - touchStartTime;
                
                if (isLongPressActive) {
                    resumeStoryInteraction();
                    return; 
                }

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                // Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„ (Ø¥ØºÙ„Ø§Ù‚)
                if (diffY > 100 && Math.abs(diffX) < 50) {
                    closeStory();
                    return;
                }

                // Ø³Ø­Ø¨ Ø¬Ø§Ù†Ø¨ÙŠ (ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
                if (Math.abs(diffX) > 60) {
                    if (diffX < 0) nextUserGroup(); // Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø±
                    else prevUserGroup(); // Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ†
                    return;
                }

                // Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                if (!isDragging && timeDiff < 250) {
                    const screenWidth = window.innerWidth;
                    if (touchEndX < screenWidth * 0.3) {
                        prevStory();
                    } else {
                        nextStory();
                    }
                }
            });

            function pauseStoryInteraction() {
                isStoryPaused = true;
                clearTimeout(storyTimer);
                const vid = document.querySelector('video');
                if(vid) vid.pause();
                
                const bar = document.getElementById(`prog-${currentStoryIndex}`);
                if(bar) {
                    const computedStyle = window.getComputedStyle(bar);
                    const w = computedStyle.getPropertyValue('width');
                    bar.style.transition = 'none';
                    bar.style.width = w;
                }

                document.querySelector('.story-header-info').style.opacity = '0';
                document.getElementById('storyFooter').style.opacity = '0';
                document.getElementById('storyBarsContainer').style.opacity = '0';
            }

            function resumeStoryInteraction() {
                isStoryPaused = false;
                document.querySelector('.story-header-info').style.opacity = '1';
                document.getElementById('storyFooter').style.opacity = '1';
                document.getElementById('storyBarsContainer').style.opacity = '1';

                const vid = document.querySelector('video');
                if (vid) {
                    vid.play();
                } else {
                     const bar = document.getElementById(`prog-${currentStoryIndex}`);
                     if(bar) {
                         bar.style.transition = `width ${storyDuration}ms linear`;
                         bar.style.width = '100%';
                     }
                     storyTimer = setTimeout(nextStory, 2000);
                }
            }
        }

        function nextUserGroup() {
            if (currentGroupIndex < storyGroups.length - 1) {
                currentGroupIndex++;
                currentStoryIndex = 0;
                updateStoryUI();
                loadStory();
            } else {
                closeStory();
            }
        }

        function prevUserGroup() {
            if (currentGroupIndex > 0) {
                currentGroupIndex--;
                currentStoryIndex = 0;
                updateStoryUI();
                loadStory();
            }
        }

        async function deleteCurrentStory(story) {
            showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...");
            closeStory(); 
            try {
                let imageRef = firebase.storage().refFromURL(story.url);
                await imageRef.delete();
                await db.collection('stories').doc(story.id).delete();
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ØµØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } catch (error) {
                db.collection('stories').doc(story.id).delete();
                showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
            }
        }

        function closeStory() { 
    const viewer = document.getElementById('storyViewer');
    viewer.style.display = 'none'; 
    document.getElementById('storyOptionsOverlay').classList.remove('active');
    document.getElementById('storyOptionsSheet').classList.remove('active');
    
    document.querySelector('.story-header-info').style.opacity = '1';
    document.getElementById('storyFooter').style.opacity = '1';
    document.getElementById('storyBarsContainer').style.opacity = '1';

    // --- ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ ---
    clearTimeout(storyTimer);
    storyTimer = null; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØªØºÙŠØ±
    
    const vid = document.querySelector('video');
    if(vid) {
        vid.pause();
        vid.src = ""; // Ø¥ÙŠÙ‚Ø§Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        vid.onended = null; // Ø¥Ù„ØºØ§Ø¡ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø«
    }

    document.getElementById('storyContent').innerHTML = '';
    isStoryPaused = false;
}

        // --- Interactions (Reactions & Input) ---
        // ============================================
// 1. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
// ============================================
// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ) ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
function sendQuickReaction(emoji) {
    // 1. Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ (Ù‚Ù„ÙˆØ¨ Ø·Ø§ÙŠØ±Ø©)
    const container = document.getElementById('floatingHearts');
    const heart = document.createElement('div');
    heart.innerText = emoji;
    heart.style.position = 'absolute';
    heart.style.bottom = '50px';
    heart.style.right = Math.random() * 50 + 'px';
    heart.style.fontSize = '30px';
    heart.style.animation = 'floatUp 2s linear forwards';
    container.appendChild(heart);
    setTimeout(() => heart.remove(), 2000);

    // 2. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    const group = storyGroups[currentGroupIndex];
    const story = group.stories[currentStoryIndex];
    
    // Ù„Ùˆ Ø£Ù†Ø§ ØµØ§Ø­Ø¨ Ø§Ù„Ù‚ØµØ© Ù…Ø´ Ù‡ÙŠÙ†ÙØ¹ Ø£ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ù†ÙØ³ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if(group.user.uid === currentUser.uid) return;

    // Ø¨Ù†Ø³ØªØ®Ø¯Ù… set Ù…Ø¹ merge Ø¹Ø´Ø§Ù† Ù†Ø¶ÙŠÙ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨ØªØ§Ø¹Ù†Ø§ Ù…Ù† ØºÙŠØ± Ù…Ø§ Ù†Ù…Ø³Ø­ ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù†Ø§Ø³
    const updateData = {};
    updateData[`reactions.${currentUser.uid}`] = emoji;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…ÙŠ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø¨Ø§Ù„Ù…Ø±Ø© (Ù„Ø£Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ ÙŠØ¹ØªØ¨Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©)
    db.collection('stories').doc(story.id).update({
        ...updateData,
        viewers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    }).then(() => {
        showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${emoji}`);
    }).catch(err => console.log(err));
}

// ============================================
// 2. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚ØµØ© Ù„Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¹ÙŠÙ† Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
// ============================================
function updateStoryUI() {
    const group = storyGroups[currentGroupIndex];
    if (!group) return; // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
    const user = group.user;
    const isMe = user.uid === currentUser.uid;
    
    // ... (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø¯ÙŠÙƒ) ...
    let nameHTML = user.name;
    if (user.isVerified) {
        nameHTML += ` <i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:14px; margin-right:5px;"></i>`;
    }
    document.getElementById('storyViewerName').innerHTML = nameHTML;
    document.getElementById('storyUserAvatarSmall').style.backgroundImage = `url('${user.avatar}')`;
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø´Ø±Ø·Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
    const barsContainer = document.getElementById('storyBarsContainer');
    barsContainer.innerHTML = '';
    group.stories.forEach((_, i) => {
        const seg = document.createElement('div');
        seg.className = 'progress-segment';
        seg.innerHTML = `<div class="progress-fill" id="prog-${i}" style="width: ${i < currentStoryIndex ? '100%' : '0%'}"></div>`;
        barsContainer.appendChild(seg);
    });

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØªØ±
    document.getElementById('storyFooter').style.display = isMe ? 'none' : 'flex';
    
    // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø¯Ø§Ø¯ + Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ”¥
    // ... Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© updateStoryUI ...

    // ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ğŸ”¥
    const viewsDiv = document.getElementById('storyViewsCount');
    const story = group.stories[currentStoryIndex];
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
    const viewCount = (story.viewers && Array.isArray(story.viewers)) ? story.viewers.length : 0;
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ø§Ù„Ø±ÙŠØ§ÙƒØ´Ù†Ø§Øª)
    const reactionsMap = story.reactions || {};
    const reactionCount = Object.keys(reactionsMap).length;

    if(isMe) {
        viewsDiv.style.display = 'flex';
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¹ÙŠÙ† ÙˆØ¬Ù†Ø¨Ù‡Ø§ Ø§Ù„Ù‚Ù„Ø¨ Ù„Ùˆ ÙÙŠÙ‡ ØªÙØ§Ø¹Ù„Ø§Øª
        let htmlContent = `<i class="fa-solid fa-eye"></i> ${viewCount}`;
        
        if (reactionCount > 0) {
            htmlContent += ` <span style="margin: 0 5px; opacity: 0.5;">|</span> <i class="fa-solid fa-heart" style="color: #ff4444;"></i> ${reactionCount}`;
        }

        viewsDiv.innerHTML = htmlContent;
        
        viewsDiv.onclick = (e) => {
            e.stopPropagation();
            showStoryViewers();
        };
        viewsDiv.style.cursor = 'pointer';
    } else {
        viewsDiv.style.display = 'none';
    }
    
    updateMuteBtnState();
}


// ============================================
// 3. Ø¯ÙˆØ§Ù„ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ÙˆØ§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ø¬Ø¯ÙŠØ¯)
// ============================================
function showStoryViewers() {
    // 1. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹
    isStoryPaused = true;
    const vid = document.querySelector('video');
    if(vid) vid.pause();

    // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const modal = document.getElementById('storyViewersModal');
    const listContainer = document.getElementById('viewersListContainer');
    const countSpan = document.getElementById('viewersTotalCount');
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ø¤Ù‚ØªØ©
    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;"><i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙˆØ±Ø§Ù‹
    modal.classList.add('active'); 

    // 3. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ØµØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
    const group = storyGroups[currentGroupIndex];
    const storyId = group.stories[currentStoryIndex].id;

    db.collection('stories').doc(storyId).get().then(doc => {
        if (!doc.exists) return;
        
        const data = doc.data();
        const viewersList = data.viewers || [];
        const reactionsMap = data.reactions || {};

        // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        countSpan.innerText = `(${viewersList.length})`;
        
        // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚ØµØ© Ù†ÙØ³Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹
        const uiCountDiv = document.getElementById('storyViewsCount');
        if(uiCountDiv) uiCountDiv.innerHTML = `<i class="fa-solid fa-eye"></i> ${viewersList.length}`;

        listContainer.innerHTML = '';

        if (viewersList.length === 0) {
            listContainer.innerHTML = `<div style="text-align:center; padding:30px; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø¨Ø¹Ø¯</div>`;
        } else {
            // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
            viewersList.forEach(async uid => {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                let user = usersCache[uid];
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒØ§Ø´ØŒ Ù†Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ (ØªØ­Ø³ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠ)
                if(!user) {
                    try {
                        const uDoc = await db.collection('users').doc(uid).get();
                        if(uDoc.exists) user = uDoc.data();
                    } catch(e) {}
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const avatar = user ? (user.profilePic || user.avatarUrl || defaultAvatar) : defaultAvatar;
                const name = user ? (user.name || "Ù…Ø³ØªØ®Ø¯Ù…") : "Ù…Ø³ØªØ®Ø¯Ù…";
                const reaction = reactionsMap[uid] ? reactionsMap[uid] : ''; // Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ

                const item = document.createElement('div');
                item.className = 'viewer-item';
                item.innerHTML = `
                    <div class="viewer-info">
                        <div class="viewer-avatar" style="background-image: url('${avatar}')"></div>
                        <div class="viewer-name">${name}</div>
                    </div>
                    <div class="viewer-reaction">${reaction}</div>
                `;
                listContainer.appendChild(item);
            });
        }
    });
}


function closeStoryViewers() {
    document.getElementById('storyViewersModal').classList.remove('active');
    // Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù‚ØµØ©
    resumeFromInput();
}

        function pauseForInput() { 
            isStoryPaused = true; 
            clearTimeout(storyTimer); 
            const v = document.querySelector('video'); 
            if(v) v.pause(); 
        }

        function resumeFromInput() { 
            isStoryPaused = false; 
            const v = document.querySelector('video'); 
            if(v) v.play(); 
        }

        // ======================= Core App Logic (Friends & Chats) =======================

        function loadFriendsList(uid) {
            db.collection("users").doc(uid).collection("friends").onSnapshot(async snap => {
                friendUids = new Set(snap.docs.map(doc => doc.id));
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ù„ÙƒØ§Ø´
                await Promise.all(Array.from(friendUids).map(fetchAndCacheUser));
                renderStories();
                if(allChats.length > 0) renderList(); 
            });
        }

        // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© loadChats Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© loadChats Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡
function loadChats(userId) {
    db.collection("chats")
      .where("users", "array-contains", userId)
      .onSnapshot(async snap => {
        let tempChats = [];
        let uniqueChatsMap = new Map();

        for (const doc of snap.docs) {
            const d = doc.data();
            
            
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø´ÙØ±Ø© Ù„Ùˆ Ù…Ø´ Ø¨ØªØ§Ø¹ØªÙŠ
            if (d.lastMessage === '__HIDDEN_START__' && d.lastSender !== userId) { continue; }

            const isSoftDeleted = d.deletedBy && d.deletedBy.includes(userId);
            const lastSenderId = d.lastSender ? d.lastSender.toString() : "";
            const currentUserIdStr = userId.toString();
            const amISender = lastSenderId === currentUserIdStr;

            // ğŸ”¥ ØªØµØ­ÙŠØ­ 1: Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø¨Ø´ÙƒÙ„ Ø£Ù‚ÙˆÙ‰ (Ø­ØªÙ‰ Ù„Ùˆ Ù…ÙƒØªÙˆØ¨Ø© group Ø³Ù…ÙˆÙ„)
            let isGroup = (d.type === 'GROUP' || d.type === 'group'); 
            
            let chatName = "Ù…Ø³ØªØ®Ø¯Ù…", chatAvatar = defaultAvatar, isVerified = false, otherUid = null;
            
            if (isGroup) { 
                chatName = d.name || "Ù…Ø¬Ù…ÙˆØ¹Ø©"; 
                // Ø§Ù„Ø¬Ø±ÙˆØ¨ Ù…Ù„ÙˆØ´ ØµÙˆØ±Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙÙ†Ø³ÙŠØ¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø£Ùˆ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø±ÙˆØ¨ Ù„Ùˆ ÙÙŠÙ‡
                if(d.groupImage) chatAvatar = d.groupImage;
            } else {
                otherUid = d.users.find(u => u !== userId);
                if(otherUid) {
                    const u = usersCache[otherUid] || await fetchAndCacheUser(otherUid);
                    chatName = u.name; chatAvatar = u.avatar; isVerified = u.isVerified;
                    
                    if (d.blockedBy && d.blockedBy.length > 0) {
                        chatAvatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                        isVerified = false;
                    }
                }
            }

            // ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù†Øµ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø¯Ø§Ù„Ø© includes Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡
            let rawMsg = d.lastMessage ? String(d.lastMessage) : '';
            let previewMsg = rawMsg || 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
            let isMedia = false;
            let isTyping = (d.typing && Array.isArray(d.typing) && d.typing.includes(otherUid));

            if (rawMsg === '__HIDDEN_START__') {
                previewMsg = '<span style="color:var(--accent-color); font-style:italic;">Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© âœ¨</span>';
            } else if (d.lockPass && d.lockPass.length === 6) { 
                previewMsg = '<span style="color:#ff3b30; font-style:italic;"><i class="fa-solid fa-lock"></i> Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù…ÙŠØ©</span>';
            } else if (rawMsg && (rawMsg.includes('http') || d.type === 'image')) {
                previewMsg = '<i class="fa-solid fa-camera"></i> ØµÙˆØ±Ø© / ÙˆØ³Ø§Ø¦Ø·'; 
                isMedia = true;
            }

            const isBlockedByMe = d.blockedBy && d.blockedBy.includes(userId);
            const isBlockedByHim = d.blockedBy && d.blockedBy.includes(otherUid);
            const isChatBlocked = isBlockedByMe || isBlockedByHim;
            const isRestricted = d.restrictedBy && d.restrictedBy.includes(userId);

            // ğŸ”¥ ØªØµØ­ÙŠØ­ 2: Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø¥Ù†Ù‡ Ù…ÙŠÙƒÙˆÙ†Ø´ Request Ø£Ø¨Ø¯Ø§Ù‹
            // Ù„Ùˆ Ù‡Ùˆ Ø¬Ø±ÙˆØ¨ØŒ ÙŠØ¨Ù‚Ù‰ isRequest = false ÙÙˆØ±Ø§Ù‹
            const isRequest = isGroup ? false : (!isGroup && d.lastSender !== userId && !friendUids.has(otherUid));

            const chatObj = {
                id: doc.id, 
                name: chatName, 
                avatar: chatAvatar, 
                isGroup,
                lastMsg: previewMsg, 
                isMedia, 
                isTyping,
                time: d.lastMessageTime ? moment(d.lastMessageTime.toDate()).fromNow(true) : '',
                timestamp: d.lastMessageTime ? d.lastMessageTime.toMillis() : 0,
                otherUid, 
                isOnline: isGroup ? true : (usersCache[otherUid]?.isOnline || false),
                amISender: amISender, 
                unreadCount: d.unreadCount || 0, 
                isSeen: d.seen === true,        
                isArchived: d.archivedBy && d.archivedBy.includes(userId),
                isBlocked: isChatBlocked,
                isVerified,
                isPinned: d.pinnedBy && d.pinnedBy.includes(userId),
                isMuted: d.mutedBy && d.mutedBy.includes(userId),
                
                isRequest: isRequest, // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØµØ­Ø­Ø©
                
                isSecret: d.secretBy && d.secretBy.includes(userId),
                isRestricted: isRestricted,
                isSoftDeleted: isSoftDeleted,
                isLocked: d.lockPass && d.lockPass.length === 6
            };

            // ğŸ”¥ ØªØµØ­ÙŠØ­ 3: Ù…Ù†Ø·Ù‚ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± (Ø§Ù„Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¬Ø±ÙˆØ¨Ø§Øª)
            if (isGroup) {
                // Ø§Ù„Ø¬Ø±ÙˆØ¨Ø§Øª ØªØ¶Ø§Ù ÙÙˆØ±Ø§Ù‹ ÙˆØ¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø´ (Ù„Ø§ ØªØ¯Ø®Ù„ ÙÙŠ Ø§Ù„Ù€ uniqueChatsMap)
                tempChats.push(chatObj); 
            } else {
                // Ø§Ù„Ø´Ø§ØªØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø¨Ø³ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø¨Ù†Ø¹Ù…Ù„Ù‡Ø§ ÙÙ„ØªØ±Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
                if (uniqueChatsMap.has(otherUid)) {
                    const existing = uniqueChatsMap.get(otherUid);
                    if (chatObj.timestamp > existing.timestamp) {
                        uniqueChatsMap.set(otherUid, chatObj);
                    }
                } else {
                    uniqueChatsMap.set(otherUid, chatObj);
                }
            }
        }
        
        // Ø¯Ù…Ø¬ Ø§Ù„Ø´Ø§ØªØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù…Ø¹ Ø§Ù„Ø¬Ø±ÙˆØ¨Ø§Øª
        uniqueChatsMap.forEach(value => tempChats.push(value));
        
        // Ø§Ù„ØªØ±ØªÙŠØ¨
        tempChats.sort((a, b) => {
            if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
            return b.timestamp - a.timestamp;
        });
        
        allChats = tempChats;
        sessionStorage.setItem('cached_allChats', JSON.stringify(allChats));
        renderList();
    });
}

        async function fetchAndCacheUser(uid) {
    // Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ø´ ÙˆØ­Ø¯ÙŠØ«Ø© (Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©) Ù†Ø±Ø¬Ø¹Ù‡Ø§
    // Ù„ÙƒÙ† Ù„Ù„Ø£Ù…Ø§Ù† Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ ÙƒÙ„ Ù…Ø±Ø© Ø£Ùˆ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Listener
    
    // ... (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ if usersCache Ù‡Ø°Ø§ Ø³Ù†ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡ÙˆØŒ Ù„ÙƒÙ† Ø³Ù†Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø£Ø³ÙÙ„)

    try {
        const doc = await db.collection("users").doc(uid).get();
        if (doc.exists) {
            const d = doc.data();
            
            
            // === [ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹] ===
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª (5 Ø¯Ù‚Ø§Ø¦Ù‚ = 300000 Ù…ÙŠÙ„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
            let isOnlineCalculated = false;
            
            if (d.online === true && d.showActivity !== false) {
                if (d.lastSeen) {
                    const lastSeenTime = d.lastSeen.toMillis();
                    const currentTime = Date.now();
                    const diff = currentTime - lastSeenTime;
                    
                    // Ù„Ùˆ Ø§Ù„ÙØ±Ù‚ Ø£Ù‚Ù„ Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚ ÙŠØ¹ØªØ¨Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
                    if (diff < 300000) { 
                        isOnlineCalculated = true;
                    }
                } else {
                    // Ù„Ùˆ Ù…Ø¹Ù†Ø¯ÙˆØ´ ÙˆÙ‚Øª Ø¨Ø³ Ø¹Ù†Ø¯Ù‡ online=true (Ø­Ø§Ù„Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©)
                    isOnlineCalculated = true; 
                }
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±Ø· "Ù‡Ù„ Ø£Ù†Ø§ Ù…ÙØ¹Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·ØŸ" Ø¹Ø´Ø§Ù† Ø£Ø´ÙˆÙ Ø§Ù„Ù†Ø§Ø³
            const realOnline = isOnlineCalculated && myActivityVisible;

            usersCache[uid] = { 
                uid, 
                name: d.name || "Ù…Ø³ØªØ®Ø¯Ù…", 
                avatar: d.profilePic || d.avatarUrl || defaultAvatar, 
                isVerified: d.isVerified === true, 
                isOnline: realOnline // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            };
            // Ø¯Ù‡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ø³ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
sessionStorage.setItem('cached_users_data', JSON.stringify(usersCache));

            return usersCache[uid];
            
        }
    } catch (e) {}
    return { uid, name: 'Ù…Ø¬Ù‡ÙˆÙ„', avatar: defaultAvatar, isOnline: false };
}

function renderList() {
    const list = document.getElementById("list");
    list.innerHTML = "";
    const titleText = document.getElementById("listTitleText");

    // 1. ØªØµÙÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ (inbox, archive, requests)
    let filteredChats = [];
    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
if (currentView === 'inbox') {
    titleText.innerText = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª";
    // Ø§Ù„ÙÙ„ØªØ± Ø¯Ù‡ Ù‡ÙŠØ¶Ù…Ù† Ø¥Ù† Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ù…ÙŠØ¸Ù‡Ø±Ø´ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
filteredChats = allChats.filter(c => !c.isArchived && !c.isRequest && !c.isSecret && !c.isSoftDeleted);

        document.getElementById('storiesContainer').style.display = 'block';
    } else {

    
        document.getElementById('storiesContainer').style.display = 'none';

        if (currentView === 'archive') {
            titleText.innerText = "Ø§Ù„Ø£Ø±Ø´ÙŠÙ";
            
             filteredChats = allChats.filter(c => c.isArchived && !c.isBlocked && !c.isSoftDeleted);
        } else if (currentView === 'requests') {
            titleText.innerText = "Ø§Ù„Ø·Ù„Ø¨Ø§Øª";
            filteredChats = allChats.filter(c => c.isRequest && !c.isBlocked && !c.isArchived && !c.isSoftDeleted);
        }
    }


    // 2. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    if (filteredChats.length === 0) {
        list.innerHTML = `<div class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù‡Ù†Ø§</div>`;
        return;
    }

    // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    filteredChats.forEach(c => {
        const wrapper = document.createElement('div');
        wrapper.className = 'chat-wrapper';


        const el = document.createElement('div');
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        let displayName = c.name;
        if (c.isGroup) displayName = `<span style="background:var(--accent-color); padding:1px 5px; border-radius:4px; font-size:9px; margin-left:4px;">GR</span> ${c.name}`;
        if (c.isVerified) displayName += ` <i class="fa-solid fa-circle-check verify-badge"></i>`;
        
if (c.isLocked) displayName += ` <i class="fa-solid fa-lock" style="color:#aaa; font-size:10px; margin-right:5px;"></i>`;

        let statusIconsHTML = '';
        if (c.isPinned) statusIconsHTML += `<i class="fa-solid fa-thumbtack" style="color:var(--accent-color); font-size:10px; margin-left:4px;"></i>`;
        if (c.isMuted) statusIconsHTML += `<i class="fa-solid fa-bell-slash" style="color:#777; font-size:10px; margin-left:4px;"></i>`;

        // Ø­Ø¯Ø¯Ù†Ø§ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ)
const seenIcon = (!c.isBlocked && c.amISender && c.isSeen) 
    ? `<div class="seen-avatar-icon" style="background-image: url('${c.avatar}')"></div>` 
    : '';

// Ø­Ø·ÙŠÙ†Ø§ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
let bottomContent = c.isTyping 
    ? `<div class="typing-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø©...</div>` 
    : `<div class="last-message-wrapper" style="display:flex; align-items:center;">
          ${seenIcon}
          <div class="last" style="margin-right:5px;">${c.lastMsg}</div>
       </div>`;
        
        // Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© ÙˆØ£Ù†Ø§ Ù„Ø³Øª Ø§Ù„Ù…Ø±Ø³Ù„
        let unreadHTML = '';

        if (!c.amISender && !c.isBlocked) {
            if (c.unreadCount > 0) {
                // Ø­Ø§Ù„Ø© 1: ÙÙŠÙ‡ Ø±Ø³Ø§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø© ÙØ¹Ù„Ø§Ù‹ -> Ø§Ø¸Ù‡Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£Ø­Ù…Ø±
                unreadHTML = `<div class="unread-badge">${c.unreadCount}</div>`;
            } else if (!c.isSeen) {
                // Ø­Ø§Ù„Ø© 2: Ù…ÙÙŠØ´ Ø±Ø³Ø§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø³ Ø£Ù†Ø§ Ø¹Ù…Ù„ØªÙ‡Ø§ "ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©" ÙŠØ¯ÙˆÙŠÙ‹Ø§ -> Ø§Ø¸Ù‡Ø± Ù†Ù‚Ø·Ø© Ø²Ø±Ù‚Ø§Ø¡
                // Ø§Ù„ÙƒÙ„Ø§Ø³ read-blue-dot Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…Ù„Ù CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
                unreadHTML = `<div class="read-blue-dot"></div>`;
            }
        }
//
        el.className = 'chat';
        if (c.isPinned) el.classList.add('pinned-chat');

        // Ø¨Ù†Ø§Ø¡ HTML Ø§Ù„Ø¹Ù†ØµØ±
        el.innerHTML = `
            <div class="avatar-container" id="avatar-${c.id}">
                <div class="avatar" style="background-image:url('${c.avatar}')"></div>
                <div class="active-dot" style="background:${c.isOnline && window.isOnlineFeatureEnabled ? '#4ade80' : '#777'}"></div>
            </div>
            <div class="info">
                <div class="top-row"><div class="name">${displayName}</div><div class="time">${statusIconsHTML} ${c.time}</div></div>
                <div class="bottom-row">${bottomContent}${unreadHTML}</div>
            </div>`;

        // =======================================================
        // Ø£) Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© (ÙŠÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·)
        // =======================================================
        const avatarDiv = el.querySelector(`#avatar-${c.id}`);
        avatarDiv.onclick = (e) => {
            e.stopPropagation(); // ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø´Ø§Øª
            vibrate();
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
            if(typeof openProfilePreview === 'function'){
                openProfilePreview(e, c);
            }
        };

        // =======================================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ÙˆØ­Ø¯ (Ù…Ø¯Ù…Ø¬ ÙÙŠÙ‡ Ø§Ù„Ù‚ÙÙ„ + Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª + Ø§Ù„ÙØªØ­)
        // =======================================================
        
        // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³Ø­Ø¨
        let startX = 0;
        let currentX = 0;
        let isDragging = false; 

        el.onclick = async (e) => {
            // 1. Ø­Ù…Ø§ÙŠØ©: Ù„Ùˆ Ø¯Ø§Ø³ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù…ÙŠØ¹Ù…Ù„Ø´ Ø­Ø§Ø¬Ø© (Ø¹Ø´Ø§Ù† ÙŠÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„)
            if (e.target.closest('.avatar-container')) return;
            
            // 2. Ø­Ù…Ø§ÙŠØ©: Ù„Ùˆ Ø¨ÙŠØ³Ø­Ø¨ Ø§Ù„Ø´Ø§Øª (Swipe) Ù…Ø§ÙŠÙØªØ­Ø´
            if (typeof isDragging !== 'undefined' && isDragging) return; 

            vibrate();
            

            // ==========================================
            // ğŸ”’ 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‡Ù…)
            // ==========================================
            if (c.isLocked) {
                console.log("Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù‚ÙÙ„Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯...");
                
                // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹
                pendingChatId = c.id;
                pendingChatName = encodeURIComponent(c.name);
                pendingChatUid = c.isGroup ? 'GROUP' : c.otherUid;
                pendingChatRequest = c.isRequest;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
                const lockModal = document.getElementById('chatLockModal');
                if(lockModal) {
                    lockModal.style.display = 'flex';
                    // ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ø¤Ø´Ø± ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
                    setTimeout(() => {
                        const passInput = document.getElementById('chatPassInput');
                        if(passInput) {
                            passInput.value = '';
                            passInput.focus();
                        }
                    }, 100);
                }
                
                return; // â›” ÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆÙ…Ø§ØªÙØªØ­Ø´ Ø§Ù„Ø´Ø§Øª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
            }
            // ==========================================
            
            
            if (!c.isRequest && !c.amISender && c.unreadCount > 0) {
                // Ù„Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ "Ù…Ø´ Ù…Ù‚ÙŠØ¯"ØŒ Ø§Ø¨Ø¹Øª Ø§Ù„Ø³ÙŠÙ† Ø¹Ø§Ø¯ÙŠ
                if (!c.isRestricted) {
                    const badge = el.querySelector('.unread-badge');
                    if(badge) badge.style.display = 'none';
                    try {
                        await resetUnreadCount(c.id);
                    } catch(err) { console.log(err); }
                } 
            }

            // 5. Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
            sessionStorage.setItem('scrollPos', window.scrollY);

            // 6. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„)
            if (c.isGroup) {
                // âœ… Ù„Ùˆ Ø¬Ø±ÙˆØ¨ -> ÙŠØ±ÙˆØ­ Ù…Ù„Ù Ø§Ù„Ø¬Ø±ÙˆØ¨Ø§Øª
                window.location.href = `group_chat.html?groupId=${c.id}&name=${encodeURIComponent(c.name)}`;
            } else {
                // âœ… Ù„Ùˆ Ø´Ø§Øª ÙØ±Ø¯ÙŠ -> ÙŠØ±ÙˆØ­ Ù…Ù„Ù Ø§Ù„Ø´Ø§Øª
                window.location.href = `chat.html?chatId=${c.id}&name=${encodeURIComponent(c.name)}&uid=${c.otherUid}`;
            }
        };

        // Ø²Ø± Ø§Ù„ÙØ£Ø±Ø© Ø§Ù„Ø£ÙŠÙ…Ù† Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª (Context Menu) - ÙƒÙ…Ø§ Ù‡Ùˆ
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            vibrate();
            openOptions(c);
        });

        // =======================================================
        // 2. ÙƒÙˆØ¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø³ÙŠØ¨Ù‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ)
        // =======================================================
        el.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            vibrate();
            openOptions(c);
        });

        // =======================================================
        // (ØªÙ… Ø­Ø°Ù Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø³Ø­Ø¨ touchstart, touchmove, touchend Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹)
        // =======================================================

        // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ØµÙØ­Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ø§Ù„Ø´Ø§Øª ÙŠØ¸Ù‡Ø±)
        wrapper.appendChild(el);
        list.appendChild(wrapper);
        renderQuickActiveUsers(); 


    }); // Ø¯ÙŠ Ù‚ÙÙ„Ø© Ø§Ù„Ù€ forEach (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹)
} // Ø¯ÙŠ Ù‚ÙÙ„Ø© Ø¯Ø§Ù„Ø© renderList (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹)

    // 2. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    
        // --- Standard & Modal Actions ---
      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ±Ø¬Ø¹ Promise Ù„Ù†Ù†ØªØ¸Ø±Ù‡Ø§ Ù‚Ø¨Ù„ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
function resetUnreadCount(chatId) { 
    return db.collection('chats').doc(chatId).update({ unreadCount: 0, seen: true }); 
}


    function openChat(cid, name, uid, req) { location.href = (req ? 'request_view.html' : 'chat.html') + `?chatId=${cid}&name=${name}&uid=${uid}`; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebarOverlay').classList.toggle('active'); }
        
        
        function showSection(section) { currentView = section; toggleSidebar(); renderList(); }
        
        
        
        // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†Ø®Ø²Ù† ÙÙŠÙ‡ Ø§Ø­Ù†Ø§ Ø¨Ù†Ø­Ø¸Ø± Ù…ÙŠÙ†
let userToBlockId = null;

function openOptions(chat) {
    selectedChatId = chat.id; 
    selectedChatData = chat;
    
    // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    document.getElementById('sheetName').innerText = chat.name;
    document.getElementById('sheetAvatar').style.backgroundImage = `url('${chat.avatar}')`;
    
    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('pinText').innerText = chat.isPinned ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª" : "ØªØ«Ø¨ÙŠØª";
    document.getElementById('archiveText').innerText = chat.isArchived ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ©" : "Ø£Ø±Ø´ÙØ©";
    document.getElementById('muteText').innerText = chat.isMuted ? "ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª" : "ÙƒØªÙ…";
    document.getElementById('markReadText').innerText = chat.isSeen ? "ØªØ­Ø¯ÙŠØ¯ ÙƒØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡" : "Ù‚Ø±Ø§Ø¡Ø©";

    // 3. Ø²Ø± Ø§Ù„Ù‚ÙÙ„
    const lockBtn = document.getElementById('lockOptionBtn');
    const lockText = document.getElementById('lockOptionText');
    const lockIcon = document.getElementById('lockOptionIcon');

    if (chat.isLocked) {
        lockText.innerText = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ (ÙØªØ­)";
        lockIcon.className = "fa-solid fa-lock-open"; 
        lockBtn.onclick = function() { vibrate(); openUnlockModal(); }; 
    } else {
        lockText.innerText = "Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©";
        lockIcon.className = "fa-solid fa-lock";
        lockBtn.onclick = function() { vibrate(); openSetChatPassModal(); };
    }

    // ==========================================
    // ğŸ”¥ Ø²Ø± Ø§Ù„Ø­Ø¸Ø± Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ğŸ”¥
    // ==========================================
    const blockContainer = document.getElementById('dynamicBlockBtnContainer');
    
    if (blockContainer) {
        blockContainer.innerHTML = ''; 

        const blockBtn = document.createElement('div');
        blockBtn.className = 'sheet-action danger';
        
        if (chat.isBlocked) {
            blockBtn.innerHTML = `<i class="fa-solid fa-user-gear"></i> <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¸Ø± (Ù…Ø­Ø¸ÙˆØ±)</span>`;
            blockBtn.onclick = function() { vibrate(); window.location.href = 'blocked.html'; };
        } else {
            blockBtn.innerHTML = `<i class="fa-solid fa-ban"></i> <span>Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>`;
            
            // Ù„Ù…Ø§ ÙŠØ¯ÙˆØ³ Ù‡Ù†Ø§ØŒ ÙŠÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
            blockBtn.onclick = function() { 
                vibrate();
                closeOptions(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                userToBlockId = chat.id; // Ø§Ø­ÙØ¸ Ø§Ø­Ù†Ø§ Ø¨Ù†Ø­Ø¸Ø± Ù…ÙŠÙ†
                document.getElementById('blockConfirmationModal').style.display = 'flex'; // Ø§ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            };
        }
        
        blockContainer.appendChild(blockBtn);
    }

    document.getElementById('optionsModal').classList.add('active');
        // ==========================================
    // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø²Ø±Ø§Ø± (Ø§Ù„Ø­Ù„ Ù‡Ù†Ø§) ğŸ”¥
    // ==========================================
    
    // 1. Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ù…Ø³Ø­Ù‡ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    const oldRestrictBtn = document.getElementById('restrictOptionBtn');
    if (oldRestrictBtn) oldRestrictBtn.remove();

    // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        // ... (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ) ...

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const restrictBtn = document.createElement('div');
    restrictBtn.id = 'restrictOptionBtn';
    restrictBtn.className = 'sheet-action';

    // === ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù‡Ù†Ø§ ===
    if (chat.isRestricted) {
        // Ø­Ø§Ù„Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù‚ÙŠØ¯ -> Ø²Ø±Ø§Ø± Ø£Ø²Ø±Ù‚ Ù„ÙÙƒ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯
        restrictBtn.innerHTML = `<i class="fa-solid fa-user-check" style="color:var(--verify-color)"></i> <span style="color:var(--verify-color)">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯</span>`;
        
        restrictBtn.onclick = function() {
            vibrate();
            closeOptions(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯" Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            window.targetRestrictId = chat.id;
            document.getElementById('unrestrictConfirmationModal').style.display = 'flex';
        };
        
    } else {
        // Ø­Ø§Ù„Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ -> Ø²Ø±Ø§Ø± Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªÙ‚ÙŠÙŠØ¯
        restrictBtn.innerHTML = `<i class="fa-solid fa-user-lock" style="color:#f59e0b"></i> <span style="color:#f59e0b">ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>`;
        
        restrictBtn.onclick = function() {
            vibrate();
            closeOptions(); // Ø§Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© "Ø§Ù„ØªÙ‚ÙŠÙŠØ¯" Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            window.targetRestrictId = chat.id;
            document.getElementById('restrictConfirmationModal').style.display = 'flex';
        };
    }

    // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø±Ø§Ø± Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ) ...

    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    const modalBody = document.querySelector('#optionsModal .bottom-sheet');
    // Ø¨Ù†Ø­Ø·Ù‡ Ù‚Ø¨Ù„ Ø¢Ø®Ø± Ø¹Ù†ØµØ±ÙŠÙ† (Ù‚Ø¨Ù„ Ø²Ø± Ø§Ù„Ø­Ø¸Ø±)
    if(modalBody.children.length > 2) {
        modalBody.insertBefore(restrictBtn, modalBody.children[modalBody.children.length - 2]); 
    } else {
        modalBody.appendChild(restrictBtn);
    }

}

// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± (Ø¨ØªØ´ØªØºÙ„ Ù„Ù…Ø§ ØªØ¯ÙˆØ³ "Ù†Ø¹Ù…" ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± (Ù…Ø¹ Ù‚ÙŠØ¯ 48 Ø³Ø§Ø¹Ø©)
async function executeBlockAction() {
    if (!userToBlockId) return;

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆÙ…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
    document.getElementById('blockConfirmationModal').style.display = 'none';
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©... â³");

    try {
        const chatRef = db.collection('chats').doc(userToBlockId);
        
        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ø¢Ø®Ø± Ù…Ø±Ø© Ø­Ø¸Ø± ÙÙŠÙ‡Ø§ Ø¥Ù…ØªÙ‰
        const doc = await chatRef.get();
        if (!doc.exists) return;
        
        const data = doc.data();
        const myId = currentUser.uid;
        
        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (48 Ø³Ø§Ø¹Ø©)
        if (data.blockCooldown && data.blockCooldown[myId]) {
            const lastActionTime = data.blockCooldown[myId].toMillis();
            const currentTime = Date.now();
            const diffInHours = (currentTime - lastActionTime) / (1000 * 60 * 60); // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ±Ù‚ Ù„Ø³Ø§Ø¹Ø§Øª

            if (diffInHours < 48) {
                const remaining = Math.ceil(48 - diffInHours);
                showToast(`ğŸš« Ø¹Ø°Ø±Ø§Ù‹! ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${remaining} Ø³Ø§Ø¹Ø© Ù‚Ø¨Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø±.`);
                
                // ØªØ´ØºÙŠÙ„ Ù‡Ø²Ø§Ø² Ù„Ù„Ø±ÙØ¶
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                return; // â›” ÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆÙ…Ø§ØªÙƒÙ…Ù„Ø´
            }
        }

        // 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø¸Ø± ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
        // Ø¨Ù†Ø³ØªØ®Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø°ÙƒÙŠ Ø¹Ø´Ø§Ù† Ù†Ø®Ø²Ù† ÙˆÙ‚Øª Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙƒ Ø§Ù†Øª Ø¨Ø³
        const updateData = {
            blockedBy: firebase.firestore.FieldValue.arrayUnion(myId)
        };
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ¨Ø¯Ø§ÙŠØ© Ù„Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø§Ù„Ù€ 48 Ø³Ø§Ø¹Ø©
        updateData[`blockCooldown.${myId}`] = firebase.firestore.FieldValue.serverTimestamp();

        await chatRef.update(updateData);
        
        showToast("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù‚ÙŠØ¯ Ù„Ù…Ø¯Ø© 48 Ø³Ø§Ø¹Ø©) ğŸ”’ğŸš«");
        
        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderList(); 
        
    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„");
    }
}


        function closeOptions() { document.getElementById('optionsModal').classList.remove('active'); }

        function createGroupAction() {
    closeOptions(); // Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„
    
    const modal = document.getElementById('createGroupModal');
    const input = document.getElementById('newGroupNameInput');
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚Ù„
    input.value = '';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    modal.style.display = 'flex';
    
    // ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ø¤Ø´Ø± Ø¹Ø´Ø§Ù† ØªÙƒØªØ¨ Ø¹Ù„Ø·ÙˆÙ„
    setTimeout(() => input.focus(), 100);
}


        function togglePinAction() {
            const ref = db.collection('chats').doc(selectedChatId);
            const op = selectedChatData.isPinned ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid);
            ref.update({ pinnedBy: op }); closeOptions();
        }

        function archiveChatAction() {
            const ref = db.collection('chats').doc(selectedChatId);
            const op = selectedChatData.isArchived ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid);
            ref.update({ archivedBy: op }); showToast(selectedChatData.isArchived ? "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ©" : "ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ©"); closeOptions();
        }

        // 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ Ø¨ØªØ´ØªØºÙ„ Ù„Ù…Ø§ ØªØ¯ÙˆØ³ "Ø­Ø°Ù" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨ØªÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø³)
function deleteChatAction() {
    closeOptions(); // Ù†Ù‚ÙÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§
    document.getElementById('deleteConfirmationModal').style.display = 'flex';
    
    // ØªØµÙÙŠØ± Ø§Ù„Ù€ Checkbox ÙƒÙ„ Ù…Ø±Ø© ØªÙØªØ­ ÙÙŠÙ‡Ø§ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('deleteForEveryoneCheck').checked = false;
}

// 2. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeDeleteModal() {
    document.getElementById('deleteConfirmationModal').style.display = 'none';
}

// 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªÙ†ÙØ° Ø§Ù„Ø­Ø°Ù ÙØ¹Ù„ÙŠØ§Ù‹
async function confirmDeleteChat() {
    const isDeleteForEveryone = document.getElementById('deleteForEveryoneCheck').checked;
    
    closeDeleteModal(); 
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...");

    try {
        const chatRef = db.collection('chats').doc(selectedChatId);

        if (isDeleteForEveryone) {
            // ==========================================
            // ğŸ”¥ Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹ ğŸ”¥
            // Ù„Ø§Ø²Ù… Ù†Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ Ù‚Ø¨Ù„ Ù…Ø§ Ù†Ø­Ø°Ù ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª
            // ==========================================
            
            // 1. Ù‡Ø§Øª ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ Ø¬ÙˆÙ‡ Ø§Ù„Ø´Ø§Øª
            const messagesSnapshot = await chatRef.collection('messages').get();
            
            // 2. Ø§Ø¹Ù…Ù„ Batch Ø¹Ø´Ø§Ù† ØªØ­Ø°ÙÙ‡Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ø£Ø³Ø±Ø¹ ÙˆØ£ÙˆÙØ±)
            const batch = db.batch();
            messagesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            // 3. Ù†ÙØ° Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§ÙŠÙ„
            await batch.commit();

            // 4. Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø§Ø­Ø°Ù Ø§Ù„Ø´Ø§Øª Ù†ÙØ³Ù‡ Ø¨Ø£Ù…Ø§Ù†
            await chatRef.delete();
            
            showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆÙ…Ø­ØªÙˆØ§Ù‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ğŸ—‘ï¸");

        } else {
            // ==========================================
            // ğŸ”¹ Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø¹Ù†Ø¯ÙŠ ğŸ”¹
            // Ø¨Ù†Ø³Ø¬Ù„ "ÙˆÙ‚Øª Ø§Ù„Ø­Ø°Ù" Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†Ø¹Ø±Ø¶Ø´ Ø§Ù„Ø±Ø³Ø§ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªØ§Ù†ÙŠ
            // ==========================================
            
            // Ø¨Ù†Ø¹Ù…Ù„ Object Ø¹Ø´Ø§Ù† Ù†Ø®Ø²Ù† ÙÙŠÙ‡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙƒ Ø£Ù†Øª Ø¨Ø³
            const updateData = {
                deletedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid), // Ø¹Ø´Ø§Ù† ÙŠØ®ØªÙÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                unreadCount: 0 
            };

            // Ø§Ù„Ø­ØªØ© Ø¯ÙŠ Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹: Ø¨Ù†Ø³Ø¬Ù„ Ø¥Ù†Ùƒ Ù…Ø³Ø­Øª Ø§Ù„Ø´Ø§Øª "Ø¯Ù„ÙˆÙ‚ØªÙŠ"
            // Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ Ù…Ø¹Ù†Ø§Ù‡: clearedAt.USER_ID = ServerTimestamp
            updateData[`clearedAt.${currentUser.uid}`] = firebase.firestore.FieldValue.serverTimestamp();

            await chatRef.update(updateData);

            showToast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© âœ…");
        }

        if (currentView === 'chat') showSection('inbox');
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø´Ø§Ù† Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹
        renderList(); 

    } catch (error) {
        console.error("Error deleting:", error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
    }
}

        function toggleMuteAction() {
            const ref = db.collection('chats').doc(selectedChatId);
            const op = selectedChatData.isMuted ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) : firebase.firestore.FieldValue.arrayUnion(currentUser.uid);
            ref.update({ mutedBy: op }); closeOptions();
        }

        function toggleReadAction() {
    const ref = db.collection('chats').doc(selectedChatId);
    
    // Ù„Ùˆ Ø§Ù„Ø´Ø§Øª ÙÙŠÙ‡ Ø±Ø³Ø§ÙŠÙ„ (Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø£ÙƒØ¨Ø± Ù…Ù† 0) Ø£Ùˆ Ù‡Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹ "ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡" (seen = false)
    // ÙŠØ¨Ù‚Ù‰ Ù„Ù…Ø§ Ù†Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø®Ù„ÙŠÙ‡ "Ù…Ù‚Ø±ÙˆØ¡"
    if (selectedChatData.unreadCount > 0 || !selectedChatData.isSeen) {
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù‚Ø±ÙˆØ¡
        ref.update({ 
            seen: true, 
            unreadCount: 0 
        });
        showToast("ØªÙ… Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡ âœ…");
    } else {
        // Ø§Ù„Ø¹ÙƒØ³: Ù‡Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù‚Ø±ÙˆØ¡ØŒ Ø¥Ø­Ù†Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ† Ù†Ø¹Ù„Ù…Ù‡ "ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡" Ù„Ù„ØªØ°ÙƒÙŠØ±
        ref.update({ 
            seen: false 
            // Ù…Ø´ Ø¨Ù†ØºÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŒ Ø¨Ù†Ø³ÙŠØ¨Ù‡ 0 Ø²ÙŠ Ù…Ø§ Ù‡ÙˆØŒ Ø¨Ø³ Ø¨Ù†ØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        });
        showToast("ØªÙ… Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙƒØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡ ğŸ”µ");
    }
    closeOptions();
}


         function hideLogoutModal() { document.getElementById('logoutModal').classList.remove('active'); }
        function performLogout() { sessionStorage.clear(); auth.signOut().then(() => location.href = 'index.html'); }
        
        function toggleMyActivity() {
            myActivityVisible = !myActivityVisible;
            localStorage.setItem('nabd_online_status', myActivityVisible);
            updateActivityUI();
            db.collection('users').doc(currentUser.uid).update({ showActivity: myActivityVisible });
            showToast(myActivityVisible ? "Ø£Ù†Øª Ø¸Ø§Ù‡Ø± Ø§Ù„Ø¢Ù†" : "Ø£Ù†Øª Ù…Ø®ÙÙŠ Ø§Ù„Ø¢Ù†");
            usersCache = {}; friendUids.forEach(fid => delete usersCache[fid]); loadChats(currentUser.uid);
        }

        function updateActivityUI() {
            const txt = document.getElementById('activityText');
            const dot = document.getElementById('activityDot');
            if(myActivityVisible) { txt.innerText = "Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·: Ø¸Ø§Ù‡Ø±"; dot.style.background = "#4ade80"; } 
            else { txt.innerText = "Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·: Ù…Ø®ÙÙŠ"; dot.style.background = "#555"; }
        }

        function monitorIncomingMessages(uid) {
    db.collection('chats')
      .where('users', 'array-contains', uid)
      .onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === 'modified' || change.type === 'added') {
                const data = change.doc.data();

                if (data.lastSender === uid) return;
                if (!data.unreadCount || data.unreadCount <= 0) return;
                if (data.mutedBy && data.mutedBy.includes(uid)) return;

                // ==========================================
                // ğŸ”¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ† ğŸ”¥
                // ==========================================
                if (data.restrictedBy && data.restrictedBy.includes(uid)) return; 

                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ)
                if (notificationAudio) {
                    notificationAudio.currentTime = 0; 
                    notificationAudio.play().catch(err => {});
                }
                vibrate();
            }
        });
    });
}

        function searchChats(val) {
            val = val.toLowerCase();
            document.querySelectorAll('.chat-wrapper').forEach(el => {
                const name = el.querySelector('.name').innerText.toLowerCase();
                el.style.display = name.includes(val) ? 'block' : 'none';
            });
        }

   
// 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØºØ±Ø¶ Ø§Ù„Ø¨Ø­Ø«
let currentFriendsData = [];

function startNewChat() {
    vibrate();
    const modal = document.getElementById('newChatModal');
    const listContainer = document.getElementById('newChatListContainer');
    const searchInput = document.getElementById('newChatSearchInput');

    // ØªØµÙÙŠØ± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©
    searchInput.value = '';
    listContainer.innerHTML = '';
    currentFriendsData = [];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ØµØ¯Ù‚Ø§Ø¡
    if (friendUids.size === 0) {
        listContainer.innerHTML = `
            <div style="text-align:center; padding:30px; color:#777;">
                <i class="fa-solid fa-user-plus" style="font-size:30px; margin-bottom:10px;"></i>
                <br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
                <br>
                <button onclick="showSection('friends')" style="background:var(--accent-color); border:none; color:#fff; padding:8px 15px; border-radius:8px; margin-top:10px; cursor:pointer;">Ø¥Ø¶Ø§ÙØ© Ø£ØµØ¯Ù‚Ø§Ø¡</button>
            </div>`;
    } else {
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„Ø¨Ø­Ø«
        friendUids.forEach(uid => {
            if(usersCache[uid]) {
                currentFriendsData.push(usersCache[uid]);
            }
        });

        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        renderNewChatList(currentFriendsData);
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    modal.classList.add('active');
}

// Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
function filterNewChatList(query) {
    const lowerQ = query.toLowerCase().trim();
    
    if (lowerQ === '') {
        renderNewChatList(currentFriendsData);
        return;
    }

    const filtered = currentFriendsData.filter(user => 
        user.name.toLowerCase().includes(lowerQ)
    );
    
    renderNewChatList(filtered);
}
// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
function renderNewChatList(dataList) {
    const listContainer = document.getElementById('newChatListContainer');
    listContainer.innerHTML = '';

    // Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªØ§Ø¦Ø¬
    if (dataList.length === 0) {
        listContainer.innerHTML = `<div style="text-align:center; padding:20px; color:#555;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
        return;
    }

    dataList.forEach(user => {
        const item = document.createElement('div');
        item.className = 'new-chat-item';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ«ÙŠÙ‚
        let displayName = user.name;
        if(user.isVerified) displayName += ` <i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:12px;"></i>`;

        item.innerHTML = `
            <div class="nc-avatar" style="background-image: url('${user.avatar}')"></div>
            <div class="nc-name">${displayName}</div>
            <i class="fa-solid fa-comment-dots" style="margin-right: auto; color: var(--accent-color);"></i>
        `;
        
        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø«: Ø´Ø§Øª Ø®ÙÙŠ + Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ¯Ø§Ø®Ù„)
        item.onclick = async () => {
            closeNewChatModal(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹
            
            // 1. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ø¹Ù† Ø´Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ (Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ String Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
            const existingChat = allChats.find(c => 
                !c.isGroup && String(c.otherUid) === String(user.uid)
            );
            
            if (existingChat) {
                // âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: ÙˆØ¬Ø¯Ù†Ø§ Ø´Ø§Øª Ø³Ø§Ø¨Ù‚
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ø§Øª "Ù…Ø­Ø°ÙˆÙØ§Ù‹ Ù…Ø¤Ù‚ØªØ§Ù‹"ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡
                if (existingChat.isSoftDeleted) {
                     db.collection('chats').doc(existingChat.id).update({
                         deletedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                     }).catch(err => console.error("Error restoring chat:", err));

                     existingChat.isSoftDeleted = false; 
                }

                // ÙØªØ­ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                openChat(existingChat.id, encodeURIComponent(user.name), user.uid, false);
                
            } else {
                // âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø§Øª Ø³Ø§Ø¨Ù‚ (Ù†Ù†Ø´Ø¦ Ø´Ø§Øª Ø®ÙÙŠ ÙÙˆØ±Ø§Ù‹)
                showToast("Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...");

                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² ÙÙˆØ±Ø§Ù‹
                    const newChatRef = await db.collection('chats').add({
                        users: [currentUser.uid, user.uid],
                        type: 'DIRECT',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        
                        // ğŸ”¥ Ø§Ù„Ø´ÙØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ© (Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯Ùƒ Ø¨Ø³) ğŸ”¥
                        lastMessage: "__HIDDEN_START__", 
                        lastSender: currentUser.uid, 
                        
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        seen: true,
                        unreadCount: 0,
                        
                        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
                        archivedBy: [],
                        deletedBy: [],
                        pinnedBy: [],
                        mutedBy: [],
                        secretBy: []
                    });

                    // ÙØªØ­ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ù„Ù€ ID Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                    openChat(newChatRef.id, encodeURIComponent(user.name), user.uid, false);

                } catch (error) {
                    console.error("Error creating ghost chat:", error);
                    showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
                }
            }
        };
        
        listContainer.appendChild(item);
    });
}


function closeNewChatModal() {
    document.getElementById('newChatModal').classList.remove('active');
}

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØµØºØ±Ø©
function openProfilePreview(e, chatData) {
    e.stopPropagation(); // Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ø´Ø§Øª
    vibrate();
    
    currentPreviewChatId = chatData.id;
    currentPreviewImage = chatData.avatar;
    
    document.getElementById('ppPreviewImg').src = chatData.avatar;
    document.getElementById('ppPreviewName').innerText = chatData.name;
    
    const modal = document.getElementById('profilePreviewModal');
    modal.style.display = 'flex';
}

function closeProfilePreview() {
    document.getElementById('profilePreviewModal').style.display = 'none';
}

// ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function openFullProfileImage() {
    const fullModal = document.getElementById('fullImageModal');
    const fullImg = document.getElementById('fullPPImg');
    
    fullImg.src = currentPreviewImage;
    fullModal.style.display = 'flex';
    closeProfilePreview();
}

function closeFullImage() {
    document.getElementById('fullImageModal').style.display = 'none';
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
function navigateToChatFromPP() {
    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Øª
    const chatEl = document.querySelector(`.chat-wrapper[onclick*="${currentPreviewChatId}"]`); // Ù‡Ø°Ø§ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    // Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆÙØªØ­ Ø§Ù„Ø´Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©
    closeProfilePreview();
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ openChat Ù‡Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
}

// ==== ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© renderList Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« ====
// Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¥Ù†Ø´Ø§Ø¡ div Ø§Ù„Ø£ÙØ§ØªØ§Ø± ÙÙŠ Ø¯Ø§Ù„Ø© renderList ÙˆØ§Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨Ø§Ù„ØªØ§Ù„ÙŠ:
/*
    const avatarContainer = document.createElement('div');
    avatarContainer.className = 'avatar-container';
    avatarContainer.innerHTML = `
        <div class="avatar" style="background-image:url('${c.avatar}')"></div>
        <div class="active-dot" style="background:${c.isOnline && window.isOnlineFeatureEnabled ? '#4ade80' : '#777'}"></div>
    `;
    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙØ§ØªØ§Ø±
    avatarContainer.onclick = (e) => openProfilePreview(e, c);
    
    el.appendChild(avatarContainer);
*/

// ==== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª (Client Side) ====
// Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙŠÙ† Ø´ÙˆØª 100% ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ØŒ Ù„ÙƒÙ† Ù‡Ø°Ù‡ Ø­ÙŠÙ„ Ù„ØªØµØ¹ÙŠØ¨ Ø§Ù„Ø£Ù…Ø±

// 1. Ù…Ù†Ø¹ Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù†
document.addEventListener('contextmenu', event => event.preventDefault());

// 2. Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (PrintScreen, Ctrl+S, etc)
document.addEventListener('keydown', function(e) {
    if (e.key === 'PrintScreen' || (e.ctrlKey && e.key === 's')) {
        copyToClipboard(); // Ù…Ø³Ø­ Ø§Ù„Ø­Ø§ÙØ¸Ø©
        alert("Ø§Ù„ØªØµÙˆÙŠØ± Ù…Ù…Ù†ÙˆØ¹!");
        e.preventDefault();
    }
});

// 3. ØªØ´ÙˆÙŠØ´ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù„Ù„Ø¬ÙˆØ§Ù„ Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…)
window.addEventListener('blur', () => {
    document.body.classList.add('blur-content');
});
window.addEventListener('focus', () => {
    document.body.classList.remove('blur-content');
});

function copyToClipboard() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ±ÙŠØº Ø§Ù„Ø­Ø§ÙØ¸Ø©
    navigator.clipboard.writeText('Screenshots are disabled');
}

                    function viewUserProfileFromStory() {
            const group = storyGroups[currentGroupIndex];
            const user = group.user;
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚ØµØ© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù„ÙƒÙ† Ø£ÙØ¶Ù„ Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
            const vid = document.querySelector('video');
            if(vid) vid.pause();
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (uid)
            location.href = `profile.html?uid=${user.uid}`;
        }

            
    /* --- Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Messenger Version) --- */

// 1. ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
function openAccountSwitcher() {
    vibrate();
    toggleSidebar(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    document.getElementById('accountSwitcherModal').style.display = 'flex';
    document.getElementById('addAccountForm').style.display = 'none';
    document.getElementById('addAccBtnContainer').style.display = 'flex';

    const list = document.getElementById('accountList');
    list.innerHTML = "";

    // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ù†ÙØ³ Ù…ÙØªØ§Ø­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ÙŠØ¹Ù…Ù„Ø§ Ù…Ø¹Ø§Ù‹)
    let accounts = JSON.parse(localStorage.getItem('nabd_accounts') || '[]');

    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if(currentUser) {
        const currentIdx = accounts.findIndex(a => a.uid === currentUser.uid);
        if(currentIdx > -1) {
            // Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
            const menuName = document.getElementById('myNameTxt') ? document.getElementById('myNameTxt').innerText : "Ø­Ø³Ø§Ø¨ÙŠ";
            accounts[currentIdx].name = menuName;
            localStorage.setItem('nabd_accounts', JSON.stringify(accounts));
        }
    }

    if (accounts.length === 0) {
        list.innerHTML = "<div style='text-align:center;color:#777;padding:20px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>";
    }

    accounts.forEach((acc, idx) => {
        const isCurrent = (currentUser && acc.uid === currentUser.uid);
        
        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
        const bgStyle = acc.pic ? `background-image:url('${acc.pic}')` : `background:#5D5FEF`;
        const char = acc.pic ? '' : (acc.name ? acc.name[0] : 'U');

        list.innerHTML += `
        <div class="acc-item" onclick="${isCurrent ? '' : `switchAccount(${idx})`}" style="${isCurrent ? 'opacity:0.5; cursor:default; border:1px solid var(--accent-color);' : ''}">
            <div style="width:40px; height:40px; border-radius:50%; ${bgStyle}; background-size:cover; background-position:center; display:grid; place-items:center; font-weight:bold; border:1px solid #333; flex-shrink:0;">
                ${char}
            </div>
            
            <div style="flex:1; text-align:right;">
                <div style="font-weight:bold; font-size:14px; color:#fff;">
                    ${acc.name} ${acc.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:12px;"></i>' : ''}
                </div>
                <div style="font-size:11px; color:#aaa;">${acc.email}</div>
            </div>

            ${!isCurrent ? `<i class="fa-solid fa-trash-can" style="color:#ef4444; padding:10px; font-size:14px;" onclick="removeAccount(event, ${idx})"></i>` : '<span style="font-size:10px; color:#38bdf8">Ù†Ø´Ø·</span>'}
        </div>`;
    });
}

// 2. Ø¥Ø¸Ù‡Ø§Ø± ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ©
function showAddAccountForm() {
    vibrate();
    document.getElementById('addAccountForm').style.display = 'block';
    document.getElementById('addAccBtnContainer').style.display = 'none';
}

function hideAddAccountForm() {
    document.getElementById('addAccountForm').style.display = 'none';
    document.getElementById('addAccBtnContainer').style.display = 'flex';
}

// 3. Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
async function addNewAccountAction() {
    vibrate();
    const e = document.getElementById('newAccEmail').value;
    const p = document.getElementById('newAccPass').value;
    
    if(!e || !p) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©");
    
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");

    try { 
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const cred = await auth.signInWithEmailAndPassword(e, p); 
        const uid = cred.user.uid;

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸
        const userDoc = await db.collection('users').doc(uid).get();
        const userData = userDoc.data() || {};
        const realName = userData.name || e.split('@')[0];
        const isVerified = userData.isVerified || false;
        const pic = userData.profilePic || userData.avatarUrl || "";

        // Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ LocalStorage
        let accs = JSON.parse(localStorage.getItem('nabd_accounts') || '[]'); 
        
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if(!accs.find(a => a.uid === uid)) {
            accs.push({
                uid: uid, 
                email: e, 
                token: btoa(p), // ØªØ´ÙÙŠØ± Ø¨Ø³ÙŠØ·
                name: realName, 
                isVerified: isVerified, 
                pic: pic
            }); 
            localStorage.setItem('nabd_accounts', JSON.stringify(accs)); 
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        location.reload(); 

    } catch(er) { 
        console.error(er); 
        showToast("Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); 
    }
}

// 4. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
function switchAccount(idx) { 
    vibrate();
    let accs = JSON.parse(localStorage.getItem('nabd_accounts')); 
    if(accs[idx]) {
        showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„...");
        auth.signInWithEmailAndPassword(accs[idx].email, atob(accs[idx].token))
            .then(() => location.reload())
            .catch(() => showToast("ÙØ´Ù„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚Ø¯ ØªÙƒÙˆÙ† ØªØºÙŠØ±Øª"));
    }
}

// 5. Ø­Ø°Ù Ø­Ø³Ø§Ø¨
function removeAccount(e, idx) { 
    e.stopPropagation();
    if(!confirm("Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ")) return;
    
    let accs = JSON.parse(localStorage.getItem('nabd_accounts')); 
    accs.splice(idx, 1);
    localStorage.setItem('nabd_accounts', JSON.stringify(accs)); 
    
    openAccountSwitcher(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©");
}
    
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ Interval Ø¹Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†ÙˆÙ‚ÙÙ‡ Ù„Ùˆ Ø­Ø¨ÙŠÙ†Ø§
let presenceInterval;

function startPresenceSystem() {
    if (!currentUser) return;

    // 1. ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    updateMyStatus();

    // 2. ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Heartbeat)
    presenceInterval = setInterval(() => {
        updateMyStatus();
    }, 60000); // 60000 Ù…ÙŠÙ„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = Ø¯Ù‚ÙŠÙ‚Ø©

    // 3. Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬ (ØªØ­Ø¯ÙŠØ« Ø£Ø®ÙŠØ±)
    window.addEventListener('beforeunload', () => {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±ÙŠØ¹Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙØ§Ø¬Ø¦ØŒ Ù„Ø°Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª)
        const batch = db.batch();
        const userRef = db.collection('users').doc(currentUser.uid);
        batch.update(userRef, { online: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
        batch.commit();
    });
    
    // 4. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ (Ù„Ùˆ Ø®Ø±Ø¬ ÙˆØ±Ø¬Ø¹)
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            updateMyStatus(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
        }
    });
}


    function updateMyStatus() {
        if (!currentUser || !myActivityVisible) return;
        
        db.collection('users').doc(currentUser.uid).update({
            online: true,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(err => console.log("Presence Error", err));
    }
    // ... (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ) ...

    // ============================================
    // Ø¯ÙˆØ§Ù„ Ù…ÙÙ‚ÙˆØ¯Ø© ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    // ============================================
    function callUserFromPP() {
        showToast("Ù…ÙŠØ²Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù‚Ø±ÙŠØ¨Ø§Ù‹...");
    }

    function infoUserFromPP() {
        // ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        if(currentPreviewChatId) {
            // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù€ UID Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ Ø£Ùˆ ÙØªØ­ Ø§Ù„Ø´Ø§Øª
             navigateToChatFromPP();
        }
    }

    // ============================================
    // ğŸ”¥ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ”¥
    // ============================================
    initApp(); 
// 1. Ø±Ø¨Ø· Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('storyReplyInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        sendStoryReply();
    }
});

// 2. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ÙƒØ±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©
// 1. ØªØ´ØºÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„Ù€ Enter ÙÙŠ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (keyup Ø£ÙØ¶Ù„ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
document.getElementById('storyReplyInput').addEventListener('keyup', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        sendStoryReply();   // Ø¥Ø±Ø³Ø§Ù„
    }
});

// 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù…Ø¹Ø¯Ù„Ø© Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„)
async function sendStoryReply() {
    const input = document.getElementById('storyReplyInput');
    const text = input.value.trim();
    
    if (!text) return;

    const group = storyGroups[currentGroupIndex];
    const storyOwnerId = group.user.uid;
    const story = group.stories[currentStoryIndex];

    if (storyOwnerId === currentUser.uid) {
        showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‚ØµØªÙƒ");
        return;
    }

    const msgToSend = text;
    input.value = ''; 
    input.blur();

    try {
        let chatId = null;
        const snapshot = await db.collection('chats')
            .where('users', 'array-contains', currentUser.uid)
            .get();

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.type !== 'GROUP' && data.users.includes(storyOwnerId)) {
                chatId = doc.id;
            }
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø§Øª Ø¬Ø¯ÙŠØ¯ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
        if (!chatId) {
            const newChatRef = await db.collection('chats').add({
                users: [currentUser.uid, storyOwnerId],
                type: 'DIRECT',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: "Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ØµØ©",
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                seen: false,
                lastSender: currentUser.uid,
                unreadCount: 1,
                deletedBy: [], // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ¶Ø±Ø¨Ø´ ÙÙŠ Ø§Ù„ÙÙ„ØªØ±Ø©
                archivedBy: []
            });
            chatId = newChatRef.id;
        }

        // ğŸ”¥ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ù€ Keys Ø§Ù„ØµØ­ÙŠØ­Ø© (uid Ùˆ createdAt)
        await db.collection('chats').doc(chatId).collection('messages').add({
            text: msgToSend,
            uid: currentUser.uid, // ÙƒØ§Ù†Øª sender ÙˆØ¨Ù‚Øª uid
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), // ÙƒØ§Ù†Øª timestamp ÙˆØ¨Ù‚Øª createdAt
            type: 'story_reply',
            storyUrl: story.url,
            storyType: story.type,
            seen: false
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
        await db.collection('chats').doc(chatId).update({
            lastMessage: `ğŸ’¬ Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ØµØ©: ${msgToSend}`,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            lastSender: currentUser.uid,
            seen: false,
            unreadCount: firebase.firestore.FieldValue.increment(1),
            deletedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid), // Ù„Ùˆ ÙƒØ§Ù† Ù…Ù…Ø³ÙˆØ­ ÙŠØ¸Ù‡Ø± ØªØ§Ù†ÙŠ
            deletedBy: firebase.firestore.FieldValue.arrayRemove(storyOwnerId)
        });

        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ âœ…");
        if (typeof resumeFromInput === 'function') resumeFromInput();

    } catch (error) {
        console.error(error);
        showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ âŒ");
    }
}


// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¶ØºØ·Ø©
let lastTap = 0;

function handleDoubleTap(e) {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¶ØºØ·ØªÙŠÙ† Ø£Ù‚Ù„ Ù…Ù† 300ms
    if (tapLength < 300 && tapLength > 0) {
        e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙˆÙ…
        
        // 1. Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ù„Ø¨ ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
        showBigHeartAnimation();
        
        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
        sendQuickReaction('â¤ï¸'); 
    }
    lastTap = currentTime;
}

// Ø£Ø¶Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø­Ø¯Ø« Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙŠØ¯ÙŠØ§
document.getElementById('storyContent').addEventListener('touchend', handleDoubleTap);

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ù‚Ù„Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ±
function showBigHeartAnimation() {
    const container = document.getElementById('storyContent');
    const heart = document.createElement('i');
    heart.className = 'fa-solid fa-heart';
    heart.style.cssText = `
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0);
        font-size: 100px; color: #fff;
        filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        z-index: 100; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    `;
    
    container.appendChild(heart);
    
    // ØªÙƒØ¨ÙŠØ±
    requestAnimationFrame(() => { heart.style.transform = 'translate(-50%, -50%) scale(1.2)'; });
    
    // Ø§Ø®ØªÙØ§Ø¡
    setTimeout(() => {
        heart.style.opacity = '0';
        heart.style.transform = 'translate(-50%, -50%) scale(0)';
        setTimeout(() => heart.remove(), 300);
    }, 800);
}
// Ø§Ø³ØªØ¯Ø¹Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ loadStory Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ØµØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØªØµÙˆÙŠØª
function renderPollSticker(question, option1, option2) {
    const container = document.getElementById('storyContent');
    
    const pollDiv = document.createElement('div');
    pollDiv.className = 'story-poll';
    pollDiv.innerHTML = `
        <div class="poll-question">${question}</div>
        <div class="poll-options">
            <button onclick="votePoll(this, 1)">${option1}</button>
            <button onclick="votePoll(this, 2)">${option2}</button>
        </div>
    `;
    // Ø³ØªØ§ÙŠÙ„ Ø³Ø±ÙŠØ¹
    pollDiv.style.cssText = `
        position: absolute; top: 60%; left: 50%; transform: translateX(-50%);
        background: #fff; width: 70%; border-radius: 12px; padding: 15px;
        text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 20;
    `;
    
    container.appendChild(pollDiv);
}

// ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø·ÙˆØ± (Fixed Logic) =================
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ‚Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ø´Ø§Ù† Ù…Ù†Ø¹Ù…Ù„Ø´ Ø¨Ø­Ø« Ù…Ø¹ ÙƒÙ„ Ø­Ø±Ù ÙˆÙ†Ø±Ù‡Ù‚ Ø§Ù„Ø³ÙŠØ±ÙØ± (Debounce)
// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ‚Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡)

async function handleGlobalSearch(query) {
    const list = document.getElementById('searchResultsList'); // ØªØ£ÙƒØ¯ Ø¥Ù† Ø¯Ù‡ ID Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§ÙŠØ¬ ÙÙŠ Ø§Ù„Ù€ HTML
    const modal = document.getElementById('searchResultsModal'); // Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø«
    const closeBtn = document.getElementById('closeSearchBtn');

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    if (closeBtn) closeBtn.style.display = query.length > 0 ? 'block' : 'none';

    // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†ØµØŒ Ù†Ø¶Ù ÙˆÙ†Ø®Ø±Ø¬
    if (!query || query.trim() === "") {
        list.innerHTML = '';
        if (modal) modal.classList.remove('active');
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    if (modal) modal.classList.add('active');
    list.innerHTML = `
        <div style="text-align:center; padding:20px; color:#00e5ff;">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª... <i class="fa-solid fa-spinner fa-spin"></i>
        </div>`;

    clearTimeout(searchDebounceTimer);

    // ØªØ£Ø®ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ° Ù‚Ù„ÙŠÙ„Ø§Ù‹ (Debounce) Ù„Ø¹Ø¯Ù… Ø¥Ø±Ù‡Ø§Ù‚ Ø§Ù„Ø³ÙŠØ±ÙØ±
    searchDebounceTimer = setTimeout(async () => {
        try {
            const lowerQuery = query.toLowerCase();
            let resultsHTML = "";
            let foundCount = 0;

            // =========================================================
            // ğŸ”¥ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ‚: Ø§Ø³ØªØ®Ø¯Ø§Ù… Collection Group Query ğŸ”¥
            // Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù€ Collections Ø§Ù„ØªÙŠ Ø§Ø³Ù…Ù‡Ø§ "messages" ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            // =========================================================
            
            // 1. Ø¨Ø­Ø« Ù…Ø¨Ø¯Ø¦ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø¯Ø±Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ Index ÙƒÙ…Ø§ Ø´Ø±Ø­Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ù„ÙƒÙ†Ù‡ Ø§Ù„Ø£Ø³Ø±Ø¹
            const snapshot = await db.collectionGroup('messages')
                .where('text', '>=', query)
                .where('text', '<=', query + '\uf8ff')
                .limit(20) // Ù‡Ø§Øª 20 Ù†ØªÙŠØ¬Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
                .get();

            // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            // Ù†Ø­ØªØ§Ø¬ Ù…ØµÙÙˆÙØ© Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù… await Ø¬ÙˆÙ‡ Ø§Ù„Ù„ÙˆØ¨
            const promises = snapshot.docs.map(async (doc) => {
                const msg = doc.data();
                
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
                if (msg.type === 'deleted') return;

                // ğŸ” Ø§Ù„Ø£Ù…Ø§Ù†: Ù„Ø§Ø²Ù… Ù†ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ ØªØ¨Ø¹ Ø´Ø§Øª Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠÙ‡
                // Ø¨Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù€ ID Ø¨ØªØ§Ø¹ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø£Ø¨ (Parent)
                const chatRef = doc.ref.parent.parent;
                const chatId = chatRef.id;

                // Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø¹Ø´Ø§Ù† Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠÙ‡ + Ù†Ø¬ÙŠØ¨ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù…
                // (Ù…Ù…ÙƒÙ† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ø´ allChats Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø´Ø§Øª Ø­Ø¯ÙŠØ«ØŒ Ø£Ùˆ Ù†Ø¬ÙŠØ¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ùˆ Ù‚Ø¯ÙŠÙ…)
                let chatData = allChats.find(c => c.id === chatId);
                
                // Ù„Ùˆ Ø§Ù„Ø´Ø§Øª Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ÙŠØ¹Ù†ÙŠ Ù‚Ø¯ÙŠÙ… Ø¬Ø¯Ø§Ù‹)ØŒ Ù†Ø¬ÙŠØ¨Ù‡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                if (!chatData) {
                    const chatDoc = await chatRef.get();
                    if (chatDoc.exists) {
                        const d = chatDoc.data();
                        // ØªØ£ÙƒØ¯ Ø¥Ù† Ø£Ù†Ø§ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Security Check)
                        if (d.users && d.users.includes(currentUser.uid)) {
                            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                            const otherUid = d.users.find(u => u !== currentUser.uid);
                            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
                            const uDoc = await db.collection('users').doc(otherUid).get();
                            const uData = uDoc.data() || {};
                            
                            chatData = {
                                id: chatId,
                                name: uData.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                                avatar: uData.profilePic || defaultAvatar,
                                isGroup: d.type === 'GROUP',
                                otherUid: otherUid
                            };
                        }
                    }
                }

                if (chatData) {
                    foundCount++;
                    
                    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
                    const highlightedText = msg.text.replace(new RegExp(`(${query})`, 'gi'), 
                        `<span style="background:#00e5ff; color:#000; padding:0 3px; border-radius:2px;">$1</span>`
                    );

                    const dateStr = msg.createdAt ? new Date(msg.createdAt.toMillis()).toLocaleDateString('ar-EG') : '';

                    resultsHTML += `
                    <div class="search-result-item" onclick="openChatFromSearch('${chatData.id}', '${chatData.name}', '${chatData.otherUid}', '${doc.id}')" 
                         style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;">
                        
                        <div style="width:45px; height:45px; border-radius:50%; background-image:url('${chatData.avatar}'); background-size:cover; border:1px solid rgba(255,255,255,0.1);"></div>
                        
                        <div style="flex:1; overflow:hidden;">
                            <div style="color:#fff; font-weight:bold; font-size:14px; display:flex; justify-content:space-between;">
                                <span>${chatData.name}</span>
                                <span style="font-size:10px; color:#555; font-weight:normal;">${dateStr}</span>
                            </div>
                            <div style="color:#94a3b8; font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${highlightedText}
                            </div>
                        </div>
                    </div>`;
                }
            });

            await Promise.all(promises);

            // 3. Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            if (foundCount === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}"</div>`;
            } else {
                list.innerHTML = `<div style="padding:10px; font-size:11px; color:#00e5ff;">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${foundCount} Ù†ØªÙŠØ¬Ø©</div>` + resultsHTML;
            }

        } catch (e) {
            console.error(e);
            // Ù„Ùˆ Ø§Ù„ÙÙ‡Ø±Ø³ (Index) Ù†Ø§Ù‚ØµØŒ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù‡ÙŠØ¯ÙŠÙƒ Ù„ÙŠÙ†Ùƒ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ØŒ Ù„Ø§Ø²Ù… ØªØ¶ØºØ· Ø¹Ù„ÙŠÙ‡
            if(e.message.includes('index')) {
                list.innerHTML = `<div style="color:orange; padding:20px; text-align:center;">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ (Ù„Ù„Ù…Ø·ÙˆØ±)</div>`;
            } else {
                list.innerHTML = `<div style="color:#ff3b30; padding:20px; text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>`;
            }
        }
    }, 800);
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø´Ø§Øª Ù…Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø±Ø³Ø§Ù„Ø© (Ø²ÙŠ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨)
function openChatFromSearch(chatId, name, uid, msgId) {
    // Ø¨Ù†Ø±ÙˆØ­ Ù„ØµÙØ­Ø© Ø§Ù„Ø´Ø§Øª ÙˆØ¨Ù†Ø¨Ø¹Øª Ù…Ø¹Ø§Ù‡Ø§ ID Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø´Ø§Ù† Ù†Ø¹Ù…Ù„Ù‡Ø§ Highlight
    // Ù‡Ù†Ø³ØªØ®Ø¯Ù… 'highlight' ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
    const url = `chat.html?chatId=${chatId}&name=${encodeURIComponent(name)}&uid=${uid}&highlightMsg=${msgId}`;
    window.location.href = url;
}


// Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… (ÙØµÙ„Ù†Ø§Ù‡Ø§ Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ø±ØªÙŠÙ†)
function renderSearchResults(results, query, isFinal) {
    const list = document.getElementById('searchResultsList');
    
    if (results.length === 0 && isFinal) {
        list.innerHTML = `<div style="padding:30px; text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>`;
        return;
    }

    let html = `<div style="padding:10px 15px; font-size:12px; color:#aaa; border-bottom:1px solid rgba(255,255,255,0.1);">
                    ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <span style="color:#FFD700">${results.length}</span> Ù†ØªÙŠØ¬Ø©
                    ${!isFinal ? '<i class="fa-solid fa-spinner fa-spin" style="float:left"></i>' : ''}
                </div>`;

    results.forEach(c => {
        let snippet = c.lastMsg;
        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø©
        const regex = new RegExp(`(${query})`, 'gi');
        const displayHTML = snippet.replace(regex, '<span style="background:#FFD700; color:#000;">$1</span>');
        
        // Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙˆØ¶Ø­ Ø¥Ù† Ø¯ÙŠ Ø±Ø³Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø©
        const icon = c.isOldMessage ? '<i class="fa-solid fa-clock-rotate-left" style="color:#888; font-size:10px;"></i> Ø£Ø±Ø´ÙŠÙ:' : '';

        html += `
        <div class="search-result-item" onclick="openChat('${c.id}', '${encodeURIComponent(c.name)}', '${c.isGroup ? 'GROUP' : c.otherUid}', false)" 
             style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;">
            
            <div style="width:40px; height:40px; border-radius:12px; background-image:url('${c.avatar}'); background-size:cover;"></div>
            
            <div style="flex:1;">
                <div style="color:#fff; font-weight:bold; font-size:14px;">${c.name}</div>
                <div style="color:#aaa; font-size:12px; margin-top:2px;">
                    ${icon} ${displayHTML}
                </div>
            </div>
        </div>`;
    });

    list.innerHTML = html;
}

function performSearchLogic(query) {
    const modal = document.getElementById('searchResultsModal');
    const listContainer = document.getElementById('searchResultsList');

    if (!listContainer || !modal) return;

    listContainer.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ…

    // Ø­Ù…Ø§ÙŠØ©: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!allChats || allChats.length === 0) {
        listContainer.innerHTML = `<div style="text-align:center; padding:20px; color:#777;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...</div>`;
        modal.classList.add('active'); // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ±
        return;
    }

    try {
        // === Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ø­Ø« ===
        const results = allChats.filter(chat => {
            // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
            const name = (chat.name || "").toLowerCase();
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù†Øµ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            let rawMsg = String(chat.lastMsg || "");
            
            // Ù„Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙˆØ¯ HTML Ù†Ø­ÙˆÙ„Ù‡Ø§ Ù„Ù†Øµ Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ø¨Ø­Ø«
            if (rawMsg.includes('<')) {
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = rawMsg;
                rawMsg = tempDiv.textContent || tempDiv.innerText || "";
            }
            rawMsg = rawMsg.toLowerCase();

            return name.includes(query) || rawMsg.includes(query);
        });

        // === Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===
        if (results.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align:center; padding:30px; color:#888;">
                    <i class="fa-solid fa-magnifying-glass" style="font-size:24px; margin-bottom:10px; opacity:0.5;"></i>
                    <br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}"
                </div>`;
        } else {
            // Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ø¯Ø¯
            listContainer.innerHTML = `
                <div style="padding:10px 15px; font-size:12px; color:#aaa; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px;">
                    ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <span style="color:#FFD700">${results.length}</span> Ù†ØªÙŠØ¬Ø©
                </div>
            `;

            results.forEach(chat => {
                let snippet = String(chat.lastMsg || "Ø±Ø³Ø§Ù„Ø©"); // Ø­Ù…Ø§ÙŠØ©
                
                // ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ù†Øµ Ù„Ùˆ ÙƒØ§Ù† Ù…ÙŠØ¯ÙŠØ§
                if (snippet.includes('<') || snippet.includes('fa-camera')) {
                     snippet = "ØµÙˆØ±Ø© / ÙˆØ³Ø§Ø¦Ø·";
                }

                let foundInMsg = snippet.toLowerCase().includes(query);
                let displayHTML = snippet;

                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© (Highlight)
                if (foundInMsg) {
                    try {
                        const regex = new RegExp(`(${query})`, 'gi');
                        displayHTML = snippet.replace(regex, '<span class="highlight-text">$1</span>');
                    } catch(e) { displayHTML = snippet; }
                }

                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
                item.onclick = () => {
                    vibrate();
                    closeSearchPopup();
                    const targetUrl = (chat.isRequest ? 'request_view.html' : 'chat.html') + 
                                      `?chatId=${chat.id}&name=${encodeURIComponent(chat.name)}&uid=${chat.isGroup ? 'GROUP' : chat.otherUid}`;
                    location.href = targetUrl;
                };

                item.innerHTML = `
                    <div class="search-res-avatar" style="background-image: url('${chat.avatar}'); width:40px; height:40px; border-radius:12px; background-size:cover;"></div>
                    <div class="search-res-info" style="flex:1;">
                        <div class="search-res-name" style="color:#fff; font-weight:bold; font-size:14px;">
                            ${chat.name} 
                            ${chat.isVerified ? '<i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:10px;"></i>' : ''}
                        </div>
                        <div class="search-res-snippet" style="color:#aaa; font-size:12px; margin-top:2px;">
                            ${foundInMsg ? '<i class="fa-solid fa-turn-up" style="color:#FFD700; font-size:10px; margin-left:5px;"></i>' : ''} 
                            ${displayHTML}
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
    } catch (err) {
        console.error("Search Error:", err);
        listContainer.innerHTML = `<div style="text-align:center; color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>`;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø®ÙŠØ±Ø§Ù‹
    modal.classList.add('active');
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØºÙ„Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬
    setTimeout(() => {
        document.addEventListener('click', closeSearchOnClickOutside);
    }, 100);
}

function closeSearchPopup() {
    const modal = document.getElementById('searchResultsModal');
    if(modal) modal.classList.remove('active');
    document.removeEventListener('click', closeSearchOnClickOutside);
}

function closeSearchOnClickOutside(e) {
    const modal = document.getElementById('searchResultsModal');
    const input = document.getElementById('globalSearchInput');
    
    // Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØºÙŠØ± Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
    if (modal && input && !modal.contains(e.target) && e.target !== input) {
        closeSearchPopup();
    }
}

// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯Ø§Ù„Ø©
let activeUserLongPressTimer;
let isLongPressHandled = false;

function renderQuickActiveUsers() {
    const list = document.getElementById('quickUsersList');
    const container = document.getElementById('quickUsersContainer');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ù„Ùˆ Ù…Ø´ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if (currentView !== 'inbox') {
        container.style.display = 'none';
        return;
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    let peopleMap = new Map();
    friendUids.forEach(uid => { if (usersCache[uid]) peopleMap.set(uid, usersCache[uid]); });
    allChats.forEach(chat => {
        if (!chat.isGroup && chat.otherUid) {
            const cachedUser = usersCache[chat.otherUid] || { uid: chat.otherUid, name: chat.name, avatar: chat.avatar, isVerified: chat.isVerified, isOnline: chat.isOnline };
            peopleMap.set(chat.otherUid, cachedUser);
        }
    });

    let peopleArray = Array.from(peopleMap.values());

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø®ÙÙŠÙŠÙ† (Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙŠØ´ØªØºÙ„)
    if (typeof hiddenActiveUsersSet !== 'undefined') {
        peopleArray = peopleArray.filter(u => !hiddenActiveUsersSet.has(u.uid));
    }

    // Ø§Ù„ØªØ±ØªÙŠØ¨
    peopleArray.sort((a, b) => {
        const aOnline = a.isOnline && window.isOnlineFeatureEnabled;
        const bOnline = b.isOnline && window.isOnlineFeatureEnabled;
        if (aOnline === bOnline) return 0;
        return aOnline ? -1 : 1;
    });

    if (peopleArray.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'flex';
    list.innerHTML = '';

    peopleArray.forEach(user => {
                // Ù„Ùˆ Ø§Ù„Ø´Ø®Øµ Ø¯Ù‡ Ù…Ø­Ø¸ÙˆØ±ØŒ Ø§Ø®Ø±Ø¬ ÙˆÙ…Ø§ ØªØ±Ø³Ù…ÙˆØ´ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø´Ø§Ø·
        const chatCheck = allChats.find(c => c.otherUid === user.uid);
        if (chatCheck && chatCheck.isBlocked) return; 

        if(user.uid === currentUser.uid) return;

        const item = document.createElement('div');
        item.className = 'quick-user-item';
        
        const isReallyOnline = user.isOnline && window.isOnlineFeatureEnabled;
        const dotDisplay = isReallyOnline ? 'block' : 'none';
        const firstName = user.name ? user.name.split(' ')[0] : "Ù…Ø³ØªØ®Ø¯Ù…";

        item.innerHTML = `
            <div class="quick-avatar-wrapper">
                <div class="quick-avatar-img" style="background-image: url('${user.avatar || defaultAvatar}');"></div>
                <div class="quick-online-dot" style="display: ${dotDisplay};"></div>
            </div>
            <div class="quick-user-name">${firstName}</div>
        `;

        // ============================================================
        // ğŸ”¥ğŸ”¥ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ø§Ù„ØªÙØ±ÙŠÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ù„Ù…Ø³Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ø·ÙˆÙ„Ø© ğŸ”¥ğŸ”¥
        // ============================================================

        let pressTimer;
        let isLongPress = false;

        // 1. Ø¹Ù†Ø¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµØ¨Ø¹ (Touch Start)
        item.addEventListener('touchstart', (e) => {
            isLongPress = false; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
            
            // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ù„Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ (600 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
            pressTimer = setTimeout(() => {
                isLongPress = true; // ØªÙ… Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ Ø§Ù„Ø¢Ù† Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø©
                if(navigator.vibrate) navigator.vibrate(50); // Ø§Ù‡ØªØ²Ø§Ø²
                
                // ğŸ”¥ Ù‡Ù†Ø§ Ù†ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ğŸ”¥
                openActiveUserOptions(user); 
            }, 600);
        }, { passive: true });

        // 2. Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ø¥ØµØ¨Ø¹ (Touch End) - Ù‡Ù†Ø§ ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ø´Ø§Øª
        item.addEventListener('touchend', (e) => {
            clearTimeout(pressTimer); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙˆØ±Ø§Ù‹

            // Ù„Ùˆ Ù…ÙƒÙ†ØªØ´ Ø¶ØºØ·Ø© Ù…Ø·ÙˆÙ„Ø© (ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Ù„ ØµØ¨Ø§Ø¹Ù‡ Ø¨Ø³Ø±Ø¹Ø©)
            if (!isLongPress) {
                // ğŸ”¥ Ù‡Ù†Ø§ Ù†ÙØªØ­ Ø§Ù„Ø´Ø§Øª (Ø§Ù„Ù„Ù…Ø³Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©) ğŸ”¥
                openChatWithUserSmart(user);
            }
        });

        // 3. Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø±Ùƒ ØµØ¨Ø§Ø¹Ù‡ (Ø¨ÙŠØ¹Ù…Ù„ Ø³ÙƒØ±ÙˆÙ„) -> Ø§Ù„ØºÙŠ ÙƒÙ„ Ø­Ø§Ø¬Ø©
        item.addEventListener('touchmove', () => {
            clearTimeout(pressTimer);
            isLongPress = true; // Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ true Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ ÙŠØ´ÙŠÙ„ ØµØ¨Ø§Ø¹Ù‡ Ù…ÙŠÙÙƒØ±Ø´ Ø§Ù†Ù‡Ø§ Ù†Ù‚Ø±Ø© ÙˆÙŠÙØªØ­ Ø§Ù„Ø´Ø§Øª
        });

        // 4. Ø¯Ø¹Ù… Ø§Ù„Ù…Ø§ÙˆØ³ (Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
        item.oncontextmenu = (e) => {
            e.preventDefault();
            openActiveUserOptions(user); // ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ† ÙŠÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        };

        item.onclick = (e) => {
            // Ù„Ùˆ ÙƒÙ„ÙŠÙƒ Ø´Ù…Ø§Ù„ Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ØŒ Ø§ÙØªØ­ Ø§Ù„Ø´Ø§Øª
            if (e.pointerType === 'mouse') {
                openChatWithUserSmart(user);
            }
        };

        list.appendChild(item);
    });
}

// ============================================================
// ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ Ø§Ù„Ø´Ø§Øª Ø¨Ø°ÙƒØ§Ø¡ (Ø¹Ø´Ø§Ù† Ù…Ù†ÙƒØ±Ø±Ù‡Ø§Ø´) ğŸ”¥
// (Ø¶ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù€ JS)
// ============================================================
function openChatWithUserSmart(user) {
    if(navigator.vibrate) navigator.vibrate(10); // Ù‡Ø²Ø© Ø®ÙÙŠÙØ© Ù„Ù„ØªØ£ÙƒÙŠØ¯
    
    // 1. Ù†Ø¯ÙˆØ± Ù‡Ù„ ÙÙŠÙ‡ Ø´Ø§Øª Ù‚Ø¯ÙŠÙ… ÙˆÙ„Ø§ Ù„Ø£ØŸ
    const existingChat = allChats.find(c => !c.isGroup && c.otherUid === user.uid);
    
    if (existingChat) {
        // Ù„Ùˆ Ù„Ù‚ÙŠÙ†Ø§ Ø´Ø§Øª Ù‚Ø¯ÙŠÙ…ØŒ Ù†ÙØªØ­Ù‡ Ø¨Ø§Ù„Ù€ ID Ø¨ØªØ§Ø¹Ù‡
        openChat(existingChat.id, encodeURIComponent(existingChat.name), user.uid, false);
    } else {
        // Ù„Ùˆ Ù…ÙÙŠØ´ØŒ Ù†ÙØªØ­ Ø´Ø§Øª Ø¬Ø¯ÙŠØ¯
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ø¥Ù† user.name Ù…Ø´ undefined
        const safeName = user.name || "Ù…Ø³ØªØ®Ø¯Ù…";
        const url = `chat.html?chatId=new&name=${encodeURIComponent(safeName)}&uid=${user.uid}`;
        location.href = url;
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ Ø§Ù„Ø´Ø§Øª (Ø¹Ø´Ø§Ù† Ù…Ù†ÙƒØ±Ø±Ù‡Ø§Ø´)
function openChatWithUserLogic(user) {
    vibrate();
    const existingChat = allChats.find(c => !c.isGroup && c.otherUid === user.uid);
    
    if (existingChat) {
        openChat(existingChat.id, encodeURIComponent(existingChat.name), user.uid, false);
    } else {
        const url = `chat.html?chatId=new&name=${encodeURIComponent(user.name)}&uid=${user.uid}`;
        location.href = url;
    }
}


// ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
function openActiveUserOptions(user) {
    selectedActiveUser = user;
    
    document.getElementById('activeUserSheetName').innerText = user.name;
    document.getElementById('activeUserSheetAvatar').style.backgroundImage = `url('${user.avatar}')`;
    
    document.getElementById('activeUserOptionsModal').classList.add('active');
}

function closeActiveUserOptions() {
    document.getElementById('activeUserOptionsModal').classList.remove('active');
}

// 1. Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
function viewUserProfileFromSheet() {
    location.href = `profile.html?uid=${selectedActiveUser.uid}`;
}

// 2. Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©
function openChatFromSheet() {
    const url = `chat.html?chatId=new&name=${encodeURIComponent(selectedActiveUser.name)}&uid=${selectedActiveUser.uid}`;
    location.href = url;
}

// 3. ğŸ”¥ Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‡Ù…) ğŸ”¥
function startShareContactFlow() {
    closeActiveUserOptions();
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø§ØªØ§Øª Ù„Ø§Ø®ØªÙŠØ§Ø± Ù‡ØªØ¨Ø¹ØªÙ‡Ø§ Ù„Ù…ÙŠÙ†
    const modal = document.getElementById('shareToChatModal');
    const list = document.getElementById('shareToList');
    list.innerHTML = '';
    
    modal.classList.add('active');
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ø§ØªØ§Øª (Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙØ±Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)
    allChats.forEach(chat => {
        const div = document.createElement('div');
        div.className = 'new-chat-item'; // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
        div.innerHTML = `
            <div class="nc-avatar" style="background-image: url('${chat.avatar}')"></div>
            <div class="nc-name">${chat.name}</div>
            <button style="margin-right:auto; background:var(--accent-color); border:none; color:#fff; padding:5px 12px; border-radius:15px;">Ø¥Ø±Ø³Ø§Ù„</button>
        `;
        
        div.onclick = () => {
            sendProfileCardToChat(chat.id);
            modal.classList.remove('active');
        };
        list.appendChild(div);
    });
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ§Ø±Øª Ù„Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© "Ù†Ø´Ø· Ø§Ù„Ø¢Ù†"
async function sendProfileCardToChat(targetChatId) {
    if(!selectedActiveUser) return;
    
    showToast("Ø¬Ø§Ø±ÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù... â³");

    try {
        // Ù„Ø§Ø²Ù… Ù†Ø¨Ø¹Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†ÙØ³ Ø§Ù„Ù€ Keys Ø§Ù„Ù„ÙŠ Ø§Ù„Ø´Ø§Øª Ø¨ÙŠÙÙ‡Ù…Ù‡Ø§
        await db.collection('chats').doc(targetChatId).collection('messages').add({
            uid: currentUser.uid, // ØªØºÙŠÙŠØ± Ù…Ù† sender Ù„Ù€ uid
            createdAt: firebase.firestore.FieldValue.serverTimestamp(), // ØªØºÙŠÙŠØ± Ù…Ù† timestamp Ù„Ù€ createdAt
            type: 'profile_card', 
            profileUid: selectedActiveUser.uid,
            profileName: selectedActiveUser.name,
            profileImage: selectedActiveUser.avatar || '',
            seen: false, // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
            text: `ğŸ‘¤ Ù…Ù„Ù Ø´Ø®ØµÙŠ: ${selectedActiveUser.name}` // Ù†Øµ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        });
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø±Ù‡
        await db.collection('chats').doc(targetChatId).update({
            lastMessage: `ğŸ‘¤ Ù…Ù„Ù Ø´Ø®ØµÙŠ: ${selectedActiveUser.name}`,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            lastSender: currentUser.uid,
            seen: false,
            unreadCount: firebase.firestore.FieldValue.increment(1)
        });

        showToast("ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    } catch(e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âŒ");
    }
}

// 1. Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (ØªØ­ÙˆÙ„ Ø§Ù„Ù‚ØµØ© Ù„Ù„Ø£Ø±Ø´ÙŠÙ ÙÙˆØ±Ø§Ù‹)
function archiveCurrentStoryManual() {
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù‚ØµØ©ØŸ Ø³ØªØ®ØªÙÙŠ Ù…Ù† Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØªØ¸Ù‡Ø± ÙÙŠ Ø£Ø±Ø´ÙŠÙÙƒ ÙÙ‚Ø·.")) return;

    const group = storyGroups[currentGroupIndex];
    const story = group.stories[currentStoryIndex];
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù†Ø¶ÙŠÙ Ø­Ù‚Ù„ isArchived = true
    db.collection('stories').doc(story.id).update({
        isArchived: true
    }).then(() => {
        showToast("ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        closeStoryOptions();
        closeStory(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø±Ø¶
        renderStories(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ØµØ©
    }).catch(err => console.error(err));
}
// ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¹Ø±Ø¶ + Ù…Ø¹Ø§ÙŠÙ†Ø©) =================

// ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø± + Ù‚Ø§Ø¦Ù…Ø©) =================

// ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©) =================

function openStoryArchive() {
    toggleSidebar(); 
    document.getElementById('storyArchiveModal').style.display = 'flex';
    const grid = document.getElementById('archiveGrid');
    
    grid.innerHTML = '<div style="grid-column:span 3; text-align:center; padding:50px; color:var(--accent-color);"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px;"></i></div>';

    db.collection('stories')
      .where('uid', '==', currentUser.uid)
      .orderBy('createdAt', 'desc')
      .get()
      .then(snapshot => {
          grid.innerHTML = '';
          const now = Date.now();
          let count = 0;

          snapshot.forEach(doc => {
              const d = doc.data();
              const timeData = d.createdAt || d.timestamp;
              if (!timeData) return;

              const storyTime = timeData.toMillis();
              const isExpired = (now - storyTime) > (24 * 60 * 60 * 1000);
              
              if (isExpired || d.isArchived === true) {
                  count++;
                  
                  let mediaContent = d.type === 'video' 
                      ? `<video src="${d.url}#t=0.1" class="archive-media" preload="metadata" muted></video>` 
                      : `<img src="${d.url}" class="archive-media" loading="lazy">`;

                  const dateObj = new Date(storyTime);
                  const dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()}`;

                  const item = document.createElement('div');
                  item.className = 'archive-item';
                  item.id = `arch-item-${doc.id}`; // ID Ù…Ù…ÙŠØ² Ù„Ù„ÙƒØ§Ø±Øª ÙƒÙ„Ù‡

                  // ğŸ”¥ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØºÙ„Ø§Ù Ù„Ù„ØµÙˆØ±Ø© + Ø²Ø± ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø¨Ø±Ù‡ Ø§Ù„ØºÙ„Ø§Ù ğŸ”¥
                  item.innerHTML = `
                      <div class="archive-media-wrapper">
                          ${mediaContent}
                          <div class="archive-date-badge" style="position:absolute; bottom:0; right:0; width:100%; padding:20px 5px 5px; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); color:#fff; font-size:10px; text-align:right;">${dateStr}</div>
                      </div>
                      
                      <div class="archive-more-btn" onclick="event.stopPropagation(); toggleArchiveMenu('${doc.id}')">
                          <i class="fa-solid fa-ellipsis"></i>
                      </div>

                      <div id="menu-${doc.id}" class="archive-menu">
                          <div class="archive-menu-item" onclick="event.stopPropagation(); repostFromArchive('${d.url}', '${d.type}', '${doc.id}')">
                              <i class="fa-solid fa-retweet"></i> Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±
                          </div>
                          <div class="archive-menu-item danger" style="color:#ff5555;" onclick="event.stopPropagation(); deleteFromArchive('${doc.id}', '${d.url}')">
                              <i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                          </div>
                      </div>
                  `;
                  
                  item.onclick = () => { viewArchivedStory(d.url, d.type); };
                  grid.appendChild(item);
              }
          });

          if(count === 0) {
              grid.innerHTML = `<div class="empty-archive"><i class="fa-solid fa-box-open"></i><span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº</span></div>`;
          }
      }).catch(err => {
          console.error(err);
      });
      
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†
    document.addEventListener('click', closeAllArchiveMenus);
}

// --- ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø§Ù„Ø³Ø± Ù‡Ù†Ø§) ---
function toggleArchiveMenu(docId) {
    const menu = document.getElementById(`menu-${docId}`);
    const parentItem = document.getElementById(`arch-item-${docId}`);
    const isVisible = menu.classList.contains('show');
    
    // 1. Ø§Ù‚ÙÙ„ Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© ØªØ§Ù†ÙŠØ© ÙˆØ±Ø¬Ø¹ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ù„ÙˆØ¶Ø¹Ù‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    closeAllArchiveMenus();
    
    // 2. Ù„Ùˆ Ù…ÙƒÙ†ØªØ´ Ù…ÙØªÙˆØ­Ø©ØŒ Ø§ÙØªØ­Ù‡Ø§ ÙˆØ§Ø±ÙØ¹ Ø§Ù„ÙƒØ§Ø±Øª Ø¯Ù‡ ÙÙˆÙ‚ Ø§Ù„ÙƒÙ„
    if (!isVisible) {
        menu.classList.add('show');
        parentItem.classList.add('active-zindex'); // Ø¯Ù‡ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ±ÙØ¹ Ø§Ù„ÙƒØ§Ø±Øª
    }
}

// --- ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ---
function closeAllArchiveMenus() {
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.querySelectorAll('.archive-menu').forEach(menu => menu.classList.remove('show'));
    // Ø¥Ø±Ø¬Ø§Ø¹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª (z-index) Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡
    document.querySelectorAll('.archive-item').forEach(item => item.classList.remove('active-zindex'));
}


// --- Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©) ---
function closeAllArchiveMenus() {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.querySelectorAll('.archive-menu').forEach(menu => menu.classList.remove('show'));
    // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³ Ø§Ù„Ù€ z-index Ø§Ù„Ø¹Ø§Ù„ÙŠ Ù…Ù† ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØª
    document.querySelectorAll('.archive-item').forEach(item => item.classList.remove('active-menu'));
}

// (ÙˆØ¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø²ÙŠ repostFromArchive Ùˆ deleteFromArchive Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)


// --- Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ---
function closeAllArchiveMenus() {
    document.querySelectorAll('.archive-menu').forEach(menu => menu.classList.remove('show'));
}

// --- Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± (Repost) ---
function repostFromArchive(url, type, originalId) {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    closeAllArchiveMenus();
    
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù‚ØµØ© Ù„ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ø§Ù…Ø© Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©ØŸ")) return;

    showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø±...");

    // Ø¥Ø¶Ø§ÙØ© Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.collection('stories').add({
        uid: currentUser.uid,
        url: url,
        type: type,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(), // ÙˆÙ‚Øª Ø¬Ø¯ÙŠØ¯
        createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨
        viewers: [], // ØªØµÙÙŠØ± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
        isArchived: false // ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ø§Ù…Ø©
    }).then(() => {
        showToast("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
        closeStoryArchive(); // Ù‚ÙÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¹Ø´Ø§Ù† ÙŠØ´ÙˆÙ Ø§Ù„Ù‚ØµØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        renderStories(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙŠØ·
    }).catch(err => {
        console.error(err);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    });
}
// ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =================

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù†ØªØ­ÙƒÙ… ÙÙŠÙ‡
let currentVideoPlayer = null;

// ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ù…Ø¹ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ·) =================

function viewArchivedStory(url, type) {
    vibrate();
    const viewer = document.getElementById('archiveFullViewer');
    const container = document.getElementById('archiveViewerContainer');
    
    viewer.style.display = 'flex';
    container.innerHTML = ''; 

    if (type === 'video') {
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ HTML
        container.innerHTML = `
            <div class="custom-video-wrapper" id="customVideoWrapper">
                <video src="${url}" class="custom-video-element" id="customVideoEl" playsinline></video>
                
                <div class="center-play-btn">
                    <i class="fa-solid fa-play"></i>
                </div>

                <div class="video-controls-bar" onclick="event.stopPropagation()">
                    <i class="fa-solid fa-play ctrl-btn" id="playPauseBtn"></i>
                    
                    <div class="video-time" id="currentTimeDisplay">00:00</div>
                    
                    <div class="video-progress-container" id="progressBarContainer">
                        <div class="video-progress-fill" id="progressBarFill"></div>
                    </div>
                    
                    <div class="video-time" id="durationDisplay">00:00</div>
                    
                    <i class="fa-solid fa-volume-high ctrl-btn" id="muteBtn"></i>
                </div>
            </div>
        `;

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const wrapper = document.getElementById('customVideoWrapper');
        const video = document.getElementById('customVideoEl');
        const playBtn = document.getElementById('playPauseBtn');
        const muteBtn = document.getElementById('muteBtn');
        const progressContainer = document.getElementById('progressBarContainer');
        const progressFill = document.getElementById('progressBarFill');
        const currTime = document.getElementById('currentTimeDisplay');
        const durTime = document.getElementById('durationDisplay');

        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        video.play().then(() => {
            wrapper.classList.add('playing');
            playBtn.className = "fa-solid fa-pause ctrl-btn";
        }).catch(() => {
            playBtn.className = "fa-solid fa-play ctrl-btn";
        });

        // 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        const togglePlay = () => {
            if (video.paused) {
                video.play();
                wrapper.classList.add('playing');
                playBtn.className = "fa-solid fa-pause ctrl-btn";
                document.querySelector('.center-play-btn i').className = "fa-solid fa-play";
            } else {
                video.pause();
                wrapper.classList.remove('playing');
                playBtn.className = "fa-solid fa-play ctrl-btn";
                document.querySelector('.center-play-btn i').className = "fa-solid fa-pause";
            }
        };

        video.addEventListener('click', togglePlay);
        playBtn.addEventListener('click', togglePlay);

        // 2. ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… (ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
        let isDragging = false; // Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ø§Ø­Ù†Ø§ Ø¨Ù†Ø³Ø­Ø¨ ÙˆÙ„Ø§ Ù„Ø£

        video.addEventListener('timeupdate', () => {
            if (!isDragging) { // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ Ø¨ÙŠØ³Ø­Ø¨ Ø§Ù„Ø´Ø±ÙŠØ·ØŒ Ø­Ø¯Ø«Ù‡ Ø¹Ø§Ø¯ÙŠ
                const percent = (video.currentTime / video.duration) * 100;
                progressFill.style.width = `${percent}%`;
                currTime.innerText = formatTime(video.currentTime);
            }
            if(video.duration) durTime.innerText = formatTime(video.duration);
        });

        // 3. ğŸ”¥ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„ØªØ­ÙƒÙ… (Scrubbing Logic) ğŸ”¥
        
        const updateScrub = (e) => {
            const rect = progressContainer.getBoundingClientRect();
            // Ø¯Ø¹Ù… Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„Ù„Ù…Ø³ (Touch)
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ø³Ø¨ÙŠ Ù„Ù„Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ·
            let pos = (clientX - rect.left) / rect.width;
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨ÙŠÙ† 0 Ùˆ 1
            pos = Math.max(0, Math.min(1, pos));
            
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø´Ø±ÙŠØ· ÙÙˆØ±Ø§Ù‹ (Visual Feedback)
            progressFill.style.width = `${pos * 100}%`;
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±Ø§Ù‹
            if (video.duration) {
                video.currentTime = pos * video.duration;
                currTime.innerText = formatTime(video.currentTime);
            }
        };

        // Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¶ØºØ· Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³
        const startDrag = (e) => {
            isDragging = true;
            updateScrub(e); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¶ØºØ·Ø©
        };

        // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Ø§Ù„Ø³Ø­Ø¨)
        const doDrag = (e) => {
            if (isDragging) {
                e.preventDefault(); // Ù…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø©
                updateScrub(e);
            }
        };

        // Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„ÙŠØ¯
        const stopDrag = () => {
            if (isDragging) {
                isDragging = false;
                // Ù„Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ§Ù† ÙˆØ§Ù‚Ù Ø´ØºÙ„Ù‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                if(video.paused) togglePlay(); 
            }
        };

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±)
        progressContainer.addEventListener('mousedown', startDrag);
        progressContainer.addEventListener('touchstart', startDrag, {passive: false});

        document.addEventListener('mousemove', doDrag);
        document.addEventListener('touchmove', doDrag, {passive: false});

        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);


        // 4. ÙƒØªÙ… Ø§Ù„ØµÙˆØª
        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            muteBtn.className = video.muted ? "fa-solid fa-volume-xmark ctrl-btn" : "fa-solid fa-volume-high ctrl-btn";
        });

        // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        video.addEventListener('ended', () => {
            wrapper.classList.remove('playing');
            playBtn.className = "fa-solid fa-arrow-rotate-right ctrl-btn"; 
        });

    } else {
        // Ù„Ùˆ ØµÙˆØ±Ø© (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ)
        const img = document.createElement('img');
        img.src = url;
        img.className = 'archive-viewer-content';
        container.appendChild(img);
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return "00:00";
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
function closeArchiveViewer() {
    const viewer = document.getElementById('archiveFullViewer');
    const container = document.getElementById('archiveViewerContainer');
    
    const vid = container.querySelector('video');
    if(vid) {
        vid.pause();
        vid.src = ""; 
    }
    
    viewer.style.display = 'none';
    container.innerHTML = '';
}


// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¹Ø´Ø§Ù† ØªÙˆÙ‚Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØµØ­
function closeArchiveViewer() {
    const viewer = document.getElementById('archiveFullViewer');
    const container = document.getElementById('archiveViewerContainer');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø´ØºØ§Ù„
    const vid = container.querySelector('video');
    if(vid) {
        vid.pause();
        vid.src = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØµØ¯Ø± Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    }
    
    viewer.style.display = 'none';
    container.innerHTML = '';
}

// --- Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ---
function closeArchiveViewer() {
    const viewer = document.getElementById('archiveFullViewer');
    const container = document.getElementById('archiveViewerContainer');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ùˆ Ø´ØºØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ù‚ÙÙ„
    const vid = container.querySelector('video');
    if(vid) vid.pause();
    
    viewer.style.display = 'none';
    container.innerHTML = '';
}

// 2. Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù‚ØµØ© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ
function deleteFromArchive(docId, fileUrl) {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚ØµØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ")) return;

    vibrate();
    
    // 1. Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ (Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    const el = document.getElementById(`arch-${docId}`);
    if(el) {
        el.style.opacity = '0';
        el.style.transform = 'scale(0.8)';
        setTimeout(() => el.remove(), 300);
    }

    // 2. Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.collection('stories').doc(docId).delete().then(() => {
        // 3. Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† (Storage) Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        if(fileUrl) {
            try {
                firebase.storage().refFromURL(fileUrl).delete().catch(e => console.log("File delete error (ignore):", e));
            } catch(e){}
        }
        showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ ğŸ—‘ï¸");
    }).catch(error => {
        console.error("Error removing document: ", error);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
        // Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù†ØµØ± ØªØ§Ù†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if(el) openStoryArchive(); 
    });
}


// 3. Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ
function closeStoryArchive() {
    document.getElementById('storyArchiveModal').style.display = 'none';
}

// Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„Ù†Øµ Ù‚ØµÙŠØ± (Ø²ÙŠ: 5Ø¯ - 2Ø³ - 1ÙŠ)
function getShortLastSeen(timestamp) {
    if (!timestamp) return '';
    
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
    if (minutes < 60) return `${minutes}Ø¯`; // Ø¯Ù‚ÙŠÙ‚Ø©
    if (hours < 24) return `${hours}Ø³`;   // Ø³Ø§Ø¹Ø©
    if (days < 4) return `${days}ÙŠ`;      // ÙŠÙˆÙ… (Ù„Ø­Ø¯ 3 Ø£ÙŠØ§Ù… Ø¨Ø³)
    
    return ''; // Ù„Ùˆ Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£ÙŠØ§Ù… Ù…Ù†Ø¸Ù‡Ø±Ø´ Ø­Ø§Ø¬Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø²Ø­Ù…Ø©
}
// 1. Ø¯Ø§Ù„Ø© ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ØªÙˆØ¶Ø¹ Ø¯Ø§Ø®Ù„ Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© context menu)
async function pinMessage() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØªØ§Ø±Ø©
    if(!selectedMsgId || !selectedMsgData) return;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ¸Ù‡Ø± (Ù„Ùˆ ØµÙˆØ±Ø© Ù†ÙƒØªØ¨ "ØµÙˆØ±Ø©" ÙˆÙ‡ÙƒØ°Ø§)
    let previewText = selectedMsgData.text;
    if(selectedMsgData.type === 'image') previewText = 'ğŸ“· ØµÙˆØ±Ø©';
    else if(selectedMsgData.type === 'video') previewText = 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ';
    else if(selectedMsgData.type === 'audio') previewText = 'ğŸ¤ Ù…Ù‚Ø·Ø¹ ØµÙˆØªÙŠ';

    // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    await db.collection('chats').doc(chatId).update({
        pinnedMessage: {
            text: previewText,
            id: selectedMsgId
        }
    });
    
    showToast("ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸ“Œ");
    closeContextMenu(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚ÙØ² Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠØ·
function jumpToPinned() {
    if(window.pinnedMsgId) {
        // Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù‚ÙˆÙŠØ© Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„Ù†Ø§Ù‡Ø§ Ø¹Ø´Ø§Ù† ØªØ¬ÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­ØªÙ‰ Ù„Ùˆ Ù‚Ø¯ÙŠÙ…Ø©
        handleSearchResultClick(window.pinnedMsgId);
    }
}
// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function openSetChatPassModal() {
    closeOptions();
    document.getElementById('setChatPassModal').style.display = 'flex';
    document.getElementById('newChatPassInput').value = '';
    document.getElementById('newChatPassInput').focus();
}

// 2. Ø­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function saveChatPassword() {
    const pass = document.getElementById('newChatPassInput').value;
    
    if (!pass || pass.length !== 6 || isNaN(pass)) {
        showToast("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·");
        return;
    }

    try {
        await db.collection('chats').doc(selectedChatId).update({
            lockPass: pass
        });
        showToast("ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ”’");
        document.getElementById('setChatPassModal').style.display = 'none';
    } catch (error) {
        console.error(error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
    }
}

// 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙØªØ­
async function verifyChatPassword() {
    const inputField = document.getElementById('chatPassInput'); // Ù…Ø³ÙƒÙ†Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
    const inputPass = inputField.value;
    
    if (!inputPass || inputPass.length !== 6) {
        showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©");
        return;
    }

    try {
        const doc = await db.collection('chats').doc(pendingChatId).get();
        if (doc.exists) {
            const realPass = doc.data().lockPass;
            
            if (inputPass === realPass) {
                // --- âœ… Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØµØ­ ---
                document.getElementById('chatLockModal').style.display = 'none';
                openChat(pendingChatId, pendingChatName, pendingChatUid, pendingChatRequest);
                pendingChatId = null;
            } else {
                // --- âŒ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø· ---
                triggerErrorEffect(inputField); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ù‡Ø²Ø§Ø²
            }
        }
    } catch (error) {
        console.error(error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚");
    }
}

// 4. Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚ÙÙ„
function closeChatLockModal() {
    document.getElementById('chatLockModal').style.display = 'none';
    pendingChatId = null;
}
// ================= Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© (The Vault) - Ø§Ù„Ù…ØµØ­Ø­ ÙˆØ§Ù„ÙƒØ§Ù…Ù„ =================

// 1. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø¶ØºØ· Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©)
async function openSecretChatsFlow() {
    toggleSidebar(); // ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¯ÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø³Ø±ÙŠ Ø£ØµÙ„Ø§Ù‹ØŸ
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.data();

    if (userData && userData.secretPass) {
        // Ù„Ø¯ÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯ -> Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        secretOperation = 'OPEN_LIST';
        openVerifySecretModal();
    } else {
        // Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯ -> Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        // ÙˆÙ†Ø­Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ù†Ù‡Ø§ ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        secretOperation = 'OPEN_LIST'; 
        document.getElementById('setupSecretModal').style.display = 'flex';
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø´Ø§Øª Ù„Ù„Ø®Ø²Ù†Ø© (ØªØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø© Ù„Ù„Ø´Ø§Øª)
async function initAddToSecret(chatId) {
    // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ø¹Ø±Ù
    if (typeof targetChatForSecret === 'undefined') {
        console.error("Variable targetChatForSecret is missing!");
        showToast("Ø®Ø·Ø£ Ø¨Ø±Ù…Ø¬ÙŠ: Ø§Ù„Ù…ØªØºÙŠØ± ØºÙŠØ± Ù…Ø¹Ø±Ù");
        return;
    }

    // 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    closeOptions(); 
    
    // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
    targetChatForSecret = chatId;
    console.log("Target Chat set to:", targetChatForSecret); // Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    
    // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø© Ø³Ø±
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();

        if (!userData || !userData.secretPass) {
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨Ø§Ø³ÙˆØ±Ø¯ -> Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
            secretOperation = 'ADD_CHAT';
            showToast("Ù‚Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ø³Ø± Ù„Ù„Ø®Ø²Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹");
            document.getElementById('setupSecretModal').style.display = 'flex';
        } else {
            // Ù„Ùˆ ÙÙŠÙ‡ Ø¨Ø§Ø³ÙˆØ±Ø¯ -> Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚
            secretOperation = 'ADD_CHAT';
            openVerifySecretModal();
        }
    } catch (error) {
        console.error("Error:", error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
    }
}

// 3. Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©)
async function saveNewSecretPass() {
    const pass = document.getElementById('createSecretPass').value;
    
    // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ø·ÙˆÙ„
    if (pass.length < 4) { 
        showToast("Ø§Ù„Ø±Ù…Ø² Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹! ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); 
        return; 
    }

    try {
        // Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙÙŠ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await db.collection('users').doc(currentUser.uid).update({
            secretPass: pass 
        });
        
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø²Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸ”’");
        document.getElementById('setupSecretModal').style.display = 'none';
        
        // ğŸ”¥ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© ğŸ”¥
        if (secretOperation === 'ADD_CHAT' && targetChatForSecret) {
            // Ù„Ùˆ ÙƒØ§Ù† Ø¬Ø§ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ¶ÙŠÙ Ø´Ø§ØªØŒ Ø¶ÙŠÙÙ‡ ÙÙˆØ±Ø§Ù‹
            performAddToSecret();
        } else {
            // Ù„Ùˆ ÙƒØ§Ù† Ø¬Ø§ÙŠ ÙŠÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø³ØŒ Ø§ÙØªØ­Ù‡Ø§
            renderSecretChats();
        }

    } catch (e) {
        console.error(e);
        // Ù„Ùˆ Ø­ØµÙ„ Ø®Ø·Ø£ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯)ØŒ Ù†Ø³ØªØ®Ø¯Ù… set Ø¨Ù€ merge
        if (e.code === 'not-found' || e.message.includes('No document')) {
             await db.collection('users').doc(currentUser.uid).set({ secretPass: pass }, { merge: true });
             showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø²Ù†Ø©");
             if (secretOperation === 'ADD_CHAT') performAddToSecret();
             else renderSecretChats();
        } else {
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
        }
    }
}

// 4. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
function openVerifySecretModal() {
    document.getElementById('verifySecretModal').style.display = 'flex';
    const input = document.getElementById('inputSecretPass');
    input.value = '';
    // ØªØ±ÙƒÙŠØ² Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆØ±Ø§Ù‹
    setTimeout(() => input.focus(), 100);
}

// 5. Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚
function closeVerifySecret() {
    document.getElementById('verifySecretModal').style.display = 'none';
    // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø¹Ù„Ù‚
    secretOperation = null;
    targetChatForSecret = null;
}

// 6. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
async function checkSecretPass() {
    const inputPass = document.getElementById('inputSecretPass').value;
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const realPass = userDoc.data().secretPass;

    if (inputPass === realPass) {
        // --- Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØµØ­ÙŠØ­ ---
        document.getElementById('verifySecretModal').style.display = 'none';
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡Ø§
        if (secretOperation === 'OPEN_LIST') {
            renderSecretChats();
        } else if (secretOperation === 'ADD_CHAT') {
            performAddToSecret();
        }
    } else {
        // --- Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø®Ø·Ø£ ---
        showToast("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ âŒ");
        if(navigator.vibrate) navigator.vibrate([100, 50, 100]); // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø®Ø·Ø£
        document.getElementById('inputSecretPass').value = '';
    }
}

// 7. ØªÙ†ÙÙŠØ° Ù†Ù‚Ù„ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø®Ø²Ù†Ø© ÙØ¹Ù„ÙŠØ§Ù‹ (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²)
async function performAddToSecret() {
    // ØªØ£Ù…ÙŠÙ†: Ù„Ùˆ Ù…ÙÙŠØ´ Ø´Ø§Øª Ù…Ø­Ø¯Ø¯ Ø§Ø®Ø±Ø¬
    if (!targetChatForSecret) return;
    
    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ø®Ø²Ù†Ø©...");
    try {
        const chatRef = db.collection('chats').doc(targetChatForSecret);
        
        await chatRef.update({
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù‚Ø§Ø¦Ù…Ø© "Ø³Ø±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø©"
            secretBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
            archivedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            pinnedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        });
        
        showToast("ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ğŸ•µï¸â€â™‚ï¸");
        
        // ØªØµÙÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        targetChatForSecret = null;
        secretOperation = null;
        
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø´Ø§Øª Ø³ÙŠØ®ØªÙÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù€ Listener Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ loadChats
    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ù‚Ù„");
    }
}

// 8. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© (Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡)
// 8. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© (Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡)
function renderSecretChats() {
    const page = document.getElementById('secretChatsPage');
    const list = document.getElementById('secretList');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© ÙˆÙ†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ø¨ÙˆØ¯ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±
    if(page.parentNode !== document.body) document.body.appendChild(page);
    page.style.display = 'flex';
    
    list.innerHTML = '<div style="text-align:center; padding:30px; color:#ff3b30;"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±...</div>';

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ø§ØªØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (allChats) Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø±ÙŠØ© ÙÙ‚Ø·
    const secretChats = allChats.filter(c => c.isSecret === true);

    list.innerHTML = '';
    
    if (secretChats.length === 0) {
        list.innerHTML = `
            <div style="text-align:center; padding:50px; color:#555;">
                <i class="fa-solid fa-user-secret" style="font-size:50px; margin-bottom:15px;"></i><br>
                Ø§Ù„Ø®Ø²Ù†Ø© ÙØ§Ø±ØºØ©.<br>Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù‡Ù†Ø§.
            </div>`;
        return;
    }

    // Ø±Ø³Ù… Ø§Ù„Ø´Ø§ØªØ§Øª
    secretChats.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chat';
        item.style.cssText = "background: linear-gradient(135deg, #1a0505 0%, #000 100%); border: 1px solid rgba(255, 59, 48, 0.2); margin-bottom: 10px;";
        
        // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… Ø£ÙƒÙ† Ø£Ù†Ø§ Ø§Ù„Ù…Ø±Ø³Ù„ ğŸ”¥
        const showBadge = (!c.amISender && c.unreadCount > 0);

        item.innerHTML = `
            <div class="avatar-container">
                <div class="avatar" style="background-image:url('${c.avatar}')"></div>
            </div>
            <div class="info">
                <div class="top-row">
                    <div class="name" style="color:#ff3b30;">${c.name} <i class="fa-solid fa-lock" style="font-size:10px; margin-right:5px;"></i></div> 
                    <div class="time" style="color:#777;">${c.time}</div>
                </div>
                <div class="bottom-row">
                    <div class="last" style="color:#aaa;">${c.lastMsg}</div>
                    ${showBadge ? `<div class="unread-badge" style="background:#ff3b30;">${c.unreadCount}</div>` : ''}
                </div>
            </div>
        `;
        
        item.onclick = () => {
            sessionStorage.setItem('scrollPos', window.scrollY);
            openChat(c.id, encodeURIComponent(c.name), c.isGroup ? 'GROUP' : c.otherUid, c.isRequest);
        };

        item.oncontextmenu = (e) => {
            e.preventDefault();
            if(navigator.vibrate) navigator.vibrate(50);
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø®Ø±Ø§Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø±ÙŠØŸ")) {
                removeFromSecret(c.id);
            }
        };

        list.appendChild(item);
    });
}

// 9. Ø¥Ø®Ø±Ø§Ø¬ Ø´Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø²Ù†Ø© (Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø³Ø±ÙŠØ©)
async function removeFromSecret(chatId) {
    try {
        await db.collection('chats').doc(chatId).update({
            secretBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        });
        
        showToast("ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø¹Ù„Ù†");
        
        // Ø¥ØºÙ„Ø§Ù‚ ØµÙØ­Ø© Ø§Ù„Ø®Ø²Ù†Ø© Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ±Ø¤ÙŠØ© Ø§Ù„Ø´Ø§Øª Ù‡Ù†Ø§Ùƒ
        document.getElementById('secretChatsPage').style.display = 'none';
        
    } catch (e) {
        console.error(e);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}

async function removeChatLock() {
    closeOptions(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    // 1. Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø§Ù„Ùƒ
    const inputPass = prompt("Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ØŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:");
    
    if (!inputPass) return; // Ù„Ùˆ Ø¯Ø§Ø³ Ø¥Ù„ØºØ§Ø¡

    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");

    try {
        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const doc = await db.collection('chats').doc(selectedChatId).get();
        if (!doc.exists) return;

        const realPass = doc.data().lockPass;

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø­Ø°Ù
        if (inputPass === realPass) {
            // Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØµØ­ -> Ø§Ø­Ø°Ù Ø­Ù‚Ù„ lockPass Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            await db.collection('chats').doc(selectedChatId).update({
                lockPass: firebase.firestore.FieldValue.delete()
            });

            showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ”“");
            // Ø§Ù„Ø´Ø§Øª Ù‡ÙŠØ±Ø¬Ø¹ ÙŠØ­Ø¯Ø« Ù†ÙØ³Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        } else {
            showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©! âŒ");
        }

    } catch (error) {
        console.error(error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„");
    }
}
// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØªØ­Ø· ÙÙŠ Ø§Ù„Ø²Ø±Ø§Ø± Ø¨Ø¯Ø§Ù„ removeChatLock Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
function openUnlockModal() {
    closeOptions(); // Ù†Ù‚ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø£ÙˆÙ„
    
    const modal = document.getElementById('unlockChatModal');
    const input = document.getElementById('unlockPassInput');
    
    modal.style.display = 'flex';
    input.value = ''; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚Ù„
    
    // ØªØ±ÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø´Ø§Ù† ÙŠÙƒØªØ¨ Ø¹Ù„Ø·ÙˆÙ„
    setTimeout(() => input.focus(), 100);
}

// 2. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeUnlockModal() {
    document.getElementById('unlockChatModal').style.display = 'none';
}

// 3. Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ù„Ù…Ø§ ÙŠØ¶ØºØ· ØªØ£ÙƒÙŠØ¯)
async function confirmUnlockAction() {
    const inputField = document.getElementById('unlockPassInput'); // Ù…Ø³ÙƒÙ†Ø§ Ø§Ù„Ø¹Ù†ØµØ±
    const inputPass = inputField.value;
    
    if (!inputPass) return showToast("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯");

    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");

    try {
        const doc = await db.collection('chats').doc(selectedChatId).get();
        if (!doc.exists) return;

        const realPass = doc.data().lockPass;

        if (inputPass === realPass) {
            // --- âœ… Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØµØ­ ---
            await db.collection('chats').doc(selectedChatId).update({
                lockPass: firebase.firestore.FieldValue.delete()
            });
            closeUnlockModal(); 
            showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ ğŸ”“");
            renderList(); 
        } else {
            // --- âŒ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø· ---
            triggerErrorEffect(inputField); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ù‡Ø²Ø§Ø²
        }

    } catch (error) {
        console.error(error);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…");
    }
}

// 4. (ØªØ­Ø³ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠ) ØªØ´ØºÙŠÙ„ Ø²Ø± Enter
document.getElementById('unlockPassInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        confirmUnlockAction();
    }
});

// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØºÙŠÙŠØ±
// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØºÙŠÙŠØ± (ØªØµÙÙŠØ± Ø§Ù„Ù€ 3 Ø­Ù‚ÙˆÙ„)
function openChangeSecretPassModal() {
    document.getElementById('changeSecretPassModal').style.display = 'flex';
    document.getElementById('oldSecretPass').value = '';
    document.getElementById('newSecretPass').value = '';
    document.getElementById('confirmSecretPass').value = ''; // ØªØµÙÙŠØ± Ø­Ù‚Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
    document.getElementById('oldSecretPass').focus();
}

// 2. ØªÙ†ÙÙŠØ° Ø§Ù„ØªØºÙŠÙŠØ± (Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚)
async function confirmChangeSecretPass() {
    const oldPass = document.getElementById('oldSecretPass').value;
    const newPass = document.getElementById('newSecretPass').value;
    const confirmPass = document.getElementById('confirmSecretPass').value; // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯

    // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† ÙƒÙ„Ù‡ Ù…Ù„ÙŠØ§Ù†
    if (!oldPass || !newPass || !confirmPass) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
    }

    // 2. ğŸ”¥ Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø²ÙŠ Ø§Ù„ØªØ£ÙƒÙŠØ¯ ğŸ”¥
    if (newPass !== confirmPass) {
        showToast("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚! âŒ");
        // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ø´Ø§Ù† ÙŠÙƒØªØ¨Ù‡Ù… ØªØ§Ù†ÙŠ Ø¨ØªØ±ÙƒÙŠØ²
        document.getElementById('newSecretPass').value = '';
        document.getElementById('confirmSecretPass').value = '';
        document.getElementById('newSecretPass').focus();
        if(navigator.vibrate) navigator.vibrate(100);
        return;
    }

    // 3. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø·ÙˆÙ„
    if (newPass.length < 4) {
        showToast("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
        return;
    }

    showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...");

    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const currentRealPass = userDoc.data().secretPass;

        // 4. Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… ØµØ­
        if (oldPass !== currentRealPass) {
            showToast("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ Ø®Ø·Ø£! âŒ");
            if(navigator.vibrate) navigator.vibrate(100);
            return;
        }

        // 5. Ø§Ù„Ø­ÙØ¸
        await db.collection('users').doc(currentUser.uid).update({
            secretPass: newPass
        });

        showToast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        document.getElementById('changeSecretPassModal').style.display = 'none';

    } catch (error) {
        console.error(error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
    }
}

function triggerErrorEffect(element) {
    // 1. ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚Ù„
    element.value = '';
    
    // 2. Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ù‡Ø²Ø©
    element.classList.add('input-error');
    
    // 3. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² (Ù„Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨ÙŠØ¯Ø¹Ù…)
    // Ø¨Ù†Ø¬Ø±Ø¨ Ù†Ù…Ø·ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ† Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø¥Ù†Ù‡ ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
    if (navigator.vibrate) {
        try { navigator.vibrate(400); } catch(e){} // Ù‡Ø²Ø© Ø·ÙˆÙŠÙ„Ø© ÙˆØ§Ø­Ø¯Ø©
        try { navigator.vibrate([100, 50, 100, 50, 100]); } catch(e){} // Ù†Ù…Ø· Ù…ØªÙ‚Ø·Ø¹
    }
    
    // 4. Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
    showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©! âŒ");
    
    // 5. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ù‡Ø²Ø© ØªØ®Ù„Øµ (Ø¹Ø´Ø§Ù† ÙŠØ±Ø¬Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ)
    setTimeout(() => {
        element.classList.remove('input-error');
        element.focus(); // Ù†Ø±Ø¬Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ø´Ø§Ù† ÙŠÙƒØªØ¨ ØªØ§Ù†ÙŠ Ø¹Ù„Ø·ÙˆÙ„
    }, 500); // Ù†Øµ Ø«Ø§Ù†ÙŠØ© (Ù†ÙØ³ Ù…Ø¯Ø© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
}

// ============================================================
// ğŸ“¡ Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Ø§Ù„Ø±Ø§Ø¯Ø§Ø±) - Ø§Ù„Ù…Ø¹Ø¯Ù„ (ÙŠØ¯Ø¹Ù… Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ ÙˆØ§Ù„Ø­Ø¸Ø±)
// ============================================================
(function initGlobalListener() {
    if (typeof firebase === 'undefined') return;

    firebase.auth().onAuthStateChanged(user => {
        if (!user) return; 

        const db = firebase.firestore();
        const currentUserId = user.uid;
        console.log("ğŸ“¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ÙŠØ¹Ù…Ù„ (Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø©)...");

        db.collectionGroup('calls')
            .where('status', '==', 'ringing')
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(async change => { // Ù„Ø§Ø­Ø¸ ÙƒÙ„Ù…Ø© async Ù‡Ù†Ø§
                    const callData = change.doc.data();
                    const callDocRef = change.doc.ref;
                    
                    // 1. Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ø±Ø¯Ø©
                    if (change.type === 'added') {
                        if (callData.callerId !== currentUserId) {
                            
                            // ==========================================
                            // ğŸ›‘ ÙØ­Øµ Ø§Ù„Ø­Ù…Ø§ÙŠØ© (Ø­Ø¸Ø± Ø£Ùˆ ØªÙ‚ÙŠÙŠØ¯) Ù‚Ø¨Ù„ Ø§Ù„Ø±Ù†ÙŠÙ† ğŸ›‘
                            // ==========================================
                            try {
                                // 1. Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ù‡Ù„ Ø§Ù„Ø´Ø®Øµ Ø¯Ù‡ Ù…Ø­Ø¸ÙˆØ± Ø£Ùˆ Ù…Ù‚ÙŠØ¯
                                const chatDocRef = callDocRef.parent.parent; // Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø´Ø§Øª Ø§Ù„Ø£Ø¨
                                const chatSnap = await chatDocRef.get();
                                
                                if (chatSnap.exists) {
                                    const chatData = chatSnap.data();

                                    // Ø£) Ù‡Ù„ Ø£Ù†Ø§ Ø­Ø§Ø¸Ø±Ù‡ØŸ (Blocked)
                                    if (chatData.blockedBy && chatData.blockedBy.includes(currentUserId)) {
                                        console.log("ğŸš« Ø§ØªØµØ§Ù„ Ù…Ø­Ø¸ÙˆØ± ØªÙ… Ø±ÙØ¶Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.");
                                        callDocRef.update({ status: 'rejected_blocked' }); // Ø±ÙØ¶ ÙÙˆØ±ÙŠ
                                        return; // Ø§Ø®Ø±Ø¬ ÙˆÙ…ØªØ±Ù†Ø´
                                    }

                                    // Ø¨) Ù‡Ù„ Ø£Ù†Ø§ Ù…Ù‚ÙŠØ¯Ù‡ØŸ (Restricted)
                                    if (chatData.restrictedBy && chatData.restrictedBy.includes(currentUserId)) {
                                        console.log("ğŸ”• Ø§ØªØµØ§Ù„ Ù…Ù‚ÙŠØ¯ (ØªÙ… Ø§Ù„ØªØ¬Ø§Ù‡Ù„).");
                                        // ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ Ø¨Ù†Ù…Ø³Ø­ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙˆÙƒØ£Ù†Ù‡Ø§ Ù„Ù… ØªÙƒÙ†ØŒ Ø£Ùˆ Ù†Ø±ÙØ¶Ù‡Ø§ Ø¨ØµÙ…Øª
                                        callDocRef.delete(); 
                                        return; // Ø§Ø®Ø±Ø¬ ÙˆÙ…ØªØ±Ù†Ø´ ÙˆÙ„Ø§ ØªØ¸Ù‡Ø± Ø£ÙŠ Ø­Ø§Ø¬Ø©
                                    }
                                }
                            } catch (error) {
                                console.error("Error checking restrictions:", error);
                            }
                            // ==========================================

                            // Ù„Ùˆ Ø¹Ø¯Ù‰ Ù…Ù† Ø§Ù„ÙØ­Øµ (Ù…Ø´ Ù…Ø­Ø¸ÙˆØ± ÙˆÙ…Ø´ Ù…Ù‚ÙŠØ¯)ØŒ ÙƒÙ…Ù„ Ø¹Ø§Ø¯ÙŠ
                            targetChatId = callDocRef.parent.parent.id;
                            globalCallDocPath = callDocRef.path;
                            isDismissed = false; 

                            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
                            db.collection('users').doc(callData.callerId).get()
                            .then(userDoc => {
                                let realName = "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶";
                                let realAvatar = "";
                                if (userDoc.exists) {
                                    const u = userDoc.data();
                                    realName = u.name || "Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø¨Ø¶";
                                    realAvatar = u.profilePic || "";
                                }
                                callData.callerName = realName;
                                callData.callerAvatar = realAvatar;
                                showHeadsUpNotification(callData);
                            })
                            .catch(() => showHeadsUpNotification(callData));
                        }
                    }

                    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (ØªÙ… Ø§Ù„Ø±Ø¯ Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡)
                    if (change.type === 'modified') {
                        if (globalCallDocPath === change.doc.ref.path) {
                            if (!callData || callData.status !== 'ringing') {
                                const isMissed = (callData.status !== 'rejected' && callData.status !== 'picked' && callData.status !== 'answered');
                                stopEverything(isMissed, callData.callerName); 
                            }
                        }
                    }

                    // 3. Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
                    if (change.type === 'removed') {
                        if (globalCallDocPath === change.doc.ref.path) {
                            stopEverything(true, callData.callerName || "Ù…Ø³ØªØ®Ø¯Ù…");
                        }
                    }
                });
            });
    });
})();


// 1. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯
function closeUnrestrictModal() {
    document.getElementById('unrestrictConfirmationModal').style.display = 'none';
    window.targetRestrictId = null;
}

// 2. Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ (Ù„Ù…Ø§ ÙŠØ¯ÙˆØ³ Ù†Ø¹Ù…)
function executeUnrestrictAction() {
    if (!window.targetRestrictId) return;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('unrestrictConfirmationModal').style.display = 'none';
    
    // ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± (false = Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯)
    toggleRestrictStatus(window.targetRestrictId, false);
}

// 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeGroupModal() {
    document.getElementById('createGroupModal').style.display = 'none';
}

// 2. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠ
async function executeCreateGroup() {
    const input = document.getElementById('newGroupNameInput');
    const groupName = input.value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
    if (!groupName) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© âš ï¸");
        triggerErrorEffect(input); // Ø§Ù„Ù‡Ø²Ø© ÙˆØ§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
        return;
    }

    closeGroupModal(); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©... ğŸ”¨");

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø£Ù†Ø§ + Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ ÙƒÙ†Øª ÙØ§ØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨ØªØ§Ø¹ØªÙ‡)
    const participants = [currentUser.uid];
    if (selectedChatData && selectedChatData.otherUid) {
        participants.push(selectedChatData.otherUid);
    }
    
    try {
        const groupRef = await db.collection('chats').add({
            name: groupName, 
            users: participants, 
            type: 'GROUP', 
            createdBy: currentUser.uid,
            lastMessage: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© âœ¨", 
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(), 
            admins: [currentUser.uid],
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            archivedBy: [],
            deletedBy: [],
            pinnedBy: [],
            mutedBy: [],
            secretBy: [],
            restrictedBy: [],
            seen: true,
            unreadCount: 0
        });
        
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
        
        // ÙØªØ­ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ø§Ù‹
        openChat(groupRef.id, encodeURIComponent(groupName), 'GROUP', false);
        
    } catch (error) { 
        console.error(error); 
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡"); 
    }
}

// 3. (Ø¥Ø¶Ø§ÙØ©) ØªØ´ØºÙŠÙ„ Ø²Ø± Enter ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
document.getElementById('newGroupNameInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        executeCreateGroup();
    }
});

// ==========================================
// ğŸ‘¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§Ù„Ù…ØµØ­Ø­)
// ==========================================

// 1. Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø£Ù…Ø§Ù†
function forceCloseSidebar() {
    const sb = document.getElementById('sidebar');
    const ov = document.getElementById('sidebarOverlay');
    if (sb) sb.classList.remove('active');
    if (ov) ov.classList.remove('active');
}

// 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
let selectedGroupMembers = new Set(); 

function openGroupCreatorPro() {
    vibrate();
    
    // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ‡Ù†ÙŠØ¬: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¢Ù…Ù†Ø© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚
    forceCloseSidebar(); 
    
    const modal = document.getElementById('createGroupProModal');
    const list = document.getElementById('friendsSelectionList');
    const countSpan = document.getElementById('selectedCount');
    const nameInput = document.getElementById('groupNamePro');

    if (!modal) {
        console.error("Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ HTML");
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    modal.style.display = 'flex';

    // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#777;"><i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡...</div>';
    selectedGroupMembers.clear();
    if(countSpan) countSpan.innerText = '0';
    if(nameInput) nameInput.value = '';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ØµØ¯Ù‚Ø§Ø¡
    if (friendUids.size === 0) {
        list.innerHTML = `<div style="text-align:center; padding:40px; color:#555;">
            <i class="fa-solid fa-user-group" style="font-size:30px; margin-bottom:10px;"></i><br>
            Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ù…
        </div>`;
        return;
    }

    // Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    setTimeout(() => { // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙ‡Ù†ÙŠØ¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        list.innerHTML = '';
        friendUids.forEach(uid => {
            let u = usersCache[uid];
            // Ù„Ùˆ Ù…Ø´ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ØŒ Ø­Ø§ÙˆÙ„ ØªØ¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            if (!u) u = { uid: uid, name: "Ù…Ø³ØªØ®Ø¯Ù…", avatar: defaultAvatar };

            const item = document.createElement('div');
            item.className = 'select-friend-item';
            item.id = `sf-${uid}`;
            item.onclick = () => toggleMemberSelection(uid);

            item.innerHTML = `
                <div class="sf-avatar" style="background-image: url('${u.avatar || defaultAvatar}')"></div>
                <div class="sf-info">
                    <div class="sf-name">${u.name}</div>
                    <div class="sf-status" style="color:${u.isOnline ? '#4ade80' : '#888'}">${u.isOnline ? 'Ù†Ø´Ø· Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØµÙ„'}</div>
                </div>
                <div class="sf-check"></div>
            `;
            list.appendChild(item);
        });
    }, 50);
}

// 3. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
function toggleMemberSelection(uid) {
    vibrate();
    const el = document.getElementById(`sf-${uid}`);
    if (!el) return;

    if (selectedGroupMembers.has(uid)) {
        selectedGroupMembers.delete(uid);
        el.classList.remove('selected');
    } else {
        selectedGroupMembers.add(uid);
        el.classList.add('selected');
    }
    document.getElementById('selectedCount').innerText = selectedGroupMembers.size;
}

// 4. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeGroupProModal() {
    const modal = document.getElementById('createGroupProModal');
    if (modal) modal.style.display = 'none';
}

// 5. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡)
async function finalizeCreateGroup() {
    const nameInput = document.getElementById('groupNamePro');
    const groupName = nameInput.value.trim();

    if (groupName.length < 2) {
        showToast("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹ âš ï¸");
        nameInput.focus();
        // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø²Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        nameInput.style.borderColor = "red";
        setTimeout(() => nameInput.style.borderColor = "#8b5cf6", 500);
        return;
    }

    if (selectedGroupMembers.size === 0) {
        showToast("Ø§Ø®ØªØ± Ø¹Ø¶ÙˆØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ğŸ‘¥");
        return;
    }

    // Ø¥ØºÙ„Ø§Ù‚ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    closeGroupProModal();
    showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©... ğŸš€");

    try {
        const members = [currentUser.uid, ...Array.from(selectedGroupMembers)];

        const groupRef = await db.collection('chats').add({
            name: groupName,
            type: 'GROUP',
            users: members,
            admins: [currentUser.uid],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastMessage: `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${groupName}" âœ¨`,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            lastSender: currentUser.uid,
            seen: true,
            unreadCount: 0,
            // Ù…ØµÙÙˆÙØ§Øª ÙØ§Ø±ØºØ© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            archivedBy: [], deletedBy: [], pinnedBy: [], mutedBy: [], 
            secretBy: [], restrictedBy: [], blockedBy: []
        });

        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        await groupRef.collection('messages').add({
            text: `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø© ${currentUser.displayName || "Ø§Ù„Ù…Ù†Ø´Ø¦"}.`,
            type: 'system',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            seen: false
        });

        showToast("ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
        
        // ÙØªØ­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙˆØ±Ø§Ù‹
        openChat(groupRef.id, encodeURIComponent(groupName), 'GROUP', false);

    } catch (error) {
        console.error(error);
        showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
    }
}
// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ†
function openRestrictedList() {
    vibrate();
    forceCloseSidebar(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø§ÙŠØ¯ Ø¨Ø§Ø±
    const modal = document.getElementById('restrictedModal');
    const list = document.getElementById('restrictedListContent');
    
    modal.style.display = 'flex';
    list.innerHTML = '<div style="text-align: center; color: #555; padding: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù† Ø£ÙŠ Ø­Ø¯ Ù…Ø­Ø·ÙˆØ· ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ restricted
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§ÙØªØ±Ø¶Ù†Ø§ Ø£Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙŠÙˆØ¯ Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    db.collection("users").doc(currentUserId).get().then((doc) => {
        const userData = doc.data();
        const restrictedIds = userData.restrictedByMe || [];

        if (restrictedIds.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ù‚ÙŠØ¯ÙˆÙ†</div>';
            return;
        }

        list.innerHTML = '';
        restrictedIds.forEach(uid => {
            const u = usersCache[uid] || { name: "Ù…Ø³ØªØ®Ø¯Ù…", avatar: defaultAvatar };
            list.innerHTML += `
                <div class="profile-item" style="border-bottom: 1px solid #222; margin-bottom: 5px;">
                    <div class="p-item-icon" style="background-image:url('${u.avatar || defaultAvatar}');"></div>
                    <div class="p-item-text">
                        <span style="color:#fff;">${u.name}</span>
                        <button onclick="unrestrictUser('${uid}')" style="background:none; border:1px solid #ef4444; color:#ef4444; font-size:10px; padding:2px 8px; border-radius:5px; cursor:pointer; margin-top:5px;">
                            Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯
                        </button>
                    </div>
                </div>
            `;
        });
    });
}

function closeRestrictedModal() {
    document.getElementById('restrictedModal').style.display = 'none';
}

// Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„Ù‚ÙŠØ¯
async function unrestrictUser(targetUid) {
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;
    
    try {
        await db.collection("users").doc(currentUserId).update({
            restrictedByMe: firebase.firestore.FieldValue.arrayRemove(targetUid)
        });
        showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­");
        openRestrictedList(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    } catch (error) {
        console.error(error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙÙƒ Ø§Ù„Ù‚ÙŠØ¯");
    }
}

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…ØµÙ„Ø­Ø© (Ø¨Ø¯ÙˆÙ† ØªÙ‡Ù†ÙŠØ¬)
async function openRestrictedPage() {
    vibrate();
    forceCloseSidebar(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙˆØ±Ø§Ù‹
    
    const page = document.getElementById('restrictedPage');
    const listContainer = document.getElementById('restrictedListFull');
    
    if (!page || !listContainer) return;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø©
    page.style.display = 'flex';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„
    listContainer.innerHTML = `
        <div style="text-align:center; padding:50px; color:var(--accent-color);">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px;"></i>
            <p style="margin-top:10px; font-size:14px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</p>
        </div>`;

    try {
        // Ø¬Ù„Ø¨ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        const userDoc = await db.collection("users").doc(currentUser.uid).get();
        
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ù‡Ù„ Ù‡Ùˆ restrictedByMe Ø£Ù… restrictedByØŸ)
        // Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø³Ù†Ø¹ØªÙ…Ø¯ restrictedByMe
        const restrictedIds = userDoc.data()?.restrictedByMe || [];

        if (restrictedIds.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align:center; padding:80px 20px; color:#64748b;">
                    <i class="fa-solid fa-user-shield" style="font-size:50px; opacity:0.2; margin-bottom:15px;"></i>
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù‚ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>`;
            return;
        }

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù€ HTML Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© (Ø£Ø³Ø±Ø¹ Ù„Ù„Ø£Ø¯Ø§Ø¡)
        let finalHtml = '';

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        for (const uid of restrictedIds) {
            let u = usersCache[uid];
            if (!u) {
                try {
                    const uDoc = await db.collection('users').doc(uid).get();
                    if (uDoc.exists) {
                        const d = uDoc.data();
                        u = {
                            name: d.name || "Ù…Ø³ØªØ®Ø¯Ù…",
                            avatar: d.profilePic || d.avatarUrl || defaultAvatar
                        };
                    }
                } catch(e) { console.log("User fetch error", e); }
            }

            if (u) {
                finalHtml += `
                    <div class="profile-item" style="justify-content: space-between; margin-bottom:10px; border: 1px solid rgba(255,255,255,0.05); display:flex; align-items:center; padding:15px; border-radius:16px;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div style="background-image:url('${u.avatar || defaultAvatar}'); background-size:cover; border-radius:12px; width:45px; height:45px; background-position:center;"></div>
                            <div class="p-item-text">
                                <span style="color:#fff; font-size:15px; font-weight:bold; display:block;">${u.name}</span>
                                <small style="color:#64748b;">Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙŠØ¯</small>
                            </div>
                        </div>
                        <button onclick="unrestrictFromPage('${uid}')" style="background: rgba(255, 59, 48, 0.1); border: 1px solid #ff3b30; color: #ff3b30; padding: 6px 12px; border-radius: 10px; cursor: pointer; font-size: 11px; font-weight: bold; font-family:'Cairo';">
                            Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯
                        </button>
                    </div>`;
            }
        }
        
        listContainer.innerHTML = finalHtml;

    } catch (error) {
        console.error("Restricted Page Error:", error);
        listContainer.innerHTML = `<p style="text-align:center; color:red; padding:20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
    }
}

// 2. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
function closeRestrictedPage() {
    const page = document.getElementById('restrictedPage');
    if(page) page.style.display = 'none';
}

// 3. Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„Ù‚ÙŠØ¯ (Ø§Ù„Ù…Ø­Ø¯Ø«Ø©)
async function unrestrictFromPage(targetUid) {
    vibrate();
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;

    try {
        await db.collection("users").doc(currentUser.uid).update({
            restrictedByMe: firebase.firestore.FieldValue.arrayRemove(targetUid)
        });
        
        showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ âœ…");
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
        openRestrictedPage(); 
    } catch (error) {
        console.error(error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
    }
}

    </script>
    

    
    <div id="profilePreviewModal" class="profile-preview-overlay" onclick="closeProfilePreview()">
        <div class="profile-preview-card" onclick="event.stopPropagation()">
            <div class="pp-image-container" onclick="openFullProfileImage()">
                <div class="protection-layer"></div>
                <img id="ppPreviewImg" src="" alt="Profile">
                <div class="pp-name-overlay" id="ppPreviewName">User Name</div>
            </div>
            <div class="pp-actions">
                <div onclick="navigateToChatFromPP()"><i class="fa-solid fa-message"></i></div>
                <div onclick="callUserFromPP()"><i class="fa-solid fa-phone"></i></div>
                <div onclick="infoUserFromPP()"><i class="fa-solid fa-circle-info"></i></div>
            </div>
        </div>
    </div>

    <div id="fullImageModal" class="full-image-overlay" onclick="closeFullImage()">
        <div id="screenShotWarning" style="display:none; color:red; position:absolute; top:50%;">Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø´Ø§Ø´Ø©!</div>
        <img id="fullPPImg" src="" class="protected-img">
    </div>


    <div class="bottom-sheet-overlay" id="newChatModal" onclick="closeNewChatModal()">
        <div class="bottom-sheet" onclick="event.stopPropagation()" style="max-height: 80vh; display: flex; flex-direction: column;">
            <div class="sheet-handle"></div>
            <div style="text-align: center; margin-bottom: 15px;">
                <h3 style="color: #fff;">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            </div>
            <div style="padding: 0 10px 15px 10px;">
                <div style="position: relative; width: 100%;">
                    <input type="text" id="newChatSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…..." 
                        oninput="filterNewChatList(this.value)" 
                        style="width: 100%; padding: 12px 40px 12px 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #fff; font-family: 'Cairo'; outline: none;">
                    <i class="fa-solid fa-magnifying-glass" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #777;"></i>
                </div>
            </div>
            <div id="newChatListContainer" style="overflow-y: auto; flex: 1; padding: 0 5px;"></div>
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="storyViewersModal" onclick="closeStoryViewers()">
        <div class="bottom-sheet" onclick="event.stopPropagation()" style="height: 60vh;">
            <div class="sheet-handle"></div>
            <h3 style="text-align:center; color:#fff; margin-bottom:15px;">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª <span id="viewersTotalCount" style="font-size:14px; color:#777;">(0)</span></h3>
            <div id="viewersListContainer" style="overflow-y:auto; height:calc(100% - 60px);"></div>
        </div>
    </div>
<div id="accountSwitcherModal" class="custom-modal">
    <div class="modal-box">
        <h3 style="color:#fff; margin-bottom:15px;">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
        
        <div id="accountList" class="account-list"></div>

        <div id="addAccBtnContainer" class="modal-actions">
            <button onclick="showAddAccountForm()" class="btn-purple">
                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            </button>
            <button onclick="document.getElementById('accountSwitcherModal').style.display='none'" class="btn-dark">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>

        <div id="addAccountForm" style="display:none; width:100%;">
            <div class="input-group">
                <i class="fa-solid fa-envelope input-icon"></i>
                <input type="email" id="newAccEmail" class="pro-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            </div>
            <div class="input-group">
                <i class="fa-solid fa-lock input-icon"></i>
                <input type="password" id="newAccPass" class="pro-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            
            <div class="modal-actions">
                <button onclick="addNewAccountAction()" class="btn-purple">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø­ÙØ¸</button>
                <button onclick="hideAddAccountForm()" class="btn-dark">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
</div>



<div id="searchResultsModal" class="search-results-popup">
    <div id="searchResultsList"></div>
</div>
<div id="deleteConfirmationModal" class="custom-modal" style="z-index: 50000;">
    <div class="modal-box" style="text-align: right;">
        <h3 style="color:#fff; margin-bottom:10px;">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
        <p style="color:#aaa; font-size:14px; margin-bottom:20px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ</p>
        
        <label class="delete-checkbox-container">
            <input type="checkbox" id="deleteForEveryoneCheck">
            <span class="checkmark"></span>
            <span style="color:#fff; font-size:14px;">Ø§Ù„Ø­Ø°Ù Ù…Ù† ÙƒÙ„Ø§ Ø§Ù„Ø·Ø±ÙÙŠÙ†</span>
        </label>

        <div class="modal-actions" style="flex-direction: row; gap: 10px; margin-top: 20px;">
            <button onclick="closeDeleteModal()" class="btn-dark" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="confirmDeleteChat()" class="btn-yes" style="flex:1; background:#ef4444;">Ø­Ø°Ù</button>
        </div>
    </div>
</div>

<script src="global-notifications.js"></script>
<script src="global-call.js"></script>
<script>
(function() {
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª (ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©)
    // Ù„Ùˆ Ù…ÙÙŠØ´ Ù‚ÙŠÙ…Ø© Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø¨Ù†Ø¹ØªØ¨Ø±Ù‡ Ø´ØºØ§Ù„ (true)
    window.appSoundsEnabled = localStorage.getItem('nabd_app_sounds') !== 'false';

    // 2. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ØµÙˆØ§Øª
    const clickSound = new Audio('./sounds/click.mp3');
    clickSound.volume = 0.6; 

    // 3. ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    function updateSoundUI() {
        const icon = document.getElementById('soundIcon');
        const toggle = document.getElementById('soundToggle');
        
        if(icon && toggle) {
            if (window.appSoundsEnabled) {
                icon.className = "fa-solid fa-volume-high";
                toggle.classList.add('active');
            } else {
                icon.className = "fa-solid fa-volume-xmark";
                toggle.classList.remove('active');
            }
        }
    }
    // ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
    document.addEventListener('DOMContentLoaded', updateSoundUI);

    // 4. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (ØªØ³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±)
    window.toggleAppSounds = function() {
        // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø©
        window.appSoundsEnabled = !window.appSoundsEnabled;
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        localStorage.setItem('nabd_app_sounds', window.appSoundsEnabled);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒÙ„
        updateSoundUI();
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ· Ù„Ùˆ ÙØ¹Ù„ØªÙ‡
        if(window.appSoundsEnabled) {
            clickSound.currentTime = 0;
            clickSound.play().catch(()=>{});
        }
    };

    // 5. Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ù‚Ø± (Global Click Listener)
    const clickableSelectors = [
        'button', 'a', '.icon-btn', '.nav-item', '.sidebar-item', 
        '.story-card', '.chat', '.floating-fab', '.sheet-action', 
        '.action-btn', '.mic-btn', '.send-btn-inside', 
        '.np-input-trigger', '.search-result-item', '.quick-user-item', 
        '[onclick]'
    ];

    document.addEventListener('click', function(e) {
        // ğŸ”¥ Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø£Ù‡Ù…: Ù„Ùˆ Ø§Ù„ØµÙˆØª Ù…Ù‚ÙÙˆÙ„ØŒ Ø§Ø®Ø±Ø¬ ÙÙˆØ±Ø§Ù‹ ÙˆÙ…Ø§ ØªØ´ØºÙ„Ø´ Ø­Ø§Ø¬Ø©
        if (!window.appSoundsEnabled) return;

        // Ø§Ø³ØªØ«Ù†Ø§Ø¡: Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØª Ù†ÙØ³Ù‡ (Ø¹Ø´Ø§Ù† Ù…ÙŠØ¹Ù„Ù‚Ø´ ØµÙˆØª ÙˆÙ‡Ùˆ Ø¨ÙŠÙ‚ÙÙ„)
        if (e.target.closest('[onclick="toggleAppSounds()"]')) return;

        const target = e.target.closest(clickableSelectors.join(','));
        if (target) {
            clickSound.currentTime = 0;
            clickSound.play().catch(() => {});
        }
    }, true);

    // 6. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ù„Ùˆ Ø¨ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ Ø­ØªØ© ØªØ§Ù†ÙŠØ©)
    const originalPlaySound = window.playSound;
    window.playSound = function(name) {
        if (!window.appSoundsEnabled) return; // Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ùˆ Ù…ÙƒØªÙˆÙ…
        
        // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© playSound Ù‚Ø¯ÙŠÙ…Ø©ØŒ Ø§Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ØŒ Ù„Ùˆ Ù…ÙÙŠØ´ Ø´ØºÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡
        if (typeof originalPlaySound === 'function') {
            originalPlaySound(name);
        }
    };

})();

// Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø¤Ù‚ØªØ§Ù‹)
function hideActiveUser() {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    closeActiveUserOptions();
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    showToast("ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ ğŸ‘ï¸ğŸš«");
    
    // 3. (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„Ø¥Ø®ÙØ§Ø¦Ù‡ ÙØ¹Ù„ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù€ DOM
    // Ù…Ø«Ù„Ø§Ù‹ Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙÙŠ LocalStorage
    if (selectedActiveUser) {
        // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ø¥Ø®ÙØ§Ø¡ Ø¨ØµØ±ÙŠ Ù…Ø¤Ù‚Øª Ø­ØªÙ‰ ÙŠØªÙ… Ø¹Ù…Ù„ Refresh
        const userItem = document.querySelectorAll('.quick-user-item');
        userItem.forEach(item => {
            if(item.innerText.includes(selectedActiveUser.name.split(' ')[0])) {
                item.style.display = 'none';
            }
        });
    }
}

// 1. Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeRestrictModal() {
    document.getElementById('restrictConfirmationModal').style.display = 'none';
    window.targetRestrictId = null;
}

// 2. Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ (Ù„Ù…Ø§ ÙŠØ¯ÙˆØ³ ØªØ£ÙƒÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©)
function executeRestrictAction() {
    if (!window.targetRestrictId) return;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('restrictConfirmationModal').style.display = 'none';
    
    // ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ‚ÙŠÙŠØ¯
    toggleRestrictStatus(window.targetRestrictId, true);
}

// 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² (ØªÙ‚ÙŠÙŠØ¯ Ø£Ùˆ ÙÙƒ)
// 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² (ØªÙ‚ÙŠÙŠØ¯ Ø£Ùˆ ÙÙƒ) - (Ù†Ø³Ø®Ø© Ù…ØµØ­Ø­Ø©)
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¯ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ ÙƒÙˆØ¯Ùƒ
async function toggleRestrictStatus(chatId, shouldRestrict) {
    showToast(shouldRestrict ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯..." : "Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯...");
    
    try {
        const chatRef = db.collection('chats').doc(chatId);
        
        // 1. Ù„Ø§Ø²Ù… Ø§Ù„Ø£ÙˆÙ„ Ù†Ø¹Ø±Ù Ù…ÙŠÙ† Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ø§Ø­Ù†Ø§ Ø¨Ù†Ù‚ÙŠØ¯Ù‡ Ø¯Ù‡ØŸ
        const chatDoc = await chatRef.get();
        if (!chatDoc.exists) return;

        const chatData = chatDoc.data();
        
        // Ø¨Ù†Ø·Ù„Ø¹ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø¨ØªØ§Ø¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø´Ø§Øª
        // (Ù„Ùˆ Ø§Ù„Ø´Ø§Øª ÙØ±Ø¯ÙŠØŒ Ø¨Ù†Ø´ÙˆÙ Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© ØºÙŠØ±ÙŠ Ø£Ù†Ø§)
        let targetUid = null;
        if (chatData.users && !chatData.isGroup) {
            targetUid = chatData.users.find(u => u !== currentUser.uid);
        }

        // 2. (Ø§Ù„Ø®Ø·ÙˆØ© Ø¯ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ®ØªÙÙŠ Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆÙŠØªÙ‚ÙÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)
        // Ø¨Ù†Ø¹Ø¯Ù„ Ø§Ù„Ø´Ø§Øª ÙˆÙ†Ù‚ÙˆÙ„ Ø¥Ù†Ù‡ Ù…Ù‚ÙŠØ¯
        const opChat = shouldRestrict 
            ? firebase.firestore.FieldValue.arrayUnion(currentUser.uid) 
            : firebase.firestore.FieldValue.arrayRemove(currentUser.uid);
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø´Ø§Øª
        await chatRef.update({ restrictedBy: opChat });

        // 3. (Ø§Ù„Ø®Ø·ÙˆØ© Ø¯ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ†) ğŸ”¥ Ø¯ÙŠ Ø§Ù„Ù„ÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ©
        // Ø¨Ù†Ø±ÙˆØ­ Ù„Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆÙ†Ø¶ÙŠÙ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø¨ØªØ§Ø¹Ù‡ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ø³Ù…Ù‡Ø§ restrictedByMe
        if (targetUid) {
            const userRef = db.collection('users').doc(currentUser.uid);
            const opUser = shouldRestrict
                ? firebase.firestore.FieldValue.arrayUnion(targetUid)
                : firebase.firestore.FieldValue.arrayRemove(targetUid);
            
            // Ø¨Ù†Ø³ØªØ®Ø¯Ù… merge Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙŠÙƒØ±ÙŠØªÙ‡
            await userRef.set({ restrictedByMe: opUser }, { merge: true });
        }
        
        showToast(shouldRestrict ? "ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ† ğŸ”’" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ âœ…");
        
        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙˆØ±Ø§Ù‹ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹ÙŠÙ†Ùƒ
        if(typeof renderList === 'function') renderList(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù‡ÙŠØ®ØªÙÙŠ)
        
        // Ù„Ùˆ ÙØ§ØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ†ØŒ Ø­Ø¯Ø«Ù‡Ø§ Ù‡ÙŠ ÙƒÙ…Ø§Ù† (Ù‡ÙŠØ¸Ù‡Ø±)
        const restrictedPage = document.getElementById('restrictedPage');
        if (restrictedPage && restrictedPage.style.display === 'flex') {
            openRestrictedPage();
        }
        
    } catch (error) {
        console.error("Restrict Error:", error);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
    }
}



</script>
<div id="storyArchiveModal" class="custom-modal" style="padding-top: 50px;">
    <div class="modal-box" style="width: 95%; max-width: 500px; height: 80vh; display: flex; flex-direction: column; background: #000; border: 1px solid #333;">
        
        <div style="padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: #fff; margin: 0;">ğŸ—‚ï¸ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù‚ØµØµ</h3>
            <i class="fa-solid fa-xmark" onclick="closeStoryArchive()" style="color: #fff; font-size: 20px; cursor: pointer;"></i>
        </div>

        <div id="archiveGrid" style="flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
            </div>

    </div>
</div>
<div id="archiveFullViewer" class="archive-viewer-overlay" onclick="closeArchiveViewer()" style="display: none;">
    <div class="archive-close-btn">
        <i class="fa-solid fa-xmark"></i>
    </div>
    <div id="archiveViewerContainer" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; pointer-events: none;">
    </div>
</div>


</div> 
    <div id="pinnedMsgBar" style="display:none; position:absolute; top:75px; left:10px; right:10px; background:rgba(30, 41, 59, 0.95); padding:8px; border-radius:10px; border-left:3px solid #f59e0b; z-index:90; cursor:pointer;" onclick="jumpToPinned()">
        <div style="font-size:11px; color:#f59e0b; font-weight:bold;">Ø±Ø³Ø§Ù„Ø© Ù…Ø«Ø¨ØªØ© <i class="fa-solid fa-thumbtack"></i></div>
        <div id="pinnedMsgText" style="font-size:12px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
    </div>

    <div class="chat-body" id="chatContainer">
<div id="chatLockModal" class="custom-modal" style="z-index: 60000;">
    <div class="modal-box" style="text-align: center;">
        <h3 style="color:#fff; margin-bottom:15px;">ğŸ”’ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù‚ÙÙ„Ø©</h3>
        <p style="color:#aaa; font-size:14px; margin-bottom:20px;">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù…ÙŠØ© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.</p>
        
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="password" id="chatPassInput" class="pro-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø±Ù‚Ø§Ù…)" maxlength="6" style="text-align: center; letter-spacing: 5px; font-size: 18px;">
        </div>

        <div class="modal-actions">
            <button onclick="verifyChatPassword()" class="btn-purple">ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
            <button onclick="closeChatLockModal()" class="btn-dark">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="setChatPassModal" class="custom-modal" style="z-index: 60000;">
    <div class="modal-box" style="text-align: center;">
        <h3 style="color:#fff; margin-bottom:15px;">ğŸ” ØªØ¹ÙŠÙŠÙ† Ù‚ÙÙ„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
        <p style="color:#aaa; font-size:14px; margin-bottom:20px;">Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù….</p>
        
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="password" id="newChatPassInput" class="pro-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" maxlength="6" style="text-align: center; letter-spacing: 5px; font-size: 18px;">
        </div>

        <div class="modal-actions">
            <button onclick="saveChatPassword()" class="btn-purple">Ø­ÙØ¸ Ø§Ù„Ù‚ÙÙ„</button>
            <button onclick="document.getElementById('setChatPassModal').style.display='none'" class="btn-dark">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="unlockChatModal" class="custom-modal" style="z-index: 70000;">
    <div class="modal-box" style="text-align: center; border: 1px solid rgba(255, 215, 0, 0.2); box-shadow: 0 0 30px rgba(0,0,0,0.8);">
        
        <div style="width:70px; height:70px; background:linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0,0,0,0.3)); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255, 215, 0, 0.3);">
            <i class="fa-solid fa-unlock-keyhole" style="font-size:30px; color:#FFD700;"></i>
        </div>

        <h3 style="color:#fff; margin-bottom:10px;">Ø¥Ù„ØºØ§Ø¡ Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
        <p style="color:#aaa; font-size:13px; margin-bottom:25px;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©.</p>
        
        <div class="input-group" style="margin-bottom: 25px;">
            <input type="password" id="unlockPassInput" class="pro-input" 
                   placeholder="â— â— â— â— â— â—" maxlength="6" 
                   style="text-align: center; letter-spacing: 8px; font-size: 20px; border-color: rgba(255, 215, 0, 0.3); font-weight:bold; color:#FFD700;">
        </div>

        <div class="modal-actions">
            <button onclick="confirmUnlockAction()" class="btn-purple" style="background:linear-gradient(135deg, #FFD700, #d4af37); color:#000;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="closeUnlockModal()" class="btn-dark" style="margin-top:0;">ØªØ±Ø§Ø¬Ø¹</button>
        </div>
    </div>
</div>

<div id="setupSecretModal" class="custom-modal" style="z-index: 70000;">
    <div class="modal-box" style="text-align: center; border: 1px solid #ff3b30;">
        <div style="width:60px; height:60px; background:rgba(255, 59, 48, 0.1); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-user-secret" style="font-size:30px; color:#ff3b30;"></i>
        </div>
        <h3 style="color:#fff; margin-bottom:10px;">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ø³Ø±ÙŠØ©</h3>
        <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø±Ù…Ø² Ù…Ø±ÙˆØ± Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©.</p>
        
        <input type="password" id="createSecretPass" class="pro-input" placeholder="Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ (4-6 Ø£Ø±Ù‚Ø§Ù…)" maxlength="6" style="text-align:center; letter-spacing:5px; margin-bottom:15px;">
        
        <button onclick="saveNewSecretPass()" class="btn-purple" style="background:#ff3b30;">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡</button>
        <button onclick="document.getElementById('setupSecretModal').style.display='none'" class="btn-dark" style="margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="verifySecretModal" class="custom-modal" style="z-index: 70000;">
    <div class="modal-box" style="text-align: center;">
        <h3 style="color:#fff; margin-bottom:15px;">ğŸ”’ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø¸ÙˆØ±Ø©</h3>
        <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
        
        <input type="password" id="inputSecretPass" class="pro-input" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" maxlength="6" style="text-align:center; letter-spacing:5px; margin-bottom:15px;">
        
        <button onclick="checkSecretPass()" class="btn-purple" style="background:linear-gradient(135deg, #ff3b30, #991b1b);">ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø©</button>
        <button onclick="closeVerifySecret()" class="btn-dark" style="margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="secretChatsPage" class="profile-page" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; background:#000; z-index: 60000;">
    <div class="pp-header" style="background:rgba(20,0,0,0.95); border-bottom:1px solid rgba(255,59,48,0.2); display: flex; align-items: center; justify-content: space-between; padding: 15px;">
        
        <div class="icon-btn" onclick="document.getElementById('secretChatsPage').style.display='none'" style="background:rgba(255,255,255,0.1); color:#fff;">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        
        <h3 style="color:#ff3b30; margin:0;"><i class="fa-solid fa-user-secret"></i> Ø§Ù„Ø®Ø²Ù†Ø©</h3>
        
        <div class="icon-btn" onclick="openChangeSecretPassModal()" style="background:rgba(255, 59, 48, 0.15); color:#ff3b30; border:1px solid rgba(255, 59, 48, 0.3);">
            <i class="fa-solid fa-key"></i>
        </div>
    </div>
    
    <div id="secretList" style="padding:10px; overflow-y:auto; flex:1;"></div>
</div>
<div id="changeSecretPassModal" class="custom-modal" style="z-index: 75000;">
    <div class="modal-box" style="text-align: center; border: 1px solid #ff3b30;">
        <h3 style="color:#fff; margin-bottom:15px;">ØªØºÙŠÙŠØ± Ø±Ù…Ø² Ø§Ù„Ø®Ø²Ù†Ø© ğŸ”</h3>
        
        <div class="input-group" style="margin-bottom: 15px;">
            <input type="password" id="oldSecretPass" class="pro-input" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ" maxlength="6" style="text-align:center; letter-spacing:3px;">
        </div>

        <div class="input-group" style="margin-bottom: 10px;">
            <input type="password" id="newSecretPass" class="pro-input" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯" maxlength="6" style="text-align:center; letter-spacing:3px; border-color:#ff3b30;">
        </div>

        <div class="input-group" style="margin-bottom: 20px;">
            <input type="password" id="confirmSecretPass" class="pro-input" placeholder="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯" maxlength="6" style="text-align:center; letter-spacing:3px; border-color:#ff3b30;">
        </div>

        <div class="modal-actions">
            <button onclick="confirmChangeSecretPass()" class="btn-purple" style="background:#ff3b30;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±</button>
            <button onclick="document.getElementById('changeSecretPassModal').style.display='none'" class="btn-dark">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>
<div class="bottom-sheet-overlay" id="activeUserOptionsModal" onclick="closeActiveUserOptions()">
    <div class="bottom-sheet" onclick="event.stopPropagation()">
        <div class="sheet-handle"></div>
        
        <div style="text-align:center; margin-bottom:20px;">
            <div id="activeUserSheetAvatar" style="width:70px; height:70px; border-radius:50%; margin:0 auto 10px auto; background-size:cover; border:2px solid var(--accent-color);"></div>
            <h3 id="activeUserSheetName" style="color:#fff;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        </div>
        
        <div class="sheet-action" onclick="viewUserProfileFromSheet()">
            <i class="fa-solid fa-circle-user"></i> <span>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
        </div>

        <div class="sheet-action" onclick="startShareContactFlow()">
            <i class="fa-solid fa-share-nodes"></i> <span>Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„</span>
        </div>

        <div class="sheet-action" onclick="openChatFromSheet()">
            <i class="fa-solid fa-comment-dots"></i> <span>Ù…Ø±Ø§Ø³Ù„Ø©</span>
        </div>
        
        <div class="sheet-action" onclick="callFromSheet()">
            <i class="fa-solid fa-phone"></i> <span>Ø§ØªØµØ§Ù„ ØµÙˆØªÙŠ</span>
        </div>

        <div class="sheet-action danger" onclick="hideActiveUser()">
            <i class="fa-solid fa-eye-slash"></i> <span>Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
        </div>
    </div>
</div>

<div class="bottom-sheet-overlay" id="shareToChatModal" onclick="document.getElementById('shareToChatModal').classList.remove('active')">
    <div class="bottom-sheet" onclick="event.stopPropagation()" style="height: 70vh;">
        <div class="sheet-handle"></div>
        <h3 style="text-align:center; color:#fff; margin-bottom:15px;">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰...</h3>
        <div id="shareToList" style="overflow-y:auto; padding:10px;"></div>
    </div>
</div>

<div id="blockConfirmationModal" class="custom-modal" style="z-index: 80000;">
    <div class="modal-box" style="text-align: center; border: 1px solid #ef4444;">
        
        <div style="width:70px; height:70px; background:rgba(239, 68, 68, 0.1); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-user-slash" style="font-size:30px; color:#ef4444;"></i>
        </div>

        <h3 style="color:#fff; margin-bottom:10px;">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</h3>
        <p style="color:#aaa; font-size:14px; margin-bottom:25px; line-height: 1.6;">
            Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ <br>
            Ù„Ù† ØªØªÙ…ÙƒÙ†Ø§ Ù…Ù† ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£Ùˆ Ø±Ø¤ÙŠØ© Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø·.
        </p>

        <div class="modal-actions" style="flex-direction: row; gap: 10px;">
            <button onclick="document.getElementById('blockConfirmationModal').style.display='none'" class="btn-dark" style="flex:1;">ØªØ±Ø§Ø¬Ø¹</button>
            <button onclick="executeBlockAction()" class="btn-yes" style="flex:1; background:#ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø¸Ø±</button>
        </div>
    </div>
</div>

<div id="restrictConfirmationModal" class="custom-modal" style="z-index: 80000;">
    <div class="modal-box" style="text-align: center; border: 1px solid #f59e0b;">
        
        <div style="width:70px; height:70px; background:rgba(245, 158, 11, 0.1); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-user-lock" style="font-size:30px; color:#f59e0b;"></i>
        </div>

        <h3 style="color:#fff; margin-bottom:10px;">ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ</h3>
        
        <div style="color:#aaa; font-size:13px; margin-bottom:25px; line-height: 1.8; text-align: right; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
            <strong style="color:#f59e0b; display:block; margin-bottom:5px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ ÙŠØ´Ù…Ù„:</strong>
            â€¢ Ù„Ù† ÙŠØ±Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù†Ùƒ Ù‚Ø±Ø£Øª Ø±Ø³Ø§Ø¦Ù„Ù‡ (Seen).<br>
            â€¢ Ù„Ù† ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£Ùˆ Ù…ÙƒØ§Ù„Ù…Ø§Øª Ù…Ù†Ù‡.<br>
            â€¢ Ø³ØªØµÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ØµÙ…Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©.
        </div>

        <div class="modal-actions" style="flex-direction: row; gap: 10px;">
            <button onclick="closeRestrictModal()" class="btn-dark" style="flex:1;">ØªØ±Ø§Ø¬Ø¹</button>
            <button onclick="executeRestrictAction()" class="btn-yes" style="flex:1; background:#f59e0b; color:#000; font-weight:800; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯</button>
        </div>
    </div>
</div>

<div id="unrestrictConfirmationModal" class="custom-modal" style="z-index: 80000;">
    <div class="modal-box" style="text-align: center; border: 1px solid #38bdf8;">
        
        <div style="width:70px; height:70px; background:rgba(56, 189, 248, 0.1); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-user-check" style="font-size:30px; color:#38bdf8;"></i>
        </div>

        <h3 style="color:#fff; margin-bottom:10px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯ØŸ</h3>
        
        <div style="color:#aaa; font-size:13px; margin-bottom:25px; line-height: 1.8; text-align: right; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
            <strong style="color:#38bdf8; display:block; margin-bottom:5px;">Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯:</strong>
            â€¢ Ø³ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…Ø¹Ø±ÙØ© Ø£Ù†Ùƒ Ù‚Ø±Ø£Øª Ø±Ø³Ø§Ø¦Ù„Ù‡.<br>
            â€¢ Ø³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆÙ…ÙƒØ§Ù„Ù…Ø§Øª Ù…Ù†Ù‡ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ.<br>
            â€¢ Ø³ØªØ¹ÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ø¹Ù…Ù„ ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯.
        </div>

        <div class="modal-actions" style="flex-direction: row; gap: 10px;">
            <button onclick="closeUnrestrictModal()" class="btn-dark" style="flex:1;">ØªØ±Ø§Ø¬Ø¹</button>
            <button onclick="executeUnrestrictAction()" class="btn-yes" style="flex:1; background:#38bdf8; color:#000; font-weight:800; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);">Ù†Ø¹Ù…ØŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠØ¯</button>
        </div>
    </div>
</div>

<div id="createGroupModal" class="custom-modal" style="z-index: 80000;">
    <div class="modal-box" style="text-align: center; border: 1px solid #8b5cf6;">
        
        <div style="width:70px; height:70px; background:rgba(139, 92, 246, 0.1); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-users" style="font-size:30px; color:#8b5cf6;"></i>
        </div>

        <h3 style="color:#fff; margin-bottom:10px;">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Ù‚Ù… Ø¨ØªØ³Ù…ÙŠØ© Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.</p>
        
        <div class="input-group" style="margin-bottom: 25px;">
            <i class="fa-solid fa-pen-nib input-icon" style="color:#8b5cf6;"></i>
            <input type="text" id="newGroupNameInput" class="pro-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..." style="border-color: #8b5cf6;">
        </div>

        <div class="modal-actions" style="flex-direction: row; gap: 10px;">
            <button onclick="closeGroupModal()" class="btn-dark" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="executeCreateGroup()" class="btn-yes" style="flex:1; background:linear-gradient(135deg, #8b5cf6, #7c3aed); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">Ø¥Ù†Ø´Ø§Ø¡</button>
        </div>
    </div>
</div>

<div id="createGroupProModal" class="custom-modal" style="z-index: 90000; padding-top: 50px;">
    <div class="modal-box" style="width: 95%; max-width: 400px; height: 85vh; display: flex; flex-direction: column; background: #121212; border: 1px solid #8b5cf6;">
        
        <div style="padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: #fff; margin: 0; font-size: 18px;">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div onclick="closeGroupProModal()" style="color: #aaa; cursor: pointer; padding: 5px;"><i class="fa-solid fa-xmark" style="font-size: 20px;"></i></div>
        </div>

        <div style="padding: 20px; text-align: center; background: rgba(139, 92, 246, 0.05);">
            <div style="width: 70px; height: 70px; background: #2a2a2a; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; border: 2px dashed #8b5cf6; cursor: pointer;">
                <i class="fa-solid fa-camera" style="color: #8b5cf6; font-size: 24px;"></i>
            </div>
            <input type="text" id="groupNamePro" class="pro-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ù…Ø·Ù„ÙˆØ¨)" style="text-align: center; border-color: #8b5cf6;">
        </div>

        <div style="padding: 10px 20px; font-size: 12px; color: #888; font-weight: bold;">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: <span id="selectedCount" style="color: #8b5cf6;">0</span></div>

        <div id="friendsSelectionList" style="flex: 1; overflow-y: auto; padding: 0 10px;">
            </div>

        <div style="padding: 15px; border-top: 1px solid #333;">
            <button onclick="finalizeCreateGroup()" class="btn-purple" style="width: 100%; box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);">
                <i class="fa-solid fa-check"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
            </button>
        </div>
    </div>
</div>

<div id="restrictedPage" class="profile-page" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index: 150000; background-color: #0b1121; flex-direction:column;">
    
    <div class="pp-header" style="background: rgba(15, 25, 38, 0.95); border-bottom: 1px solid rgba(255,255,255,0.1); height: 65px; display: flex; align-items: center; padding: 0 15px;">
        <div class="icon-btn" onclick="closeRestrictedPage()" style="background:transparent; border:none; cursor:pointer;">
            <i class="fa-solid fa-arrow-right" style="font-size: 20px; color: #fff;"></i>
        </div>
        <h3 style="margin:0; font-size:18px; color: #fff; flex:1; text-align:center; font-weight:bold;">
            Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù‚ÙŠØ¯Ø©
        </h3>
        <div style="width: 40px;"></div> </div>
    
    <div class="pp-content" style="padding: 20px; overflow-y:auto; flex:1;">
        <div style="color: #94a3b8; font-size: 13px; margin-bottom: 20px; text-align: center; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
            <i class="fa-solid fa-circle-info" style="color: #f59e0b; margin-left: 5px;"></i>
            Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø§ Ù„Ù† ÙŠØ¸Ù‡Ø± Ù„Ù‡Ø§ Ø£Ù†Ùƒ Ù‚Ø±Ø£Øª Ø±Ø³Ø§Ø¦Ù„Ù‡Ù…ØŒ ÙˆÙ„Ù† ØªØµÙ„Ùƒ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ù†Ù‡Ù….
        </div>

        <div id="restrictedListFull" class="profile-menu-list">
            </div>
    </div>
</div>
<script>
    // ==========================================
    // ğŸš¨ ÙƒÙˆØ¯ Ø§Ù„Ù…ØµÙŠØ¯Ø©: Ù„ÙƒØ´Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠØ³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø±
    // ==========================================
    (function detectCrash() {
        const suspects = [
            'storyReplyInput', 
            'storyContent', 
            'unlockPassInput', 
            'newGroupNameInput'
        ];

        console.log("--- Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªÙ‡Ù…Ø© ---");

        suspects.forEach(id => {
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ù†ØµØ±
                const el = document.getElementById(id);
                
                // Ù‡Ù†Ø§ Ø§Ù„Ù…Ø­Ùƒ: Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Ø®Ø§ØµÙŠØ© Ù…Ù†Ù‡. Ù„Ùˆ Ù‡Ùˆ null Ø§Ù„ÙƒÙˆØ¯ Ù‡ÙŠÙ†ÙØ¬Ø± Ù‡Ù†Ø§
                // ÙˆÙ‡Ù†ØµØ·Ø§Ø¯Ù‡ ÙÙŠ Ø§Ù„Ù€ catch
                if (!el) throw new Error("Element is NULL");
                
                // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù‡Ù†Ø§ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø³Ù„ÙŠÙ… ÙÙŠ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø¯Ù‡
                el.addEventListener ? el.addEventListener('test', ()=>{}) : null;
                
            } catch (e) {
                // ğŸ›‘ Ø£Ù…Ø³ÙƒÙ†Ø§ Ø§Ù„Ø®Ø·Ø£!
                console.error(`ğŸ”¥ğŸ”¥ Ù‚ÙØ´Ù†Ø§ Ø§Ù„Ø­Ø±Ø§Ù…ÙŠ! Ø§Ù„Ø¹Ù†ØµØ± Ù‡Ùˆ: ${id}`);
                alert(`âš ï¸ ØªÙ… ÙƒØ´Ù Ø§Ù„Ù…Ø´ÙƒÙ„Ø©!\n\nØ§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø³Ø¨Ø¨ Ù„Ù„Ø®Ø·Ø£ Ù‡Ùˆ: "${id}"\n\nØ§Ù„Ø³Ø¨Ø¨: Ø§Ù„ÙƒÙˆØ¯ Ø¨ÙŠØ´ØªØºÙ„ Ù‚Ø¨Ù„ Ù…Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø¯Ù‡ ÙŠØªØ±Ø³Ù… ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©.`);
            }
        });
    })();
</script>


</body>
</html>