<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NABD - Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/ar.min.js"></script>
    
    <style>
        /* === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… === */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-color: #0d0d0f;
            --card-color: #161616;
            --primary-solid: #5D5FEF;
            --primary-gradient: linear-gradient(135deg, #5D5FEF, #7879F1);
            --text-color: #eee;
            --secondary-text: #aaa;
            --border-color: #2a2a2a;
            --danger-color: #ff453a;
            --success-color: #4ade80;
            --btn-bg: #262626;
        }

        body { 
            background: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            font-family: "Cairo", sans-serif; 
            padding-bottom: 90px; 
            overflow-x: hidden; 
            overscroll-behavior-y: contain; 
        }

        /* === Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ« === */
        #pullIndicator {
            position: fixed; 
            top: -60px; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: center;
            z-index: 99; transition: top 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #pullIndicator.visible { top: 70px; }
        #pullIcon {
            font-size: 24px; color: var(--primary-solid);
            background: rgba(255,255,255,0.1); width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid var(--border-color);
        }
        #pullIcon.rotate { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* === Header === */
        .header { 
            display: flex; align-items: center; padding: 15px 20px; 
            background: rgba(13, 13, 15, 0.95); 
            border-bottom: 1px solid var(--border-color); 
            position: sticky; top: 0; z-index: 100; 
            backdrop-filter: blur(10px); 
        }
        .header h2 { margin: 0; font-size: 18px; flex: 1; text-align: center; font-weight: 700; }
        
        .back-btn { 
            font-size: 20px; cursor: pointer; color: var(--text-color); 
            padding: 8px; border-radius: 50%; transition: 0.2s; 
        }
        .back-btn:active { background: rgba(255,255,255,0.1); }

        .header-req-btn { position: relative; cursor: pointer; padding: 5px; }
        .notif-badge-top { 
            background: var(--danger-color); color: white; 
            padding: 2px 5px; border-radius: 50%; 
            min-width: 16px; height: 16px;
            font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: 0; right: 0;
            display: none; animation: pulse 1.5s infinite;
        }

        /* === Section Styles === */
        .section-header {
            padding: 25px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .section-title { font-size: 18px; font-weight: 800; color: var(--text-color); display: flex; align-items: center; gap: 8px; }
        .req-badge {
            background: var(--danger-color); color: white;
            padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;
            display: none;
        }
        .req-badge.show { display: inline-block; }

        /* === User Card Styling === */
        .list-container { padding: 0 15px; display: flex; flex-direction: column; gap: 12px; }

        .user-card { 
            background: var(--card-color); 
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 15px; 
            display: flex; flex-direction: column; gap: 12px;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card-top { display: flex; align-items: center; gap: 12px; }
        
        .user-avatar { 
            width: 60px; height: 60px; 
            border-radius: 50%; 
            background-color: #333; 
            background-size: cover; background-position: center; 
            border: 2px solid var(--bg-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .user-info { flex: 1; }
        .user-name { font-size: 16px; font-weight: 700; color: var(--text-color); margin-bottom: 2px; }
        .user-bio { font-size: 12px; color: var(--secondary-text); display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .req-time { font-size: 11px; color: var(--primary-solid); margin-top: 4px; display: block; opacity: 0.8; }

        /* === Buttons === */
        .actions-row { display: flex; gap: 10px; width: 100%; }
        
        .btn {
            flex: 1; border: none; padding: 0; height: 40px; border-radius: 12px;
            font-family: "Cairo"; font-weight: 700; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); }

        .btn-confirm { background: var(--primary-solid); color: #fff; box-shadow: 0 4px 15px rgba(93, 95, 239, 0.25); }
        .btn-delete { background: var(--btn-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-add { background: rgba(93, 95, 239, 0.1); color: var(--primary-solid); border: 1px solid rgba(93, 95, 239, 0.2); }
        
        /* Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ */
        .load-more-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px dashed var(--secondary-text);
            color: var(--secondary-text);
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            display: none; 
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .load-more-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-color); border-color: var(--text-color); }

        /* === Success & Skeleton === */
        .success-overlay {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            animation: fadeIn 0.4s ease; padding: 10px 0;
        }
        .success-icon { font-size: 28px; color: var(--success-color); margin-bottom: 8px; filter: drop-shadow(0 0 10px rgba(74, 222, 128, 0.3)); }
        .success-text { font-size: 15px; font-weight: 700; color: #fff; }
        .success-text span { color: var(--primary-solid); }
        .success-sub { font-size: 12px; color: var(--secondary-text); margin-top: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .skeleton-card {
            background: var(--card-color); border-radius: 16px; padding: 15px;
            border: 1px solid var(--border-color); margin-bottom: 12px;
        }
        .sk-head { display: flex; gap: 12px; align-items: center; margin-bottom: 15px; }
        .sk-avatar { width: 60px; height: 60px; border-radius: 50%; background: #222; animation: pulse 1.5s infinite; }
        .sk-info { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .sk-line { height: 10px; background: #222; border-radius: 6px; animation: pulse 1.5s infinite; }
        .sk-btns { display: flex; gap: 10px; }
        .sk-btn { height: 40px; flex: 1; background: #222; border-radius: 12px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* === Empty State === */
        .empty-state { 
            text-align: center; padding: 40px 20px; color: var(--secondary-text); 
            display: none; flex-direction: column; align-items: center;
        }
        .empty-state i { font-size: 50px; margin-bottom: 15px; opacity: 0.3; }

        /* === Toast === */
        #toast { 
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: #222; border: 1px solid #333; color: #fff; 
            padding: 12px 24px; border-radius: 30px; font-size: 14px; opacity: 0; 
            transition: 0.3s; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 8px; pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* === Bottom Nav === */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; background: var(--card-color); 
            display: flex; justify-content: space-around; align-items: center;
            padding: 10px 0; border-top: 1px solid var(--border-color); z-index: 900; 
        }
        .nav-item { 
            font-size: 22px; color: var(--secondary-text); 
            cursor: pointer; transition: 0.2s; position: relative; 
            display: flex; justify-content: center; align-items: center;
        }
        .nav-item.active { color: var(--primary-solid); transform: translateY(-2px); }
        .nav-item:active { transform: scale(0.9); }
        
        .requests-badge-bottom { 
            background: var(--danger-color); color: white; 
            padding: 2px 5px; border-radius: 50%; 
            min-width: 15px; height: 15px;
            font-size: 9px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            position: absolute; top: -5px; right: -5px;
            display: none;
        }
    </style>
</head>
<body>

    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.mp3"></audio>
    <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>
    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <div id="pullIndicator"><i id="pullIcon" class="fa-solid fa-rotate-right"></i></div>

    <div class="header">
        <i class="fa-solid fa-arrow-right back-btn" onclick="smartNavigate('back')"></i>
        <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h2>
        <div class="header-req-btn" onclick="smartNavigate('notifications.html')">
            <i class="fa-regular fa-bell" style="font-size:20px; color:var(--text-color)"></i>
            <div class="notif-badge-top" id="headerNotifBadge">0</div>
        </div>
    </div>

    <div class="section-header">
        <span class="section-title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© <span id="reqBadge" class="req-badge">0</span></span>
    </div>

    <div class="list-container" id="requestsContainer">
        <div class="skeleton-card">
            <div class="sk-head"><div class="sk-avatar"></div><div class="sk-info"><div class="sk-line" style="width:50%"></div><div class="sk-line" style="width:30%"></div></div></div>
            <div class="sk-btns"><div class="sk-btn"></div><div class="sk-btn"></div></div>
        </div>
    </div>

    <div style="padding: 0 15px;">
        <button id="loadMoreBtn" class="load-more-btn" onclick="loadMoreRequests()">
            Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ <i class="fa-solid fa-chevron-down"></i>
        </button>
    </div>

    <div id="noRequestsMsg" class="empty-state">
        <i class="fa-solid fa-user-check"></i>
        <span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØµØ¯Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
    </div>

    <div style="height: 20px; border-bottom: 1px dashed var(--border-color); margin: 20px; opacity: 0.5;"></div>

    <div class="section-header"><span class="section-title">Ø£Ø´Ø®Ø§Øµ Ù‚Ø¯ ØªØ¹Ø±ÙÙ‡Ù…</span></div>
    <div class="list-container" id="suggestionsContainer"></div>

    <div id="toast"><i class="fa-solid fa-check-circle" style="color:var(--success-color)"></i> <span>ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</span></div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="smartNavigate('home.html')"><i class="fa-solid fa-house"></i></div>
        <div class="nav-item" onclick="smartNavigate('friends.html')"><i class="fa-solid fa-users"></i></div>
        <div class="nav-item" onclick="smartNavigate('create_post.html')"><i class="fa-solid fa-plus-circle" style="font-size: 28px;"></i></div>
        <div class="nav-item active" onclick="scrollToTop()">
            <i class="fa-solid fa-user-plus"></i>
            <div class="requests-badge-bottom" id="bottomReqBadge">0</div>
        </div>
        <div class="nav-item" onclick="smartNavigate('profile.html')"><i class="fa-regular fa-user"></i></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpvqNAReChsHn5tFJSp7vV_EJHmtD2x4c",
            authDomain: "pools-e4381.firebaseapp.com",
            projectId: "pools-e4381",
            storageBucket: "pools-e4381.appspot.com",
            messagingSenderId: "339799216046",
            appId: "1:339799216046:web:26e437a7b7d5c24fe9023f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore();
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        
        let currentUserUid = null;
        let myFriendsSet = new Set();
        let acceptedRequests = new Set(); 
        
        let requestsLimit = 50; 
        let requestsUnsubscribe = null;

        auth.onAuthStateChanged(user => {
            if (user) { 
                currentUserUid = user.uid; 
                initPage(); 
                startNotificationListener();
            } else { location.href = "index.html"; }
        });

        async function initPage() {
            await fetchMyFriends();
            loadRequests(); 
            loadSuggestions(); 
        }

        async function fetchMyFriends() {
            try { 
                const snap = await db.collection("users").doc(currentUserUid).collection("friends").get(); 
                snap.forEach(doc => myFriendsSet.add(doc.id)); 
            } catch (e) {}
        }

        // ==========================================
        //  Smart Navigation
        // ==========================================
        function smartNavigate(url) {
            playClick();
            const isInIframe = window.self !== window.top;
            if (url === 'back' || url === 'home.html') {
                if (isInIframe && window.parent.closeUniversalPage) {
                    window.parent.closeUniversalPage();
                } else {
                    if(url === 'back') history.back(); else location.href = url;
                }
            } else { location.href = url; }
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        // ==========================================
        //  Pull to Refresh
        // ==========================================
        let pStart = {x:0, y:0};
        let isPulling = false;
        const pullIndicator = document.getElementById('pullIndicator');
        const pullIcon = document.getElementById('pullIcon');

        document.addEventListener('touchstart', e => { if(window.scrollY === 0) { pStart.y = e.touches[0].screenY; isPulling = true; } }, {passive: false});
        document.addEventListener('touchmove', e => { if(!isPulling) return; const currentY = e.touches[0].screenY; if(currentY > pStart.y && window.scrollY === 0) pullIndicator.classList.add('visible'); else pullIndicator.classList.remove('visible'); }, {passive: false});
        document.addEventListener('touchend', e => { if(!isPulling) return; if(pullIndicator.classList.contains('visible')) performRefresh(); isPulling = false; });

        function performRefresh() {
            pullIcon.classList.add('rotate'); playClick();
            if(navigator.vibrate) navigator.vibrate(50);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù„ÙŠÙ…ÙŠØª
            requestsLimit = 50; 
            
            setTimeout(() => { 
                document.getElementById('requestsContainer').innerHTML = '<div class="skeleton-card"><div class="sk-head"><div class="sk-avatar"></div><div class="sk-info"><div class="sk-line" style="width:50%"></div><div class="sk-line" style="width:30%"></div></div></div><div class="sk-btns"><div class="sk-btn"></div><div class="sk-btn"></div></div></div>';
                loadRequests(); 
                loadSuggestions(); 
                pullIcon.classList.remove('rotate'); pullIndicator.classList.remove('visible'); 
            }, 1000);
        }

        // ==========================================
        //  Loading Requests
        // ==========================================
        function loadRequests() {
            const container = document.getElementById('requestsContainer');
            const emptyMsg = document.getElementById('noRequestsMsg');
            const badge = document.getElementById('reqBadge'); 
            const bottomBadge = document.getElementById('bottomReqBadge'); 
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            if(requestsUnsubscribe) requestsUnsubscribe();

            requestsUnsubscribe = db.collection("users").doc(currentUserUid).collection("friendRequests")
                .orderBy("createdAt", "desc")
                .limit(requestsLimit) 
                .onSnapshot(async (snapshot) => {
                    
                    const skeletons = container.querySelectorAll('.skeleton-card');
                    skeletons.forEach(sk => sk.remove());

                    if (snapshot.size > 0) {
                        badge.innerText = snapshot.size;
                        badge.classList.add('show');
                        bottomBadge.innerText = snapshot.size;
                        bottomBadge.style.display = 'flex'; 
                        emptyMsg.style.display = 'none';
                        
                        if(snapshot.size >= requestsLimit) {
                            loadMoreBtn.style.display = 'flex';
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }

                    } else {
                        badge.classList.remove('show');
                        bottomBadge.style.display = 'none';
                        loadMoreBtn.style.display = 'none';
                        if (container.children.length === 0) emptyMsg.style.display = 'flex';
                    }

                    snapshot.docChanges().forEach(async (change) => {
                        const reqId = change.doc.id;
                        
                        if (change.type === "added") {
                            if(document.getElementById(`req-${reqId}`)) return;
                            if(acceptedRequests.has(reqId)) return;
                            const reqData = change.doc.data();
                            renderRequestCard(reqId, reqData);
                        }

                        if (change.type === "removed") {
                            if (!acceptedRequests.has(reqId)) {
                                const card = document.getElementById(`req-${reqId}`);
                                if(card) card.remove();
                                if (container.children.length === 0) emptyMsg.style.display = 'flex';
                            }
                        }
                    });
                });
        }

        function loadMoreRequests() {
            playClick();
            const btn = document.getElementById('loadMoreBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            requestsLimit += 50;
            setTimeout(() => {
                loadRequests();
                btn.innerHTML = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ <i class="fa-solid fa-chevron-down"></i>';
            }, 500);
        }

        async function renderRequestCard(uid, data) {
            const container = document.getElementById('requestsContainer');
            let userData = { name: "Ù…Ø³ØªØ®Ø¯Ù…", profilePic: defaultAvatar };
            try {
                const uDoc = await db.collection("users").doc(uid).get();
                if(uDoc.exists) userData = uDoc.data();
            } catch(e){}

            const pic = userData.profilePic || userData.avatarUrl || defaultAvatar;
            const timeAgo = data.createdAt ? moment(data.createdAt.toDate()).fromNow() : '';

            const card = document.createElement('div');
            card.className = 'user-card';
            card.id = `req-${uid}`;
            card.innerHTML = `
                <div class="card-top">
                    <div class="user-avatar" onclick="smartNavigate('profile.html?uid=${uid}')" style="background-image:url('${pic}')"></div>
                    <div class="user-info">
                        <div class="user-name">${userData.name}</div>
                        <div class="user-bio">ÙŠØ±ØºØ¨ ÙÙŠ Ø£Ù† ÙŠÙƒÙˆÙ† ØµØ¯ÙŠÙ‚Ùƒ</div>
                        <span class="req-time"><i class="fa-regular fa-clock"></i> ${timeAgo}</span>
                    </div>
                </div>
                <div class="actions-row">
                    <button class="btn btn-confirm" onclick="acceptFriend('${uid}', '${userData.name}')">
                        <i class="fa-solid fa-user-check"></i> ØªØ£ÙƒÙŠØ¯
                    </button>
                    <button class="btn btn-delete" onclick="deleteRequest('${uid}')">
                        Ø­Ø°Ù
                    </button>
                </div>
            `;
            container.appendChild(card);
        }

        async function acceptFriend(uid, name) {
            playClick();
            const card = document.getElementById(`req-${uid}`);
            if(!card) return;

            acceptedRequests.add(uid);

            // 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø±Øª Ù„Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            card.innerHTML = `
                <div class="success-overlay">
                    <i class="fa-solid fa-check-circle success-icon"></i>
                    <div class="success-text">Ø£ØµØ¨Ø­Øª Ø£Ù†Øª Ùˆ <span>${name}</span> ØµØ¯ÙŠÙ‚ÙŠÙ†</div>
                    <div class="success-sub">ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†</div>
                </div>
            `;
            card.style.borderColor = "var(--success-color)";
            card.style.background = "linear-gradient(to bottom, #161616, #0d1a0f)";

            playSuccess();

            try {
                const batch = db.batch();
                const time = firebase.firestore.FieldValue.serverTimestamp();
                
                // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
                batch.set(db.collection("users").doc(currentUserUid).collection("friends").doc(uid), { acceptedAt: time });
                batch.set(db.collection("users").doc(uid).collection("friends").doc(currentUserUid), { acceptedAt: time });
                
                // 3. Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨
                batch.delete(db.collection("users").doc(currentUserUid).collection("friendRequests").doc(uid));

                // ğŸ”¥ğŸ”¥ğŸ”¥ 4. Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© "ÙƒØ³Ø± Ø§Ù„ØµÙ…Øª" (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ğŸ”¥ğŸ”¥ğŸ”¥
                const chatId = [currentUserUid, uid].sort().join("_");
                const chatRef = db.collection('chats').doc(chatId);
                const msgRef = chatRef.collection('messages').doc();

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Øª
                batch.set(chatRef, {
                    users: [currentUserUid, uid],
                    lastMessage: "Ù„Ù‚Ø¯ Ø£ØµØ¨Ø­ØªÙ…Ø§ ØµØ¯ÙŠÙ‚ÙŠÙ†ØŒ Ø§ÙƒØ³Ø±ÙˆØ§ Ø­Ø§Ø¬Ø² Ø§Ù„ØµÙ…Øª! ğŸ‘‹",
                    lastMessageTime: time,
                    lastSender: "system", // Ù…Ø±Ø³Ù„ Ø®Ø§Øµ
                    isSystemLast: true
                }, { merge: true });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù†ÙØ³Ù‡Ø§
                batch.set(msgRef, {
                    text: "Ù„Ù‚Ø¯ Ø£ØµØ¨Ø­ØªÙ…Ø§ ØµØ¯ÙŠÙ‚ÙŠÙ†ØŒ Ø§ÙƒØ³Ø±ÙˆØ§ Ø­Ø§Ø¬Ø² Ø§Ù„ØµÙ…Øª! ğŸ‘‹",
                    senderId: "system",
                    createdAt: time,
                    isSystem: true, // Ø¹Ø´Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
                    type: "system"
                });

                // ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
                await batch.commit();
                myFriendsSet.add(uid);

            } catch (error) {
                console.error(error);
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            }
        }

        async function deleteRequest(uid) {
            playClick();
            const card = document.getElementById(`req-${uid}`);
            if(card) {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            }
            try {
                await db.collection("users").doc(currentUserUid).collection("friendRequests").doc(uid).delete();
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨");
            } catch (e) { 
                showToast("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù"); 
                if(card) card.style.opacity = '1';
            }
        }

        async function loadSuggestions() {
            const container = document.getElementById('suggestionsContainer');
            container.innerHTML = "";
            try {
                const snap = await db.collection("users").limit(10).get();
                let count = 0;
                for (const doc of snap.docs) {
                    const uid = doc.id;
                    if (uid !== currentUserUid && !myFriendsSet.has(uid)) {
                        const uData = doc.data();
                        const name = uData.name || "Ù…Ø³ØªØ®Ø¯Ù…";
                        const pic = uData.profilePic || uData.avatarUrl || defaultAvatar;

                        const div = document.createElement('div');
                        div.className = 'user-card';
                        div.innerHTML = `
                            <div class="card-top">
                                <div class="user-avatar" onclick="smartNavigate('profile.html?uid=${uid}')" style="background-image:url('${pic}')"></div>
                                <div class="user-info">
                                    <div class="user-name">${name}</div>
                                    <div class="user-bio">${uData.bio || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ NABD'}</div>
                                </div>
                            </div>
                            <div class="actions-row">
                                <button class="btn btn-add" id="btn-add-${uid}" onclick="sendReq('${uid}')">
                                    <i class="fa-solid fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚
                                </button>
                                <button class="btn btn-delete" onclick="this.closest('.user-card').remove()">
                                    ØªØ¬Ø§Ù‡Ù„
                                </button>
                            </div>
                        `;
                        container.appendChild(div);
                        count++;
                    }
                }
                if(count === 0) container.innerHTML = '<div style="padding:20px;text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
            } catch (e) { console.log(e); }
        }

        async function sendReq(targetUid) {
            playClick();
            const btn = document.getElementById(`btn-add-${targetUid}`);
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ...';
            try {
                await db.collection("users").doc(targetUid).collection("friendRequests").doc(currentUserUid).set({
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    from: currentUserUid
                });
                
                btn.style.background = "#222";
                btn.style.color = "#aaa";
                btn.style.border = "none";
                btn.innerHTML = '<i class="fa-solid fa-check"></i> ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
                btn.onclick = null;
                showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©");
            } catch (e) {
                btn.innerHTML = 'Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚';
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£");
            }
        }

        function startNotificationListener() {
            db.collection("notifications").where("recipientId", "==", currentUserUid).where("read", "==", false).onSnapshot(snap => {
                const count = snap.size;
                const badge = document.getElementById('headerNotifBadge');
                if (badge) {
                    if (count > 0) {
                        badge.style.display = 'flex'; badge.innerText = count > 99 ? '99+' : count;
                        snap.docChanges().forEach(change => {
                            if (change.type === "added") {
                                const timeDiff = Date.now() - (change.doc.data().createdAt?.toDate().getTime() || Date.now());
                                if (timeDiff < 10000) {
                                    document.getElementById('notificationSound').play().catch(e=>{});
                                    showToast("ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯");
                                    if(navigator.vibrate) navigator.vibrate(200);
                                }
                            }
                        });
                    } else { badge.style.display = 'none'; }
                }
            });
        }

        function playClick() { document.getElementById('clickSound').play().catch(()=>{}); }
        function playSuccess() { document.getElementById('successSound').play().catch(()=>{}); }
        function showToast(msg) { const t = document.getElementById('toast'); t.querySelector('span').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    </script>
    <script src="global-call.js"></script>
</body>
</html>
